[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Nmap Live Host Discovery](https://tryhackme.com/r/room/nmap01) 

Всего 9 заданий:
## Задание 1
Когда мы хотим атаковать сеть, нам нужен эффективный инструмент, который поможет нам справляться с повторяющимися 
задачами и ответить на следующие вопросы: 
- Какие системы работают?
- Какие службы работают в этих системах?
Инструмент, на который мы будем полагаться, — это Nmap . На первый вопрос о поиске работающих компьютеров дается 
  ответ в этой комнате. Эта комната — первая в серии из четырех комнат, посвященных Nmap . На второй вопрос об 
  обнаружении работающих служб дается ответ в следующих комнатах Nmap , которые посвящены сканированию портов.

Эта комната — первая из четырех в этой серии Nmap . Эти четыре комнаты также являются частью модуля сетевой безопасности.
- Nmap Live Host Discovery
- Базовое сканирование портов Nmap
- Расширенное сканирование портов Nmap
- Nmap Post сканирование портов
В этой комнате объясняются шаги, которые Nmap выполняет для обнаружения систем, находящихся в сети, перед 
  сканированием портов. Этот этап имеет решающее значение, поскольку попытка сканирования портов автономных систем 
  только напрасно потратит время и создаст ненужный шум в сети.

Мы представляем различные подходы, которые Nmap использует для обнаружения живых хостов. В частности, мы рассмотрим:
- ARP- сканирование: это сканирование использует ARP- запросы для обнаружения активных хостов.
- Сканирование ICMP: это сканирование использует запросы ICMP для идентификации активных хостов.
- Сканирование TCP/ UDP ping: это сканирование отправляет пакеты на порты TCP и UDP для определения активных хостов.
- Мы также представляем два сканера, arp-scan и masscan, и объясняем, как они пересекаются с частью обнаружения хостов 
  Nmap.

Как уже упоминалось, начиная с этой комнаты, мы будем использовать Nmap для активного обнаружения систем и служб. 
Nmap был создан Гордоном Лионом (Федором), экспертом по сетевой безопасности и программистом с открытым исходным 
кодом. Он был выпущен в 1997 году. Nmap , сокращение от Network Mapper, является бесплатным программным обеспечением 
с открытым исходным кодом, выпущенным по лицензии GPL. Nmap является стандартным инструментом для картирования сетей,
идентификации работающих хостов и обнаружения работающих служб. Скриптовый движок Nmap может дополнительно расширить 
его функциональность, от снятия отпечатков служб до эксплуатации уязвимостей. Сканирование Nmap обычно проходит 
через этапы, показанные на рисунке ниже, хотя многие из них являются необязательными и зависят от предоставленных 
вами аргументов командной строки.

### Ответьте на вопросы ниже
Для ответа на некоторые из этих вопросов потребуется использовать статический сайт, а для других — AttackBox и 
целевую виртуальную машину. 

```commandline
Ответ не нужен
```

## Задание 2
Давайте рассмотрим несколько терминов, прежде чем перейдем к основным задачам. Сетевой сегмент — это группа 
компьютеров, подключенных с помощью общей среды. Например, средой может быть коммутатор Ethernet или точка доступа 
WiFi. В IP-сети подсеть обычно эквивалентна одному или нескольким сетевым сегментам, подключенным вместе и 
настроенным на использование одного и того же маршрутизатора. Сетевой сегмент относится к физическому соединению, 
тогда как подсеть относится к логическому соединению.

На следующей схеме сети у нас есть четыре сетевых сегмента или подсети. В общем, ваша система будет подключена к 
одному из этих сетевых сегментов/подсетей. Подсеть или просто подсеть имеет свой собственный диапазон IP-адресов и 
подключена к более обширной сети через маршрутизатор. Может быть брандмауэр, обеспечивающий соблюдение политик 
безопасности в зависимости от каждой сети.

На рисунке выше показаны два типа подсетей:
- Подсети с /16, что означает, что маска подсети может быть записана как 255.255.0.0. Эта подсеть может иметь около 
  65 тысяч хостов. 
- Подсети с /24, что указывает на то, что маска подсети может быть выражена как 255.255.255.0. Эта подсеть может 
  иметь около 250 хостов.
- Если вам нужно больше узнать о подсетях, возможно, вам стоит обратиться к заданию 2 в разделе «Введение в локальные 
  сети».

В рамках активной разведки мы хотим узнать больше информации о группе хостов или о подсети. Если вы подключены к той 
же подсети, вы могли бы ожидать, что ваш сканер будет полагаться на запросы ARP (Address Resolution Protocol) для 
обнаружения активных хостов. Запрос ARP направлен на получение аппаратного адреса (MAC-адреса), чтобы связь через 
канальный уровень стала возможной; однако мы можем использовать это, чтобы сделать вывод, что хост находится в сети. 
(Мы снова рассмотрим канальный уровень в Задаче 4.)

Если вы находитесь в сети A, вы можете использовать ARP только для обнаружения устройств в этой подсети (10.1.100.
0/24). Предположим, вы подключены к подсети, отличной от подсети целевой системы (систем). В этом случае все пакеты, 
сгенерированные вашим сканером, будут маршрутизироваться через шлюз по умолчанию (маршрутизатор) для достижения 
систем в другой подсети; однако запросы ARP не будут маршрутизироваться и, следовательно, не смогут пройти через 
маршрутизатор подсети. ARP — это протокол канального уровня, и пакеты ARP привязаны к своей подсети.    

Нажмите кнопку «Просмотр сайта», чтобы запустить сетевой симулятор. Мы будем использовать этот симулятор, чтобы 
ответить на вопросы в заданиях 2, 4 и 5. 

### Ответьте на вопросы ниже
Отправьте пакет со следующим содержанием:
С компьютера1
На компьютер1 (чтобы указать, что идет трансляция)
Тип пакета: «ARP-запрос»
Данные: computer6 (потому что мы запрашиваем MAC-адрес computer6 с помощью ARP-запроса)
Сколько устройств могут видеть ARP-запрос?
```commandline
4
```
Получил ли компьютер 6 запрос ARP? (Да/Нет)
```commandline
N
```
Отправьте пакет со следующим содержанием:
С компьютера4
На компьютер4 (чтобы указать, что идет трансляция)
Тип пакета: «ARP-запрос»
Данные: computer6 (потому что мы запрашиваем MAC-адрес computer6 с помощью ARP-запроса)
Сколько устройств могут видеть ARP-запрос?
```commandline
4
```
Ответил ли computer6 на запрос ARP? (Да/Нет)
```commandline
Y
```

## Задание 3
Мы упомянули различные методы, которые мы можем использовать для сканирования в Задаче 1. Прежде чем мы подробно 
объясним каждый из них и применим его к живой цели, нам нужно указать цели, которые мы хотим сканировать. В общем, 
вы можете предоставить список, диапазон или подсеть. Примеры спецификации цели:

- список: MACHINE_IP scanme.nmap.org example.comбудет сканировать 3 IP-адреса.
- диапазон: 10.11.12.15-20 будет сканировать 6 IP-адресов: 10.11.12.15, 10.11.12.16,… и 10.11.12.20.
- подсеть: MACHINE_IP/30 будет сканировать 4 IP-адреса.
Вы также можете предоставить файл в качестве входных данных для вашего списка целей, nmap -iL list_of_hosts.txt.

Если вы хотите проверить список хостов, которые Nmap будет сканировать, вы можете использовать nmap -sL TARGETS. Эта 
опция предоставит вам подробный список хостов, которые Nmap будет сканировать, не сканируя их; однако Nmap 
попытается выполнить обратное разрешение DNS для всех целей, чтобы получить их имена. Имена могут раскрыть различную 
информацию для пентестера. (Если вы не хотите, чтобы Nmap отправлял DNS- сервер, вы можете добавить -n.)

Запустите AttackBox с помощью кнопки Start AttackBox, откройте терминал, когда AttackBox будет готов, и используйте 
Nmap, чтобы ответить на следующие вопросы. 

### Ответьте на вопросы ниже
Какой первый IP-адрес будет сканировать Nmap, если вы укажете его 10.10.12.13/29 в качестве цели?
```commandline
10.10.12.8
```
Сколько IP-адресов просканирует Nmap, если вы предоставите следующий диапазон  10.10.0-255.101-125? 
```commandline
6400
```

## Задание 4
Давайте вернемся к слоям TCP /IP, показанным на следующем рисунке. Мы воспользуемся протоколами для обнаружения 
активных хостов. Начиная снизу вверх, мы можем использовать: 
- ARP с канального уровня
- ICMP с сетевого уровня
- TCP с транспортного уровня
- UDP с транспортного уровня


Прежде чем мы подробно обсудим, как сканеры могут использовать каждый из них, мы кратко рассмотрим эти четыре 
протокола. ARP имеет одну цель: отправить кадр на широковещательный адрес в сегменте сети и попросить компьютер с 
определенным IP-адресом ответить, предоставив свой MAC-адрес (аппаратный).

ICMP имеет много типов . ICMP ping использует тип 8 (эхо) и тип 0 (эхо-ответ).

Если вы хотите выполнить ping-тест системы в той же подсети, ARP- запрос должен предшествовать ICMP Echo.

Хотя TCP и UDP являются транспортными уровнями, для целей сканирования сети сканер может отправить специально 
созданный пакет на общие порты TCP или UDP , чтобы проверить, ответит ли цель. Этот метод эффективен, особенно когда 
ICMP Echo заблокирован.  

Если вы закрыли сетевой симулятор, нажмите кнопку «Просмотр сайта» в Задаче 2, чтобы снова отобразить его.

### Ответьте на вопросы ниже
Отправьте пакет со следующим содержанием:

С компьютера1
На компьютер3
Тип пакета: «Запрос Ping»
Какой тип пакета отправил computer1 перед пингом?
```commandline
ARP Request
```
Какой тип пакета получил компьютер computer1, прежде чем смог отправить ping?
```commandline
ARP Response
```
Сколько компьютеров ответили на запрос ping?
```commandline
1
```
Отправьте пакет со следующим содержанием:
С компьютера2
На компьютер5
Тип пакета: «Запрос Ping»
Как называется первое устройство, ответившее на первый ARP-запрос?
```commandline
router
```
Как называется первое устройство, ответившее на второй ARP-запрос?
```commandline
computer5
```
Отправить еще один запрос Ping. Требовались ли новые запросы ARP? (Да/Нет)
```commandline
N
```

## Задание 5
Как узнать, какие хосты работают? Важно не тратить время на сканирование портов офлайн-хоста или неиспользуемого 
IP-адреса. Существуют различные способы обнаружения онлайн-хостов. Если не предоставлены параметры обнаружения 
хостов, Nmap использует следующие подходы для обнаружения активных хостов:  
- Когда привилегированный пользователь пытается сканировать цели в локальной сети (Ethernet), Nmap использует 
  запросы ARP. Привилегированный пользователь — это root или пользователь, который принадлежит sudoers и может 
  запускать sudo.
- Когда привилегированный пользователь пытается сканировать цели за пределами локальной сети, Nmap использует запросы 
  ICMP-эха, TCP ACK (подтверждение) на порт 80, TCP SYN (синхронизация) на порт 443 и запрос временной метки ICMP.
- Когда непривилегированный пользователь пытается сканировать цели за пределами локальной сети, Nmap прибегает к 
  трехстороннему TCP- рукопожатию, отправляя SYN-пакеты на порты 80 и 443.
- Nmap по умолчанию использует ping-сканирование для поиска активных хостов, а затем переходит к сканированию только 
  активных хостов. Если вы хотите использовать Nmap для обнаружения онлайн-хостов без сканирования портов активных 
  систем, вы можете выполнить nmap -sn TARGETS. Давайте копнем глубже, чтобы получить четкое представление о 
  различных используемых методах.  

ARP- сканирование возможно только в том случае, если вы находитесь в той же подсети, что и целевые системы. В 
Ethernet (802.3) и WiFi (802.11) вам необходимо знать MAC-адрес любой системы, прежде чем вы сможете с ней связаться.
MAC-адрес необходим для заголовка канального уровня; заголовок содержит исходный MAC-адрес и MAC-адрес назначения 
среди других полей. Чтобы получить MAC-адрес, ОС отправляет ARP- запрос. Хост, который отвечает на ARP- запросы, 
включен. ARP- запрос работает только в том случае, если цель находится в той же подсети, что и вы, т. е. в том же 
Ethernet/WiFi. Вы должны ожидать увидеть много ARP- запросов, сгенерированных во время сканирования локальной сети 
Nmap. Если вы хотите, чтобы Nmap выполнял только ARP- сканирование без сканирования портов, вы можете использовать 
nmap -PR -sn TARGETS, где -PR указывает, что вам нужно только ARP- сканирование. Следующий пример показывает, что 
Nmap использует ARP для обнаружения хоста без сканирования портов. Мы запускаем, nmap -PR -sn MACHINE_IP/24чтобы 
обнаружить все работающие системы в той же подсети, что и наша целевая машина.         

Терминал пентестера
```commandline
pentester@TryHackMe$ sudo nmap -PR -sn 10.10.210.6/24

Starting Nmap 7.60 ( https://nmap.org ) at 2021-09-02 07:12 BST
Nmap scan report for ip-10-10-210-75.eu-west-1.compute.internal (10.10.210.75)
Host is up (0.00013s latency).
MAC Address: 02:83:75:3A:F2:89 (Unknown)
Nmap scan report for ip-10-10-210-100.eu-west-1.compute.internal (10.10.210.100)
Host is up (-0.100s latency).
MAC Address: 02:63:D0:1B:2D:CD (Unknown)
Nmap scan report for ip-10-10-210-165.eu-west-1.compute.internal (10.10.210.165)
Host is up (0.00025s latency).
MAC Address: 02:59:79:4F:17:B7 (Unknown)
Nmap scan report for ip-10-10-210-6.eu-west-1.compute.internal (10.10.210.6)
Host is up.
Nmap done: 256 IP addresses (4 hosts up) scanned in 3.12 seconds
```

В этом случае AttackBox имел IP-адрес 10.10.210.6 и использовал ARP- запросы для обнаружения активных хостов в той 
же подсети. ARP- сканирование работает, как показано на рисунке ниже. Nmap отправляет ARP- запросы всем целевым 
компьютерам, и те, которые находятся в сети, должны отправить ARP- ответ обратно.  



Если мы посмотрим на пакеты, сгенерированные с помощью такого инструмента, как tcpdump или Wireshark, мы увидим 
сетевой трафик, аналогичный показанному на рисунке ниже. На рисунке ниже Wireshark отображает исходный MAC-адрес, 
целевой MAC-адрес, протокол и запрос, относящиеся к каждому ARP- запросу. Исходный адрес — это MAC-адрес нашего 
AttackBox, а целевой — широковещательный адрес, поскольку мы не знаем MAC-адрес цели. Однако мы видим IP-адрес цели, 
который отображается в столбце «Информация». На рисунке мы видим, что мы запрашиваем MAC-адреса всех IP-адресов в 
подсети, начиная с 10.10.210.1. Хост с IP-адресом, о котором мы спрашиваем, отправит ARP- ответ со своим MAC-адресом,
и так мы узнаем, что он в сети.



Говоря об ARP- сканировании, следует упомянуть сканер, построенный на ARP- запросах: arp-scan; он предоставляет 
множество опций для настройки вашего сканирования. Посетите  вики arp-scan для получения подробной информации. Один 
из популярных вариантов — arp-scan --localnet или просто arp-scan -l. Эта команда отправит ARP- запросы на все 
допустимые IP-адреса в ваших локальных сетях. Более того, если в вашей системе более одного интерфейса, и вы хотите 
обнаружить активные хосты на одном из них, вы можете указать интерфейс с помощью -I. Например, sudo arp-scan -I eth0 
-l отправит ARP- запросы на все допустимые IP-адреса на eth0интерфейсе.     

Обратите внимание, что arp-scanон не установлен на AttackBox; однако его можно установить с помощью apt install arp-scan.

В примере ниже мы просканировали подсеть AttackBox с помощью arp-scan ATTACKBOX_IP/24. Поскольку мы запустили это 
сканирование в интервале времени, близком к предыдущему nmap -PR -sn ATTACKBOX_IP/24, мы получили те же три живые цели. 

Терминал пентестера
```commandline
pentester@TryHackMe$ sudo arp-scan 10.10.210.6/24
Interface: eth0, datalink type: EN10MB (Ethernet)
WARNING: host part of 10.10.210.6/24 is non-zero
Starting arp-scan 1.9 with 256 hosts (http://www.nta-monitor.com/tools/arp-scan/)
10.10.210.75	02:83:75:3a:f2:89	(Unknown)
10.10.210.100	02:63:d0:1b:2d:cd	(Unknown)
10.10.210.165	02:59:79:4f:17:b7	(Unknown)

4 packets received by filter, 0 packets dropped by kernel
Ending arp-scan 1.9: 256 hosts scanned in 2.726 seconds (93.91 hosts/sec). 3 responded
```
Аналогично, команда arp-scanсгенерирует много ARP- запросов, которые мы можем увидеть с помощью tcpdump, Wireshark 
или аналогичного инструмента. Мы можем заметить, что захват пакетов для arp-scan и nmap -PR -sn выдает похожие 
шаблоны трафика. Ниже приведен вывод Wireshark. 



Если вы закрыли сетевой симулятор, нажмите кнопку «Посетить сайт» в Задаче 2, чтобы снова отобразить его.

### Ответьте на вопросы ниже
Мы будем отправлять широковещательные пакеты ARP-запросов со следующими параметрами:

С компьютера1
На компьютер1 (чтобы указать, что идет трансляция)
Тип пакета: «ARP-запрос»
Данные: попробуйте все возможные восемь устройств (кроме компьютера 1) в сети: компьютер 2, компьютер 3, компьютер 4,
компьютер 5, компьютер 6, коммутатор 1, коммутатор 2 и маршрутизатор. 
Сколько устройств вы можете обнаружить с помощью ARP-запросов?
```commandline
3
```
## Задание 6
Мы можем выполнить ping каждого IP-адреса в целевой сети и посмотреть, кто ответит на наши ping запросы (ICMP Type 
8/Echo) ответом ping (ICMP Type 0). Просто, не правда ли? Хотя это был бы самый простой подход, он не всегда надежен.
Многие брандмауэры блокируют ICMP echo; новые версии MS Windows настроены с использованием хост-брандмауэра, который 
блокирует запросы ICMP echo по умолчанию. Помните, что запрос ARP будет предшествовать запросу ICMP, если ваша цель 
находится в той же подсети.    

Чтобы использовать эхо-запрос ICMP для обнаружения активных хостов, добавьте опцию -PE. (Не забудьте добавить ее, 
-sn если вы не хотите выполнять сканирование портов.) Как показано на следующем рисунке, эхо-сканирование ICMP 
работает путем отправки эхо-запроса ICMP и ожидает, что цель ответит эхо-ответом ICMP, если она находится в сети.

В примере ниже мы просканировали подсеть цели с помощью . Это сканирование отправит эхо-пакеты ICMP на каждый 
IP-адрес в подсети. Опять же, мы ожидаем ответа от активных хостов; однако разумно помнить, что многие брандмауэры 
блокируют ICMP. Вывод ниже показывает результат сканирования подсети класса C виртуальной машины с помощью AttackBox.
`nmap -PE -sn MACHINE_IP/24`
`sudo nmap -PE -sn MACHINE_IP/24 `  

Терминал пентестера
```commandline
pentester@TryHackMe$ sudo nmap -PE -sn 10.10.68.220/24

Starting Nmap 7.60 ( https://nmap.org ) at 2021-09-02 10:16 BST
Nmap scan report for ip-10-10-68-50.eu-west-1.compute.internal (10.10.68.50)
Host is up (0.00017s latency).
MAC Address: 02:95:36:71:5B:87 (Unknown)
Nmap scan report for ip-10-10-68-52.eu-west-1.compute.internal (10.10.68.52)
Host is up (0.00017s latency).
MAC Address: 02:48:E8:BF:78:E7 (Unknown)
Nmap scan report for ip-10-10-68-77.eu-west-1.compute.internal (10.10.68.77)
Host is up (-0.100s latency).
MAC Address: 02:0F:0A:1D:76:35 (Unknown)
Nmap scan report for ip-10-10-68-110.eu-west-1.compute.internal (10.10.68.110)
Host is up (-0.10s latency).
MAC Address: 02:6B:50:E9:C2:91 (Unknown)
Nmap scan report for ip-10-10-68-140.eu-west-1.compute.internal (10.10.68.140)
Host is up (0.00021s latency).
MAC Address: 02:58:59:63:0B:6B (Unknown)
Nmap scan report for ip-10-10-68-142.eu-west-1.compute.internal (10.10.68.142)
Host is up (0.00016s latency).
MAC Address: 02:C6:41:51:0A:0F (Unknown)
Nmap scan report for ip-10-10-68-220.eu-west-1.compute.internal (10.10.68.220)
Host is up (0.00026s latency).
MAC Address: 02:25:3F:DB:EE:0B (Unknown)
Nmap scan report for ip-10-10-68-222.eu-west-1.compute.internal (10.10.68.222)
Host is up (0.00025s latency).
MAC Address: 02:28:B1:2E:B0:1B (Unknown)
Nmap done: 256 IP addresses (8 hosts up) scanned in 2.11 seconds
```
Вывод сканирования показывает, что восемь хостов включены; более того, он показывает их MAC-адреса. Вообще говоря, мы не ожидаем узнать MAC-адреса целей, если только они не находятся в той же подсети, что и наша система. Вывод выше показывает, что Nmap не нужно было отправлять пакеты ICMP, поскольку он подтвердил, что эти хосты включены, на основе полученных ARP- ответов.

Мы повторим сканирование выше; однако на этот раз мы будем сканировать из системы, которая принадлежит другой подсети. Результаты будут похожими, но без MAC-адресов.

Терминал пентестера
```commandline
pentester@TryHackMe$ sudo nmap -PE -sn 10.10.68.220/24

Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 12:16 EEST
Nmap scan report for 10.10.68.50
Host is up (0.12s latency).
Nmap scan report for 10.10.68.52
Host is up (0.12s latency).
Nmap scan report for 10.10.68.77
Host is up (0.11s latency).
Nmap scan report for 10.10.68.110
Host is up (0.11s latency).
Nmap scan report for 10.10.68.140
Host is up (0.11s latency).
Nmap scan report for 10.10.68.142
Host is up (0.11s latency).
Nmap scan report for 10.10.68.220
Host is up (0.11s latency).
Nmap scan report for 10.10.68.222
Host is up (0.11s latency).
```
Nmap done: 256 IP addresses (8 hosts up) scanned in 8.26 seconds
Если вы посмотрите на сетевые пакеты с помощью инструмента типа Wireshark, вы увидите что-то похожее на изображение 
ниже. Вы можете видеть, что у нас есть один исходный IP-адрес в другой подсети, нежели целевой подсети, отправляющий 
запросы ICMP echo на все IP-адреса в целевой подсети, чтобы увидеть, какой из них ответит.  



Поскольку запросы ICMP echo, как правило, блокируются, вы также можете рассмотреть запросы ICMP Timestamp или ICMP 
Address Mask, чтобы определить, находится ли система в сети. Nmap использует запрос временной метки (ICMP Type 13) и 
проверяет, получит ли он ответ Timestamp (ICMP Type 14). Добавление этой -PPопции сообщает Nmap использовать запросы 
ICMP timestamp. Как показано на рисунке ниже, вы ожидаете ответа от активных хостов.



В следующем примере мы запускаем `nmap -PP -sn MACHINE_IP/24` обнаружение подключенных к сети компьютеров в подсети 
целевых машин.

Терминал пентестера
```commandline
pentester@TryHackMe$ sudo nmap -PP -sn 10.10.68.220/24

Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 12:06 EEST
Nmap scan report for 10.10.68.50
Host is up (0.13s latency).
Nmap scan report for 10.10.68.52
Host is up (0.25s latency).
Nmap scan report for 10.10.68.77
Host is up (0.14s latency).
Nmap scan report for 10.10.68.110
Host is up (0.14s latency).
Nmap scan report for 10.10.68.140
Host is up (0.15s latency).
Nmap scan report for 10.10.68.209
Host is up (0.14s latency).
Nmap scan report for 10.10.68.220
Host is up (0.14s latency).
Nmap scan report for 10.10.68.222
Host is up (0.14s latency).
Nmap done: 256 IP addresses (8 hosts up) scanned in 10.93 seconds
```
Подобно предыдущему сканированию ICMP, это сканирование отправит множество запросов на временные метки ICMP на 
каждый допустимый IP-адрес в целевой подсети. На снимке экрана Wireshark ниже вы можете видеть один исходный 
IP-адрес, отправляющий пакеты ICMP на каждый возможный IP-адрес для обнаружения хостов в сети.  



Аналогично, Nmap использует запросы маски адреса (ICMP Type 17) и проверяет, получает ли он ответ маски адреса (ICMP 
Type 18). Это сканирование можно включить с помощью опции -PM. Как показано на рисунке ниже, ожидается, что активные 
хосты будут отвечать на запросы маски адреса ICMP.  



В попытке обнаружить работающие хосты с помощью запросов маски адреса ICMP мы запускаем команду nmap -PM -sn 
MACHINE_IP/24. Хотя на основе предыдущих сканирований мы знаем, что по крайней мере восемь хостов активны, это 
сканирование не вернуло ни одного. Причина в том, что целевая система или брандмауэр на маршруте блокирует этот тип 
пакета ICMP. Поэтому важно изучить несколько подходов для достижения того же результата. Если блокируется один тип 
пакета, мы всегда можем выбрать другой, чтобы обнаружить целевую сеть и службы.

Терминал пентестера
```commandline
pentester@TryHackMe$ sudo nmap -PM -sn 10.10.68.220/24

Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 12:13 EEST
Nmap done: 256 IP addresses (0 hosts up) scanned in 52.17 seconds
```

Хотя мы не получили никакого ответа и не смогли выяснить, какие хосты находятся в сети, важно отметить, что это 
сканирование отправляло запросы маски адреса ICMP на каждый действительный IP-адрес и ждало ответа. Каждый запрос 
ICMP отправлялся дважды, как мы можем видеть на снимке экрана ниже.  



### Ответьте на вопросы ниже
Какая опция необходима, чтобы указать Nmap использовать метку времени ICMP для обнаружения активных хостов?
```commandline
-PP
```
Какая опция необходима, чтобы указать Nmap использовать маску адреса ICMP для обнаружения активных хостов?
```commandline
-PM
```
Какая опция необходима, чтобы указать Nmap использовать ICMP Echo для обнаружения активных хостов?
```commandline
-PE
```

## Задание 7
#### TCP SYN-пинг

Мы можем отправить пакет с флагом SYN (синхронизация), установленным на порт TCP , по умолчанию 80, и ждать ответа. 
Открытый порт должен ответить SYN/ACK (подтверждение); закрытый порт приведет к RST (сброс). В этом случае мы только 
проверяем, получим ли мы какой-либо ответ, чтобы сделать вывод, работает ли хост. Конкретное состояние порта здесь 
не имеет значения. Рисунок ниже является напоминанием о том, как обычно работает трехстороннее рукопожатие TCP.

Если вы хотите, чтобы Nmap использовал TCP SYN ping, вы можете сделать это с помощью опции, -PS за которой следует 
номер порта, диапазон, список или их комбинация. Например, -PS21будет нацелен на порт 21, в то время как 
-PS21-25будет нацелен на порты 21, 22, 23, 24 и 25. Наконец, -PS80,443,8080будет нацелен на три порта 80, 443 и 8080.  

Привилегированные пользователи (root и sudoers) могут отправлять пакеты TCP SYN и не обязаны завершать трехстороннее 
рукопожатие TCP , даже если порт открыт, как показано на рисунке ниже. У непривилегированных пользователей нет 
выбора, кроме как завершить трехстороннее рукопожатие, если порт открыт.  



Мы запустим nmap -PS -sn MACHINE_IP/24 сканирование целевой подсети VM. Как мы видим в выводе ниже, нам удалось 
обнаружить пять хостов. 

Терминал пентестера
```commandline
pentester@TryHackMe$ sudo nmap -PS -sn 10.10.68.220/24
Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 13:45 EEST
Nmap scan report for 10.10.68.52
Host is up (0.10s latency).
Nmap scan report for 10.10.68.121
Host is up (0.16s latency).
Nmap scan report for 10.10.68.125
Host is up (0.089s latency).
Nmap scan report for 10.10.68.134
Host is up (0.13s latency).
Nmap scan report for 10.10.68.220
Host is up (0.11s latency).
Nmap done: 256 IP addresses (5 hosts up) scanned in 17.38 seconds
```
Давайте подробнее рассмотрим, что произошло за кулисами, взглянув на сетевой трафик в Wireshark на рисунке ниже. 
Технически говоря, поскольку мы не указали никаких портов TCP для использования в сканировании TCP ping, Nmap 
использовал общие порты; в данном случае это порт TCP 80. Ожидается, что любая служба, прослушивающая порт 80, 
ответит, косвенно указывая, что хост находится в сети.


#### TCP ACK пинг

Как вы уже догадались, это отправляет пакет с установленным флагом ACK. Вы должны запустить Nmap как 
привилегированный пользователь, чтобы иметь возможность сделать это. Если вы попробуете это как непривилегированный 
пользователь, Nmap попытается выполнить трехстороннее рукопожатие.  

По умолчанию используется порт 80. Синтаксис похож на TCP SYN ping. -PA должен сопровождаться номером порта, 
диапазоном, списком или их комбинацией. Например, рассмотрим -PA21, -PA21-25и -PA80,443,8080. Если порт не указан, 
будет использоваться порт 80.  

На следующем рисунке показано, что любой пакет TCP с флагом ACK должен получить обратно пакет TCP с установленным 
флагом RST. Цель отвечает установленным флагом RST, поскольку пакет TCP с флагом ACK не является частью какого-либо 
текущего соединения. Ожидаемый ответ используется для определения того, работает ли целевой хост.  



В этом примере мы запускаем sudo nmap -PA -sn MACHINE_IP/24 обнаружение онлайн-хостов в целевой подсети. Мы видим, 
что сканирование TCP ACK ping обнаружило пять хостов как работающих.

Терминал пентестера
```commandline
pentester@TryHackMe$ sudo nmap -PA -sn 10.10.68.220/24
Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 13:46 EEST
Nmap scan report for 10.10.68.52
Host is up (0.11s latency).
Nmap scan report for 10.10.68.121
Host is up (0.12s latency).
Nmap scan report for 10.10.68.125
Host is up (0.10s latency).
Nmap scan report for 10.10.68.134
Host is up (0.10s latency).
Nmap scan report for 10.10.68.220
Host is up (0.10s latency).
Nmap done: 256 IP addresses (5 hosts up) scanned in 29.89 seconds
```
Если мы посмотрим на сетевой трафик, как показано на рисунке ниже, мы обнаружим множество пакетов с установленным 
флагом ACK, отправленных на порт 80 целевых систем. Nmap отправляет каждый пакет дважды. Системы, которые не 
отвечают, находятся в автономном режиме или недоступны.  



#### UDP -пинг

Наконец, мы можем использовать UDP , чтобы узнать, находится ли хост в сети. В отличие от TCP SYN ping, отправка 
пакета UDP на открытый порт не должна приводить к какому-либо ответу. Однако, если мы отправим пакет UDP на закрытый 
порт UDP , мы ожидаем получить пакет ICMP о недоступности порта; это означает, что целевая система работает и доступна.  

На следующем рисунке мы видим UDP- пакет, отправленный на открытый UDP- порт и не вызвавший никакого ответа. Однако 
отправка UDP- пакета на любой закрытый UDP- порт может вызвать ответ, косвенно указывающий на то, что цель находится 
в сети.  





Синтаксис для указания портов похож на синтаксис TCP SYN ping и TCP ACK ping; Nmap использует его -PU для UDP ping. В 
следующем примере мы используем UDP- сканирование и обнаруживаем пять активных хостов. 

Терминал пентестера
```commandline
pentester@TryHackMe$ sudo nmap -PU -sn 10.10.68.220/24
Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 13:45 EEST
Nmap scan report for 10.10.68.52
Host is up (0.10s latency).
Nmap scan report for 10.10.68.121
Host is up (0.10s latency).
Nmap scan report for 10.10.68.125
Host is up (0.14s latency).
Nmap scan report for 10.10.68.134
Host is up (0.096s latency).
Nmap scan report for 10.10.68.220
Host is up (0.11s latency).
Nmap done: 256 IP addresses (5 hosts up) scanned in 9.20 seconds
```


Давайте проверим сгенерированные пакеты UDP . На следующем снимке экрана Wireshark мы видим, что Nmap отправляет 
пакеты UDP на порты UDP , которые, скорее всего, закрыты. На изображении ниже показано, что Nmap использует 
необычный порт UDP для запуска ошибки ICMP destination unreachable (port unreachable).



#### Массскан

Кстати, Masscan использует похожий подход для обнаружения доступных систем. Однако, чтобы быстро завершить 
сканирование сети, Masscan довольно агрессивен в отношении скорости генерируемых пакетов. Синтаксис довольно похож: 
-p может сопровождаться номером порта, списком или диапазоном. Рассмотрим следующие примеры:


```commandline
masscan MACHINE_IP/24 -p443
masscan MACHINE_IP/24 -p80,443
masscan MACHINE_IP/24 -p22-25
masscan MACHINE_IP/24 ‐‐top-ports 100
```
Masscan не установлен на AttackBox, однако его можно установить с помощью `apt install masscan`.

### Ответьте на вопросы ниже
Какое сканирование TCP ping не требует привилегированной учетной записи?
```commandline
TCP SYN Ping
```
Для какого сканирования TCP-ping требуется привилегированная учетная запись?
```commandline
TCP ACK Ping
```
Какую опцию необходимо добавить в Nmap для запуска сканирования TCP SYN ping на порту Telnet?
```commandline
-PS23
```

## Задание 8
Поведение Nmap по умолчанию заключается в использовании обратных DNS- хостов в сети. Поскольку имена хостов могут 
многое раскрыть, это может быть полезным шагом. Однако, если вы не хотите отправлять такие DNS- запросы, вы можете 
-n пропустить этот шаг. 

По умолчанию Nmap будет искать онлайн-хосты; однако вы можете использовать опцию -R для запроса DNS- сервера даже для 
офлайн-хостов. Если вы хотите использовать определенный DNS- сервер, вы можете добавить  --dns-servers DNS_SERVER 
опцию.  

### Ответьте на вопросы ниже
Мы хотим, чтобы Nmap выполнил обратный DNS-поиск для всех возможных хостов в подсети, надеясь получить некоторую 
информацию из имен. Какую опцию нам следует добавить? 

```commandline
-R
```

## Задание 9
Вы узнали, как ARP , ICMP, TCP и UDP могут обнаруживать активные хосты, завершив эту комнату. Любой ответ от хоста 
является указанием на то, что он в сети. Ниже приведен краткий обзор параметров командной строки для Nmap, которые 
мы рассмотрели.  


- ARP -сканирование	sudo nmap -PR -sn MACHINE_IP/24
- Эхо-сканирование ICMP	sudo nmap -PE -sn MACHINE_IP/24
- Сканирование временных меток ICMP	sudo nmap -PP -sn MACHINE_IP/24
- Сканирование маски адреса ICMP	sudo nmap -PM -sn MACHINE_IP/24
- TCP SYN Ping-сканирование	sudo nmap -PS22,80,443 -sn MACHINE_IP/30
- TCP ACK Ping-сканирование	sudo nmap -PA22,80,443 -sn MACHINE_IP/30
- UDP- пинг-сканирование	sudo nmap -PU53,161,162 -sn MACHINE_IP/30

Не забудьте добавить -sn, если вас интересует только обнаружение хоста без сканирования портов. Если пропустить, 
Nmap-sn по умолчанию будет сканировать порты активных хостов. 

- -n	нет DNS- поиска
- -R	обратный DNS- поиск для всех хостов
- -sn	только обнаружение хоста
### Ответьте на вопросы ниже
Убедитесь, что вы приняли к сведению все опции Nmap, описанные в этой комнате. Чтобы продолжить изучение Nmap, 
присоединяйтесь к комнате  Nmap Basic Port Scans , которая знакомит с основными типами сканирования портов.

```commandline
Ответ не нужен
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)