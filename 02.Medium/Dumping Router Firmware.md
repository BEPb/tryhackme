[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Dumping Router Firmware](https://tryhackme.com/r/room/rfirmware) 

Всего 3 задания:
## Задание 1
Установка необходимого программного обеспечения

Каждый год миллионы домашних маршрутизаторов продаются потребителям; большинство из них даже не знают, что на них 
работает. Сегодня мы собираемся взглянуть. Прежде чем продолжить, нам понадобятся несколько инструментов:

- Доступ к дистрибутиву Linux (или WSL) со строками и binwalk.
- Прошивка Linksys WRT1900ACS v2 находится здесь:  https://github.com/Sq00ky/Dumping-Router-Firmware-Image/
- Наконец, убедитесь, что binwalk поддерживает JFFS2, с помощью следующей команды :

```commandline
sudo pip install cstruct; 
git clone https://github.com/sviehb/jefferson;
cd jefferson && sudo python setup.py install
```
После того, как вы приобрели инструменты, вы готовы обустроить свое рабочее место!

Пересборка прошивки

Сначала мы клонируем репозиторий, содержащий прошивку:
```commandline
git clone https://github.com/Sq00ky/Dumping-Router-Firmware-Image/ /opt/Dumping-Router-Firmware && cd /opt/Dumping-Router-Firmware/
```
Далее мы распакуем многокомпонентный zip-файл :
```commandline
7z x ./FW_WRT1900ACSV2_2.0.3.201002_prod.zip
```
запустив,  ls вы должны увидеть образ прошивки:
```commandline
FW_WRT1900ACSV2_2.0.3.201002_prod.img
```
Наконец, запустив sha256sum  образ прошивки, вы должны получить значение  dbbc9e8673149e79b7fd39482ea95db78bdb585c3fa3613e4f84ca0abcea68a4

### Ответьте на вопросы ниже
Загрузите прошивку и настройте свое рабочее место!
```commandline
Ответ не нужен
```

## Задание 2
Анализ глубиной в один дюйм

В этом разделе мы рассмотрим прошивку, проверим строки и сделаем дамп файловой системы из образа. Следующий раздел будет посвящен монтированию и исследованию файловой системы.

### Ответьте на вопросы ниже
При запуске строк в файле есть много заметного открытого текста. Это связано с тем, что некоторые аспекты образа 
прошивки не зашифрованы. Это, вероятно, означает, что с помощью Binwalk мы можем выгрузить прошивку из образа.

Что означает первая строка открытого текста при запуске строк в файле?

```commandline
Linksys WRT1900ACS Router
```

Также, используя строки, какая операционная система работает на устройстве?

```commandline
Linux
```

Прокручивая строки, вы можете заметить еще несколько интересных строк, например: 


и различные другие файлы lua. Это действительно заставляет задуматься, что там внутри происходит.
```commandline
/bin/занятыйбокс
```

Далее мы выгрузим файловую систему из файла образа. Для этого мы воспользуемся инструментом binwalk.

Binwalk — это инструмент, который проверяет известные сигнатуры файлов в заданном файле. Это может быть полезно для 
многих вещей; он даже используется в стеганографии. Файл может быть скрыт внутри фотографии, и Binwalk покажет это и 
поможет нам извлечь его. В этом случае мы будем использовать его для извлечения файловой системы маршрутизатора.
```commandline
Ответ не нужен
```
Какая опция в Binwalk позволит нам извлечь файлы из образа прошивки?
```commandline
-e
```
Теперь, когда мы знаем, как извлечь содержимое образа прошивки, какой элемент был извлечен первым?
```commandline
uImage header
```
Какова дата создания?
```commandline
2020-04-22 11:07:26
```
Циклическая проверка избыточности используется аналогично хешированию файлов, чтобы гарантировать, что содержимое 
файла не было повреждено и/или изменено при передаче.

Каков CRC изображения ?
```commandline
0xABEBC439
```
Каков размер изображения?
```commandline
4229755 bytes
```
Какая архитектура используется в устройстве?
```commandline
ARM
```
Исследуем результаты по вопросу 10, верно ли это?
```commandline
Yes
```
Вы заметите, что были извлечены два файла: один из них — файловая система jffs2, а другой, по мнению Binwalk, 
предназначен для сжатия сжатых данных с помощью gzip.

Вы можете попытаться извлечь данные, но вы ничего не добьетесь. Binwalk неверно истолковал данные. Однако мы все еще 
можем провести их анализ. 

Запустив строки на 6870, мы замечаем большой кусок открытого текста. Мы можем повторно запустить binwalk для этого 
файла, чтобы получить еще больше файлов для исследования. Достаточно интересно, что копия ядра Linux включена. Для 
какой версии это?

```commandline
3.10.39
```

Предположим, вы извлекаете содержимое 6870 с помощью Binwalk и запускаете строки на 799E38.cpio, вы можете увидеть 
много шестнадцатеричных чисел в нижней части файла. Часть из них можно перевести в понятный человеку текст. Часть из 
них интересна и заставляет задуматься о ее назначении. Дополнительное расследование может раскрыть ее назначение. Я 
оставлю вас исследовать это самостоятельно, хотя :)
```commandline
Ответ не нужен
```

Продолжая анализ, у нас есть файловая система jffs2, содержимое которой мы можем изучить. Сначала мы должны ее 
смонтировать, что приведет нас к следующему разделу.
```commandline
Ответ не нужен
```

## Задание 3
Монтирование файловой системы

В этом разделе мы начнем рассматривать, как монтировать файловую систему. Обратите внимание, если вы делаете это с любой другой файловой системой, не в формате Little Endian, вы должны преобразовать ее из Big Endian в Little Endian с помощью инструмента jffs2dump. Но вот достаточно краткое руководство по монтированию файловой системы:

Шаг 1. Если /dev/mtdblock0 существует, удалите файл/каталог и заново создайте блочное устройство.

rm -rf /dev/mtdblock0
mknod /dev/mtdblock0 b 31 0
Шаг 2. Создайте место для размещения файловой системы jffs2
mkdir /mnt/jffs2_file/
Шаг 3. Загрузите необходимые модули ядра
modprobe jffs2
modprobe mtdram
modprobe mtdblock
Шаг 4. Записать образ в /dev/mtdblock0
dd if=/opt/Dumping-Router-Firmware-Image/_FW_WRT1900ACSV2_2.0.3.201002_prod.img.extracted/600000.jffs2 of=/dev/mtdblock0
Шаг 5. Монтируем файловую систему в папку
mount -t jffs2 /dev/mtdblock0 /mnt/jffs2_file/
Шаг 6. Наконец, перейдите в смонтированную файловую систему.
cd /mnt/jffs2_file/

Чтобы немного объяснить, что делает команда, мы создаем блочное устройство (mtdblock ( Memory Technology Device )), которое позволит нам сделать дамп флэш-памяти. Сначала мы удаляем его, если он существует, а затем создаем заново.

Далее мы создаем место для монтирования нашего файла jffs2 .

После этого мы загружаем некоторые модули ядра, которые позволят нам взаимодействовать с файловой системой jffs2 и делать дамп флэш-памяти.

Далее мы записываем файловую систему на блочное устройство, после чего монтируем устройство mtdblock  , которое теперь содержит флэш-память файловой системы. 

Наконец, выполнив команду,  мы теперь находимся внутри сброшенной прошивки маршрутизатора и можем начать расследование. cd /mnt/jffs2_file/ 
### Ответьте на вопросы ниже
Запуск ls -la раскрывает много интересной информации. Во-первых, мы замечаем, что многие файлы символически связаны (похоже на ярлык). 

Куда ссылается linuxrc?

```commandline
/bin/busybox
```

На какую родительскую папку ссылаются mnt, opt и var?

```commandline
/tmp/
```

В какой папке будет храниться HTTP-сервер маршрутизатора?

```commandline
/www/
```

Просматривая множество этих папок, вы можете заметить, что они пусты. Это крайне странно, но это потому, что маршрутизатор не запущен и не работает. Помните, мы просто смотрим на шаблон файловой системы, которая будет прошита на маршрутизаторе, а не на прошивку маршрутизатора, которая была сброшена. Другая информация о маршрутизаторе может содержаться в предыдущем разделе в блоке 6870.

Первая из папок, которая не пуста, — это /bin/; куда ссылается большинство файлов?

Почему так? Ну, busybox — это более или менее набор инструментов для выполнения общих команд в среде Unix .

```commandline
busybox
```

Интересно, какая база данных будет запущена в папке bin, если маршрутизатор будет подключен к сети?

```commandline
sqlite3
```
Следующая примечательная папка, представляющая интерес, это /etc/. Эта папка содержит множество файлов конфигурации для маршрутизатора, таких как уровни мощности точек доступа, регулируемые определенными странами. Одна из них, которую вы можете знать, — это FCC (Федеральная комиссия по связи).

Мы даже можем увидеть дату сборки устройства. Какая дата сборки? 

```commandline
2020-04-22 11:44
```

На устройстве даже есть файлы, связанные с SSH-сервером. Какой SSH-сервер работает на машине?

```commandline
dropbear
```

Мы даже можем увидеть файл для медиасервера, какая компания его разработала?

Эта компания когда-то владела Linksys, и, вероятно, поэтому она до сих пор используется.

```commandline
Cisco
```

Какой файл в /etc/ содержит список стандартных сетевых служб и связанных с ними номеров портов?

```commandline
services
```

Какой файл содержит настройки системы по умолчанию?

```commandline
system_defaults
```

Какая конкретная версия прошивки находится в папке /etc/?

```commandline
2.0.3.201002
```

Возвращаясь к папке JNAP, JNAP API (ранее известный как HNAP, Home Network Administration Protocol) был 
потенциальным вектором атаки и уязвимостью в прошлом, что эта статья освещает  здесь . Достаточно интересно, что 
воспоминание об этом все еще здесь сегодня на устройствах Linksys. Переход на http://<Default_Gateway>/JNAP/ на 
маршрутизаторе Linksys показывает интересный 404. Значительно отличающийся от стандартного 404.

Доступ к /JNAP/

Доступ к любому другому недействительному URI

Это заставляет задуматься, а есть ли там что-то еще? Если вы исследуете папку /JNAP/modules в сброшенной файловой 
системе, вы увидите некоторое содержимое, связанное с устройством и предлагаемыми им службами, некоторые из них — 
брандмауэры, http-прокси, QoS, VPN-серверы, uPnP, SMB, фильтрация MAC-адресов, FTP и т. д.

Примечание: Если у вас есть маршрутизатор Linksys и вы заинтересованы в дальнейшем экспериментировании, я нашел этот 
репозиторий Github  для инструментов для взаимодействия с JNAP, я решил не включать его в комнату, поскольку не у 
всех есть доступ к маршрутизатору Linksys. Я не пойду дальше изучения файловой системы.

Какие три сети имеют папку в /JNAP/modules?

```commandline
guest_lan, lan, wan
```

После папки JNAP, lib — единственная папка с каким-либо содержимым, и то, что там находится, стандартно с точки 
зрения библиотек. Остальная часть файловой системы относительно пуста, что приводит нас к концу этой комнаты.

Надеюсь, я заставил вас всех больше интересоваться тем, что происходит в вашем устройстве; самое главное, я надеюсь, 
что вам понравилось. Я призываю всех вас выйти на свой собственный путь и получить прошивку вашего маршрутизатора, 
сделать дамп прошивки и посмотреть, что происходит внутри вашего устройства.

В будущем может появиться комната о кабельных модемах. Однако образы прошивок кабельных модемов относительно 
труднодоступны, поскольку они распространяются только среди CMO (операторов кабельных модемов, таких как Charter, 
Xfinity, Cox и т. д.)
```commandline
Ответ не нужен
```

[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)