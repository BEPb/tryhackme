[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Active Directory Hardening](https://tryhackme.com/r/room/activedirectoryhardening) 

Всего 7 заданий:
## Задание 1
Active Directory ( AD ) широко используется почти каждой крупной организацией для управления, контроля и руководства сетью компьютеров, серверов и других устройств. Целью занятия является обучение базовым концепциям укрепления AD в соответствии с лучшими практиками кибербезопасности.

#### Цели обучения
В этом зале мы рассмотрим следующие темы:
- Безопасные методы аутентификации
- Защита хостов с помощью групповых политик
- Реализация модели наименьших привилегий
- Защита от известных атак AD
- План восстановления (сценарий после компрометации)

#### Предпосылки
Прежде чем приступить к изучению этого раздела, мы рекомендуем вам ознакомиться со следующими разделами, чтобы получить четкое представление о Windows AD :
- Основы Active Directory 
- Взлом Active Directory 
- Стандартные технологии, используемые в  корпоративной среде

#### Подключение к машине
В качестве машины для разработки/тестирования мы будем использовать Windows Server 2019 со следующими учетными данными:
- IP-адрес:MACHINE_IP
- Имя пользователя:Administrator
- Пароль: tryhackmewouldnotguess1@
Вы можете получить доступ к виртуальной машине , нажав Start Machine. Машина запустится в режиме разделенного экрана. Если виртуальная машина не видна, используйте синюю Show Split Viewкнопку в правом верхнем углу страницы. Кроме того, вы можете получить доступ к виртуальной машине через удаленный рабочий стол, используя указанные выше учетные данные.
Давайте начнем.
### Ответьте на вопросы ниже
Я могу успешно подключиться к машине AD.
```commandline
Ответ не нужен
```

## Задание 2
#### Домен
Домен выступает в качестве основной единицы логической структуры Active Directory. Он изначально хранит всю 
критическую информацию об объектах, которые принадлежат только домену.  

#### Контроллер домена
Контроллер домена — это сервер Active Directory, который действует как мозг для домена сервера Windows; он 
контролирует всю сеть. В пределах домена он действует как привратник для аутентификации пользователей и авторизации 
ИТ-ресурсов.

#### Деревья и леса
Деревья и леса — две наиболее важные концепции Active Directory.

**Деревья**
Деревья отвечают за распределение ресурсов между доменами. Связь между доменами внутри дерева возможна как с 
односторонним, так и с двусторонним доверием. Когда домен добавляется в Дерево, он становится Дочерним доменом того 
конкретного домена, к которому он добавляется — теперь Родительским доменом.

**Леса**
Когда обмен стандартным глобальным каталогом, схемой каталога, логической структурой и конфигурацией каталога между 
коллекциями деревьев выполнен успешно, это называется лесом. Связь между двумя лесами становится возможной после  
создания доверия на уровне леса.

**Доверие к Active Directory** 
Доверие AD — это установленный мост связи между доменами в Active Directory. Когда мы говорим, что один домен 
доверяет другому в сети AD, это означает, что его ресурсы могут быть совместно использованы с другим доменом. Однако 
ресурсы одного домена не доступны напрямую для каждого другого домена, так как это небезопасно. Таким образом, 
доступность совместного использования ресурсов регулируется доверительными отношениями в AD. Доверительные 
отношения AD делятся на две категории, которые классифицируются на основе их характеристик или текущего направления.

Доверия AD, классифицированные на основе характеристик, известны как транзитивные и нетранзитивные. Транзитивное 
доверие отражает двустороннюю связь между доменами. Если есть три домена, домен A доверяет домену B, а домен B имеет 
транзитивное доверие с доменом C. Следовательно, домен A будет автоматически доверять домену C для совместного 
использования ресурсов.

Опять же, доверительные отношения AD бывают двух типов, если классифицировать их по направлению: односторонние и 
двусторонние доверительные отношения. Вы можете получить доступ к доверительным отношениям AD следующим образом:
Server Manager > Tools > Active Directory Domains and Trust

как получить доступ к доменам и трастам AD

**Контейнер и листья**
Для тех, кто знаком, каждая часть сети рассматривается как объект в AD. Все, что угодно, от ресурсов, пользователей,
служб или части сети, может быть объектом.  Иерархическая структура AD определяет, что объект может содержать или не 
содержать другие объекты в зависимости от сценария. Когда объект содержит другой объект, он называется контейнером; 
в противном случае он называется конечным объектом.

### Ответьте на вопросы ниже
Какой корневой домен на подключенной машине AD?
```commandline
tryhackme.loc
```

## Задание 3
В этой задаче мы кратко изучим различные методы аутентификации безопасности, которые можно использовать для 
безопасной связи и обеспечения целостности данных с одной машины на другую в среде AD. Мы будем использовать 
встроенный инструмент Microsoft Group Policy Management Editor, доступный на прикрепленной машине AD, для настройки 
различных политик безопасности. Инструкции по доступу к инструменту приведены ниже:

как получить доступ к редактору управления групповой политикой

Хэш LAN Manager 
Пароль учетной записи пользователя для Windows не хранится в открытом виде; вместо этого он хранит пароли с двумя 
типами хэш-представления. Когда пароль для любой учетной записи пользователя изменяется или устанавливается с менее 
чем 15 символами, как LM-хэш (LAN Manager-хэш), так и NT-хэш (Windows NT-хэш) генерируются Windows и могут быть 
сохранены в AD. LM-хэш относительно слабее NT и подвержен быстрой атаке методом подбора.  Лучшая рекомендация — 
запретить Windows хранить LM-хэш пароля. Вы можете получить к нему доступ следующим образом:

Group Policy Management Editor > Computer Configuration > Policies > Windows Settings > Security Settings > Local 
Policies > Security Options > double click Network security - Do not store LM hash value on next password change 
policy > select "Define policy setting"

как отключить хранение хэш-значений LM

#### Подписание  SMB
SMB означает Server Message Block (блок сообщений сервера). Обычно сети на базе Microsoft используют этот протокол 
для обмена файлами и печати. Более того, он обеспечивает безопасную передачу по сети. Настройка подписи SMB через 
групповую политику имеет решающее значение для  обнаружения атак Man in the Middle (MiTM), которые могут привести к 
изменению трафика SMB при передаче. Подпись SMB обеспечивает целостность данных как для клиента, так и для сервера.  
Все поддерживаемые версии Windows имеют опцию подписи пакетов SMB.

Group Policy Management Editor > Computer Configuration > Policies > Windows Settings > Security Settings > Local 
Policies > Security Options > double click Microsoft network server: Digitally sign communication (always) > select 
Enable Digitally Sign Communications

как включить SMB-подписание

#### Подписание LDAP
Light Weight Directory Access Protocol (LDAP) позволяет находить и аутентифицировать ресурсы в сети. Хакеры могут 
внедрять атаки повторного воспроизведения или MiTM для запуска пользовательских запросов LDAP. Таким образом, 
подпись LDAP является свойством Simple Authentication and Security Layer (SASL), которое принимает только 
подписанные запросы LDAP и игнорирует другие запросы (текстовые или не-SSL).  Мы можем включить подпись LDAP 
следующим образом:
 Group Policy Management Editor > Computer Configuration > Policies > Windows Settings > Security Settings > Local 
Policies > Security Options > Domain controller: LDAP server signing requirements > select Require signing from the dropdown

как подписать LDAP-сервер

#### Ротация паролей 
Безопасность паролей Active Directory критически важна из-за нарушений безопасности и повторного использования 
паролей. Для любой организации становится сложным сбросить пароли учетных записей или обновить их везде, поэтому они 
предпочитают этого не делать.  Этот сценарий может иметь несколько альтернативных подходов, и у каждого метода есть 
свои плюсы и минусы.
- Первый метод:  создание скрипта для автоматического обновления паролей в запланированной задаче с помощью 
PowerShell. Этот метод не требует дополнительных накладных расходов и устраняет все ручные усилия по ротации паролей, но он требует от вас написания и поддержки вашего скрипта, что может быть сложным. 
- Второй метод: добавьте решение Multi-Factor Authentication (MFA) в AD и не меняйте пароль слишком часто. Это 
  добавляет уровень безопасности, и вам не придется часто менять пароль. Подробнее о внедрении MFA можно прочитать здесь .
- Третий метод: Microsoft предоставляет решение для ротации паролей учетных записей служб через Group Managed 
  Services Accounts (gMSAs), которые меняют пароли каждые 30 дней. Подробнее об этом можно узнать здесь .

#### Политика паролей
Злоумышленники используют различные методы компрометации корпоративных паролей, включая brute force, dictionary, 
password spraying, account data attacks и т. д. Все организации должны иметь строгую политику паролей для защиты от 
всех таких атак. Политики паролей означают различные правила создания паролей, включая длину, сложность и частоту 
смены.  Для просмотра и настройки политики паролей вы можете использовать следующее:
Group Policy Management Editor > Computer Configuration > Policies > Windows Settings > Security Settings > Account Policies > Password Policy

как установить максимальный срок действия пароля

Понимание настроек политики паролей
- Обеспечьте сохранность истории паролей:  не допускайте установки как минимум 10–15 старых паролей в качестве новых. 
- Минимальная длина пароля:  минимальная длина пароля должна быть от 10 до 14.
- Требования к сложности:  пароль не должен содержать имя учетной записи пользователя и должен содержать заглавные 
  буквы, строчные буквы, цифры или специальные символы.
### Ответьте на вопросы ниже
Измените настройки групповой политики в виртуальной машине, чтобы она не сохраняла хэш LAN Manager при следующей смене пароля.
```commandline
Ответ не нужен
```
Какова минимальная длина пароля по умолчанию (количество символов) в подключенной виртуальной машине?
```commandline
7
```

## Задание 4
Реализация модели наименьших привилегий требует ограничения доступа пользователя или приложения для минимизации 
рисков безопасности и поверхностей атак. Когда приложению или пользователям разрешено работать с административными 
привилегиями, им предоставляется полный доступ для изменения, изменения, создания других ресурсов в системе и 
выполнения любых действий с административными правами. В отличие от этого, модель наименьших привилегий 
предоставляет ограниченный и авторизованный доступ в соответствии с текущими условиями.

Каковы преимущества внедрения модели наименьших привилегий?

#### Создание правильного типа счетов
Реализация модели наименьших привилегий требует настройки различных типов учетных записей для различных целей. Она включает следующие типы учетных записей:
- Учетные записи пользователей : Вы должны продвигать использование обычных учетных записей пользователей для 
большинства людей в сети, которые необходимы для выполнения своих обычных обязанностей.
- Привилегированные учетные записи: это учетные записи с повышенными привилегиями, которые далее классифицируются как 
  учетные записи первой и второй привилегий. 
- Общие учетные записи : Эти учетные записи являются общими для группы людей, как посетителей с минимальными 
  привилегиями, чтобы предоставить ограниченный доступ на определенное время. Эти учетные записи не рекомендуются и должны использоваться в ограниченных сценариях. 
#### Контроль доступа на основе ролей  на хостах
Для системного администратора крайне важно предоставлять права на ресурсы, учитывая принцип наименьших привилегий, который  гласит  :
Согласно Википедии, « Принцип минимальных привилегий или принцип наименьших полномочий требует, чтобы на определенном уровне абстракции вычислительной среды каждый модуль (например, процесс, пользователь или программа, в зависимости от субъекта) имел возможность доступа только к той информации и ресурсам, которые необходимы для его законного назначения ».

Управление доступом на основе ролей позволяет вам указывать привилегии доступа на разных уровнях. Оно включает уровни записи зоны DNS , сервера или ресурса и определяет, кто имеет контроль доступа к созданию, редактированию и удалению операций различных ресурсов Active Directory. 

#### Многоуровневая модель доступа 
Модель многоуровневого доступа Active Directory (TAM) включает в себя множество технических элементов управления, которые снижают риски эскалации привилегий.  Она состоит из логической структуры, которая разделяет активы Active Directory, создавая границы в целях безопасности. Основной целью является защита наиболее ценных идентификаторов Active Directory (уровень 0). В то же время члены домена и другие пользователи могут выполнять рутинные задачи, такие как проверка электронной почты, серфинг в Интернете и использование приложений и других служб (уровень 1, 2).  Она включает в себя три уровня, уровень 0, 1 и 2, которые являются следующими: 
- Уровень 0 : верхний уровень, включает все учетные записи администраторов, контроллер домена и группы.
- Уровень 1 : Приложения и серверы, входящие в домен. 
- Уровень 2 : Устройства для конечных пользователей, например, сотрудники отделов кадров и продаж (не ИТ-персонал).
Что такое распределение многоуровневой модели доступа?

Реализация модели многоуровневого доступа 
Критическая реализация этой модели основана на принципе «Предотвращение пересечения границ привилегированными учетными данными, как случайного, так и преднамеренного» . Реализация технического контроля с помощью объектов групповой политики имеет решающее значение для предотвращения таких сценариев. Эти объекты групповой политики объединяют права безопасности, которые могут запрещать доступ или предоставлять разрешение. Подробнее о многоуровневой и корпоративной модели доступа (EAM) можно прочитать  здесь . 

#### Аудит учетных записей 
Аудит учетных записей — это важная задача, которая в основном выполняется путем настройки правильной учетной записи, назначения привилегий и применения ограничений. Периодически необходимо проводить три типа аудита, связанных с учетными записями: аудит использования, аудит привилегий и аудит изменений. 
- Аудит использования позволяет отслеживать конкретные задачи каждой учетной записи и проверять права доступа. 
- Аудит привилегий позволяет проверить, имеет ли каждая учетная запись в системе наименьшие привилегии.
- Аудит изменений позволяет вам искать любые неправомерные изменения в разрешениях учетной записи, паролях или 
  настройках. Любое неприемлемое изменение этих данных может привести к утечке данных.
### Ответьте на вопросы ниже
Компьютеры и принтеры необходимо добавить к уровню 0 — да/нет?
```commandline
nay
```
Предположим, что поставщик приезжает к вам на объект для выполнения задания продолжительностью в 2 недели. Будучи системным администратором, вы должны создать для него учетную запись с высокими привилегиями — да/нет?
```commandline
nay
```

## Задание 5
Microsoft Security Compliance Toolkit (MSCT) — официальный набор инструментов, предоставляемый корпорацией Microsoft 
для внедрения и управления локальными и доменными политиками. Вам не нужно беспокоиться о сложных синтаксисах и 
сценариях политик, поскольку Microsoft предоставит предварительно разработанные базовые линии безопасности для среды 
конечного пользователя.  Вы можете загрузить MSCT по ссылке на официальном сайте Microsoft .  Вы можете найти все 
базовые линии и программное обеспечение анализатора политик на  Desktop > Scripts подключенной виртуальной машине.

Установка базовых показателей безопасности 
Microsoft предлагает своим клиентам базовые линии безопасности, которые легко доступны в потребляемых форматах, например, резервные копии объектов групповой политики. Вы можете легко загрузить их в виде zip-файлов и извлечь содержимое.  Вот как можно загрузить и установить базовые линии безопасности для Windows Server простым способом:
Open Microsoft Security Compliance Website > click Download > click Windows Servers Security Baseline.zip > Download
как скачать базовую версию для windows server

Open extracted folder > Scripts > & select desired baseline & execute with PowerShell

как установить базовые линии

#### Анализатор политики 
Одной из функций Security Compliance ToolKit является анализатор политик, который позволяет сравнивать групповые 
политики для быстрой проверки несоответствий, избыточных настроек и изменений, которые необходимо внести между ними. 
Рассмотрим сценарий, в котором множество GPO применяется на разных уровнях. Будут конфликтующие, избыточные 
настройки и множество других путей, которые можно быстро разрешить с помощью анализатора политик.  Как и базовые 
показатели безопасности, он загружается в виде zip-файла по той же ссылке , и можно легко извлечь содержимое, а 
затем выполнить процедуру, как показано в следующих шагах:
как загрузить анализатор политики

После загрузки вы можете запустить его  PolicyAnalyzer.exeдля добавления и управления локальными или доменными политиками.

как добавлять политики в анализатор политик

Будьте осторожны при загрузке базовых показателей безопасности, поскольку их следует загружать только с официального сайта Microsoft. 
### Ответьте на вопросы ниже
Найдите и откройте скрипт BaselineLocalInstall в редакторе PowerShell. Сможете ли вы найти флаг?
```commandline
THM{00001}
```
Найдите и откройте скрипт MergePolicyRule (анализатор политик) в редакторе PowerShell. Сможете ли вы найти флаг?
```commandline
{THM00191}
```
## Задание 6
Если злоумышленник успешно получает доступ к учетной записи администратора домена, вы можете считать, что игра 
окончена. Никто никогда не готов раскрыть конфиденциальные данные компании или понести финансовые потери. Прежде чем 
мы обсудим некоторые известные атаки, важно думать как злоумышленник и выработать образ мышления, надев его обувь. 
Вот несколько уже разработанных интересных комнат на THM, которые помогут вам ознакомиться с возможностями и полосой 
векторов атак для противника.

- Нулевой вход в систему (получение административного доступа к AD без учетных данных).
- Взлом AD  (Получение первого набора учетных данных в среде AD).
- Эксплуатация AD  (изучите распространенные методы эксплуатации AD).
- Основы постэксплуатации (что делает злоумышленник после получения первоначального контроля над AD).
Давайте рассмотрим несколько методов защиты Active Directory от известных атак. 

#### Kerberoasting
Kerberoasting — это распространенная и успешная техника постэксплуатации, используемая злоумышленниками для 
получения привилегированного доступа к AD. Злоумышленник использует Kerberos Ticket Granting Service (TGS) для 
запроса зашифрованного пароля, а затем взламывает его в автономном режиме с помощью различных методов подбора. Эти 
атаки трудно обнаружить, поскольку запрос выполняется через одобренного пользователя, и в ходе этого процесса не 
генерируется необычная схема трафика. Вы можете предотвратить атаку, обеспечив дополнительный уровень аутентификации 
с помощью MFA или часто и периодически сбрасывая пароль учетной записи службы Kerberos Key Distribution Centre (KDC).
Вы можете узнать больше об атаке здесь.

#### Слабые и легко угадываемые пароли 
Самая легкая цель для злоумышленников — это слабые и легко угадываемые старые пароли. Лучшая рекомендация — 
использовать надежные пароли и избегать уже известных. Надежный пароль состоит из комбинации заглавных и строчных 
букв, цифр и специальных символов. Вы можете узнать больше о надежности пароля здесь. Существует множество 
инструментов, которые могут помочь вам выполнить аудит паролей в AD. Вы можете просмотреть отчет, созданный с 
помощью бесплатного инструмента на Desktop > Password-Report.png.

#### Протокол удаленного рабочего стола с подбором паролей 
Злоумышленники используют инструменты сканирования для подбора слабых учетных данных. После 
успешного подбора они быстро получают доступ к скомпрометированным системам и пытаются повысить привилегии, а также 
закрепиться на компьютере цели. Лучшая рекомендация — никогда не выставлять RDP без дополнительных мер безопасности 
в общедоступном Интернете. Постоянные проверки на предмет сканирующих атак или попыток подбора также являются важным 
шагом.

#### Публично доступный 
Во время настройки AD некоторые папки общего доступа общедоступны или остаются неаутентифицированными, предоставляя 
начальную точку опоры для злоумышленников для бокового перемещения . Вы можете использовать  командлет  
Get-SmbOpenFile в PowerShell для поиска любых нежелательных общих ресурсов в сети и настроить доступ соответствующим 
образом.
### Ответьте на вопросы ниже
Использует ли Kerberoasting схему офлайн-атак для взлома зашифрованных паролей — да/нет?
```commandline
yea
```
Согласно сформированному отчету, у скольких пользователей пароль такой же, как у aaron.booth?
```commandline
186
```

## Задание 7
Вы уверены, что ваш AD защищен от всех типов атак?

Укрепление AD — это непрерывный процесс, требующий коллективных усилий системных администраторов и конечных 
пользователей. Существуют различные стандарты укрепления системы, и мы обсудили несколько из них в этой комнате. 
Ниже приведен краткий обзор методов укрепления, которые позволят системным администраторам быстро укрепить AD.

Изображение для шпаргалки

Это просто — не так ли? Эта комната была базовым введением. Мы планируем разработать несколько подробных комнат по 
усилению AD, чтобы подробно обсудить, как защитить AD с помощью групповых политик и реализовать модель наименьших 
привилегий. Оставайтесь с нами!

### Ответьте на вопросы ниже
Я закончил комнату.

```commandline
Ответ не нужен
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)