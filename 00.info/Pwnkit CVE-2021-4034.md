[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Pwnkit: CVE-2021-4034](https://tryhackme.com/r/room/pwnkit) 

Всего 5 заданий:
## Задание 1
CVE-2021-4034 ( в просторечии именуемая «Pwnkit » ) — это ужасающая уязвимость локального повышения привилегий (LPE),
расположенная в пакете «Polkit», установленном по умолчанию почти во всех основных дистрибутивах операционной 
системы Linux (а также во многих других операционных системах *nix). Другими словами, она затрагивает практически 
все основные системы Linux на планете.   

В этой комнате будет представлен обзор уязвимости, а также рекомендации по исправлению затронутых систем. Также была 
прикреплена уязвимая машина, чтобы вы могли самостоятельно опробовать уязвимость!

Без лишних слов, начнем.

#### Ответить на вопросы ниже
Разверните машину, нажав на зеленую кнопку «Развернуть» в верхней части этой задачи!

```commandline
Ответ не нужен
```

## Задание 2
Обзор

CVE-2021-4034 (он же «pwnkit») был обнаружен исследователями Qualys и объявлен в январе 2022 года; техническую рекомендацию по безопасности для этой уязвимости можно найти здесь . Уязвимость существовала в каждой версии пакета «Policy Toolkit» (или Polkit) с момента его первого выпуска в 2009 году и позволяет любому непривилегированному злоумышленнику легко получить полный административный доступ к любой машине Linux с установленным пакетом Polkit. К сожалению, Polkit установлен по умолчанию в большинстве дистрибутивов Linux , что делает эту уязвимость чрезвычайно распространенной.

Легкость эксплуатации и повсеместная распространенность Polkit делают эту уязвимость абсолютно разрушительной; однако, к счастью, ее невозможно эксплуатировать удаленно, что делает Pwnkit исключительно уязвимостью локального повышения привилегий (LPE).

Что такое Полкит?

Прежде чем рассматривать уязвимость напрямую, полезно понять, что на самом деле представляет собой Polkit.

Polkit является частью системы авторизации Linux. По сути, когда вы пытаетесь выполнить действие, требующее более высокого уровня привилегий, Polkit можно использовать для определения наличия у вас необходимых разрешений. Он интегрирован с systemd и гораздо более настраиваем, чем традиционная система sudo. Действительно, его иногда называют «sudo systemd», предоставляя гранулярную систему, с помощью которой можно назначать разрешения пользователям.

При взаимодействии с polkit мы можем использовать pkexecутилиту — именно эта программа содержит уязвимость Pwnkit. В качестве примера использования утилиты, попытка запустить команду useraddв pkexecсеансе GUI приводит к появлению всплывающего окна с запросом учетных данных:
pkexec useradd test1234
Демонстрация диалога аутентификации Polkit GUI

В сеансе CLI вместо этого мы получаем текстовую подсказку:

pkexec при запуске из командной строки
muiri@demo-vm:~$ pkexec useradd test1234
==== AUTHENTICATING FOR org.freedesktop.policykit.exec ===
Authentication is needed to run '/usr/sbin/useradd' as the super user
Authenticating as: muiri,,, (muiri)
Password:
Подводя итог, можно сказать, что набор инструментов политики можно рассматривать как детализированную альтернативу более простой системе sudo, с которой вы, возможно, уже знакомы.

Уязвимость

Как упоминалось ранее, уязвимость Pwnkit существует в pkexecутилите — основном интерфейсе к системе Polkit. Мы не будем вдаваться в подробности в интересах читабельности; однако вам рекомендуется прочитать Qualys Security Advisory для полного технического объяснения уязвимости.

Короткая версия такова: версии pkexec, выпущенные до патча, не обрабатывают аргументы командной строки безопасно, что приводит к уязвимости "запись за пределами границ", позволяя злоумышленнику манипулировать средой, в которой запускается pkexec. Это все, что вам действительно нужно знать, но для более технического объяснения читайте дальше!

Более конкретно, pkexec пытается проанализировать любые аргументы командной строки, которые мы ему передаем, используя цикл for, начиная с индекса 1, чтобы сместить имя программы и получить первый реальный аргумент (например, если мы ввели pkexec bash, то, как и  pkexec имя программы, это будет аргумент 0 — фактические аргументы командной строки начинаются с индекса 1). Имя программы не имеет значения для анализа аргумента, поэтому индексация просто смещается, чтобы игнорировать его.

Что же произойдет, если мы не предоставим никаких аргументов? Индекс будет постоянно установлен на 1!

Следующий псевдокод может помочь вам визуализировать это:

Псевдокод: Индексация списка, начиная с 1
for(n=1; n < number_of_arguments; n++){
  //Do Stuff
}
Если число аргументов равно 0, то никогда неn будет меньше числа аргументов. Таким образом, остается равным единице, и цикл полностью обходит.n

Это становится проблемой позже, когда pkexec пытается записать значение аргумента в index n. Поскольку аргументов командной строки нет, аргумента в index нет —n вместо этого программа перезаписывает следующее в памяти, которое как раз оказывается первым значением в списке переменных среды, когда программа вызывается с помощью функции C под названием execve(). Другими словами, передав pkexec пустой список аргументов, мы можем заставить его перезаписать переменную среды!

Для контекста: некоторые «опасные» переменные среды удаляются операционной системой, когда вы пытаетесь запустить программу с установленным битом SUID (как это делает pkexec по необходимости); это делается для того, чтобы не дать злоумышленникам возможности перехватить программу, когда она работает с административными разрешениями. Используя запись за пределами допустимого диапазона, мы можем повторно ввести наш выбор этих опасных переменных среды, обманом заставив pkexec добавить их для нас. Существует множество различных способов злоупотребления этим, все из которых приводят к выполнению кода от имени пользователя root.

Ответить на вопросы ниже
Можно ли эксплуатировать Pwnkit удаленно (да/нет)?

```commandline
Nay
```
В какой утилите Polkit находится уязвимость Pwnkit?


```commandline
Ответ не нужен
```

## Задание 3
 
```commandline
Ответ не нужен
```

## Задание 4
 
```commandline
Ответ не нужен
```

## Задание 5
```commandline
Ответ не нужен
```

[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)