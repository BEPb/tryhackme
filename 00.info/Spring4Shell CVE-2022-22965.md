[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Spring4Shell: CVE-2022-22965](https://tryhackme.com/r/room/spring4shell) 

Всего 4 задания:
## Задание 1
В конце марта 2022 года были обнародованы две уязвимости удаленного выполнения команд в фреймворке Java Spring . 
Первая из этих уязвимостей затрагивает компонент фреймворка под названием «Spring Cloud Functions». Вторая, возможно,
более серьезная уязвимость, затрагивает компонент в «Spring Core» — сердце фреймворка — тем самым значительно 
увеличивая потенциальное воздействие уязвимости и заслужив название «Spring4Shell» (игра слов от Log4Shell , 
названия жестокой уязвимости, раскрытой в конце 2021 года).

По разным причинам в более широком сообществе специалистов по информационной безопасности возникло много путаницы 
вокруг этих уязвимостей. Таким образом, эта комната может обновляться по мере появления новой информации. Аналогично,
влияние Spring4Shell в настоящее время неизвестно; только время покажет, насколько широко распространена эта 
уязвимость в дикой природе.   

В этой комнате будет представлен обзор уязвимости Spring4Shell RCE в Spring Core, а также предоставлена 
возможность эксплуатировать ее самостоятельно на уязвимой машине, прикрепленной к этой задаче. Мы начнем с 
рассмотрения уязвимости на высоком уровне, прежде чем эксплуатировать целевую машину для себя.

#### Давай начнем!

Ответить на вопросы ниже
Разверните целевую машину, нажав зеленую кнопку в верхней части этой задачи!

Примечание: Для полного запуска машины потребуется 2–3 минуты.
```commandline
Ответ не нужен
```

## Задание 2
#### Обзор

Spring4Shell изначально был выпущен как 0-day в ныне удаленной ветке твитов. Он был быстро идентифицирован как обход 
патча для CVE -2010-1622 — уязвимости в более ранних версиях Spring Framework, которая позволяла злоумышленникам 
получать удаленное выполнение команд, злоупотребляя способом, которым Spring обрабатывает данные, отправленные в 
HTTP-запросах. Короче говоря, уязвимость позволяет злоумышленникам загружать «webshell» (фрагмент кода, который 
принимает команды от злоумышленника, которые затем обманным путем заставляют веб-сервер выполнить) на уязвимый 
сервер, достигая удаленного выполнения команд.

#### Как это работает?

Чтобы понять Spring4Shell, важно понимать CVE -2010-1622. Spring MVC ( Model - View -Controller ) является частью 
Spring Framework, что упрощает разработку веб-приложений в соответствии с шаблоном проектирования MVC. Одной из 
особенностей Spring MVC является то, что он автоматически создает и заполняет объект указанного класса при 
выполнении запроса на основе параметров, отправленных в конечную точку. Проще говоря, это может быть использовано 
для перезаписи важных атрибутов родительского класса, что приведет к удаленному выполнению кода.

Spring4Shell работает по схожим принципам, обходя смягчения, добавленные в патч CVE -2010-1622. Большинство 
эксплойтов для уязвимости Spring4Shell работают, заставляя приложение записывать вредоносный .jsp файл (фактически 
обычный текст Java, который может выполнить Tomcat — так же, как веб-сервер PHP будет выполнять файлы с .
php расширением) на веб-сервер. Затем этот веб-shell может быть запущен для удаленного выполнения команды над целью.


#### Ограничения

К счастью, несмотря на то, насколько широко используется Spring Framework, условия, в которых уязвимость может быть 
использована, на самом деле довольно ограничены. 

Уязвимость Spring4Shell затрагивает Spring Core до версии 5.2, а также в версиях 5.3.0-17 и 5.2.0-19, работающих на 
версии Java Development Kit (JDK) выше или равной 9. Общедоступные эксплойты, доступные в настоящее время, работают 
только с приложениями, развернутыми в Apache Tomcat как WAR; однако специалисты по поддержке Spring Framework 
заявили, что, по их мнению, могут быть и другие способы эксплуатации уязвимости.   

Текущие условия уязвимости (как указано в объявлении Spring об уязвимости ) можно резюмировать следующим образом:

- JDK 9+
- Уязвимая версия Spring Framework (<5.2 | 5.2.0-19 | 5.3.0-17)
- Apache Tomcat как сервер для приложения Spring, упакованного в WAR
- Зависимость от spring-webmvcи/или spring-webfluxкомпонентов Spring Framework
- Однако стоит отметить, что со временем они могут измениться по мере обнаружения других способов эксплуатации 
  уязвимости.



#### Ремедиации

К счастью, были выпущены исправленные версии Spring Framework. Чтобы исправить Spring4Shell, убедитесь, что вы 
используете версию Spring, выпущенную после патча 18 младшего релиза 5.3 (т. е. после 5.3.18) или после патча 20, 
если используете младшего релиза 5.2 (т. е. после 5.2.20). Обновления версии фреймворка достаточно, чтобы устранить 
уязвимость из ваших приложений.

Если обновление невозможно, можно несколько смягчить эту уязвимость, установив список блоков уязвимых шаблонов 
 полей. Дополнительные советы по этому поводу можно найти здесь .

Ответить на вопросы ниже
Прочитайте информацию о задании и поймите, как работает Spring4Shell на высоком уровне.

```commandline
Ответ не нужен
```

## Задание 3
#### Загрузка эксплойта

Мы рассмотрели теорию, теперь пришло время использовать цель!

Поскольку это сетевой эксплойт, для его запуска вам понадобится TryHackMe AttackBox или локальная виртуальная машина.

Копии кода эксплойта можно получить в трех местах:

- Прикреплено к этой задаче, доступно с помощью синей кнопки «Загрузить файлы задачи».
- На порту 8080 целевой машины ( http://MACHINE_IP:8080/exploit.zip).
- Прямо на AttackBox ( /root/Rooms/Spring4Shell/exploit.py). Для вашего удобства он уже будет извлечен из архива.
Используйте любой из методов, который проще всего использовать для получения копии exploit.zipzip-файла. Пароль для 
  этого архива — TryHackMe123!.

Когда вы распакуете архив, вы должны найти один скрипт Python: exploit.py. Это модифицированная версия 
доказательства концепции, которая в настоящее время циркулирует в сети — она немного более удобна для пользователя, 
чем оригинал (полученный здесь ); однако вы можете использовать любую версию, которую пожелаете. Эта задача 
предполагает, что вы используете предоставленный код.

#### Эксплойт

Прочитайте код эксплойта и убедитесь, что вы довольны тем, что он делает то, что он заявляет. Вам всегда следует 
просматривать неизвестные эксплойты перед их запуском. 

Успешно завершив обзор кода, давайте начнем с обзора меню справки по эксплойту:

Меню справки по эксплойтам
```commandline
user@attacker:~$ ./exploit.py --help
usage: exploit.py [-h] [-f FILENAME] [-p PASSWORD] [-d DIRECTORY] url

Spring4Shell RCE Proof of Concept

positional arguments:
  url                   Target URL

optional arguments:
  -h, --help            show this help message and exit
  -f FILENAME, --filename FILENAME
                        Name of the file to upload (Default tomcatwar.jsp)
  -p PASSWORD, --password PASSWORD
                        Password to protect the shell with (Default: thm)
  -d DIRECTORY, --directory DIRECTORY
                        The upload path for the file (Default: ROOT)
```

Скрипт требует один аргумент: url— это указывает цель для запроса POST. Остальные три необязательных аргумента можно 
игнорировать в текущем контексте. 

Давайте начнем с просмотра веб-сайта в браузере ( http://MACHINE_IP/)

Мы можем легко найти целевой URL, проверив исходный код домашней страницы веб-сайта ( view-source:http://MACHINE_IP/).
В частности, мы ищем «действие» контактной формы (единственный доступный нам запрос POST). Оно находится в строке 20:

<form id="contactForm" action="/" method="post">

Действие — « /», то есть наш целевой URL будет просто: http://MACHINE_IP/.

Примечание: завершающий слеш здесь очень важен!



#### Атака

Пришло время использовать эксплойт!

Выполните скрипт (если вы используете AttackBox, перейдите в папку /root/Rooms/spring4shell). Вы должны получить вывод, аналогичный следующему:

Запуск эксплойта

```commandline
user@attacker:~$ ./exploit.py http://MACHINE_IP/
Shell Uploaded Successfully!
Your shell can be found at: http://MACHINE_IP/tomcatwar.jsp?pwd=thm&cmd=whoami
```

Теперь веб-оболочка должна быть загружена!

Перейдите по ссылке, предоставленной эксплойтом, чтобы увидеть это в действии. Вы можете изменить, какая команда 
будет запущена, изменив cmdпараметр. По умолчанию команда — whoami. 

Примечание: После успешного использования эксплойта его нельзя будет использовать снова, пока приложение не будет 
перезапущено. Если вы загрузите веб-оболочку с неправильным именем или путем к каталогу, вам придется завершить и 
повторно развернуть целевую машину.  

Ответить на вопросы ниже
Следуйте инструкциям в задаче, чтобы использовать Spring4Shell и получить веб-оболочку.
```commandline
Ответ не нужен
```

Правильный ответ
[Бонусный вопрос: необязательно] Используйте свой веб-шелл, чтобы получить обратный/привязанный шелл на цели.

```commandline
Ответ не нужен
```

Правильный ответ
Какой флаг в/root/flag.txt?

```commandline
THM{NjAyNzkyMjU0MzA1ZWMwZDdiM2E5YzFm}
```

## Задание 4
Поздравляем, вы достигли конца комнаты Spring4Shell!

Завершив эту комнату, вы, как мы надеемся, получите высокий уровень понимания уязвимости и будете чувствовать себя 
комфортно. атакующие ‌приложения, уязвимые к CVE -2022-22965.  

Как упоминалось ранее, эта уязвимость может быть очень распространена, но только время покажет, насколько она 
серьезна на самом деле. Будьте начеку и убедитесь, что вы исправили все системы, за которые вы отвечаете! 

Если вы хотите узнать больше о Spring4Shell, вы можете найти следующие информативные ресурсы:

- Весеннее объявление RCE
- Запись в блоге LunaSec
- Запись в блоге преторианца
- o0o Описание CVE -2010-1622

Ответить на вопросы ниже
Я понимаю и могу злоупотреблять Spring4Shell!

```commandline
Ответ не нужен
```



[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)