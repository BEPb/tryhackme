[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Confluence CVE-2023-22515](https://tryhackme.com/r/room/confluence202322515) 

Всего 5 заданий:
## Задание 1
4 октября 2023 года компания Atlassian выпустила рекомендацию по безопасности относительно CVE -2023-22515 , уязвимости взлома контроля доступа, с присвоенным рейтингом CVSS 10,0 . Уязвимость была введена в версии 8.0.0 изданий Confluence Server и Data Center и присутствует в версиях <8.3.3, <8.4.3, <8.5.2. По данным Atlassian, уязвимость  уже  эксплуатировалась в реальных условиях.

Атакующий может использовать уязвимость для создания дополнительной учетной записи в Confluence с полными административными привилегиями. Атакующему не нужна предварительная информация для эксплуатации уязвимости. Считается, что уязвимость делает возможными другие неизвестные векторы атак и должна быть исправлена ​​как можно скорее.

Запуск виртуальной машины

Чтобы развернуть подключенную виртуальную машину , нажмите зеленую кнопку «Запустить машину» в верхней части задачи.

На вашей виртуальной машине установлена ​​чистая пробная версия Atlassian Confluence Data Center edition http://MACHINE_IP:8090, которая будет работать на , что и будет нашей целью. Загрузка машины может занять около 5 минут.

### Ответьте на вопросы ниже
Нажмите и продолжайте обучение!
```commandline
Ответ не нужен
```

## Задание 2
Первоначальная настройка Confluence

При первом запуске Confluence вы пройдете начальную настройку, которая позволит вам настроить некоторые основные параметры и создать учетную запись администратора. Начальную настройку можно выполнить, перейдя по адресу http://MACHINE_IP:8090/setup/.

Если вы попытаетесь получить доступ к первоначальной настройке после ее завершения, вы не сможете пройти ее снова, но увидите сообщение о том, что процесс настройки уже завершен:

Сообщение о завершении установки

Это нормальное ожидаемое поведение, которое, как правило, не представляет никакой пользы для злоумышленника.

Введите  CVE -2023-22515

Эта уязвимость позволяет злоумышленнику повторно включить начальный процесс настройки. При этом злоумышленник может пройти этап создания нового администратора заново.

Все это возможно, поскольку Confluence создан с использованием фреймворка Apache Struts, который зависит от пакета XWork. XWork позволяет вам определять действия в форме класса Java. Каждое действие может быть вызвано через URL, а соответствующий класс Java обработает запрос, выполнит все, что требует действие, и выдаст ответ. 

Чтобы прояснить, как работают Действия, перейдите на http://MACHINE_IP:8090/. Вы должны быть немедленно перенаправлены на http://MACHINE_IP:8090/login.action. Этот URL вызывает Действие, связанное с классом Java для обработки попыток входа. Когда Действие вызывается через его URL, execute()метод класса будет вызван по умолчанию.

Вызов геттеров/сеттеров через XWorks 

Мы также можем вызывать геттеры и сеттеры в классах Action, используя URL, указывающий параметр HTTP с цепочкой атрибутов, которые мы хотим получить/установить. Например, если бы класс Action входа имел метод setId(), мы могли бы вызвать его через следующий URL:

http://MACHINE_IP:8090/login.action?Id=123
Это будет выполнено setId('123')так, как определено в соответствующем классе Action.

Цепочка геттеров/сеттеров для повторного включения начальной настройки

Сообщенный эксплойт использует ServerInfoActionAction. Причина выбора этого конкретного Action заключается в том, что мы можем построить из него цепочку геттеров/сеттеров, чтобы задать параметр конфигурации, который включает или выключает начальную настройку.

Если вы проанализируете код класса ServerInfoAction, вы увидите, что он расширяет ConfluenceActionSupportкласс. Сделав это, он также унаследует все его методы. Одним из таких методов является геттер, который возвращает объект BootstrapStatusProvider:

public class ConfluenceActionSupport extends ActionSupport implements LocaleProvider, WebInterface, MessageHolderAware {
  public BootstrapStatusProvider getBootstrapStatusProvider() {
    if (this.bootstrapStatusProvider == null)
      this.bootstrapStatusProvider = BootstrapStatusProviderImpl.getInstance(); 
    return this.bootstrapStatusProvider;
  }
}
Нас интересует этот BootstrapStatusProviderкласс, поскольку у него есть еще один метод получения, который мы можем использовать для получения ApplicationConfigurationобъекта:

public class BootstrapStatusProviderImpl implements BootstrapStatusProvider, BootstrapManagerInternal {
  public ApplicationConfiguration getApplicationConfig() {
    return this.delegate.getApplicationConfig();
  }
}
Как вы, вероятно, уже догадались, этот объект содержит конфигурацию приложения, включая атрибут, который сообщает Confluence, была ли завершена начальная настройка. Такой атрибут можно изменить, используя сеттер в классе ApplicationConfig:

public class ApplicationConfig implements ApplicationConfiguration {
  public synchronized void setSetupComplete(boolean setupComplete) {
    this.setupComplete = setupComplete;
  }  
}
Если мы вызовем setSetupComplete(false), мы фактически восстановим начальную настройку. Собрав все вместе, мы можем вызвать эту цепочку геттеров/сеттеров, перейдя по следующему URL:

http://MACHINE_IP:8090/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false
XWork фактически преобразует это в вызов:

getBootstrapStatusProvider().getApplicationConfig().setSetupComplete(false)
Теперь зайдите в браузер и перейдите по созданному URL-адресу, чтобы активировать уязвимость. Вы должны получить следующий ответ от сервера:

Успешный ответ на эксплойт

Создание учетной записи администратора

Теперь, когда мы снова можем получить доступ к начальной настройке, давайте перейдем к: 

http://MACHINE_IP:8090/setup/setupadministrator-start.action
Заполните данные вашего нового пользователя-администратора и нажмите «Далее»:

Создание нового администратора

Если все пройдет хорошо, вы получите доступ к Confluence с правами администратора!

Проверка учетной записи администратора

В этой задаче мы провели краткое объяснение уязвимости. Если вы хотите более подробно рассмотреть технические детали, проверьте анализ Rapid7 в attackerKB .

### Ответьте на вопросы ниже
Войдите в Confluence с вашими новыми учетными данными. Каково значение флага, опубликованного администратором?
```commandline
THM{who_needs_keys_anyway}
```

## Задание 3
Как мы увидели, эксплуатация уязвимости относительно проста и может быть выполнена вручную с помощью одного запроса и обычного браузера. Тем не менее, автоматизированные эксплойты легко доступны. 

Chocapikk разработал один такой эксплойт, который можно скачать здесь . Не стесняйтесь скачивать и использовать эксплойт против целевой машины!

С другой стороны, если вам нужно протестировать много серверов, чтобы увидеть, уязвимы ли они, простой сканер уязвимостей был разработан ErikWynter. Его можно получить на его странице GitHub . В отличие от скрипта Chocapikk, этот не будет эксплуатировать уязвимость, а только проверит ее.

### Ответьте на вопросы ниже
Прочитайте сценарий Chocapikk. Каково имя пользователя Confluence, которого он создает?
```commandline
pleasepatch
```

## Задание 4
Обнаружение

Если у вас есть экземпляр уязвимой версии Confluence, обязательно проверьте следующее:

Журналы сетевого доступа указывают на /setup/*.action. Нет причин для обычного пользователя запрашивать такие URL-адреса после установки.
Журналы сетевого доступа к /server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false.
Просмотрите пользователей Confluence и найдите подозрительные учетные записи и участников группы confluence-administrators.
Исправление

Все уязвимые экземпляры следует как можно скорее обновить как минимум до одной из следующих версий:

8.3.3
8.4.3
8.5.2
Если обновление невозможно немедленно, доступ к /setup/*конечным точкам может быть заблокирован в качестве временной меры. Для этого добавьте следующее ограничение безопасности внутри <web-app>тега в /<confluence-install-dir>/confluence/WEB-INF/web.xml:
```commandline
<security-constraint>
  <web-resource-collection>
    <url-pattern>/setup/*</url-pattern>
    <http-method-omission>*</http-method-omission>
  </web-resource-collection>
  <auth-constraint />
</security-constraint>

```
Это фактически ограничит доступ к /setup/*.

Помните, что инструкции по смягчению не следует считать окончательным исправлением, а лишь временной мерой. Серверы все равно следует обновлять как можно скорее.

### Ответьте на вопросы ниже
Уязвим ли Confluence Server версии 8.2.0 к CVE-2023-22515? (да/нет)
```commandline
yea
```
Заменяет ли применение мер по смягчению необходимость обновления Confluence? (да/нет)
```commandline
nay
```

## Задание 5
В этой комнате мы проанализировали уязвимость управления доступом в Atlassian Confluence Server и Data Center, которая позволяет злоумышленникам создавать нового администратора в уязвимом приложении. Как мы увидели, эксплуатация уязвимости тривиальна, поэтому крайне важно как можно скорее установить исправления на серверы Confluence. Уязвимость была исправлена ​​в версиях 8.3.3, 8.4.3 и  8.5.2. Все более новые ветви версий также должны быть безопасными.

Поскольку было обнаружено, что уязвимость эксплуатируется в дикой природе, проверка наших серверов на наличие признаков компрометации также важна. Помните, что уязвимость, вероятно, использовалась субъектом национального государства, как подтвердила Atlassian в оригинальном бюллетене по безопасности .

### Ответьте на вопросы ниже
Нажмите и продолжайте обучение!
```commandline
Ответ не нужен
```

[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)