[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Pyramid Of Pain](https://tryhackme.com/r/room/pyramidofpainax) 

Всего 10 заданий:
## Задание 1
Эта известная концепция применяется в таких решениях по кибербезопасности, как Cisco Security, SentinelOne и 
SOCRadar, для повышения эффективности CTI (разведки киберугроз), поиска угроз и реагирования на инциденты. 

Понимание концепции «пирамиды боли» важно для охотника за угрозами, специалиста по реагированию на инциденты или 
аналитика SOC. 

Готовы ли вы исследовать то, что скрывается внутри Пирамиды Боли? 

### Ответить на вопросы ниже
Прочитайте вышеизложенное.

```commandline
Ответ не нужен
```

## Задание 2
Согласно Microsoft, хэш-значение — это числовое значение фиксированной длины, которое однозначно идентифицирует 
данные. Хэш-значение — это результат алгоритма хэширования. Ниже приведены некоторые из наиболее распространенных 
алгоритмов хэширования:   
- MD5 (Message Digest, определено  RFC 1321 ) — была разработана Роном Ривестом в 1992 году и  является широко 
  используемой криптографической хэш-функцией со 128-битным хэш-значением. ХэшиMD5НЕ считаютсякриптографически 
  безопасными. В 2011 годуIETFопубликовалаRFC6151 «Обновленные соображения безопасности для MD5 Message-Digest и 
  алгоритмовHMAC- MD5 », в котором упоминалось несколько атак наMD5, включая коллизию хэшей.
- SHA-1 (Secure Hash Algorithm 1, определенный в  RFC 3174 ) —  был изобретен Агентством национальной безопасности 
  США в 1995 году.  Когда данные подаются на алгоритм хеширования SHA-1, SHA-1 принимает входные данные и создает 
  160-битную строку хеш-значения в виде 40-значного шестнадцатеричного числа.  NIST прекратил использование SHA-1 в 
  2011 году и запретил его использование для цифровых подписей в конце 2013 года на основании его подверженности 
  атакам методом подбора. Вместо этого NIST рекомендует перейти от SHA-1 к более сильным алгоритмам хеширования в 
  семействах SHA-2 и SHA-3.    
- SHA-2 (Secure Hash Algorithm 2) - алгоритм хеширования SHA-2 был разработан Национальным институтом стандартов и 
  технологий ( NIST ) и Агентством национальной безопасности (NSA) в 2001 году для замены SHA-1. SHA-2 имеет много 
  вариантов, и, возможно, наиболее распространенным является SHA-256 . Алгоритм SHA-256 возвращает хеш-значение 
  размером 256 бит в виде 64-значного шестнадцатеричного числа.   
- Хэш не считается криптографически безопасным, если два файла имеют одинаковое значение хэша или дайджест.

Специалисты по безопасности обычно используют хеш-значения для получения информации о конкретном образце 
вредоносного ПО, вредоносном или подозрительном файле, а также в качестве способа уникальной идентификации и ссылки 
на вредоносный артефакт.  

Вы, вероятно, читали отчеты о программах-вымогателях в прошлом, где исследователи безопасности предоставляли хэши, 
связанные с вредоносными или подозрительными файлами, используемыми в конце отчета.  Вы можете ознакомиться с  The 
DFIR Report  и  FireEye Threat Research Blogs,  если вам интересно увидеть пример.  

Для поиска хэшей можно использовать различные онлайн-инструменты, такие как VirusTotal и Metadefender Cloud - OPSWAT .

Всего вирусов:
Под хешем на скриншоте выше вы можете увидеть имя файла. В данном случае это "m_croetian.wnry"

MetaDefender Cloud — OPSWAT:
 
Как вы могли заметить, обнаружить вредоносный файл очень просто, если в нашем арсенале есть хэш. Однако для 
злоумышленника изменение файла даже на один бит является тривиальной задачей, что приведет к другому значению хэша. 
При таком количестве вариаций и экземпляров известных вредоносных программ или программ-вымогателей поиск угроз с 
использованием хэшей файлов в качестве IOC (индикаторов компрометации) может стать затруднительным.   

Давайте рассмотрим пример того, как можно изменить хеш-значение файла, просто добавив строку в конец файла с помощью 
echo :Хэш файла (до изменения) 
```commandline
PS C:\Users\THM\Downloads> Get-FileHash .\OpenVPN_2.5.1_I601_amd64.msi -Algorithm MD5
Algorithm Hash                             Path                                                 
_________ ____                             ____                                                 
MD5       D1A008E3A606F24590A02B853E955CF7 C:\Users\THM\Downloads\OpenVPN_2.5.1_I601_amd64.msi
```

Хэш файла (после модификации)
```commandline
PS C:\Users\THM\Downloads> echo "AppendTheHash" >> .\OpenVPN_2.5.1_I601_amd64.msi
PS C:\Users\THM\Downloads> Get-FileHash .\OpenVPN_2.5.1_I601_amd64.msi -Algorithm MD5
Algorithm Hash                             Path                                                 
_________ ____                             ____                                                 
MD5       9D52B46F5DE41B73418F8E0DACEC5E9F C:\Users\THM\Downloads\OpenVPN_2.5.1_I601_amd64.msi
```

### Ответить на вопросы ниже
Проанализируйте отчет, связанный с хешем "b8ef959a9176aef07fdca8705254a163b50b49a17217a4ff0107487f59d4a35d" здесь. 
Каково имя файла образца? 

```commandline
Sales_Receipt 5606.xls
```

## Задание 3
Вы, возможно, узнали о важности IP-адреса из комнаты «Что такое сетевое взаимодействие?» .  IP-адрес используется 
для идентификации любого устройства, подключенного к сети. Эти устройства варьируются от настольных компьютеров до 
серверов и даже камер видеонаблюдения!  Мы используем IP-адреса для отправки и получения информации по сети. Но мы 
не собираемся вдаваться в структуру и функциональность IP-адреса.  В рамках Пирамиды боли мы оценим, как IP-адреса 
используются в качестве индикатора.    

В Пирамиде боли IP-адреса обозначены зеленым цветом. Вы можете спросить, почему и с чем можно связать зеленый цвет?

С точки зрения защиты, знание IP-адресов, используемых противником, может быть ценным. Распространенная тактика 
защиты — блокировать, сбрасывать или отклонять входящие запросы с IP-адресов на вашем параметрическом или внешнем 
брандмауэре. Эта тактика часто не является пуленепробиваемой, поскольку опытному противнику легко восстановиться, 
просто используя новый публичный IP-адрес.   

Вредоносные IP-подключения ( app.any.run ):



ПРИМЕЧАНИЕ! Не пытайтесь взаимодействовать с IP-адресами, указанными выше.

Одним из способов, с помощью которых злоумышленник может затруднить успешную блокировку IP-адресов, является 
использование  Fast Flux. 

По словам Akamai , Fast Flux — это метод DNS, используемый ботнетами для сокрытия фишинга, веб-проксирования, 
доставки вредоносного ПО и вредоносной коммуникационной активности за скомпрометированными хостами, действующими как 
прокси. Цель использования сети Fast Flux — сделать коммуникацию между вредоносным ПО и его командно-контрольным 
сервером (C&C) сложной для обнаружения специалистами по безопасности.    

Итак, основная концепция сети Fast Flux заключается в наличии нескольких IP-адресов, связанных с доменным именем, 
которое постоянно меняется.  Palo Alto создала отличный вымышленный сценарий для объяснения Fast Flux:  " Fast Flux 
101: Как киберпреступники повышают устойчивость своей инфраструктуры, чтобы избежать обнаружения и арестов 
правоохранительными органами"   

Прочитайте следующий отчет (сгенерированный с помощью any.run ) для этого примера здесь, чтобы ответить на 
приведенные ниже вопросы: 

### Ответить на вопросы ниже
Прочитайте следующий отчет, чтобы ответить на этот вопрос. Какой первый IP-адрес вредоносный процесс (PID 1632) 
пытается установить связь?

```commandline
50.87.136.52
```
Прочитайте следующий отчет, чтобы ответить на этот вопрос. Какое первое доменное имя пытается установить связь с 
вредоносным процессом (PID 1632)?

```commandline
craftingalegacy.com
```

## Задание 4
Давайте поднимемся по Пирамиде Боли и перейдем к Доменным Именам. Вы можете увидеть переход цветов - от зеленого к 
бирюзовому. 

Доменные имена можно рассматривать как простое сопоставление IP-адреса со строкой текста. Доменное имя может 
содержать домен и домен верхнего уровня ( evilcorp.com ) или поддомен, за которым следуют домен и домен верхнего 
уровня ( tryhackme.evilcorp.com ). Но мы не будем вдаваться в подробности того, как работает система доменных имен 
(DNS). Вы можете узнать больше о DNS в этой комнате «DNS in Detail» .    

Доменные имена могут быть немного более болезненными для злоумышленника, поскольку им, скорее всего, придется купить 
домен, зарегистрировать его и изменить записи DNS . К сожалению для защитников, многие поставщики DNS имеют 
свободные стандарты и предоставляют API, чтобы злоумышленнику было еще проще изменить домен.  

Вредоносные  домены Sodinokibi C2 ( Command and Control Infrastructure)  : 

Вы можете заметить что-нибудь вредоносное на скриншоте выше?  Теперь сравните его с видом легитимного веб-сайта ниже:


Это один из примеров атаки Punycode, которую злоумышленники используют для перенаправления пользователей на 
вредоносный домен, который на первый взгляд кажется легитимным. 

Что такое Punycode? Согласно Wandera , «Punycode — это способ преобразования слов, которые не могут быть записаны в 
ASCII, в кодировку Unicode ASCII». 

То, что вы видели в URL выше,  adıdas.de имеет Punycode http://xn--addas-o4a.de/

Internet Explorer, Google Chrome, Microsoft Edge и Apple Safari теперь довольно хорошо преобразуют зашифрованные 
символы в полное доменное имя Punycode. 

Для обнаружения вредоносных доменов можно использовать журналы прокси-сервера или веб-сервера.

Злоумышленники обычно скрывают вредоносные домены под URL Shorteners. AU RL Shortener  — это инструмент, который 
создает короткий и уникальный URL, который будет перенаправлять на определенный веб-сайт, указанный на начальном 
этапе настройки ссылки URL Shortener. По данным Cofense , злоумышленники используют следующие сервисы URL Shortener 
для создания вредоносных ссылок:    

бит.ly
goo.gl
вл.ли
с.идентификатор
smarturl.it
крошечный.pl
tinyurl.com
x.co
Вы можете увидеть фактический веб-сайт, на который вас перенаправляет сокращенная ссылка, добавив к нему "+" (см. 
примеры ниже). Введите сокращенный URL в адресную строку веб-браузера и добавьте указанные выше символы, чтобы 
увидеть URL перенаправления.   

ПРИМЕЧАНИЕ: Приведенные ниже примеры сокращенных ссылок не существуют.



Просмотр подключений в Any.run:

Поскольку Any.run — это сервис песочницы, который выполняет образец, мы можем просматривать любые соединения, такие 
как HTTP-запросы, DNS-запросы или процессы, взаимодействующие с IP-адресом. Для этого мы можем посмотреть на вкладку 
«сеть», расположенную прямо под снимком машины.  

Обратите внимание: вам следует быть крайне осторожными, посещая любые IP-адреса или HTTP-запросы, указанные в 
отчете. В конце концов, это поведение образца вредоносного ПО — так что они, вероятно, делают что-то опасное! 

HTTP- запросы:
- Эта вкладка показывает записанные HTTP- запросы с момента детонации образца. Это может быть полезно для просмотра 
того, какие ресурсы извлекаются с веб-сервера, например, дроппер или обратный вызов.
- иллюстрирование HTTP-запросов в представлении anyrun

Соединения:
- На этой вкладке отображаются все коммуникации, выполненные с момента детонации образца. Это может быть полезно, 
чтобы увидеть, взаимодействует ли процесс с другим хостом. Например, это может быть трафик C2, загрузка/выгрузка файлов по FTP и т. д.
- иллюстрирование соединений в представлении anyrun

DNS- запросы:
- На этой вкладке показаны DNS-запросы, сделанные с момента детонации образца. Вредоносное ПО часто делает 
  DNS-запросы для проверки интернет-подключения (т.е. если оно не может подключиться к интернету/позвонить домой, то 
  оно, вероятно, находится в песочнице или бесполезно).   
- иллюстрирование DNS-запросов в представлении anyrun

### Ответить на вопросы ниже
Перейдите к этому отчету на app.any.run  и укажите первый подозрительный URL-запрос, который вы видите. Этот отчет 
вам понадобится для ответа на оставшиеся вопросы этой задачи. 

```commandline
craftingalegacy.com
```
Какой термин обозначает адрес, используемый для доступа к веб-сайтам?


```commandline
Domain Name
```
Какой тип атаки использует символы Unicode в доменном имени для имитации известного домена?


```commandline
Punycode attack
```
Укажите перенаправленный веб-сайт для сокращенного URL-адреса с помощью предварительного просмотра: https://tinyurl.com/bw7t8p4u
```commandline
https://tryhackme.com/
```

## Задание 5
Давайте сделаем еще один шаг к желтой зоне.

На этом уровне атакующий будет чувствовать себя немного более раздраженным и разочарованным, если вы сможете 
обнаружить атаку.  Нападающему придется вернуться на этот уровень обнаружения и изменить свои инструменты и 
методологии атаки.  Это отнимает очень много времени у атакующего, и, вероятно, ему придется потратить больше 
ресурсов на свои инструменты противника.   

Артефакты хоста — это следы или наблюдаемые данные, которые злоумышленники оставляют в системе, например, значения 
реестра, подозрительное выполнение процессов, шаблоны атак или индикаторы компрометации (IOC), файлы, сброшенные 
вредоносными приложениями, или что-либо, относящееся исключительно к текущей угрозе.  

Подозрительное выполнение процесса из Word: 

Подозрительные события, сопровождающиеся открытием вредоносного приложения: 

Файлы, измененные/удаленные злоумышленником:

### Ответить на вопросы ниже
Поставщик безопасности проанализировал вредоносный образец для нас. Ознакомьтесь с отчетом здесь, чтобы ответить на 
следующие вопросы. 
```commandline
Ответ не нужен
```
Процесс с именем regidle.exe отправляет запрос POST на IP-адрес, расположенный в Соединенных Штатах (США), на порт 
8080. Что такое IP-адрес? 

```commandline
96.126.101.6
```
Актер сбрасывает вредоносный исполняемый файл (EXE). Как называется этот исполняемый файл?
```commandline
G_jugk.exe
```
Посмотрите на этот отчет Virustotal. Сколько поставщиков определяют этот хост как вредоносный?
```commandline
9
```
## Задание 6
Артефакты сети также относятся к желтой зоне в Пирамиде боли. Это означает, что если вы можете обнаружить и 
отреагировать на угрозу, злоумышленнику понадобится больше времени, чтобы вернуться и изменить свою тактику или 
модифицировать инструменты, что дает вам больше времени для реагирования и обнаружения будущих угроз или устранения 
существующих.

Сетевой артефакт может быть строкой user-agent, информацией C2 или шаблонами URI, за которыми следуют запросы HTTP 
POST. Злоумышленник может использовать строку User-Agent, которая ранее не наблюдалась в вашей среде или кажется 
необычной. User-Agent определяется RFC2616 как поле заголовка запроса, которое содержит информацию о user-agent, 
инициировавшем запрос.   

Сетевые артефакты можно обнаружить в файлах Wireshark PCAP (файл, содержащий пакетные данные сети) с помощью 
анализатора сетевых протоколов, например TShark , или изучив журналы IDS (системы обнаружения вторжений) из такого 
источника, как Snort.  

HTTP- запросы POST, содержащие подозрительные строки:

Давайте используем TShark для фильтрации строк User-Agent с помощью следующей команды:tshark --Y http.request -T 
fields -e http.host -e http.user_agent -r analysis_file.pcap  

Это наиболее распространенные строки User-Agent, обнаруженные для трояна Emotet Downloader.

Если вам удастся обнаружить пользовательские строки User-Agent, используемые злоумышленником, вы сможете 
заблокировать их, создав дополнительные препятствия и сделав его попытки взломать сеть более раздражающими. 

### Ответить на вопросы ниже
Какой браузер использует строку User-Agent, показанную на снимке экрана выше?
```commandline
Internet Explorer
```
Сколько запросов POST на снимке экрана из файла pcap?
```commandline
6
```

## Задание 7
Поздравляем! Мы добрались до самого сложного для противников участка!

На этом этапе мы выровняли наши возможности обнаружения артефактов. Злоумышленник, скорее всего, откажется от 
попыток взлома вашей сети или вернется и попытается создать новый инструмент, который служит той же цели. Для 
злоумышленников это будет игра окончена, поскольку им нужно будет вложить немного денег в создание нового 
инструмента (если они способны это сделать), найти инструмент с таким же потенциалом или даже пройти обучение, чтобы 
научиться владеть определенным инструментом.     

Злоумышленники будут использовать эти утилиты для создания вредоносных макродокументов (maldocs) для попыток 
целевого фишинга, бэкдора, который может быть использован для установки C2 (Command and Control Infrastructure) , 
любых пользовательских файлов .EXE и .DLL , полезных нагрузок или взломщиков паролей.  

Троян поместил подозрительный «Stealer.exe» в папку Temp:


Выполнение подозрительного двоичного файла:


На этом этапе антивирусные сигнатуры, правила обнаружения и правила YARA могут стать для вас эффективным оружием 
против злоумышленников. 

MalwareBazaar  и  Malshare  — хорошие ресурсы, которые предоставят вам доступ к образцам, вредоносным каналам и 
результатам YARA. Все это может оказаться очень полезным при поиске угроз и реагировании на инциденты.  

Что касается правил обнаружения, SOC Prime Threat Detection Marketplace — это отличная платформа, на которой 
специалисты по безопасности делятся своими правилами обнаружения различных видов угроз, включая новейшие CVE, 
которые активно эксплуатируются злоумышленниками.   

Нечеткое хеширование также является сильным оружием против инструментов злоумышленника. Нечеткое хеширование 
помогает вам выполнять  анализ схожести — сопоставлять два файла с небольшими различиями на основе нечетких значений 
хеширования. Одним из примеров нечеткого хеширования является использование SSDeep ; на  официальном сайте SSDeep вы 
также можете найти полное объяснение нечеткого хеширования.     

Пример SSDeep от VirusTotal:


### Ответить на вопросы ниже
Укажите метод, используемый для определения сходства между файлами. 
```commandline
Fuzzy Hashing
```
Укажите альтернативное название для нечетких хэшей без аббревиатуры 
```commandline
context triggered piecewise hashes
```

## Задание 8
Это еще не конец. Но хорошие новости: мы добрались до финальной стадии или вершины Пирамиды Боли! 

TTPs означает Tactics, Techniques & Procedures. Сюда входит вся матрица MITRE  ATT&CK , то есть все шаги, 
предпринимаемые противником для достижения своей цели, начиная от попыток фишинга и заканчивая настойчивостью и 
эксфильтрацией данных.   

Если вы можете быстро обнаружить и отреагировать на TTP, вы почти не оставляете противникам шансов на отпор.  
Например, если вы можете обнаружить атаку Pass-the-Hash с помощью Windows Event Log Monitoring и устранить ее, вы 
сможете очень быстро найти скомпрометированный хост и остановить горизонтальное движение внутри вашей сети . На этом 
этапе у злоумышленника будет два варианта:   

Вернитесь назад, проведите дополнительные исследования и обучение, перенастройте свои пользовательские инструменты.
Сдавайся и найди другую цель.
Вариант 2 определенно кажется менее затратным по времени и ресурсам.

### Ответить на вопросы ниже
Перейдите на веб-страницу ATT&CK Matrix. Сколько методов попадают в категорию Эксфильтрация?

```commandline
9
```
Chimera — это китайская хакерская группа, действующая с 2018 года. Как называется коммерческий инструмент удаленного 
доступа, который они используют для C2-маяков и кражи данных? 
```commandline
Cobalt Strike
```

## Задание 9
Разверните статический сайт, прикрепленный к этой задаче, и разместите подсказки на правильных уровнях в пирамиде боли!

Как только вы убедитесь, отправьте свой ответ на статическом сайте, чтобы получить флаг!

Ответить на вопросы ниже
Заполните статический сайт. Что такое флаг?
```commandline
THM{PYRAMIDS_COMPLETE}
```

## Задание 10
Теперь вы изучили концепцию Пирамиды боли. Возможно, пришло время применить это на практике. Пожалуйста, перейдите 
на Статический сайт, чтобы выполнить упражнение.  

Вы можете выбрать любую APT (Advanced Persistent Threat Groups) в качестве другого упражнения. Хорошим местом для 
изучения будет  FireEye Advanced Persistent Threat Groups . Когда вы определили APT-группу, которую хотите 
исследовать, найдите ее индикаторы и спросите себя: «Что я могу сделать или какие правила обнаружения и подходы я 
могу создать для обнаружения активности противника?» и «Где эта активность или обнаружение находятся на Пирамиде 
боли?»    


Как утверждает Дэвид Бланко, « количество боли, которую вы причиняете противнику, зависит от типов индикаторов, 
которые вы можете использовать».".  
### Ответить на вопросы ниже
Прочитайте вышеизложенное.
```commandline
Ответ не нужен
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)