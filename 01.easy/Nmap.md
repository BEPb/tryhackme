[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Nmap](https://tryhackme.com/r/room/furthernmap) 

Всего 15 заданий:
## Задание 1
Нажмите зеленую кнопку, чтобы развернуть машину!
Обратите внимание: эта машина предназначена только для сканирования. Вам не нужно входить в нее или использовать 
какие-либо уязвимости для получения доступа. 

Если вы используете TryHackMe AttackBox, то вам нужно будет развернуть его отдельно. Нажмите кнопку Start AttackBox 
в правом верхнем углу, чтобы запустить машину. 

### Ответить на вопросы ниже
Разверните присоединенную виртуальную машину

```commandline
Ответ не нужен
```

## Задание 2
Когда дело доходит до взлома, знание — сила. Чем больше у вас знаний о целевой системе или сети, тем больше у вас 
возможностей. Это делает крайне важным проведение надлежащего подсчета до того, как будут предприняты какие-либо 
попытки эксплуатации.  

Допустим, нам дали IP (или несколько IP-адресов) для проведения аудита безопасности. Прежде чем что-либо делать, нам 
нужно получить представление о «ландшафте», который мы атакуем. Это означает, что нам нужно установить, какие службы 
запущены на целях. Например, возможно, одна из них запускает веб-сервер, а другая действует как контроллер домена 
Windows Active Directory. Первый этап в создании этой «карты» ландшафта — это то, что называется сканированием 
портов. Когда компьютер запускает сетевую службу, он открывает сетевую конструкцию, называемую «портом», для 
получения соединения. Порты необходимы для выполнения нескольких сетевых запросов или для обеспечения доступности 
нескольких служб. Например, когда вы загружаете несколько веб-страниц одновременно в веб-браузере, программа должна 
иметь какой-то способ определить, какая вкладка загружает какую веб-страницу. Это делается путем установления 
соединений с удаленными веб-серверами с использованием разных портов на вашей локальной машине. Аналогично, если вы 
хотите, чтобы сервер мог запускать более одной службы (например, возможно, вы хотите, чтобы ваш веб-сервер запускал 
как HTTP , так и HTTPS-версии сайта), то вам нужен какой-то способ направить трафик на соответствующую службу. И 
снова, порты являются решением этой проблемы. Сетевые соединения устанавливаются между двумя портами — открытым 
портом, прослушивающим сервер, и случайно выбранным портом на вашем собственном компьютере. Например, когда вы 
подключаетесь к веб-странице, ваш компьютер может открыть порт 49534 для подключения к порту 443 сервера.              



Как и в предыдущем примере, диаграмма показывает, что происходит, когда вы подключаетесь к нескольким веб-сайтам 
одновременно. Ваш компьютер открывает другой порт с высоким номером (случайным образом), который он использует для 
всех своих коммуникаций с удаленным сервером.  

Каждый компьютер имеет в общей сложности 65535 доступных портов; однако многие из них зарегистрированы как 
стандартные порты. Например, HTTP Webservice почти всегда можно найти на порту 80 сервера. HTTPS Webservice можно 
найти на порту 443. Windows NETBIOS можно найти на порту 139, а SMB можно найти на порту 445. Важно отметить; однако,
что, особенно в условиях CTF, нередки случаи, когда даже эти стандартные порты изменяются, что делает еще более 
необходимым выполнение соответствующего перечисления на цели.    

Если мы не знаем, какой из этих портов открыт на сервере, то у нас нет надежды на успешную атаку на цель; таким 
образом, крайне важно, чтобы мы начинали любую атаку со сканирования портов. Это можно сделать разными способами — 
обычно с помощью инструмента nmap, который находится в центре внимания этой комнаты. Nmap можно использовать для 
выполнения множества различных видов сканирования портов — наиболее распространенные из них будут представлены в 
следующих задачах; однако основная теория такова: nmap будет подключаться к каждому порту цели по очереди. В 
зависимости от того, как реагирует порт, его можно определить как открытый, закрытый или отфильтрованный (обычно 
брандмауэром). Как только мы узнаем, какие порты открыты, мы можем перечислить, какие службы запущены на каждом 
порту — либо вручную, либо, что более распространено, с помощью nmap.       

Итак, почему nmap? Короткий ответ заключается в том, что в настоящее время он является отраслевым стандартом по 
определенной причине: ни один другой инструмент сканирования портов не может сравниться с ним по функциональности 
(хотя некоторые новички теперь могут сравниться с ним по скорости). Это чрезвычайно мощный инструмент — он стал еще 
более мощным благодаря своему скриптовому движку, который можно использовать для сканирования уязвимостей, а в 
некоторых случаях даже для непосредственного выполнения эксплойта! Опять же, это будет рассмотрено подробнее в 
следующих задачах.     

На данный момент важно, чтобы вы понимали: что такое сканирование портов, почему оно необходимо и что nmap — это 
предпочтительный инструмент для любого вида первоначального подсчета. 

### Ответить на вопросы ниже
Какие сетевые конструкции используются для направления трафика в нужное приложение на сервере?

```commandline
Ports
```
Сколько из них доступно на любом сетевом компьютере?


```commandline
65535
```
[Исследование] Сколько из них считаются «общеизвестными»? (Это «стандартные» числа, упомянутые в задании)

1024
```commandline
Ответ не нужен
```

## Задание 3
Как и большинство инструментов для пентестинга, nmap запускается из терминала. Существуют версии для Windows и Linux.
Для этой комнаты мы предположим, что вы используете Linux; однако переключатели должны быть идентичны. Nmap 
установлен по умолчанию как в Kali Linux, так и в TryHackMe Attack Box.

Доступ к Nmap можно получить, введя nmapв командной строке терминала команду, а затем некоторые «ключи» (аргументы 
команды, которые сообщают программе, что нужно делать), которые мы рассмотрим ниже.

Все, что вам для этого понадобится, — это меню справки для nmap (доступ с помощью nmap -h) и/или страница 
руководства nmap (доступ с помощью man nmap). Для каждого ответа включите все части переключателя, если не указано 
иное. Это включает дефис в начале ( -).

### Ответить на вопросы ниже
Какой переключатель указан первым в меню справки для «Syn Scan» (подробнее об этом позже!)?
```commandline
-sS
```
Какой коммутатор вы бы использовали для «UDP-сканирования»?
```commandline
-sU
```
Какой переключатель вы бы использовали, если бы хотели определить, на какой операционной системе работает целевое 
устройство? 
```commandline
-O
```
Nmap предоставляет переключатель для определения версии служб, запущенных на цели. Что это за переключатель?
```commandline
-sV
```
Вывод по умолчанию, предоставляемый nmap, часто не предоставляет достаточно информации для пентестера. Как бы вы 
увеличили детализацию? 
```commandline
-v
```
Уровень детализации один хорош, но уровень детализации два лучше! Как бы вы установили уровень детализации два?
( Примечание : настоятельно рекомендуется всегда использовать по крайней мере эту опцию)
```commandline
-vv
```
Мы всегда должны сохранять результаты наших сканирований — это означает, что нам нужно запустить сканирование только 
один раз (что снижает сетевой трафик и, следовательно, вероятность обнаружения), и дает нам ссылку, которую можно 
использовать при написании отчетов для клиентов.  

Какой переключатель вы бы использовали для сохранения результатов nmap в трех основных форматах?
```commandline
-oA
```
Какой переключатель следует использовать для сохранения результатов nmap в «обычном» формате?
```commandline
-oN
```
Очень полезный формат вывода: как сохранить результаты в формате, пригодном для «grepable»?
```commandline
-oG
```
Иногда результаты, которые мы получаем, просто недостаточны. Если нас не волнует, насколько мы громкие, мы можем 
включить «агрессивный» режим. Это сокращенный переключатель, который активирует обнаружение служб, обнаружение 
операционной системы, трассировку и сканирование общих сценариев.  

Как бы вы активировали эту настройку?
```commandline
-A
```
Nmap предлагает пять уровней шаблона "времени". Они по сути используются для увеличения скорости сканирования. 
Однако будьте осторожны: более высокие скорости более шумные и могут привести к ошибкам!

Как бы вы установили шаблон синхронизации на уровень 5?
```commandline
-T5
```
Мы также можем выбрать, какой порт(ы) сканировать.

Как бы вы указали nmap сканировать только порт 80?
```commandline
-p 80
```
Как бы вы указали nmap сканировать порты 1000-1500?
```commandline
-p 1000-1500
```
Очень полезная опция, которую нельзя игнорировать:

Как бы вы указали nmap сканировать все порты?
```commandline
-p-
```
Как активировать скрипт из библиотеки скриптов nmap (подробнее об этом позже!)?
```commandline
--script
```
Как бы вы активировали все скрипты в категории «уязвимости»?
```commandline
--script=vuln
```

## Задание 4
При сканировании портов с помощью Nmap существует три основных типа сканирования. Это:
- Сканирование TCP- подключений (-sT)
- SYN «Полуоткрытые» сканы (-sS)
- Сканирование UDP (-sU)


Кроме того, есть несколько менее распространенных типов сканирования портов, некоторые из которых мы также 
  рассмотрим (хотя и менее подробно). Это: 
- TCP- сканирование нулей (-sN)
- Сканирование TCP FIN ( -sF)
- TCP Xmas сканирование ( -sX)
Большинство из них (за исключением сканирования UDP) используются для очень похожих целей, однако, способ их работы 
  отличается для каждого сканирования. Это означает, что, хотя одно из первых трех сканирований, скорее всего, будет 
  вашим выбором в большинстве ситуаций, стоит иметь в виду, что существуют и другие типы сканирования.  

Что касается сканирования сети, мы также кратко рассмотрим сканирование ICMP (или «ping»).

### Ответить на вопросы ниже
Прочитайте введение в типы сканирования.
```commandline
Ответ не нужен
```

## Задание 5
Чтобы понять сканирование TCP Connect ( -sT), важно, чтобы вы были знакомы с трехсторонним рукопожатием TCP . Если 
этот термин для вас новый, то перед продолжением рекомендуется завершить курс Вводные сетевые технологии. 

Вкратце, трехэтапное рукопожатие состоит из трех этапов. Сначала подключающийся терминал (в данном случае наша 
атакующая машина) отправляет TCP- запрос на целевой сервер с установленным флагом SYN. Затем сервер подтверждает 
этот пакет TCP- ответом , содержащим флаг SYN, а также флаг ACK. Наконец, наш терминал завершает рукопожатие, 
отправляя TCP- запрос с установленным флагом ACK.   



Это один из основополагающих принципов сетей TCP /IP, но как он связан с Nmap ?

Ну, как следует из названия, сканирование TCP Connect работает, выполняя трехстороннее рукопожатие с каждым целевым 
портом по очереди. Другими словами, Nmap пытается подключиться к каждому указанному порту TCP и определяет, открыта 
ли служба, по полученному ответу.  

Например, если порт закрыт, RFC 9293 гласит, что:

«... Если соединение не существует (ЗАКРЫТО), то сброс отправляется в ответ на любой входящий сегмент, за 
исключением другого сброса. Сегмент SYN, который не соответствует существующему соединению, отклоняется этим способом». 

Другими словами, если Nmap отправляет TCP- запрос с установленным флагом SYN на закрытый порт, целевой сервер 
ответит TCP- пакетом с установленным флагом RST (Reset). По этому ответу Nmap может установить, что порт закрыт. 



Однако если запрос отправляется на открытый порт, цель ответит TCP- пакетом с установленными флагами SYN/ACK. Затем 
Nmap помечает этот порт как открытый (и завершает рукопожатие, отправляя обратно TCP- пакет с установленным ACK). 

Это все хорошо, однако есть и третья возможность.

Что делать, если порт открыт, но скрыт за брандмауэром?

Многие брандмауэры настроены на простое отбрасывание входящих пакетов. Nmap отправляет запрос TCP SYN и ничего не 
получает в ответ. Это указывает на то, что порт защищен брандмауэром, и поэтому порт считается фильтруемым . 

Тем не менее, очень легко настроить брандмауэр для ответа пакетом RST TCP. Например, в IPtables для Linux простая 
версия команды будет выглядеть следующим образом: 

iptables -I INPUT -p tcp --dport <port> -j REJECT --reject-with tcp-reset

Это может чрезвычайно затруднить (если не сделать невозможным) получение точных показаний цели(ей).

### Ответить на вопросы ниже
Какой RFC определяет соответствующее поведение протокола TCP?


```commandline
RFC 9293
```
Если порт закрыт, какой флаг должен отправить сервер, чтобы сообщить об этом?
```commandline
RST
```

## Задание 6
Как и в случае со сканированием TCP , сканирование SYN ( -sS) используется для сканирования диапазона портов TCP 
цели или целей; однако, эти два типа сканирования работают немного по-разному. Сканирование SYN иногда называют « 
полуоткрытым» сканированием или «скрытым» сканированием.  

В то время как TCP -сканирование выполняет полное трехстороннее рукопожатие с целью, SYN-сканирование отправляет 
обратно пакет RST TCP после получения SYN/ACK от сервера (это предотвращает повторные попытки сервера сделать запрос)
. Другими словами, последовательность сканирования открытого порта выглядит следующим образом:

### Для нас, хакеров, это имеет ряд преимуществ:

- Его можно использовать для обхода старых систем обнаружения вторжений, поскольку они ищут полное трехстороннее 
рукопожатие. Это часто больше не относится к современным решениям IDS; именно по этой причине сканирование SYN все 
  еще часто называют сканированием «скрытого» типа. 
- SYN-сканирования часто не регистрируются приложениями, прослушивающими открытые порты, поскольку стандартная 
  практика заключается в регистрации соединения после его полной установки. Опять же, это играет на руку идее 
  скрытности SYN-сканирования. 
- Благодаря отсутствию необходимости выполнять (и отключать) трехстороннее рукопожатие для каждого порта, 
  сканирование SYN выполняется значительно быстрее стандартного сканирования TCP Connect.


Однако у SYN-сканирования есть несколько недостатков, а именно:
- Для корректной работы в Linux им требуются разрешения sudo [1] . Это связано с тем, что для сканирования SYN 
  требуется возможность создавать сырые пакеты (в отличие от полного TCP- рукопожатия), что по умолчанию является 
  привилегией только пользователя root.  
- Иногда нестабильные сервисы выходят из строя из-за сканирования SYN, что может оказаться проблематичным, если 
  клиент предоставил производственную среду для тестирования.


В целом, плюсы перевешивают минусы.
- По этой причине сканирования SYN являются сканированиями по умолчанию, используемыми Nmap при запуске с 
  разрешениями sudo . Если запущен без разрешений sudo, Nmap по умолчанию использует сканирование TCP Connect, 
  которое мы видели в предыдущей задаче.  
- При использовании сканирования SYN для определения закрытых и отфильтрованных портов применяются те же правила, 
  что и при сканировании TCP Connect. 
- Если порт закрыт, то сервер отвечает пакетом RST TCP . Если порт фильтруется брандмауэром, то пакет TCP SYN либо 
  отбрасывается, либо подделывается сбросом TCP. 



В этом отношении оба сканирования идентичны: большая разница заключается в том, как они обрабатывают открытые порты.

[1] SYN-сканирование также можно запустить, предоставив Nmap возможности CAP_NET_RAW, CAP_NET_ADMIN и 
CAP_NET_BIND_SERVICE; однако это может помешать корректной работе многих сценариев NSE. 

### Ответить на вопросы ниже
Существуют еще два названия SYN-сканирования. Как они называются?

```commandline
Half-Open, Stealth
```
Может ли Nmap использовать SYN-сканирование без разрешений Sudo (Да/Нет)?
```commandline
N
```

## Задание 7
В отличие от TCP, UDP- соединения не имеют состояния . Это означает, что вместо того, чтобы инициировать соединение 
с помощью двустороннего «рукопожатия», UDP- соединения полагаются на отправку пакетов на целевой порт и, по сути, на 
то, что они его получат. Это делает UDP превосходным для соединений, которые полагаются на скорость, а не на 
качество (например, обмен видео), но отсутствие подтверждения значительно затрудняет (и делает гораздо медленнее) 
сканирование UDP . Переключатель для сканирования UDP Nmap — ( -sU)

Когда пакет отправляется на открытый порт UDP , ответа быть не должно. Когда это происходит, Nmap ссылается на порт 
как на open|filtered. Другими словами, он подозревает, что порт открыт, но он может быть заблокирован брандмауэром. 
Если он получает ответ UDP (что бывает очень необычно), то порт помечается как открытый . Чаще всего ответа нет, и в 
этом случае запрос отправляется второй раз для двойной проверки. Если ответа по-прежнему нет, то порт помечается как 
открытый|отфильтрованный , и Nmap переходит к следующему этапу.    

Когда пакет отправляется на закрытый порт UDP , цель должна ответить пакетом ICMP (ping), содержащим сообщение о том,
что порт недоступен. Это четко определяет закрытые порты, которые Nmap помечает как таковые и движется дальше.

Из-за этой трудности в определении того, открыт ли порт UDP, сканирование UDP, как правило, невероятно медленное по 
сравнению с различными сканированиями TCP (в районе 20 минут для сканирования первых 1000 портов при хорошем 
соединении). По этой причине обычно хорошей практикой является запуск сканирования Nmap с --top-ports 
<number>включенным. Например, сканирование с  nmap -sU --top-ports 20 <target>. Будет сканировать 20 самых часто 
используемых портов UDP , что приведет к гораздо более приемлемому времени сканирования.

При сканировании портов UDP Nmap обычно отправляет совершенно пустые запросы — просто сырые пакеты UDP . При этом 
для портов, которые обычно заняты известными службами, он вместо этого отправит полезную нагрузку, специфичную для 
протокола, которая с большей вероятностью вызовет ответ, из которого можно извлечь более точный результат.

### Ответить на вопросы ниже
Если порт UDP не отвечает на сканирование Nmap, как он будет помечен?
```commandline
open|filtered
```
Когда порт UDP закрыт, по соглашению цель должна отправить обратно сообщение «порт недоступен». Какой протокол она 
будет использовать для этого? 
```commandline
ICMP
```

## Задание 8
Сканирование портов TCP NULL, FIN и Xmas используется реже, чем любое другое, о котором мы уже говорили, поэтому мы 
не будем вдаваться в подробности. Все три взаимосвязаны и используются в первую очередь потому, что они, как правило,
еще более скрытны, относительно говоря, чем "скрытое" сканирование SYN. Начнем со сканирования NULL:

Как следует из названия, сканирование NULL ( -sN) происходит, когда запрос TCP отправляется без установки флагов 
вообще. Согласно RFC , целевой хост должен ответить RST, если порт закрыт. 

Сканирование FIN ( -sF) работает почти идентично; однако вместо отправки совершенно пустого пакета отправляется 
запрос с флагом FIN (обычно используется для корректного закрытия активного соединения). И снова Nmap ожидает RST, 
если порт закрыт.

Как и в случае с двумя другими сканированиями в этом классе, сканирование Xmas ( -sX) отправляет неправильно 
сформированный пакет TCP и ожидает ответ RST для закрытых портов. Это называется сканированием Xmas, поскольку флаги,
которые оно устанавливает (PSH, URG и FIN), придают ему вид мигающей рождественской елки при просмотре в качестве 
захвата пакета в Wireshark.

Ожидаемый ответ для открытых портов при этих сканированиях также идентичен и очень похож на ответ сканирования UDP . 
Если порт открыт, то ответа на искаженный пакет нет. К сожалению (как и в случае с открытыми портами UDP ), это 
также ожидаемое поведение, если порт защищен брандмауэром, поэтому сканирования NULL, FIN и Xmas будут определять 
порты только как открытые|фильтруемые , закрытые или фильтруемые . Если порт определяется как фильтруемый при одном 
из этих сканирований, то это обычно происходит из-за того, что цель ответила пакетом ICMP о недоступности.

Также стоит отметить, что хотя RFC 793 предписывает сетевым хостам отвечать на некорректные пакеты пакетом RST TCP 
для закрытых портов и не отвечать вообще для открытых портов, на практике это не всегда так. В частности, известно, 
что Microsoft Windows (и множество сетевых устройств Cisco) отвечают RST на любой некорректный пакет TCP — 
независимо от того, открыт порт на самом деле или нет. Это приводит к тому, что все порты отображаются как закрытые.

Тем не менее, цель здесь, конечно, уклонение от брандмауэра. Многие брандмауэры настроены на сброс входящих 
TCP-пакетов на заблокированные порты, на которых установлен флаг SYN (таким образом блокируя новые запросы на 
инициацию соединения). Отправляя запросы, не содержащие флага SYN, мы эффективно обходим этот тип брандмауэра. Хотя 
это хорошо в теории, большинство современных решений IDS подкованы в этих типах сканирования, поэтому не полагайтесь 
на них, как на 100% эффективные при работе с современными системами.

### Ответить на вопросы ниже
Какой из трех показанных типов сканирования использует флаг URG?
```commandline
xmas
```
Почему обычно используются сканирования NULL, FIN и Xmas?
```commandline
Firewall Evasion
```
Какая распространенная ОС может ответить на сканирование NULL, FIN или Xmas с помощью RST для каждого порта?
```commandline
Microsoft Windows
```

## Задание 9
При первом подключении к целевой сети в задании «черный ящик» нашей первой целью является получение «карты» 
структуры сети — или, другими словами, мы хотим увидеть, какие IP-адреса содержат активные хосты, а какие нет. 

Один из способов сделать это — использовать Nmap для выполнения так называемого «ping sweep». Это именно то, что 
следует из названия: Nmap отправляет пакет ICMP на каждый возможный IP-адрес для указанной сети. Когда он получает 
ответ, он отмечает ответивший IP-адрес как активный. По причинам, которые мы увидим в более поздней задаче, это не 
всегда точно; однако это может предоставить что-то вроде базового уровня и поэтому заслуживает рассмотрения.   

Для выполнения ping-сканирования мы используем коммутатор -snв сочетании с диапазонами IP-адресов, которые можно 
указать либо с помощью дефиса ( -), либо с помощью нотации CIDR. То есть мы можем сканировать 192.168.0.xсеть, 
используя:  
```commandline
nmap -sn 192.168.0.1-254
```
или
```commandline
nmap -sn 192.168.0.0/24
```
Коммутатор -snсообщает Nmap не сканировать никакие порты, заставляя его полагаться в первую очередь на эхо-пакеты 
ICMP (или запросы ARP-sn в локальной сети, если запущен с sudo или напрямую как пользователь root) для определения 
целей. В дополнение к эхо-запросам ICMP коммутатор также заставит nmap отправить пакет TCP SYN на порт 443 цели, а 
также пакет TCP ACK (или TCP SYN, если запущен не как пользователь root) на порт 80 цели.   

### Ответить на вопросы ниже
Как бы вы выполнили ping-сканирование в сети 172.16.xx (сетевая маска: 255.255.0.0) с помощью Nmap? (нотация CIDR)
```commandline
nmap -sn 172.16.0.0/16
```

## Задание 10
N map S cripting Engine (NSE) — невероятно мощное дополнение к Nmap , значительно расширяющее его функциональность. 
Скрипты NSE написаны на языке программирования Lua и могут использоваться для выполнения различных задач: от 
сканирования уязвимостей до автоматизации их использования. NSE особенно полезен для разведки, однако стоит помнить, 
насколько обширна библиотека скриптов.   

Доступно много категорий. Некоторые полезные категории включают:

- safe:- Не повлияет на цель
- intrusive:- Небезопасно: вероятно, повлияет на цель
- vuln:- Сканирование на наличие уязвимостей
- exploit:- Попытка воспользоваться уязвимостью
- auth:- Попытка обойти аутентификацию для запущенных служб (например, анонимный вход на FTP- сервер)
- brute:- Попытка взлома учетных данных для запуска служб
- discovery:- Попытайтесь запросить у запущенных служб дополнительную информацию о сети (например, запросить 
  SNMP-сервер).


Более полный список можно найти здесь .

В следующем задании мы рассмотрим, как взаимодействовать с NSE и использовать скрипты в этих категориях.

### Ответить на вопросы ниже
На каком языке написаны скрипты NSE?
```commandline
Lua
```
Какую категорию скриптов не стоит запускать в производственной среде?
```commandline
intrusive
```
## Задание 11
В Задаче 3 мы очень кратко рассмотрели --scriptпереключатель для активации скриптов NSE из vulnкатегории с 
использованием --script=vuln. Неудивительно, что другие категории работают точно так же. Если команда 
--script=safeзапущена, то все применимые безопасные скрипты будут запущены против цели (Примечание: будут 
активированы только скрипты, нацеленные на активную службу).

Чтобы запустить определенный скрипт, мы используем --script=<script-name> , например 
`--script=http-fileupload-exploiter, `. 

Несколько скриптов могут быть запущены одновременно таким образом, разделяя их запятой. Например: 
`--script=smb-enum-users,smb-enum-shares`. 

Некоторые скрипты требуют аргументов (например, учетных данных, если они эксплуатируют аутентифицированную 
уязвимость). Их можно задать с помощью переключателя --script-args Nmap . Примером этого может служить 
http-putскрипт (используемый для загрузки файлов с помощью метода PUT). Он принимает два аргумента: URL-адрес для 
загрузки файла и местоположение файла на диске. Например:   

```nmap -p 80 --script http-put --script-args http-put.url='/dav/shell.php',http-put.file='./shell.php'```

Обратите внимание, что аргументы разделяются запятыми и соединяются с соответствующим скриптом точками (т.е.  
<script-name>.<argument>). 

Полный список скриптов и соответствующих им аргументов (вместе с примерами использования) можно найти здесь .

Скрипты Nmap поставляются со встроенными меню справки, доступ к которым можно получить с помощью nmap --script-help 
<script-name>. Обычно это не так обширно, как в ссылке, указанной выше, однако, это все еще может быть полезно при 
локальной работе.  

### Ответить на вопросы ниже
Какой необязательный аргумент может ftp-anon.nseпринимать сценарий?

```commandline
maxlist
```

## Задание 12
Итак, мы знаем, как использовать скрипты в Nmap, но мы пока не знаем, как найти эти скрипты.

У нас есть два варианта для этого, которые в идеале должны использоваться в сочетании друг с другом. Первый — это 
страница на сайте Nmap (упомянутая в предыдущей задаче), которая содержит список всех официальных скриптов. Второй — 
локальное хранилище на вашей атакующей машине. Nmap хранит свои скрипты на Linux в /usr/share/nmap/scripts. Все 
скрипты NSE по умолчанию хранятся в этом каталоге — именно там Nmap ищет скрипты, когда вы их указываете.   

Есть два способа поиска установленных скриптов. Один из них — с помощью файла /usr/share/nmap/scripts/script.db. 
Несмотря на расширение, это на самом деле не база данных, а скорее отформатированный текстовый файл, содержащий 
имена файлов и категории для каждого доступного скрипта.  



Nmap использует этот файл для отслеживания (и использования) скриптов для скриптового движка; однако мы также можем 
выполнить grep для поиска скриптов. Например: grep "ftp" /usr/share/nmap/scripts/script.db. 



Второй способ поиска скриптов — это довольно просто использовать команду ls. Например, мы могли бы получить те же 
результаты, что и на предыдущем снимке экрана, используя ls -l /usr/share/nmap/scripts/*ftp*: 



Обратите внимание на использование звездочек ( *) по обе стороны от поискового запроса.

Те же методы можно использовать для поиска категорий сценариев. Например:
`grep "safe" /usr/share/nmap/scripts/script.db`

### Установка новых скриптов

Ранее мы упоминали, что веб-сайт Nmap содержит список скриптов, так что же произойдет, если один из них отсутствует 
в scriptsлокальном каталоге? Стандарт sudo apt update && sudo apt install nmap должен исправить это; однако, также 
возможно установить скрипты вручную, загрузив скрипт из Nmap ( sudo wget -O /usr/share/nmap/scripts/<script-name>.
nse https://svn.nmap.org/nmap/scripts/<script-name>.nse). Затем это должно сопровождаться nmap --script-updatedb, 
который обновляет script.dbфайл, чтобы он содержал недавно загруженный скрипт.    

Стоит отметить, что вам понадобится та же команда «updatedb», если вы захотите создать свой собственный скрипт NSE и 
добавить его в Nmap — более чем выполнимая задача при наличии некоторых базовых знаний Lua! 

### Ответить на вопросы ниже
Найдите в /usr/share/nmap/scripts/каталоге скрипты "smb", используя любой из продемонстрированных методов.
Каково имя файла скрипта, который определяет базовую ОС сервера SMB?
```commandline
smb-os-discovery.nse
```
Прочитайте этот сценарий. От чего он зависит?
```commandline
smb-brute
```

## Задание 13
Мы уже рассмотрели некоторые методы обхода брандмауэров (например, скрытое сканирование, а также сканирование NULL, 
FIN и Xmas); однако существует еще одна очень распространенная конфигурация брандмауэра, которую крайне важно знать, 
как обойти.  

Ваш типичный хост Windows будет, с его брандмауэром по умолчанию, блокировать все пакеты ICMP. Это представляет 
собой проблему: не только мы часто используем ping для ручного определения активности цели, Nmap делает то же самое 
по умолчанию. Это означает, что Nmap зарегистрирует хост с этой конфигурацией брандмауэра как мертвый и вообще не 
будет сканировать его.   

Итак, нам нужен способ обойти эту конфигурацию. К счастью, Nmap предоставляет для этого опцию: -Pn, которая сообщает 
Nmap , что не нужно беспокоиться о пинге хоста перед его сканированием. Это означает, что Nmap всегда будет считать 
целевой хост(ы) активными, эффективно обходя блокировку ICMP; однако это достигается ценой потенциально очень 
длительного времени для завершения сканирования (если хост действительно мертв, то Nmap все равно будет проверять и 
перепроверять каждый указанный порт).    

Стоит отметить, что если вы уже находитесь непосредственно в локальной сети, Nmap также может использовать ARP- 
запросы для определения активности хоста.  

Есть множество других переключателей, которые Nmap считает полезными для обхода брандмауэра. Мы не будем 
рассматривать их подробно, однако их можно найти здесь . 

Особого внимания заслуживают следующие переключатели:

- -f:- Используется для фрагментации пакетов (т. е. разделения их на более мелкие части), что снижает вероятность 
обнаружения пакетов межсетевым экраном или системой обнаружения вторжений.
- Альтернатива -f, но предоставляющая больше контроля над размером пакетов: --mtu <number>, принимает максимальный 
  размер единицы передачи для использования в отправляемых пакетах. Он должен быть кратен 8.
- --scan-delay <time>ms:- используется для добавления задержки между отправленными пакетами. Это очень полезно, если 
  сеть нестабильна, а также для обхода любых срабатываний брандмауэра/ IDS , основанных на времени.
- --badsum:- это используется для генерации недействительной контрольной суммы для пакетов. Любой реальный стек 
  TCP/IP отбросит этот пакет, однако брандмауэры могут потенциально ответить автоматически, не беспокоясь о проверке 
  контрольной суммы пакета. Таким образом, этот переключатель может использоваться для определения наличия 
  брандмауэра/ IDS.  
### Ответить на вопросы ниже
Какой простой (и часто используемый) протокол часто блокируется, требуя использования коммутатора -Pn?
```commandline
ICMP
```
[Исследование] Какой переключатель Nmap позволяет добавлять произвольную длину случайных данных в конец пакетов?
```commandline
--data-length
```

## Задание 14
Используйте полученные знания для сканирования целевой машины и ответьте на следующие вопросы!
(Примечание: если вы не являетесь подписчиком, убедитесь, что у этого устройства было около десяти минут для запуска)

### Ответить на вопросы ниже
Отвечает ли целевой IP-адрес на запросы ICMP echo (ping) (Да/Нет)?
```commandline
N
```
Выполните сканирование Xmas на первых 999 портах цели — сколько портов открыты или отфильтрованы?
```commandline
999
```
Для этого есть причина. Какая она?

Примечание: Ответ будет в результатах сканирования. Тщательно продумайте, какие переключатели использовать, и 
прочитайте подсказку, прежде чем просить о помощи! 
```commandline
No Response
```
Выполните сканирование TCP SYN на первых 5000 портах цели — сколько портов открыты?
```commandline
5
```
Откройте Wireshark (см. инструкции в Wireshark Room от Cryillic ) и выполните сканирование TCP Connect на порту 80 
на целевом компьютере, отслеживая результаты. Убедитесь, что вы понимаете, что происходит.  Разверните скрипт на 
устройстве. Может ли Nmap успешно войти на FTP-сервер на порту 21? (Y/N) ftp-anon   
```commandline
Y
```

## Задание 15
Вы завершили изучение комнаты Further Nmap — надеемся, она вам понравилась и вы узнали что-то новое!

Есть много отличных ресурсов, чтобы узнать больше о Nmap самостоятельно. Впереди и в центре — собственные (весьма 
обширные) документы Nmap , которые уже упоминались несколько раз в комнате. Это великолепный ресурс, поэтому, хотя 
читать их построчно и заучивать наизусть совершенно не нужно, было бы крайне желательно использовать их в качестве 
справочной информации, если она вам понадобится.

### Ответить на вопросы ниже
Прочитайте заключение.

```commandline
Ответ не нужен
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)