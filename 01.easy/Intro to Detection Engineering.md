[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Intro to Detection Engineering](https://tryhackme.com/r/room/introtodetectionengineering) 

Всего 6 заданий:
## Задание 1
Инженерия обнаружения — важная роль и задача для аналитика безопасности. Она включает в себя разработку процессов, 
которые помогут вам как аналитику выявлять угрозы, обнаруживать их с помощью правил и процессов и настраивать 
процесс по мере изменения ландшафта.  

Цели обучения
- Понять, что такое техника обнаружения.
- Понять жизненный цикл разработки систем обнаружения.
- Определить различные структуры, используемые в технике обнаружения.
На рисунке показано, как инженер по безопасности использует увеличительное стекло на компьютере для демонстрации 
  процесса обнаружения активности.

### Ответьте на вопросы ниже
Давайте начнем.
```commandline
Ответ не нужен
```

## Задание 2
#### Обнаружение техники
Кибербезопасность растет и развивается быстрыми темпами, усугубляясь прогрессом в технологиях. Вместе с этим 
развиваются и действия противников, а кибератаки становятся настолько необузданными и изощренными, что за ними 
трудно угнаться. Кроме того, команды по безопасности должны разрабатывать и адаптироваться к новым образам мышления 
и практикам, которые помогут им не отставать от противников. Вот тут-то и вступает в дело техника обнаружения.

Инженерия обнаружения — это непрерывный процесс создания и эксплуатации аналитики разведки угроз для выявления 
потенциально вредоносной активности или неправильных конфигураций, которые могут повлиять на вашу среду. Это требует 
культурного сдвига с согласованием всех групп безопасности и руководства для создания эффективных систем защиты от 
угроз.

#### Типы обнаружения
Обнаружение угроз можно рассматривать с двух точек зрения, каждая из которых включает две категории: Первая,  
обнаружение на основе среды  , фокусируется на рассмотрении изменений в среде на основе конфигураций и базовых 
действий, которые были определены. В рамках этого обнаружения у нас есть обнаружение конфигурации и моделирование.

Во второй перспективе   обнаружение на основе угроз фокусируется на элементах, связанных с деятельностью противника, 
таких как тактика, инструменты и артефакты, которые идентифицируют его действия. В рамках этого у нас есть 
индикаторы и обнаружения поведения угроз.

#### Обнаружение конфигурации
В рамках этого обнаружения мы используем текущие знания об известной среде и инфраструктуре для выявления 
несоответствий. Конфигурации могут пересекать домены, включая сеть, актив или идентификацию.

Обнаружение конфигурации имеет следующие преимущества и проблемы:

#### Моделирование
Обнаружение угроз в рамках этого типа осуществляется путем определения базовых операций и действий и регистрации 
любых возникающих отклонений. Основное предположение этого подхода заключается в том, что вредоносная активность 
может быть достаточно четко идентифицирована от безобидной активности.  

Подход предполагает создание профиля активов или активности, который включает базовые события, время и порог данных. 
Углубленный взгляд на базовые данные будет обсуждаться в следующей задаче.  

Некоторые преимущества и недостатки этого метода обнаружения включают в себя следующее:


#### Индикатор обнаружения
Напоминаем, что индикаторы — это фрагменты информации, которые идентифицируют состояние и контекст элемента или 
сущности. Существуют как goodиндикаторы, используемые для идентификации законных действий или ресурсов, например, 
используемые в белых списках, так и bad индикаторы, используемые для подозрительных или вредоносных ресурсов, 
например, в черных списках или вредоносных IP-адресах.   

IOC обычно ссылаются и выводят из расследований против вредоносных событий. Наблюдая за деятельностью и 
расследованиями угроз, аналитики могут использовать выявленные индикаторы для создания обнаружений и адаптировать их 
на основе скорости изменения противника.  

Некоторые преимущества и недостатки этого метода обнаружения включают в себя следующее:


#### Обнаружение опасного поведения
Аналитики будут рассматривать тактики, методы и процедуры (TTP) противника для проведения атаки, независимо от 
каких-либо конкретных индикаторов. Это делает обнаружение более масштабируемым за пределами индикаторов. 

Благодаря этому обнаружению аналитики могут более эффективно сосредоточить свои усилия на реагировании на угрозу и 
смягчении ее последствий, вместо того чтобы тратить время и ресурсы на понимание того, как и почему были 
сгенерированы оповещения. Кроме того, обнаружение поведения угроз может быть сопряжено с установленными рабочими 
процессами и руководствами для предоставления передовых методов, которым можно следовать во время расследования.   

Некоторые преимущества и недостатки этого метода обнаружения включают в себя следующее:

Объединение этих форм обнаружения приводит к более надежным системам защиты. Например, обнаружение на основе модели 
может быть усилено с помощью обнаружения конфигурации под руководством эксперта, чтобы снизить вероятность ложных 
срабатываний, выдающих оповещения.  

#### Обнаружение как код
Detection as Code (DaC) — это структурированный подход к написанию обнаружений, включающий принципы передовой 
практики разработки программного обеспечения. Это означает, что инженеры по обнаружению и аналитики будут 
обрабатывать процессы обнаружения и логику как код, предлагая масштабируемость для реагирования на быстро меняющиеся 
среды и возможности противника.   

DaC предлагает рабочий процесс на основе кода, который создает тонко настроенные процессы обнаружения, которые 
вводят критические элементы, найденные в рабочих процессах непрерывной интеграции/непрерывной разработки ( CI / CD ).
Некоторые из этих элементов включают:  
- Контроль версий: большинство продуктов SIEM и EDR не имеют возможности отслеживать изменения, внесенные в оповещения и их определения. Внедрение контроля версий позволяет быстро просматривать, тестировать и учитывать правила и процессы обнаружения, что обеспечивает более высокое качество обнаружения.
- Автоматизация рабочих процессов: Внедрение рабочего процесса CI / CD позволяет автоматизировать тестирование 
  обнаружения и обеспечивает быстрый переход и поставку продукции.

При этом Detection as Code обеспечивает следующие преимущества:
- Настраиваемые и гибкие обнаружения: использование общего языка для обнаружения, такого как Sigma и YARA, дает DaC возможность быть независимым от поставщика и развертываться в многочисленных решениях SIEM, EDR и XDR.
- Разработка через тестирование: Качественное тестирование кода обнаружения может гарантировать, что слепые пятна и 
  ложноположительные тесты будут выявлены на ранних этапах процесса и повысит эффективность обнаружения. Кроме того, этот подход повышает качество обнаружения и гарантирует, что они хорошо документированы.
- Совместная работа команд: использование рабочих процессов CI / CD устраняет изоляцию между командами по 
  безопасности и способствует совместной работе в процессе кодирования.
- Возможность повторного использования кода: поскольку со временем появляются новые шаблоны обнаружения, инженеры 
  могут повторно использовать код для выполнения аналогичных функций в разных обнаружениях, гарантируя, что процесс обнаружения будет проходить быстрее, поскольку не будет необходимости начинать все с самого начала.
На рисунке показаны процессы, происходящие во время обнаружения как кода.

### Ответьте на вопросы ниже
Какой тип обнаружения фокусируется на несоответствиях в текущей инфраструктуре?
```commandline
Configuration
```
Какой подход к обнаружению подразумевает  создание базового профиля активов или деятельности для обнаружения?
```commandline
Modelling
```
Какой тип обнаружения  интегрируется с оборонительными схемами?
```commandline
Threat Behaviour
```

## Задание 3
Анализ пробелов в обнаружении
Первый шаг включает в себя изучение среды и определение ключевых областей, в которых организации могут улучшить обнаружение угроз. Этот процесс также известен как моделирование угроз и может быть выполнен следующими способами:

Реагирование : оценка последних внутренних отчетов об инцидентах, учет уроков, извлеченных из атак, и выявление пропущенных областей возможного обнаружения.
Проактивный : использование структуры ATT&CK и различных источников информации об угрозах для определения потенциальных областей атак и различных тактик TTP, которые может использовать противник против вашей среды.
Примечание: Моделирование угроз в этом контексте отличается от типа обнаружения, обсуждавшегося в предыдущей задаче.

Идентификация источника данных и сбор журналов
Имея информацию о соответствующих субъектах угроз, TTP и потенциальных рисках, с которыми может столкнуться организация, необходимо определить источники соответствующих данных, связанных с рисками. Это позволит определить, какие журналы в настоящее время доступны, что поможет определить обнаружения угроз и узнать, какие из них отсутствуют, а какие необходимы.

Создание базовой линии
Прежде чем использовать всю собранную информацию о противниках, их TTP и любом вредоносном поведении, аналитики безопасности должны знать, что такое нормальное поведение, и установить свои базовые уровни безопасности. Это будет непрерывный процесс, требующий участия всех отделов организации.

Настройка базовых линий безопасности включает в себя определение различных типов устройств, работающих в организации, на основе их операционной системы, служб и функций. Базовые линии безопасности можно сгруппировать в две категории:

Высокий уровень: устанавливает общие независимые от ОС стандарты, руководствуясь определенной политикой безопасности.
Технический: Он состоит из стандартов конфигурации на основе ОС , описывающих различные системные функции и предполагаемое поведение или действия. Например, технические базовые линии описывают политики усиления ОС , сетевые действия, политики управления идентификацией и доступом (IAM) и политики приложений.
Сбор журналов
После того, как базовые данные и источники внутренних данных были идентифицированы и расставлены по приоритетам, следует выполнить сбор журналов и метаданных, полезных для обнаружения угроз. В зависимости от настройки инфраструктуры централизованная система может объединять все журналы, используя сетевые датчики для сетевых данных и такие службы, как Sysmon, для сбора данных хоста.

Написание правил
На основе настройки инфраструктуры и служб SIEM необходимо будет написать и протестировать правила обнаружения на источниках данных. Правила обнаружения проверяют аномальные шаблоны на основе зарегистрированных событий. Сетевой трафик будет оцениваться с помощью правил Snort, в то время как правила Yara будут оценивать данные файлов. Посетите комнаты Snort и Yara для получения дополнительной информации.

В рамках модуля «Технология обнаружения» мы рассмотрим Sigma — универсальный язык сигнатур, используемый для написания правил обнаружения для файлов журналов.

Развертывание, автоматизация и настройка
Протестированные правила обнаружения должны быть введены в эксплуатацию для оценки в реальной среде. Со временем обнаружения должны быть изменены и обновлены для учета изменений в векторах атак, шаблонах или среде. Это повышает качество обнаружения и поощряет рассматривать обнаружение как непрерывный процесс.

### Ответьте на вопросы ниже
Прочитайте вышеизложенное.

```commandline
Ответ не нужен
```

## Задание 4
Фреймворки ATT&CK и CAR от MITRE
MITRE хорошо известен тем, что публикует выявленные CVE, которые злоумышленники хотели бы использовать для своих вредоносных действий. Кроме того, MITRE предоставляет доступ на основе знаний, который аналитики безопасности могут использовать для отслеживания тактик и методов, обычно используемых злоумышленниками на разных платформах, таких как Windows, macOS, Linux и Mobile.

Структура ATT&CK помогает планировать враждебные действия на основе инфраструктуры, используемой для инженерии обнаружения. Она указывает, что искать, особенно в рамках фазы анализа пробелов обнаружения.

База знаний CAR ( репозиторий кибераналитики ) используется для обнаружения поведения злоумышленников и определения их приоритетности на основе фреймворка ATT&CK.

Изображение, показывающее поперечное сечение структуры ATT&CK

Нажмите, чтобы увеличить изображение.

Пирамида Боли
Это хорошо известная в отрасли структура, которая в основном используется для демонстрации неудобств для противника: если защитники обнаружат свои TTP, то насколько сложно и/или дорого будет противнику изменить свои TTP.

Пирамида боли

Кибер-цепочка убийств
Благодаря военной концепции стратегии атаки, Lockheed Martin сформулировала структуру Cyber Kill Chain, чтобы определить необходимые шаги, которым следуют противники. Структура фокусируется на семи важнейших фазах, которые обычно следуют за кибератаками:

Разведка
Вооружение
Доставка
Эксплуатация
Установка
Командование и контроль
Действия по целям
Киберцепочка убийств.

Как аналитик по безопасности и инженер по обнаружению, понимание Cyber Kill Chain даст вам знания, необходимые для распознавания попыток вторжения, созданных противником, и их отображения в вашем плане обнаружения. Unified Kill Chain был разработан для дополнения Cyber ​​Kill Chain путем объединения его с другими фреймворками, такими как фреймворк MITRE ATT&CK. Это расширило исходную kill chain до 18 фаз, чтобы охватить все известные элементы кибератаки.

На рисунке показаны фазы унифицированной цепочки убийств.

Если вы не знакомы с этими фреймворками, ознакомьтесь со следующими статьями, которые дадут вам глубокое понимание:

Пирамида Боли
Кибер-цепочка убийств
Единая цепочка убийств
МИТРА
### Ответьте на вопросы ниже
Какая структура рассматривает, как затруднить злоумышленнику изменение своего подхода в случае обнаружения?
```commandline
Pyramid of Pain
```
Как называется усовершенствованная структура Cyber Kill Chain?
```commandline
The Unified Kill Chain
```
Сколько фаз в улучшенной цепочке убийств?
```commandline
18
```

## Задание 5
Структура стратегии оповещения и обнаружения
Palantir разработала ADS Framework, чтобы предоставить руководство по документированию контента обнаружения. 
Значительная проблема, с которой сталкиваются команды по безопасности, и Palantir не является исключением, — это 
усталость от бдительности и апатия, в основном вызванные неэффективными средствами разработки и внедрения оповещений 
об обнаружении, которые привели бы к эффективному реагированию на инциденты и смягчению их последствий. ADS 
Framework стремится решить эту проблему и предоставить руководство по построению эффективных обнаружений и оповещений.    

ADS Framework имеет строгий поток, которому инженеры по обнаружению должны следовать перед публикацией правил 
обнаружения в производство. Вовлеченные этапы следующие:  
- Цель: Описывает предполагаемые причины настройки оповещения и тип поведения, которое необходимо обнаружить.
- Категоризация: сопоставление обнаружения с фреймворком MITRE ATT&CK для предоставления аналитикам информации о TTP 
  для расследования и областях цепочки уничтожения, где будет использоваться ADS. 
- Аннотация стратегии: предоставляет общее описание того, как функционирует реализуемая стратегия обнаружения, 
  описывая, на что будет направлено оповещение, источники данных, ресурсы обогащения и способы сокращения ложных 
  срабатываний.  
- Технический контекст: описывает техническую среду обнаружения, которая будет использоваться, предоставляя 
  аналитикам и респондентам всю информацию, необходимую для понимания оповещения. Аналитики безопасности должны 
  согласовывать эту информацию с платформами и инструментами для сбора и обработки оповещений об угрозах.
- Слепые пятна и предположения: Описывает любые выявленные проблемы, где подозрительные действия могут не запустить 
  стратегию. Предположения и слепые пятна помогают прояснить, как ADS может выйти из строя или быть обойдена 
  противником.  
- Ложные срабатывания: описывает случаи, когда оповещения могут быть вызваны из-за неправильной конфигурации или 
  невредоносных действий в среде. Это позволяет легко настроить SIEM, чтобы ограничить генерацию оповещений только 
  целевыми угрозами при запуске в производство.
- Проверка: Каждое обнаружение должно быть проверено, и здесь вы можете описать все шаги, необходимые для создания 
  истинно-положительного события, которое вызовет оповещение об обнаружении. Рассматривайте это как модульный тест, 
  который может быть даже сценарием или сценарием, используемым для генерации оповещения. 


Для эффективной проверки:
- Разработайте план, который даст действительно положительный результат.
- Документируйте процесс выполнения плана.
- В тестовой среде проведите тестирование и запустите оповещение.
- Проверьте стратегию, вызвавшую оповещение.

Приоритет: Настройте уровни оповещения, с помощью которых может быть помечена стратегия обнаружения. В этом разделе 
приведены сведения о критериях, используемых для настройки предпочтений, и он отделен от уровней оповещения, 
отображаемых через SIEM.

Ответ: Предоставляет подробную информацию о том, как сортировать и расследовать оповещение об обнаружении. Эта 
информация полезна для аналитиков и респондентов, чтобы иметь возможность предотвратить экстремальные последствия.

Этапы стратегии оповещения и обнаружения.

#### Модель уровня зрелости обнаружения
Райан Стиллионс выдвинул модель уровня зрелости обнаружения (DML) в 2014 году как способ для организации оценить 
свои уровни зрелости относительно ее способности принимать и использовать разведданные о киберугрозах для 
обнаружения действий противника. По словам Райана, для этой модели есть два руководящих принципа:

Зрелость организации измеряется не ее способностью получать ценную разведывательную информацию, а ее способностью применять ее для обнаружения и реагирования.
Без налаженных функций обнаружения нет возможности осуществлять функции реагирования.
Модель DML состоит из девяти выделенных уровней зрелости, пронумерованных от 0 до 8, где наименьшее значение представляет технические аспекты атаки, а наивысший уровень представляет абстрактные и интеллектуальные аспекты атаки. Отдельные уровни можно описать следующим образом:

Цели DML-8: Вершина модели представляет организации, которые могут обнаружить мотивы и цели противника. К сожалению, практически невозможно проводить обнаружения, основываясь исключительно на целях, поскольку в большинстве случаев это игра в догадки, основанная на поведенческих выводах из более низких DML.
DML-7 Стратегия : Этот уровень, который следует сразу за DML-8, не является техническим и представляет намерения противника и стратегии их выполнения. Организации на этом уровне будут иметь зрелый источник разведданных, который обеспечит им контекст относительно планов противника, что будет полезно для респондентов.
Тактика DML-6: Организации должны быть способны обнаружить тактику, используемую противником, не обязательно зная, какую технику или инструмент он использовал. Тактику можно обнаружить после наблюдения за закономерностями событий, которые объединяются с течением времени и при определенных условиях.
Методы DML-5: Методы обычно специфичны для отдельного человека или APT . Поэтому злоумышленники оставляют доказательства своих привычек и поведения при атаках, а организации, которые могут обнаружить, когда конкретный субъект угрозы находится в их среде, получают преимущество.
Процедуры DML-4: Организациям необходимо обнаружить последовательности событий противника на этом уровне. Они будут очень организованы и будут следовать заданному шаблону, например, разведке перед эксфильтрацией.
Инструменты DML-3: Обнаружение инструментов может делиться на два этапа: первый этап, transfer phaseкогда инструмент загружается через сеть на хост-устройство и размещается в файловой системе или в памяти. Второй этап — обнаружение через functionality and operation. В некоторых случаях этот уровень обнаружения потребует от организаций проведения обратного проектирования вредоносных инструментов, что затрудняет нанесение ущерба путем понимания возможностей их инструментов.
DML-2 Хост и сетевые артефакты: большая часть организационных ресурсов будет потрачена на сбор IOC и артефактов в качестве разведданных об угрозах на этом уровне. К сожалению, в большинстве случаев индикаторы наблюдаются постфактум. Субъект угрозы, скорее всего, вызовет хаос в сети, когда артефакты будут подобраны и исследованы. Это было описано как «преследование инверсионного следа самолета».
Атомарные индикаторы DML-1: этот уровень охватывает организации, использующие потоки разведданных об угрозах в виде списков IP-адресов и доменов для обнаружения угроз.
DML-0 Нет: В нижней части модели организации, работающие на этом уровне, не имеют установленных процессов обнаружения.
Пирамида модели уровня зрелости обнаружения

В оригинальной публикации модели DML Райан описал четыре критических варианта использования модели, а именно:
- Предоставить словарь для более доступной передачи информации об угрозах.
- Оценить зрелость обнаружения в отношении отслеживаемых субъектов угроз.
- Оценить зрелость поставщиков средств безопасности и используемых ими продуктов.
Предоставить контекст аналитикам путем включения уровней DML в правила Yara, сигнатуры Snort и правила корреляции SIEM.

### Ответьте на вопросы ниже
Прочитайте вышеизложенное.

```commandline
Ответ не нужен
```

## Задание 6
Сценарий: THM стремится создать процесс разработки обнаружения для обнаружения изменений, внесенных в 
привилегированные и административные группы и учетные записи в их Active Directory . Как аналитику обнаружения, вам 
было поручено разработать стратегию на основе набора вопросов. Каждый вопрос имеет один правильный ответ; поэтому 
вам нужно определить и выбрать его. У вас будет три попытки выполнить упражнение, прежде чем оно сбросится.   


Используйте приведенный ниже шаблон инфраструктуры ADS «Необычный хост-процесс Powershell» в качестве руководства по 
требованиям каждого этапа инфраструктуры. 

Ответ	
- Сравните подозрительный хост PowerShell с записями белого списка.
- Проверьте цифровую подпись двоичного файла.
- Определите поведение выполнения двоичного файла.
- Взято из примеров ADS Framework .

Чтобы начать, нажмите View Site.

Удачной охоты!

### Ответьте на вопросы ниже
Что такое флаг?
```commandline
THM{Sup3r-D3t3ct1v3}
```

[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)