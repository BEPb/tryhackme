[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Intro to Log Analysis](https://tryhackme.com/r/room/introtologanalysis) 

Всего 10 заданий:
## Задание 1
Анализ журналов является важным аспектом кибербезопасности и мониторинга систем. На высоком уровне анализ журналов 
изучает и интерпретирует данные событий журналов, сгенерированные различными источниками (устройствами, приложениями 
и системами), для мониторинга показателей и выявления инцидентов безопасности. Он включает сбор, анализ и обработку 
файлов журналов для превращения данных в выполнимые цели. Приняв эффективную стратегию анализа журналов, группы 
безопасности могут более точно реагировать на инциденты безопасности и получать упреждающие сведения о потенциальных 
угрозах.

В этом зале мы рассмотрим концепции, связанные с методологией анализа журналов, эффективными методами ведения 
журналов и распространенными инструментами, помогающими обнаруживать и реагировать. 

Цели обучения
- Изучите передовой опыт анализа журналов.
- Откройте для себя основные инструменты для анализа журналов.
- Получите практический опыт анализа журналов с использованием различных инструментов и технологий.
- Предварительные условия для комнаты

Рекомендуется иметь общее представление о журналах и о том, как они собираются. Предыдущие комнаты в модуле Анализа 
журналов являются отличными примерами для этой темы: 
- Введение в журналы
- Операции журнала

### Ответьте на вопросы ниже
Я готов продолжить!
```commandline
Ответ не нужен
```

## Задание 2
Среди различных источников данных, собираемых и используемых инфраструктурными системами, журналы играют ключевую роль в предоставлении ценной информации о внутренней работе и взаимодействии этих систем в сети. Журнал — это поток упорядоченных по времени сообщений, которые регистрируют происходящие события. Анализ журналов — это процесс осмысления событий, зафиксированных в журналах, для создания четкой картины того, что произошло в инфраструктуре.

#### Что такое журналы?

Журналы — это записанные события или транзакции в системе, устройстве или приложении. В частности, эти события могут 
быть связаны с ошибками приложений, системными сбоями, проверенными действиями пользователей, использованием 
ресурсов, сетевыми подключениями и т. д. Каждая запись журнала содержит соответствующие сведения для 
контекстуализации события, такие как его временная метка (дата и время возникновения), источник (система, 
сгенерировавшая журнал) и дополнительная информация о конкретном событии журнала.

образец.log
Jul 28 17:45:02 10.10.0.4 FW-1: %WARNING% general: Unusual network activity detected from IP 10.10.0.15 to IP 203.0.
113.25. Source Zone: Internal, Destination Zone: External, Application: web-browsing, Action: Alert. 
В приведенном выше примере эта запись журнала означает событие, обнаруженное брандмауэром относительно необычной 
сетевой активности из внутренней системы, что указывает на потенциальную проблему безопасности. Соответствующие поля 
для рассмотрения в этом примере:
- Jul 28 17:45:02- Эта временная метка показывает дату и время события.
- 10.10.0.4- Это относится к IP-адресу системы (источнику), сгенерировавшей журнал.
- %WARNING%- Это указывает на серьезность журнала, в данном случае, Предупреждение . Записям журнала часто 
  присваивается уровень серьезности для категоризации и сообщения об их относительной важности или влиянии. Эти 
  уровни серьезности помогают расставить приоритеты в ответах, расследованиях и действиях на основе критичности 
  событий. Различные системы могут использовать немного разные уровни серьезности, но обычно можно ожидать, что вы 
  найдете следующие возрастающие уровни серьезности: Информационный, Предупреждение, Ошибка и Критический.    
- Action: Alert- В этом случае политика брандмауэра была настроена на уведомление при возникновении такой необычной 
  активности. 
- Остальные поля дают нам конкретную информацию, связанную с зарегистрированным событием. В частности, была 
  обнаружена необычная сетевая активность с IP 10.10.0.15 по IP 203.0.113.25. На основе Source Zoneполя трафик, 
  по-видимому, предназначен для Интернета ( Внешний ), а Приложение было отнесено к категории веб-браузинга.  

#### Почему важны журналы?

Есть несколько причин, по которым сбор журналов и принятие эффективной стратегии анализа журналов жизненно важны для 
текущих операций организации. Некоторые из наиболее распространенных видов деятельности включают: 
- Устранение неполадок системы : анализ системных ошибок и журналов предупреждений помогает ИТ-отделам понимать и быстро реагировать на сбои системы, сводя к минимуму время простоя и повышая общую надежность системы.
- Инциденты кибербезопасности: в контексте безопасности журналы имеют решающее значение для обнаружения и 
  реагирования на инциденты безопасности. Например, журналы брандмауэра , журналы системы обнаружения вторжений (IDS) и журналы аутентификации системы содержат важную информацию о потенциальных угрозах и подозрительных действиях. Выполнение анализа журналов помогает командам SOC и аналитикам безопасности выявлять и быстро реагировать на попытки несанкционированного доступа, вредоносные программы, утечки данных и другие вредоносные действия.
- Threat Hunting: С проактивной стороны, команды по кибербезопасности могут использовать собранные журналы для 
  активного поиска сложных угроз, которые могли обойти традиционные меры безопасности. Аналитики безопасности и охотники за угрозами могут анализировать журналы для поиска необычных шаблонов, аномалий и индикаторов компрометации (IOC), которые могут указывать на присутствие субъекта угрозы.
- Соответствие: организации часто должны вести подробные записи о деятельности своих систем в целях соблюдения 
  нормативных требований и соответствия. Регулярный анализ журналов гарантирует, что организации могут предоставлять точные отчеты и демонстрировать соответствие таким нормативным требованиям, как GDPR, HIPAA или PCI DSS .

#### Типы бревен

Как обсуждалось в комнате Введение в журналы  , различные компоненты в вычислительной среде генерируют различные 
типы журналов, каждый из которых служит определенной цели. Эти типы журналов включают, но не ограничиваются: 
- Журналы приложений: сообщения от определенных приложений, дающие представление об их состоянии, ошибках, предупреждениях и других рабочих данных.
- Журналы аудита: события, действия и изменения, происходящие в системе или приложении, предоставляющие историю 
  действий пользователя и поведения системы.
- Журналы безопасности: события, связанные с безопасностью, такие как входы в систему, изменение разрешений, 
  активность брандмауэра и другие действия, влияющие на безопасность системы.
- Журналы сервера: системные журналы, журналы событий, журналы ошибок и журналы доступа, каждый из которых содержит 
  различную информацию о работе сервера.
- Системные журналы: активность ядра, системные ошибки, последовательности загрузки и состояние оборудования, 
  помогающие диагностировать проблемы системы.
- Сетевые журналы: общение и активность внутри сети, сбор информации о событиях, соединениях и передачах данных.
- Журналы базы данных: действия в системе базы данных, такие как выполненные запросы, действия и обновления.
- Журналы веб-сервера: запросы, обработанные веб-серверами, включая URL-адреса, исходные IP-адреса, типы запросов, 
  коды ответов и многое другое.
- Каждый тип журнала представляет собой уникальную перспективу действий в среде, и анализ этих журналов в контексте 
  друг друга имеет решающее значение для эффективного расследования кибербезопасности и обнаружения угроз.

### Ответьте на вопросы ниже
Я понимаю основы ведения журналов и готов продолжить!
```commandline
Ответ не нужен
```

## Задание 3
Для создания согласованной временной шкалы и проведения эффективных расследований по анализу журналов используются несколько методологий, передовых практик и основных приемов.

Хронология

При проведении анализа журнала создание временной шкалы является основополагающим аспектом понимания последовательности событий в системах, устройствах и приложениях. На высоком уровне временная шкала представляет собой хронологическое представление зарегистрированных событий, упорядоченное по мере их возникновения. Возможность визуализации временной шкалы является мощным инструментом для контекстуализации и понимания событий, произошедших за определенный период.

В сценариях реагирования на инциденты временные шкалы играют решающую роль в реконструкции инцидентов безопасности. С эффективной временной шкалой аналитики безопасности могут отслеживать последовательность событий, приведших к инциденту, что позволяет им определить начальную точку компрометации и понять тактику, методы и процедуры (TTP) злоумышленника.

Временная метка

В большинстве случаев журналы обычно включают временные метки, которые фиксируют, когда произошло событие. С учетом потенциала множества распределенных устройств, приложений и систем, генерирующих отдельные события журнала в различных регионах, крайне важно учитывать часовой пояс и формат каждого журнала. Преобразование временных меток в согласованный часовой пояс необходимо для точного анализа журнала и корреляции между различными источниками журналов.

Многие решения для мониторинга журналов решают эту проблему с помощью обнаружения часовых поясов и автоматической настройки. Например, Splunk автоматически обнаруживает и обрабатывает часовые пояса при индексации и поиске данных. Независимо от того, как указано время в отдельных событиях журнала, временные метки преобразуются во время UNIX и сохраняются в _timeполе при индексации.

Эту согласованную временную метку можно затем преобразовать в местный часовой пояс во время визуализации, что делает отчетность и анализ более эффективными. Эта стратегия гарантирует, что аналитики могут проводить точные расследования и получать ценную информацию из своих данных журнала без ручного вмешательства.

Супер Хронология

Суперхронология, также известная как консолидированная хронология, является мощной концепцией в анализе журналов и цифровой криминалистике. Суперхронология обеспечивает комплексное представление событий в различных системах, устройствах и приложениях, позволяя аналитикам понимать последовательность событий в целом. Это особенно полезно для расследования инцидентов безопасности, затрагивающих несколько компонентов или систем.

Суперхронологии часто включают данные из ранее обсуждавшихся источников журналов, таких как системные журналы, журналы приложений, журналы сетевого трафика, журналы брандмауэра и т. д. Объединяя эти разрозненные источники в одну временную шкалу, аналитики могут выявлять корреляции и закономерности, которые должны быть очевидны при индивидуальном анализе журналов.

Создание консолидированной временной шкалы со всей этой информацией вручную потребовало бы времени и усилий. Вам пришлось бы не только записывать временные метки для каждого файла в системе, но и понимать методы хранения данных каждого приложения. К счастью, Plaso (Python Log2Timeline) — это инструмент с открытым исходным кодом, созданный Кристинн Гудйонссон и многими участниками, который автоматизирует создание временных шкал из различных источников журналов. Он специально разработан для цифровой криминалистики и анализа журналов и может анализировать и обрабатывать данные журналов из широкого спектра источников для создания единой хронологической временной шкалы.

Чтобы узнать больше о Plaso и его возможностях, посетите официальную страницу документации здесь .

Визуализация данных

Инструменты визуализации данных, такие как Kibana (из Elastic Stack) и Splunk, помогают преобразовывать необработанные данные журнала в интерактивные и проницательные визуальные представления через пользовательский интерфейс. Такие инструменты позволяют аналитикам безопасности понимать индексированные данные, визуализируя закономерности и аномалии, часто в графическом виде. Несколько визуализаций, метрик и графических элементов могут быть сконструированы в виде индивидуальной панели мониторинга, что позволяет получить всеобъемлющее представление «единого окна» для операций анализа журнала.

Пример специализированной панели мониторинга Splunk для мониторинга и производительности

Для создания эффективных визуализаций журналов необходимо в первую очередь понять собираемые данные (и источники) и определить четкие цели визуализации.

Например, предположим, что цель состоит в том, чтобы отслеживать и обнаруживать закономерности увеличения количества неудачных попыток входа. В этом случае нам следует попытаться визуализировать журналы, которые проверяют попытки входа с сервера аутентификации или пользовательского устройства. Хорошим решением было бы создание линейной диаграммы, которая отображает тенденцию неудачных попыток входа с течением времени. Чтобы управлять плотностью полученных данных, мы можем отфильтровать визуализацию, чтобы показать последние семь дней. Это даст нам хорошую отправную точку для визуализации увеличения количества неудачных попыток и обнаружения аномалий.

Мониторинг журналов и оповещения

Помимо визуализации, внедрение эффективного мониторинга журналов и оповещений позволяет службам безопасности заблаговременно выявлять угрозы и немедленно реагировать при появлении оповещений.

Многие решения SIEM (например, Splunk и Elastic Stack) позволяют создавать пользовательские оповещения на основе метрик, полученных в событиях журнала. События, для которых стоит создавать оповещения, могут включать в себя множественные неудачные попытки входа, повышение привилегий, доступ к конфиденциальным файлам или другие индикаторы потенциальных нарушений безопасности. Оповещения гарантируют, что службы безопасности будут оперативно уведомлены о подозрительных действиях, требующих немедленного внимания.

Роли и обязанности должны быть определены для процедур эскалации и уведомления на различных этапах процесса реагирования на инциденты. Процедуры эскалации гарантируют, что инциденты будут рассмотрены быстро и что нужный персонал будет проинформирован на каждом уровне серьезности.

Для практического ознакомления с панелями мониторинга и оповещениями в Splunk рекомендуем посетить раздел Splunk : Панели мониторинга и отчеты !

Внешние исследования и разведданные об угрозах

Важно определить, что может представлять для нас интерес в анализе журнала. Сложно анализировать журнал, если мы не совсем уверены в том, что ищем.

Сначала давайте разберемся, что такое разведка угроз. Подводя итог, разведка угроз — это фрагменты информации, которые можно отнести к злоумышленнику. Примеры разведки угроз включают:

IP-адреса
Хэши файлов
Домены
При анализе файла журнала мы можем искать наличие информации об угрозах. Например, возьмем эту запись веб-сервера Apache2 ниже. Мы видим, что IP-адрес пытался получить доступ к панели администратора нашего сайта.

Вывод журнала доступа Apache2
cmnatic@thm cat access.log
54.36.149.64 - - [25/Aug/2023:00:05:36 +0000] "GET /admin HTTP/1.1" 200 8260 "-" "Mozilla/5.0 (compatible; AhrefsBot/7.0; +http://ahrefs.com/robot/)"
191.96.106.80 - - [25/Aug/2023:00:33:11 +0000] "GET /TryHackMe/rooms/docker-rodeo/dockerregistry/catalog1.png HTTP/1.1" 200 19594 "https://tryhackme.com/" "Mozi>
54.36.148.244 - - [25/Aug/2023:00:34:46 +0000] "GET /TryHackMe/?C=D;O=D HTTP/1.1" 200 5879 "-" "Mozilla/5.0 (compatible; AhrefsBot/7.0; +http://ahrefs.com/robot>
66.249.66.68 - - [25/Aug/2023:00:35:53 +0000] "GET /TryHackMe%20Designs/ HTTP/1.1" 200 5973 "-" "Mozilla/5.0 (Linux; Android 6.0.1; Nexus 5X Build/MMB29P) 200 19594 "https://tryhackme.com/" "Mozi>
Используя канал аналитики угроз, такой как ThreatFox , мы можем выполнять поиск в наших файлах журналов на предмет присутствия известных злоумышленников.

Вывод Threatfox, в котором выделены несколько индикаторов компрометации в нашем файле журнала


Использование GREP для поиска IP-адреса в файле журнала
cmnatic@thm grep "54.36.149.64" logfile.txt
54.36.149.64
Ответьте на вопросы ниже
Как называется консолидированное хронологическое представление зарегистрированных событий из различных источников, часто используемое при анализе журналов и цифровой криминалистике?
Super Timeline

### Правильный ответ
Какой показатель разведки об угрозах будет 5b31f93c09ad1d065c0491b764d04933классифицирован 763f8bdbc98d105a8e82f36157e98bbe?

```commandline
File Hashes
```

## Задание 4
Распространенные расположения файлов журнала

Важнейшим аспектом анализа журналов является понимание того, где размещать файлы журналов, созданные различными приложениями и системами. Хотя пути к файлам журналов могут различаться в зависимости от конфигураций системы, версий программного обеспечения и пользовательских настроек, знание общих местоположений файлов журналов необходимо для эффективного расследования и обнаружения угроз.

Хотя это общие пути к файлам журналов, важно отметить, что фактические пути могут отличаться в зависимости от конфигураций системы, версий программного обеспечения и пользовательских настроек. Рекомендуется обратиться к официальной документации или файлам конфигурации, чтобы проверить правильные пути к файлам журналов и обеспечить точный анализ и расследование.

Общие закономерности

В контексте безопасности распознавание общих закономерностей и тенденций в данных журнала имеет решающее значение для выявления потенциальных угроз безопасности. Эти «шаблоны» относятся к идентифицируемым артефактам, оставленным в журналах субъектами угроз или инцидентами кибербезопасности. К счастью, есть некоторые общие закономерности, которые, если их изучить, улучшат ваши возможности обнаружения и позволят вам эффективно реагировать на инциденты.

Ненормальное поведение пользователя

Один из основных шаблонов, который можно определить, связан с необычным или аномальным поведением пользователя. Это относится к любым действиям или деятельности, осуществляемым пользователями, которые отклоняются от их типичного или ожидаемого поведения.

Для эффективного обнаружения аномального поведения пользователей организации могут использовать решения для анализа журналов, включающие механизмы обнаружения и алгоритмы машинного обучения для установления нормальных моделей поведения. Отклонения от этих моделей или базовых показателей затем могут быть оповещены как потенциальные инциденты безопасности. Некоторые примеры таких решений включают Splunk User Behavior Analytics ( UBA ), IBM QRadar UBA и защита личных данных Azure AD .

Конкретные показатели могут существенно различаться в зависимости от источника, но вот некоторые примеры, которые можно найти в файлах журналов:

Несколько неудачных попыток входа в систему
Необычно большое количество неудачных попыток входа в систему за короткий промежуток времени может указывать на атаку методом подбора.
Необычное время входа в систему
События входа в систему, выходящие за рамки обычных часов или схем доступа пользователя, могут быть признаком несанкционированного доступа или взлома учетных записей.
Географические аномалии
События входа в систему с IP-адресов в странах, куда пользователь обычно не заходит, могут указывать на потенциальную компрометацию учетной записи или подозрительную активность.
Кроме того, одновременные входы в систему из разных географических точек (или признаки невозможности перемещения) могут указывать на совместное использование учетных записей или несанкционированный доступ.
Частая смена паролей
События журнала, указывающие на частую смену пароля пользователя за короткий период времени, могут указывать на попытку скрыть несанкционированный доступ или захватить учетную запись.
Необычные строки user-agent
В контексте журналов HTTP- трафика запросы от пользователей с необычными строками user-agent, отличающимися от их типичного браузера, могут указывать на автоматизированные атаки или вредоносную деятельность.
Например, по умолчанию сканер Nmap будет регистрировать пользовательский агент, содержащий "Nmap Scripting Engine". Инструмент для подбора паролей Hydra по умолчанию будет включать "(Hydra)" в свой пользовательский агент. Эти индикаторы могут быть полезны в файлах журналов для обнаружения потенциальной вредоносной активности.
Значимость этих аномалий может существенно различаться в зависимости от конкретного контекста и используемых систем, поэтому крайне важно точно настроить все автоматизированные механизмы обнаружения аномалий, чтобы свести к минимуму ложные срабатывания.

Распространенные сигнатуры атак

Выявление общих сигнатур атак в данных журнала является эффективным способом обнаружения и быстрого реагирования на угрозы. Сигнатуры атак содержат определенные шаблоны или характеристики, оставленные субъектами угроз. Они могут включать в себя вредоносные заражения, веб-атаки ( инъекции SQL , межсайтовый скриптинг, обход каталогов) и многое другое. Поскольку это полностью зависит от поверхности атаки, некоторые примеры высокого уровня включают:

#### SQL- инъекция

SQL -инъекции пытаются использовать уязвимости в веб-приложениях, которые взаимодействуют с базами данных. Ищите необычные или неправильно сформированные SQL- запросы в журналах приложений или баз данных, чтобы определить общие шаблоны атак SQL- инъекций.

Подозрительные запросы SQL могут содержать неожиданные символы, такие как одинарные кавычки ( '), комментарии ( --, #), операторы объединения ( UNION) или атаки на основе времени ( WAITFOR DELAY, SLEEP()). Полезный список полезной нагрузки SQLi для справки можно найти здесь .

В приведенном ниже примере попытка SQL- инъекции может быть идентифицирована по ' UNION SELECTразделу q=параметра запроса. Похоже, что злоумышленник экранировал SQL- запрос с помощью одинарной кавычки и внедрил оператор union select для извлечения информации из usersтаблицы в базе данных. Часто эта полезная нагрузка может быть закодирована в URL, что требует дополнительного этапа обработки для ее эффективной идентификации.

SQLi.log
10.10.61.21 - - [2023-08-02 15:27:42] "GET /products.php?q=books' UNION SELECT null, null, username, password, null FROM users-- HTTP/1.1" 200 3122
Межсайтовый скриптинг ( XSS )

Использование уязвимостей межсайтового скриптинга ( XSS ) позволяет злоумышленникам внедрять вредоносные скрипты в веб-страницы. Чтобы определить распространенные шаблоны атак XSS , часто бывает полезно искать записи журнала с неожиданным или необычным вводом, который включает теги скриптов ( <script>) и обработчики событий ( onmouseover​​, onclick, onerror). Полезный список полезной нагрузки XSS можно найти здесь .

В приведенном ниже примере  попытку межсайтового скриптинга можно идентифицировать по <script>alert(1);</script>полезной нагрузке, вставленной в searchпараметр, что является распространенным методом тестирования на уязвимости XSS .

xss.log
10.10.19.31 - - [2023-08-04 16:12:11] "GET /products.php?search=<script>alert(1);</script> HTTP/1.1" 200 5153
Прохождение пути

Эксплуатация уязвимостей обхода пути позволяет злоумышленникам получать доступ к файлам и каталогам за пределами предполагаемой структуры каталогов веб-приложения, что приводит к несанкционированному доступу к конфиденциальным файлам или коду. Чтобы определить распространенные шаблоны атак обхода, ищите символы последовательности обхода ( ../и ../../) и указания на доступ к конфиденциальным файлам ( /etc/passwd, /etc/shadow). Полезный список полезной нагрузки обхода каталога для справки можно найти здесь .

Важно отметить, как и в приведенных выше примерах, что обходы каталогов часто кодируются URL (или дважды кодируются URL), чтобы избежать обнаружения брандмауэрами или инструментами мониторинга. По этой причине %2Eи %2Fявляются полезными символами URL-кодирования, которые нужно знать, поскольку они относятся к .и /соответственно.

В приведенном ниже примере попытку обхода каталога можно определить по повторяющейся последовательности символов ../, указывающей на то, что злоумышленник пытается «вернуться» из веб-каталога и получить доступ к конфиденциальному /etc/passwdфайлу на сервере.

путь-прохождение.log
10.10.113.45 - - [2023-08-05 18:17:25] "GET /../../../../../etc/passwd HTTP/1.1" 200 505

### Ответьте на вопросы ниже
Какой путь к файлу по умолчанию используется для просмотра журналов HTTP-запросов на сервере Nginx?
```commandline
/var/log/nginx/access.log
```
Была идентифицирована запись в журнале, содержащая %2E%2E%2F%2E%2E%2Fproc%2Fself%2Fenviron. О каком виде атаки это 
может свидетельствовать? 
```commandline
Path Traversal
```

## Задание 5
Автоматизированный анализ

Автоматизированный анализ подразумевает использование инструментов. Например, они часто включают в себя коммерческие инструменты, такие как XPLG или SolarWinds Loggly. Автоматизированные инструменты анализа позволяют обрабатывать и анализировать данные журналов. Эти инструменты часто используют искусственный интеллект/машинное обучение для анализа закономерностей и тенденций. По мере развития ландшафта ИИ мы ожидаем увидеть более эффективные решения для автоматизированного анализа.

Преимущества	Недостатки
Экономит время, выполняя большую часть ручной работы, необходимой при ручном анализе.	Инструменты автоматизированного анализа обычно доступны только на коммерческой основе и, следовательно, дороги.
Использование искусственного интеллекта эффективно для распознавания закономерностей и тенденций.	Эффективность искусственного интеллекта зависит от того, насколько способна модель. Например, увеличивается риск ложных срабатываний или могут быть пропущены новые или никогда ранее не встречавшиеся события, поскольку ИИ не обучен их распознавать.
Ручной анализ

Ручной анализ — это процесс изучения данных и артефактов без использования средств автоматизации. Например, аналитик, прокручивающий журнал веб-сервера, будет считаться ручным анализом. Ручной анализ необходим аналитику, поскольку на средства автоматизации нельзя полагаться.

Преимущества	Недостатки
Это дешево и не требует дорогостоящего инструментария. Например, простые команды Linux могут сделать это.	Это отнимает много времени, поскольку аналитику приходится выполнять всю работу, включая переформатирование файлов журналов.
Позволяет провести тщательное расследование.	Н/Д
Снижает риск переобучения или ложных срабатываний оповещений от автоматизированных инструментов.	События или оповещения могут быть пропущены! Особенно, если нужно просмотреть много данных.
Позволяет проводить контекстный анализ. Аналитик имеет более широкое понимание организации и ландшафта кибербезопасности.	Н/Д
### Ответьте на вопросы ниже
Файл журнала обрабатывается инструментом, который возвращает вывод. Какая это форма анализа?
```commandline
Automated
```
Аналитик открывает файл журнала и ищет события. Какая это форма анализа?
```commandline
Manual
```
## Задание 6
При анализе собранных журналов иногда наиболее доступным инструментом, который у нас есть, является сама командная строка. Анализ журналов через командную строку обеспечивает быстрый и эффективный способ получения информации о системных действиях, устранения неполадок и обнаружения инцидентов безопасности, даже если у нас не настроена система SIEM .

Многие встроенные команды Linux позволяют нам быстро анализировать и фильтровать соответствующую информацию. Просмотр файлов журналов с помощью командной строки — одна из самых простых, но важных задач для проведения анализа журналов. Для этой цели используются несколько распространенных встроенных инструментов, предлагающих различные функции для эффективного чтения и навигации по файлам журналов.

Вы можете найти apache.logфайл на AttackBox ниже, /root/Rooms/introloganalysis/task6чтобы следовать этой задаче. Однако он также прикреплен к этой задаче и доступен для скачивания.

кот

Команда cat(сокращение от "concatenate") — простая утилита, которая считывает один или несколько файлов и отображает их содержимое в терминале. При использовании для файлов журнала она выводит все содержимое журнала на экран.

Например, чтобы просмотреть содержимое файла журнала с именем apache.log, вы можете использовать команду:

пример кота
user@tryhackme$ cat apache.log        
203.0.113.42 - - [31/Jul/2023:12:34:56 +0000] "GET /index.php HTTP/1.1" 200 1234 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36"
120.54.86.23 - - [31/Jul/2023:12:34:57 +0000] "GET /contact.php HTTP/1.1" 404 5678 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36"
185.76.230.45 - - [31/Jul/2023:12:34:58 +0000] "GET /about.php HTTP/1.1" 200 9876 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.164 Safari/537.36"
201.39.104.77 - - [31/Jul/2023:12:34:59 +0000] "GET /login.php HTTP/1.1" 200 4321 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.54 Safari/537.36"
...
...
Из-за большого объема выходных данных это, как правило, не лучший подход для работы с длинными файлами журналов.

меньше

Команда lessявляется улучшением по сравнению catс более крупными файлами. Она позволяет просматривать данные файла постранично, предоставляя более удобный способ чтения длинных журналов. При использовании lessдля открытия файла по умолчанию отображается первая страница, и вы можете прокручивать вниз с помощью клавиш со стрелками или с помощью Page Up и Page Down .

Например, чтобы просмотреть тот же файл журнала с помощью less, используйте команду:

меньше Пример
user@tryhackme$ less apache.log       
...
...
HTTP/1.1" 200 7890 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.350 Safari/5>
P/1.1" 404 4321 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.81 Safari/537.3>
TTP/1.1" 200 1234 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.90 Safari/537>
P/1.1" 200 5678 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.81 Safari/537.3>
TTP/1.1" 404 5678 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.54 Safari/537>
P/1.1" 200 1234 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.85 Safari/537.3>
TP/1.1" 200 5678 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.90 Safari/537.>
~
~
~
~
(END)
Выйти из вывода команды можно с помощью qклавиши.

хвост

Команда tailспециально разработана для просмотра конца файлов и очень полезна для просмотра сводки недавно сгенерированных событий в случае файлов журнала. Наиболее часто используется в tailсочетании с -fопцией , которая позволяет вам «следить» за файлом журнала в реальном времени, поскольку она постоянно обновляет терминал новыми записями журнала по мере их генерации и записи. Это чрезвычайно полезно при мониторинге журналов на предмет живых событий или поведения системы в реальном времени.

По умолчанию tailбудут отображаться только последние десять строк файла. Однако мы можем изменить это с помощью опции -nи указать количество строк, которые мы хотим просмотреть.

Например, если мы хотим распечатать только последние пять строк файла apache.logи «следить» за журналами в режиме реального времени, мы можем использовать команду:

Пример хвоста
user@tryhackme$ tail -f -n 5 apache.log
176.145.201.99 - - [31/Jul/2023:12:34:24 +0000] "GET /login.php HTTP/1.1" 200 1234 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.90 Safari/537.36"
104.76.29.88 - - [31/Jul/2023:12:34:23 +0000] "GET /index.php HTTP/1.1" 200 5678 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.81 Safari/537.36"
128.45.76.66 - - [31/Jul/2023:12:34:22 +0000] "GET /contact.php HTTP/1.1" 404 5678 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.54 Safari/537.36"
76.89.54.221 - - [31/Jul/2023:12:34:21 +0000] "GET /about.php HTTP/1.1" 200 1234 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.85 Safari/537.36"
145.76.33.201 - - [31/Jul/2023:12:34:20 +0000] "GET /login.php HTTP/1.1" 200 5678 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.90 Safari/537.36"
Возможность сортировать, фильтровать и манипулировать файлами журналов из командной строки является важнейшим аспектом эффективного анализа журналов. Аналитикам часто требуется извлекать определенную информацию, отфильтровывать соответствующие данные, агрегировать результаты и преобразовывать журналы для выявления идей и выявления аномалий.

Примечание: Противоположность команды tail— head, которая позволяет просматривать первые десять строк файла по умолчанию и принимает те же аргументы. Не стесняйтесь экспериментировать и с этим!

Туалет

Команда wc(word count) — простая, но мощная утилита, которая может быть весьма полезна для быстрого анализа и сбора статистики. Вывод wcпредоставляет информацию о количестве строк, слов и символов в файле журнала. Это может помочь аналитикам безопасности понять размер и объем данных журнала, с которыми они имеют дело, прежде чем погрузиться в более подробный анализ.

Пример туалета
user@tryhackme$ wc apache.log     
   70  1562 14305 apache.log
После запуска wcмы apache.logможем определить, что файл содержит 70 строк, 1562 отдельных слова (разделенных пробелом) и 14305 отдельных символов.

резать

Команда cutизвлекает определенные столбцы (поля) из файлов на основе указанных разделителей. Это удобная команда для работы с файлами журналов, которые имеют структурированные или разделенные табуляцией данные.

Если мы хотим извлечь все IP-адреса из файла, мы можем использовать команду, cutчтобы указать разделитель символа spaceи выбрать только первое возвращенное поле.

пример вырезать
user@tryhackme$ cut -d ' ' -f 1 apache.log
203.0.113.42
120.54.86.23
185.76.230.45
201.39.104.77
112.76.89.56
211.87.186.35
156.98.34.12
202.176.73.99
122.65.187.55
77.188.103.244
189.76.230.44
153.47.106.221
200.89.134.22
...
...
Приведенная выше команда вернет список всех IP-адресов в файле журнала. Расширяя это, мы можем изменить номер поля на -f 7для извлечения URL-адресов и -f 9для извлечения кодов статуса HTTP .

сортировать

Иногда полезно сортировать возвращаемые записи в хронологическом или алфавитном порядке. sortКоманда упорядочивает данные в файлах в порядке возрастания или убывания на основе определенных критериев. Это может быть важно для выявления закономерностей, тенденций или выбросов в наших данных журнала. Также часто объединяют вывод другой команды (например, cut) и используют его в качестве ввода команды sort с помощью |символа перенаправления конвейера.

Например, чтобы отсортировать список возвращенных IP-адресов из приведенной выше cutкоманды, мы можем выполнить:

Пример сортировки
user@tryhackme$ cut -d ' ' -f 1 apache.log | sort -n
76.89.54.221
76.89.54.221
76.89.54.221
76.89.54.221
76.89.54.221
76.89.54.221
77.188.103.244
99.76.122.65
104.76.29.88
104.76.29.88
104.76.29.88
104.76.29.88
104.76.29.88
104.76.29.88
...
...
В приведенной выше команде мы передали вывод из cutв sortкоманду и добавили -nопцию сортировки по числам . Это изменило вывод, чтобы перечислить IP-адреса в порядке возрастания.

Если мы хотим изменить порядок, мы можем добавить опцию -r:

Пример сортировки (обратный)
user@tryhackme$ cut -d ' ' -f 1 apache.log | sort -n -r
221.90.64.76
211.87.186.35
203.78.122.88
203.64.78.90
203.64.78.90
203.64.78.90
203.64.78.90
203.64.78.90
203.64.78.90
203.0.113.42
202.176.73.99
201.39.104.77
200.89.134.22
...
...
уникальный

Команда uniqопределяет и удаляет смежные дублирующиеся строки из отсортированного ввода. В контексте анализа журнала это может быть полезным инструментом для упрощения списков данных (например, собранных IP-адресов), особенно когда записи журнала могут содержать повторяющуюся или избыточную информацию. Команда uniqчасто сочетается с sortкомандой для сортировки данных перед удалением дублирующихся записей.

Например, вывод команды, sortкоторую мы запустили выше, содержит несколько дублирующих IP-адресов, что легче обнаружить, когда данные отсортированы по номерам. Чтобы удалить эти повторно извлеченные IP-адреса из списка, мы можем запустить:

Пример уникальности
user@tryhackme$ cut -d ' ' -f 1 apache.log | sort -n -r | uniq
221.90.64.76
211.87.186.35
203.78.122.88
203.64.78.90
203.0.113.42
202.176.73.99
201.39.104.77
200.89.134.22
192.168.45.99
...
...
Мы также можем добавить -cопцию для вывода уникальных строк и добавить количество вхождений для каждой строки. Это может быть очень полезно для быстрого определения IP-адресов с необычно высоким трафиком.

Пример uniq (с подсчетом)
user@tryhackme$ cut -d ' ' -f 1 apache.log | sort -n -r | uniq -c
      1 221.90.64.76
      1 211.87.186.35
      1 203.78.122.88
      6 203.64.78.90
      1 203.0.113.42
      1 202.176.73.99
      1 201.39.104.77
      1 200.89.134.22
      1 192.168.45.99
...
...
сед

Оба sedи awkявляются мощными инструментами обработки текста, которые обычно используются для анализа журналов. Иногда они используются взаимозаменяемо, но обе команды имеют свои варианты использования и могут позволить аналитикам безопасности эффективно манипулировать, извлекать и преобразовывать данные журналов.

Используя синтаксис замены, sedможно заменить определенные шаблоны или строки в записях журнала. Например, чтобы заменить все вхождения " 31/Jul/2023 " на " 31 июля 2023 " в apache.logфайле, мы можем использовать:

Пример sed
user@tryhackme$ sed 's/31\/Jul\/2023/July 31, 2023/g' apache.log
203.0.113.42 - - [July 31, 2023:12:34:56 +0000] "GET /index.php HTTP/1.1" 200 1234 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36"
120.54.86.23 - - [July 31, 2023:12:34:57 +0000] "GET /contact.php HTTP/1.1" 404 5678 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36"
...
...
Обратите внимание, что символ обратной косой черты \ требуется для «экранирования» прямой косой черты в нашем шаблоне и сообщает, sedчто прямую косую черту следует рассматривать как буквальный символ. Также обратите внимание, что sedкоманда не изменяет apache.logфайл напрямую; вместо этого она только выводит измененную версию файла на стандартный вывод в командной строке. Если вы хотите перезаписать файл, вы можете добавить опцию -iредактирования файла на месте или использовать оператор перенаправления, >чтобы сохранить вывод в исходном или другом файле.

Внимание: Если вы используете -iопцию с sed, вы рискуете перезаписать исходный файл и потерять ценные данные. Обязательно сохраните резервную копию!

awk

Для awkкоманды, распространенный вариант использования, это условные действия, основанные на определенных значениях полей. Например, чтобы распечатать записи журнала, где код ответа HTTP больше или равен 400(что будет указывать на статусы ошибок HTTP ), мы можем использовать следующую команду:

Пример awk
user@tryhackme$ awk '$9 >= 400' apache.log
120.54.86.23 - - [31/Jul/2023:12:34:57 +0000] "GET /contact.php HTTP/1.1" 404 5678 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36"
156.98.34.12 - - [31/Jul/2023:12:35:02 +0000] "GET /about.php HTTP/1.1" 404 5678 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.85 Safari/537.36"
189.76.230.44 - - [31/Jul/2023:12:35:06 +0000] "GET /about.php HTTP/1.1" 404 1234 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.170 Safari/537.36"
...
...
В этом случае мы используем $9поле (которое в этом примере журнала относится к кодам состояния HTTP ), требуя, чтобы оно было больше или равно 400.

Это лишь малая часть возможностей этих команд, и настоятельно рекомендуется прочитать больше об их возможностях и вариантах использования здесь .

грэп

Команда grepпредставляет собой мощный инструмент текстового поиска, широко используемый в системах UNIX и обеспечивающий исключительные случаи использования в анализе журналов. Она позволяет вам искать определенные шаблоны или регулярные выражения в файлах или потоках текста. Использование grepможет помочь аналитикам быстро идентифицировать соответствующие записи журнала, которые соответствуют определенным критериям, определенным ресурсам или ключевым словам, или шаблонам, связанным с инцидентами безопасности.

Самое простое использование grep— поиск определенных строк в файлах журнала. Например, если у нас есть подозрения относительно любых записей журнала, которые попадают на /admin.phpвеб-страницу на сервере, мы можем grepдля «admin» вернуть любые соответствующие результаты:

Пример grep
user@tryhackme$ grep "admin" apache.log
145.76.33.201 - - [31/Jul/2023:12:34:54 +0000] "GET /admin.php HTTP/1.1" 200 4321 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.330 Safari/537.36"
Как и uniq -cкоманда, мы можем добавить -cопцию для grepподсчета записей, соответствующих критериям поиска. Например, поскольку в приведенной выше команде была возвращена только одна строка, добавление -cвернет "1".

Пример grep (с подсчетом)
user@tryhackme$ grep -c "admin" apache.log
1
Если бы мы хотели узнать, какой номер строки в файле журнала относится к соответствующим записям, мы могли бы добавить опцию, -nкоторая поможет быстро найти определенные события:

Пример grep (номер строки)
user@tryhackme$ grep -n "admin" apache.log                           
37:145.76.33.201 - - [31/Jul/2023:12:34:54 +0000] "GET /admin.php HTTP/1.1" 200 4321 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.330 Safari/537.36"
В этом случае к выходным данным записи журнала добавляется номер строки «37» .

Наконец, мы можем инвертировать нашу команду, используя -vопцию только для выбора строк, которые не содержат указанный шаблон или ключевые слова. Это может быть полезно для быстрой фильтрации нежелательных или нерелевантных строк из файлов журнала. Например, если нас не интересуют никакие записи журнала, попавшие на страницу /index.php, мы можем выполнить следующую команду, чтобы отфильтровать их:

Пример grep (инвертированный)
user@tryhackme$ grep -v "/index.php" apache.log | grep "203.64.78.90"
203.64.78.90 - - [31/Jul/2023:12:35:01 +0000] "GET /about.php HTTP/1.1" 404 4321 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.170 Safari/537.36"
203.64.78.90 - - [31/Jul/2023:12:34:53 +0000] "GET /about.php HTTP/1.1" 200 1234 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.210 Safari/537.36"
203.64.78.90 - - [31/Jul/2023:12:34:46 +0000] "GET /contact.php HTTP/1.1" 200 4321 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.100 Safari/537.36"
203.64.78.90 - - [31/Jul/2023:12:34:32 +0000] "GET /login.php HTTP/1.1" 404 5678 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.330 Safari/537.36"
203.64.78.90 - - [31/Jul/2023:12:34:25 +0000] "GET /about.php HTTP/1.1" 404 4321 "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.81 Safari/537.36"
Обратите внимание, что в приведенной выше команде мы отфильтровали страницу index.phpи передали вывод в другую команду grep, которая извлекла только записи журнала, содержащие IP-адрес 203.64.78.90.

Как и в случае с awkи sed, grepэто чрезвычайно мощный инструмент, который невозможно полностью охватить одной задачей. Настоятельно рекомендуется прочитать больше о нем на официальной странице руководства GNU здесь .

Хотя анализ журнала командной строки предлагает мощные возможности, он может подходить только для некоторых сценариев, особенно при работе с обширными и сложными наборами данных журнала. Специальное решение для анализа журнала, такое как Elastic (ELK) Stack или Splunk , может быть более эффективным и предлагать дополнительные функции анализа и визуализации журнала. Тем не менее, командная строка остается необходимой для быстрых и простых задач анализа журнала.

### Ответьте на вопросы ниже
Используйте cutв apache.logфайле, чтобы вернуть только URL-адреса. Какой флаг возвращается в одной из уникальных записей?
```commandline
c701d43cc5a3acb9b5b04db7f1be94f6
```
Сколько всего ответов HTTP 200 было зарегистрировано в файле apache.log ?
```commandline
52
```
Какой IP-адрес в файле apache.log сгенерировал наибольший трафик?
```commandline
145.76.33.201
```
Какова полная временная метка записи, в которой 110.122.65.76 получил доступ к /login.php ?
```commandline
31/Jul/2023:12:34:40 +0000
```

## Задание 7
Регулярные выражения, сокращенно regex , являются бесценным способом определения шаблонов для поиска, сопоставления и обработки текстовых данных. Шаблоны регулярных выражений создаются с использованием комбинации специальных символов, которые представляют правила сопоставления и поддерживаются во многих языках программирования, текстовых редакторах и программном обеспечении.

В этой комнате не будет подробно рассматриваться использование построения шаблонов регулярных выражений. Однако комната регулярных выражений — это фантастический ресурс для изучения и практики регулярных выражений.

Регулярные выражения широко используются в анализе журналов для извлечения релевантной информации, фильтрации данных, выявления закономерностей и обработки журналов перед их отправкой в ​​централизованную систему SIEM. Можно даже использовать regex с командой grep, так как это чрезвычайно мощный способ поиска закономерностей в файлах журналов.

Регулярные выражения для grep

В качестве простого примера, обратитесь к apache-ex2.logфайлу в ZIP-файле, прикрепленном к этой задаче. Вы можете найти файлы задач на AttackBox в разделе /root/Rooms/introloganalysis/task7. Сначала убедитесь, что unzipфайл запущен unzip regex.zip, а затем cd regex.

Этот файл журнала содержит записи журнала с сайта блога. Сайт структурирован таким образом, что каждая запись блога имеет свой уникальный идентификатор, динамически извлекаемый из базы данных через postпараметр URL. Если нас интересуют только определенные записи блога с идентификатором от 10 до 19, мы можем запустить следующий grepшаблон регулярного выражения в файле журнала:

Пример регулярного выражения grep
```commandline
user@tryhackme$ grep -E 'post=1[0-9]' apache-ex2.log
203.0.113.1 - - [02/Aug/2023:10:15:23 +0000] "GET /blog.php?post=12 HTTP/1.1" 200 - "Mozilla/5.0"
100.22.189.54 - - [03/Aug/2023:12:48:43 +0000] "GET /blog.php?post=14 HTTP/1.1" 200 - "Mozilla/5.0"
34.210.98.12 - - [03/Aug/2023:15:30:56 +0000] "GET /blog.php?post=11 HTTP/1.1" 200 - "Mozilla/5.0"
102.210.76.44 - - [04/Aug/2023:19:26:29 +0000] "GET /blog.php?post=16 HTTP/1.1" 200 - "Mozilla/5.0"
98.88.76.103 - - [05/Aug/2023:17:56:33 +0000] "GET /blog.php?post=13 HTTP/1.1" 200 - "Mozilla/5.0"
76.88.44.90 - - [06/Aug/2023:12:58:22 +0000] "GET /blog.php?post=17 HTTP/1.1" 200 - "Mozilla/5.0"
98.76.102.33 - - [07/Aug/2023:15:24:30 +0000] "GET /blog.php?post=19 HTTP/1.1" 200 - "Mozilla/5.0"
...
...

```
Обратите внимание, что мы добавили -Eопцию, указывающую, что мы ищем по шаблону, а не просто по строке, что позволяет нам использовать regex. Для самого шаблона мы сопоставляем буквальные символы post=. После этого мы включаем число 1, за которым следует динамическая вставка символов 0-9 с помощью [0-9]. Сопоставив это, 1[0-9]мы сопоставим любое двузначное число, начинающееся с «1», например, 10, 11, 12 и далее.

Регулярные выражения для анализа журналов

Регулярные выражения также играют важную роль в разборе журнала, который представляет собой процесс разбиения записей журнала на структурированные компоненты и извлечения из них релевантной информации. Файлы журналов из разных источников могут иметь различные форматы и поля, иногда требуя дополнительной обработки для преобразования необработанных данных журнала в структурированную, полезную информацию.

Кроме того, инженеры могут создавать пользовательские шаблоны регулярных выражений, адаптированные к определенным журналам, чтобы сопоставлять определенные части записи журнала с именованными полями для системы SIEM . В целом, этот процесс значительно упрощает последующий запрос и анализ извлеченных данных.

Рассмотрим следующую необработанную, неструктурированную запись журнала:

Пример записи в журнале
126.47.40.189 - - [28/Jul/2023:15:30:45 +0000] "GET /admin.php HTTP/1.1" 200 1275 "" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.9999.999 Safari/537.36"
С точки зрения безопасности, несколько полей здесь было бы полезно извлечь в SIEM для визуализации. Некоторые из них включают:

IP-адрес
Временная метка
Метод HTTP (например, POST, GET или PUT)
URL-адрес
Пользовательский агент
RegExr — это онлайн-инструмент, помогающий обучать, строить и тестировать шаблоны регулярных выражений. Чтобы следовать, скопируйте приведенную выше запись журнала и вставьте ее в раздел « Текст » инструмента.

Графический интерфейс Regexr.com после вставки неструктурированной записи журнала

В качестве простого примера, если мы хотим извлечь только удаленный IP-адрес из этого журнала, мы можем логически представить структуру IP-адреса. IP-адрес — это первая часть записи журнала, состоящая из четырех октетов, разделенных точками. Мы можем использовать следующий шаблон:

\b([0-9]{1,3}\.){3}[0-9]{1,3}\b

Вставьте этот шаблон в поле « Выражение » в RegExr, и вы увидите, что IP-адрес из журнала успешно извлечен и выделен.

Графический интерфейс Regexr.com после вставки шаблона Regex

Разбивая этот шаблон, он начинается и заканчивается якорем границы слова, \bчтобы гарантировать, что мы сопоставляем полные IP-адреса. Между ними мы определяем следующее:

[0-9]{1,3}- Сопоставляет от одной до трех цифр для соответствия числам от 0 до 999. Хотя октеты адресов IPv4 не могут превышать 255, этот упрощенный шаблон подходит для нашего варианта использования.
\.- Экранирует и сопоставляет буквенный .символ в IP-адресе.
{3}- Указывает, что предыдущая группа захвата ([0-9]{1,3}\.)должна быть повторена три раза.
[0-9]{1,3}- Опять же, это соответствует числам от 0 до 999, завершая четвертый октет IP-адреса.
Пример: Logstash и Grok

Grok — это мощный плагин Logstash, который позволяет вам преобразовывать неструктурированные данные журнала в нечто структурированное и пригодное для поиска. Он обычно используется для любого формата журнала, написанного для чтения людьми, а не для использования компьютером. Он работает, объединяя текстовые шаблоны с синтаксисом шаблона %{SYNTAX:SEMANTIC}. Однако иногда в Logstash отсутствует встроенный шаблон, который нам нужен. В этих случаях мы можем определить пользовательские шаблоны с помощью синтаксиса Oniguruma и воспользоваться регулярными выражениями. Более подробную информацию о Grok и его использовании в Elastic Stack можно найти в документации Elastic здесь .

Мы можем использовать шаблон, который мы создали ранее, чтобы успешно извлечь адреса IPv4 из нашего файла журнала и обработать их в настраиваемом поле перед отправкой в ​​SIEM . В сценарии Elastic Stack мы можем добавить фильтр с помощью Grokплагина в нашем файле конфигурации Logstash , чтобы добиться этого.
```commandline
logstash.conf
input {
  ...
}

filter {
  grok {
    match => { "message" => "(?<ipv4_address>\b([0-9]{1,3}\.){3}[0-9]{1,3}\b)" }
  }
}

output {
  ...
}

```
В конфигурации выше мы используем наш ранее определенный шаблон регулярного выражения для извлечения адресов IPv4 из поля "message" входящих событий журнала. Извлеченные значения будут добавлены под пользовательским именем поля "ipv4_addresses", которое мы определили. Обычно IP-адреса извлекаются автоматически конфигурациями по умолчанию. Но этот простой пример показывает мощь шаблонов регулярных выражений при работе со сложными файлами журналов и требованиями к пользовательским полям.

Комната Logstash и официальная документация Grok — это замечательные ресурсы для дальнейшего изучения входных данных Logstash и конфигураций фильтров!

### Ответьте на вопросы ниже
Как бы вы изменили исходный шаблон grep, приведенный выше, чтобы сопоставить записи блога с идентификатором в диапазоне 22-26?
```commandline
post=2[2-6]
```
Как называется плагин-фильтр, используемый в Logstash для анализа неструктурированных данных журнала?
```commandline
Grok
```

## Задание 8
CyberChef — мощный инструмент в арсенале аналитика. Созданный GCHQ , CyberChef долгое время считался «швейцарским армейским киберножом». Приложение может похвастаться более чем 300 операциями, которые в совокупности составляют рецепт, делающий обработку данных проще простого. Вот некоторые ключевые особенности:

Кодирование и декодирование данных
Алгоритмы шифрования и хеширования
Анализ данных, такой как разбор файлов журналов и извлечение данных
И многое другое!
Эта задача продемонстрирует, как CyberChef может использоваться для разбора файла журнала наряду с использованием рецептов для анализа. Прежде чем начать, давайте познакомимся с интерфейсом CyberChef. Сначала давайте запустим CyberChef в нашем браузере, посетив CyberChef . Обратите внимание, если вы являетесь бесплатным пользователем AttackBox, локальная копия CyberChef установлена ​​и может быть доступна, щелкнув закладку «Offline CyberChef» в Firefox.

Понимание CyberChef

Давайте разберем интерфейс:

Вкладка «Операции» — эта вкладка позволяет нам выбрать, что мы хотим сделать с входными данными.
Рецепт - эта вкладка представляет собой набор операций.
Ввод . На этой вкладке мы вводим данные или источник, которые хотим проанализировать.
Вывод . Эта вкладка представляет собой окончательный вывод ввода после применения операций.
Интерфейс CyberChef по умолчанию

Давайте продемонстрируем CyberChef в использовании. В этом примере я предоставляю входные данные "dHJ5aGFja21l" , что является "tryhackme" в base64. После выбора операции "From Base64" мы можем увидеть вывод "tryhackme" :

Декодированный вывод tryhackme base-64

Обратите внимание: если вы не уверены в кодировке входных данных, вы можете воспользоваться функцией CyberChef «Magic», которая поможет вам определить, что именно представляют собой входные данные и какие операции здесь могут пригодиться.

Волшебная операция CyberChef

Регулярное выражение с CyberChef

Вспомните из этой комнаты, что регулярные выражения — отличный способ поиска и сопоставления данных. В этом примере мы берем файл журнала, который зафиксировал попытки аутентификации SSH , и используем regex для вывода всех IP-адресов, которые пытались пройти аутентификацию.

Кроме того, мы используем шаблон регулярного выражения \b([0-9]{1,3}\.){3}[0-9]{1,3}\bдля поиска значений, являющихся IP-адресами:

Использование регулярных выражений с CyberChef

Выбрав фильтр "Список совпадений" в "Формате вывода" операции, мы можем удалить весь шум из журнала и вывести только IP-адреса. Конечно, это небольшой пример. Файлы журналов часто могут быть длиной в сотни строк.

Загрузка файлов в CyberChef

Файлы и папки можно загружать в CyberChef. Это удобный способ загрузки файлов журналов в CyberChef. Для этого щелкните по полю со стрелкой, указывающей внутрь. Кроме того, в CyberChef есть операторы, которые позволяют распаковывать сжатые файлы, такие как .tar.gz или .zip .





### Ответьте на вопросы ниже
Найдите файл «loganalysis.zip» /root/Rooms/introloganalysis/task8и извлеките его содержимое.
```commandline
Ответ не нужен
```
Загрузите файл журнала с именем "access.log" в CyberChef. Используйте regex для перечисления всех IP-адресов. Какой полный IP-адрес начинается с 212?
```commandline
212.14.17.145
```
Используя тот же файл журнала из вопроса № 2, был сделан запрос, закодированный в base64. Каково декодированное значение?
```commandline
THM{CYBERCHEF_WIZARD}
```
Используя CyberChef, декодируйте файл с именем "encodedflag.txt" и используйте регулярное выражение для извлечения по MAC-адресу. Каково извлеченное значение?
```commandline
08-2E-9A-4B-7F-61
```

## Задание 9
Сигма

Sigma — это очень гибкий инструмент с открытым исходным кодом, который описывает события журнала в структурированном формате. Sigma может использоваться для поиска записей в файлах журнала с использованием сопоставления с образцом. Sigma используется для:

Обнаружение событий в файлах журналов
Создание SIEM- поиска
Определить угрозы
Sigma использует синтаксис YAML для своих правил. Эта задача продемонстрирует использование Sigma для обнаружения событий неудачного входа в SSH. Обратите внимание, что написание правила Sigma выходит за рамки этой комнаты. Однако давайте разберем пример правила Sigma для сценария, указанного выше:

title: Failed SSH Logins
description: Searches sshd logs for failed SSH login attempts
status: experimental
author: CMNatic
logsource: 
    product: linux
    service: sshd

detection:
    selection:
        type: 'sshd'
        a0|contains: 'Failed'
        a1|contains: 'Illegal'
    condition: selection
falsepositives:
    - Users forgetting or mistyping their credentials
level: medium
В этом правиле Сигмы:

Ключ	Ценить	Описание
заголовок	Неудачные входы по SSH	В этом заголовке изложена цель правила Сигмы.
описание	Просматривает журналы sshd на предмет неудачных попыток входа по SSH.
Этот ключ содержит описание, расширяющее заголовок.
статус	экспериментальный	Этот ключ объясняет статус правила. Например, «экспериментальный» означает, что необходимо провести дальнейшее тестирование или усовершенствование.
автор	CMNatic	Человек, написавший правило.
источник журнала	продукт: linux
сервис: sshd	Где можно найти файлы журналов, содержащие нужные нам данные?
обнаружение	sshd
В этом ключе перечислены данные, которые пытается найти правило Sigma.
a0|содержит	a0|содержит: «Не удалось»	В этом случае найдите все записи со статусом «Не пройдено».
a1|содержит	a1|содержит: «Незаконно»	В этом случае найдите все записи со словом «Незаконно».
ложноположительные результаты	Пользователи забывают или неправильно вводят свои учетные данные
Перечислите случаи, когда эта запись может присутствовать, но не обязательно указывает на вредоносное поведение.
Это правило теперь можно использовать в платформах SIEM для идентификации событий в обработанных журналах. Если вы хотите узнать больше о Sigma, я рекомендую вам заглянуть в комнату Sigma  на TryHackMe.

Яра

Yara — еще один инструмент сопоставления шаблонов, который занимает свое место в арсенале аналитика. Yara — это инструмент в формате YAML , который идентифицирует информацию на основе двоичных и текстовых шаблонов (таких как шестнадцатеричные и строковые). Хотя он обычно используется при анализе вредоносных программ, Yara чрезвычайно эффективен при анализе журналов.

Давайте рассмотрим этот пример правила Yara под названием "IPFinder". Это правило YARA использует regex для поиска любых адресов IPV4. Если анализируемый нами файл журнала содержит IP-адрес, YARA пометит его:

rule IPFinder {
    meta:
        author = "CMNatic"
    strings:
        $ip = /([0-9]{1,3}\.){3}[0-9]{1,3}/ wide ascii
 
    condition:
        $ip
}
Давайте рассмотрим ключевые моменты, составляющие это правило Yara:

Ключ	Пример	Описание
правило	IPFinder
Этот ключ дает название правилу.
мета	автор	Этот ключ содержит метаданные. Например, в данном случае это имя автора правила.
струны	$ip = /([0-9]{1,3}\.){3}[0-9]{1,3}/ широкий ascii	Этот ключ содержит значения, которые YARA должна искать. В этом случае она использует REGEX для поиска адресов IPV4.
состояние	$ip	Если переменная $ip обнаружена, то правило должно сработать.
Использование YARA для обнаружения определенного IP-адреса
cmnatic@thm:~$ yara ipfinder.yar apache2.txt
IPFinder apache2
Это правило YARA можно расширить для поиска:

Несколько IP-адресов
IP-адреса на основе диапазона (например, ASN или подсети)
IP-адреса в HEX
Если IP-адрес указан больше определенного количества раз (т.е. вывести предупреждение, если IP-адрес найден пять раз)
И в сочетании с другими правилами. Например, если IP-адрес посещает определенную страницу или выполняет определенное действие
Если вы хотите узнать больше о Yara, посетите комнату  Yara  на TryHackMe.

### Ответьте на вопросы ниже
Какие языки использует Sigma?
```commandline
YAML
```
Какое ключевое слово используется для обозначения «названия» правила Sigma?
```commandline
title
```
Какое ключевое слово используется для обозначения «имени» правила в YARA?
```commandline
rule
```

## Задание 10
В этой комнате мы рассмотрели базовую методологию принятия эффективной стратегии анализа журналов. Мы изучили 
важность сбора данных журналов, общие шаблоны атак и полезные инструменты для процессов расследования и реагирования.

Следующие шаги

Чтобы расширить возможности вашего решения SIEM и централизованного ведения журнала, посетите модули Advanced Splunk 
и Advanced ELK. 

### Ответьте на вопросы ниже
Нажмите и продолжайте обучение!
```commandline
Ответ не нужен
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)