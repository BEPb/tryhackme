[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [ParrotPost: Phishing Analysis](https://tryhackme.com/r/room/parrotpost) 

Всего 9 заданий:
## Задание 1
В этой комнате мы рассмотрим идентификацию и анализ вредоносного фишингового письма с помощью визуального осмотра, распространенных инструментов проверки заголовков и ручной деобфускации. Изучив эти методы, станет легче идентифицировать и реагировать на фишинговые угрозы, которые ежедневно затрагивают организации.

Цели обучения

Узнайте, что такое заголовки электронных писем, и ознакомьтесь с наиболее распространенными заголовками.
Используйте инструменты для проверки и анализа подозрительных писем и вложений.
Научитесь распознавать различные методы обфускации, используемые во вредоносном коде HTML, CSS и JavaScript.
Предварительные условия для комнаты

Прежде чем продолжить эту комнату, рекомендуется иметь некоторый фоновый контекст по фишинговым письмам и их характеристикам. Комната Фишинговые письма в действии является отличной отправной точкой для ознакомления с темой.

### Ответьте на вопросы ниже
Нажмите, чтобы продолжить!
```commandline
Ответ не нужен
```

## Задание 2
Работая аналитиком SOC в Flying-Sec , вы получаете входящий отчет от старшего руководителя Пола Фезерса. Недавно Пол 
получил электронное письмо от ParrotPost , законного инструмента электронной почты компании, в котором его просили 
войти в свою учетную запись, чтобы решить проблему с данными своей учетной записи.

Подозрительное электронное письмо, которое Пол получил в своем почтовом клиенте.

Ваша задача — исследовать электронное письмо и определить, является ли оно законным запросом или попыткой фишинга. 
Файл EML можно получить на AttackBox в разделе /root/Rooms/ParrotPost. Однако он также прикреплен к этой задаче и 
доступен для загрузки.  

### Ответьте на вопросы ниже
Я готов приступить к анализу!
```commandline
Ответ не нужен
```

## Задание 3
Давайте поговорим об анализе файлов электронной почты. Электронные письма состоят из нескольких компонентов, включая заголовок, тело и, если применимо, любые вложения. Стандарт, которому обычно следуют электронные письма, определен Инженерной группой Интернета ( IETF ) , в частности в RFC 5322 , который определяет синтаксис и семантику сообщений электронной почты, и в серии RFC 2045-2049 , которая определяет стандарт многоцелевых расширений электронной почты ( MIME ) для сообщений электронной почты в Интернете.

Заголовки электронных писем

Заголовки писем — это отличное место для начала ручного расследования подозрительного письма. Заголовки писем содержат важные метаданные и информацию, такую ​​как адреса электронной почты отправителя и получателя, дату и время отправки письма и путь, который сообщение прошло, чтобы достичь своего предполагаемого адресата. Исследование заголовков писем может дать ценную информацию об источнике письма и потенциальных проблемах безопасности.

Просмотр заголовков электронной почты

Процесс просмотра заголовков писем может различаться в зависимости от используемого вами почтового клиента или сервиса. Иногда в контекстном меню или меню просмотра конкретного письма будет возможность просмотреть заголовки напрямую или загрузить исходное сообщение в виде файла. В нашем случае у нас уже есть копия письма, полученного Полом в .emlформате. .emlФормат файла — обычный текст, то есть его можно читать и редактировать с помощью базового текстового редактора, например, Notepad, TextEdit или Sublime Text.

Чтобы исследовать это письмо более подробно, откройте его URGENTParrotPostAccountUpdateRequired.emlв Sublime Text. Вы можете скопировать содержимое файла и вставить его в инструмент анализа заголовков писем, например MXToolbox или Message Header Analyzer . Эти клиентские веб-инструменты обеспечивают более графическое представление заголовков писем.

Распространенные заголовки электронных писем

Вероятно, вы привыкли видеть несколько стандартных заголовков электронных писем, поскольку большинство почтовых клиентов (таких как Gmail, Outlook, Yahoo и другие) отображают эти заголовки по умолчанию:

Тема — содержит тему или краткое изложение содержания электронного письма.
От — идентифицирует отправителя сообщения электронной почты (его можно легко подделать!)
Кому — определяет основного получателя(ей) электронного письма.
Дата — указывает дату и время отправки сообщения электронной почты.
Ниже визуально определите, где эти заголовки отображаются в почтовом клиенте Пола, как это видно из приложения Outlook в Интернете (OWA).

Помеченная диаграмма, сопоставляющая компоненты снимка экрана электронного письма с общими заголовками, обнаруженными в почтовом клиенте OWA.

Большинство заголовков электронных писем не будут видны напрямую из почтового клиента, поэтому для просмотра полной информации заголовка электронного письма нам понадобится текстовый редактор.

Также важно понимать, что любая строка в письме может быть подделана или спуфингирована. Однако есть некоторые заголовки, которым вы можете доверять больше, чем другим при проведении анализа. Например, заголовки «Получено» добавляются каждым почтовым сервером, который обрабатывает письмо, и они могут предоставить запись пути письма от источника до места назначения.

Определение источника

Поскольку заголовки электронной почты так легко подделываются, может быть сложно определить отправителя или источник электронной почты. Как упоминалось ранее, заголовки «Получено» добавляются почтовыми серверами, чтобы показать путь, который прошло электронное письмо. IP-адрес отправителя обычно указывается в первом заголовке «Получено» (обратите внимание на дату/время!).

Получен заголовок сообщения электронной почты Пола, указывающий на IP-адрес 109.205.120.0

После того, как вы определили исходный IP-адрес, вы можете использовать инструмент поиска IP, чтобы узнать больше информации об отправителе, например, его ISP (Internet Service Provider) или географическое местоположение его IP-адреса. Несколько бесплатных инструментов доступны онлайн, например, iplocation.io и iplocation.net .

Пользовательские заголовки электронных писем

Заголовки электронных писем, начинающиеся с «X-», являются пользовательскими заголовками, которые может добавить отправитель. Префикс «X-» обычно используется для обозначения того, что заголовок не является официальным или стандартизированным заголовком, определенным IETF . Эти пользовательские заголовки часто предоставляют дополнительную информацию или метаданные об электронной почте, например, пометку электронной почты для фильтрации или сортировки спама или добавление информации, специфичной для конкретной организации или системы.

### Ответьте на вопросы ниже
Согласно IP-адресу, с какой страной связан сервер, отправляющий почту?

```commandline
Latvia
```
Если Пол ответит на это письмо, на какой адрес электронной почты будет отправлен его ответ?

```commandline
no-reply@postparr0t.thm
```
Какова ценность пользовательского заголовка в электронном письме?
```commandline
THM{y0u_f0und_7h3_h34d3r}
```

## Задание 4
Как мы обнаружили, просмотрев .emlфайл в текстовом редакторе, электронное письмо, полученное Полом, содержит встроенное вложение с именем «ParrotPostACTIONREQUIRED.htm».  Исходя из этого типа файла и указанного Content-Type , это файл HTML (язык гипертекстовой разметки), используемый для создания веб-страницы или документа, которые можно просматривать в веб-браузере.

Вывод Sublime Text, указывающий, что имя файла этого вложения установлено на ParrotPostACTIONREQUIRED.html с типом содержимого text/html

Некоторые фильтры электронной почты или системы безопасности могут быть настроены на блокировку или карантин определенных типов файлов, таких как файлы HTML. Используя альтернативы, такие как расширения файлов HTM или SHTM вместо HTML, злоумышленники могут обойти эти фильтры и увеличить шансы того, что их электронное письмо достигнет предполагаемого получателя. Файл .htmявляется наиболее распространенной альтернативой HTML и аналогичным образом используется для представления веб-страниц, написанных в коде HTML.

Вы можете подумать, что получение HTML-документа, прикрепленного к электронному письму, изначально подозрительно. Хотя это и нечасто, существуют веские причины, по которым легитимный сервис может это делать, например, включение интерактивных форм или динамического контента. Например, защищенные почтовые платформы (например, Cisco Secure Email Encryption Service ) также могут прикреплять HTML-документы для улучшения пользовательского опыта с помощью расширенных функций, таких как шифрование и аутентификация.

Кодирование передачи контента

В разделе метаданных вложения файла .eml "Content-Transfer-Encoding" — это заголовок, который указывает, как кодируется содержимое вложения. Base64 кодирует двоичные данные (например, изображения, аудиофайлы или другой контент) в символы ASCII, которые можно отправлять по электронной почте или другим текстовым каналам.

Вы заметите большой раздел текста, закодированного в base64, в конце файла .eml. Это закодированное содержимое встроенного файла HTM, которое мы можем извлечь и вручную декодировать, но обычно вложения можно извлечь с помощью любого современного почтового клиента.

Вложение было извлечено и отделено от письма, чтобы упростить эту задачу. Вы можете найти этот файл .htm на AttackBox в разделе /root/Rooms/ParrotPostили загрузить ParrotPostACTIONREQUIRED.htmфайл, нажав на Download Task Files в верхней части этой задачи.

Анализ файла

Поскольку ParrotPostACTIONREQUIRED.htm — это текстовый файл, мы также можем открыть его в Sublime Text. Сделав это, мы раскрываем разметку этой веб-страницы, которая, по-видимому, является еще одной стеной закодированного текста!

Совет: включите функцию переноса слов в Sublime Text в разделе Вид > Перенос слов.

Код SublimeText, демонстрирующий, что прикрепленный файл HTM закодирован в формате base64.

Создатель этого файла использует кодировку, чтобы скрыть истинную природу веб-страницы. Между этим и подозрительным расширением файла, первоначальный отправитель может иметь коварные намерения и активно пытается избежать обнаружения.

Этот HTML-документ объявляет переменную с именем b64, которая установлена ​​в другую длинную строку, по-видимому, закодированных данных. Помимо говорящего имени переменной, данные в кодировке base64 обычно включают символы AZ, az, 0-9, +, / и символы заполнения (=). Если вы видите эти символы в строке текста, есть большая вероятность, что он может быть закодирован в base64.

атоб()

После объявления закодированной строки браузер выполнит следующую строку JavaScript:

document.write(unescape(atob(b64)));

Чтобы разбить эту вложенную функцию:

Это atob()встроенная функция JavaScript для декодирования строки в кодировке base64. Эта функция передает переменную b64, которая была ранее объявлена ​​как ее входные данные.
Функция unescape() преобразует все экранированные символы в декодированной строке в их исходную форму. Это необходимо, поскольку строки в кодировке base64 могут содержать специальные символы, которые должны быть соответствующим образом отформатированы перед отображением на веб-странице.
Функция document.write()отображает декодированную и неэкранированную строку на веб-странице, где выполняется код.
Закодированная переменная, вероятно, содержит фактический контент веб-сайта, отображаемый во время выполнения. Из-за этого нам нужно будет пойти еще на один уровень глубже и декодировать переменную, чтобы узнать, из чего состоит эта веб-страница.

Декодирование Base64

Существует много способов декодирования данных base64, и очень распространенным методом является использование CyberChef, мощного веб-приложения, предоставляющего инструменты для кодирования, декодирования, анализа и обработки данных в различных форматах. Его можно найти предустановленным на AttackBox (перейдите по адресу http://localhost:7777), или его можно найти в Интернете здесь: https://gchq.github.io/CyberChef/

Чтобы раскрыть содержимое переменной b64, скопируйте всю строку base64 (все между открывающими и закрывающими кавычками) и вставьте ее в поле ввода CyberChef. Оттуда мы можем выбрать операцию From Base64 в левой части страницы и перетащить ее в панель рецепта .

Панель управления CyberChef, декодирование строки из файла вложения HTM с помощью base64.

Если все прошло успешно, вы должны увидеть декодированные данные под панелью Output . Скопируйте весь этот вывод и сохраните его как новый HTML-файл с именем "decoded_webpage.html".

### Ответьте на вопросы ниже
Какая схема кодирования используется для сокрытия содержимого веб-страницы?
```commandline
base64
```
Какая встроенная функция JavaScript используется для декодирования веб-страницы перед ее записью на страницу?
```commandline
atob()
```
Каково значение оставшегося комментария, закодированного в base64, после первоначального декодирования base64?
```commandline
THM{d0ubl3_3nc0d3d}
```

## Задание 5
Декодирование HTML-сущностей

Анализ нашего файла "decoded_webpage.html" немного пугает, поскольку этот файл не предназначен для чтения человеком. Это связано с тем, что он был сжат в минимизированную форму, что означает, что все ненужные символы, такие как пробелы, переносы строк и некоторые комментарии, были удалены для уменьшения размера файла. Минимизированный код часто используется в веб-разработке для сокращения времени загрузки веб-страниц, поскольку файлы меньшего размера могут загружаться быстрее. Однако это может сделать код более сложным для чтения и понимания для людей.

Мы поработаем над тем, чтобы сделать код более читабельным для человека в ближайшее время, но сначала, похоже, в HTML все еще есть некоторая кодировка. Если вы найдете тег <h1>, вы заметите длинную строку, казалось бы, случайных символов, за которыми следуют точки с запятой. Пример:<h1>&#80;&#97;&#114;&#114;&#111;&#116;

Это известно как HTML Entity Encoding  и является еще одним трюком, который использует автор этого файла, чтобы сбить нас с толку. HTML Entity — это специальные последовательности символов, используемые для представления зарезервированных символов и других специальных символов в HTML. К счастью, CyberChef может справиться с процессом декодирования символов HTML Entity.

Скопируйте все от открывающего <h1>тега до закрывающего </form>тега и вставьте в поле ввода CyberChef. Оттуда найдите "HTML Entity" в строке поиска Operations и перетащите From HTML Entity в панель Recipe .

Панель управления CyberChef, HTML-сущность, декодирующая строку из вложенного файла HTM.

Совет: не забудьте нажать «Очистить рецепт» (значок мусорной корзины) перед этим шагом, чтобы не пытаться снова декодировать base64!

Отлично! Теперь мы можем скопировать содержимое Output и вставить его в файл "decoded_webpage.html" вместо всех символов HTML Entity, которые мы изначально скопировали. Это также отличное время для добавления разрывов строк, чтобы прояснить, что мы декодировали. Ваш файл должен выглядеть примерно так:

SublimeText, показывающий текущее состояние HTML-файла после выполнения вышеуказанных действий.

Пока неясно, но теперь мы можем различить элементы HTML. Если присмотреться, то это страница входа. Некоторые элементы ввода запрашивают у пользователя адрес электронной почты и пароль, а также кнопку отправки входа.

### Ответьте на вопросы ниже
Какой текст находится внутри тега <h1> после декодирования символов HTML Entity?
```commandline
ParrotPost Secure Webmail Login
```
## Задание 6
CSS (каскадные таблицы стилей) — это веб-язык, используемый для объявления визуального дизайна веб-страницы, написанной на HTML. CSS позволяет веб-разработчикам отделить представление документа от его содержимого, что упрощает создание и поддержку визуально привлекательных веб-страниц. CSS также можно встраивать непосредственно в существующий HTML-документ с помощью элемента <style>.

В нашем файле таблица стилей CSS занимает большую часть в начале документа и содержится в открывающих <style>и закрывающих </style>тегах. CSS также прошел через Minifier для удаления ненужных пробелов, комментариев и других символов, которые не нужны браузеру для правильной интерпретации и отображения стилей. Если бы мы хотели лучше понять таблицу стилей, мы могли бы скопировать и вставить ее в инструмент CSS Beautify , чтобы сделать ее более читабельной. CyberChef может выполнять операции CSS Beautify и CSS Minify. Однако еще один хороший пример — https://www.cleancss.com/css-beautify/ .

Графическая диаграмма, отображающая разницу между CSS до и после модификации.

Таблица стилей была пропущена через инструмент CSS Obfuscator . Как и минимизатор, CSS obfuscator преобразует CSS-код, чтобы сделать его трудным для чтения и понимания, не влияя на его функциональность. Обычно он используется для защиты интеллектуальной собственности кода, затрудняя его копирование, изменение или обратную разработку другими лицами.

Часто в случае фишинга и веб-страниц захвата учетных данных злоумышленники напрямую копируют таблицы стилей CSS с известных доверенных веб-сайтов (например, страницы входа Google или Microsoft). Запутывая скопированные таблицы стилей, антивирусным системам и агентам песочницы становится сложнее обнаружить украденную таблицу стилей.

Этот раздел был рассмотрен для полноты. Однако мы можем эффективно игнорировать все, что находится перед закрывающим </style>тегом, и добавить несколько переносов строк, чтобы визуально разделить вещи.

### Ответьте на вопросы ниже
Что является обратной стороной CSS Minify?
```commandline
CSS Beautify
```

## Задание 7
Пока что мы обнаружили, что прикрепленный файл .htm отображает форму входа HTML, а встроенная таблица стилей используется для определения дизайна веб-страницы. Однако куда форма входа отправляет свои захваченные данные? И что происходит после того, как мы отправляем учетные данные? Чтобы найти эти ответы, мы должны посмотреть на последнюю часть этого файла внутри тега <script>.

JavaScript часто используется в формах входа для выполнения асинхронной проверки формы на стороне клиента и отправки учетных данных пользователя на сервер для аутентификации. В качестве темы, работающей с этим файлом, есть некоторые препятствия, которые нам нужно преодолеть, чтобы сделать его читаемым.

JavaScript Украшение

Этот код JavaScript был минимизирован, удалены все ненужные символы и пробелы. К счастью, мы можем «украсить» этот код, скопировав все между открывающим <script>и закрывающим </script>тегами, вставив его во входные данные Beautifier.io и нажав Beautify Code . В качестве альтернативы мы можем использовать операцию CyberChef «JavaScript Beautify» для достижения того же результата.

Веб-страница Beautifier.io, показывающая результат после улучшения раздела JavaScript.

Нажмите, чтобы увеличить изображение.

Затем мы можем скопировать и заменить вывод в нашем файле исходным кодом JavaScript, который мы скопировали. Теперь, когда у нас есть читаемый код, автор случайно оставил несколько подробных комментариев, которые помогают нам понять, что делает каждое выражение. Используйте это и некоторые внешние исследования JavaScript, чтобы ответить на вопросы ниже.

### Ответьте на вопросы ниже
Какой URL-адрес получает запрос на вход при отправке формы входа?
```commandline
http://evilparrot.thm:8080/cred-capture.php
```
Какое свойство JavaScript может перенаправить браузер на новый URL?

```commandline
window.location.href
```

## Задание 8
В ходе нашего расследования мы вручную расшифровали и вывели истинную природу этой веб-страницы. Подводя итог, можно сказать, что это страница входа, которая выдает себя за законный веб-сайт ParrotPost для сбора учетных данных пользователя в вредоносных целях. Код JavaScript прослушивает событие отправки формы входа и отправляет запрос HTTP GET на другой URL-адрес, который явно не является фактической конечной точкой входа ParrotPost.

Взрывая форму

Взаимодействие с этой вредоносной веб-страницей — это не то, что вы обычно хотите делать (если только вы не находитесь в контролируемой среде-песочнице), но давайте продемонстрируем, что происходит, когда жертва попадает на этот фишинговый сайт! Это поможет нам изучить поведение документа и его потенциальное влияние на реальную систему (и жертву) без фактического заражения или нанесения вреда каким-либо системам.

Сначала нажмите Start Machine в верхней части этой задачи. Это откроет виртуальную машину в окне браузера с разделенным экраном. Если виртуальная машина не видна, нажмите синюю кнопку Show Split View в правом верхнем углу страницы. После того, как вы окажетесь на рабочем столе, откройте исходный ParrotPostACTIONREQUIRED.htmдокумент в веб-браузере виртуальной машины (щелкните правой кнопкой мыши и выберите Open With Firefox Web Browser ).

Рабочий стол подключенной виртуальной машины с выделенной опцией контекстного меню «Открыть с помощью Firefox».

Примечание: для этой задачи убедитесь, что вы используете виртуальную машину , подключенную к этой задаче, а не AttackBox.

В вашем браузере откроется следующая HTML-страница:

Отображение фишинговой веб-страницы в браузере.

Как и предполагалось, это страница входа в систему для захвата учетных данных, и, похоже, адрес электронной почты Пола уже был заполнен в поле Email . Это распространенная тактика знакомства, чтобы заставить жертву думать, что сайт запомнил или кэшировал ее имя пользователя, помогая создать доверие. Это также показывает, что это, вероятно, целевая фишинговая кампания, и поскольку Пол является старшим руководителем, это может быть атакой Whaling .

Давайте изменим значение полей Email и Password , чтобы они представляли поддельные учетные данные, поскольку это, вероятно, будет зарегистрировано на сервере злоумышленника. Затем нажмите Login .

Сообщение об ошибке на отрисованной фишинговой веб-странице после ввода поддельных учетных данных и нажатия кнопки «Войти».

После отправки наших фальшивых учетных данных веб-сайт возвращает сообщение об ошибке, утверждающее, что произошла ошибка при обработке нашего запроса на вход. Однако это может быть не так; это может быть «поддельное» сообщение об ошибке, которое злоумышленники используют, чтобы ослабить подозрения, тогда как на самом деле наш запрос, содержащий учетные данные, прошел в фоновом режиме (благодаря красоте асинхронного JavaScript).

Проверьте сетевые запросы

Проверяя вкладку Сеть в Инструментах разработчика браузера , мы можем быстро определить, отправила ли форма успешный запрос HTTP GET. Чтобы открыть меню Инструментов разработчика, щелкните правой кнопкой мыши на странице и выберите Проверить . После того, как вкладка открыта, щелкните вкладку Сеть .

Вкладка «Сеть» браузера, на которой не отображается ни одного запроса.

Отсюда нам нужно только нажать кнопку «Войти» , чтобы снова отправить форму. Вы должны внезапно увидеть запрос GET!

Вкладка «Сеть» браузера, на которой показан запрос GET к evilparrot.thm

Наш браузер успешно установил соединение с evilparrot.thm веб-сервером и включил наши учетные данные в качестве параметров запроса в запрос GET к /cred-capture.php.

Нажатие на указанный запрос даст нам больше подробностей на правой панели. Мы можем перемещаться между различными вкладками для просмотра информации, такой как заголовки запроса и ответа. Вкладка Response покажет любое содержимое ответа, такое как тело ответа HTML, JSON или XML . Иногда это может дать нам больше информации о том, как веб-сервер обрабатывает запрос, в зависимости от того, насколько подробным разработан код на стороне сервера.

Панель сведений о сетевом запросе, указывающая, что учетные данные пользователя были отправлены на веб-сервер в качестве параметров URL.

Поиграйтесь, протестировав запрос и проанализировав ответ. Вы можете найти интересную информацию, которая поможет ответить на вопросы ниже.

### Ответьте на вопросы ниже
Какой флаг вы получаете после отправки поддельных учетных данных на конечную точку /cred-capture.php?
```commandline
THM{c4p7ur3d_y0ur_cr3d5}
```
Каков путь на веб-сервере, где размещен журнал перехваченных учетных данных?
```commandline
/creds.txt
```
Судя по журналу, какой пароль у Криса Смита?
```commandline
FlyL1ke!A~Bird
```

## Задание 9
Теперь вы должны лучше понимать, как идентифицировать и анализировать фишинговые атаки, которые пытаются украсть 
учетные данные пользователя. Вы научились использовать различные инструменты для проверки и анализа подозрительных 
писем и вложений, а также распознавать и декодировать различные методы обфускации, используемые во вредоносном коде 
HTML, CSS и JavaScript.

Помните, анализ на этом не заканчивается; всегда полезно сообщать о вредоносных доменах и IP-адресах, чтобы защитить 
себя и других от будущих атак. Регистраторы доменов обычно имеют контактную информацию о злоупотреблениях 
регистратора, которую можно найти, выполнив поиск WhoIs вредоносного домена. О вредоносных IP-адресах можно сообщить 
через соответствующего поставщика услуг Интернета (ISP) или хостинг-провайдера.    

### Ответьте на вопросы ниже
Прохождение завершено!
```commandline
Ответ не нужен
```

[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)