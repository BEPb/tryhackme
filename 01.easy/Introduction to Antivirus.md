[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Introduction to Antivirus](https://tryhackme.com/r/room/introtoav) 

Всего 8 заданий:
## Задание 1
Добро пожаловать на Введение в AV

Антивирусное ( AV ) программное обеспечение является одним из основных решений безопасности на основе хоста, 
доступных для обнаружения и предотвращения атак вредоносного ПО на компьютере конечного пользователя .  AV- 
программное обеспечение состоит из различных модулей, функций и методов обнаружения, которые обсуждаются в этой 
комнате.   

Как red teamer или pentester, важно знать и понимать, как работает AV -ПО  и его методы обнаружения  . Как только 
эти знания будут получены, будет легче работать над методами обхода AV.

### Цели обучения
- Что такое антивирусное программное обеспечение?
- Подходы к обнаружению антивирусов
- Перечислить установленное антивирусное программное обеспечение на целевой машине
- Тест в имитируемой среде

Требования к помещению

Общие сведения о решениях по обнаружению на базе хоста; для получения дополнительной информации посетите раздел « Описание местности» .
Общий опыт хеширования криптовалют;  для получения дополнительной информации посетите раздел «Хеширование — криптография 101» .
Базовые знания правил Yara; для получения дополнительной информации посетите комнату THM Yara .

### Ответьте на вопросы ниже
Давайте начнем!
```commandline
Ответ не нужен
```

## Задание 2
Что такое антивирусное программное обеспечение ?

Антивирусное ( AV ) программное обеспечение представляет собой дополнительный уровень безопасности, целью которого 
является обнаружение и предотвращение выполнения и распространения вредоносных файлов в целевой операционной системе. 

Это хост-приложение, которое работает в режиме реального времени (в фоновом режиме) для мониторинга и проверки 
текущих и новых загруженных файлов. Программное обеспечение AV проверяет и решает, являются ли файлы вредоносными, 
используя различные методы, которые будут рассмотрены далее в этой комнате.  

Интересно, что первое антивирусное программное обеспечение было разработано исключительно для обнаружения и удаления 
компьютерных вирусов . В настоящее время это изменилось; современные антивирусные приложения могут обнаруживать и 
удалять компьютерные вирусы, а также другие вредоносные файлы и угрозы.  

Что ищет антивирусное программное обеспечение?

Традиционное антивирусное ПО ищет  вредоносное ПО  с предопределенными вредоносными шаблонами или сигнатурами. 
Вредоносное ПО — это вредоносное ПО, чья основная цель — нанести ущерб целевой машине, включая, но не ограничиваясь: 
- Получите полный доступ к целевой машине.
- Кража конфиденциальной информации, например паролей.
- Шифровать файлы и вызывать их повреждение.
- Внедрение другого вредоносного ПО или нежелательной рекламы.
- Использовать взломанную машину для проведения дальнейших атак, таких как атаки с использованием ботнетов.

#### AV против других продуктов безопасности

В дополнение к программному обеспечению AV, другие решения безопасности на основе хоста обеспечивают защиту конечных 
устройств в реальном времени. Endpoint Detection and Response ( EDR ) — это решение безопасности, которое 
обеспечивает защиту в реальном времени на основе поведенческой аналитики. Антивирусное приложение выполняет 
сканирование, обнаружение и удаление вредоносных файлов. С другой стороны, EDR отслеживает различные проверки 
безопасности на целевой машине, включая файловую активность, память, сетевые подключения, реестр Windows, процессы и 
т. д.     

Современные антивирусные продукты внедряются для интеграции традиционных антивирусных функций и других расширенных 
функций (аналогичных функциям EDR) в один продукт для обеспечения комплексной защиты от цифровых угроз.  Для 
получения дополнительной информации о решениях безопасности на основе хоста мы предлагаем посетить комнату THM :  
The Lay of the Land .   

Программное обеспечение AV в прошлом и настоящем

McAfee Associates, Inc. начала первую реализацию антивирусного программного обеспечения в 1987 году. Оно называлось 
«VirusScan», и его главной целью в то время было удаление вируса под названием «Brain», который заразил компьютер 
Джона Макафи.  Позже к борьбе с вирусами присоединились и другие компании. Антивирусное программное обеспечение 
называлось сканерами, и это было программное обеспечение командной строки, которое искало вредоносные шаблоны в 
файлах.    

С тех пор все изменилось. В настоящее время антивирусное программное обеспечение использует графический 
пользовательский интерфейс (GUI) для сканирования вредоносных файлов и выполнения других задач. Вредоносные 
программы также расширили сферу применения и теперь нацелены на жертв на Windows и других операционных системах.  
Современное антивирусное программное обеспечение поддерживает большинство устройств и платформ, включая Windows, 
Linux , macOS, Android и iOS. Современное антивирусное программное обеспечение улучшилось и стало  более 
интеллектуальным и сложным, поскольку оно включает в себя набор универсальных функций , включая антивирус, 
анти-эксплойт, брандмауэр , инструмент шифрования и т. д.      

В следующем задании мы обсудим некоторые функции AV .

### Ответьте на вопросы ниже
Что означает АВ?
```commandline
Antivirus
```
Какой производитель антивирусов для ПК первым выпустил на рынок антивирусное программное обеспечение?
```commandline
McAfee
```
Антивирусное программное обеспечение — это решение безопасности на основе _____.
```commandline
Host
```

## Задание 3
Антивирусные движки

AV-движок отвечает за поиск и удаление вредоносного кода и файлов. Хорошее AV-программное обеспечение реализует эффективное и надежное AV-ядро, которое точно и быстро анализирует  вредоносные файлы . Кроме того, оно должно обрабатывать и поддерживать различные типы файлов, включая архивные файлы, где оно может самоизвлекаться и проверять все сжатые файлы.

Большинство AV -продуктов имеют одни и те же общие характеристики, но реализованы по-разному, включая, помимо прочего:

Сканер
Методы обнаружения
Компрессоры и архивы
Распаковщики
Эмуляторы
Сканер

Функция сканирования включена в большинство продуктов AV: программное обеспечение AV запускается и сканирует в режиме реального времени или по требованию. Эта функция доступна в графическом интерфейсе или через командную строку. Пользователь может использовать ее в любое время для проверки файлов или каталогов. Функция сканирования должна поддерживать наиболее известные типы вредоносных файлов для обнаружения и удаления угрозы. Кроме того, она также может поддерживать другие типы сканирования в зависимости от программного обеспечения AV , включая уязвимости, электронную почту, память Windows и реестр Windows.

Методы обнаружения

Метод обнаружения антивирусных программ ищет и обнаруживает вредоносные файлы; в рамках антивирусного движка могут использоваться различные методы обнаружения, в том числе:

Обнаружение на основе сигнатур — это традиционный метод антивирусной защиты , который ищет предопределенные вредоносные шаблоны и сигнатуры в файлах.
Эвристическое обнаружение — более продвинутая технология, включающая различные поведенческие методы анализа подозрительных файлов.
Динамическое обнаружение — это метод, включающий мониторинг системных вызовов и API, а также тестирование и анализ в изолированной среде.
Мы рассмотрим эти методы в следующей задаче. Хороший антивирусный движок точен и быстро обнаруживает вредоносные файлы с меньшим количеством ложноположительных результатов. Мы продемонстрируем несколько антивирусных продуктов, которые предоставляют неточные результаты и неправильно классифицируют файл.

Компрессоры и архивы

Функция «Компрессоры и архивы» должна быть включена в любое антивирусное программное обеспечение. Оно должно поддерживать и иметь возможность работать с различными типами системных файлов, включая сжатые или архивированные файлы: ZIP, TGZ, 7z, XAR, RAR и т. д. Вредоносный код часто пытается обойти решения безопасности на основе хоста, скрываясь в сжатых файлах.  По этой причине антивирусное программное обеспечение должно распаковать и просканировать все файлы, прежде чем пользователь откроет файл в архиве .

 Анализ и распаковка PE (переносимых исполняемых файлов) 

Вредоносное ПО скрывает и упаковывает свой вредоносный код, сжимая и шифруя его в полезной нагрузке. Оно распаковывает и дешифрует себя во время выполнения, чтобы затруднить выполнение статического анализа. Таким образом, антивирусное ПО должно быть способно обнаружить и распаковать большинство известных упаковщиков (UPX, Armadillo, ASPack и т. д.) до начала выполнения статического анализа.

Разработчики вредоносных программ используют различные методы, такие как упаковка, чтобы уменьшить размер и изменить структуру вредоносного файла. Упаковка сжимает исходный исполняемый файл, чтобы затруднить его анализ. Поэтому антивирусное программное обеспечение должно иметь функцию распаковщика для распаковки защищенных или сжатых исполняемых файлов в исходный код.

Еще одна функция, которой должно обладать антивирусное ПО, — это парсер заголовков Windows Portable Executable ( PE ). Парсинг PE исполняемых файлов помогает отличить вредоносное и легитимное ПО (файлы .exe). Формат файла PE в Windows (32 и 64 бит) содержит различную информацию и ресурсы, такие как объектный код, библиотеки DLL, файлы значков, файлы шрифтов и дампы ядра.

Эмуляторы

Эмулятор — это функция антивируса, которая выполняет дополнительный анализ подозрительных файлов. Получив запрос, эмулятор запускает подозрительные файлы (exe, DLL, PDF и т. д.) в виртуализированной и контролируемой среде. Он отслеживает поведение исполняемых файлов во время выполнения, включая вызовы API Windows, реестр и другие файлы Windows. Ниже приведены примеры артефактов, которые может собирать эмулятор:

API -вызовы
Дампы памяти
Модификации файловой системы
Журнал событий
Запуск процессов
Веб-запросы
Эмулятор останавливает выполнение файла, когда собирается достаточно артефактов для обнаружения вредоносного ПО.

Другие общие черты

Ниже приведены некоторые общие особенности, присущие AV- продуктам:

Драйвер самозащиты для защиты от вредоносных программ, атакующих сам AV .
Функции межсетевого экрана и проверки сети.
Инструменты командной строки и графического интерфейса.
Демон или служба.
Консоль управления.
### Ответьте на вопросы ниже
Какая функция антивируса анализирует вредоносное ПО в безопасной и изолированной среде?
```commandline
Emulator
```
Функция _______ представляет собой процесс восстановления или расшифровки сжатых исполняемых файлов до исходного состояния. 
```commandline
unpacker
```
Прочитайте вышеизложенное, чтобы перейти к следующему заданию, в котором мы обсудим методы обнаружения AV.
```commandline
Ответ не нужен
```

## Задание 4
Мы предоставили машину Windows 10 Pro для завершения этой комнаты. Доступ к виртуальной машине можно получить через 
функцию браузера. После развертывания виртуальной машины ваш браузер должен разделиться на два окна, как показано ниже: 

Если браузер не разделен, вы можете выбрать «Показать разделенный вид», расположенный в верхней части браузера.

Вы также можете подключиться через RDP , для этого обязательно разверните AttackBox или подключитесь  к VPN .

Используйте следующие учетные данные ниже.

IP-адрес машины:  MACHINE_IP            Имя пользователя:  thm Пароль:  TryHackM3           

`user@machine$ xfreerdp /v:MACHINE_IP /u:thm /p:TryHackM3`

### Ответьте на вопросы ниже
После развертывания виртуальной машины ее загрузка займет несколько минут. Затем переходите к следующей задаче!
```commandline
Ответ не нужен
```

## Задание 5
В целом, обнаружение AV можно разделить на три основных подхода:
- Статическое обнаружение
- Динамическое обнаружение
- Эвристическое и поведенческое обнаружение 
#### Статическое обнаружение

Метод статического обнаружения — это простейший тип обнаружения антивируса, который основан на предопределенных 
сигнатурах вредоносных файлов. Проще говоря, он использует методы сопоставления шаблонов при обнаружении, такие как 
поиск уникальной строки, CRC (контрольные суммы), последовательность значений байт-кода/Hex и криптографические хэши 
( MD5 , SHA1 и т. д.).   

Затем он выполняет ряд сравнений между существующими файлами в операционной системе и базой данных сигнатур. Если 
сигнатура существует в базе данных, то она считается вредоносной. Этот метод эффективен против статических 
вредоносных программ.  

Поток статического обнаружения

В этой задаче мы будем использовать метод обнаружения на основе сигнатур, чтобы увидеть, как антивирусные продукты 
обнаруживают вредоносные файлы. Важно отметить, что этот метод работает против известных вредоносных файлов только с 
предварительно сгенерированными сигнатурами в базе данных. Таким образом, базу данных необходимо время от времени 
обновлять.   

Мы будем использовать  антивирусное программное обеспечение ClamAV  , чтобы продемонстрировать, как обнаружение на 
основе сигнатур идентифицирует вредоносные файлы . Программное обеспечение ClamAV предустановлено в предоставленной 
виртуальной машине , и мы можем получить к нему доступ по следующему пути:  c:\Program Files\ClamAV\clamscan.exe .  
Мы также просканируем несколько образцов вредоносных программ, которые можно найти на рабочем столе. Папка образцов 
вредоносных программ содержит следующие файлы:    

- `EICAR` — это тестовый файл, содержащий строки ASCII, которые используются для проверки эффективности 
  антивирусного ПО 
вместо настоящего вредоносного ПО, которое может повредить вашему компьютеру. Для получения дополнительной 
информации вы можете посетить официальный сайт EICAR,  здесь .  
- `Backdoor 1` — это программа на языке C#, которая использует известную технику установления обратного соединения, 
включая создание процесса и выполнение шелл-кода Metasploit Framework. 
- `Backdoor 2` — это программа на C#, которая использует внедрение процесса и шифрование для установления обратного 
соединения, включая внедрение шелл-кода Metasploit в существующий и запущенный процесс.
- `AV -Check` — это программа C#, которая перечисляет антивирусное ПО на целевой машине. Обратите внимание, что этот 
  файл не является вредоносным. Мы рассмотрим этот инструмент более подробно в задаче 6. 
- `notes.txt` — текстовый файл, содержащий командную строку. Обратите внимание, что этот файл не является вредоносным.
- `ClamAV` поставляется со своей базой данных, и во время установки нам нужно загрузить недавно обновленную версию. 


Давайте попробуем просканировать папку образцов вредоносных программ с помощью двоичного файла  clamscan.exe  и 
проверим, как ClamAV справляется с этими образцами.  

Командная строка
```commandline
c:\>"c:\Program Files\ClamAV\clamscan.exe" c:\Users\thm\Desktop\Samples
Loading:    22s, ETA:   0s [========================>]    8.61M/8.61M sigs
Compiling:   4s, ETA:   0s [========================>]       41/41 tasks

C:\Users\thm\Desktop\Samples\AV-Check.exe: OK
C:\Users\thm\Desktop\Samples\backdoor1.exe: Win.Malware.Swrort-9872015-0 FOUND
C:\Users\thm\Desktop\Samples\backdoor2.exe: OK
C:\Users\thm\Desktop\Samples\eicar.com: Win.Test.EICAR_HDB-1 FOUND
C:\Users\thm\Desktop\Samples\notes.txt: OK
```
Вышеприведенный вывод показывает, что программное обеспечение ClamAV правильно проанализировало и пометило два из наших проверенных файлов (EICAR, backdoor1, AV -Check и notes.txt) как вредоносные. Однако оно неправильно идентифицировало backdoor2 как не вредоносный, хотя это так.

Вы можете запустить  clamscan.exe --debug <file_to_scan> , и вы увидите все модули, загруженные и используемые во время сканирования. Например, он использует метод распаковки для разделения файлов и поиска предопределенной вредоносной последовательности значений байт-кода, и именно так он смог обнаружить бэкдор C# 1. Значение байт-кода шелл-кода Metasploit, используемого в бэкдоре 1, было ранее идентифицировано и добавлено в базу данных ClamAV. 

Однако бэкдор 2 использует технику шифрования (XOR) для шелл-кода Metasploit, что приводит к появлению различных последовательностей значений байт-кода, которые отсутствуют в базе данных ClamAV. 

В то время как ClamAV смог обнаружить тестовый файл EICAR.COM как вредоносный, используя метод на основе сигнатуры md5. Чтобы подтвердить это, мы можем повторно просканировать тестовый файл EICAR.COM в режиме отладки (--debug). В какой-то момент в выводе вы увидите следующее сообщение:

LibClamAV debug: FP SIGNATURE: 44d88612fea8a8f36de82e1278abb02f:68:Win.Test.EICAR_HDB-1  # Name: eicar.com, Type: CL_TYPE_TEXT_ASCII
Теперь давайте сгенерируем значение md5 EICAR.COM, если оно совпадает с тем, что мы видим в предыдущем сообщении из 
вывода. Для этого мы будем использовать sigtool:  

Командная строка
```commandline
c:\>"c:\Program Files\ClamAV\sigtool.exe" --md5 c:\Users\thm\Desktop\Samples\eicar.com
44d88612fea8a8f36de82e1278abb02f:68:eicar.com

```
Если внимательно проверить сгенерированное значение MD5,  44d88612fea8a8f36de82e1278abb02f , оно совпадает.


Создайте свою собственную базу данных подписей 

Одной из функций ClamAV является создание собственной базы данных, что позволяет включать элементы, не найденные в официальной базе данных ClamAV. Давайте попробуем создать сигнатуру для Backdoor 2, которую ClamAV уже пропустил, и добавить ее в базу данных. Ниже приведены необходимые шаги:

Создайте подпись MD5 для файла.
Добавьте сгенерированную подпись в базу данных с расширением «.hdb».
Повторно просканируйте ClamAV файл, используя нашу новую базу данных.
Сначала мы воспользуемся  инструментом sigtool , который входит в комплект ClamAV, для генерации MD5- хеша  backdoor2.exe  с использованием  аргумента --md5 .   

Сгенерировать хэш MD5
```commandline
C:\Users\thm\Desktop\Samples>"c:\Program Files\ClamAV\sigtool.exe" --md5 backdoor2.exe
75047189991b1d119fdb477fef333ceb:6144:backdoor2.exe 
```
Как показано в выводе, сгенерированная хэш-строка содержит следующую структуру: Hash:Size-in-byte:FileName . 
Обратите внимание, что ClamAV использует сгенерированное значение при сравнении во время сканирования. 

Теперь, когда у нас есть хэш MD5, давайте создадим нашу собственную базу данных. Мы воспользуемся инструментом 
sigtool и сохраним вывод в файл с помощью > thm.hdb следующим образом, 

Сгенерируйте нашу новую базу данных
```commandline
C:\Users\thm\Desktop\Samples>"c:\Program Files\ClamAV\sigtool.exe" --md5 backdoor2.exe > thm.hdb
```
В результате в текущем каталоге будет создан файл thm.hdb , который выполнит команду. 

Мы уже знаем, что ClamAV не обнаружил backdoor2.exe с помощью официальной базы данных! Теперь давайте повторно 
просканируем его с помощью созданной нами базы данных thm.hdb и посмотрим на результат! 

Повторное сканирование backdoor2.exe с использованием новой базы данных!
```commandline
C:\Users\thm\Desktop\Samples>"c:\Program Files\ClamAV\clamscan.exe" -d thm.hdb backdoor2.exe
Loading:     0s, ETA:   0s [========================>]        1/1 sigs
Compiling:   0s, ETA:   0s [========================>]       10/10 tasks

C:\Users\thm\Desktop\Samples\backdoor2.exe: backdoor2.exe.UNOFFICIAL FOUND

```
Как мы и ожидали,  инструмент ClamAV пометил двоичный файл backdoor2.exe как вредоносный на основе предоставленной 
нами базы данных. В качестве практики добавьте подпись MD5 AV-Check.exe в ту же базу данных, которую мы уже создали, 
затем проверьте, может ли ClamAV пометить AV -Check.exe как вредоносный.  


Правила Yara для статического обнаружения


Одним из инструментов, помогающих в статическом обнаружении, является Yara . Yara — это инструмент, позволяющий 
разработчикам вредоносных программ классифицировать и обнаруживать вредоносное ПО. Yara использует обнаружение на 
основе правил, поэтому для обнаружения нового вредоносного ПО нам нужно создать новое правило. ClamAV также может 
работать с правилами Yara для обнаружения вредоносных файлов. Правило будет таким же, как в нашей базе данных в 
предыдущем разделе.     

Для создания правила нам необходимо изучить и проанализировать вредоносное ПО; на основе результатов мы пишем 
правило. Возьмем в качестве примера AV -Check.exe и напишем правило для него.  

Сначала давайте проанализируем файл и перечислим все читаемые человеком строки в двоичном файле с помощью 
инструмента strings. В результате мы увидим все функции, переменные и бессмысленные строки. Но если вы посмотрите 
внимательно, мы можем использовать некоторые уникальные строки в наших правилах для обнаружения этого файла в 
будущем. AV -Check использует базу данных программы (.pdb), которая содержит тип и символическую отладочную 
информацию программы во время компиляции.    

Командная строка
```commandline
C:\Users\thm\Desktop\Samples>strings AV-Check.exe | findstr pdb
C:\Users\thm\source\repos\AV-Check\AV-Check\obj\Debug\AV-Check.pdb

```
Мы будем использовать путь в выводе предыдущей команды как наш уникальный пример строки в правиле Yara, которое мы создадим. Сигнатура может быть чем-то другим в реальном мире, например, ключами реестра, командами и т. д. Если вы не знакомы с Yara, то мы предлагаем проверить комнату Yara THM . Ниже приведено правило Yara, которое мы будем использовать в нашем обнаружении :
```commandline
rule thm_demo_rule {
	meta:
		author = "THM: Intro-to-AV-Room"
		description = "Look at how the Yara rule works with ClamAV"
	strings:
		$a = "C:\\Users\\thm\\source\\repos\\AV-Check\\AV-Check\\obj\\Debug\\AV-Check.pdb"
	condition:
		$a
}

```
Давайте объясним это правило Яры немного подробнее.

Правило начинается с  rule thm_demo_rule ,  что является именем нашего правила. ClamAV использует это имя, если правило соответствует.
Раздел метаданных, представляющий собой общую информацию, содержит автора и описание, которые может заполнить пользователь.
Раздел strings содержит строки или байт-код, которые мы ищем. В этом случае мы используем путь к базе данных программы C#. Обратите внимание, что мы добавляем дополнительный символ  \  в этот путь, чтобы экранировать специальный символ, поэтому он не нарушает правило. 
В разделе условий мы указываем, найдена ли определенная строка в разделе строк, а затем помечаем файл.
Обратите внимание, что правила Yara должны храниться в  файле расширения .yara  , чтобы ClamAV мог с ними справиться. Давайте снова просканируем  папку c:\Users\thm\Desktop\Samples,  используя созданное нами правило Yara. Копию правила Yara можно найти на рабочем столе по адресу  c:\Users\thm\Desktop\Files\thm-demo-1.yara .

Сканирование с использованием правила Яры
```commandline
C:\Users\thm>"c:\Program Files\ClamAV\clamscan.exe" -d Desktop\Files\thm-demo-1.yara Desktop\Samples
Loading:     0s, ETA:   0s [========================>]        1/1 sigs
Compiling:   0s, ETA:   0s [========================>]       40/40 tasks

C:\Users\thm\Desktop\Samples\AV-Check.exe: YARA.thm_demo_rule.UNOFFICIAL FOUND
C:\Users\thm\Desktop\Samples\backdoor1.exe: OK
C:\Users\thm\Desktop\Samples\backdoor2.exe: OK
C:\Users\thm\Desktop\Samples\eicar.com: OK
C:\Users\thm\Desktop\Samples\notes.txt: YARA.thm_demo_rule.UNOFFICIAL FOUND

```
В результате ClamAV может обнаружить двоичный файл  AV -Check.exe  как вредоносный на основе правила Yara, которое мы предоставляем. Однако ClamAV дал ложноположительный результат, пометив  файл notes.txt  как вредоносный. Если мы откроем файл  notes.txt  , то увидим, что текст содержит тот же путь, который мы указали в правиле.

Давайте улучшим наше правило Yara, чтобы уменьшить ложноположительный результат. Мы будем указывать тип файла в нашем правиле. Часто типы файлов можно определить с помощью магических чисел, которые являются первыми двумя байтами двоичного файла. Например, исполняемые файлы (.exe) всегда начинаются со значения ASCII "MZ" или "4D 5A" в шестнадцатеричном формате.

Чтобы подтвердить это, давайте используем приложение HxD , которое является бесплатным Hex Editor, чтобы изучить двоичный файл AV-Check.exe и увидеть первые два байта. Обратите внимание, что HxD  уже доступен в предоставленной VM .

Приложение HxD


Зная, что это поможет улучшить обнаружение, давайте включим это в наше правило Yara, чтобы помечать только файлы .exe, содержащие нашу строку подписи как вредоносные. Ниже приведено улучшенное правило Yara:
```commandline
rule thm_demo_rule {
	meta:
		author = "THM: Intro-to-AV-Room"
		description = "Look at how the Yara rule works with ClamAV"
	strings:
		$a = "C:\\Users\\thm\\source\\repos\\AV-Check\\AV-Check\\obj\\Debug\\AV-Check.pdb"
		$b = "MZ"
	condition:
		$b at 0 and $a
}

```
В новом правиле Yara мы определили уникальную строку ($b), равную MZ, как идентификатор для типа файла .exe. Мы также обновили раздел условий, который теперь включает следующие условия:

Если строка «MZ» найдена в позиции 0, это начало файла.
Если уникальная строка (путь) встречается в двоичном файле.
В разделе условий мы использовали  оператор AND  для обоих  определений в 1 и 2, то есть у нас есть совпадение.  
Вы можете найти обновленное правило в  Desktop\Files\thm-demo-2.yara . Теперь, когда у нас есть обновленное правило Yara, давайте попробуем его снова.

Сканирование с использованием правила Яры
```commandline
C:\Users\thm>"c:\Program Files\ClamAV\clamscan.exe" -d Desktop\Files\thm-demo-2.yara Desktop\Samples
Loading:     0s, ETA:   0s [========================>]        1/1 sigs
Compiling:   0s, ETA:   0s [========================>]       40/40 tasks

C:\Users\thm\Desktop\Samples\AV-Check.exe: YARA.thm_demo_rule.UNOFFICIAL FOUND
C:\Users\thm\Desktop\Samples\backdoor1.exe: OK
C:\Users\thm\Desktop\Samples\backdoor2.exe: OK
C:\Users\thm\Desktop\Samples\eicar.com: OK
C:\Users\thm\Desktop\Samples\notes.txt: OK

```
Вывод показывает, что мы улучшили наше правило Yara, чтобы уменьшить количество ложноположительных результатов. Это был простой пример того, как работает антивирусное программное обеспечение. Таким образом, поставщики антивирусного программного обеспечения усердно работают над борьбой с вредоносным ПО и улучшают свои продукты и базу данных, чтобы повысить производительность и точность результатов.

Недостатком обнаружения на основе сигнатур является то, что файлы  будут иметь другое значение хэша, если двоичный файл изменен.  Поэтому кто-то может легко обойти методы обнаружения на основе сигнатур, если он знает, что ищет антивирусное программное обеспечение и как анализировать двоичные файлы, как показано в последующих комнатах.

### Ответьте на вопросы ниже
Каковы  выходные данные инструмента sigtool  для генерации MD5  двоичного файла AV-Check.exe  ?
```commandline
f4a974b0cf25dca7fbce8701b7ab3a88:6144:AV-Check.exe
```
Используйте инструмент strings для вывода списка всех читаемых человеком строк двоичного файла AV-Check. Что такое флаг?
```commandline
THM{Y0uC4nC-5tr16s}
```
## Задание 6
Концепция статического обнаружения относительно проста. В этом разделе мы обсудим различные типы методов обнаружения.

#### Динамическое обнаружение

Подход динамического обнаружения является более продвинутым и сложным, чем статическое обнаружение. Динамическое 
обнаружение больше ориентировано на проверку файлов во время выполнения с использованием различных методов. На 
следующей диаграмме показан поток сканирования динамического обнаружения:   

Поток динамического обнаружения

Первый метод — мониторинг API Windows. Механизм обнаружения проверяет вызовы приложений Windows и отслеживает вызовы 
API Windows с помощью Windows Hooks . 

Другой метод динамического обнаружения — Sandboxing. Sandbox — это виртуализированная среда, используемая для 
запуска вредоносных файлов отдельно от хост-компьютера. Обычно это делается в изолированной среде, и основная цель — 
проанализировать, как вредоносное ПО действует в системе. После подтверждения вредоносного ПО будут созданы 
уникальная сигнатура и правило на основе характеристик двоичного файла. Наконец, новое обновление будет отправлено в 
облачную базу данных для будущего использования.    

Этот тип обнаружения также имеет недостатки, поскольку он требует выполнения и работы вредоносного ПО в течение 
ограниченного времени в виртуальной среде для защиты системных ресурсов. Как и в случае с другими методами 
обнаружения, динамическое обнаружение можно обойти. Разработчики вредоносных программ реализуют свое ПО так, чтобы 
оно не работало в виртуальной или имитируемой среде, чтобы избежать динамического анализа. Например, они проверяют, 
порождает ли система реальный процесс выполнения ПО перед выполнением вредоносных действий или позволяют ПО 
некоторое время подождать перед выполнением.     

Для получения дополнительной информации об уклонении от песочницы мы рекомендуем вам посетить комнату THM: Уклонение 
от песочницы ! 


#### Эвристическое и поведенческое обнаружение

Эвристическое и поведенческое обнаружение стали неотъемлемой частью современных AV- продуктов. Современное AV 
-программное обеспечение опирается на этот тип обнаружения для обнаружения вредоносного ПО. Эвристический анализ 
использует различные методы, включая статические и динамические эвристические методы:  
- Статический эвристический анализ — это процесс декомпиляции (если это возможно) и извлечения исходного кода 
  вредоносного ПО. Затем извлеченный исходный код сравнивается с другими известными исходными кодами вирусов. Эти 
  исходные коды известны заранее и предопределены в эвристической базе данных. Если совпадение достигает или 
  превышает пороговый процент, код помечается как вредоносный.
- Динамический эвристический анализ основан на предопределенных поведенческих правилах. Исследователи безопасности 
  анализировали подозрительное программное обеспечение в изолированных и защищенных средах. На основании своих 
  выводов они помечали программное обеспечение как вредоносное. Затем создаются поведенческие правила, 
  соответствующие вредоносным действиям программного обеспечения на целевой машине.  

Ниже приведены примеры правил поведения: 
- Если процесс пытается взаимодействовать с процессом LSASS.exe, который содержит хэши NTLM пользователей, билеты Kerberos и многое другое
- Если процесс открывает порт прослушивания и ждет получения команд от сервера управления и контроля ( C2 )
- На следующей диаграмме показан процесс сканирования эвристического и поведенческого обнаружения:

Эвристический и поведенческий поток обнаружения



Подводя итог методам обнаружения

Давайте подведем итог, как современное антивирусное программное обеспечение работает как единое целое, включая все 
компоненты, и объединяет различные функции и методы обнаружения для реализации своего антивирусного движка. Ниже 
приведен пример компонентов антивирусного движка:  

Краткое описание методов обнаружения

На схеме вы можете видеть, как  подозрительный файл Foobar.zip передается антивирусному программному обеспечению для 
сканирования. Антивирусное программное обеспечение распознает, что это сжатый файл (.zip). Поскольку программное 
обеспечение поддерживает файлы .zip, оно  применяет функцию распаковки для извлечения файлов ( Foobar.exe ). Затем 
оно определяет тип файла, чтобы знать, с каким модулем работать, а затем выполняет операцию анализа PE, чтобы 
извлечь информацию о двоичном файле и другие характерные особенности. Затем оно проверяет, упакован ли файл; если да,
то распаковывает код.  Наконец, оно передает собранную информацию и двоичный файл антивирусному движку , где оно 
пытается определить, является ли он вредоносным, и выдает нам результат.        

### Ответьте на вопросы ниже
Какой метод обнаружения используется для анализа вредоносного ПО внутри виртуальных сред?
```commandline
Dynamic Detection
```

## Задание 7
Поставщики AV-оборудования

Многие поставщики AV на рынке в основном сосредоточены на внедрении продукта безопасности для домашних или 
корпоративных пользователей. Современное AV-программное обеспечение улучшилось и теперь сочетает антивирусные 
возможности с другими функциями безопасности, такими как брандмауэр, шифрование, антиспам, EDR , сканирование 
уязвимостей, VPN и т. д.   

Важно отметить, что трудно рекомендовать, какое программное обеспечение AV является лучшим. Все сводится к 
предпочтениям и опыту пользователя. В настоящее время поставщики AV сосредоточены на безопасности бизнеса в 
дополнение к безопасности конечного пользователя.  Мы предлагаем проверить веб-сайт AV Compares для получения более 
подробной информации о поставщиках корпоративных AV .   

Среда тестирования  AV

Среды тестирования AV — это отличное место для проверки подозрительных или вредоносных файлов. Вы можете загружать 
файлы для сканирования их различными поставщиками программного обеспечения AV . Более того, такие платформы, как 
VirusTotal, используют различные методы и предоставляют результаты в течение нескольких секунд. Как red teamer или 
пентестер, мы должны тестировать полезную нагрузку против самых известных приложений AV , чтобы проверить 
эффективность метода обхода.    

VirusTotal 

VirusTotal — это известная веб-платформа сканирования для проверки подозрительных файлов. Она позволяет 
пользователям загружать файлы для сканирования более чем 70 антивирусными движками. VirusTotal передает загруженные 
файлы антивирусным движкам для проверки, возвращает результат и сообщает, являются ли они вредоносными или нет. 
Применяется множество контрольных точек, включая проверку URL-адресов или служб, занесенных в черный список, 
сигнатур, двоичного анализа, поведенческого анализа, а также проверку вызовов API. Кроме того, двоичный файл будет 
запущен и проверен в имитированной и изолированной среде для получения лучших результатов. Для получения 
дополнительной информации и ознакомления с другими функциями вы можете посетить веб-сайт VirusTotal.


ВирусВсего альтернатив

Важное примечание:  VirusTotal — удобная платформа сканирования с отличными функциями, но у нее есть политика 
совместного использования. Все результаты сканирования будут переданы и предоставлены поставщикам антивирусов для 
улучшения их продуктов и обновления их баз данных для известных вредоносных программ. Как участник Red Team, это 
сожжет дроппер или полезную нагрузку, которую вы используете в сражениях. Таким образом, доступны альтернативные 
решения для тестирования против различных поставщиков продуктов безопасности, и самым важным преимуществом является 
то, что у них нет политики совместного использования. Однако есть и другие ограничения. У вас будет ограниченное 
количество файлов для сканирования в день; в противном случае  для неограниченного тестирования  потребуется  
подписка . По этим причинам мы рекомендуем вам тестировать вредоносное ПО только на сайтах, которые не делятся 
информацией, например:

AntiscanMe  (6 бесплатных сканирований в день)
Сканирование на вирусы Сканирование на наличие вредоносных программ Jotti

Программное обеспечение AV для снятия отпечатков пальцев

Как участники Red Team, мы не знаем, какое антивирусное ПО установлено, как только мы получаем первоначальный доступ 
к целевой машине. Поэтому важно найти и определить, какие продукты безопасности на основе хоста установлены, включая 
антивирусное ПО. AV -отпечатки являются важным процессом для определения поставщика антивирусного ПО. Знание того, 
какое антивирусное ПО установлено, также весьма полезно при создании той же среды для тестирования методов обхода.     

В этом разделе представлены различные способы анализа и идентификации антивирусного программного обеспечения на 
основе статических артефактов, включая имена служб, имена процессов, доменные имена, ключи реестра и файловые системы.  

В следующей таблице приведено известное и часто используемое антивирусное программное обеспечение. 


#### SharpEDRChecker

Один из способов снятия отпечатков AV — использование общедоступных инструментов, таких как  SharpEDRChecker . Он 
написан на C# и выполняет различные проверки на целевой машине, включая проверки на наличие антивирусного ПО, 
например запущенных процессов, метаданных файлов, загруженных DLL- файлов, ключей реестра, служб, каталогов и файлов.   

Мы предварительно загрузили SharpEDRChecker из репозитория GitHub  , чтобы использовать его в прикрепленной 
виртуальной машине . Теперь нам нужно скомпилировать проект, и мы уже создали ярлык для проекта на рабочем столе 
(SharpEDRChecker). Для этого дважды щелкните по нему, чтобы открыть его в Microsoft Visual Studio 2022. Теперь, 
когда наш проект готов, нам нужно скомпилировать его, как показано на следующем снимке экрана:

После компиляции мы можем найти путь скомпилированной версии в разделе вывода, как указано в шаге 3. Мы также 
добавили копию скомпилированной версии в каталог  C:\Users\thm\Desktop\Files .  Теперь давайте попробуем запустить 
его и увидеть результат следующим образом:  

Командная строка!
```commandline
C:\> SharpEDRChecker.exe
➜	
Резюме SharpEDRChecker
[!] Directory Summary:
   [-] C:\Program Files\Windows Defender : defender
   [-] C:\Program Files\Windows Defender Advanced Threat Protection : defender, threat
   [-] C:\Program Files (x86)\Windows Defender : defender

[!] Service Summary:
   [-] PsShutdownSvc : sysinternal
   [-] Sense : defender, threat
   [-] WdNisSvc : defender, nissrv
   [-] WinDefend : antimalware, defender, malware, msmpeng
   [-] wscsvc : antivirus

```
В результате Windows Defender обнаруживается на основе папок и служб. Обратите внимание, что эта программа может 
быть помечена антивирусным ПО как вредоносная, поскольку она выполняет различные проверки и вызовы API.  

Проверка отпечатков пальцев C#

Другой способ перечислить антивирусное ПО — написать собственную программу.  Мы подготовили программу на C# в 
предоставленной виртуальной машине Windows 10 Pro, поэтому мы можем провести несколько практических экспериментов! 
Вы можете найти значок проекта на рабочем столе ( AV -Check) и дважды щелкнуть по нему, чтобы открыть его с помощью 
Microsoft Visual Studio 2022.    

Следующий код C# прост, и его основная цель — определить, установлено ли антивирусное программное обеспечение, на 
основе предопределенного списка известных антивирусных приложений. 
```commandline
using System;
using System.Management;

internal class Program
{
    static void Main(string[] args)
    {
        var status = false;
        Console.WriteLine("[+] Antivirus check is running .. ");
        string[] AV_Check = { 
            "MsMpEng.exe", "AdAwareService.exe", "afwServ.exe", "avguard.exe", "AVGSvc.exe", 
            "bdagent.exe", "BullGuardCore.exe", "ekrn.exe", "fshoster32.exe", "GDScan.exe", 
            "avp.exe", "K7CrvSvc.exe", "McAPExe.exe", "NortonSecurity.exe", "PavFnSvr.exe", 
            "SavService.exe", "EnterpriseService.exe", "WRSA.exe", "ZAPrivacyService.exe" 
        };
        var searcher = new ManagementObjectSearcher("select * from win32_process");
        var processList = searcher.Get();
        int i = 0;
        foreach (var process in processList)
        {
            int _index = Array.IndexOf(AV_Check, process["Name"].ToString());
            if (_index > -1)
            {
                Console.WriteLine("--AV Found: {0}", process["Name"].ToString());
                status = true;
            }
            i++;
        }
        if (!status) { Console.WriteLine("--AV software is not found!");  }
    }
}

```
Давайте объясним код немного подробнее. Мы предварительно определили список известных приложений AV в  массиве 
AV_Check в нашем коде, который взят из предыдущего раздела, где мы обсуждали отпечатки программного обеспечения AV 
(таблица выше). Затем мы используем запрос командной строки инструментария управления Windows (WMIC) ( select * from 
win32_process ), чтобы составить список всех текущих запущенных процессов на целевой машине и сохранить их в   
переменной processList . Затем мы просматриваем текущие запущенные процессы и сравниваем, существуют ли они в 
предварительно определенном  массиве. Если совпадение найдено, то у нас установлено программное обеспечение AV.

Программа C# использует объект WMIC для перечисления текущих запущенных процессов, которые могут отслеживаться 
программным обеспечением AV . Если программное обеспечение AV плохо реализовано для отслеживания запросов WMIC или 
API Windows, это может привести к ложноположительным результатам при сканировании нашей программы C#.  

Давайте скомпилируем версию x86 программы C#, загрузим ее на сайт VirusTotal и проверим результаты!  Чтобы 
скомпилировать программу C# в Microsoft Visual Studio 2022, выберите Build в меню панели и выберите опцию Build 
Solution . Затем, если все прошло правильно, вы можете найти путь к скомпилированной версии в разделе вывода, как 
выделено в шаге 3 на снимке экрана ниже.   

Компиляция проекта C#

Если мы загрузим программу AV -Check на  сайт VirusTotal  и проверим результат, то, как ни странно, VirusTotal 
показал, что два поставщика AV (MaxSecure и SecureAge APEX) пометили нашу программу как вредоносную! Таким образом, 
это ложноположительный результат, когда он неправильно идентифицирует файл как вредоносный, хотя это не так. Одна из 
возможных причин заключается в том, что программное обеспечение этих поставщиков AV использует классификатор 
машинного обучения или метод обнаружения на основе правил, который плохо реализован. Более подробную информацию о 
фактическом отчете об отправке см.  здесь . Существует четыре основных раздела: Обнаружение, Подробности, Поведение 
и Сообщество. Если мы проверим раздел Поведение, мы увидим все вызовы API Windows, разделы реестра, модули и запрос 
WMIC.       

VirusTotal проверка

В разделе Detection есть правила Sigma, которые, если системное событие во время выполнения совпадает (в среде 
sandbox), считают файл вредоносным. Этот результат, вероятно, основан на правилах; VirusTotal пометил нашу программу 
из-за техники  Process Ghosting , как показано на следующем снимке экрана.  

VirusTotal проверка

Теперь давайте перекомпилируем программу C# с использованием процессора x64 и проверим, работают ли движки проверки 
по-другому. В нашей попытке отправки на этот раз программное обеспечение трех поставщиков AV (Cyren AV добавлен в 
список) пометило файл как вредоносный.  Более подробную информацию о фактическом отчете об отправке см.  здесь .   

VirusTotal проверка

Примечание:  если вы попытаетесь отправить файл на сайт VirusTotal, он может дать вам другой результат. Помните, что 
VirusTotal делится отчетами об отправке с поставщиками антивирусов для улучшения их механизмов обнаружения 
антивирусов , включая ложноположительные результаты.  
### Ответьте на вопросы ниже
Для отпечатка антивируса C# попробуйте переписать код на другом языке, например, Python, и проверьте, помечает ли 
VirusTotal его как вредоносный.
```commandline
Ответ не нужен
```

Прочитайте вышеизложенное!
Ответ не требуется
```commandline
Ответ не нужен
```

## Задание 8
Резюме

В этой комнате мы рассмотрели антивирусное программное обеспечение и его подходы к обнаружению. Как члену Red Team, 
важно знать, как работает антивирусное программное обеспечение и как оно обнаруживает вредоносные приложения, чтобы 
иметь возможность реализовать обходные методы.

Мы также подробно обсудили метод статического обнаружения и продемонстрировали, как ClamAV, антивирус с открытым 
исходным кодом, обнаруживает вредоносные файлы с помощью статического анализа. Кроме того, мы показали, как создать 
собственную базу данных и использовать правила Yara для обнаружения вредоносных файлов, которые не обнаруживаются 
официальной базой данных.    

После получения доступа к цели необходимо перечислить целевую машину перед выполнением дальнейших действий, таких 
как повышение привилегий или горизонтальное перемещение. Причина в том, чтобы не вызывать оповещения о 
подозрительных действиях, которые могут привести к потере доступа к целевой машине. Таким образом, мы представили 
два метода для практики AV- отпечатков с использованием публичных и частных инструментов.   

### Ответьте на вопросы ниже
Поздравляю с завершением комнаты и продолжайте учиться!
```commandline
Ответ не нужен
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)