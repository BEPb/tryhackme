[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Active Directory Basics](https://tryhackme.com/r/room/winadbasics) 

Всего 9 заданий:
## Задание 1
Microsoft Active Directory — это основа корпоративного мира. Она упрощает управление устройствами и пользователями в 
корпоративной среде. В этой комнате мы подробно рассмотрим основные компоненты Active Directory. 

### Цели комнаты

В этой комнате мы узнаем об Active Directory и познакомимся со следующими темами:
- Что такое Active Directory
- Что такое домен Active Directory
- Какие компоненты входят в домен Active Directory
- Леса и доверие к доменам
И многое другое!
Предварительные условия для комнаты

Общее знакомство с Windows. Проверьте модуль Windows Fundamentals для получения дополнительной информации по этому 
вопросу. 
### Ответить на вопросы ниже
Нажмите и продолжайте обучение!
```commandline
Ответ не нужен
```

## Задание 2
Представьте себе, что вы администрируете небольшую сеть предприятия, состоящую всего из пяти компьютеров и пяти 
сотрудников. В такой крошечной сети вы, вероятно, сможете настроить каждый компьютер отдельно без проблем. Вы 
вручную войдете в каждый компьютер, создадите пользователей для тех, кто будет ими пользоваться, и сделаете 
определенные настройки для учетных записей каждого сотрудника. Если компьютер пользователя перестанет работать, вы, 
вероятно, пойдете к нему домой и почините компьютер на месте.

Хотя это звучит как очень расслабленный образ жизни, предположим, что ваш бизнес внезапно вырос и теперь имеет 157 
компьютеров и 320 разных пользователей, расположенных в четырех разных офисах. Сможете ли вы по-прежнему управлять 
каждым компьютером как отдельной сущностью, вручную настраивать политики для каждого пользователя в сети и 
предоставлять поддержку на месте для всех? Ответ, скорее всего, нет.   

Чтобы преодолеть эти ограничения, мы можем использовать домен Windows. Проще говоря, домен Windows — это группа 
пользователей и компьютеров, находящихся под управлением определенного бизнеса. Основная идея домена — 
централизовать администрирование общих компонентов компьютерной сети Windows в едином репозитории, называемом Active 
Directory (AD) . Сервер, на котором работают службы Active Directory, называется контроллером домена (DC).   

### Обзор домена Windows

Основные преимущества наличия настроенного домена Windows:

Централизованное управление идентификацией: все пользователи в сети могут быть настроены из Active Directory с 
минимальными усилиями. 
Управление политиками безопасности: вы можете настраивать политики безопасности непосредственно из Active Directory 
и применять их к пользователям и компьютерам по всей сети по мере необходимости. 
Пример из реальной жизни

Если это звучит немного странно, скорее всего, вы уже когда-то взаимодействовали с доменом Windows в школе, 
университете или на работе. 

В школьных/университетских сетях вам часто будут предоставлять имя пользователя и пароль, которые вы можете 
использовать на любом из доступных компьютеров в кампусе. Ваши учетные данные действительны для всех машин, 
поскольку всякий раз, когда вы вводите их на машине, она перенаправляет процесс аутентификации обратно в Active 
Directory, где ваши учетные данные будут проверены. Благодаря Active Directory ваши учетные данные не обязательно 
должны существовать на каждой машине и доступны по всей сети.    

Active Directory также является компонентом, который позволяет вашей школе/университету ограничивать ваш доступ к 
панели управления на ваших школьных/университетских компьютерах. Политики обычно развертываются по всей сети, так 
что у вас нет административных привилегий на этих компьютерах.  

### Добро пожаловать в THM Inc.

В ходе выполнения этой задачи мы возьмем на себя роль нового ИТ-администратора в THM Inc. В качестве нашей первой 
задачи нам было предложено просмотреть текущий домен "THM.local" и выполнить некоторые дополнительные настройки. У 
вас будут административные учетные данные на предварительно настроенном контроллере домена ( DC ) для выполнения задач.  

Не забудьте нажать кнопку Start Machine сейчас, так как вы будете использовать одну и ту же машину для всех задач. 
Это должно открыть машину в вашем браузере. Если вы предпочитаете подключаться к ней через RDP, вы можете 
использовать следующие учетные данные:  

Флаг ТХМ
Имя пользователя	Администратор
Пароль	Пароль321
Примечание: При подключении через RDP используйте в качестве имени пользователя, чтобы указать, что вы хотите войти 
в систему, используя имя пользователя в домене.   `THM\Administrator  Administrator  THM`  


Поскольку мы будем подключаться к целевой машине через RDP , это также подходящее время для запуска AttackBox (если 
вы не используете свою собственную машину). 

### Ответить на вопросы ниже
В домене Windows учетные данные хранятся в централизованном репозитории, который называется...
```commandline
Active Directory
```
Сервер, отвечающий за работу служб Active Directory, называется...
```commandline
Domain Controller
```

## Задание 3
Ядром любого домена Windows является служба домена Active Directory ( AD DS) . Эта служба действует как каталог, в 
котором хранится информация обо всех «объектах», существующих в вашей сети. Среди множества объектов, поддерживаемых 
AD, у нас есть пользователи, группы, машины, принтеры, общие ресурсы и многое другое. Давайте рассмотрим некоторые 
из них:   

### Пользователи

Пользователи являются одним из наиболее распространенных типов объектов в Active Directory. Пользователи являются 
одним из объектов, известных как субъекты безопасности , что означает, что они могут быть аутентифицированы доменом 
и им могут быть назначены привилегии на ресурсы , такие как файлы или принтеры. Можно сказать, что субъект 
безопасности — это объект, который может действовать на ресурсах в сети.   

Пользователи могут использоваться для представления двух типов сущностей:
- Люди: пользователи, как правило, представляют собой лиц в вашей организации, которым необходим доступ к сети, 
  например, сотрудников. 
- Службы: вы также можете определить пользователей, которые будут использоваться службами, такими как IIS или MSSQL. 
- Каждая отдельная служба требует пользователя для запуска, но пользователи служб отличаются от обычных пользователей, 
поскольку у них будут только привилегии, необходимые для запуска их конкретной службы.  

### Машины

Машины — это еще один тип объектов в Active Directory; для каждого компьютера, который присоединяется к домену 
Active Directory, будет создан объект машины. Машины также считаются «участниками безопасности» и им назначается 
учетная запись, как и любому обычному пользователю. Эта учетная запись имеет несколько ограниченные права в самом 
домене.   

Учетные записи компьютеров сами по себе являются локальными администраторами на назначенном компьютере, к ним, как 
правило, не должен иметь доступ никто, кроме самого компьютера, но, как и в случае с любой другой учетной записью, 
если у вас есть пароль, вы можете использовать его для входа в систему.  

Примечание:  пароли учетных записей компьютеров автоматически меняются и обычно состоят из 120 случайных символов.

Идентификация учетных записей машин относительно проста. Они следуют определенной схеме именования. Имя учетной 
записи машины — это имя компьютера, за которым следует знак доллара. Например, машина с именем DC01будет иметь 
учетную запись машины с именем DC01$.  

### Группы безопасности

Если вы знакомы с Windows, вы, вероятно, знаете, что можно определить группы пользователей, чтобы назначать права 
доступа к файлам или другим ресурсам целым группам, а не отдельным пользователям. Это обеспечивает лучшую 
управляемость, поскольку вы можете добавлять пользователей в существующую группу, и они автоматически унаследуют все 
привилегии группы. Группы безопасности также считаются субъектами безопасности и, следовательно, могут иметь 
привилегии над ресурсами в сети.    

Группы могут иметь в качестве участников как пользователей, так и машины. При необходимости группы могут включать в 
себя и другие группы. 

Несколько групп создаются по умолчанию в домене, которые могут использоваться для предоставления пользователям 
определенных привилегий. В качестве примера, вот некоторые из наиболее важных групп в домене: 

Группа Безопасности	Описание
- Администраторы домена	Пользователи этой группы имеют административные привилегии во всем домене. По умолчанию они 
могут администрировать любой компьютер в домене, включая контроллеры домена.
- Операторы сервера	Пользователи в этой группе могут администрировать контроллеры домена. Они не могут изменять 
  членство в каких-либо административных группах.
- Резервные операторы	Пользователям этой группы разрешен доступ к любому файлу, игнорируя их разрешения. Они 
  используются для выполнения резервного копирования данных на компьютерах.
- Операторы счетов	Пользователи этой группы могут создавать или изменять другие учетные записи в домене.
- Пользователи домена	Включает все существующие учетные записи пользователей в домене.
- Доменные компьютеры	Включает все существующие компьютеры в домене.
- Контроллеры домена	Включает все существующие контроллеры домена в домене.
- Полный список групп безопасности по умолчанию можно получить из документации Microsoft .

### Пользователи и компьютеры Active Directory

Чтобы настроить пользователей, группы или компьютеры в Active Directory, нам необходимо войти в контроллер домена и 
запустить «Пользователи и компьютеры Active Directory» из меню «Пуск»: 

### Меню «Пуск» Пользователи и компьютеры AD

Это откроет окно, в котором вы можете увидеть иерархию пользователей, компьютеров и групп, которые существуют в 
домене. Эти объекты организованы в организационные подразделения (OU) , которые являются объектами-контейнерами, 
позволяющими классифицировать пользователей и машины. OU в основном используются для определения наборов 
пользователей со схожими требованиями к контролю. Например, к сотрудникам отдела продаж вашей организации, скорее 
всего, будут применяться другие наборы политик, чем к сотрудникам ИТ-отдела. Помните, что пользователь может быть 
частью только одного OU одновременно.     

Проверяя нашу машину, мы видим, что уже есть OU с четырьмя дочерними OU для отделов ИТ, менеджмента, маркетинга и 
продаж. Очень типично видеть, как OU имитируют THMструктуру бизнеса, поскольку это позволяет эффективно развертывать 
базовые политики, которые применяются ко всем отделам. Помните, что хотя это будет ожидаемой моделью большую часть 
времени, вы можете определять OU произвольно. Не стесняйтесь щелкнуть правой кнопкой мыши по THM OU и создать под 
ним новую OU , названную Studentsпросто ради забавы.    

### Пользователи и компьютеры AD

Если вы откроете какие-либо OU, вы сможете увидеть пользователей, которых они содержат, и выполнять простые задачи, 
такие как создание, удаление или изменение их по мере необходимости. Вы также можете сбросить пароли, если это 
необходимо (довольно полезно для службы поддержки):  

### ИТ-отдел OU

Вы, вероятно, уже заметили, что есть и другие контейнеры по умолчанию, помимо THM OU. Эти контейнеры создаются 
Windows автоматически и содержат следующее: 
- Встроенный: Содержит группы по умолчанию, доступные любому хосту Windows.
- Компьютеры: Любая машина, подключающаяся к сети, будет помещена сюда по умолчанию. Вы можете переместить их, если 
  необходимо.
- Контроллеры домена: организационное подразделение по умолчанию , содержащее контроллеры домена в вашей сети.
- Пользователи: пользователи и группы по умолчанию, которые применяются к общедоменному контексту.
Управляемые учетные записи служб: хранит учетные записи, используемые службами в вашем домене Windows.
### Группы безопасности против OU

Вы, вероятно, задаетесь вопросом, почему у нас есть и группы, и OU. Хотя оба используются для классификации 
пользователей и компьютеров, их цели совершенно разные: 

OU удобны для  применения политик к пользователям и компьютерам, которые включают в себя определенные конфигурации, 
относящиеся к наборам пользователей в зависимости от их конкретной роли в предприятии. Помните, что пользователь 
может быть членом только одного OU одновременно, так как было бы бессмысленно пытаться применить два разных набора 
политик к одному пользователю.   
Группы безопасности , с другой стороны, используются для предоставления разрешений на ресурсы. Например, вы будете 
использовать группы, если хотите разрешить некоторым пользователям доступ к общей папке или сетевому принтеру. 
Пользователь может быть частью многих групп, что необходимо для предоставления доступа к нескольким ресурсам.  
### Ответить на вопросы ниже
Какая группа обычно администрирует все компьютеры и ресурсы в домене?
```commandline
Domain Admins
```
Каково будет имя учетной записи компьютера, связанного с компьютером с именем TOM-PC?
```commandline
TOM-PC$
```
Предположим, что наша компания создает новый отдел по обеспечению качества. Какой тип контейнеров нам следует 
использовать для группировки всех пользователей отдела обеспечения качества, чтобы политики можно было применять к 
ним последовательно?  
```commandline
Organizational Units
```

## Задание 4
Ваша первая задача в качестве нового администратора домена — проверить существующие подразделения и пользователей AD 
, поскольку в бизнесе произошли некоторые недавние изменения. Вам дали следующую организационную схему, и от вас 
ожидают внесения изменений в AD , чтобы соответствовать ей:  

Организационная структура THM

Удаление дополнительных OU и пользователей

Первое, что вы должны заметить, это то, что в вашей текущей конфигурации AD есть дополнительный OU отдела, который 
не отображается в таблице. Нам сказали, что он был закрыт из-за сокращения бюджета и должен быть удален из домена. 
Если вы попытаетесь щелкнуть правой кнопкой мыши и удалить OU , вы получите следующую ошибку:  

### Ошибка удаления OU
По умолчанию OU защищены от случайного удаления. Чтобы удалить OU , нам нужно включить Дополнительные функции в меню Вид:

## Включение расширенных функций
Это покажет вам некоторые дополнительные контейнеры и позволит вам отключить защиту от случайного удаления. Для 
этого щелкните правой кнопкой мыши OU и перейдите в Properties. Вы найдете флажок на вкладке Object, чтобы отключить 
защиту:  

### Отключить защиту от удаления OU

Обязательно снимите флажок и попробуйте удалить OU еще раз. Вам будет предложено подтвердить, что вы хотите удалить 
OU , и в результате все пользователи, группы или OU в нем также будут удалены.  

После удаления лишнего OU вы должны заметить, что для некоторых отделов пользователи в AD не соответствуют 
пользователям в нашей организационной схеме. Создавайте и удаляйте пользователей по мере необходимости, чтобы 
сопоставить их.  

### Делегация
Одна из приятных вещей, которую вы можете сделать в AD, — это предоставить определенным пользователям контроль над 
некоторыми OU. Этот процесс называется делегированием  и позволяет вам предоставлять пользователям определенные 
привилегии для выполнения расширенных задач в OU без необходимости вмешательства администратора домена.  

Одним из наиболее распространенных вариантов использования этого является предоставление IT supportпривилегий для 
сброса паролей других пользователей с низким уровнем привилегий. Согласно нашей организационной схеме, Филлип 
отвечает за ИТ-поддержку, поэтому мы, вероятно, хотели бы делегировать ему контроль над сбросом паролей в 
подразделениях Sales, Marketing и Management.   

Для этого примера мы делегируем управление над OU Sales Филиппу. Чтобы делегировать управление над OU , вы можете 
щелкнуть его правой кнопкой мыши и выбрать Delegate Control : 

Делегирование контроля над подразделением

Должно открыться новое окно, в котором сначала вам будет предложено указать пользователей, которым вы хотите 
делегировать управление: 

Примечание: Чтобы избежать опечаток при вводе имени пользователя, напишите «phillip» и нажмите кнопку «Проверить 
имена» . Windows автоматически заполнит имя пользователя для вас. 

Делегирование отдела продаж Филлипу

Нажмите «ОК» и на следующем шаге выберите следующую опцию:

### Делегирование сброса пароля

Нажмите «Далее» пару раз, и теперь Филлип должен иметь возможность сбрасывать пароли для любого пользователя в 
отделе продаж. Хотя вы, вероятно, захотите повторить эти шаги, чтобы делегировать сбросы паролей отделов маркетинга 
и управления, мы оставим это здесь для этой задачи. Вы можете продолжить настройку остальных OU, если пожелаете.

Теперь давайте используем учетную запись Филлипа, чтобы попытаться сбросить пароль Софи. Вот учетные данные Филлипа 
для входа через RDP: 

### ТМ-ключ
Имя пользователя	филипп
Пароль	Клэр2008
Примечание: При подключении через RDP используйте THM\phillip в качестве имени пользователя, чтобы указать, что вы 
хотите войти в систему, используя имя пользователя phillip в THM домене. 

Хотя у вас может возникнуть соблазн зайти в Active Directory Users and Computers, чтобы попробовать и протестировать 
новые полномочия Филлипа, у него на самом деле нет прав, чтобы открыть его, поэтому вам придется использовать другие 
методы для сброса пароля. В этом случае мы будем использовать Powershell для этого:  

Окна PowerShell (Как Филипп)
`PS C:\Users\phillip> Set-ADAccountPassword sophie -Reset -NewPassword (Read-Host -AsSecureString -Prompt 'New Password') -Verbose`

New Password: *********

`VERBOSE: Performing the operation "Set-ADAccountPassword" on target "CN=Sophie,OU=Sales,OU=THM,DC=thm,DC=local".`
Поскольку мы не хотим, чтобы Софи продолжала использовать известный нам пароль, мы также можем принудительно 
сбросить пароль при следующем входе в систему с помощью следующей команды: 

Окна
PowerShell
(как Филипп)
`PS C:\Users\phillip> Set-ADUser -ChangePasswordAtLogon $true -Identity sophie -Verbose`

`VERBOSE: Performing the operation "Set" on target "CN=Sophie,OU=Sales,OU=THM,DC=thm,DC=local".`
Флаг ТХМ
Войдите в учетную запись Софи, используя новый пароль, и получите флаг с рабочего стола Софи.
Примечание: При подключении через RDP используйте THM\sophie в качестве имени пользователя, чтобы указать, что вы 
хотите войти в систему, используя имя пользователя sophie в THM домене.

### Ответить на вопросы ниже
Что за флаг был найден на рабочем столе Софи?
```commandline
THM{thanks_for_contacting_support}
```
Процесс предоставления пользователю привилегий в отношении некоторого OU или другого объекта AD называется...
```commandline
delegation
```

## Задание 5
По умолчанию все машины, которые присоединяются к домену (кроме DC), будут помещены в контейнер под названием 
"Computers". Если мы проверим наш DC , то увидим, что некоторые устройства уже там:

### Компьютеры OU

Мы видим несколько серверов, несколько ноутбуков и несколько ПК, соответствующих пользователям в нашей сети. 
Размещение всех наших устройств там — не самая лучшая идея, поскольку весьма вероятно, что вы захотите использовать 
разные политики для своих серверов и машин, которые обычные пользователи используют ежедневно.  

Хотя нет золотого правила, как организовать ваши машины, отличной отправной точкой является разделение устройств в 
соответствии с их использованием. В целом, вы ожидаете увидеть устройства, разделенные по крайней мере на три 
следующие категории:  

1. Рабочие станции
Рабочие станции являются одними из самых распространенных устройств в домене Active Directory. Каждый пользователь в 
домене, скорее всего, будет входить в рабочую станцию. Это устройство, которое они будут использовать для выполнения 
своей работы или обычного просмотра. На этих устройствах никогда не должен входить привилегированный пользователь.  
2. Серверы
Серверы являются вторым наиболее распространенным устройством в домене Active Directory. Серверы обычно используются 
   для предоставления услуг пользователям или другим серверам. 
3. Контроллеры домена

Контроллеры домена являются третьим наиболее распространенным устройством в домене Active Directory. Контроллеры 
домена позволяют управлять доменом Active Directory. Эти устройства часто считаются наиболее конфиденциальными 
устройствами в сети, поскольку они содержат хэшированные пароли для всех учетных записей пользователей в среде.  

Поскольку мы приводим в порядок AD, давайте создадим два отдельных OU для Workstations и Servers(контроллеры домена 
уже находятся в OU, созданной Windows). Мы создадим их непосредственно под thm.local контейнером домена. В итоге у 
вас должна получиться следующая структура OU :  

окончательная структура OU

Теперь переместите персональные компьютеры и ноутбуки в OU Workstations, а серверы — в OU Servers из контейнера 
Computers. Это позволит нам позже настроить политики для каждого OU. 

### Ответить на вопросы ниже
После организации имеющихся компьютеров сколько из них оказалось в подразделении рабочих станций?

```commandline
7
```
Рекомендуется ли создавать отдельные OU для серверов и рабочих станций? (да/нет)
```commandline
yay
```
## Задание 6
До сих пор мы организовывали пользователей и компьютеры в OU просто так, но главная идея этого заключается в том, 
чтобы иметь возможность развертывать различные политики для каждого OU индивидуально. Таким образом, мы можем 
продвигать различные конфигурации и базовые уровни безопасности для пользователей в зависимости от их отдела.   

Windows управляет такими политиками через объекты групповой политики ( GPO ) . GPO — это просто набор настроек, 
которые можно применить к OU. GPO могут содержать политики, нацеленные как на пользователей, так и на компьютеры, 
что позволяет вам устанавливать базовые параметры для определенных машин и идентификаторов.  

Для настройки объектов групповой политики можно использовать инструмент управления групповой политикой , доступный 
из меню «Пуск»: 

### Стартовое меню GPM

Первое, что вы увидите, открыв его, — это полная иерархия OU , как определено ранее. Чтобы настроить групповые 
политики, сначала создайте GPO в разделе «Объекты групповой политики»  , а затем свяжите его с OU , к которому вы 
хотите применить политики. В качестве примера вы можете увидеть, что на вашей машине уже есть несколько существующих GPO:  

### Существующие OU на вашем компьютере

На изображении выше мы видим, что было создано 3 объекта групповой политики. Из них Default Domain Policy и RDP 
Policy связаны с thm.local доменом в целом, а Default Domain Controllers Policy связан только с Domain Controllers OU. 
Важно помнить, что любой объект групповой политики будет применяться к связанной OU и любым под-OU в ней. Например, 
Sales OU по-прежнему будет зависеть от Default Domain Policy.

Давайте рассмотрим, Default Domain Policy что находится внутри GPO. Первая вкладка, которую вы увидите при выборе GPO 
, показывает его область действия, то есть то, где GPO связан в AD. Для текущей политики мы видим, что она связана 
только с thm.local доменом:  

### Область применения OU

Как вы видите, вы также можете применить фильтрацию безопасности к объектам групповой политики, чтобы они 
применялись только к определенным пользователям/компьютерам в OU . По умолчанию они будут применяться к группе 
Authenticated Users, которая включает всех пользователей/ПК.  

Вкладка «Параметры» включает фактическое содержимое GPO и позволяет нам узнать, какие конкретные конфигурации он 
применяет. Как уже говорилось ранее, каждый GPO имеет конфигурации, которые применяются только к компьютерам, и 
конфигурации, которые применяются только к пользователям. В этом случае единственный Default Domain Policy содержит 
конфигурации компьютеров:   

### Настройки OU

Не стесняйтесь исследовать GPO и расширять доступные элементы, используя ссылки "показать" на правой стороне каждой 
конфигурации. В этом случае Default Domain Policy указывает на действительно базовые конфигурации, которые должны 
применяться к большинству доменов, включая политики паролей и блокировки учетных записей:  

### Подробные настройки OU

Поскольку этот GPO применяется ко всему домену, любые изменения в нем повлияют на все компьютеры. Давайте изменим 
политику минимальной длины пароля, чтобы потребовать от пользователей иметь не менее 10 символов в своих паролях. 
Для этого щелкните правой кнопкой мыши GPO и выберите Изменить:  

Редактирование настроек GPO

Это откроет новое окно, в котором мы можем перемещаться и редактировать все доступные конфигурации. Чтобы изменить 
минимальную длину пароля, перейдите Computer Configurations -> Policies -> Windows Setting -> Security Settings -> 
Account Policies -> Password Policyи измените требуемое значение политики:

Политика паролей GPO

Как вы видите, в GPO можно установить множество политик. Хотя объяснить каждую из них в одной комнате было бы 
невозможно, не стесняйтесь немного изучить, так как некоторые политики просты. Если вам нужна дополнительная 
информация о любой из политик, вы можете дважды щелкнуть по ним и прочитать вкладку «Объяснение» для каждой из них:

Вкладка с пояснениями настроек OU

Распределение групповой политики

GPO распространяются по сети через сетевой ресурс SYSVOL, называемый, который хранится в DC. Все пользователи в 
домене обычно должны иметь доступ к этому ресурсу по сети для периодической синхронизации своих GPO. Общий ресурс 
SYSVOL по умолчанию указывает на каталог C:\Windows\SYSVOL\sysvol\на каждом из DC в нашей сети.  

После внесения изменений в любые GPO компьютерам может потребоваться до 2 часов, чтобы наверстать упущенное. Если вы 
хотите заставить какой-либо конкретный компьютер немедленно синхронизировать свои GPO, вы всегда можете выполнить 
следующую команду на нужном компьютере:  

Окна
```commandline
PowerShell
PS C:\> gpupdate /force
```

Создание некоторых объектов групповой политики для THM Inc.

В рамках нашей новой работы нам было поручено внедрить некоторые объекты групповой политики, которые позволят нам:

Заблокируйте доступ к панели управления для пользователей, не являющихся ИТ-специалистами.
Настройте рабочие станции и серверы на автоматическую блокировку экранов после 5 минут бездействия пользователя, 
чтобы пользователи не оставляли свои сеансы открытыми. 
Давайте сосредоточимся на каждом из них и определим, какие политики следует включить в каждом объекте групповой 
политики и с чем их следует связать. 

Ограничить доступ к панели управления

Мы хотим ограничить доступ к панели управления на всех машинах только для пользователей, которые являются частью 
ИТ-отдела. Пользователи других отделов не должны иметь возможности изменять системные настройки. 

Давайте создадим новый GPO с именем Restrict Control Panel Access и откроем его для редактирования. Поскольку мы 
хотим, чтобы этот GPO применялся к определенным пользователям, мы будем искать User Configuration следующую политику:

Ограничение доступа к панели управления

Обратите внимание, что мы включили политику «Запретить доступ к панели управления и настройкам ПК» .

После настройки GPO нам нужно будет связать его со всеми OU, соответствующими пользователям, которые не должны иметь 
доступа к панели управления своих ПК. В этом случае мы свяжем OU Marketing, Management и SalesOU, перетащив GPO в 
каждую из них: 

Связывание Ограничения Панели Управления GPO

Автоматическая блокировка экрана GPO

Для первого объекта групповой политики , касающегося блокировки экрана для рабочих станций и серверов, мы могли бы 
напрямую применить его к Workstations, Servers и Domain ControllersOU, которые мы создали ранее. 

Хотя это решение должно работать, альтернатива состоит в простом применении GPO к корневому домену, поскольку мы 
хотим, чтобы GPO влиял на все наши компьютеры. Поскольку OU Workstations, Servers и Domain ControllersOU являются 
дочерними OU корневого домена, они унаследуют его политики.  

Примечание: Вы могли заметить, что если наш GPO применяется к корневому домену, он также будет унаследован другими 
OU, такими как Salesили Marketing. Поскольку эти OU содержат только пользователей, любая конфигурация компьютера в 
нашем GPO будет ими проигнорирована.  

Давайте создадим новый GPO , назовем его Auto Lock Screenи отредактируем. Политика для достижения того, что мы хотим,
находится в следующем маршруте: 

Настройка лимита бездействия машины

Мы установим предел бездействия в 5 минут, чтобы компьютеры автоматически блокировались, если какой-либо 
пользователь оставляет свой сеанс открытым. После закрытия редактора GPO мы привяжем GPO к корневому домену, 
перетащив GPO в него:  

Связывание GPO автоматической блокировки экрана

После того, как GPO были применены к правильным OU, мы можем войти в систему как любой пользователь в Marketing, 
Sales или Management для проверки. Для этой задачи давайте подключимся через RDP, используя учетные данные Марка: 

ТМ-ключ
Имя пользователя	Отметка
Пароль	М4рк3т1нг.21
Примечание:  При подключении через  RDP используйте THM\Mark в качестве имени пользователя, чтобы указать, что вы 
хотите войти в систему, используя имя пользователя Mark в THM домене. 

Если мы попробуем открыть Панель управления, мы должны получить сообщение о том, что эта операция отклонена 
администратором. Вы также можете подождать 5 минут, чтобы проверить, заблокирован ли экран автоматически, если хотите. 

Поскольку мы не применили групповую политику панели управления к ИТ-отделу, вы все равно сможете войти в систему как 
любой из этих пользователей и получить доступ к панели управления.  

Примечание: Если вы создали и связали объекты групповой политики, но по какой-то причине они все еще не работают, 
помните, что вы можете запустить , gpupdate /force чтобы принудительно обновить объекты групповой политики.

### Ответить на вопросы ниже
Каково имя сетевого ресурса, используемого для распространения объектов групповой политики на компьютеры домена?
```commandline
sysvol
```
Можно ли использовать GPO для применения настроек к пользователям и компьютерам? (да/нет)
```commandline
yay
```

## Задание 7
При использовании доменов Windows все учетные данные хранятся в контроллерах домена. Всякий раз, когда пользователь 
пытается пройти аутентификацию в службе с использованием учетных данных домена, служба должна будет запросить 
контроллер домена проверить их правильность. Для сетевой аутентификации в доменах Windows можно использовать два 
протокола:   

Kerberos : Используется любой последней версией Windows. Это протокол по умолчанию в любом последнем домене.
NetNTLM: Устаревший протокол аутентификации сохранен в целях совместимости.
Хотя NetNTLM следует считать устаревшим, в большинстве сетей оба протокола будут включены. Давайте подробнее 
рассмотрим, как работает каждый из этих протоколов. 

### Аутентификация Kerberos

Аутентификация Kerberos — это протокол аутентификации по умолчанию для любой последней версии Windows. Пользователям,
которые входят в службу с использованием Kerberos, будут назначены билеты. Думайте о билетах как о доказательстве 
предыдущей аутентификации. Пользователи с билетами могут предоставить их службе, чтобы продемонстрировать, что они 
уже прошли аутентификацию в сети и, следовательно, могут ее использовать.   

При использовании Kerberos для аутентификации происходит следующий процесс:

Пользователь отправляет свое имя пользователя и временную метку, зашифрованные с помощью ключа, полученного из его 
пароля, в Центр распространения ключей (KDC) — службу, обычно устанавливаемую на контроллере домена, отвечающую за 
создание билетов Kerberos в сети.  

KDC создаст и отправит обратно билет на выдачу билетов (TGT) , который позволит пользователю запрашивать 
дополнительные билеты для доступа к определенным услугам. Необходимость в билете для получения дополнительных 
билетов может показаться немного странной, но это позволяет пользователям запрашивать билеты на услуги без передачи 
своих учетных данных каждый раз, когда они хотят подключиться к услуге. Вместе с TGT пользователю предоставляется 
ключ сеанса , который ему понадобится для генерации следующих запросов.    

Обратите внимание , что TGT зашифрован с использованием хэша пароля учетной записи krbtgt , и поэтому пользователь 
не может получить доступ к его содержимому. Важно знать, что зашифрованный TGT включает копию ключа сеанса как часть 
своего содержимого, и KDC не нужно хранить ключ сеанса, поскольку он может восстановить копию, расшифровав TGT, если 
это необходимо.   

### Керберос шаг 1

Когда пользователь хочет подключиться к службе в сети, например к общему ресурсу, веб-сайту или базе данных, он 
использует свой TGT , чтобы запросить у KDC службу предоставления билетов (TGS) . TGS — это билеты, которые 
разрешают подключение только к определенной службе, для которой они были созданы. Чтобы запросить TGS, пользователь 
отправляет свое имя пользователя и временную метку, зашифрованную с помощью сеансового ключа, вместе с TGT и именем 
участника службы (SPN), которое указывает на службу и имя сервера, к которым мы собираемся получить доступ.    

В результате KDC отправит нам TGS вместе с ключом сеанса службы , который нам понадобится для аутентификации в 
службе, к которой мы хотим получить доступ. TGS зашифрован с использованием ключа, полученного из  хэша владельца 
службы . Владелец службы — это учетная запись пользователя или компьютера, под которой работает служба. TGS содержит 
копию ключа сеанса службы в своем зашифрованном содержимом, чтобы владелец службы мог получить к нему доступ, 
расшифровав TGS.    

### Керберос шаг 2

Затем TGS может быть отправлен в нужную службу для аутентификации и установления соединения. Служба будет 
использовать хэш пароля своей настроенной учетной записи для расшифровки TGS и проверки ключа сеанса службы. 
Керберос шаг 3

### Аутентификация NetNTLM

NetNTLM работает с использованием механизма «вызов-ответ».  Весь процесс выглядит следующим образом:

Аутентификация NetNTLM

Клиент отправляет запрос аутентификации на сервер, к которому он хочет получить доступ.
Сервер генерирует случайное число и отправляет его в качестве вызова клиенту.
Клиент объединяет свой NTLM- хеш пароля с вызовом (и другими известными данными), чтобы сгенерировать ответ на вызов,
и отправляет его обратно на сервер для проверки. 
Сервер пересылает запрос и ответ контроллеру домена для проверки.
Контроллер домена использует вызов для пересчета ответа и сравнивает его с исходным ответом, отправленным клиентом. 
Если они оба совпадают, клиент аутентифицирован; в противном случае доступ запрещен. Результат аутентификации 
отправляется обратно на сервер.  
Сервер пересылает результат аутентификации клиенту.
Обратите внимание, что пароль (или хэш) пользователя никогда не передается по сети в целях безопасности.

Примечание: Описанный процесс применяется при использовании учетной записи домена. Если используется локальная 
учетная запись, сервер может сам проверить ответ на вызов, не требуя взаимодействия с контроллером домена, поскольку 
он хранит хэш пароля локально в своем SAM.  

### Ответить на вопросы ниже
Будет ли текущая версия Windows использовать NetNTLM в качестве предпочтительного протокола аутентификации по 
умолчанию? (да/нет) 
```commandline
nay
```
Какой тип билета, ссылаясь на Kerberos, позволяет нам запрашивать дополнительные билеты, известные как TGS?
```commandline
Ticket Granting Ticket
```
При использовании NetNTLM передается ли пароль пользователя по сети в какой-либо момент? (да/нет)
```commandline
nay
```

## Задание 8
До сих пор мы обсуждали, как управлять одним доменом, роль контроллера домена и как он объединяет компьютеры, 
серверы и пользователей. 

Единый домен

По мере роста компаний растут и их сети. Для начала достаточно иметь один домен для компании, но со временем 
некоторые дополнительные потребности могут подтолкнуть вас к тому, чтобы иметь больше одного. 

Деревья

Представьте, например, что ваша компания внезапно расширяется в новую страну. В новой стране действуют другие законы 
и правила, которые требуют от вас обновления ваших GPO для соответствия. Кроме того, теперь у вас есть 
ИТ-специалисты в обеих странах, и каждая ИТ-команда должна управлять ресурсами, соответствующими каждой стране, не 
мешая другой команде. Хотя вы можете создать сложную структуру OU и использовать делегирование для достижения этого, 
наличие огромной структуры AD может быть сложным в управлении и подверженным человеческим ошибкам.    

К счастью для нас, Active Directory поддерживает интеграцию нескольких доменов, так что вы можете разделить свою 
сеть на блоки, которые могут управляться независимо. Если у вас есть два домена, которые разделяют одно и то же 
пространство имен (thm.localв нашем примере), эти домены можно объединить в дерево.  

Если бы наш thm.localдомен был разделен на два поддомена для филиалов в Великобритании и США, вы могли бы построить 
дерево с корневым доменом thm.local и двумя поддоменами с именами uk.thm.local и us.thm.local, каждый со своим AD, 
компьютерами и пользователями:  

Дерево

Эта секционированная структура дает нам лучший контроль над тем, кто может получить доступ к чему в домене. 
IT-специалисты из Великобритании будут иметь свой собственный DC, который управляет только ресурсами Великобритании. 
Например, пользователь из Великобритании не сможет управлять пользователями из США. Таким образом, администраторы 
домена каждого филиала будут иметь полный контроль над своими соответствующими DC, но не DC других филиалов. 
Политики также можно настраивать независимо для каждого домена в дереве.    

Необходимо ввести новую группу безопасности, когда речь идет о деревьях и лесах. Группа Enterprise Admins 
предоставит пользователю административные привилегии по всем доменам предприятия. Каждый домен по-прежнему будет 
иметь своих Domain Admins с привилегиями администратора по своим отдельным доменам и Enterprise Admins, которые 
могут контролировать все на предприятии.   

Леса

Домены, которыми вы управляете, также могут быть настроены в разных пространствах имен. Предположим, что ваша 
компания продолжает расти и в конечном итоге приобретает другую компанию под названием MHT Inc.Когда обе компании 
объединяются, у вас, вероятно, будут разные деревья доменов для каждой компании, каждое из которых будет управляться 
собственным ИТ-отделом. Объединение нескольких деревьев с разными пространствами имен в одну сеть называется лесом.   

Лес

Доверительные отношения

Наличие нескольких доменов, организованных в деревья и леса, позволяет вам иметь прекрасную разграниченную сеть с 
точки зрения управления и ресурсов. Но в определенный момент пользователю THM UK может потребоваться доступ к общему 
файлу на одном из серверов MHT ASIA. Для этого домены, организованные в деревья и леса, объединяются доверительными 
отношениями. 

Проще говоря, наличие доверительных отношений между доменами позволяет вам авторизовать пользователя из домена  THM 
UK для доступа к ресурсам из домена  MHT EU. 

Простейшими доверительными отношениями, которые могут быть установлены, являются односторонние доверительные 
отношения . В односторонних доверительных отношениях, если Domain AAA доверяет Domain BBB, это означает, что 
пользователь на BBB может быть авторизован для доступа к ресурсам на AAA:  

### Трасты

Направление односторонних доверительных отношений противоположно направлению доступа.

Двусторонние доверительные отношения также могут быть созданы, чтобы позволить обоим доменам взаимно авторизовать 
пользователей друг из друга. По умолчанию объединение нескольких доменов в дереве или лесу сформирует двусторонние 
доверительные отношения.  

Важно отметить, что наличие доверительных отношений между доменами не предоставляет автоматически доступ ко всем 
ресурсам на других доменах. После установления доверительных отношений у вас есть возможность авторизовать 
пользователей в разных доменах, но вам решать, что на самом деле авторизовано, а что нет.  

### Ответить на вопросы ниже
Как называется группа доменов Windows, использующих одно и то же пространство имен?
```commandline
Tree
```
Что необходимо настроить между двумя доменами, чтобы пользователь в домене A мог получить доступ к ресурсу в домене B?
```commandline
A Trust Relationship
```

## Задание 9
В этой комнате мы показали основные компоненты и концепции, связанные с Active Directory и доменами Windows. Помните,
что эта комната должна служить только введением в основные концепции, поскольку для внедрения готовой к производству 
среды Active Directory нужно изучить еще очень многое.  

Если вам интересно узнать, как защитить установку Active Directory, обязательно посетите Active Directory Hardening 
Room (будет выпущена в ближайшее время). Если же вы хотите узнать, как злоумышленники могут воспользоваться 
распространенными ошибками конфигурации AD и другими методами взлома AD, то вам подойдет модуль Compromising Active 
Directory.

### Ответить на вопросы ниже
Нажмите и продолжайте обучение!
```commandline
Ответ не требуется
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)