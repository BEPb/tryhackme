[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)

# Комната [Registry Persistence Detection](https://tryhackme.com/r/room/registrypersistencedetection) 

Всего 6 заданий:
## Задание 1
Один из важнейших шагов, который вредоносное ПО делает после успешного выполнения на целевой машине, заключается в том, чтобы гарантировать, что оно может остаться там даже после перезагрузки или попытки удаления. Это возможно с помощью различных методов, которые в совокупности называются «механизмами сохранения вредоносного ПО» .

В этом номере вы получите обзор этих методов и познакомитесь с инструментом, который поможет их обнаружить и устранить.

Цели обучения

- Узнайте, как вредоносное ПО сохраняется на компьютере
- Узнайте, как вредоносное ПО использует реестр в качестве механизма сохранения.
- Узнайте, как использовать модуль PowerShell AutoRuns для обнаружения и устранения механизмов сохранения.

Подключение к машине

Мы будем использовать предоставленную виртуальную машину для выполнения задач в этой комнате. Вы можете запустить ее 
в режиме разделенного экрана, нажав зеленую кнопку «Запустить машину» в правом верхнем углу этой задачи. Если 
виртуальная машина не видна, используйте синюю кнопку «Показать разделенный вид» в правом верхнем углу страницы. 
Кроме того, вы можете подключиться к виртуальной машине,  используя  учетные данные ниже через «Удаленный рабочий 
стол».    

ТМ-ключ
Имя пользователя	Администратор
Пароль	Пароль!
ИС	МАШИНА_IP
### Ответьте на вопросы ниже
Прочитайте вышеизложенное, запустите машину и войдите в систему.
```commandline
Ответ не нужен
```

## Задание 2
Термин «устойчивость вредоносного ПО»  можно определить следующим образом:

«Поведение, позволяющее вредоносному ПО оставаться в системе независимо от системных событий, таких как перезагрузки».

Существует несколько способов, с помощью которых вредоносное ПО может получить стойкость. Используемые методы различаются в зависимости от целевой операционной системы, простоты внедрения, уровня скрытности или, иногда, в зависимости от предпочтений автора вредоносного ПО.  Примерами таких методов могут быть изменение загрузочного сектора операционной системы, установка вредоносных конфигураций или перехват потока выполнения.

В Windows наиболее распространенным и простым в реализации методом является злоупотребление ключами «Выполнить» реестра Windows.

Реестр Windows — это база данных низкоуровневых операционных систем и настроек приложений. Ключи Run — это особые 
ключи в реестре, которые содержат путь, который запускается каждый раз, когда пользователь входит в систему, и они 
перечислены ниже:  
- HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run — путь запуска при входе текущего пользователя в систему
- HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run — путь запуска при входе любого пользователя в 
  систему
- HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce — запуск пути при входе текущего пользователя в 
  систему, затем удаление
- HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce — запуск пути при входе любого пользователя в 
  систему, затем удаление
Чтобы просмотреть эти ключи, откройте редактор реестра , выполнив поиск по запросу «Regedit» в поиске Windows или дважды щелкнув значок Regedit, закрепленный на панели задач Windows.

Вот как выглядит окно редактора реестра:

Скриншот встроенного редактора реестра Windows

Если вы хотите просмотреть значение для одного из ключей Run, разверните папки и их подпапки, пока не найдете нужный 
ключ. Например: 

HKEY_LOCAL_MACHINE >  Программное обеспечение > Microsoft > Windows > CurrentVersion > Выполнить
### Ответьте на вопросы ниже
Каково значение "Имя" подозрительной записи реестра, которая запускается во время запуска? Включите скобки.
```commandline
(Default)
```
Каково значение «Данные» подозрительной записи реестра, которая запускается при запуске?
```commandline
C:\Users\Administrator\AppData\Local\bd84\24d9.bat
```
Какая строка отображается на консоли при запуске подозрительного файла?
```commandline
pleaseletmepersist
```

## Задание 3
Как вы видели в предыдущей задаче, можно обнаружить наличие механизмов сохранения в реестре, вручную проверив ключи. Однако для установления сохранения можно использовать другие ключи реестра, и они не столь очевидны, что затрудняет их поиск.  К счастью, некоторые инструменты могут помочь нам с этой проблемой.

Широко используемый инструмент от Microsoft под названием AutoRuns  проверяет все возможные места, где программа может автоматически запускаться при запуске или при входе пользователя в систему. Этот инструмент делает то, что нам нужно, но это не тот инструмент, который мы будем использовать в этой комнате (если вы все равно хотите проверить его, попробуйте комнату SysInternals ).

Логотип модуля PowerShell AutoRuns

Для этой комнаты мы будем использовать модуль AutoRuns PowerShell . Он делает то же самое, что и оригинальный инструмент AutoRuns. Тем не менее, он позволяет нам использовать преимущества сценариев PowerShell и имеет базовую функцию для сравнения текущих снимков с предыдущими. Позже вы поймете, почему эти функции так важны.

На компьютере Windows уже установлен модуль AutoRuns PowerShell . Чтобы использовать его, откройте PowerShell в режиме администратора, щелкнув значок PowerShell на панели задач Windows в нижней части экрана. После появления окна PowerShell введите следующее, чтобы просмотреть доступные команды:

Администратор: Windows
PowerShell
PS C:\> Get-Command -Module AutoRuns
CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Function        Compare-AutoRunsBaseLine                           14.0       AutoRuns
Function        Get-PSAutorun                                      14.0       AutoRuns
Function        New-AutoRunsBaseLine                               14.0       AutoRuns
Чтобы узнать больше о каждой команде AutoRuns,  мы можем использовать командлет Get-help вместе с каждым именем команды AutoRun, как показано ниже:

Администратор: Windows
PowerShell
PS C:\> Get-Help CHANGETHIS
 Дополнительную информацию можно также найти  на странице ReadMe инструмента .
### Ответьте на вопросы ниже
Какая функция AutoRun используется для получения и отображения записей автозапуска?
```commandline
Get-PSAutorun
```
Какая функция AutoRun используется для создания базового файла из артефактов Autoruns?
```commandline
New-AutoRunsBaseLine
```
Какая функция AutoRun используется для сравнения двух базовых файлов артефактов Autoruns?
```commandline
Compare-AutoRunsBaseLine
```

## Задание 4
AutoRuns PowerShell имеет функцию Get-PSAutorun , которая выводит список всех возможных механизмов автозапуска, доступных на машине. Этот список создается на основе таких категорий, как реестр, службы Windows, записи WMI, перехват DLL и т. д. Из-за этого вывод команды вернет много результатов, которые могут быть сложными, если их не отфильтровать должным образом.

Администратор: Windows
PowerShell
PS C:\> Get-PSAutorun

Path          : HKLM:\System\CurrentControlSet\Control\Session Manager
Item          : BootExecute
Category      : Boot Execute
Value         : autocheck autochk *
ImagePath     : C:\Windows\system32\autochk.exe
Size          : 956416
LastWriteTime : 11/6/2022 4:24:46 AM
Version       : 10.0.17763.1697

Path          : HKLM:\SOFTWARE\\Microsoft\Windows\CurrentVersion\Explorer\ShellServiceObjects
Item          : {003e0278-eca8-4bb8-a256-3689ca1c2600}
Category      : Explorer
Value         : C:\Windows\system32\shell32.dll
ImagePath     : C:\Windows\system32\shell32.dll
Size          : 22153696
LastWriteTime : 11/6/2022 4:25:16 AM
Version       : 10.0.17763.1911

Path          : HKLM:\SOFTWARE\\Microsoft\Windows\CurrentVersion\Explorer\ShellServiceObjects
Item          : {3BF043EF-A974-49B3-8322-B853CF1E5EC5}
Category      : Explorer
Value         : C:\Windows\System32\SndVolSSO.dll
ImagePath     : C:\Windows\System32\SndVolSSO.dll
Size          : 823808
LastWriteTime : 11/6/2022 4:25:22 AM
Version       : 10.0.17763.652

...
        
Передача результата выполнения приведенной выше команды в командлет Out-GridView может сделать вывод более читабельным.

Администратор: Windows
PowerShell
PS C:\> Get-PSAutorun | Out-GridView
Приведенная выше команда откроет новое окно, отображающее следующий вывод:

Вывод модуля AutoRuns PowerShell с использованием Out-GridView.

Примечание: Подождите пару минут, пока инструмент завершит заполнение результатов.

Результаты выше перечисляют все возможные места, где программа может запускаться при запуске. Вы можете отфильтровать результаты, указав ключевые слова в строке «Фильтр» в верхней части окна. Вы также можете сортировать результаты, нажимая на заголовки столбцов.

Мы можем указать переключатели параметров при вызове функции, чтобы отфильтровать результат в соответствии с ранее упомянутыми категориями. Откройте новое окно PowerShell и используйте Get-Helpкоманду для вывода списка доступных параметров.

Администратор: Windows
PowerShell
PS C:\> Get-Help Get-PSAutorun -detailed
### Ответьте на вопросы ниже
Какой параметр-переключатель используется для фильтрации артефактов, связанных с выполнением загрузки образов? 
```commandline
BootExecute
```
Сколько записей выводится при использовании переключателя параметров из предыдущего вопроса?
```commandline
1
```
Какой параметр-переключатель используется для фильтрации артефактов, связанных с драйвером принтера и мониторами состояния?
```commandline
PrintMonitorDLLs
```
Сколько записей указано в выходных данных при использовании переключателя параметров из предыдущего вопроса?
```commandline
5
```
Какой параметр используется для добавления нового столбца, показывающего, имеет ли файл цифровую подпись?
```commandline
VerifyDigitalSignature
```
При поиске по всем категориям у скольких записей в столбце «Подписано» установлено значение «ложь»?
```commandline
3
```

Попробуйте ответить на предыдущий вопрос, используя только Powershell и без использования Out-GridView.
```commandline
Ответ не нужен
```

## Задание 5
Хотя фильтрация с помощью переключателей параметров помогает сократить вывод, все еще многое предстоит сделать. 
Именно здесь полезна функция создания и сравнения базовых линий модуля AutoRuns PowerShell , поскольку в результатах 
отображаются только те записи, которые отличаются от базовых линий.  

После создания машины этой комнаты был сгенерирован базовый файл, который был сохранен в  папке ~/Documents . Этот 
файл служит снимком реестра до запуска вредоносной программы.

Снимок экрана, показывающий каталог базового файла.

Чтобы проверить, какие ключи реестра были изменены, необходимо создать новый базовый файл с помощью функции  
New-AutoRunsBaseLine. 

```commandline

Администратор: Windows
PowerShell
PS C:\> Get-PSAutorun -VerifyDigitalSignature |
>> Where { -not($_.isOSbinary)} |
>> New-AutoRunsBaseLine -Verbose
```
Примечание: Создание нового базового файла с использованием кода выше займет несколько минут. Поэтому, пожалуйста, 
будьте терпеливы. 
После завершения новый базовый файл будет добавлен в папку ~/Documents.

Снимок экрана, показывающий каталог базовых файлов.

Теперь два базовых файла можно сравнить с помощью следующей команды:

Администратор: Windows
PowerShell
`PS C:\> Compare-AutoRunsBaseLine -Verbose | Out-GridView`
Примечание: Убедитесь, что при сравнении в папке ~/Documents всегда есть два базовых файла. Удалите остальные файлы, 
которые вам не нужны, чтобы избежать путаницы.

### Ответьте на вопросы ниже
Есть еще одна подозрительная запись реестра входа. Каков полный путь к этому ключу?
```commandline
HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
```
Каково имя элемента значения подозрительной записи реестра из вопроса №1?
```commandline
Userinit
```
Каковы данные о ценности подозрительной записи реестра из вопроса №1?
```commandline
C:\Windows\system32\userinit.exe,C:\Users\Administrator\AppData\Local\THM\789a.bat
```
Какую категорию AutoRuns присвоил записи из вопроса №1?
```commandline
Logon
```
Какая строка отображается на консоли при запуске подозрительного файла?
```commandline
letmestaymyfriend
```

## Задание 6
Теперь мы можем предпринять необходимые шаги для удаления вредоносных ключей реестра и файлов, которые мы нашли. В 
этом случае это так же просто, как удалить или изменить записи через "RegEdit" и убедиться, что они исчезнут после 
перезагрузки.

Снимок экрана, показывающий, как изменять записи через RegEdit.

Надеюсь, эта комната дала вам представление о том, как вредоносное ПО использует реестр Windows для сохранения на 
целевой машине. Хотя существуют и другие методы, которые использует вредоносное ПО, этот же инструмент можно 
использовать для обнаружения большинства из них.

### Ответьте на вопросы ниже
Поздравляем! Вы очистили свою машину от механизмов сохранения... на данный момент.
```commandline
Ответ не нужен
```
[>> вернуться на главную страницу](https://github.com/BEPb/tryhackme/blob/master/README.md)